TESTPRG		EQU	0	;SV 3.3d
TESTPRGB	EQU	0


OS3	  	EQU 1
NEWSYSTEM 	EQU 1			;1 = NEW
CALIBRATED14	EQU 0
DIRECTAMIGAAUDIO EQU 1
POLISH		EQU	1		;1=english
NEWFILTER	EQU	1		;Resonant Filters
BAREDITOR	EQU	0		;Bars inside PED

CFILTER_MAXRESO	EQU	185
CFILTER_MAXFREQ	EQU	240


	;3.3d	Block Read Write to disk 
	;	BUG: Block Paste geht rechts ueber Borders
	;	BUG FIXED: LineSample trashing String section

	;3.3c   Realtime BP,HP filters with reso

	;3.2f	FIXED : Extension problems with songs/mods
	;	NEW: more filter types
	;	PrintRenderInfoSize
	;	10 MB Render Buffer

	;3.2e	FIXED : Retrig inside StartSample
	;	NEW: RealTime Modification Unit is now block aware
	;       TO REMOVE : doretrigtest
	;	correct displaying of Time with 4x OS3
	;	correct realtime filterfreq with 4x OS3
	;	NEW: Reso Filter of Instrument is displayed
	;	RT resofilters are cleared if song is stopped

	;3.2d	NEW: Aiff Rendering
	;3.2c	NEW CV Subclass: Panorama
	;3.2c	NEW: MENU/Stereo Control/Declicking

	;3.1l	Fade Reso LP Filters
	;3.1g	8x Oversample
	;3.1f	Clip Regions, Player fixed
	;   d   Event ED displays commands correctly
	;   c   Single Mode
	;3.1a	Flicker Free Loop
	;		M: LP Filter changed, Visage as pic viewer
	;		l: Sync System changed, max 40 buffers now
	;	      27h: Gfx Speedup
	;	Gamma 27g; Event Modify !
	;	Gamma 27f: Macro load/save
	;	Gamma 27e: Fast GFX while MacroProcess
	;	Gamma 27d: Prerelease, Maud, Maestro Swapped
	;	Gamma 27c Slider Gad, PT Converter special bei 128 PatternLen
	;	Gamma 27b Faster Gfx (HLine, VLine)
	;	Gamma 27: Memory Leak fixed
	;	Gamma 26: New DEMO/Player
	;	Gamma 25: Much faster GUI building (value gads ueberspringen)
	;	Gamma 23: Mouse Offset
	;	Gamma 22: memory protection errors fixed at high freqs
	;	Gamma 21: DryDspBuffer_PTR , RenderBuffer_PTR length fixed
	;	Gamma 19: Lots of smaller bugs fixed, Render Gfx fixed
	;	Gamma 18: All Windows are now safe
	;	Gamma 17: Macro
	;	Gamma 15: Refresh of Event fixed, Waveform Style is saved
	;	Gamma 14: New Wild Pattern
	;	Gamma 13: Dsp Plug In, New Area Title Pattern
	;	Gamma 12: Old Compressor implemented
	;	Megaprob fixed: windows zu klein -> Break Down
	;	NEW: Sampleboost above 100 %
	;	Enforcer: CopySample: manchmal 0 Instrument ??
	;	Reply Msg anstatt Gadtools Zeugs
	;	DrawSamplePosition
	;	CopyVoiceBuffer_L CheckBufferMem
	;	NGSampleBoost

SAVEENCODED	EQU	0
USEENCODED	EQU	0

SPECIAL		EQU	0

VerString	macro
		dc.b	"3.3"
		endm

DetailVerString	macro
		dc.b	"3.3d"
		endm

AvailString	macro
		DC.B	"Symphonie III is available at:",10,10
		dc.b	"   RealTime Software",10
		dc.b	"   Patrick Meng, Rosenfeldweg 4,",10
		dc.b	"   CH - 6048 Horw, Switzerland",10,10
		dc.b	"   eMAIL : pmeng@vtx.ch",0
		endm

	MC68020

		;NEWBUFSYNC

SYMPHPRO	EQU	1 	;16BIT=1 8BIT=0



AMINETDEMO	EQU	0	;only 16 Voices
DEMO		EQU	0
SMALLGUI	EQU	0	;Single Window DEMO





	IFNE AMINETDEMO
LOCALDIR	EQU	1
	ELSE

		IFNE DEMO
LOCALDIR	EQU	1
		ELSE
LOCALDIR	EQU	1
		ENDC
	ENDC



MIDI		EQU	0
MIDILIB		EQU	1

PRIVATETEST	EQU	0


PROVCODE	EQU	0
SHOWMSGINT	EQU	1	;nur falls TESTPRGB 1
CAPSMENUS	EQU	1

SHAREWARE	EQU	0
TESTREQHANDLE	EQU	0
DIRECTPEDGFX	EQU	0	;direct ped BM gfx (font)
FXROUTINES	EQU	1	;color routines
SQRTFUNC	EQU	0

NEWMAXIMIZE	EQU	0
MAXSAMPLEBOOST	EQU	200
MAXMASTERVOL	EQU	100
MAXANTIALIAS	EQU	100

SYSVOLFADE	EQU	32
SYSVOLFADELN	EQU	5

	IFEQ	DEMO
PROCVLIMIT_INIT	EQU	99

		IFNE	SYMPHPRO
	IFEQ AMINETDEMO
RENDER		EQU	1
	ELSE
RENDER		EQU	0
	ENDC	

		ELSE
RENDER		EQU	0
		ENDC
	ELSE
PROCVLIMIT_INIT	EQU	90

RENDER		EQU	0
	ENDC


TOCCATA		EQU	0


ENCODEREG	EQU	0	;1=DISKKEY, 0=BUILD KEY  CodeRegisterString
COPYPROTECT	EQU	0	;1=YES (KEY), 0=NO KEY STUFF
NOPACKDATA	EQU	0

FADEOUT_STEPS	EQU	28
FADETO_STEPS	EQU	9


DSPTEST		EQU	0
OVERSAMPLING	EQU	0
DSP		EQU	0
DSPHALL		EQU	0
INCXPK		EQU	1


				
TRANSRESOSTEP	EQU	12	;Transreso





MAXPROCFREQ	EQU	$7fffffff


	;IFNE	SYMPHPRO
SOUND14BIT	EQU	1
	;ELSE
	;SOUND14BIT	EQU	0
	;ENDC


VERSION		EQU	1
REVISION	EQU	0


	;3.0	SCOPE BITMAP H := SCREEN H	Guru fixed


	;	SAVE8BIT_QUALITY


	;	v2.5 rel 1
	;	NEW SAMPLEBOOST SYSTEM

	;	v2.4f rel 9h
	;	NEW: antialias, pitch diff	

	;	v2.4f rel 9f
	;	NEW: Sample Antialias
	;	EVENT ED: Event Lock


	;	v2.4f rel 9d
	;	Transreso nur mit TESTPRGB
	;	Flag NEWMAXIMIZE= old better maximize system

	;	v2.4f rel 9c
	;	Playing from Actual Pos fixed !!
	;	Guru Fixed (pos511)
	;	PT Import: Poslist
	;	XPK mod loader

	;;	Maximize Sample modified
	;;	Filter Sample modified
	;	15 KB shorter ()
	;;	System Requesters now appear on Symphonie SCREEN
	;	BUG fixed: CurrentDir probs (CLI probs fixed, too)

	;	2.4f rel 8
	;	PT loader fixed: 255 InstrNr
	;	Memory Protection fixed in MSG Recording Buffer
	;	GFX Bug fixed (Patted Crsr with Mouse)
	;	Case Menu texts

	;	2.4f rel 7
	;	PT loader final
	;	SUPERFAST better declicked
	;	MemoryCheck at StopSong
	;	2 memory protection violations fixed

	;	2.4f rel 6
	;	PT loader prerelease
	;	NEW ColorOrgan ColorDef
	;	even faster GFX
	;	CopySampleZero

	;	2.4f rel 4
	;	SampeVib reset fixed
	;	FlushCaches

	;	2.4f rel 3
	;	NEW Wave loader
	;	Noise bei hoher Freq fixed
	;	Transwave fixed fuer SymJr
	;	NEW Alle Formate werden angezeigt, ausser raw
	;	BUG fixed in PrintAssText (bei langen texten wird nicht
	;		korrekt abgeschnitten)
	;	2x laden eines mods/songs ist nicht mehr moeglich



	;	2.4f beta 2
	;	AIFF, SmallView, MEMiD

	;	2.4f beta
	;	FASTPLAY

	;	2.4e rel 3
	;	Path File Remembering expanded

	;	2.4e rel 2
	;	New Declicking System
	;	Clicks fixed at Sample End

	;	2.4e
	;	Gui Prefs
	;	New Gui Possibilities
	;	Paths/File remembering
	;	Quick Prefs

	;	2.4d rel 4
	;	Render Buffering
	;	Sampleboost Saving into Mods/Songs

	;	2.4d rel 2
	;	2 Room DSP: ProcessMuteDSP

	;	2.4d DSP PlugIn (Pro Only)

	;	NEWS:	2.4c rel 3
	;	Save DSP Buffer reduce
	;	Better Shift Status
	;	Pos Up/Down, Pat Up/Down with Shift!

	;	NEWS:	2.4c rel 2
	;	better anticlick
	;	shareware text modified
	;	sync for play and record in track fixed


	;	NEWS:	2.4c
	;	SyncLoop
	;	New Loopsystem
	;	AntiKnack16
	;	New DrawSamplePos

	;	UpdateRecalcLoop

	;	NEWS: 2.4b
	;	NewSearchForIffBody_BF NEW Stereo Check

	;	NEWS: 2.4
	;	NewSearchForIffBody
	;	Extract iff format modified (Less compatibility problems)
	;	Balance, MasterVolume
	
	;	NEWS: 2.3e
	;	NoteEd/Patted Visual Bugs fixed
	;	Extract Quality

	;	NEWS: 2.3d

	;	QualityUp fixed to QUALFREQ_MAX	(250 000)
	;	Clone -> Remix

	;	NEWS: 2.3c release 10
	;	date 95 -> 96
	;	kill instr -> clear samplename
	;	import/export sample kicked
	;	

	;	NEWS: 2.3c release 9
	;		new 16 bit test - wav
	;		loaddefaultprefs
	;		SecurityCheck no blue flash
	
	;	no 8bit conv flashing


	;	NEWS: 2.3c release 8

	;	ConvTempSample


	;	NEWS: 2.3c release 7
	
	;	NEW: STEREO EXPAND fuer stereo instrs
	;	NEW: NO INSTR UPDATE
	
	;	Replay MACRO: rA
	;	NEW: DrawActualEvent
	;	NEW: SetActualInstrNum, GotoInstrNum, UpdateActWave
	;	NEW: BackupIName,RecallIName


	;	PrintActInstrInfo
	;	Resync after Rendering
	;	ResyncCheck

	;	menu color: black
	;	dsp echo fx protected (case len =0)
	;	ReInitSongSeq (much faster)

	;	BuildMainTitLPF

	;	Pitch Diff: noise !
	;	AdjustPath: wrong text ( SetSampNamePath )
	;	small testwindow (64x40)
	;	max pitch check: C6


	;	Only Correct Sync Check
	;	mA, No Chorus, MaxBuf=8, Kill-> Remove
	;	Left, Right Modes faster and corrected







	;	HISTORY:

	;	SAMPLESTRUCT:  ComplexFX_JMP    MMENU_JL:    PreDspHPFilt
	;	CopyBackStreamOS14_L:	

	;	TESTING:  ClearInstrSaPos
	;	EncodeKey  GetActualNotePtr

       	; 	Symphonie V 2.0
	;	8BIT SAMPLES - 8 BIT MIXER - 8BIT AUDIOOUT

	;	ADDED Quality Paramter
	;	AUTOADJUST system to TONLEITER
	;	Max 100 SAMPLES
	;	Max 24 PATTERNS
	;	INSTRUMENT LOADING
	;	AREA GUI Implemented
	;	PATLEN IMPLEMENTED
	;	PATSPEED Implemented
	;	TRACKBUFFER LEN Bug Fixed

	;	GADGET 030 ERROR FIXED

	;0.6	SAMPLE max len set to 4GIGABYTE !!!
	;	Fixed Noise Bug at EOSamples

	;0.61	GUI for Instr Loop Implemented

	;0.62	Looped Instr testing phase

	;0.63	Fixed: There is a error (illegal memory write -> GURU)
	;	Detected: SAMPLE max len is to 4Mega (Percent Calc Routine)
	;       

	;0.64	Draw Wave autodraws looped range

	;0.65	Stop, Cont Sample FX

	;0.66	AutoAlloc SOUNDATAS
	;	Impl ROT TRACK D,U
	;	Impl Load/Save Soundata   #?.SYMSDTA

	;1.01	Detected: VBR is not used -> crash on MC68040
	;	Fixed:	Memory Trashing
	;		Waveform GFX trashing

	;	New:		ViRT samples
	;			MovePrevInstrument
	;			All Routines are AREA_ID aware

	;	Changed:	DownInstr,UpInstr

	;1.02	Fixed: 		VBR no longer crashing on MC68040

	;	New		Mouse Bar BOOPSI gadget BarGadget
	;			Instrument Finetuning
	;			NoteEd: New Outfit



	;1.04	Fixed: 		LINESAMPLE MEM FAKE REALLOC
	;			LINESAMPLE FLAGSTUFF
	;			KILLSAMPLE routinez
	;			QUEsample: falsche LEN, da bei LEN pitch nicht beruecksichtigt wird
	;			Div Zero on 60Hz Amiga
	;			IF POSNUMB < MODULEPOSNUMB(LOADING...) -> MEMOVERFLOW
	;			SHIFT pressed -> cannolonger select LOOPRANGE with mouse!!!

	;	New		LINESAMPLE : IpolFilter
	;			POSITION   : Tune (PosTuneUp,)
	;			INSTRUMENT OUTFIT
	;			ForceUpdateActInstrType,Pitch/Vol Down/Up Track(Shift)
	;			Sequence
	;			GUI changings
	;			Security

	;	Changed		PattEdDrawStatus,PlaySongPattern

	;	Detect		MIX erhaelt teils falsche SRC position

	;V1.052	BOOLGADGETS, ERRORHANDLER
	;V1.053	EXTRACT SAMPLES
	;V1.054	BLOCK COMMANDS,MACRO RECORDING,AnalyzeMsg(V2.2)
	;V1.055	AUTOLOOP, 16BIT VIRTUELSAMPLE!
	;V1.056	KNACKs reduced, PITCHSLIDE, VOLSLIDE, BLOCKInstr u/d
	;	modularity, new copysample, more SHIFT support	
	;V1.057 Screenmode Requester, Fixed 16Bit Linesample mix memerror
	;	Oversampling Version included, Fontadjust V0.1
	;	(gadtooltest fixed nolonger via addglist!!!)

	;V1.058	Fixed Sync Prob (new period relativ algorithms)
	;	WAV autoconvert algorithm ( WAVtoAMIGA_8Bit )

	;V1.059	Fixed Oversample, Fixed Error in Normal_FREQLIST
	;	Fixed POSITION_LOOPCOUNT ERROR for POS>64
	;	Fixed Track_Mirror

	;V1.060	Fixed Knack at Sample END with x>1 samples playing
        ;	Max Frequenz is now 65KHz (Quality: 225)


	;	DrawDblBorder	had an missing RP move com -> gfx error, mem trashing ???? fixed ?

	;V1.061	FIXED: Sample Extract bug on stereo samples
	;	NEW: Sample load and process algorithms are 16Bit !
	;	NEW: Sample load routine completely rewritten and
	;	     expanded to 16Bit
	;	FIXED: |R|eload sample now reloads stereo samples correctly
	;	NEW: |R|eload sample does a recalc on ViRT samples
	;	NEW: Sample tune range expanded to -/+24 halftones (4 octaves)
	;	NEW: Antiknack algorithm rewritten (now does a 32sample vfade)
	;	FIXED: Stereo samples reimplemented
	;	NEW: Sequencer FX "FromAdd", "FromSet", "SetSpeed"
	;	NEW: multiwindow handler implemented (prepared for new
	;            gui interpreter)
	;	NEW: 040COPYBACK support algorithms implemented



	;V2.01	FIXED Spectrum , SamplePosPtr
	;	FIXED Probs with large Patterns
	;	NEW Undo can now undo Undo (-)
	;	NEW Bps expanded to Max 600Bps
	;	NEW Noise Limiter Implemented (Prefs/)
	;	NEW Menu:Flag Autowindow to Front (if window gets activated)
	;	NEW Sample Volume above 100% now correctly implemented. Non destructive compressor
	;	FIXED Note Delete/Insert Fixed
	;	NEW Song Packer implemented, probs with Songconverter removed
	;	NEW Assist reports a "End of Sequence/Song"
	;	NEW Surround Left/Right expanded to 9Bit (50% less noise)
	;	FIXED Prefs:Force Update (no clock running ...)
	;	BUG REMOVED (Guru at End of Song) detected and Fixed
	;	NEW a lot of Info/Error Msgs redirected to use Assist as Output
	;	  instead of using nasty OK-requests


	;VexQuality	EQU	100		;100%=MAX
	;VexSpeed		EQU	83





	;VexBufferSize 	EQU [[VexQuality*28867]/[50*100*[1+OVERSAMPLING]]]*100/VexSpeed
	;VexPeriod	EQU [124*100]/VexQuality
	;System_FreqBase	EQU [131*124*100]/[VexQuality*350]*[1+OVERSAMPLING]


	;	OverSampBuffSize=VexBufferSize*2
	;	OverSampVoiceBufferSize=OverSampBuffSize*VexBufferNumb

MOUSEXCORR	EQU	4


	IFNE SYMPHPRO
SAMPLELENGTHB	EQU	2	;16 Bit
	ELSE
SAMPLELENGTHB	EQU	1	; 8 Bit
	ENDC


MINBUFFERS	EQU	2
MAXBUFFERS	EQU	40


NGWINDOW_STDW	EQU	320
NGWINDOW_STDH	EQU	160



VexAud0Vol	EQU	0
VexAud1Vol	EQU	0
VexAud2Vol	EQU	0
VexAud3Vol	EQU	0

PlayMusic	EQU	0

PITCHFXSHIFT		EQU	7
PITCHDIFFSHIFT		EQU	12

PITCHSLIDE_LN		EQU	5	;HI = SLOW	
VOLUMESLIDE_LN		EQU	4	;HIGH = FAST
FROMADDSTEP_LN		EQU	14	;HIGH = FAST

Test_PattNumb		EQU	64
Test_LinesPerPattern	EQU	64


Test_SongSpeed		EQU	5
Test_PosNumb		EQU	512
Test_SeqNumb		EQU	64

MaxNumb_Samples		EQU	256
SampleNameMaxLen	EQU	256

	IFEQ	AMINETDEMO
CHANNEL_MAXNUMB		EQU	256
	ELSE
CHANNEL_MAXNUMB		EQU	32
	ENDC

AUDIO_MAXNUMB		EQU	4

NOTEPITCHMAX		EQU	7*12

NGSAMPLEBOOST_DEFAULT	EQU	3000



SAMPLENAME_INSTRTYPE	EQU	128	;0=No Instr
SAMPLENAME_LOOPSTART	EQU	129	;%
SAMPLENAME_LOOPLEN	EQU	130	;%
SAMPLENAME_LOOPNUMB	EQU	131	;0=ENDLESS, 1-255=#
SAMPLENAME_MULTI	EQU	132	;0=MONO
SAMPLENAME_AUTOMAXIMIZE	EQU	133	;0=NO, 1=YES
SAMPLENAME_VOLUME	EQU	134	;0=NO, VOLUME in %1...200%
SAMPLENAME_RELATION	EQU	135	;0=INDEPENDET, 1=PARENT 2=CHILD UNUSED
SAMPLENAME_CHILDNUMB	EQU	136	;0=INDEPENDET UNUSED
;SAMPLENAME_SAMPLETYPE	EQU	137	;0=RAW, 1=IFF
SAMPLENAME_FINETUNE	EQU	138	;SIGNED 0=None [-127...+127]
SAMPLENAME_TUNE		EQU	139	;SIGNED 0=None [-24...+24
SAMPLENAME_LSFLAGS	EQU	140	;LINESAMPLE FLAGS
SAMPLENAME_FILTER	EQU	141	;0=NONE
SAMPLENAME_PLAYFLAG	EQU	142	;0=NRM
SAMPLENAME_DOWNSAMPLE	EQU	143	;0=NONE
SAMPLENAME_RESO		EQU	144	;0=NONE
SAMPLENAME_LOADFLAGS	EQU	145	;0=NORMAL
SAMPLENAME_INFO		EQU	146	;BIT0 
SAMPLENAME_RANGEBGN	EQU	147	;%
SAMPLENAME_RANGELEN	EQU	148	;%
SAMPLENAME_LOOPSTARTLO	EQU	150	; lower bits of loop
SAMPLENAME_LOOPLENLO	EQU	152	; lower bits of loop

SAMPLENAME_RESOFILTERFLAGS EQU	160	;4x LP od HP
SAMPLENAME_RESOFILTERNUMB EQU	161	;Anzahl Punkte
SAMPLENAME_RESOFILTER	EQU	162	;bis 170

SAMPLENAME_VFADESTATUS	EQU	170
SAMPLENAME_VFADEBGN	EQU	SAMPLENAME_VFADESTATUS+1
SAMPLENAME_VFADEEND	EQU	SAMPLENAME_VFADEBGN+1


SNINFO_RANGED	EQU	0	;BIT 0



LOADFLAG_16BIT		EQU	0
LOADFLAG_UNSIGNED	EQU	1
LOADFLAG_RVSFORMAT	EQU	2	;


SPLAYFLAG_DODETUNE	EQU	0	;BIT 0 SET:DO POS TUNE OFFSET
SPLAYFLAG_NODSP		EQU	1	;BIT 1 SET:DRY ROOM
SPLAYFLAG_SUPERFAST	EQU	2	;BIT 2 SET:SYNC PLAY (MONO-> 2xMONO, STEREO->SYNCED)

LSFLAGS_RVS		EQU	0	;BIT 0: reverse sample
LSFLAGS_ASQUEUE		EQU	1	;BIT 1: interprete as list of samples (no mix)
LSFLAGS_MIRROR		EQU	2	;BIT 2: mirror x axis sample
LSFLAGS_16BIT		EQU	3	;BIT 3: for deltapack16
LSFLAGS_NEWLOOP		EQU	4	;New LoopSystem
LSFLAGS_NODSP		EQU	5	;None Dsp


MULTISAMPLE_MONO	EQU	0
MULTISAMPLE_STEREOL	EQU	1
MULTISAMPLE_STEREOR	EQU	2
MULTISAMPLE_LINESRC	EQU	3

INSTRTYPE_SILENT	EQU	-8
INSTRTYPE_KILL	EQU	-4
INSTRTYPE_NONE	EQU	0
INSTRTYPE_LOOP	EQU	4
INSTRTYPE_SUST	EQU	8

INSTRTYPE_MAX	EQU	8


MEM_PTR		EQU	0
MEM_SIZE	EQU	4
MEM_TYPE	EQU	8

MEM_SIZEOF	EQU	12


EXECBASEADR	EQU	4

acode	macro
	CNOP 0,4
	endm

;LVOs
	INCLUDE "lvo/exec.i"
	INCLUDE "lvo/intuition.i"
	INCLUDE "lvo/graphics.i"
	INCLUDE "lvo/dos.i"
	INCLUDE "lvo/xpkmaster_lib.i"

	INCDIR	Assembler:
	acode
	INCLUDE	"exec/exec.i"
;INCLUDE	"exec/exec_lib.i"
	acode
	INCLUDE	"exec/execbase.i"
	acode
	INCLUDE	"intuition/intuition.i"
	acode
	INCLUDE "dos/dos.i"
	acode
	INCLUDE "intuition/intuitionbase.i"
	acode
;	INCLUDE "intuition/gadgetclass.i"
	acode
;	INCLUDE "INCLUDES/libjumps.i"
	acode
	INCLUDE "graphics/displayinfo.i"

	acode
	INCLUDE "hardware/custom.i"
	acode
	INCLUDE "libraries/asl.i"
	acode
	INCLUDE "libraries/gadtools.i"
	IFNE	INCXPK
	acode
	INCLUDE "libraries/xpk.i"
	ENDC
	IFNE    MIDILIB
	INCLUDE	"midi/camd.i"			;MIDI
	ENDC
	acode

	INCLUDE "libraries/reqtools.i"
	INCLUDE "libraries/reqtools_lib.i"



;FREQB_MULTISELECT	EQU	0
;FREQF_MULTISELECT	EQU	$1
;FREQB_SAVE	EQU	1
;FREQF_SAVE	EQU	$2
;FREQB_NOFILES	EQU	3
;FREQF_NOFILES	EQU	$8
;FREQB_PATGAD	EQU	4
;FREQF_PATGAD	EQU	$10
;FREQB_SELECTDIRS	EQU	12
;FREQF_SELECTDIRS	EQU	$1000

FREQ_PATH	EQU	16




 ;--- GADTOOLS ----------------------------------


;CreateContext	EQU	-114
;CreateGadgetA	EQU	-30
;CreateMenusA	EQU	-48
;DrawBevelBoxA	EQU	-120
;FreeGadgets	EQU	-36
;FreeMenus	EQU	-54
;FreeVisualInfo	EQU	-132
;GetVisualInfoA	EQU	-126
;LayoutMenuItemsA	EQU	-60
;LayoutMenusA	EQU	-66
;GT_RefreshWindow	EQU	-84
;GT_GetIMsg      EQU     -72
;GT_ReplyIMsg    EQU     -78


 ;--- INT ----------------------------------

CurrentTime	EQU	-84
;WindowToFront	EQU	-312	;IDCMP_ACTIVEWINDOW
SetWindowTitles	EQU	-276
PubScreenStatus	EQU	-552
ChangeWindowBox	EQU	-486

 ;--- GFX ----------------------------------

AllocBitMap	EQU	-918
BltBitMapRastPort	EQU	-606
FreeBitMap	EQU	-924
RectFill	EQU	-306
ScrollRaster	EQU	-396
SetFont		EQU	-66
ScrollVPort	EQU	-588
ClipBlit	EQU	-552

 ;--- EXEC ----------------------------------

;AllocSignal	EQU	-330
CachePreDMA	EQU	-762
CacheClearU	EQU	-636
FindTask	EQU	-294
;FreeSignal	EQU	-336
Signal		EQU	-324
SuperState	EQU	-150
UserState	EQU	-156
Wait		EQU	-318

 ;--- DOS ----------------------------------

CurrentDir	EQU	-126
DeleteFile	EQU	-72
FilePart	EQU	-870
GetProgramDir	EQU	-600
Seek		EQU	-66
SystemTagList	EQU	-606

;M A C R O S

ERRORTXT	macro
	move.l	#\1,ErrorText_TXT
	jsr	PrintErrorMsg
	endm

ASSTXT	macro
	move.l	#\1,AssText_TXT
	jsr	PrintAssTextF
	endm

ASSTXT2	macro
	puts	a0-a1
	move.l	#\1,a0
	move.l	#\2,a1
	jsr	PrintDblAssString
	gets	a0-a1
	endm


;--- ASSIST STATUS ---

ASSTATUS macro
	puts	a0
	lea.l	\1,a0
	jsr	NGSetStatusText
	gets	a0
	endm

;--- DEBUG FLASH ---

	IFNE	TESTPRGB
FLASH	macro
	move.w	#$\1,$dff180
	endm
	ELSE
FLASH	macro
	;nop
	endm
	ENDC

FLASHB	macro
	move.w	#$\1,$dff180
	endm

BGN	macro
	movem.l	d0-d7/a0-a6,-(a7)
	endm

RET	macro
	movem.l	(a7)+,d0-d7/a0-a6
	rts
	endm

BGNB	macro
	movem.l	d1-d7/a0-a6,-(a7)
	endm

RETB	macro
	movem.l	(a7)+,d1-d7/a0-a6
	rts
	endm
BGNA	macro
	movem.l	d0-d7/a1-a6,-(a7)
	endm
RETA	macro
	movem.l	(a7)+,d0-d7/a1-a6
	rts
	endm

	IFNE TESTPRGB
VHEX	macro
	puts	d0
	move.l	\1,d0
	jsr	PrintAssHex
	gets	d0
	endm

	ELSE
VHEX	macro
	;move.l	\1,d0
	endm
	ENDC


;--- CALLs ---

CALLEXEC	macro
	MOVE.L	4.w,a6
	JSR	_LVO\1(a6)
	endm


CALLINT	macro
	move.l	_IntuitionBase,a6
	jsr	_LVO\1
	endm

CALLMIDI	macro
	move.l	_CamdBase,a6
	jsr	\1(a6)
	endm

GFX	macro                
        move.l  _GraphicsBase,a6
        jsr     _LVO\1        
	endm
DOS	macro                
        move.l  _DOSBase,a6
        jsr     _LVO\1        
	endm

CALLGFX	macro                
        move.l  _GraphicsBase,a6
        jsr     _LVO\1(a6)
	endm
CALLDOS	macro                
        move.l  _DOSBase,a6
        jsr     _LVO\1(a6)
	endm

CALLXPK MACRO
	MOVE.L	_XpkBase,A6
	JSR     _LVOXpk\1(A6)
	ENDM

;CallASL MACRO
;	MOVE.L	ASLBASE,A6
;	JSR     \1(A6)
;	ENDM
	
;GADTOOLS	 macro
;	move.l	_GadToolsBase,a6
;	jsr	\1(a6)
;	endm

CALLREQ	macro
	move.l	_ReqToolsBase,a6
	jsr	_LVOrt\1(a6)
	endm


MoveXY	macro
	move.w  \1,d0
	move.w  \2,d1
	endm

moveqxy	macro
	moveq  \1,d0
	moveq  \2,d1
	endm

puts	macro
	movem.l	\1,-(sp)
	endm

gets	macro
	movem.l	(sp)+,\1
	endm

grts	macro
	movem.l	(sp)+,\1
	rts
	endm
adata	macro
	CNOP 0,4
	endm


;--- SECURITY SYSTEM -------------------------------


	IFNE TESTPRGB	
CHECKREG3 macro
	cmp.l	#0,\1
	bne	.checkreg3OK
	ASSTXT	.checkreg3TEXT
	bra	\3
.checkreg3TEXT
	dc.b	"\1"
	dc.b	" - "
	dc.b	"\2"
	dc.b	" error",0
	acode
.checkreg3OK
	endm
	ELSE
CHECKREG3 macro
	;nop
	endm
	ENDC


	IFNE TESTPRGB	
CHECKREG4 macro
	cmp.l	#0,\1
	bne	.checkreg4OK
	ASSTXT	.checkreg4TEXT
	bra	\3
.checkreg4TEXT
	dc.b	"\1"
	dc.b	" - "
	dc.b	"\2"
	dc.b	" error",0
	acode
.checkreg4OK
	endm
	ELSE
CHECKREG4 macro
	;nop
	endm
	ENDC




	IFNE TESTPRGB	
TSTBYTE macro
	puts	a6
	lea.l	\1,a6
	cmp.l	#0,a6
	beq.s	.ok	
	ASSTXT	.checkreg4TEXT
.ok	gets	a6
	bra	.cont
.checkreg4TEXT
	dc.b	"Illegal byte write to $0"
	dc.b	" - "
	dc.b	"\2"
	acode
.cont
	rts
	ELSE
TSTBYTE macro
	;nop
	endm
	ENDC




	IFNE TESTPRGB	
CHECKREG5 macro
	cmp.l	#0,\1
	bne	.checkreg5OK
	ASSTXT	.checkreg5TEXT
	bra	\3
.checkreg5TEXT
	dc.b	"\1"
	dc.b	" - "
	dc.b	"\2"
	dc.b	" error",0
	acode
.checkreg5OK
	endm
	ELSE
CHECKREG5 macro
	;nop
	endm
	ENDC








;S Y S T E M   C O N S T

ID16BIT	EQU	"16BT"


TRUE	EQU	-1
FALSE	EQU	0

OK	EQU	0
ERROR	EQU	-1

FASTMEMNOCLEAR	EQU	MEMF_ANY
FASTMEM	EQU	MEMF_CLEAR+MEMF_ANY
PUPMEM	EQU	MEMF_CLEAR+MEMF_ANY+MEMF_PUBLIC
CHIPMEM	EQU	MEMF_CHIP+MEMF_CLEAR+MEMF_PUBLIC

SAMPLEMAN_MEMTYPE	EQU	FASTMEM


	IFNE DIRECTAMIGAAUDIO
CUSTOMBASE	EQU	$dff000
	ENDC








;------------------------------

;S E C T I O N		I N I T 

;------------------------------

	SECTION	Hunkstart,CODE

	move.l	EXECBASEADR,EXECBASE
	IFEQ	TESTPRG
rb_HunkStart
	IFNE	DEMO
	move.l	a0,Para_PTR+2
	move.l	d0,Para_PTR+6
	move.w	#TRUE,Para_PTR
	ENDC

	suba.l	A1,A1
	CALLEXEC FindTask
	MOVE.L	D0,A4
	TST.L	$AC(A4)		; pr_CLI
	BNE.S	rb_FromCLI

	move.w	#FALSE,Para_PTR
	LEA	$5C(A4),A0	; pr_MsgPort
	CALLEXEC WaitPort
	LEA	$5C(A4),A0
	CALLEXEC GetMsg
	MOVE.L	D0,WBMSG_PTR		; D7 = WBmsg
	bsr	MAIN	
	bra.s	rb_dexit
rb_FromCLI
	IFNE	DEMO
		bsr	ParseParams
	ENDC
		bsr	MAIN
rb_dexit	
	TST.L	WBMSG_PTR(PC)
	BEQ.S	rb_exit
	MOVE.L	WBMSG_PTR(PC),A1
	CALLEXEC Forbid
	CALLEXEC ReplyMsg
rb_exit	MOVEQ	#0,D0
	RTS

WBMSG_PTR	dc.l	0
rb_DOSname	dc.b	"dos.library",0

	acode
	IFNE	DEMO
ParseParams	
	BGN
	move.w	#TRUE,Para_PTR
	move.l	Para_PTR+2,a0
	move.l	Para_PTR+6,d0

ParseParams_L
	lea.l	1(a0),a0
	subq.l	#1,d0
	beq.s	ParseParams_None

	cmpi.b	#" ",(a0)
	beq.s	ParseParams_L

	andi.l	#$ff,d0
	move.l	a0,Para_PTR+2
	move.l	d0,Para_PTR+6

	lea.l	Para_FileName,a1
	
	lea.l	-1(a0),a0
ParseParams_C
	move.b	(a0)+,(a1)+
	dbf	d0,ParseParams_C

	clr.b	-1(a1)

	RET

	acode
ParseParams_None
	move.w	#FALSE,Para_PTR
	RET

	ENDC

	acode
UseParsedParams
	BGN
	IFNE	DEMO
	cmpi.w	#TRUE,Para_PTR
	bne.s	UseParsedParams_X

	move.l  #Para_FileName,AssText_TXT
	jsr     PrintAssTextF

	lea.l	Para_FileName,a0
	move.l	FinalFileNameRT_PTR,a1
	jsr	CopyString

	move.w	#FALSE,Para_PTR
	move.w	#TRUE,MOD_RELOAD	;;
	move.w	#TRUE,AutoLoadMod
	move.w	#TRUE,BatchProc

UseParsedParams_X

	ENDC
	RET

	acode
AutoStartMod
	IFNE	DEMO
	cmpi.w	#TRUE,AutoPlayMod
	bne.s	AutoStartMod_X
	move.w	#FALSE,BatchProc
	move.w	#FALSE,AutoPlayMod
	jsr	PlayActualSong

AutoStartMod_X
	ENDC
	rts


BatchProc	dc.w	FALSE
AutoLoadMod	dc.w	FALSE
AutoPlayMod	dc.w	FALSE
	ENDC

	acode
	even
_SysBase
EXECBASE	dc.l	0


;--------------------------------------

;SECTION	M A I N

;--------------------------------------

	acode
MAIN
j
	BGN

	suba.l	A1,A1
	CALLEXEC FindTask
	move.l	d0,SymphonieTask_PTR
	move.l	d0,MyScreenTask+4
	jsr	GetProcessor	
	move.w	Processor_FLAGS,d0
	btst	#AFB_68020,d0
	bne.s	Processor_Ok
	btst	#AFB_68030,d0
	bne.s	Processor_Ok

	btst	#AFB_68040,d0
	bne.s	Processor_Ok

	bra	Processor_Fail
VersionString	
	IFNE	SYMPHPRO
	dc.b	"$VER: Symphonie Pro "
	DetailVerString
	dc.b	0
	ELSE
	IFEQ AMINETDEMO
	dc.b	"$VER: Symphonie Jr "
	ELSE
	dc.b	"$VER: FREE Symphonie "
	ENDC
	DetailVerString
	dc.b	0
	ENDC
	even
	dc.w	VERSION,REVISION

	acode


	XREF _OpenLibs
	XREF _CloseLibs

Processor_Ok
	;moveq	#-1,d0
	;CallEXEC AllocSignal(a6)
	;move.l	d0,MyScreenPubSig+4

	;jsr	SetEightVoices

	move.w  #TRUE,ERROR_FLAG

	move.l	#ERRNoLibs_TXT,ErrorText_TXT
	;lea.l	MAIN_AUTOLIBLIST,a0
	;jsr		OpenAutoLiblist
	jsr 	_OpenLibs
	tst.w	d0
	;bne.W	ERR_Libs
	beq.w 	ERR_Libs


	move.l	#ERRNoResMem_TXT,ErrorText_TXT
	lea.l	Resident_AUTOMEM,a0
	jsr		AutoGetMem
	cmpi.w	#TRUE,d0
	bne.W	ERR_ResMem



	;--- ENCODE STRINGS --------------------------------
	IFNE SAVEENCODED
	jsr	SaveEncodedStrings
	ENDC

	IFNE USEENCODED
	jsr	DecodeStrings
	ENDC


ChangeScreenModeDO

	jsr	InitMacroMem
	jsr	InitColTTab
	jsr	LoadTempPrefs
	;jsr	BuildCompressorTab


	clr.b	OnWBScreen
	move.l	#ERRNoScrMode_TXT,ErrorText_TXT
	;--- ALLOC SCREENMODE REQ ---
	IFEQ SMALLGUI
	moveq	#RT_SCREENMODEREQ,d0
	suba.l	a0,a0
	CALLREQ AllocRequestA
	move.l	d0,ScreenModeReq_PTR
	tst.l	d0
	beq		ERR_NOSCRMODEReqA


	;--- PLAYER START --- ??
	cmpi.w	#TRUE,Para_PTR
	bne.s	ReAsk_BatchStart
	ENDC

	lea.l	TempPrefs_Head,a2
	move.w	#2,30(a2)
	jsr		SetWBScreen
	bra		OpenWBScreen



ReAsk_BatchStart

	IFEQ	TESTPRGB
ReAsk_ModeID
	;--- DISPLAY SCREEN MODE REQUESTER ---

	;lea.l	TempPrefs_Head,a2	;ScreenMode Daten in TempPrefs
	;move.l	REQ_DisplayID(a0),d0
	;move.l	d0,20(a2)
	;move.l	REQ_DisplayWidth(a0),d0
	;move.w	d0,24(a2)
	;move.l	REQ_DisplayHeight(a0),d0
	;move.w	d0,26(a2)
	;move.w	REQ_DisplayDepth(a0),d0
	;move.w	d0,28(a2)
	;move.w	#1,30(a2)	;Mode Custom Screen


	IFEQ SMALLGUI
	move.l	ScreenModeReq_PTR,a1
	move.w	#4,rtsc_DisplayDepth(a1)
	lea.l	ScreenModeReq_TAGS,a0
	lea.l	ScreenModeReq_txt,a3
	
	move.l	#ERRNoScrMode_TXT,ErrorText_TXT
	CALLREQ ScreenModeRequestA
	tst.w	d0
	bne.s	.ScrMd_Ok

	jsr	xxx


	;--- ASK WB SCREEN ---
	clr.l	InfoRequest_TAGS+4	;Set WB Request Screen
	lea.l	TryWbScr_CTXT,a0
	jsr		MulitChoiceRequest
	tst.w	d0
	beq		ScrMdExit
	cmpi.w	#1,d0
	beq.s	ReAsk_ModeID
	ENDC



	lea.l	TempPrefs_Head,a2
	move.w	#2,30(a2)	;Set WB - TempPrefs
	jsr		SetWBScreen
	bra		OpenWBScreen


.ScrMd_Ok
	;--- SET SCREEN PREFS ---

	moveq	#0,d0
	move.l	ScreenModeReq_PTR,a0
	move.l	rtsc_DisplayID(a0),DisplayID2_ADR+4	;ID
	move.w	rtsc_DisplayWidth(a0),d0
	move.l	d0,DisplayID2_ADR+12
	move.w	rtsc_DisplayHeight(a0),d0		;H
	move.l	d0,DisplayID2_ADR+20
	move.l	d0,SCOPEBM_H
	move.w	rtsc_DisplayDepth(a0),d0		;W
	move.l	d0,DisplayID2_ADR+28
	cmpi.w	#1,d0
	bne.s	.Menucolor
	move.w	#$0000,MENUCOL
.Menucolor

	;move.l	ScrModeRequest_PTR,a0
	;jsr	SetCustomScreenPrefs

	ENDC


	;--- OPEN A SCREEN ---
	lea.l	MainScreen_PTR+4,a1
	suba.l	a0,a0
	CALLINT 	OpenScreenTagList(a6)
	move.l	d0,MainScreen_PTR
	IFEQ	TESTPRGB
	beq.w	ReAsk_ModeID
	ENDC

OpenScreen_OK
	move.l	d0,TestWin_TAGS+4
	move.l	d0,a0
	jsr		SetRequesterScreen
	jsr		MakeScreenPublic
	
	
OpenWBScreen
	move.l	#ERRNoFileReq_TXT,ErrorText_TXT


	;--- ALLOC FILE REQUESTER ---
	clr.l	RQReqStruct_PTR
	moveq	#RT_FILEREQ,d0
	suba.l	a0,a0
	CALLREQ	AllocRequestA
	tst.l	d0
	beq		ERR_NOASLFR
	move.l	d0,RQReqStruct_PTR


	move.l	SuperSupportTable_PTR,a0
	move.l	MainScreen_PTR,SST_PTR_Screen(a0)



	jsr		AllocateScopeBM

	lea.l	Test_VOICEEXPANDER,a0
	move.l	Test_SAMPLE,VOICEEXP_FIRSTSAMPLEPTR(a0)

	moveqxy	#10,#0				;MENU
	move.l	AutoMenu_PTR,a0
	lea.l	MenuDef_TXT,a1
	jsr		AutoMenu

;	lea.l	MenuDef_TXT(PC),a0
;	move.l	AutoMenu_PTR,a1
;	jsr	NewAutoMenu


	move.l	#ERRNoVisualInfo_TXT,ErrorText_TXT

	move.l	MainScreen_PTR,a0
	suba.l	a1,a1

;	GADTOOLS GetVisualInfoA
;	move.l	d0,VisualInfo_PTR
;	beq.w	ERR_NoVisualInfo
;	move.l	VisualInfo_PTR,GADDEF_ADR+22
;	move.l	MainScreen_PTR,a0
;	move.l	40(a0),GADDEF_ADR+12	;Set GadText Attr
;	move.l	40(a0),MENULAYOUT_TAGS+4
;	move.l	testmenu2_PTR,a0				;M E N U S !!!
;	lea.l	NEWMENU_TAGS,a1
;	GADTOOLS CreateMenusA
;	move.l	d0,NewMenu_PTR
;	beq.w	ERR_NoMenus
;	move.l	NewMenu_PTR,a0
;	move.l	VisualInfo_PTR,a1
;	lea.l	MENULAYOUT_TAGS,a2
;	GADTOOLS LayoutMenusA
;	tst.l	d0
;	beq.w	ERR_MenuLay

	jsr		InitProjectTitle

;	lea.l	Context_PTR(PC),a0
;	GADTOOLS CreateContext
;	move.l	d0,ContextGad_PTR
;	move.l	d0,TestWin_GADTAG+4
;	beq.L	ERR_NOCONTEXT
;	moveq	#CHECKBOX_KIND,d0
;	move.l	ContextGad_PTR,a0
;	lea.l	GADDEF_ADR(PC),a1
;	suba.l	a2,a2
;	GADTOOLS CreateGadgetA
;	tst.l	d0
;	beq.L	ERR_NoGad

	jsr		BuildMainTitle
	;move.l	ScreenTitle_PTR,TestWin_SCRTITLE+4
	move.l	ScreenTitle_PTR,AutoWin_SCRTITLE+4

	move.l	#ERRNoWindow_TXT,ErrorText_TXT


	;--- OPEN TEST WINDOW ---
	lea.l	TestWin_TAGS,a1
	suba.l	a0,a0
	CALLINT OpenWindowTagList(a6)
	move.l	d0,TestWin2_PTR
	beq.w	ERR_NOWIN
	move.l	TestWin2_PTR,a0
	lea.l	TestWin_SCR,a1
	jsr		GetWinStruct
	move.l	TestWin2_PTR,a0
	jsr		InitWinFontDim
	move.l	TestWin2_PTR,a0
	CALLINT	CloseWindow(a6)


	
	jsr		LoadDefaultPrefs
	jsr		NGOpenWindows

	;IFNE	DIRECTPEDGFX
	;jsr	SetScreenFont
	;ENDC
	;jsr	CalcScreenDepth

	;--- INIT OLD GFX SYSTEM ---

	IFNE DIRECTAMIGAAUDIO
	jsr		GetAudioDevice
	cmpi.b	#FALSE,AUDIODEV_TAKEN
	beq.w	ERR_NOAUDIODEVICE
	ENDC


	IFNE AMINETDEMO
	lea.l	Welcome_CTXT,a0
	jsr		MulitChoiceRequest
	ENDC

	IFNE	SOUND14BIT
	jsr	Build14BitTab
	ENDC

	jsr	BuildSinusTab
	jsr	Init9BitStream

	jsr	CDtoProgramDir

	jsr	SetZeroVolume




	;--- MAIN LOOP ---

	bsr	MainLoop

	;--- MAIN LOOP END ---


	jsr	SetOldCList


	IFNE MIDILIB
	jsr	DeInitMidi
	ENDC

	jsr	SaveTempPrefs
	jsr	DSPPlugCleanup
	IFNE DIRECTAMIGAAUDIO
	jsr	FreeAudioDevice
	ENDC
	jsr	CDtoOldDir

ERR_NOAUDIODEVICE

;	jsr	FreeTempMem


ERR_NGWIN
	jsr	NGCloseWindows


ERR_NOWAVEWIN

ERR_NOWIN


ERR_NoGad
;		move.l	ContextGad_PTR,a0
;		GADTOOLS FreeGadgets

ERR_NOCONTEXT


ERR_MenuLay
;		move.l	NewMenu_PTR,a0
;		GADTOOLS FreeMenus
ERR_NoMenus
;		move.l	VisualInfo_PTR,a0
;		GADTOOLS FreeVisualInfo

ERR_NoVisualInfo
		jsr	FreeScopeBM
		;--- FREE FILE REQUESTER ---
		move.l	RQReqStruct_PTR,a1
		bsr	FreeReqtoolsRequest

ERR_NOASLFR	;--- CLOSE SCREEN ---
		tst.b	OnWBScreen
		bne.s	ScrMd_Quit
		move.l	MainScreen_PTR,a0
		cmp.l	#0,a0
		beq.s	ScrMd_Quit
		CALLINT	CloseScreen(a6)
		clr.l	MainScreen_PTR
		bra.s	ScrMd_Quit
ScrMdExit	move.w	#FALSE,ERROR_FLAG
		clr.l	ErrorText_TXT

ScrMd_Quit


ERR_NOSCRMODEReqA					;Free ScreenMode Req
		IFNE SMALLGUI
		move.l	ScreenModeReq_PTR(PC),a1
		bsr	FreeReqtoolsRequest
		ENDC

ERR_ResMem	lea.l	Resident_AUTOMEM,a0
		move.l	#$00010001,MEM_DEBUG_INFO
		move.l	#$00000000,MEM_DEBUG_INFO+4
		jsr	AutoFreeMem


		IFEQ	TESTPRGB
		cmpi.b	#TRUE,CHANGE_SCREENMODE
		bne.s	.quit
		move.w	#FALSE,MAINEXIT_FLAG
		move.b	#FALSE,CHANGE_SCREENMODE
		move.w	#FALSE,ERROR_FLAG
		suba.l	a0,a0
		jsr	SetRequesterScreen
		jsr	ClrSystemRequesterScreen

		move.l	#ERRNoResMem_TXT,ErrorText_TXT
		lea.l	Resident_AUTOMEM,a0
		jsr	AutoGetMem
		cmpi.w	#TRUE,d0
		bne	.quit


		bra	ChangeScreenModeDO
.quit		
		ENDC




ERR_Libs
	;lea.l	MAIN_AUTOLIBLIST,a0
	;jsr		CloseAutoLiblist
	jsr 	_CloseLibs

	cmpi.w	#TRUE,ERROR_FLAG
	beq		MAIN_ERREXIT
	jsr		PrintErrorMsg
	RET

xxx	BGN
	move.l	#20000,d0
.loop
	move.w	#$ff0,$dff180
	move.w	#$f00,$dff180
	dbf	d0,.loop
	RET


	acode
ScreenModeReq_PTR	dc.l	0
ScreenModeReq_TAGS	
	dc.l	RTSC_Flags,SCREQF_SIZEGADS+SCREQF_DEPTHGAD
	dc.l	RTSC_MinWidth,320
	dc.l	RTSC_MinHeight,200
	dc.l	TAG_DONE


	acode
FreeReqtoolsRequest
	cmp.l	#0,a1
	beq.s	.exit
	CALLREQ	FreeRequest
.exit	rts

	acode
ChangeScreenMode
	move.w	#TRUE,MAINEXIT_FLAG
	move.b	#TRUE,CHANGE_SCREENMODE
	rts
CHANGE_SCREENMODE	dc.b	FALSE


;--- MAIN LOOP ---

	acode
MainLoop:
	BGN
	IFNE RENDER
	jsr	InitRenderPrefs
	ENDC

.Restart_J

	jsr	ClrLockState
	IFNE	DIRECTAMIGAAUDIO
	jsr	SetZeroVolume
	ENDC
	jsr	PreCalcMemUsage

	move.w	#FALSE,Restart_FLAG
	move.w  #TRUE,ERROR_FLAG
	move.w	#FALSE,MAINEXIT_FLAG


	move.l	#ERRNoMainMem_TXT,ErrorText_TXT

	lea.l	Main_AUTOMEM,a0
	jsr	AutoGetMem
	cmpi.w	#TRUE,d0
	bne	.ERR_MainMem

	;--- Clear Instrument Names ---
	jsr	ClearInstrNameList
	

	;--- INIT KEYBOARD ---
	lea.l	Standard_KEYTRANS,a0
	jsr	InitKeyTrans

	;--- INIT SONG STRUCTURES ---
	jsr	InitSongDatas
	jsr	TestInitPatterns
	lea.l	Test_PATTED,a0
	lea.l	Test_SONG,a1
	move.w	#Test_PosNumb,SONG_NUMBSONGDATA(a1)
	move.l	TestSongData_PTR,SONG_FIRSTSONGDATA(a1)
	move.w	#SONGT_SINGLE,SONG_TYPE(a1)
	move.w	#Test_SongSpeed,SONG_SPEED(a1)
	move.w	CHANNEL_NUMB,SONG_NUMBVOICES(a1)
	jsr	InitSequences
	jsr	ForceAllTracksOn

	IFEQ	SYMPHPRO
	jsr	InitVolumeList
	ENDC


	;--- Draw Spectrum ---
	jsr	InitSpecNoteAdd

	;--- Make Ts ---
	jsr	SetQuaterTabs


	;--- GET SOUNDENGINE ---
	move.l	#ERRNoVoiceEx_TXT,ErrorText_TXT
	jsr	GetVoiceExpander
	cmpi.w	#TRUE,d0		;success ?
	bne	.ERR_NoVoiceExpander


	jsr	BuildFreqList


	IFNE DIRECTAMIGAAUDIO
	move.w	#$0400,$dff096			;LO BLITTER PRI
	ENDC

	;jsr	AudioDMAReset
	jsr	CollectAutoSignalMask

	jsr	ClearPED

	lea.l	Test_PATTED,a0
	lea.l	Test_SONG,a1
	jsr	InitPattEd	;GURU DEBUG ERROR

	jsr	RedrawSpectrum

	jsr	InitAutoUpdate
	;jsr	FlushCaches

	move.l	SAMPLEMANLIST_PTR,a0
	jsr	InitSampleManagement
	move.l	FirstEntry_INSTR,a0
	jsr	InitInstrList


	jsr	StopAllChannels
	jsr	StopSong

	;--- Start Audio ---
	IFNE DIRECTAMIGAAUDIO
	clr.b	LowCPUWarn			;NEW
	jsr		SetAudioRegisters	;NEW
	jsr		SetAudioIRQ
	move.w	#$00ff,$9e+CUSTOMBASE	;NEW
	jsr		AudioDMAOn			;NEW
	ENDC
	jsr		ClrStreamCount		;NEW
	jsr		SwapSyncBuffer		;NEW

	IFNE DIRECTAMIGAAUDIO
	move.w	#TRUE,IRQStuff_STATUS	;NEW
	ENDC


	move.w	#FALSE,ERROR_FLAG
	clr.l	ErrorText_TXT

	;--- OPTICAL REFRESH ---
	jsr	PattEdDrawStatus
	jsr	DrawPositionCacheReset
	jsr	DrawSongAll
	jsr	DrawInstrumentReset
	jsr	DrawInstrument
	jsr	ResetRelMasterTime
	jsr	DrawPattedTitle
	IFEQ SMALLGUI
	jsr	RedrawMEventAll
	ENDC
	IFNE	SOUND14BIT
	jsr	StartupMode
	ENDC

	jsr	BuildSuperSupportTable
	IFNE DIRECTAMIGAAUDIO
	jsr	RebuildSoundSystem2	;NEW
	ENDC
	bsr	DrawSystemSetup
	bsr	ShowDspStatus
	jsr	InitActionDelay


	;--- MAIN LOOP ---
	cmpi.w	#TRUE,MOD_RELOAD
	bne.s	.Main_L

	move.l	SAMPLEMANLIST_PTR,a0
	jsr	FreeAllSamples

	jsr	LoadActualModule
	jsr	PattEdDrawStatus	;DEBUG
	jsr	DrawPositionCacheReset
	jsr	DrawSongAll
	jsr	DrawInstrumentReset
	jsr	DrawInstrument
	
	IFNE DIRECTAMIGAAUDIO
	jsr	RebuildSoundSystem
	ENDC

	bsr	DrawSystemSetup
	bsr	ShowDspStatus
	jsr	InitActionDelay

.Main_L
	jsr	AnimateSpecialFX
	jsr	CheckBufferMem
		;jsr	AutoStartMod
		;cmpi.w	#TRUE,AutoLoadMod
		;beq.s	.QUIT

	bsr	GetAutoSignalMask
	tst.l	d0
	beq.s	.Main_L2

	bsr	ResyncCheck

		;IFNE	DEMO
		;jsr	UseParsedParams
		;cmpi.w	#TRUE,AutoLoadMod
		;beq.s	.QUIT
		;cmpi.w	#TRUE,BatchProc
		;beq.s	.Bnowait
		;ENDC

		;tst.w	MouseMark_STATUS
		;bne.s	.Bnowait
		;IFNE	TESTREQHANDLE
		;jsr	ReqAddSignal
		;ENDC
	CALLEXEC	Wait
		;IFNE	TESTREQHANDLE
		;jsr	ReqCheckSignal
		;ENDC

.Bnowait
		;IFNE	TESTPRGB
		;jsr	ShowFreqInfo
		;ENDC


	IFNE	MIDILIB
	jsr	CheckMidiMsg
	ENDC

	IFEQ DEMO
	jsr	CheckXYInBlockRange
	ENDC
		;jsr	doretrigtest
	jsr	CheckQJMsg
	jsr	ProcessAutoUpdate
.Main_L2
	jsr	ResetWinMsgCounter
	jsr	HandleAllMsgs
	tst.l	ResetWinMsgCounter_ADR
	beq.w	.Main_L
	cmpi.w	#TRUE,MAINEXIT_FLAG
	bne.w	.Main_L2

.QUIT
	move.w	#FALSE,IRQStuff_STATUS
	IFNE DIRECTAMIGAAUDIO
	jsr	RemoveAudioIRQ
	ENDC

.ERR_NoVoiceExpander
	move.w	#FALSE,IRQStuff_STATUS
	jsr	StopVoices
	jsr	FreeVoiceExpander

	;E X I T   &   C L E A N U P

	move.l	SAMPLEMANLIST_PTR,a0
	jsr	FreeAllSamples

	jsr	FreeTempSample

.ERR_MainMem
;	jsr	ClearRecoverKey
	lea.l	Main_AUTOMEM,a0
	move.l	#$00010000,MEM_DEBUG_INFO
	move.l	#$00000000,MEM_DEBUG_INFO+4
	jsr	AutoFreeMem
	
.SEX
	jsr	FreeModuleDiz
	jsr	FreeModuleDiz2
	cmpi.w	#TRUE,ERROR_FLAG
	beq.s	.SkipRestart
	cmpi.w	#TRUE,MOD_RELOAD
	beq.w	.Restart_J
	cmpi.w	#TRUE,Restart_FLAG		;Restarting from here
	beq.w	.Restart_J
.SkipRestart
	RET


	acode
SetResync
	move.b	#-1,Resync_FLAG
	rts

	acode
ResyncCheck
	tst.b	Resync_FLAG
	bne.s	ResyncCheck_do
	rts
	acode
ResyncCheck_do
	IFNE DIRECTAMIGAAUDIO
	jsr	RebuildSoundSystem2
	ENDC
	clr.b	Resync_FLAG
	rts

Processor_Fail
	move.l	#ERRProc_TXT,ErrorText_TXT
MAIN_ERREXIT	
	jsr	PrintErrorMsg
	RET





;--- SECTION : 	AUTOUPDATE ---------------------------------------


UPDATE_TASK		EQU	0
UPDATE_SIGNALM	EQU	4
UPDATE_FIRST	EQU	8
UPDATE_STATUS	EQU	12	;WORD TRUE/FALSE

UPENTRY_STATUS	EQU	0	;TRUE/FALSE
UPENTRY_ENABLE	EQU	4	;TRUE/FALSE
UPENTRY_JSR		EQU	8
UPENTRY_SIZEOF	EQU	12

UPENTRYSTATUS_EOF	EQU	$8000

	acode
InitAutoUpdate	;V1.0 NG
	BGN
	lea.l	AutoUpdate_Handler(PC),a5
	suba.l	a1,a1
	CALLEXEC	FindTask
	move.l	d0,UPDATE_TASK(a5)

	move.l	#"CTRL",d0
	jsr	NGFindWindow
	cmp.l	#0,a0
	beq.s	.err

	move.l	NGWIN_SIGMASK(a0),UPDATE_SIGNALM(a5)
	move.w	#FALSE,UPDATE_STATUS(a5)

.exit	RET
.err	ASSTXT	NoUpdateSigtxt
	bra.s	.exit



	acode
SignalAutoUpdate
	puts	d0-d1/a0-a1/a5-a6
	lea.l	AutoUpdate_Handler(PC),a5
	move.l	UPDATE_TASK(a5),a1
	move.l	UPDATE_SIGNALM(a5),d0
	move.w	#TRUE,UPDATE_STATUS(a5)
	CALLEXEC	Signal
	gets	d0-d1/a0-a1/a5-a6
	rts

SetSignal	EQU	-306

	acode
CheckBreakSig
	BGN
	moveq   #0,d0
        moveq   #0,d1
        move.l  4,a6
        jsr     SetSignal(a6)
        andi.l   #4096,d0
	tst.l	d0
	beq.s	CheckBreakSig_X
	jsr	MAINEXIT
CheckBreakSig_X
	RET

	acode
ProcessAutoUpdate
	BGN
	bsr	CheckBreakSig
	lea.l	AutoUpdate_Handler(PC),a5
	jsr	NGWDoAnimations

	cmpi.w	#TRUE,UPDATE_STATUS(a5)
	bne.s	.exit
	jsr	NotifyDSPPlugIn
	move.w	#FALSE,UPDATE_STATUS(a5)

	moveq	#TRUE,d2
	move.l	UPDATE_FIRST(a5),a4
.NEXT	movem.l	(a4)+,d0/d1/a3
		cmpi.l	#UPENTRYSTATUS_EOF,d0
		beq.s	.exit
		cmp.w	d2,d1
		bne.s	.NEXT
		cmp.w	d2,d0
		bne.s	.NEXT
		jsr	(a3)
	bra.s	.NEXT
.exit	RET


AutoUpdate_Handler
	dc.l	0,0
	dc.l	AutoUpdate_Exelist
	dc.w	FALSE

AutoUpdate_Exelist
AutoUpdate_Scopes	dc.l	TRUE,TRUE,BuildScopeImage
AutoUpdate_Spectrum	dc.l	TRUE,TRUE,UpdateDrawSpectrum
			dc.l	TRUE,TRUE,DrawTime
AutoUpdate_DrSeq	dc.l	TRUE,TRUE,UpdateDrawSequence
AutoUpdate_DrPos	dc.l	TRUE,TRUE,UpdateDrawPosition
AutoUpdate_NextLine	dc.l	FALSE,FALSE,UpdateGotoNextLine

			dc.l	UPENTRYSTATUS_EOF
	acode
ToogleNoPosChange
	puts	a0
	lea.l	AutoUpdate_DrPos(PC),a0
	eori.l	#-1,UPENTRY_ENABLE(a0)
	gets	a0
	rts
ToogleNoScroll_SAVE	dc.l	0

	acode
ToogleNoScroll
	puts	a0
	lea.l	AutoUpdate_NextLine(PC),a0
	eori.l	#-1,UPENTRY_ENABLE(a0)
	gets	a0
	rts

	acode
ToogleNoSpectrum
	puts	a0
	lea.l	AutoUpdate_Spectrum(PC),a0
	eori.l	#-1,UPENTRY_ENABLE(a0)
	gets	a0
	rts

	acode
ToogleNoScopes
	puts	a0
	lea.l	AutoUpdate_Scopes(PC),a0
	eori.l	#-1,UPENTRY_ENABLE(a0)
	gets	a0
	rts

	acode
ToogleNoInstr
	eori.l	#-1,InstrUpdate
	rts
InstrUpdate	dc.l	-1

	acode
ToogleForceUpdate
	eori.b	#-1,ForceUpdate
	rts


;--- TIMER ---------------------------------------------------


TIMESTAMP_SEC	EQU	0
TIMESTAMP_MICRO	EQU	4




	acode
ClrStreamCount
	puts	d0
	clr.l	StreamCount
	jsr	GetStreamBufBytes
	move.l	d0,StreamBufLen
	gets	d0
	rts

	acode
ResetRelTime
	puts	d0-d1
	jsr	GetTimeTicks
	move.l	d0,RelTimeBase_STAMP
	move.l	#-1,DrawTime_OLD
	gets	d0-d1
	rts

	acode
ResetRelMasterTime
	bsr	ResetRelTime
	puts	d0-d1
	jsr	GetTimeTicks
	move.l	d0,RelTimeMaster_STAMP
	;lea.l	SongDuration,a1		;??? ###
	gets	d0-d1
	rts

	acode
BackupActTime
	move.w	#TRUE,NotifySeqEnd
	move.l	SongDuration,SongDuration+4
	move.l	SequenceDuration,SequenceDuration+4
	rts

	acode
DrawSeqEndTime
	cmpi.w	#FALSE,NotifySeqEnd
	bne.s	.do
	rts
.do	puts	d0-d1
	bsr	GetTimeTicks
	move.l	SongDuration+4,d0
	beq.s	.exit
	move.l	SequenceDuration+4,d1
	beq.s	.exit
	jsr	BuildTime
	jsr	ShowTime
.exit	move.w	#FALSE,NotifySeqEnd
	gets	d0-d1
	rts

	acode
GetStreamChunkLen
	puts	a0
	lea.l	Test_VOICEEXPANDER,a0
	move.l	VOICEEXP_BUFFERBASE(a0),a0
	moveq	#0,d0
	move.w	BUFFER_SAMPLESPERFRAME(a0),d0
	gets	a0
	rts

	acode
GetStreamBufBytes
	bsr	GetStreamChunkLen
	tst.w	OverSamp_FLAG
	beq.s	.mark
	lsr.w	#1,d0
.mark	rts

	acode
GetTimeTicks			;###
	puts	d1
	move.l	StreamCount,d0
;	jsr	PrintAssHex

	move.l	StreamBufLen,d1
	mulu.l	d1,d0
;	jsr	PrintAssHex
;	move.l	d0,d1
;	jsr	GetSystemFreq
;	divu.l	d0,d1
;	move.l	d1,d0
;	jsr	PrintAssHex
;	jsr	BuildTime
;	jsr	ShowTime
	gets	d1
	rts


	acode
GetRelTime	;V2.0
		;O(D0L,D1L)(in secs)
	puts	d2-d7/a0-a6
	jsr	GetRealSystemFreq
	move.l	d0,d2

	jsr	GetTimeTicks
	move.l	d0,ActTime_STAMP

	lea.l	ActTime_STAMP,a1
	lea.l	RelTimeBase_STAMP,a0
	move.l	(a1),d0
	sub.l	(a0),d0
	divu.l	d2,d0

	lea.l	RelTimeMaster_STAMP,a0
	move.l	(a1),d1
	sub.l	(a0),d1
	divu.l	d2,d1
	gets	d2-d7/a0-a6
	rts

	acode
DrawTime	;V1.0
	jsr	DrawSamplePosition
	cmpi.w	#TRUE,PLAYER_STATUS
	beq.s	.Do
	rts

.Do	BGN
	bsr	GetRelTime
	cmp.l	DrawTime_OLD,d0
	beq.s	.exit

	move.l	d1,SongDuration
	move.l	d0,SequenceDuration
	bsr	BuildTime
	move.l	d0,DrawTime_OLD

	move.l	#"SY3H",d0
	lea.l	TimeString_TXT,a0
	jsr	NGODrawText

	tst.b	PREDSP_UPDATE
	beq.s	.ex
	jsr	ShowMainTitle
	jsr	ShowDspStatus
	clr.b	PREDSP_UPDATE
.ex	bsr	DrawSeqEndTime
.exit	RET

PREDSP_UPDATE	dc.b	1
	even
DrawTime_OLD	dc.l	0

	acode
BuildTime	;I(D0W,D1W)(SECS,MASTERSECS)
	BGN
	lea.l	TimeString_TXT,a0
	bsr		AddTimeString
	move.l	d1,d0
	bsr		AddTimeString
	clr.b	(a0)
	RET

	acode
AddTimeString	;I(D0L,A0L)(SECS,STR_PTR)

	puts	d0-d2/a1-a2
	move.l	a0,a2
	move.l	d0,d2
	divu	#60,d2
	moveq	#0,d0
	move.b	d2,d0
	jsr		ConvertToDecByte
	lea		DecByteSave+1,a0
	move.b	(a0)+,(a2)+
;	cmpi.b	#10,d0
	move.b	(a0)+,(a2)+
	move.b	#":",(a2)+
	moveq	#0,d0
	swap	d2
	move.b	d2,d0
	jsr		ConvertToDecByte
	lea		DecByteSave+1,a0
	move.b	(a0),(a2)+
;	cmpi.b	#10,d0
	move.b	1(a0),(a2)+
	move.b	#" ",(a2)+			;PATTERN NUM
	move.l	a2,a0
	gets	d0-d2/a1-a2
	rts

	
ISTATE_KILLED	EQU	-1	;MINUS=KILLED
ISTATE_ACTIVE	EQU	0
ISTATE_SILENT	EQU	1



	acode
CheckInstrument	;O(D0W:ISTATE)
	puts	d7/a0

	moveq	#ISTATE_KILLED,d7
	jsr		GetActualInstrName
	tst.b	(a0)
	beq.s	.exit
	cmpi.w	#INSTRTYPE_KILL,SAMPLENAME_INSTRTYPE(a0)
	beq.s	.exit
	moveq	#ISTATE_SILENT,d7
	cmpi.w	#INSTRTYPE_SILENT,SAMPLENAME_INSTRTYPE(a0)
	beq.s	.exit
	moveq	#ISTATE_ACTIVE,d7
.exit	move.w	d7,d0
	gets	d7/a0
	rts


;--- DRAW SAMPLE POSITION ----------------------------------------------

	acode
DrawSamplePosition	;V1.0
	BGN
	jsr		CheckInstrument
	tst.w	d0
	bne.w	DrawSamplePosition_X

	jsr		GetActualInstrName
	move.l	a0,a2
	jsr		GetActualInstrument

	move.l	INSTR_SAMPLEPOS(a0),d7
	beq		DrawSamplePosition_X
	move.l	INSTR_SAMPLEPTR(a0),d0
	beq		DrawSamplePosition_X
	move.l	INSTR_NUMBSAMPLES(a0),d6
	beq		DrawSamplePosition_X
	add.l	d0,d6

	sub.l	d0,d6
	bmi		DrawSamplePosition_X
	sub.l	d0,d7
	bmi		DrawSamplePosition_X

	move.l	#"WINS",d0
	move.l	#"SWAV",d1
	jsr		NGGetInnerAreaData
	cmp.l	#0,a1
	beq		.exit

	cmpi.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a2)
	beq.s	.old
	btst	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a2)
	beq.s	.old

	move.w	d2,d5
	lsr.w	#2,d5
	sub.w	d5,d2

.old
	move.w	d0,d5
	andi.l	#$ffff,d2
	mulu.l	d2,d7
	divu.l	d6,d7
	move.w	d7,d2
	add.w	d1,d3

	jsr		NGRInvDrMd
	jsr		NGRDarkAPen

	move.w	d7,d0
	add.w	d5,d0
	add.w	d5,d2
	bsr		ClrSaPoLine
	jsr		DrawLine
	movem.w	d0-d3,OLDSAPOL_LINE
.exit	RET

DrawSamplePosition_X	;Letzte Linie wieder loeschen
	move.l	#"WINS",d0
	move.l	#"SWAV",d1
	jsr		NGGetInnerAreaData
	cmp.l	#0,a1
	beq.s	.exit
	jsr		NGRInvDrMd
	jsr		NGRDarkAPen
	bsr		ClrSaPoLine
.exit	RET

ClrSaPoLine
	tst.w	OLDSAPOL_LINE
	bne.s	.do
	rts
.do	BGN
	movem.w	OLDSAPOL_LINE,d0-d3
	jsr	DrawLine
	clr.w	OLDSAPOL_LINE
	RET

		dc.w	-1
SampleMark_INFO	dc.l	0,0	;PTR,LEN

OLDSAPOL_LINE	dc.w	0,0,0,0


	acode
TestWin2_PTR	dc.l	0,0,0,0,0,0,0,0
MESSAGE_PARAM	dc.l	0

ResetWinMsgCounter_ADR	dc.l	0



TestWin_PTR	dc.l	0
TestWin_TAGS
			dc.l	WA_CustomScreen,0
			dc.l	WA_Left,0
			dc.l	WA_Top,16
			dc.l	WA_Width,30
			dc.l	WA_Height,12
			dc.l	WA_AutoAdjust,TRUE
			dc.l	TAG_DONE



AutoActWindow	dc.b	FALSE


	acode
ToogleAutoActWindow
	eori.b	#-1,AutoActWindow
	rts

	acode
ToogleDMBAbort
	eori.b	#-1,EmAbort
	rts


	acode
SetSystemRequesterScreen
	;I(A0L)(WINDOW)
	puts	a1
	move.l	SymphonieTask_PTR,a1
	move.l	a0,184(a1)
	gets	a1
	rts

ClrSystemRequesterScreen
	tst.l	SymphonieTask_PTR
	beq.s	.exit
	move.l	SymphonieTask_PTR,a0
	clr.l	184(a0)
.exit	rts

	acode
SetAutoMenuStrip	;V1.0
			;I(A0L)(WINDOW)
	cmp.l	#0,a0
	bne.s	.DO
	rts
.DO
	bsr	SetSystemRequesterScreen
	BGN
	move.l  AutoMenu_PTR,a1         
	CALLINT	SetMenuStrip(a6)
	RET

	acode
GetWindowSignal	;V2.0
		;I(A0L)(WINDOW)
		;O(D0L)(SIGNALMASK)
	puts	d1/a0
	cmp.l	#0,a0
	beq.s	.err
	jsr	GetWindowUP
	moveq	#0,d1
	cmp.l	#0,a0
	beq.s	.err
	move.b	15(a0),d1
	moveq	#1,d0
	lsl.l	d1,d0
.exit	gets	d1/a0
	rts
	acode
.err	moveq	#0,d0
	bra.s	.exit

	acode
ResetWinMsgCounter	;V1.0
	clr.l	ResetWinMsgCounter_ADR
	rts

	acode
ProcessWindowMsg	;V1.0
			;I(A0L,A1L)(WINDOW_PTR,JUMPLIST)
	BGN
	cmp.l	#0,a0
	beq.s	.exit
	jsr	GetWindowUP

	puts	a1
	;GADTOOLS GT_GetIMsg
	CALLEXEC	GetMsg
	gets	a1
	tst.l	d0
	beq.s	.exit

	addq.l	#1,ResetWinMsgCounter_ADR

	move.l	d0,a0
	suba.l	a2,a2
	jsr	AnalyzeMsg
.exit	RET

	acode
CollectAutoSignalMask
	BGN
	moveq	#0,d1
	bsr	NGWGetSignalMask
	or.l	d0,d1
	move.l	d1,ASIGMASK
	RET
ASIGMASK	dc.l	0

	acode
GetAutoSignalMask
	move.l	ASIGMASK(PC),d0
	rts


;BeginRefresh	EQU	-354
;EndRefresh	EQU	-366
;
;	acode
;SetRefresh
;	BGN
;	jsr	GetIDWindow
;	move.l	INTBASE,a6
;	move.l	a0,RFWin
;	jsr	BeginRefresh(a6)
;	RET
;
;	acode
;ClrRefresh
;	BGN
;	move.l	RFWin(PC),a0
;	move.l	INTBASE,a6
;	moveq	#TRUE,d0
;	jsr	EndRefresh(a6)
;	RET
;RFWin	dc.l	0


	

;--- NEW WINDOW SYSTEM : WINDOW MANAGER --------------------------------



SONG_NUMBSONGDATA	EQU	0
SONG_SEQCOUNT		EQU	2		;PRIV
SONG_FIRSTSONGDATA	EQU	4
SONG_ACTSONGDATA	EQU	8
SONG_TYPE			EQU	12
SONG_SPEED			EQU	14
SONG_SPEEDCOUNT		EQU	16		;PRIV
SONG_NUMBVOICES		EQU	18		;WORD
SONG_U1				EQU	20		;UNUSED
SONG_INSTRLIST		EQU	24
SONG_FREQLIST		EQU	28		;PRIV
SONG_MAXLINELEN		EQU	32		;WORD
SONG_LINESIZE		EQU	34		;LENGTH OF NOTELINE IN BYTES
SONG_FIRSTSEQ		EQU	38		;PTR
SONG_ACTUALSEQ		EQU	42		;PTR
SONG_SEQNUM			EQU	46		;WORD	ACTUALSEQ#
SONG_SEQCOUNTER		EQU	48		;

SONG_SIZEOF			EQU	64

SONGT_RANDOM		EQU	$200
SONGT_ONCE			EQU	$100
SONGT_LOOP			EQU	$0

SONGT_SINGLE		EQU	-1+SONGT_LOOP
SONGT_MULTI			EQU	-2+SONGT_LOOP




SEQUENCE_STARTPOS	EQU	0
SEQUENCE_LENGTH		EQU	2
SEQUENCE_LOOP		EQU	4	;1 = 1xLOOPEN
SEQUENCE_INFO		EQU	6	;0=PLAY 1=SKIP -1=LAST OF SONG
SEQUENCE_TUNE		EQU	8	;SEQ TRANSPOSE HALBTONES

SEQUENCE_SIZEOF		EQU	16

SEQINFO_PLAY		EQU	0
SEQINFO_SKIP		EQU	1
SEQINFO_ENDSONG		EQU	-1



POSITION_PATHEADPTR	EQU	0	;V1.1

POSITION_LOOPNUMB	EQU	4
POSITION_LOOPCOUNT	EQU	6
POSITION_PATNUM		EQU	8
POSITION_STARTPOINT	EQU	10
POSITION_LEN		EQU	12
POSITION_SPEED		EQU	14
POSITION_TUNE		EQU	16
POSITION_EVENTSPERLINE	EQU	18	;WORD: 0=1 Event per Line

POSITION_SIZEOF		EQU	32






PATHEAD_LINECOUNT	EQU	2	;PRIV
PATHEAD_NOTEDATAPTR	EQU	4
PATHEAD_ACTUALLINEPTR	EQU	8
PATHEAD_STATUS		EQU	12

PATHEADST_DORESET	EQU	0
PATHEADST_PLAYING	EQU	1234

PATHEAD_SIZEOF		EQU	16



PATTED_SONG			EQU	0	;LONG

PATTED_FIRSTNOTEDATA	EQU	4
PATTED_ACTNOTEDATA	EQU	8
PATTED_LINESPERPATTERN	EQU	14	;WORD !!
PATTED_NUMBVOICES	EQU	18
PATTED_FIRSTSONGDATA	EQU	20
PATTED_ACTUALSONGDATA	EQU	24
PATTED_LINESIZE		EQU	28	;Size of 1 line in bytes
PATTED_NOTESIZE		EQU	30


PATTED_CRSRX		EQU	32	;CRSR
PATTED_CRSRY		EQU	34	;
PATTED_CRSRXOFFSET	EQU	60	;CRSR
PATTED_CRSRYOFFSET	EQU	62	;

PATTED_DISPX		EQU	40	;% OF WINW DISP POSITION
PATTED_DISPY		EQU	42	;% OF WINH

PATTED_RP			EQU	46	;LONG



PATTED_WEIDTH		EQU	50	;% OF WINW
PATTED_HEIGHT		EQU	52	;% OF WINH

PATTED_ENTRYH		EQU	56	;PIXEL (-> SCROLL DY)


PATTED_DISPNUMBTRACKS	EQU	64
PATTED_DISPNUMBLINES	EQU	66	;MAX NUMB LINES

PATTED_CRSRNOTEPTR	EQU	72	;LONG ?
PATTED_NOTEOFFSET	EQU	76	;WORD->LONG (1x USED)

PATTED_FIRSTLINEY	EQU	84	;PIX OBSOLETE
PATTED_LASTLINEY	EQU	86	;PIX OBSOLETE

PATTED_TEXTPIXOFFSET	EQU	88	;PIX DISTANCE TEXTY, FIRSTPIXELY OK
PATTED_BORDERDX		EQU	90	;?
PATTED_BORDERDY		EQU	92	;?
PATTED_SCROLLX		EQU	94	;NDEF
PATTED_SCROLLY		EQU	96	;NDEF
PATTED_SCROLLW		EQU	98	;NDEF
PATTED_SCROLLH		EQU	100	;NDEF
PATTED_SCROLLDX		EQU	102	;NDEF
PATTED_SCROLLDY		EQU	104	;NDEF

PATTED_ACTPOSNUM	EQU	114
PATTED_LASTPLAYED	EQU	116

PATTED_CRSRSTATE	EQU	118	;BYTE	TRUE=ON,FALSE=OFF	UNUSED
PATTED_EDITXYWH		EQU	120	;4*WORD			OK
PATTED_NOTEW		EQU	128	;WORD	NOTEW in PIXEL	OK
PATTED_NOTEH		EQU	130	;WORD	NOTEH in PIXEL	OK


PATTED_SIZEOF		EQU	256







NOTE_FULLEMPTY		EQU	$00ff0000


NOTE_FX		EQU	0	;CONTROL BYTE
NOTE_PITCH	EQU	1	;NOW BYTE!!! (WORD)
NOTE_VOLUME	EQU	2	;BYTE
NOTE_INSTR	EQU	3	;BYTE

NOTE_VI		EQU	2	;WORD VVII

NOTE_SIZEOF	EQU	4


FX_VOLUMESLIDEUP	EQU	1
FX_VOLUMESLIDEDOWN	EQU	2
FX_PITCHSLIDEUP		EQU	3
FX_PITCHSLIDEDOWN	EQU	4
FX_REPLAYFROM		EQU	5
FX_FROMANDPITCH		EQU	6
FX_SETFROMADD		EQU	7
FX_FROMADD			EQU	8
FX_SETSPEED			EQU	9
FX_ADDPITCH			EQU	10
FX_ADDVOLUME		EQU	11
FX_VIBRATO			EQU	12
FX_TREMOLO			EQU	13
FX_SAMPLEVIB		EQU	14
FX_PSLIDETO			EQU	15
FX_RETRIG			EQU	16
FX_EMPHASIS			EQU	17
FX_ADDHALVTONE		EQU	18
FX_CV				EQU	19
FX_CVADD			EQU	20
FX_FILTER			EQU	23

FX_DSPECHO			EQU	24
FX_DSPDELAY			EQU	25
FX_DSPCHOR			EQU	26

FXADDPITCH_LN		EQU	7+3
FXADDVOL_LN			EQU	5

FX_OLDNONE			EQU	-1
FX_NONE				EQU	0

FX_MIN	EQU	1
FX_MAX	EQU	FX_DSPDELAY

VOLUME_STOPSAMPLE	EQU	254
VOLUME_CONTSAMPLE	EQU	253
VOLUME_STARTSAMPLE	EQU	252
VOLUME_KEYOFF		EQU	251
VOLUME_SPEEDDOWN	EQU	250
VOLUME_SPEEDUP		EQU	249
VOLUME_SETPITCH		EQU	248
VOLUME_PITCHUP		EQU	247
VOLUME_PITCHDOWN	EQU	246
VOLUME_PITCHUP2		EQU	245
VOLUME_PITCHDOWN2	EQU	244
VOLUME_PITCHUP3		EQU	243
VOLUME_PITCHDOWN3	EQU	242



VOLUME_NONE			EQU	0
VOLUME_MIN			EQU	1
VOLUME_MAX			EQU	100
VOLUME_COMMAND		EQU	200


NOTEPITCH_NONOTE	EQU	-1
NOTEPITCH_MIN		EQU	0
NOTEPITCH_OCTAVE	EQU	12
NOTEPITCH_MAX		EQU	(NOTEPITCH_OCTAVE*7)

INSTR_MAX		EQU	127	;FUER EDITOR

DSPNOTE_TYPE	EQU	NOTE_PITCH
DSPNOTE_LEVEL	EQU	NOTE_INSTR
DSPNOTE_BUF		EQU	NOTE_VOLUME


PEDTITLE_H		EQU	1	;CHARS
PEDLINETITLE_W	EQU	5	;CHARS


;--- DRAW DSP STATUS ---

	acode
ShowDspStatus:
	BGN
	;--- PITCH DIFF/SAMPLE DIFF ---
	move.l	#"SY85",d0
	move.w	SAMPLEDIFF+2,d2
	jsr	NGODrawDecWord4Char

	move.l	#"SY81",d0
	move.w	PITCHDIFF+2,d2
	jsr	NGODrawDecWord3Char

	;--- DSP LEN ---

	move.l	#"SY52",d0		;Echo Len
	move.l	DSP_ECHO_LEN,d2
	jsr	NGODrawDecWord3Char

	move.l	#"SY62",d0		;Delay Len
	moveq	#0,d2
	move.w	DELAYINFO,d2

	jsr	NGODrawDecWord3Char
	move.l	#"SY72",d0		;Echo Len
	move.w	HallInfo,d2

	jsr	NGODrawDecWord3Char
	bsr	DrawDspEchoLvl
	bsr	DrawDspDelayLvl
	bsr	DrawDspHallLvl
	RET

	acode
DrawDspEchoLvl
	puts	d0-d2
	move.l	DSP_ECHO_LVL,d0
	bsr	LnLevelToWord
	mulu	#100,d0
	lsr.l	#8,d0
	cmpi.l	#DSP_CenterEcho,DSPFX
	beq.s	.nrm
	cmpi.l	#DSP_CROSSECHO2,DSPFX
	blo.s	.nrm
	bsr	InvertLnWord
.nrm	moveq	#0,d2
	move.w	d0,d2
	move.l	#"SY56",d0
	jsr	NGODrawFloatValue
	gets	d0-d2
	rts

	acode
DrawDspDelayLvl	
	puts	d0-d2
	moveq	#0,d0
	move.w	DELAYINFO+2,d0
	bsr	LnLevelToWord
	mulu	#100,d0
	lsr.l	#8,d0
	move.l	d0,d2
	move.l	#"SY66",d0
	jsr	NGODrawFloatValue
	gets	d0-d2
	rts

	acode
DrawDspHallLvl	
	puts	d0-d2
	moveq	#0,d0
	move.w	HallInfo+2,d0
	bsr	LnLevelToWord
	mulu	#100,d0
	lsr.l	#8,d0
	bsr	InvertLnWord
	moveq	#0,d2
	move.w	d0,d2
	move.l	#"SY76",d0
	jsr	NGODrawFloatValue
	gets	d0-d2
	rts

	acode
InvertLnWord
		;I(D0W)(VALUE)
	puts	d2
	move.l	#100*100,d2
	lsr.w	#1,d0
	sub.w	d0,d2
	move.w	d2,d0
	gets	d2
	rts

;--- DRAW EVENT ---

	adata
DrawNECache
	dc.l	-1

	acode
ClrDrawNECache
	move.l	#-1,DrawNECache
	rts

	acode
DrawNoteEvent:	;V1.0 NG
		;I(A0L)(ACTUAL_NOTE)
	BGN
	jsr	CheckNoteType
	lea.l	ENone,a2
	cmpi.w	#NOTETYPEID_NONE,d0
	beq.s	.draw
	lea.l	EKeyOn,a2
	cmpi.w	#NOTETYPEID_NOTEON,d0
	beq.s	.draw
	lea.l	ESimpleFX,a2
	cmpi.w	#NOTETYPEID_SIMPLEFX,d0
	beq.s	.draw
	lea.l	EVibrato,a2
	swap	d0
	cmpi.w	#25,d0
	bhi.s	.exit
	subq.w	#1,d0
	bmi.s	.draw

	lea.l	EFXList,a2
	move.l	(a2,d0.w*4),a2

.draw	bsr	.DrawEvent
.exit	RET

	acode
.DrawEvent
	cmp.w	DrawNECache,d0
	beq.s	.DrawEventJSR
	bsr	.DrawEventTitles
	move.w	d0,DrawNECache
.DrawEventJSR
	BGN
	move.l	#"EE11",d6
	moveq	#NUMED_PI,d7
	moveq	#0,d2
	move.b	NOTE_PITCH(a0),d2
	move.l	(a2)+,a3
	jsr	(a3)

	move.l	#"EE21",d6
	moveq	#NUMED_INSTR,d7
	move.b	NOTE_INSTR(a0),d2
	move.l	(a2)+,a3
	jsr	(a3)

	move.l	#"EE31",d6
	moveq	#NUMED_VOL,d7
	move.b	NOTE_VOLUME(a0),d2
	move.l	(a2)+,a3
	jsr	(a3)
	RET

EVENTLIST_TEXT	EQU	3*4

.DrawEventTitles:
	puts	d0/a0-a2
	lea.l	EVENTLIST_TEXT(a2),a2
	move.l	a2,a0
	move.l	#"EE02",d0
	jsr	NGODrawText
	jsr	MoveNextString
	cmpi.b	#"",(a0)
	beq.s	.Skip
	move.l	#"EE10",d0
	jsr	NGODrawText
.Skip	jsr	MoveNextString
	move.l	#"EE20",d0
	jsr	NGODrawText
	jsr	MoveNextString
	move.l	#"EE30",d0
	jsr	NGODrawText
	gets	d0/a0-a2
	rts


;	acode
;DrawNoteInstrument:	;I(D0W,D1W,D2W,A1L)(X,Y,INSTR#,RP)
;	cmpi.b	#-1,d2
;	bne.s	DrawNoteInstrument_M1
;		moveq	#0,d2
;DrawNoteInstrument_M1	jsr	DrawDecByteXY
;	rts
;	cmpi.b	#FX_NONE,NOTE_FX(a0)
;	beq.s	DrawNoteVolume_NoFX
;	cmpi.b	#FX_OLDNONE,NOTE_FX(a0)
;	beq.s	DrawNoteVolume_NoFX
;		puts	a4
;		lea.l	DrawDecByteXY,a4
;		cmpi.b	#FX_FROMADD,NOTE_FX(a0)
;		beq.s	DrawNoteV_M1
;		cmpi.b	#FX_ADDPITCH,NOTE_FX(a0)
;		beq.s	DrawNoteV_M1
;		cmpi.b	#FX_ADDVOLUME,NOTE_FX(a0)
;		beq.s	DrawNoteV_M1
;		bra.s	DrawNoteV_Do		
;DrawNoteV_M1
;			lea.l	DrawSignDecByteXY,a4
;DrawNoteV_Do
;		jsr	(a4)
;		gets	a4
;	bra.s	DrawNoteVolume_X
;
;DrawNoteVolume_NoFX

	acode
DrawNoteVolume	;V1.0
	BGN
	tst.w	d2
	beq.w	.ZERO
	cmpi.b	#VOLUME_COMMAND,d2
	bhi.s	.COM

	move.l	d6,d0
	bsr	EVENTDrawDecByte

	;lea.l	EventVol_TXT,a0
	;move.l	d6,d0
	;jsr	NGODrawText
.exit	RET

.COM	puts	d0
	moveq	#0,d0
	move.b	d2,d0
	lea.l	PEDSiFx_CONVTAB,a0
	jsr	ProcTabValuetoLong
	lea.l	dummy(PC),a0
	move.l	d0,(a0)
	move.l	d0,d3
	gets	d0

	cmpi.l	#-1,d3
	bne.s	.DwCOM

	move.l	d6,d0
	bsr	EVENTDrawDecByte
	bra.s	.exit

.DwCOM	lea.l	dummy-3(PC),a0
	move.l	d6,d0
	jsr	NGODrawText
	bra.s	.exit

.ZERO	move.l	d6,d0
	bsr	EVENTDrawDecByte
	bra	.exit

	dc.l	"    "
dummy	dc.l	0


	acode
DrawNotePitch	;V1.1
		;I(D0W,D1W,D2B,A1L)(X,Y,NOTE#,RP)
	BGN
	cmpi.b	#NOTEPITCH_NONOTE,d2
	beq.s	.NONOTE

	andi.l	#$ff,d2
	divu	Actual_FREQDEF+FREQDEF_OCTAVE,d2
	move.w	d2,d3
	andi.b	#$7,d3
	addi.b	#"0",d3

	swap	d2
	lsl.w	#1,d2

	lea.l	FinalNote_TXT,a0
	lea.l	NoteName_TAB,a2

	move.w	(a2,d2.w),d4
	move.w	d4,(a0)
	move.b	d3,2(a0)

	move.b	3(a0),d5
	clr.b	3(a0)
	move.l	d6,d0
	jsr	NGODrawText
	move.b	d5,3(a0)
.exit	RET

.NONOTE	lea.l	NoNote_TXT,a0
	move.l	d6,d0
	jsr	NGODrawText
	bra.s	.exit





DrawCVIdXY
	BGN

	move.l	d2,d0
	ext.l	d0

	lea.l	CVId_TXT+8,a0
	jsr	ProcTabLongtoLong

	move.l	CVId_ill,CVId_TXT
	tst.l	d0
	bmi.s	.ill
	move.l	d0,CVId_TXT
.ill	lea.l	CVId_TXT,a0
	move.l	d6,d0
	jsr	NGODrawText
.exit	RET


CV_SET		EQU	0
CV_FADE		EQU	1
CV_FADETO	EQU	2
CV_FADELNTO	EQU	3
CV_PAN		EQU	4

CV_MAX		EQU	4


EVENTDrawDecByte
	BGN
	andi.l	#$ff,d2
	move.l	d6,d0
	bsr	NGODrawDecWord6Char
	RET

	acode
NGODrawDecWord6Char	;V1.0 nur fuer Event Editor
			;I(D0L,D2W)(NGGAD ID,VALUE)
	BGN
	exg	d0,d2
	lea.l	DecWordSave,a0
	andi.l	#$ffff,d0
	jsr	ConvertToDecWord
	move.l	DecWordSave+1,d3
	move.l	d3,.txt+2
	move.l	d2,d0
	lea	.txt,a0
	jsr	NGObjectRedraw
	RET
.txt	dc.b	"  ----",0


	acode
DrawSignDecByte6
	BGN
	move.l	d6,d0
	bsr	NGODrawSignByte3Char
	RET

	acode
DrawDecByte6
	BGN
	move.b	d2,d0
	jsr	ConvertToDecByte
	move.l	DecByteSave-1,ValueText6-1
	lea	ValueText6,a0
	clr.b	ValueText6+6
	move.l	d6,d0
	jsr	NGODrawText
	RET

	acode
EDrawNone:
	BGN
	lea.l	None_TXT,a0
	move.l	d6,d0
	jsr	NGODrawText
	RET

	acode
EDrawFilterID:
	BGN
	lea.l	EFilter_Off,a0
	cmpi.b	#0,d2
	beq	.ok
	lea.l	EFilter_LP,a0
	subq.w	#1,d2
	beq	.ok
	lea.l	EFilter_HP,a0
	subq.w	#1,d2
	beq	.ok
	lea.l	EFilter_BP,a0
	subq.w	#1,d2
	beq	.ok
	lea.l	EFilter_NP,a0
	subq.w	#1,d2
	beq	.ok

	lea.l	EFilter_Off2,a0
	subq.w	#1,d2
	beq	.ok
	lea.l	EFilter_LP2,a0
	subq.w	#1,d2
	beq	.ok
	lea.l	EFilter_HP2,a0
	subq.w	#1,d2
	beq	.ok
	lea.l	EFilter_BP2,a0
	subq.w	#1,d2
	beq	.ok
	lea.l	EFilter_NP2,a0
	subq.w	#1,d2
	beq	.ok

	lea.l	EFilter_Off3,a0
	subq.w	#1,d2
	beq.s	.ok
	lea.l	EFilter_LP3,a0
	subq.w	#1,d2
	beq.s	.ok
	lea.l	EFilter_HP3,a0
	subq.w	#1,d2
	beq.s	.ok
	lea.l	EFilter_BP3,a0
	subq.w	#1,d2
	beq.s	.ok
	lea.l	EFilter_NP3,a0
	subq.w	#1,d2
	beq.s	.ok

	lea.l	EFilter_Off4,a0
	subq.w	#1,d2
	beq.s	.ok
	lea.l	EFilter_LP4,a0
	subq.w	#1,d2
	beq.s	.ok
	lea.l	EFilter_HP4,a0
	subq.w	#1,d2
	beq.s	.ok
	lea.l	EFilter_BP4,a0
	subq.w	#1,d2
	beq.s	.ok
	lea.l	EFilter_NP4,a0
	subq.w	#1,d2
	beq.s	.ok



.ill	lea.l	EFilter_Ill,a0
.ok	cmpi.b	#"-",(a0)
	beq.s	.ill
        move.l	d6,d0
	jsr	NGODrawText
	RET
EFilter_Ill	dc.b	"Illegl",0

EFilter_Off	dc.b	"Ch Off",0
EFilter_LP	dc.b	"Ch  LP",0
EFilter_HP	dc.b	"Ch  HP",0
EFilter_BP	dc.b	"Ch  BP",0 
EFilter_NP	dc.b	"-Ch  --",0 

EFilter_Off2	dc.b	"WetOff",0
EFilter_LP2	dc.b	"Wet LP",0
EFilter_HP2	dc.b	"Wet HP",0
EFilter_BP2	dc.b	"Wet BP",0 
EFilter_NP2	dc.b	"-Wet --",0 

EFilter_Off3	dc.b	"DryOff",0
EFilter_LP3	dc.b	"Dry LP",0
EFilter_HP3	dc.b	"Dry HP",0
EFilter_BP3	dc.b	"Dry BP",0 
EFilter_NP3	dc.b	"-Dry --",0 

EFilter_Off4	dc.b	"PstOff",0
EFilter_LP4	dc.b	"PostLP",0
EFilter_HP4	dc.b	"PostHP",0
EFilter_BP4	dc.b	"PostBP",0 
EFilter_NP4	dc.b	"-Post--",0 






	acode
DrawFx8V
	BGN
	ext.w	d2
	move.w	d2,d0
	muls	#(100000/256),d0
	moveq	#FROMADDSTEP_LN-8,d3
	asr.l	d3,d0
	andi.l	#$ffff,d0

;	tst.w	d2
;	bpl.s	.DrawFx8V_Pl
;	neg.w	d0
;.DrawFx8V_Pl

	move.l	d0,d2
	move.l	d6,d0
	jsr	NGODrawFloatValue
	RET

	acode
DrawEVDelayLvl
	BGN
	ext.w	d2
	move.w	d2,d0
	jsr	LnLevelToWord
	muls	#100,d0
	divs	#256,d0
	andi.l	#$ffff,d0
	move.l	d0,d2
	move.l	d6,d0
	jsr	NGODrawFloatValue
	RET


DrawEVEchoLvl
	BGN		;EVActDspFx
	ext.w	d2
	move.w	d2,d0
	jsr	LnLevelToWord
	muls	#100,d0
	divs	#256,d0
	cmpi.b	#3,EVActDspFx
	bne.s	.noinv
	jsr	InvertLnWord
.noinv
	andi.l	#$ffff,d0
	move.l	d0,d2
	move.l	d6,d0
	jsr	NGODrawFloatValue
	RET

	acode
DrawEVCV
	BGN
	ext.w	d2
	move.w	d2,d0
	muls	#100,d0

	;divs	#256,d0
	andi.l	#$ffff,d0
	move.l	d0,d2
	move.l	d6,d0
	jsr	NGODrawFloatValue
	RET


	acode
DrawFx11V
	BGN
	ext.w	d2
	move.w	d2,d0
	asl.w	#FXADDVOL_LN,d0
	muls	#100,d0
	divs	#256,d0
	andi.l	#$ffff,d0
	move.l	d0,d2
	move.l	d6,d0
	jsr	NGODrawFloatValue
	RET

	acode	
DrawFx12V	;V1.0	Add Pitch
	BGN
	ext.w	d2
	move.w	d2,d0
	muls	#10000,d0
	divs	#1024,d0
	andi.l	#$ffff,d0
	move.l	d0,d2
	move.l	d6,d0
	jsr	NGODrawFloatValue2
	RET

	acode
DrawPerHexXY:
	BGN
	andi.w	#$00ff,d2
	move.w	d2,d0
	mulu	#10000,d0
	divu	#256,d0
	andi.l	#$ffff,d0
	move.l	d0,d2
	move.l	d6,d0
	jsr	NGODrawFloatValue
	RET

	acode
DrawFromInstr
	BGN
	tst.b	FromPi_FLAG
	beq.s	.DrawFromInstrOff
	clr.b	FromPi_FLAG
	bsr	EVENTDrawDecByte
	RET
.DrawFromInstrOff
	move.l	d6,d0
	jsr	NGODrawText
	RET

	acode
DrawOffText
	BGN
	lea.l	DrawFromPi_TXT2,a0
	move.l	d6,d0
	jsr	NGODrawText
	RET

	acode
DrawFromPi
	BGN
	clr.b	FromPi_FLAG
	lea.l	DrawFromPi_TXT2,a0
	cmpi.b	#NOTEPITCH_NONOTE,d2
	beq.s	.ill
	lea.l	DrawFromPi_TXT,a0
	move.b	#-1,FromPi_FLAG
.ill	move.l	d6,d0
	jsr	NGODrawText
	RET

	acode
DrawDecPlus1
	puts	d2
	addq.w	#1,d2
	bsr	EVENTDrawDecByte
	gets	d2
	rts

	acode
DrawDspFxXY
	BGN
	move.b	d2,EVActDspFx
	tst.b	d2
	bmi.s	.Ill
	cmpi.b	#DSP_MAX,d2
	bhi.s	.Ill
	lea.l	DspTextList,a0
.loop	subq.b	#1,d2
	bmi.s	.draw
	jsr	MoveNextString
	bra.s	.loop
.Ill	jsr	WarnFlash
	lea.l	DspTextIll_TXT,a0
.draw	move.l	d6,d0
	jsr	NGODrawText
	RET
EVActDspFx	dc.b	0


	acode
DrawLnDecByteXY:	;EVENT ED ONLY
	puts	d0-d2
	exg	d0,d2
	bsr	LnLevelToByte
	exg	d0,d2
	bsr	EVENTDrawDecByte
	gets	d0-d2
	rts

;	acode
;DrawLnDecFWordXY
;	rts
;	puts	d0-d2
;	exg	d0,d2
;	bsr	LnLevelToWord
;	exg	d0,d2
;	jsr	DrawFloatValue
;	gets	d0-d2
;	rts

	acode
LnLevelToByte
	cmpi.b	#32,d0
	bls.s	.ok
	moveq	#0,d0
	rts
	acode
.ok	puts	d1
	move.l	#200,d1
.loop	lsr.w	#1,d1
	subq.b	#1,d0
	bpl.s	.loop
	move.l	d1,d0
	gets	d1
	rts

	acode
LnLevelToWord:
	cmpi.b	#32,d0
	bls.s	.ok
	moveq	#0,d0
	rts
	acode
.ok	puts	d1
	move.l	#200*256,d1
.loop	lsr.l	#1,d1
	subq.b	#1,d0
	bpl.s	.loop
	move.l	d1,d0
	gets	d1
	rts




;--- EVENT DRAW END -----------------------------------------------





;--- GFX lib ---

	acode
DrawFloatValueXY
	BGN
	jsr	GFX_Move	
	move.l	d2,d0
	bsr	DrawFloatValue
	RET

	acode
DrawFloatValue	;I(D0W [*100], D2W[POS/NEG]
	BGN
	lea.l	DecWordSave,a0
	jsr	ConvertToDecWord
	move.w	3(a0),d3
	move.b	#".",3(a0)
	move.w	d3,4(a0)
	tst.w	d2
	bpl.s	.Pl2
	move.b	#"-",(a0)
.Pl2	cmpi.b	#" ",4(a0)
	bne.s	.M3
	move.b	#"0",4(a0)
.M3	lea.l	DecWordSave,a0
	moveq	#6,d0
	GFX	Text(a6)
	RET


	;--- EVENT EDITOR ----------------------------------------



OctaveDown	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	NOTE_PITCH(a1),d0
	cmpi.b	#NOTEPITCH_MIN,d0
	bls.s	OctaveDown_X
		sub.b	Actual_FREQDEF+FREQDEF_OCTAVE+1,d0
		bmi.s	OctaveDown_X
		cmpi.b	#NOTEPITCH_MIN,d0
		blo.s	OctaveDown_X
		move.b	d0,NOTE_PITCH(a1)	
		jsr	PatEdDrawActLine
	bsr	DrawEventStatus
OctaveDown_X	RET

OctaveUp	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	NOTE_PITCH(a1),d0
	cmpi.b	#NOTEPITCH_MAX,d0
	bhs.s	OctaveUp_X
		add.b	Actual_FREQDEF+FREQDEF_OCTAVE+1,d0
		cmpi.b	#NOTEPITCH_MAX,d0
		bhs.s	OctaveUp_X
		move.b	d0,NOTE_PITCH(a1)	
		jsr	PatEdDrawActLine
	bsr	DrawEventStatus
OctaveUp_X	RET

PitchUp	;V1.1
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a0
	jsr	PitchUpNote
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

PitchDown	;V1.1
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a0
	jsr	PitchDownNote
	bsr	DrawEventStatus
	jsr	PatEdDrawActLine
PitchDown_X	RET
	ENDC

SetNoteInstr
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	jsr	GetActualInstrNum
	move.b	d0,NOTE_INSTR(a1)
	bsr	DrawEventStatus
	jsr	PatEdDrawActLine
	RET
	ENDC

NoteInstrDown
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	NOTE_INSTR(a1),d0
	jsr	ProcessInstrDown
	move.b	d0,NOTE_INSTR(a1)
	bsr	DrawEventStatus
	jsr	PatEdDrawActLine
	RET
	ENDC

NoteInstrUp
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	NOTE_INSTR(a1),d0
	jsr	ProcessInstrUp
	move.b	d0,NOTE_INSTR(a1)
	bsr	DrawEventStatus
	jsr	PatEdDrawActLine
	RET
	ENDC




FXPitchDown
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1

	move.b	NOTE_VOLUME(a1),d0
	beq.s	FXSetPitchDown


	cmpi.b	#VOLUME_PITCHDOWN,d0
	beq.s	FXNextPitchDown
	cmpi.b	#VOLUME_PITCHDOWN2,d0
	beq.s	FXNextPitchDown

	cmpi.b	#VOLUME_PITCHUP,d0
	beq.s	FXPitchDownSetZero

	cmpi.b	#VOLUME_PITCHUP2,d0
	beq.s	FXPitchDownDown
	cmpi.b	#VOLUME_PITCHUP3,d0
	beq.s	FXPitchDownDown

	cmpi.b	#VOLUME_PITCHDOWN3,d0
	beq.s	FXPitchDown_X

FXSetPitchDown
		move.b	#VOLUME_PITCHDOWN,d0
		bra.s	FXPitchDown_X

FXPitchDownDown
		addq.b	#2,d0
		bra.s	FXPitchDown_X

FXPitchDownSetZero
		clr.b	d0
		bra.s	FXPitchDown_X


FXNextPitchDown
		subq.b	#2,d0
		bra	FXPitchDown_X

FXPitchDown_X
	move.b	d0,NOTE_VOLUME(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC



FXPitchUp
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1


	move.b	NOTE_VOLUME(a1),d0
	beq.s	FXSetPitchUp

	cmpi.b	#VOLUME_PITCHUP,d0
	beq.s	FXNextPitchUp
	cmpi.b	#VOLUME_PITCHUP2,d0
	beq.s	FXNextPitchUp

	cmpi.b	#VOLUME_PITCHDOWN,d0
	beq.s	FXPitchUpSetZero
	cmpi.b	#VOLUME_PITCHDOWN2,d0
	beq.s	FXPitchDownUp
	cmpi.b	#VOLUME_PITCHDOWN3,d0
	beq.s	FXPitchDownUp
	cmpi.b	#VOLUME_PITCHUP3,d0
	beq.s	FXPitchUp_X

FXSetPitchUp
		move.b	#VOLUME_PITCHUP,d0
		bra.s	FXPitchUp_X

FXPitchDownUp
		addq.b	#2,d0
		bra.s	FXPitchUp_X

FXPitchUpSetZero
		clr.b	d0
		bra.s	FXPitchUp_X


FXNextPitchUp
		subq.b	#2,d0
		bra	FXPitchUp_X

FXPitchUp_X	
	move.b	d0,NOTE_VOLUME(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC


	acode
SetKeyOff
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	GetActualPattEd
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a0
	jsr	FxClrNote_Whole
	move.b	#VOLUME_KEYOFF,NOTE_VOLUME(a0)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC


	acode
FXSetPitch
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#VOLUME_SETPITCH,NOTE_VOLUME(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC


	acode
SetStopSample
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a0
	jsr	FxClrNote_Whole
	move.b	#VOLUME_STOPSAMPLE,NOTE_VOLUME(a0)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC


SetContSample
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a0
	jsr	FxClrNote_Whole
	move.b	#VOLUME_CONTSAMPLE,NOTE_VOLUME(a0)	
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC






	acode
SpeedFXDown
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#VOLUME_SPEEDDOWN,NOTE_VOLUME(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SpeedFXUp
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#VOLUME_SPEEDUP,NOTE_VOLUME(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxFilter
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	bsr	SetFxClrVol
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	clr.l	(a1)
	move.b	#FX_FILTER,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC


SetFxPlayFrom	
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	bsr	SetFxClrVol
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_REPLAYFROM,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxFromP
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	bsr	SetFxClrVol
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_FROMANDPITCH,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxTrem
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	bsr	SetFxClrAll
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_TREMOLO,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxVibrato
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	bsr	SetFxClrAll
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_VIBRATO,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxSampleVib
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	bsr	SetFxClrAll
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_SAMPLEVIB,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxPSlideTo
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	bsr	SetFxClrVol
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_PSLIDETO,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxRetrig
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	bsr	SetFxClrAll
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_RETRIG,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxVFadeIn
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	GetActualNotePtr
	clr.l	(a0)
	move.b	#FX_EMPHASIS,NOTE_FX(a0)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxClrAll
	puts	d0/a0
	jsr	GetActualNotePtr
	jsr	CheckNoteType
	cmpi.w	#NOTETYPEID_COMPLEXFX,d0
	beq.s	SetFxClrAll_X
		clr.l	(a0)
SetFxClrAll_X	gets	d0/a0
	rts

SetFxClrNote
	move.l	#FxClrNote_Whole,FxClrNote
	bra.s	DoFxClrNote
SetFxClrVol
	move.l	#FxClrNote_Vol,FxClrNote
	bra.s	DoFxClrNote
	nop
DoFxClrNote
	BGN
	jsr	GetActualNotePtr
	jsr	CheckNoteType
	cmpi.w	#NOTETYPEID_NONE,d0
	beq.s	SetFxClrNote_X
	cmpi.w	#NOTETYPEID_COMPLEXFX,d0
	beq.s	SetFxClrNote_X
		move.l	FxClrNote(PC),a1
		jsr	(a1)
SetFxClrNote_X	
	bsr	DrawEventStatus
	RET
FxClrNote	dc.l	FxClrNote_Whole
FxClrNote_Whole
	move.l	#NOTE_FULLEMPTY,(a0)
	rts
FxClrNote_Vol
	clr.b	NOTE_VOLUME(a0)
	rts

SetFxSetFromAdd
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_SETFROMADD,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxFromAdd
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_FROMADD,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxSetSpeed
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_SETSPEED,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxCVolAdd
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	bsr	SetFxClrAll
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_CVADD,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxCVol	;CV	CFXID,	CVID,	PARAM1,	PARAM0
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	bsr	SetFxClrAll
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_CV,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxSetADDPITCH
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_ADDPITCH,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC


SetFxSetADDHALVTONE
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_ADDHALVTONE,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetFxSetADDVOL
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_ADDVOLUME,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC


SetFxDspOn	
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1

	move.b	#FX_DSPECHO,NOTE_FX(a1)
	move.l	DSPFX,d0
	move.b	d0,DSPNOTE_TYPE(a1)
	move.l	DSP_ECHO_LVL,d0
	move.b	d0,DSPNOTE_LEVEL(a1)
	move.l	DSP_ECHO_LEN,d0
	move.b	d0,DSPNOTE_BUF(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

DeactivateDelay
	bclr	#POSTDELAY,POSTDSP_FLAG
	jsr	SetPostDsp
	rts
SetDspDelay
	bset	#POSTDELAY,POSTDSP_FLAG
	move.l	#PrepPostDsp,POSTDSP
	rts
SetDspCrossDelay
	bset	#POSTDELAY,POSTDSP_FLAG
	move.l	#PrepPostDsp,POSTDSP
	rts

SetFxDspDelay
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1

	move.b	#FX_DSPDELAY,NOTE_FX(a1)

	moveq	#DSP_DELAY,d0
	btst	#POSTDELAY,POSTDSP_FLAG
	bne.s	SetFxDelayOn
		moveq	#DSP_OFF,d0
SetFxDelayOn
	move.b	d0,DSPNOTE_TYPE(a1)

	move.w	DELAYINFO+2,d0
	move.b	d0,DSPNOTE_LEVEL(a1)
	move.w	DELAYINFO,d0
	move.b	d0,DSPNOTE_BUF(a1)

	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

;SetFxDspChor
;	IFNE	DEMO
;	rts
;	ELSE
;	BGN
;	jsr	BackupPattern
;	lea.l	Test_PATTED,a0
;	jsr	CalcActNoteData
;	move.l	PATTED_ACTNOTEDATA(a0),a1
;	move.b	#FX_DSPCHOR,NOTE_FX(a1)
;	move.b	d0,DSPNOTE_TYPE(a1)
;	move.b	d0,DSPNOTE_LEVEL(a1)
;	move.b	d0,DSPNOTE_BUF(a1)
;	jsr	PatEdDrawActLine
;	RET
;	ENDC



SetVolSlideUp
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_VOLUMESLIDEUP,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetVolSlideDown
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_VOLUMESLIDEDOWN,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetPSlideUp
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_PITCHSLIDEUP,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetPSlideDown		
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_PITCHSLIDEDOWN,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetNoneFX		
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	move.b	#FX_NONE,NOTE_FX(a1)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

EditVolume	
	IFNE	DEMO
	rts
		ELSE
	BGN
	jsr	BackupPattern
	jsr	GetActualPattEd
	jsr	CalcActNoteData
	move.l	a0,a2
	move.l	PATTED_ACTNOTEDATA(a2),a3

EditVolume_REP
		moveq	#0,d0
		move.b	NOTE_VOLUME(a3),d0
		lea.l	EditBuf(PC),a0
		move.l	d0,(a0)
		lea.l	EditVolume_TXT,a1
		moveq	#1,d1
		moveq	#100,d2
		jsr	ReqMinMaxLong
		tst.w	d0
		beq.s	EditVolume_X
		tst.l	(a0)
		beq.s	EditVolume_REP

	move.l	(a0),d0
	move.b	d0,NOTE_VOLUME(a3)

	jsr	GetActualPattEd
	jsr	PatEdDrawActLine

EditVolume_X	
	bsr	DrawEventStatus
	RET
	ENDC
EditBuf	dc.l	0


	acode
EditPitch	
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	GetActualPattEd
	jsr	CalcActNoteData
	move.l	a0,a2
	move.l	PATTED_ACTNOTEDATA(a2),a3

EditPitch_REP
		moveq	#0,d0
		move.b	NOTE_PITCH(a3),d0
		lea.l	EditBuf(PC),a0
		move.l	d0,(a0)
		lea.l	EditPitch_TXT,a1
		moveq	#NOTEPITCH_MAX,d1
		jsr	NaturalLongRequestZ
		tst.w	d0
		beq.s	EditPitch_X
		;tst.l	(a0)
		;beq.s	EditPitch_REP

	move.l	(a0),d0
	move.b	d0,NOTE_PITCH(a3)

	jsr	GetActualPattEd
	jsr	PatEdDrawActLine

EditPitch_X
	bsr	DrawEventStatus
	RET
	ENDC



;	acode
;Volume25		IFNE	DEMO
;	rts
;	ELSE
;	BGN
;	lea.l	Test_PATTED,a0
;	jsr	CalcActNoteData
;	move.l	PATTED_ACTNOTEDATA(a0),a1
;	move.b	#25,NOTE_VOLUME(a1)
;	jsr	PatEdDrawActLine
;	RET
;	ENDC

;Volume50		IFNE	DEMO
;	rts
;	ELSE
;	BGN
;	lea.l	Test_PATTED,a0
;	jsr	CalcActNoteData
;	move.l	PATTED_ACTNOTEDATA(a0),a1
;	move.b	#50,NOTE_VOLUME(a1)
;	jsr	PatEdDrawActLine
;	RET
;	ENDC

;Volume75		IFNE	DEMO
;	rts
;	ELSE
;	BGN
;	lea.l	Test_PATTED,a0
;	jsr	CalcActNoteData
;	move.l	PATTED_ACTNOTEDATA(a0),a1
;	move.b	#75,NOTE_VOLUME(a1)
;	jsr	PatEdDrawActLine
;	RET
;	ENDC

;Volume100		IFNE	DEMO
;	rts
;	ELSE
;	BGN
;	lea.l	Test_PATTED,a0
;	jsr	CalcActNoteData
;	move.l	PATTED_ACTNOTEDATA(a0),a1
;	move.b	#100,NOTE_VOLUME(a1)
;	jsr	PatEdDrawActLine
;	RET
;	ENDC


VolumeDown
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a0
	jsr	VolDownNote
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetVolume
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	GetActNote
	move.b	#1,NOTE_VOLUME(a0)
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET
	ENDC

SetActNoteVolume
	puts	a0
	jsr	GetActNote
	move.b	d0,NOTE_VOLUME(a0)
	gets	a0
	rts

SetActNotePitch
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	mulu	#NOTEPITCH_MAX,d0
	divu	#100,d0
	move.b	d0,NOTE_PITCH(a1)
	RET


VolumeUp
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a0
	
	cmpi.l	#NOTE_FULLEMPTY,(a0)
	beq.s	VolumeUp_SETCOM

	jsr	VolUpNote
VolumeUp_C
	jsr	PatEdDrawActLine
	bsr	DrawEventStatus
	RET

VolumeUp_SETCOM
	move.b	#1,NOTE_VOLUME(a0)
	bra.s	VolumeUp_C

	ENDC











	acode
NOTELEN	dc.l	10

	acode
MoveFirstPattern
	IFEQ	DEMO
	puts	d0
	moveq	#0,d0
	jsr	SetPatternNum
	jsr	PattedUpdateDisp
	jsr	UpdatePosList
	jsr	DrawEventStatusQ
	gets	d0
	ENDC
	rts

MoveLastPattern
	IFEQ	DEMO
	puts	d0
	move.l	VEX_PattNumb,d0
	subq.w	#1,d0
	jsr	SetPatternNum
	jsr	PattedUpdateDisp
	jsr	UpdatePosList
	jsr	DrawEventStatusQ
	gets	d0
	ENDC
	rts


	acode
MoveFirstPosition
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a1
	jsr	GetActualPattEd
	move.w	SEQUENCE_STARTPOS(a1),PATTED_ACTPOSNUM(a0)
	bsr	PosToPatNum
	jsr	PattedUpdateDisp
	jsr	UpdatePosList
	RET

GotoFirstPosition
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a1
	jsr	GetActualPattEd
	move.w	SEQUENCE_STARTPOS(a1),PATTED_ACTPOSNUM(a0)
	bsr	PosToPatNum
	RET


MoveLastPosition
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a1
	jsr	GetActualPattEd
	move.w	SEQUENCE_STARTPOS(a1),d0
	add.w	SEQUENCE_LENGTH(a1),d0
	subq.w	#1,d0
	move.w	d0,PATTED_ACTPOSNUM(a0)
	bsr	PosToPatNum
	jsr	PattedUpdateDisp
	jsr	UpdatePosList
	RET


	acode
MovePosUp	;V1.1	wird auch im irq aufgerufen !!!
	puts	a0
	jsr	GetActualPattEd
	cmpi.w	#Test_PosNumb-1,PATTED_ACTPOSNUM(a0)
	blo.s	.ok
		move.w	#Test_PosNumb-1,PATTED_ACTPOSNUM(a0)
		bra.s	.exit
.ok		addq.w	#1,PATTED_ACTPOSNUM(a0)
.exit	bsr	PosToPatNum
	gets	a0
	rts

	acode
MovePosDown
	puts	a0
	jsr	GetActualPattEd
	tst.w	PATTED_ACTPOSNUM(a0)
	beq.s	.exit
		subq.w	#1,PATTED_ACTPOSNUM(a0)
		bsr	PosToPatNum
.exit	gets	a0
	rts

	acode
PosNumUp	;V1.0
	jsr	HideBlockRange
	bsr	MovePosUp
	cmpi.b	#TRUE,MACROPROCESS
	beq.s	.exit
	jsr	PattedUpdateDisp
	jsr	UpdatePosList
.exit	rts


	acode
PosNumDown	;V1.0
	jsr	HideBlockRange
	bsr	MovePosDown
	cmpi.b	#TRUE,MACROPROCESS
	beq.s	.exit
	jsr	PattedUpdateDisp
	jsr	UpdatePosList
.exit	rts

PosToPatNum	;V1.0
	puts	d0/a0
	jsr	GetActualPattEd
	move.w	PATTED_ACTPOSNUM(a0),d0
	bsr	SetPositonNum
	gets	d0/a0
	rts

SetPositonNum	;V1.1
		;I(D0W)(PositonNUM)
	puts	d0/a0-a1
	cmpi.w	#Test_PosNumb-1,d0
	bhi.s	.exit
	jsr	GetActualPattEd
	move.l	PATTED_FIRSTSONGDATA(a0),a1
	mulu	#POSITION_SIZEOF,d0
	lea.l	(a1,d0.l),a1
	move.l	a1,PATTED_ACTUALSONGDATA(a0)
	move.l	a1,a0
	jsr	SetPatHeadPTR
.exit	gets	d0/a0-a1
	rts

SetPatternNum	;V1.0
		;I(D0W)(PATTERNNUM)
	puts	a0
	jsr	GetActualPattEd
	move.l	PATTED_ACTUALSONGDATA(a0),a0
	move.w	d0,POSITION_PATNUM(a0)
	jsr	SetPatHeadPTR
	gets	a0
	rts




;--- PATTERN EDITOR MANAGER ---



;--- CRSR ---

KbdCrsrUp
	move.l	#"XXCU",XXMsg
	jsr	NGRecordXXMsg
CrsrUp	BGN
	jsr	HideBlockRange
	jsr	GetActualPattEd
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.Nrm
	jsr	PattEdMoveFirstLine
	RET
.Nrm	jsr	PattEdMovePrevLine
	bsr	ShowBlockRange
	bsr	DrawEventStatus
	RET



KbdCrsrDown
	move.l	#"XXCD",XXMsg
	jsr	NGRecordXXMsg
CrsrDown	BGN
	jsr	HideBlockRange
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.M
	jsr	PattEdMoveLastLine
	RET
.M	jsr	GetActualPattEd
	bsr	PattEdMoveNextLine
	bsr	ShowBlockRange
	bsr	DrawEventStatus
	RET

KbdCrsrRight
	move.l	#"XXCR",XXMsg
	jsr	NGRecordXXMsg
CrsrRight	BGN
	jsr	HideBlockRange
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.M
	bsr	PattEdMoveLastRow
	RET
.M	jsr	GetActualPattEd
	bsr	PattEdMoveNextVoice
	bsr	ShowBlockRange
	bsr	DrawEventStatus
	RET

KbdCrsrLeft
	move.l	#"XXCL",XXMsg
	jsr	NGRecordXXMsg
CrsrLeft	BGN
	jsr	HideBlockRange
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.M
	jsr	PattEdMoveFirstRow
	RET
.M	jsr	GetActualPattEd
	bsr	PattEdMovePrevVoice
	bsr	ShowBlockRange
	bsr	DrawEventStatus
	RET



	acode
CrsrT	jsr	HideBlockRange
	jsr	PattEdMoveFirstLine
	bsr	DrawEventStatus
	bra	PattedUpdateDisp

CrsrTL	jsr	HideBlockRange
	jsr	PattEdMoveFirstLine
	jsr	PattEdMoveFirstRow
	bsr	DrawEventStatus
	bra	PattedUpdateDisp

CrsrB	jsr	HideBlockRange
	jsr	PattEdMoveLastLine
	bsr	DrawEventStatus
	bra	PattedUpdateDisp

CrsrBR	jsr	HideBlockRange
	jsr	PattEdMoveLastLine
	jsr	PattEdMoveLastRow
	bsr	DrawEventStatus
	bra	PattedUpdateDisp


;--- KEYBOARD ---


FastKeyboard	BGN
	jsr	CheckInstrument
	tst.w	d0
	bne.s	FastKeyboard_X

	jsr	IMSGInfo
	move.b	d4,d0
	jsr	GetActualInstrument
	move.l	a0,a1
	jsr	GetActualInstrName
	move.l	a0,a2
	lea.l	Standard_KEYTRANS,a0
	jsr	PlayKeyNote
	cmpi.b	#MULTISAMPLE_STEREOL,SAMPLENAME_MULTI(a2)
	bne.s	FastKeyboard_X

	btst	#SPLAYFLAG_SUPERFAST,SAMPLENAME_PLAYFLAG(a2)
	bne.s	FastKeyboard_X

	lea.l	SampleNameMaxLen(a2),a2
	cmpi.b	#MULTISAMPLE_STEREOR,SAMPLENAME_MULTI(a2)
	bne.s	FastKeyboard_X
		lea.l	INSTR_SIZEOF(a1),a1
		move.w	RECORD_STATUS,d7
			move.w	#FALSE,RECORD_STATUS

			move.l	KeyboardEditPunch,d6
			tst.l	d6
			bne.s	.punchok
			moveq	#100,d6
.punchok		move.w	d6,KeyboardPunch
			jsr	PlayKeyNote

		move.w	d7,RECORD_STATUS
	bsr	DrawEventStatus
FastKeyboard_X	
	RET
Freq	dc.l	0




	acode
CalcActSongData:
	;I(A0L)(PETTED)
	BGN
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	move.l	POSITION_PATHEADPTR(a2),a3
	move.l	PATHEAD_NOTEDATAPTR(a3),a4
	move.l	a4,PATTED_FIRSTNOTEDATA(a0)
	RET

	acode
CalcActNoteData:
	;I(A0L)(PETTED)
	BGN
	bsr	CalcActSongData

	move.l	PATTED_FIRSTNOTEDATA(a0),a1
	move.w	PATTED_CRSRX(a0),d0
	add.w	PATTED_CRSRXOFFSET(a0),d0
	move.w	PATTED_NOTESIZE(a0),d2
	mulu	d2,d0

	move.w	PATTED_CRSRY(a0),d1
	add.w	PATTED_CRSRYOFFSET(a0),d1
	move.w	PATTED_LINESIZE(a0),d2
	mulu	d2,d1

	add.l	d0,d1
	lea.l	(a1,d1.l),a1
	move.l	a1,ActNoteData
	move.l	a1,PATTED_ACTNOTEDATA(a0)

	RET
ActNoteData	dc.l	0

	acode
GetFirstDispNoteData:
	;I(A0L)(PETTED)
	movem.l	d0-d7/a1-a6,-(a7)
	bsr	CalcActSongData

	move.l	PATTED_FIRSTNOTEDATA(a0),a1
	move.w	PATTED_CRSRX(a0),d0
	move.w	PATTED_NOTESIZE(a0),d2
	mulu	d2,d0

	move.w	PATTED_CRSRY(a0),d1
	move.w	PATTED_LINESIZE(a0),d2
	mulu	d2,d1

	add.l	d0,d1
	lea.l	(a1,d1.l),a0

	movem.l	(a7)+,d0-d7/a1-a6
	rts

;--- PATTERN EDITOR --------------------------------------------


;	acode
;PatEdScrollUp:	;V2.0
;		;I(A0L)(PATTED)
;	BGN
;	jsr	GetActualPattEd
;	bsr	PatSimpleScrollUp
;	bsr	PatEdDrawActLine
;	RET

	acode
PatSimpleScrollUp:	;V2.0
		;I(A0L)(PATTED)
	BGN
	jsr	GetActualPattEd
	cmpi.w	#1,PATTED_DISPNUMBLINES(a0)
	bls.s	.exit

	bsr	PatEdGetScrollRange
	bsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit
	moveq	#0,d0
	move.w	FONT_H,d1
	;jsr	GFX_ScrollRaster
	jsr	NGScrollRaster
.exit	RET


	acode
PatEdScrollDown	;V2.0
		;I(A0L)(PATTED)
	BGN
	bsr	PatEdCrsrOff
	jsr	GetActualPattEd
	cmpi.w	#1,PATTED_DISPNUMBLINES(a0)
	bls.s	.exit

	bsr	PatEdGetScrollRange
	bsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit
	moveq	#0,d0
	move.w	FONT_H,d1
	neg.w	d1
	;jsr	GFX_ScrollRaster
	jsr	NGScrollRaster
.exit	RET

	acode
PatEdGetScrollRange	;V1.0
			;I(A0L)(PATTED)
	move.w	PATTED_DISPNUMBTRACKS(a0),d0
	move.w	PATTED_DISPNUMBLINES(a0),d1
	bsr	PatEdCrsrToPix
	move.w	d0,d4
	move.w	d1,d5
	moveq	#0,d0
	moveq	#0,d1
	bsr	PatEdCrsrToPix
	move.w	PATTED_DISPX(a0),d2
	move.w	d1,d3
	subq.w	#1,d5
	rts

	acode
CalcDispEdOffsets	;V2.01
			;I(A0L)(PATTED)
			;Calcs "PATTED_NOTEOFFSET"
	BGN
	move.w	PATTED_CRSRX(a0),d0
	add.w	PATTED_CRSRXOFFSET(a0),d0
	move.w	PATTED_CRSRY(a0),d1
	add.w	PATTED_CRSRYOFFSET(a0),d1

	move.w	PATTED_NOTESIZE(a0),d2
	mulu	d2,d0
	move.w	PATTED_LINESIZE(a0),d2
	mulu	d2,d1
	add.l	d1,d0

	move.l	d0,PATTED_NOTEOFFSET(a0)
	RET

	acode
PattEdMoveFirstLine
	BGN
	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit
	bsr	PatEdCrsrOff
	jsr	PattedUpdateReset
	jsr	GetActualPattEd
	clr.w	PATTED_CRSRY(a0)
	clr.w	PATTED_CRSRYOFFSET(a0)
	jsr	PattedUpdateDisp
	bsr	PatEdCrsrOn
.exit	RET

	acode
PattEdMoveFirstRow
	BGN
	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit
	bsr	PatEdCrsrOff
	jsr	PattedUpdateReset
	jsr	GetActualPattEd
	clr.w	PATTED_CRSRX(a0)
	clr.w	PATTED_CRSRXOFFSET(a0)
	jsr	PattedUpdateDisp
	bsr	PatEdCrsrOn
.exit	RET

	acode
PattEdMoveLastRow
	BGN
	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit
	bsr	PatEdCrsrOff
	jsr	PattedUpdateReset
	jsr	GetActualPattEd
	move.w	PATTED_NUMBVOICES(a0),d0
	move.w	PATTED_DISPNUMBTRACKS(a0),d1

	move.w	d1,PATTED_CRSRXOFFSET(a0)
	subq.w	#1,PATTED_CRSRXOFFSET(a0)

	sub.w	d1,d0
	bmi.s	.quit
		move.w	d0,PATTED_CRSRX(a0)
.quit	jsr	PattedUpdateDisp
	bsr	PatEdCrsrOn
.exit	RET

	acode
PattEdMoveLastLine
	BGN
	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit

	bsr	PatEdCrsrOff
	jsr	PattedUpdateReset
	jsr	GetActualPattEd

	move.w	PATTED_LINESPERPATTERN(a0),d2
	cmp.w	PATTED_DISPNUMBLINES(a0),d2
	bls.s	.fullH

	move.w	PATTED_DISPNUMBLINES(a0),d0

	move.w	d2,d1
	sub.w	PATTED_DISPNUMBLINES(a0),d1

.ok	subq.w	#1,d0
	move.w	d0,PATTED_CRSRYOFFSET(a0)
	move.w	d1,PATTED_CRSRY(a0)
	
	jsr	PattedUpdateDisp
	bsr	PatEdCrsrOn
.exit	RET
.fullH	moveq	#0,d1
	move.w	d2,d0
	bra.s	.ok


	acode
PattEdMoveToLine
	;V1.0
	;I(D0W,A0L)(DESTLINE#,PETTED)
	BGN
	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	PattEdMoveToLine_X

	jsr	PatEdCrsrOff
	jsr	HideBlockRange
	move.w	d0,d1
	bsr	GetActualLineNum
	sub.w	d0,d1
	beq.s	PattEdMoveToLine_X
	bmi.s	PattEdMoveToLine_Rvs

	subq.w	#1,d1
	bmi.s	PattEdMoveToLine_X
PattEdMoveToLine_L1
		bsr	PattEdMoveNextLine
	dbf	d1,PattEdMoveToLine_L1
PattEdMoveToLine_X	RET
PattEdMoveToLine_Rvs
	neg.w	d1
	subq.w	#1,d1
	bmi.s	PattEdMoveToLine_X
PattEdMoveToLine_L2
		bsr	PattEdMovePrevLine
	dbf	d1,PattEdMoveToLine_L2
	bra.s	PattEdMoveToLine_X

	acode

PattEdMoveNextLines
	BGN
	move.l	JumpLen,d7
	subq.w	#1,d7
SetNote_SCROLL
		bsr	PattEdMoveNextLine	;;;NEW
	dbf	d7,SetNote_SCROLL
	RET

	acode
PattEdMoveNextLine
	;V1.0
	;I(A0L)(PETTED)
	BGN
	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit

	bsr	GetActualLineNum
	addq.w	#1,d0
	cmp.w	PATTED_LINESPERPATTERN(a0),d0
	beq.s	.exit

	cmpi.w	#FALSE,RECORD_STATUS
	beq.s	.NRM

	move.w	PATTED_DISPNUMBLINES(a0),d0
	add.w	PATTED_CRSRY(a0),d0
	cmp.w	PATTED_LINESPERPATTERN(a0),d0
	bhs.s	.NoScroll

	move.w	PATTED_DISPNUMBLINES(a0),d0
	lsr.w	#1,d0
	subq.w	#1,d0
	cmp.w	PATTED_CRSRYOFFSET(a0),d0
	blo.s	PattEdMoveNextLine_Scroll
	bra.s	.NoScroll

.NRM
	move.w	PATTED_DISPNUMBLINES(a0),d0
	subq.w	#1,d0
	cmp.w	PATTED_CRSRYOFFSET(a0),d0
	beq.s	PattEdMoveNextLine_Scroll

.NoScroll
	bsr	PatEdCrsrOff
	addq.w	#1,PATTED_CRSRYOFFSET(a0)
	bsr	PatEdCrsrOn
.exit	RET

PattEdMoveNextLine_Scroll
	bsr	GetActualLineNum
	addq.w	#1,d0
	cmp.w	PATTED_LINESPERPATTERN(a0),d0
	beq.s	.exit
	addq.w	#1,PATTED_CRSRY(a0)
	addq.w	#1,PattedUpdate_OLD+4

	bsr	PatEdCrsrOff
	jsr	PatSimpleScrollUp
	jsr	PatEdDrawLastLine;;;;
.exit	jsr	PatEdCrsrOn
	RET

	acode
PattEdMovePrevLine
	;V1.0
	;I(A0L)(PETTED)
	BGN
	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	PattEdMovePrevLine_X

	tst.w	PATTED_CRSRYOFFSET(a0)
	beq.s	PattEdMovePrevLine_sc

	cmpi.w	#FALSE,RECORD_STATUS
	beq.s	PattEdMovePrevLine_NRM
	tst.w	PATTED_CRSRY(a0)
	beq.s	PattEdMovePrevLine_NRM

	move.w	PATTED_DISPNUMBLINES(a0),d0
	lsr.w	#1,d0
	cmp.w	PATTED_CRSRYOFFSET(a0),d0
	bhs.s	PattEdMovePrevLine_sc

PattEdMovePrevLine_NRM
	bsr	PatEdCrsrOff
	subq.w	#1,PATTED_CRSRYOFFSET(a0)
	bsr	PatEdCrsrOn
	RET

PattEdMovePrevLine_sc
	tst.w	PATTED_CRSRY(a0)
	beq.s	PattEdMovePrevLine_X

	bsr	PatEdCrsrOff
	subq.w	#1,PATTED_CRSRY(a0)
	jsr	PatEdScrollDown
	jsr	PatEdDrawFirstLine
	bsr	PatEdCrsrOn
PattEdMovePrevLine_X
	RET


	acode
GetActualTrackNum	;V1.0
	move.w	PATTED_CRSRX(a0),d0
	add.w	PATTED_CRSRXOFFSET(a0),d0
	rts

	acode
GetActualLineNum	;V1.0 NEW
	move.w	PATTED_CRSRY(a0),d0
	add.w	PATTED_CRSRYOFFSET(a0),d0
	rts

	acode
PattEdMoveNextVoice	;V2.0
			;I(A0L)(PETTED)
	BGN
	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit

	move.w	PATTED_CRSRXOFFSET(a0),d0
	move.w	PATTED_CRSRX(a0),d1
	add.w	d0,d1
	addq.w	#1,d1
	cmp.w	PATTED_NUMBVOICES(a0),d1
	beq.s	.exit

	addq.w	#1,d0
	cmp.w	PATTED_DISPNUMBTRACKS(a0),d0
	bhs.s	.nrm

		bsr	PatEdCrsrOff
		move.w	d0,PATTED_CRSRXOFFSET(a0)
		bsr	PatEdCrsrOn
	bra.s	.exit

.nrm		jsr	PatEdCrsrOff
		move.w	PATTED_NUMBVOICES(a0),d0
		subq.w	#1,d0
		cmp.w	PATTED_CRSRX(a0),d0
		beq.s	.skip
		
		addq.w	#1,PATTED_CRSRX(a0)
		bsr	PatEdDrawPattern
.skip		jsr	PatEdCrsrOn

.exit	RET

	acode
PattEdMovePrevVoice	;V2.0
			;I(A0L)(PETTED)
	BGN
	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit

	tst.w	PATTED_CRSRXOFFSET(a0)
	beq.s	.nrm
		bsr	PatEdCrsrOff
		subq.w	#1,PATTED_CRSRXOFFSET(a0)
		bsr	PatEdCrsrOn
		;move.w	#TRUE,PATDRAW_FAST
		;bsr	PatEdDrawPattern
		;move.w	#FALSE,PATDRAW_FAST
	bra.s	.exit

.nrm	tst.w	PATTED_CRSRX(a0)
	beq.s	.skip
	subq.w	#1,PATTED_CRSRX(a0)
		jsr	PatEdCrsrOff
		bsr	PatEdDrawPattern
		jsr	PatEdCrsrOn
.skip

.exit	RET



	acode
MuteActualTrack:
	puts	d0/a0
	lea.l	Test_PATTED,a0
	jsr	GetActualTrackNum
	jsr	MuteTrack
	gets	d0/a0
	rts

	acode
MuteTrack:	;I(D0W)(TRACK#)
	BGN
	lea.l	Test_PATTED,a0
	lea.l	PlayTrackInfo,a1
	cmpi.w	#TRUE,Shift_KEY
	beq.s	.ALL
	eori.b	#-1,(a1,d0.w)
.exit	jsr	PatEdDrawTitle
	RET
.ALL	lea.l	ForceAllTracksOn,a2
	tst.b	(a1,d0.w)
	beq.s	.M
	lea.l	ForceAllTracksOff,a2
.M	jsr	(a2)
	bra.s	.exit

	acode
ForcePlayOnePattern	;V1.1
			;I(A0L)(SONG)
	BGN
	move.l	Actual_FREQDEF,SONG_FREQLIST(a0)
	move.w	#1,SONG_SEQCOUNT(a0)		;INIT SONG
	move.w	SONG_SPEED(a0),SONG_SPEEDCOUNT(a0)

	lea.l	Test_PATTED,a2
	move.l	PATTED_ACTUALSONGDATA(a2),a1

	move.w	POSITION_SPEED(a1),SONG_SPEED(a0)
	move.l	a1,SONG_ACTSONGDATA(a0)

	move.w	#1000,POSITION_LOOPCOUNT(a1)
	move.l	(a1),a4
	move.w	#PATHEADST_DORESET,PATHEAD_STATUS(a4)
	RET



	acode
InsertPosition	;V1.0
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	HideBlockRange
	lea.l	Test_PATTED,a2
	move.l	PATTED_FIRSTSONGDATA(a2),a1
	move.w	#Test_PosNumb,d0
	mulu	#POSITION_SIZEOF,d0
	lea.l	(a1,d0.w),a1
	lea.l	-POSITION_SIZEOF(a1),a0


	move.w	#Test_PosNumb,d7
	sub.w	PATTED_ACTPOSNUM(a2),d7
	subq.w	#2,d7
	bmi.s	InsertPosition_X
InsertPosition_L2	moveq	#POSITION_SIZEOF-1,d6
InsertPosition_L1	move.b	-(a0),-(a1)
		dbf	d6,InsertPosition_L1
	dbf	d7,InsertPosition_L2
	lea.l	Test_PATTED,a0
	jsr	PatEdDrawPattern
	jsr	UpdatePosList
InsertPosition_X	RET
	ENDC
	rts

	acode
DeletePosition	;V1.0

	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	HideBlockRange
	lea.l	Test_PATTED,a2
	move.l	PATTED_ACTUALSONGDATA(a2),a1
	lea.l	POSITION_SIZEOF(a1),a0
	move.w	#Test_PosNumb,d7
	sub.w	PATTED_ACTPOSNUM(a2),d7
	subq.w	#2,d7
	bmi.s	DeletePosition_X
DeletePosition_L2	moveq	#POSITION_SIZEOF-1,d6
DeletePosition_L1	move.b	(a0)+,(a1)+
		dbf	d6,DeletePosition_L1
	dbf	d7,DeletePosition_L2
	lea.l	Test_PATTED,a0
	jsr	PatEdDrawPattern
	jsr	UpdatePosList
DeletePosition_X	RET
	ENDC



	acode
CutPosition

	IFNE	DEMO
	rts
	ELSE
	bsr	CopyPosition
	bsr	DeletePosition
	rts
	ENDC


	acode
CopyPosition
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	GetActualPattEd
	move.l	PATTED_ACTUALSONGDATA(a0),a0
	lea.l	Position_BUF,a1
	moveq	#POSITION_SIZEOF-1,d7
.loop	move.b	(a0)+,d0
	move.b	d0,(a1)+
	dbf	d7,.loop
	jsr	UpdatePosList
	RET
	ENDC


	acode
PastePosition
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	HideBlockRange
	jsr	GetActualPattEd
	move.l	PATTED_ACTUALSONGDATA(a0),a0
	lea.l	Position_BUF,a1
	moveq	#POSITION_SIZEOF-1,d7
	exg	a0,a1
.loop	move.b	(a0)+,d0
	move.b	d0,(a1)+
	dbf	d7,.loop
	jsr	GetActualPattEd
	jsr	PatEdDrawPattern
	jsr	UpdatePosList
	RET
	ENDC

	acode
ClearPosition
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	HideBlockRange
	jsr	GetActualPattEd
	move.l	PATTED_ACTUALSONGDATA(a0),a0
	jsr	InitSongData	
	jsr	UpdatePosList
	RET
	ENDC

	acode
ClearActualPattern	;V1.0
	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	GetActualPattEd
	move.l	PATTED_FIRSTNOTEDATA(a0),a1
	move.l	VEX_NotePerPattern,d7
	subq.w	#1,d7
ClearActualPattern_L
		jsr	ClrDestNote
		lea.l	NOTE_SIZEOF(a1),a1
	dbf	d7,ClearActualPattern_L
	jsr	PatEdDrawPattern
	bsr	DrawEventStatus
	RET
	ENDC


	acode
InsertTrackLine

	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	bsr	CopyActualTrack
	bsr	RotUpTrack
	bsr	PasteTrackTillPos

	jsr	GetActualPattEd
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1

	jsr	ClrDestNote

	lea.l	Test_PATTED,a0
	bsr	PatEdDrawPattern
	RET
	ENDC


	acode
DeleteTrackLine

	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	bsr	CopyActualTrack
	bsr	RotDownTrack
	bsr	PasteTrackTillPos
	bsr	ClearLastNote
	jsr	GetActualPattEd
	jsr	PatEdDrawPattern
	
	RET
	ENDC


	acode
NoteOffsetToAdr
	puts	d0-d1/a1
	jsr	GetActualPattEd
	move.l	a0,a1
	move.l	PATTED_FIRSTNOTEDATA(a1),a0
	mulu	PATTED_NOTESIZE(a1),d0
	mulu	PATTED_LINESIZE(a1),d1
	add.l	d0,d1
	lea.l	(a0,d1.l),a0
	gets	d0-d1/a1
	rts

	acode
ClearLastNote
	BGN
	jsr	GetActualPattEd
	move.w	PATTED_CRSRX(a0),d0
	add.w	PATTED_CRSRXOFFSET(a0),d0
	move.w	PATTED_LINESPERPATTERN(a0),d1
	subq.w	#1,d1
	jsr	NoteOffsetToAdr
	move.l	a0,a1
	jsr	ClrDestNote
	RET

	acode
GetRemainLines
	puts	a0
	jsr	GetActualPattEd
	move.w	PATTED_LINESPERPATTERN(a0),d0
	sub.w	PATTED_CRSRY(a0),d0
	sub.w	PATTED_CRSRYOFFSET(a0),d0
	subq.w	#1,d0
	gets	a0
	rts

	acode
ClearActualTrack	;V1.0

	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	move.l	PATTED_FIRSTNOTEDATA(a0),a1
	move.w	PATTED_LINESPERPATTERN(a0),d7
	subq.w	#1,d7
	move.w	PATTED_CRSRX(a0),d6
	add.w	PATTED_CRSRXOFFSET(a0),d6
	mulu	PATTED_NOTESIZE(a0),d6
	lea.l	(a1,d6.w),a1
	move.w	PATTED_LINESIZE(a0),d6
ClearActualTrack_L	
		jsr	ClrDestNote
		lea.l	(a1,d6.w),a1
	dbf	d7,ClearActualTrack_L
	jsr	PatEdDrawPattern
	bsr	DrawEventStatus
	RET
	ENDC



	acode
CopyActualTrack	;V1.0

	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a2
	move.l	PATTED_FIRSTNOTEDATA(a2),a0
	move.w	PATTED_LINESPERPATTERN(a2),d7
	subq.w	#1,d7
	move.w	PATTED_CRSRX(a2),d6
	add.w	PATTED_CRSRXOFFSET(a2),d6
	mulu	PATTED_NOTESIZE(a2),d6
	lea.l	(a0,d6.w),a0
	move.w	PATTED_LINESIZE(a2),d6
	move.l	TrackBuffer_PTR,a1
CopyActualTrack_L	
		jsr	CopyNote
		lea.l	(a0,d6.w),a0
		lea.l	(a1,d6.w),a1
	dbf	d7,CopyActualTrack_L
	RET

	ENDC


	acode
MirrorTrack	;V1.0

	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a2
	move.w	PATTED_CRSRX(a2),d6
	add.w	PATTED_CRSRXOFFSET(a2),d6
	move.l	VEX_NoteSize,d7
	mulu	d7,d6
	move.l	PATTED_FIRSTNOTEDATA(a2),a0
	lea.l	(a0,d6.w),a0
	move.l  VEX_PatternSize,d6
	lea.l	(a0,d6.l),a1
	moveq	#0,d6
	move.w	PATTED_LINESIZE(a2),d6
	move.l	VEX_LinesPerPattern,d7
	lsr.l	#1,d7
	subq.l	#1,d7
.loop	sub.l	d6,a1	
	jsr	SwapNote
	lea.l	(a0,d6.w),a0
	dbf	d7,.loop
	move.l	a2,a0
	bsr	PatEdDrawPattern
	bsr	DrawEventStatus
	RET
	ENDC


InstrPaint	dc.b	0	;BYTEFLAG
	even

	acode
SwapInstrPaint
	IFNE	DEMO
	rts
	ELSE
	eori.b	#-1,InstrPaint
	ENDC
	rts

	acode
ProcessInstrPaint
	BGN
	jsr	BackupPattern
	cmpi.w	#TRUE,Shift_KEY
	beq	SpaceShift

	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a2

	move.b	NOTE_PITCH(a2),d0
	move.b	NOTE_INSTR(a2),d1
	move.b	NOTE_VOLUME(a2),d2
	move.b	NOTE_FX(a2),d3

	tst.b	InstrPaint
	beq.s	.Clr
		jsr	ProcessNoteSetActInstr
	bra.s	.Save
.Clr	jsr	ProcessNoteClr
.Save	move.b	d0,NOTE_PITCH(a2)
	move.b	d1,NOTE_INSTR(a2)
	move.b	d2,NOTE_VOLUME(a2)
	move.b	d3,NOTE_FX(a2)
	jsr	CopyLockedNotes
	bsr	PatEdDrawActLine
	bsr	PattEdMoveNextLines
ProcessInstrPaint_X
	RET

	acode
ProcessNoteClr
	move.b	#NOTEPITCH_NONOTE,d0
	clr.b	d1
	clr.b	d2
	clr.b	d3
	rts

	acode
ProcessNoteSetActInstr
	cmpi.b	#NOTEPITCH_NONOTE,d0
	beq.s	ProcessNoteSetActInstr_X
	exg	d0,d1
	jsr	GetActualInstrNum
	exg	d0,d1
ProcessNoteSetActInstr_X	rts	

	acode
SpaceShift	
	jsr	ClearActualTrack
;	jsr	CopyLockedNotes
	bra	ProcessInstrPaint_X


	acode
RotDownTrack	;V1.1
	
		IFNE	DEMO
	rts
		ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a2
	move.l	PATTED_FIRSTNOTEDATA(a2),a0
	move.w	PATTED_LINESPERPATTERN(a2),d7
	subq.w	#2,d7
	bmi.s	RotDownTrack_X
	move.w	PATTED_CRSRX(a2),d6
	add.w	PATTED_CRSRXOFFSET(a2),d6
	mulu	PATTED_NOTESIZE(a2),d6
	lea.l	(a0,d6.l),a0
	move.w	PATTED_LINESIZE(a2),d6
	move.l	a0,a1
	lea.l	(a0,d6.w),a0
	lea.l	RotTemp_Note(PC),a2
		puts	a0-a2
		move.l	a1,a0
		move.l	a2,a1
		jsr	CopyNote
		gets	a0-a2
RotDownTrack_L	jsr	CopyNote
		lea.l	(a0,d6.w),a0
		lea.l	(a1,d6.w),a1
	dbf	d7,RotDownTrack_L
	move.l	a2,a0
	jsr	CopyNote
	lea.l	Test_PATTED,a0
	bsr	PatEdDrawPattern
RotDownTrack_X	RET
RotTemp_Note	blk.b	NOTE_SIZEOF,0
		ENDC


	acode
RotUpTrack	;V1.2

		IFNE	DEMO
	rts
		ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a2
	move.l	PATTED_FIRSTNOTEDATA(a2),a0
	move.w	PATTED_LINESPERPATTERN(a2),d7
	subq.w	#2,d7
	bmi.s	RotUpTrack_X
	move.w	PATTED_CRSRX(a2),d6
	add.w	PATTED_CRSRXOFFSET(a2),d6
	mulu	PATTED_NOTESIZE(a2),d6
	lea.l	(a0,d6.w),a0
	move.l	a0,a3
	move.w	PATTED_LINESIZE(a2),d6
	move.w	d6,d5
	mulu	d7,d5
	lea.l	(a0,d5.l),a0
	move.l	a0,a1
	lea.l	(a0,d6.w),a0
	lea.l	(a1,d6.w),a1
	neg.w	d6
	lea.l	RotTemp_Note(PC),a2
		puts	a0-a2
		move.l	a1,a0
		move.l	a2,a1
		jsr	CopyNote
		gets	a0-a2
RotUpTrack_L
		lea.l	(a0,d6.w),a0
		jsr	CopyNote
		lea.l	(a1,d6.w),a1
	dbf	d7,RotUpTrack_L
	move.l	a2,a0
	move.l	a3,a1
	jsr	CopyNote
	lea.l	Test_PATTED,a0
	bsr	PatEdDrawPattern
RotUpTrack_X	RET
		ENDC
	rts


	acode
GetActualPattEd	;V1.0
		;O(A0L)(ACTUAL PATTED)
	lea.l	Test_PATTED,a0
	rts

	acode
GetPTEDCrsrXY	;V1.0
		;O(D0W,D1W)(CRSR_X/Y)
	puts	a0
	bsr	GetActualPattEd
	move.w	PATTED_CRSRX(a0),d0
	add.w	PATTED_CRSRXOFFSET(a0),d0
	move.w	PATTED_CRSRY(a0),d1
	add.w	PATTED_CRSRYOFFSET(a0),d1
	gets	a0
	rts

BLOCKINFO_FLAG	EQU	0
BLOCKINFO_X	EQU	2
BLOCKINFO_Y	EQU	4
BLOCKINFO_X2	EQU	6
BLOCKINFO_Y2	EQU	8
BLOCKINFO_W	EQU	10
BLOCKINFO_H	EQU	12

	acode
CutActualNote
	IFNE	DEMO
	rts
	ELSE
	bsr	MarkNote
	jsr	CutActualBlock
	jsr	DrawEventStatusQ
	rts
	ENDC

	acode
PasteActualNote
	IFNE	DEMO
	rts
	ELSE
	bra	PasteActualBlock
	ENDC

	acode
MarkNote
	IFNE	DEMO
	rts
	ELSE
	bsr	HideBlockRange
	bsr	PatEdCrsrOff
	bsr	ForceBlockEndMark
	bsr	MarkBlock
	bsr	MarkBlock
	bsr	PatEdCrsrOn
	bsr	ShowBlockRange
	rts
	ENDC

	acode
MarkPattern
	IFNE	DEMO
	rts
	ELSE

	jsr	PatEdCrsrOff

	BGN
	bsr	HideBlockRange
	bsr	GetActualPattEd

	lea.l	ActualBlock_INFO(PC),a2

	move.w	PATTED_NUMBVOICES(a0),d0
	clr.w	BLOCKINFO_X(a2)
	move.w	d0,BLOCKINFO_W(a2)
	subq.w	#1,d0
	move.w	d0,BLOCKINFO_X2(a2)

	move.w	PATTED_LINESPERPATTERN(a0),d0
	clr.w	BLOCKINFO_Y(a2)
	move.w	d0,BLOCKINFO_H(a2)
	subq.w	#1,d0
	move.w	d0,BLOCKINFO_Y2(a2)
	clr.w	BLOCKINFO_FLAG(a2)

	bsr	CopyActualBlock
	;bsr	PatEdDrawPattern
	bsr	PatEdCrsrOn
	bsr	ShowBlockRange
	RET
	ENDC

	acode
MarkTrack
	IFNE	DEMO
	rts
	ELSE
	bsr	HideBlockRange
	bsr	PatEdCrsrOff
	BGN
	bsr	GetActualPattEd
	lea.l	ActualBlock_INFO(PC),a2
	
	move.w	PATTED_CRSRX(a0),d0
	add.w	PATTED_CRSRXOFFSET(a0),d0
	move.w	d0,BLOCKINFO_X2(a2)
	move.w	d0,BLOCKINFO_X(a2)
	move.w	#1,BLOCKINFO_W(a2)

	move.w	PATTED_LINESPERPATTERN(a0),d0
	clr.w	BLOCKINFO_Y(a2)
	move.w	d0,BLOCKINFO_H(a2)
	subq.w	#1,d0
	move.w	d0,BLOCKINFO_Y2(a2)
	clr.w	BLOCKINFO_FLAG(a2)

	bsr	CopyActualBlock
	;bsr	PatEdDrawPattern
	bsr	PatEdCrsrOn
	bsr	ShowBlockRange
	RET
	ENDC

	IFEQ DEMO
	acode
GetBlockRangeXYWH	;V1.0
			;-> GetPTEDCrsrXY
	puts	a0
	lea.l	ActualBlock_INFO(PC),a0
	moveq	#0,d0
	moveq	#0,d1
	moveq	#0,d2
	moveq	#0,d3
	tst.w	BLOCKINFO_FLAG(a0)
	bne.s	.exit
	movem.w	BLOCKINFO_W(a0),d2-d3
	move.w	BLOCKINFO_X(a0),d0
	move.w	BLOCKINFO_Y(a0),d1
.exit	gets	a0
	rts

CheckXYInBlockRange	;V1.0
			;I(D0W,D1W)(X,Y)
			;O(D0L)(TRUE/FALSE)
	puts	d1-d5
	move.w	d0,d4
	move.w	d1,d5
	bsr	GetBlockRangeXYWH
	tst.w	d2
	beq.s	.clear
	sub.w	d0,d4
	bmi.s	.clear
	sub.w	d2,d4
	bpl.s	.clear
	sub.w	d1,d5
	bmi.s	.clear
	sub.w	d3,d5
	bpl.s	.clear
	moveq	#TRUE,d0
	bra.s	.exit
.clear	moveq	#FALSE,d0
.exit	gets	d1-d5
	rts	



	acode
MarkBlock
	BGN

	bsr	HideBlockRange
	bsr	PatEdCrsrOff
	bsr	GetPTEDCrsrXY

	lea.l	ActualBlock_INFO(PC),a2
	move.w	BLOCKINFO_FLAG(a2),d7
	lea.l	BLOCKINFO_X(a2),a1

	tst.w	d7
	beq.s	.MarkBGN
		lea.l	BLOCKINFO_X2(a2),a1
		ASSTXT	MarkBlocktxt2
		bra.s	.MarkEND
.MarkBGN
	ASSTXT	MarkBlocktxt
.MarkEND
	movem.w	d0-d1,(a1)
	eori.w	#-1,d7
	move.w	d7,BLOCKINFO_FLAG(a2)
	tst.w	d7
	bne.s	.exit

		movem.w	BLOCKINFO_X(a2),d0-d3
		cmp.w	d0,d2
		bhi.s	.XOK
			move.w	d2,BLOCKINFO_X(a2)
			move.w	d0,BLOCKINFO_X2(a2)
.XOK

		cmp.w	d1,d3
		bhi.s	.YOK
			move.w	d3,BLOCKINFO_Y(a2)
			move.w	d1,BLOCKINFO_Y2(a2)
.YOK

		movem.w	BLOCKINFO_X(a2),d0-d3
		sub.w	d0,d2
		sub.w	d1,d3
		addq.w	#1,d2
		addq.w	#1,d3
		movem.w	d2-d3,BLOCKINFO_W(a2)

	bsr	CopyActualBlock
.exit	;jsr	PatEdDrawPattern
	bsr	PatEdCrsrOn
	bsr	ShowBlockRange
	RET

	ENDC

	acode
ActualBlock_INFO	dc.w	0
			dc.w	0,0,0,0
			dc.w	0,0,0

ActualBlock_PTR		dc.l	0,0,FASTMEM
UndoBuffer_PTR		dc.l	0,0,FASTMEM

	acode
GetActualNotePtr
	jsr	GetActualPattEd
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a0
	rts

	acode
GetActualNoteType	;O(D0W)(NOTETYPE_ID)
	puts	a0
	bsr	GetActualNotePtr
	bsr	CheckNoteType
	gets	a0
	rts

	acode
ForceBlockEndMark
	tst.w	ActualBlock_INFO
	IFEQ DEMO
	bne.w	MarkBlock
	ENDC
	rts

	acode
DuplicateBlock
	jsr	PatEdCrsrOff
	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	ForceBlockEndMark
	jsr	CopyActualBlock
	jsr	PatternUp
	jsr	ClearActualPattern
	jsr	PasteActualBlock
	jsr	UpdatePosList
	jsr	PatEdCrsrOn

	RET
	ENDC
	

	acode
CopyActualBlock
	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	ForceBlockEndMark
	lea.l	CopyNote,a0
	move.l	a0,ReadCall
	bsr	ReadActualBlock
	RET
	ENDC



	acode
PitchUpActualBlock
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	ForceBlockEndMark
	lea.l	PitchUpNote,a0
	move.l	a0,ReadCall
	bsr	ReadActualBlock
	jsr	PatEdDrawPattern
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
	RET
	ENDC

	acode
PitchDownActualBlock
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	ForceBlockEndMark
	lea.l	PitchDownNote,a0
	move.l	a0,ReadCall
	bsr	ReadActualBlock
	jsr	PatEdDrawPattern
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
	RET
	ENDC

	acode
VolumeUpActualBlock
	jsr	PatEdCrsrOff
	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	ForceBlockEndMark
	lea.l	VolUpNote,a0
	move.l	a0,ReadCall
	bsr	ReadActualBlock
	jsr	PatEdDrawPattern
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
	RET
	ENDC

	acode
VolumeDownActualBlock
	jsr	PatEdCrsrOff
	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	ForceBlockEndMark
	lea.l	VolDownNote,a0
	move.l	a0,ReadCall
	bsr	ReadActualBlock
	jsr	PatEdDrawPattern
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
	RET
	ENDC

	acode
InstrUpActualBlock
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	ForceBlockEndMark
	lea.l	InstrUpNote,a0
	move.l	a0,ReadCall
	bsr	ReadActualBlock
	jsr	PatEdDrawPattern
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
	RET
	ENDC

	acode
InstrDownActualBlock
	jsr	PatEdCrsrOff
	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	ForceBlockEndMark
	lea.l	InstrDownNote,a0
	move.l	a0,ReadCall
	bsr	ReadActualBlock
	jsr	PatEdDrawPattern
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
	RET
	ENDC

	acode
CutActualBlock
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	ForceBlockEndMark
	lea.l	CutNote,a0
	move.l	a0,ReadCall
	bsr	ReadActualBlock
	jsr	PatEdDrawPattern
	jsr	PatEdCrsrOn
	jsr	DrawEventStatus
	RET
	ENDC

	acode
ClrActualBlock
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	ForceBlockEndMark
	lea.l	ClrSrcNote,a0
	move.l	a0,ReadCall
	bsr	ReadActualBlock
	jsr	PatEdDrawPattern
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
	RET
	ENDC

ReadCall	dc.l	0

	acode
PrepareBlockReg
	lea.l	ActualBlock_INFO(PC),a2
	movem.w	BLOCKINFO_X(a2),d6-d7
	bsr	GetActualPattEd
	move.w	PATTED_NOTESIZE(a0),d0
	move.w	PATTED_LINESIZE(a0),d1
	move.l	PATTED_FIRSTNOTEDATA(a0),a1

	move.w	PATTED_LINESPERPATTERN(a0),d3
	cmp.w	BLOCKINFO_W+2(a2),d3
	bne.s	FullTrackb
		moveq	#0,d7
	move.w	PATTED_NUMBVOICES(a0),d3
	cmp.w	BLOCKINFO_W(a2),d3
	bne.s	FullTrackb
		moveq	#0,d6
FullTrackb

	mulu	d0,d6
	mulu	d1,d7
	add.l	d6,d7
	lea.l	(a1,d7.l),a0
	move.l	ActualBlock_PTR,a1
	movem.w	BLOCKINFO_W(a2),d6-d7
	rts

	acode
ReadActualBlock
	BGN
	bsr	PrepareBlockReg
	move.l	a0,a4
	subq.w	#1,d7
	bmi.s	CopyActualBlock_X
	tst.l	ReadCall
	beq.s	CopyActualBlock_X
CopyActualBlock_L2
		move.w	d6,d5
		subq.w	#1,d5
		bmi.s	CopyActualBlock_X
CopyActualBlock_L
			move.l	ReadCall(PC),a5
			jsr	(a5)
			move.l	Block_MoveCALL(PC),a5
			jsr	(a5)
		dbf	d5,CopyActualBlock_L
		lea.l	(a4,d1.w),a4
		move.l	a4,a0
CopyActualBlock_X	dbf	d7,CopyActualBlock_L2
	move.l	a1,LastBlockLPtr
	
	RET
LastBlockLPtr	dc.l	0


Block_MoveCALL	dc.l	BlockMove_Nrm

	acode
BlockMove_Nrm
	lea.l	(a0,d0.w),a0
	lea.l	(a1,d0.w),a1
	rts	

	acode
BlockMove_Exp
	lea.l	(a0,d0.w),a0

	tst.w	ExpandBlock_TEMP
	bne.s	BlockMove_Exp1
		lea.l	(a1,d0.w),a1
BlockMove_Exp1	rts	

	acode
PasteActualBlock
	jsr	PatEdCrsrOff
	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	CopyNote,a0
	move.l	a0,WriteCall
	bsr	WriteActualBlock
	jsr	PatEdCrsrOn
	jsr	DrawEventStatusQ
	RET
	ENDC

	acode
ShrinkActualBlock
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	ForceBlockEndMark
	jsr	BackupPattern
	jsr	CopyActualBlock
	bsr	ShrinkBlock
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
	RET
	ENDC

	acode
ExpandActualBlock
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	ForceBlockEndMark
	jsr	BackupPattern
	jsr	CopyActualBlock
	bsr	ExpandBlock
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
	RET
	ENDC

	acode
MirrorActualBlock
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	ForceBlockEndMark
	jsr	BackupPattern
	jsr	CopyActualBlock
	bsr	MirrorBlock
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
	RET
	ENDC

	acode
AddActualBlock
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	AddNote,a0
	move.l	a0,WriteCall
	bsr	WriteActualBlock
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
	RET
	ENDC


	acode
SwapActualBlock
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	SwapNote,a0
	move.l	a0,WriteCall
	bsr	WriteActualBlock
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
	RET
	ENDC

WriteCall	dc.l	0

	acode
PrepareBlockWriteReg
	puts	d5
	lea.l	ActualBlock_INFO(PC),a2
	movem.w	BLOCKINFO_X(a2),d6-d7

	bsr	GetActualPattEd
	move.w	PATTED_NOTESIZE(a0),d0
	move.w	PATTED_LINESIZE(a0),d1
	move.l	PATTED_FIRSTNOTEDATA(a0),a1

	move.w	PATTED_CRSRX(a0),d6
	add.w	PATTED_CRSRXOFFSET(a0),d6
	move.w	PATTED_CRSRY(a0),d7
	add.w	PATTED_CRSRYOFFSET(a0),d7

	moveq	#0,d5

	move.w	PATTED_LINESPERPATTERN(a0),d3
	cmp.w	BLOCKINFO_W+2(a2),d3
	bne.s	FullTrack
		moveq	#0,d7
		moveq	#-1,d5
	move.w	PATTED_NUMBVOICES(a0),d3
	cmp.w	BLOCKINFO_W(a2),d3
	bne.s	FullTrack
		
		moveq	#0,d6
		moveq	#-1,d5
FullTrack
	mulu	d0,d6
	mulu	d1,d7
	add.l	d6,d7
	lea.l	(a1,d7.l),a0
	move.l	ActualBlock_PTR,a1
	movem.w	BLOCKINFO_W(a2),d6-d7

	puts	d0
	tst.w	d5
	bne.s	PrepareBWR_In

	moveq	#0,d0
	move.w	d7,d0
	jsr	GetRemainLines
	addq.w	#1,d0
	cmp.w	d0,d7
	bls.s	PrepareBWR_In
		move.w	d0,d7
PrepareBWR_In
	gets	d0

	gets	d5
	rts

	acode
WriteActualBlock
	BGN
	bsr	PrepareBlockWriteReg
	exg	a0,a1
	move.l	a1,a4
	subq.w	#1,d7
	bmi.s	WriteActualBlock_X
	move.l	WriteCall,a5
WriteActualBlock_L2
		move.w	d6,d5
		subq.w	#1,d5
		bmi.s	WriteActualBlock_X
WriteActualBlock_L
			jsr	(a5)
			lea.l	(a0,d0.w),a0
			lea.l	(a1,d0.w),a1
		dbf	d5,WriteActualBlock_L
		lea.l	(a4,d1.w),a4
		move.l	a4,a1
	dbf	d7,WriteActualBlock_L2
	jsr	PatEdDrawPattern
WriteActualBlock_X	RET

	acode
RotateDBlock
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	BGN
	jsr	BackupPattern
	jsr	CopyActualBlock
	bsr	PrepareBlockReg
	exg	a0,a1
	move.l	a1,a4

	subq.w	#2,d7
	bmi.s	RotateDActualBlock_X

	move.l	a4,a3

RotateDActualBlock_L2
		move.w	d6,d5
		subq.w	#1,d5
		bmi.s	RotateDActualBlock_X

		lea.l	(a4,d1.w),a4
		move.l	a4,a1

RotateDActualBlock_L
			jsr	CopyNote
			lea.l	(a0,d0.w),a0
			lea.l	(a1,d0.w),a1
		dbf	d5,RotateDActualBlock_L

	dbf	d7,RotateDActualBlock_L2

	move.l	a3,a1
	move.w	d6,d5
	subq.w	#1,d5
RotateDActualBlock_Lb
		jsr	CopyNote
		lea.l	(a0,d0.w),a0
		lea.l	(a1,d0.w),a1
	dbf	d5,RotateDActualBlock_Lb

	jsr	PatEdDrawPattern
RotateDActualBlock_X	
	jsr	PatEdCrsrOn
	jsr	DrawEventStatus
	RET

	acode
RotateUBlock
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	BGN
	jsr	BackupPattern
	jsr	CopyActualBlock
	bsr	PrepareBlockReg
	exg	a0,a1
	move.l	a1,a4

	subq.w	#2,d7
	bmi.s	RotateUActualBlock_X

	move.l	a0,a3
	move.w	d6,d5
	mulu	d0,d5
	lea.l	(a0,d5.w),a0

RotateUActualBlock_L2
		move.w	d6,d5
		subq.w	#1,d5
		bmi.s	RotateUActualBlock_X


RotateUActualBlock_L
			jsr	CopyNote
			lea.l	(a0,d0.w),a0
			lea.l	(a1,d0.w),a1
		dbf	d5,RotateUActualBlock_L

		lea.l	(a4,d1.w),a4
		move.l	a4,a1

	dbf	d7,RotateUActualBlock_L2

	move.l	a3,a0
	move.w	d6,d5
	subq.w	#1,d5
RotateUActualBlock_Lb
		jsr	CopyNote
		lea.l	(a0,d0.w),a0
		lea.l	(a1,d0.w),a1
	dbf	d5,RotateUActualBlock_Lb

	jsr	PatEdDrawPattern
RotateUActualBlock_X	
	jsr	PatEdCrsrOn
	jsr	DrawEventStatus
	RET

	acode
ShrinkBlock
	jsr	HideBlockRange
	BGN

	bsr	PrepareBlockReg
	exg	a0,a1
	move.l	a1,a4

	lsr.w	#1,d7
	subq.w	#1,d7
	bmi.s	ShrinkActualBlock_X

ShrinkActualBlock_L2
		move.w	d6,d5
		subq.w	#1,d5
		bmi.s	ShrinkActualBlock_X

ShrinkActualBlock_L
			jsr	CopyNote
			lea.l	(a0,d0.w),a0
			lea.l	(a1,d0.w),a1
		dbf	d5,ShrinkActualBlock_L

		move.w	d6,d5
		subq.w	#1,d5
ShrinkActualBlock_Lb
			lea.l	(a0,d0.w),a0
		dbf	d5,ShrinkActualBlock_Lb

		lea.l	(a4,d1.w),a4
		move.l	a4,a1
	dbf	d7,ShrinkActualBlock_L2
	jsr	PatEdDrawPattern
ShrinkActualBlock_X	RET

	acode
DemoBlockMutation
	jsr	HideBlockRange
	BGN
	bsr	PrepareBlockReg
	move.l	a0,a4

	subq.w	#1,d7
	bmi.s	.exit
.loop2	move.w	d6,d5
	subq.w	#1,d5
	bmi.s	.exit
.loop	bsr	.do
	lea.l	(a0,d0.w),a0
	dbf	d5,.loop
	lea.l	(a4,d1.w),a4
	move.l	a4,a0
	dbf	d7,.loop2
	jsr	PatEdDrawPattern
.exit	RET

.do	cmpi.b	#FX_NONE,NOTE_FX(a0)
	bne.s	.next
	cmpi.b	#VOLUME_MAX,NOTE_VOLUME(a0)
	bhi.s	.next
	cmpi.b	#VOLUME_MIN,NOTE_VOLUME(a0)
	blo.s	.next
	;--- SET VOL ---
	move.b	#50,NOTE_VOLUME(a0)
.next	rts




SetFadeToSteps
	BGN
	lea.l	FADETOSTEPS-2,a0
	lea.l	Declicktxt,a1
	moveq	#4,d1
	move.l	#800,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq	.exit
.exit	move.w	FADETOSTEPS,d0
	subq.w	#1,d0
	move.w	d0,FADETOSTEPSm
	RET


	IFEQ DEMO
	acode
JMPTEST
VolumeFadeBlock
	jsr	HideBlockRange
	BGN
	ASSTATUS VFade_INFOTXT
	lea.l	VFadeBuf,a0
	lea.l	VFadeMin_TXT,a1
	moveq	#1,d1
	move.l	#100,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit
	lea.l	VFadeBuf+4,a0
	lea.l	VFadeMax_TXT,a1
	moveq	#1,d1
	move.l	#100,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit

	bsr	PrepareBlockReg
	move.l	a0,a4
	move.w	d7,d4
	subq.w	#1,d7
	bmi.s	.exit

	move.l	VFadeBuf,d2
	move.l	VFadeBuf+4,d3
	;moveq	#75,d2
	;moveq	#20,d3

.loop2	move.w	d6,d5
	subq.w	#1,d5
	bmi.s	.exit
.loop	bsr	.do
	lea.l	(a0,d0.w),a0
	dbf	d5,.loop
	lea.l	(a4,d1.w),a4
	move.l	a4,a0
	dbf	d7,.loop2
	jsr	PatEdDrawPattern
.exit	RET
.do	puts	d0-d7
	cmpi.b	#FX_NONE,NOTE_FX(a0)
	bne.s	.next
	cmpi.b	#VOLUME_MAX,NOTE_VOLUME(a0)
	bhi.s	.next
	cmpi.b	#VOLUME_MIN,NOTE_VOLUME(a0)
	blo.s	.next
	;--- SET VOL ---
	moveq	#100,d0

	subq.w	#1,d4
	move.w	d4,d1
	sub.w	d7,d1

	move.w	d3,d5
	sub.w	d2,d5

	ext.l	d5
	ext.l	d1

	muls.l	d5,d0
	muls.l	d1,d0
	divs.l	d4,d0

	mulu	#100,d2
	add.l	d2,d0

	moveq	#0,d1
	move.b	NOTE_VOLUME(a0),d1

	muls.l	d1,d0
	divs.l	#100*100,d0

	tst.b	d0
	bne.s	.vok
	moveq	#1,d0
.vok	move.b	d0,NOTE_VOLUME(a0)
.next	gets	d0-d7
	rts
	ENDC

	acode
ExpandBlock
	jsr	HideBlockRange
	BGN
	bsr	PrepareBlockReg
	exg	a0,a1
	move.l	a1,a4

	lsr.w	#1,d7
	subq.w	#1,d7
	bmi.s	ExpandActualBlock_X

ExpandActualBlock_L2
		move.w	d6,d5
		subq.w	#1,d5
		bmi.s	ExpandActualBlock_X

ExpandActualBlock_L
			jsr	CopyNote
			lea.l	(a0,d0.w),a0
			lea.l	(a1,d0.w),a1
		dbf	d5,ExpandActualBlock_L

		move.w	d6,d5
		subq.w	#1,d5
		lea.l	(a4,d1.w),a4
		move.l	a4,a1

ExpandActualBlock_Lb
			bsr	ClrDestNote
			lea.l	(a1,d0.w),a1
		dbf	d5,ExpandActualBlock_Lb

		lea.l	(a4,d1.w),a4
		move.l	a4,a1
	dbf	d7,ExpandActualBlock_L2
	jsr	PatEdDrawPattern
ExpandActualBlock_X	RET

	acode
MirrorBlock
	jsr	HideBlockRange
	BGN
	jsr	BackupPattern
	jsr	CopyActualBlock
	bsr	PrepareBlockReg
	exg	a0,a1


	subq.w	#1,d7
	bmi.s	MirrorActualBlock_X

	move.w	d0,d2
	mulu	d6,d2
	neg.w	d2

	move.l	LastBlockLPtr,a5
	lea.l	(a5,d2.w),a5
	move.l	a5,a0

	move.l	a1,a4

MirrorActualBlock_L2
		move.w	d6,d5
		subq.w	#1,d5
		bmi.s	MirrorActualBlock_X

MirrorActualBlock_L
			jsr	CopyNote
			lea.l	(a0,d0.w),a0
			lea.l	(a1,d0.w),a1
		dbf	d5,MirrorActualBlock_L

		lea.l	(a5,d2.w),a5
		move.l	a5,a0
		lea.l	(a4,d1.w),a4
		move.l	a4,a1

	dbf	d7,MirrorActualBlock_L2
	jsr	PatEdDrawPattern
MirrorActualBlock_X	RET

	acode
AddNote		;(A0L,A1L)(SRCNOTE_PTR,DESTNOTE_PTR)
	puts	d0/a0-a1
	exg	a0,a1
	bsr	CheckNoteType
	exg	a0,a1
	cmpi.w	#NOTETYPEID_NONE,d0
	bne.s	AddNote_X
	gets	d0/a0-a1
	bra.s	CopyNote
AddNote_X
	gets	d0/a0-a1
	rts

	acode
CAddNote		;(A0L,A1L)(SRCNOTE_PTR,DESTNOTE_PTR)
	puts	d0/a0-a1
;	exg	a0,a1
	bsr	CheckNoteType
;	exg	a0,a1
	cmpi.w	#NOTETYPEID_NONE,d0
	bne.s	CAddNote_X
	gets	d0/a0-a1
	bra.s	CopyNote
CAddNote_X
	gets	d0/a0-a1
	rts

	acode
CopyNote	;(A0L,A1L)(SRCNOTE_PTR,DESTNOTE_PTR)
	move.l	(a0),(a1)
	rts

	acode
PasteNote	;(A0L,A1L)(DESTNOTE_PTR,SRCNOTE_PTR)
	move.l	(a1),(a0)
	rts

	acode
ClrNote		;obsolete
ClrSrcNote	;(A0L)(SRCNOTE_PTR)
	move.b	#NOTEPITCH_NONOTE,NOTE_PITCH(a0)
	clr.b	NOTE_INSTR(a0)
	clr.b	NOTE_VOLUME(a0)
	clr.b	NOTE_FX(a0)
	rts

	acode
ClrDestNote	;(A1L)(DESTNOTE_PTR)
	move.b	#NOTEPITCH_NONOTE,NOTE_PITCH(a1)
	clr.b	NOTE_INSTR(a1)
	clr.b	NOTE_VOLUME(a1)
	clr.b	NOTE_FX(a1)
	rts

	acode
CutNote
	bsr	CopyNote
	bsr	ClrSrcNote
	rts

	acode
SwapNote
	puts	d0
	move.l	(a0),d0
	move.l	(a1),(a0)
	move.l	d0,(a1)
	gets	d0
	rts


ExpandBlock_TEMP	dc.w	0

	acode
ProcExpandBlock

	tst.w	ExpandBlock_TEMP
	beq.s	ProcExpandBlock_Paste

		bsr	ClrSrcNote
		bra.s	ProcExpandBlock_X

ProcExpandBlock_Paste
		bsr	PasteNote
ProcExpandBlock_X
	eori.w	#-1,ExpandBlock_TEMP
	rts

	acode
VolUpNote
	puts	d0-d7
	bsr	GetActualNoteType
	move.l	d0,d7
	bsr	CheckNoteType
	cmpi.w	#NOTETYPEID_SIMPLEFX,d0
	beq.s	VolUpNote_Ok

	cmp.l	d0,d7
	bne.s	VolUpNote_X

VolUpNote_Ok
	move.b	NOTE_VOLUME(a0),d0
	move.b	NOTE_FX(a0),d1
	bsr	ProcessVolUp
	move.b	d0,NOTE_VOLUME(a0)
VolUpNote_X	gets	d0-d7
	rts

	acode
VolDownNote
	puts	d0-d7
	bsr	GetActualNoteType
	move.l	d0,d7
	bsr	CheckNoteType
	cmpi.w	#NOTETYPEID_SIMPLEFX,d0
	beq.s	VolDNote_Ok

	cmp.l	d0,d7
	bne.s	VolDownNote_X

VolDNote_Ok
	move.b	NOTE_VOLUME(a0),d0
	move.b	NOTE_FX(a0),d1
	bsr	ProcessVolDown
	move.b	d0,NOTE_VOLUME(a0)
VolDownNote_X	gets	d0-d7
	rts

	acode
ProcessVolUp	;V1.1
	puts	d1-d2
	move.b	d0,d2
	cmpi.b	#FX_OLDNONE,d1
	beq.s	ProcessVolUp_M1
	cmpi.b	#FX_NONE,d1
	beq.s	ProcessVolUp_M1
		move.b	d0,d1
		jsr	SetDecShiftKeyRaster
		add.b	d0,d1
		move.b	d1,d2
	bra.s	ProcessVolUp_X

ProcessVolUp_M1
	tst.b	d2
	beq.s	ProcessVolUp_X
	cmpi.b	#VOLUME_MAX,d2
	bhs.s	ProcessVolUp_X
	move.b	d0,d1
	jsr	SetDecShiftKeyRaster
	add.b	d0,d1
	cmpi.b	#VOLUME_MAX,d1
	bls.s	ProcessVolUp_OK
		moveq	#VOLUME_MAX,d1
ProcessVolUp_OK
		move.b	d1,d2
ProcessVolUp_X	move.b	d2,d0
	gets	d1-d2
	rts
	
	acode
ProcessVolDown	;V1.1
	puts	d1-d2
	move.b	d0,d2
	cmpi.b	#FX_OLDNONE,d1
	beq.s	ProcessVolDown_M1
	cmpi.b	#FX_NONE,d1
	beq.s	ProcessVolDown_M1
		move.b	d0,d1
		jsr	SetDecShiftKeyRaster
		sub.b	d0,d1
		move.b	d1,d2
		bra.s	ProcessVolDown_X
ProcessVolDown_M1
	cmpi.b	#VOLUME_NONE,d2
	beq.s	ProcessVolDown_X

	cmpi.b	#VOLUME_MIN,d2
	beq.s	ProcessVolDown_X
	cmpi.b	#VOLUME_MAX,d2
	bhi.s	ProcessVolDown_X

ProcessVolDown_ValueRange
	move.b	d0,d1
	jsr	SetDecShiftKeyRaster
	sub.b	d0,d1
	cmpi.b	#VOLUME_MIN,d1
	bge.s	ProcessVolDown_OK
	moveq	#VOLUME_MIN,d1

ProcessVolDown_OK
		move.b	d1,d2
ProcessVolDown_X	move.b	d2,d0
	gets	d1-d2
	rts
	

	acode
PitchUpNote
	puts	d0
	jsr	CheckNoteType
	cmpi.w	#NOTETYPEID_COMPLEXFX,d0
	beq.s	PitchUpNote_Complex
	move.b	NOTE_PITCH(a0),d0
	jsr	ProcessNoteUp
	move.b	d0,NOTE_PITCH(a0)
	gets	d0
	rts

	acode
PitchUpNote_Complex
	jsr	SetDecShiftKeyRaster
	add.b	d0,NOTE_PITCH(a0)
	gets	d0
	rts

	acode
PitchDownNote
	puts	d0
	jsr	CheckNoteType
	cmpi.w	#NOTETYPEID_COMPLEXFX,d0
	beq.s	PitchDwnNote_Complex
	move.b	NOTE_PITCH(a0),d0
	jsr	ProcessNoteDown
	move.b	d0,NOTE_PITCH(a0)
	gets	d0
	rts
	acode
PitchDwnNote_Complex
	jsr	SetDecShiftKeyRaster
	sub.b	d0,NOTE_PITCH(a0)
	gets	d0
	rts

	acode
ProcessNoteUp
	puts	d1-d2
	move.b	d0,d2
	cmpi.b	#NOTEPITCH_NONOTE,d2
	beq.s	ProcessNoteUp_X
	move.b	d0,d1
	jsr	SetOctaveKeyRaster
	add.b	d1,d0
	cmpi.b	#NOTEPITCH_MAX,d0
	bhi.s	ProcessNoteUp_X
		move.b	d0,d2
ProcessNoteUp_X	move.b	d2,d0
	gets	d1-d2
	rts

	acode
ProcessNoteDown
	puts	d1-d2
	move.b	d0,d2
	cmpi.b	#NOTEPITCH_NONOTE,d2
	beq.s	ProcessNoteDown_X
	move.b	d0,d1
	jsr	SetOctaveKeyRaster
	sub.b	d0,d1
	bmi.s	ProcessNoteDown_X
		move.b	d1,d2
ProcessNoteDown_X	move.b	d2,d0
	gets	d1-d2
	rts

	acode
InstrUpNote	;V1.0	*NEW
	puts	d0
	bsr	CheckNoteType
	cmpi.w	#NOTETYPEID_NONE,d0
	beq.s	InstrUpNote_X
	cmpi.w	#NOTETYPEID_SIMPLEFX,d0
	beq.s	InstrUpNote_X
		move.b	NOTE_INSTR(a0),d0
		bsr	ProcessInstrUp
		move.b	d0,NOTE_INSTR(a0)
InstrUpNote_X	gets	d0
	rts

	acode
InstrDownNote	;V1.0	*NEW
	puts	d0
	bsr	CheckNoteType
	cmpi.w	#NOTETYPEID_NONE,d0
	beq.s	InstrDownNote_X
	cmpi.w	#NOTETYPEID_SIMPLEFX,d0
	beq.s	InstrDownNote_X
		move.b	NOTE_INSTR(a0),d0
		bsr	ProcessInstrDown
		move.b	d0,NOTE_INSTR(a0)
InstrDownNote_X	gets	d0
	rts

NOTETYPEID_NONE		EQU	0
NOTETYPEID_NOTEON	EQU	1
NOTETYPEID_SIMPLEFX	EQU	2
NOTETYPEID_COMPLEXFX	EQU	3

	acode
CheckNoteType	;V1.0
		;I(A0L)(NOTE_PTR)
		;O(D0L)(NOTETYPE_ID)
	moveq	#0,d0
	cmpi.b	#FX_OLDNONE,NOTE_FX(a0)
	beq.s	CheckNoteType_NOFX
	cmpi.b	#FX_NONE,NOTE_FX(a0)
	beq.s	CheckNoteType_NOFX
	moveq	#NOTETYPEID_COMPLEXFX,d0
	swap	d0
	move.b	NOTE_FX(a0),d0
	swap	d0
	rts
CheckNoteType_NOFX
	cmpi.b	#NOTEPITCH_NONOTE,NOTE_PITCH(a0)
	beq.s	CheckNoteType_NOKEYON
	moveq	#NOTETYPEID_NOTEON,d0
	rts
CheckNoteType_NOKEYON
	cmpi.b	#VOLUME_NONE,NOTE_VOLUME(a0)
	bne.s	CheckNoteType_SIMPLEFX
	moveq	#NOTETYPEID_NONE,d0
	rts
CheckNoteType_SIMPLEFX
	moveq	#NOTETYPEID_SIMPLEFX,d0
	swap	d0
	move.b	NOTE_VOLUME(a0),d0			;NEW
	swap	d0
	rts

EDINSTR_MAX	EQU	255

	acode
ProcessInstrUp	;V2.0	*NEW
	puts	d1-d2
	moveq	#0,d1
	move.b	d0,d1
	jsr	SetDecShiftKeyRaster
	add.w	d0,d1
	cmpi.w	#EDINSTR_MAX,d1
	bls.s	.ok
	move.b	#EDINSTR_MAX,d1
.ok	move.b	d1,d0
	gets	d1-d2
	rts
	
	acode
ProcessInstrDown	;V2.0	*NEW
	puts	d1-d2
	move.b	d0,d2
	beq.s	.exit
	moveq	#0,d1
	move.b	d0,d1
	jsr	SetDecShiftKeyRaster
	sub.w	d0,d1
	bpl.s	.ok
	
	moveq	#0,d1

.ok	cmpi.w	#EDINSTR_MAX,d1
	bhi.s	.exit
	move.b	d1,d2

.exit	move.b	d2,d0
	gets	d1-d2
	rts
	
	acode
PasteTrackTillPos	;V2.0
	BGN
	jsr	GetActualPattEd
	move.l	a0,a2
	move.l	PATTED_FIRSTNOTEDATA(a2),a0
	move.w	PATTED_CRSRY(a2),d7
	add.w	PATTED_CRSRYOFFSET(a2),d7
	subq.w	#1,d7
	bmi.s	.exit
	move.w	PATTED_CRSRX(a2),d6
	add.w	PATTED_CRSRXOFFSET(a2),d6
	mulu	PATTED_NOTESIZE(a2),d6
	lea.l	(a0,d6.w),a0
	move.w	PATTED_LINESIZE(a2),d6
	move.l	TrackBuffer_PTR,a1
	exg	a0,a1
.loop		jsr	CopyNote
		lea.l	(a0,d6.w),a0
		lea.l	(a1,d6.w),a1
	dbf	d7,.loop
.exit	RET

	acode
CutActualPattern
	IFNE	DEMO
	rts
	ELSE
	jsr	BackupPattern
	jsr	CopyPattern
	jsr	ClearActualPattern
	jsr	DrawEventStatusQ
	rts
	ENDC

	acode
PasteActualTrack	;V2.0
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a2
	move.l	PATTED_FIRSTNOTEDATA(a2),a0
	move.w	PATTED_LINESPERPATTERN(a2),d7
	subq.w	#1,d7
	move.w	PATTED_CRSRX(a2),d6
	add.w	PATTED_CRSRXOFFSET(a2),d6
	mulu	PATTED_NOTESIZE(a2),d6
	lea.l	(a0,d6.w),a0
	move.w	PATTED_LINESIZE(a2),d6
	move.l	TrackBuffer_PTR,a1
	exg	a0,a1
.loop		jsr	CopyNote
		lea.l	(a0,d6.w),a0
		lea.l	(a1,d6.w),a1
	dbf	d7,.loop
	lea.l	Test_PATTED,a0
	bsr	PatEdDrawPattern
	RET
	ENDC

	acode
SwapActualTrack	;V2.0
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern

	lea.l	Test_PATTED,a2
	move.l	PATTED_FIRSTNOTEDATA(a2),a0
	move.w	PATTED_LINESPERPATTERN(a2),d7
	subq.w	#1,d7
	move.w	PATTED_CRSRX(a2),d6
	add.w	PATTED_CRSRXOFFSET(a2),d6
	mulu	PATTED_NOTESIZE(a2),d6
	lea.l	(a0,d6.w),a0
	move.w	PATTED_LINESIZE(a2),d6
	move.l	TrackBuffer_PTR,a1
	exg	a0,a1
.loop		jsr	SwapNote
		lea.l	(a0,d6.w),a0
		lea.l	(a1,d6.w),a1
	dbf	d7,.loop
	lea.l	Test_PATTED,a0
	bsr	PatEdDrawPattern
	RET
	ENDC

	acode
AddActualTrack	;V1.0
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a2
	move.l	PATTED_FIRSTNOTEDATA(a2),a0
	move.w	PATTED_LINESPERPATTERN(a2),d7
	subq.w	#1,d7
	move.w	PATTED_CRSRX(a2),d6
	add.w	PATTED_CRSRXOFFSET(a2),d6
	mulu	PATTED_NOTESIZE(a2),d6
	lea.l	(a0,d6.w),a0
	move.w	PATTED_LINESIZE(a2),d6
	move.l	TrackBuffer_PTR,a1
	exg	a0,a1
.loop		move.b	NOTE_PITCH(a0),d0
		cmpi.b	#NOTEPITCH_NONOTE,d0
		beq.s	.skip
		cmpi.b	#NOTEPITCH_NONOTE,NOTE_PITCH(a1)
		bne.s	.skip
			jsr	CopyNote
.skip	lea.l	(a0,d6.w),a0
		lea.l	(a1,d6.w),a1
	dbf	d7,.loop
	lea.l	Test_PATTED,a0
	bsr	PatEdDrawPattern
	RET
	ENDC

	acode
ShrinkPattern
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	BackupPatternOff
	bsr	CopyPattern
	bsr	ClearActualPattern
	jsr	BackupPatternOn
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	move.l	POSITION_PATHEADPTR(a2),a3
	move.w	PATTED_LINESPERPATTERN(a0),d7
	move.w	PATTED_NUMBVOICES(a0),d6
	move.w	PATTED_LINESIZE(a0),d5
	move.w	d5,d4
	lsl.w	#1,d5
	move.l	PATTED_FIRSTNOTEDATA(a0),a0
	move.l	TrackBuffer_PTR,a1
	lsr.w	#1,d7
	subq.w	#1,d7
	subq.w	#1,d6
	move.w	d6,d3

	exg	a0,a1
	move.l	a0,a2
	move.l	a1,a3
.loop			jsr	CopyNote
			lea.l	NOTE_SIZEOF(a0),a0
			lea.l	NOTE_SIZEOF(a1),a1
		dbf	d6,.loop
		lea.l	(a2,d5.w),a2
		move.l	a2,a0
		lea.l	(a3,d4.w),a3
		move.l	a3,a1
		move.w	d3,d6
	dbf	d7,.loop
	lea.l	Test_PATTED,a0
	bsr	PatEdDrawPattern
	RET
	ENDC

	acode
ExpandPattern
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	jsr	BackupPatternOff
	bsr	CopyPattern
	bsr	ClearActualPattern
	jsr	BackupPatternOn
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	move.l	POSITION_PATHEADPTR(a2),a3
	move.w	PATTED_LINESPERPATTERN(a0),d7
	move.w	PATTED_NUMBVOICES(a0),d6
	move.w	PATTED_LINESIZE(a0),d5
	move.w	d5,d4
	lsl.w	#1,d4
	move.l	PATTED_FIRSTNOTEDATA(a0),a0
	move.l	TrackBuffer_PTR,a1
	lsr.w	#1,d7
	subq.w	#1,d7
	subq.w	#1,d6
	move.w	d6,d3

	exg	a0,a1
	move.l	a0,a2
	move.l	a1,a3
.loop	jsr	CopyNote
			lea.l	NOTE_SIZEOF(a0),a0
			lea.l	NOTE_SIZEOF(a1),a1
		dbf	d6,.loop
		lea.l	(a2,d5.w),a2
		move.l	a2,a0
		lea.l	(a3,d4.w),a3
		move.l	a3,a1
		move.w	d3,d6
	dbf	d7,.loop
	lea.l	Test_PATTED,a0
	bsr	PatEdDrawPattern
	RET
	ENDC

	acode
PartDupPattern
	IFNE	DEMO
	rts
	ELSE
	BGN
	bsr	CopyPattern

	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	move.l	POSITION_PATHEADPTR(a2),a3
	move.w	POSITION_LEN(a2),d7
	move.w	PATTED_NUMBVOICES(a0),d6
	move.w	PATTED_LINESIZE(a0),d5

	move.w	POSITION_STARTPOINT(a2),d2

	move.w	d7,d4
	mulu	d5,d4
	mulu	d5,d2
	add.w	d2,d4

	move.l	PATTED_FIRSTNOTEDATA(a0),a1
	move.l	TrackBuffer_PTR,a0
	subq.w	#1,d7
	subq.w	#1,d6
	move.w	d6,d3

	lea.l	(a0,d2.w),a0
	lea.l	(a1,d4.w),a1

	move.l	a0,a2
	move.l	a1,a3
.loop	jsr	CopyNote
			lea.l	NOTE_SIZEOF(a0),a0
			lea.l	NOTE_SIZEOF(a1),a1
		dbf	d6,.loop
		lea.l	(a2,d5.w),a2
		move.l	a2,a0
		lea.l	(a3,d5.w),a3
		move.l	a3,a1
		move.w	d3,d6
	dbf	d7,.loop
	lea.l	Test_PATTED,a0
	bsr	PatEdDrawPattern
	RET
	ENDC

	acode
CopyPattern
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	move.l	POSITION_PATHEADPTR(a2),a3
	move.w	PATTED_LINESPERPATTERN(a0),d7
	mulu	PATTED_NUMBVOICES(a0),d7
	move.l	PATTED_FIRSTNOTEDATA(a0),a0
	move.l	TrackBuffer_PTR,a1
	subq.w	#1,d7
	moveq	#NOTE_SIZEOF,d6
.loop	jsr	CopyNote
		lea.l	(a0,d6.w),a0
		lea.l	(a1,d6.w),a1
	dbf	d7,.loop
	RET
	ENDC

	acode
GetActualPattern
	jsr	GetActualPattEd
	move.l	PATTED_FIRSTNOTEDATA(a0),a0
	rts

	acode
GetActualPatNum
	puts	a0
	jsr	GetActualPattEd
	move.l	PATTED_ACTUALSONGDATA(a0),a0
	move.w	POSITION_PATNUM(a0),d0
	gets	a0
	rts

	acode
GetActualPatNotes
	puts	a0
	jsr	GetActualPattEd
	move.w	PATTED_LINESPERPATTERN(a0),d0
	mulu	PATTED_NUMBVOICES(a0),d0
	gets	a0
	rts

	acode
CopyLockedNotes
	BGN
	bsr	GetActualPatNum
	cmp.w	LockState(PC),d0
	bne.s	.exit

	bsr	GetActualPattern
	move.l	LockBuffer_PTR,a1

	bsr	GetActualPatNotes
	subq.w	#1,d0
	moveq	#NOTE_SIZEOF,d6

	exg	a0,a1

	bsr	GetActualPattern
	move.l	LockBuffer_PTR,a1
	bsr	GetActualPatNotes
	subq.w	#1,d0
	moveq	#NOTE_SIZEOF,d6
	exg	a0,a1
.loop		jsr	ULCopyNote
		lea.l	(a0,d6.w),a0
		lea.l	(a1,d6.w),a1
	dbf	d0,.loop
.exit	RET

	acode
ULCopyNote
	puts	d0
	jsr	CheckNoteType
	cmpi.l	#NOTETYPEID_NONE,d0
	bne.s	ULCopyNote_M2
	gets	d0
	rts
ULCopyNote_M2
	jsr	CopyNote
	gets	d0
	rts
	
	acode
LockPattern
	cmpi.w	#-1,LockState
	bne.w	UnlockPattern
	BGN
	bsr	GetActualPatNum
	move.w	d0,LockState
	bsr	GetActualPattern
	move.l	LockBuffer_PTR,a1
	bsr	GetActualPatNotes
	subq.w	#1,d0
	moveq	#NOTE_SIZEOF,d6
.loop	jsr	CopyNote
	lea.l	(a0,d6.w),a0
	lea.l	(a1,d6.w),a1
	dbf	d0,.loop
	ASSTXT	PatLocked
	RET

	acode
LockState	dc.w	-1

FillLINETITLE_TXT
	blk.b	PEDLINETITLE_W," "
	dc.b	0
NotePre_TXT	dc.b	" ",0
Fill5_TXT	
	blk.b	10-3," "	;NOTELEN-3
	dc.b	0
	even
pattedtest_TXT	dc.b	"           ",0


	acode
ClrLockState
	move.w	#-1,LockState
	rts

	acode
UnlockPattern
	move.w	#-1,LockState
	ASSTXT	Patunlocked
	rts

	acode
VerifyValueRangeW
	;I(D0L,D1W)(MINMAX, VALUE)
	cmp.w	d0,d1
	bge	VerifyVRW_MinOk
		move.w	d0,d1
		bra.s	VerifyVRW_X

VerifyVRW_MinOk
	swap	d0
	cmp.w	d0,d1
	ble	VerifyVRW_MaxOk
		move.w	d0,d1
VerifyVRW_MaxOk
	swap	d0
VerifyVRW_X
	rts

	acode
KeybTuneU
	puts	d0-d1
	jsr	SetOctaveKeyRaster
	move.w	KeyboardTune(PC),d1
	add.w	d0,d1
	move.l	KeyboardTune+2,d0
	jsr	VerifyValueRangeW
	move.w	d1,KeyboardTune
	jsr	PattEdDrawStatus
	gets	d0-d1
	rts

	acode
KeybTuneD
	puts	d0-d1
	jsr	SetOctaveKeyRaster
	move.w	KeyboardTune(PC),d1
	sub.w	d0,d1
	move.l	KeyboardTune+2,d0
	jsr	VerifyValueRangeW
	move.w	d1,KeyboardTune
	jsr	PattEdDrawStatus
	gets	d0-d1
	rts
KeyboardTune	dc.w	12
		dc.w	56,0

	acode
BackupPattern
	cmpi.b	#TRUE,BackupPattern_FLAG
	beq.s	BackupPattern_Do
		rts
BackupPattern_Do	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	move.l	POSITION_PATHEADPTR(a2),a3
	move.w	PATTED_LINESPERPATTERN(a0),d7
	mulu	PATTED_NUMBVOICES(a0),d7
	move.l	PATTED_FIRSTNOTEDATA(a0),a0
	move.l	UndoBuffer_PTR,a1
	subq.w	#1,d7
	moveq	#NOTE_SIZEOF,d6
BackupPattern_L	jsr	CopyNote
		lea.l	(a0,d6.w),a0
		lea.l	(a1,d6.w),a1
	dbf	d7,BackupPattern_L
	RET
BackupPattern_FLAG	dc.b	TRUE
	even

	acode
BackupPatternOn
	move.b	#TRUE,BackupPattern_FLAG
	rts
	acode
BackupPatternOff
	move.b	#FALSE,BackupPattern_FLAG
	rts

	acode
UndoPattern
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	move.l	POSITION_PATHEADPTR(a2),a3
	move.w	PATTED_LINESPERPATTERN(a0),d7
	mulu	PATTED_NUMBVOICES(a0),d7
	move.l	PATTED_FIRSTNOTEDATA(a0),a0
	move.l	UndoBuffer_PTR,a1
	exg	a0,a1
	subq.w	#1,d7
	moveq	#NOTE_SIZEOF,d6
UndoPattern_L	jsr	SwapNote
		lea.l	(a0,d6.w),a0
		lea.l	(a1,d6.w),a1
	dbf	d7,UndoPattern_L
	bsr	PatEdDrawPattern
	RET
	ENDC

	acode
PastePattern
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	BackupPattern
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	move.l	POSITION_PATHEADPTR(a2),a3
	move.w	PATTED_LINESPERPATTERN(a0),d7
	mulu	PATTED_NUMBVOICES(a0),d7
	move.l	PATTED_FIRSTNOTEDATA(a0),a0
	move.l	TrackBuffer_PTR,a1
	subq.w	#1,d7
	exg	a0,a1
InsertActualPattern_L
		jsr	CopyNote
		lea.l	NOTE_SIZEOF(a0),a0
		lea.l	NOTE_SIZEOF(a1),a1
	dbf	d7,InsertActualPattern_L
	lea.l	Test_PATTED,a0
	bsr	PatEdDrawPattern
	RET
	ENDC


	acode
GetPEDBody:	;O(D0W-D3W,A1,A5)(XYWH,RP,NGWIN)
	puts	d7/a0
	move.l	#NGWIN_PED,d0
	move.l	#"PED2",d1
	bsr	NGGetInnerAreaData

	move.w	FONT_H,d7
	lsl.w	#1,d7
	cmp.w	d7,d3
	blo.s	.closed	

	move.w	FONT_W,d7
	mulu	#16,d7
	cmp.w	d7,d2
	blo.s	.closed	

	cmp.l	#0,a0
	beq.s	.closed
	cmp.l	#0,a5
	beq.s	.closed
.exit	gets	d7/a0
	rts
.closed	suba.l	a1,a1
	bra.s	.exit

	acode
InitPattEd:	;V1.1
		;I(A1L)(SONG)
	BGN
	;--- Init Patted Song ---
	jsr	GetActualPattEd
	jsr	PatEdCrsrOff
	move.l	a1,PATTED_SONG(a0)				;A0 PATTED
	move.w	SONG_NUMBVOICES(a1),PATTED_NUMBVOICES(a0)	;A1 SONG

	move.l	SONG_FIRSTSONGDATA(a1),a2				;A2 SONGDATA(first)
	move.l	a2,PATTED_FIRSTSONGDATA(a0)
	move.l	a2,PATTED_ACTUALSONGDATA(a0)

	move.w	PATTED_NUMBVOICES(a0),d0
	mulu	#NOTE_SIZEOF,d0
	move.w	d0,PATTED_LINESIZE(a0)
	move.w	d0,SONG_LINESIZE(a1)

	move.w	#NOTE_SIZEOF,PATTED_NOTESIZE(a0)


	;--- Init PattED View ---
	bsr	GetPEDBody
	cmp.l	#0,a1
	beq.s	.exit
	move.w	d0,PATTED_DISPX(a0)
	move.w	d1,PATTED_DISPY(a0)
	move.w	d2,PATTED_WEIDTH(a0)
	move.w	d3,PATTED_HEIGHT(a0)
	move.l  a1,PATTED_RP(a0)
	move.w	FONT_BASE,d0
	neg.w	d0
	move.w	d0,PATTED_TEXTPIXOFFSET(a0)
	clr.w	PATTED_ACTPOSNUM(a0)
	bsr	InitPatEdDisp
	bsr	PEDInitActualPattern
	move.l  PATTED_RP(a0),a1
	bsr	PatEdDrawPattern
.exit	jsr	PatEdCrsrOn
	RET

RANGE_X	EQU	0
RANGE_Y	EQU	2
RANGE_W	EQU	4
RANGE_H	EQU	6

	acode
Check2DRange	;V2.0
		;2.0: partial range valid possible now 
		;I(X,Y,RANGE)(D0W,D1W,A0L)
		;O(D0W,D1W)(DELTAX,DELTAY)
	puts	a1
	move.l	PATTED_RP(a2),a1
	andi.l	#$ffff,d0
	andi.l	#$ffff,d1
	sub.w	RANGE_X(a0),d0
	bmi.s	Check2DRange_XIll
	cmp.w	RANGE_W(a0),d0
	bls.s	Check2DRange_XOk
Check2DRange_XIll
		moveq	#-1,d0
Check2DRange_XOk

	sub.w	RANGE_Y(a0),d1
	bmi.s	Check2DRange_YIll
	cmp.w	RANGE_H(a0),d1
	bls.s	Check2DRange_YOk
Check2DRange_YIll
		moveq	#-1,d1
Check2DRange_YOk
	gets	a1
	rts


	acode
InitPatEdDisp	;V1.0
	BGN	;I(A0L)(PATTED)
	bsr	GetPEDBody
	cmp.l	#0,a1
	beq	.exit

	movem.w	d0-d3,PATTED_EDITXYWH(a0)

	clr.w	PATTED_CRSRXOFFSET(a0)
	clr.w	PATTED_CRSRYOFFSET(a0)
	
	moveq	#PEDLINETITLE_W,d0
	moveq	#PEDTITLE_H,d1
	jsr	CharToPixel
	move.w	d0,d3
	move.w	d1,d4
	move.w	d3,d5

	move.l	NOTELEN,d0
	moveq	#1,d1
	jsr	CharToPixel
	move.w	d0,PATTED_NOTEW(a0)
	move.w	d1,PATTED_NOTEH(a0)

	move.l	VEX_LinesPerPattern,d2
	move.w	d2,PATTED_LINESPERPATTERN(a0)

	moveq	#0,d2
	move.w	PATTED_WEIDTH(a0),d2
	sub.w	d3,d2
	add.w	FONT_W,d2
	divu	d0,d2
	andi.l	#$ffff,d2
	cmp.w	PATTED_NUMBVOICES(a0),d2
	bls.s	.OK
		move.w	PATTED_NUMBVOICES(a0),d2
.OK	
	move.w	d2,PATTED_DISPNUMBTRACKS(a0)

	moveq	#0,d2
	move.w	PATTED_HEIGHT(a0),d2
	sub.w	d4,d2
	divu	d1,d2
	cmp.w	PATTED_LINESPERPATTERN(a0),d2
	bls.s	.OK2
		move.w	PATTED_LINESPERPATTERN(a0),d2
.OK2	move.w	d2,PATTED_DISPNUMBLINES(a0)


	;--- CORRECT W,H ---
	move.w	PATTED_DISPNUMBTRACKS(a0),d0
	mulu	PATTED_NOTEW(a0),d0
	subq.w	#1,d0
	move.w	PATTED_DISPNUMBLINES(a0),d1
	mulu	PATTED_NOTEH(a0),d1
	subq.w	#1,d1
	movem.w	d0-d1,PATTED_EDITXYWH+4(a0)


	;--- CORR X,Y ---
	;movem.w	PATTED_DISPX(a0),d0-d1
	;add.w	d0,PATTED_EDITXYWH(a0)
	;add.w	FONT_H,d1
	;add.w	FONT_H,d1
	;add.w	FONT_H,d1
	;sub.w	PATTED_TEXTPIXOFFSET(a0),d1
	;add.w	d1,PATTED_EDITXYWH+2(a0)
.exit	RET



	acode
PEDInitActualPattern
		;I(A0L)(PATTED)
	puts	a1-a3
	move.w	#0,PATTED_CRSRX(a0)
	move.w	#0,PATTED_CRSRY(a0)
	move.w	#0,PATTED_CRSRXOFFSET(a0)
	move.w	#0,PATTED_CRSRYOFFSET(a0)
	move.l	PATTED_FIRSTSONGDATA(a0),a1
	move.l	POSITION_PATHEADPTR(a1),a2
	move.l	PATHEAD_NOTEDATAPTR(a2),a3
	move.l	a3,PATTED_FIRSTNOTEDATA(a0)
	move.l	a3,PATTED_ACTNOTEDATA(a0)
	gets	a1-a3
	rts

	acode
PatEdCrsrOn:	;V1.0
	puts	a0
	jsr	GetActualPattEd
	cmpi.b	#TRUE,PATTED_CRSRSTATE(a0)
	beq.s	.exit
	bsr	PatEdDrawCrsr
	move.b	#TRUE,PATTED_CRSRSTATE(a0)
.exit	gets	a0
	rts

	acode
PatEdCrsrOff	;V1.0
	puts	a0
	jsr	GetActualPattEd
	cmpi.b	#FALSE,PATTED_CRSRSTATE(a0)
	beq.s	.exit
	bsr	PatEdDrawCrsr
	move.b	#FALSE,PATTED_CRSRSTATE(a0)
.exit	gets	a0
	rts


	acode
PatEdDrawCrsr:	;V1.0
	BGN
	bsr	GetPEDBody
	cmp.l	#0,a1
	beq	.exit

	bsr	GetActualPattEd
	move.l	a0,a2

	move.l	NOTELEN,d0
	moveq	#1,d1
	jsr	CharToPixel

	move.w	d0,d2
	sub.w	FONT_W,d2
	move.w	d1,d3

	move.w	d0,d4
	mulu	PATTED_CRSRXOFFSET(a2),d4
	move.w	FONT_H,d5
	mulu	PATTED_CRSRYOFFSET(a2),d5

	moveq	#PEDLINETITLE_W-1,d0
	moveq	#PEDTITLE_H,d1
	jsr	CharToPixel
	move.l	PATTED_RP(a2),a1
	add.w	PATTED_DISPX(a2),d0
	add.w	PATTED_DISPY(a2),d1
	subq.w	#1,d3

	add.w	d4,d0
	add.w	d5,d1
	subq.w	#1,d2
	subq.w	#1,d3

	jsr	Set2PMask
	bsr	NGRRectInvert
	
	;--- BLOCK ON LEFT SIDE ---
	puts	d0-d3
	move.w	FONT_W,d2
	mulu	#3,d2
	subq.w	#1,d2
	move.w	PATTED_DISPX(a2),d0

	move.w	FONT_H,d3
	subq.w	#1,d3
	bsr	NGRRectInvert
	gets	d0-d3

	;--- BLOCK ON TOP SIDE ---
	puts	d1-d3
	move.w	FONT_W,d2
	mulu	#3,d2
	add.w	FONT_W,d0
	subq.w	#1,d2

	move.w	FONT_H,d3
	subq.w	#1,d3
	move.w	PATTED_DISPY(a2),d1
	bsr	NGRRectInvert
	gets	d1-d3


	;--- H LINE UNDER CRSR
	move.w	FONT_W,d0
	mulu	#4,d0
	add.w	PATTED_EDITXYWH(a2),d0

	move.w	PATTED_EDITXYWH+4(a2),d2

	add.w	FONT_BASE,d1
	addq.w	#1,d1
	moveq	#1,d3
	bsr	NGRRectInvert
	jsr	SetOldPMask

	bsr	NGRNrm1DrMd
.exit	RET


	acode
PatEdGetDispBounds	;V1.0
			;O(D0W,D1W,D2W,D3W)(MINX,MINY,MAXX,MAXY)
	puts	a0
	bsr	GetActualPattEd
	move.w	PATTED_CRSRX(a0),d0
	move.w	PATTED_CRSRY(a0),d1
	move.w	PATTED_DISPNUMBTRACKS(a0),d2
	move.w	PATTED_DISPNUMBLINES(a0),d3
	add.w	d0,d2
	add.w	d1,d3
	gets	a0
	rts

	acode
PatEdLimitToDisp	;V1.0
			;I(D0W,D1W)(CRSRX,CRSRY)
			;O(D0W,D1W)(CRSRX,CRSRY) limited to visible range
	puts	d2-d5
	move.w	d0,d4
	move.w	d1,d5
	bsr	PatEdGetDispBounds
	cmp.w	d0,d4
	bhs.s	.M1
		move.w	d0,d4
.M1	cmp.w	d2,d4
	bls.s	.M2
		move.w	d2,d4
.M2	cmp.w	d1,d5
	bhs.s	.M3
		move.w	d1,d5
.M3	cmp.w	d3,d5
	bls.s	.M4
		move.w	d3,d5
.M4	move.w	d4,d0
	move.w	d5,d1
	gets	d2-d5
	rts

	acode
PatEdCrsrToPix	;V1.0
		;I(D0W,D1W)(CRSRXOFFSET[0..x],CRSRYOFFSET[0..y])
		;O(D0W,D1W)(X,Y[PIXEL])
	puts	d2-d5/a0
	move.w	d0,d4
	move.w	d1,d5

	bsr	GetActualPattEd

	move.l	NOTELEN,d0
	moveq	#1,d1
	jsr	CharToPixel


	move.w	d0,d2
	mulu	d4,d2
	move.w	FONT_H,d3
	mulu	d5,d3

	moveq	#PEDLINETITLE_W-1,d0
	moveq	#PEDTITLE_H,d1
	jsr	CharToPixel
	add.w	PATTED_DISPX(a0),d0
	add.w	PATTED_DISPY(a0),d1
	add.w	d2,d0
	add.w	d3,d1
	gets	d2-d5/a0
	rts

	acode
BlockRangeOff
	bsr	HideBlockRange
	move.w	#FALSE,BLOCKDRAW+2
	rts

	acode
BlockRangeOn
	move.w	#TRUE,BLOCKDRAW+2
	bsr	ShowBlockRange
	rts

	acode
HideBlockRange:
	cmpi.b	#TRUE,MACROPROCESS
	beq.s	.exit
	cmpi.w	#TRUE,BLOCKDRAW
	beq.s	PatEdDrawBlockRange
.exit	rts

	acode
ShowBlockRange:
	cmpi.b	#TRUE,MACROPROCESS
	beq.s	.exit
	cmpi.w	#FALSE,BLOCKDRAW
	beq.s	PatEdDrawBlockRange
.exit	rts

GetPEDRP:	;O(A1L,A5L)
	puts	d0-d3
	bsr	GetPEDBody
	gets	d0-d3
	rts

	acode
DrawBlockRange:
PatEdDrawBlockRange:
	cmpi.b	#TRUE,MACROPROCESS
	bne	.do
.do	BGN
	bsr	GetPEDRP
	cmp.l	#0,a1
	beq	.exit
	tst.w	ActualBlock_INFO
	bne	.exit
	cmpi.w	#TRUE,BLOCKDRAW+2
	bne	.exit

	lea.l	ActualBlock_INFO(PC),a2
	tst.w	BLOCKINFO_W(a2)
	beq.s	.exit
	tst.w	BLOCKINFO_H(a2)
	beq.s	.exit

	lea.l	BLOCKINFO_X(a2),a2

	bsr	GetActualPattEd
	movem.w	(a2)+,d2-d3
	movem.w	(a2)+,d0-d1
	addq.w	#1,d0
	addq.w	#1,d1
	bsr	PatEdLimitToDisp
	sub.w	PATTED_CRSRX(a0),d0
	sub.w	PATTED_CRSRY(a0),d1
	bsr	PatEdCrsrToPix
	exg	d0,d2
	exg	d1,d3
	bsr	PatEdLimitToDisp
	sub.w	PATTED_CRSRX(a0),d0
	sub.w	PATTED_CRSRY(a0),d1
	bsr	PatEdCrsrToPix

	sub.w	d0,d2
	sub.w	d1,d3

	subq.w	#1,d2
	sub.w	FONT_W,d2
	bmi.s	.exit
	subq.w	#1,d3
	bmi.s	.exit


	bsr	GetPEDRP
	jsr	Set2PMask
	jsr	NGRRectInvert
	jsr	SetOldPMask
	eori.w	#-1,BLOCKDRAW

	bsr	NGRNrm1DrMd
.exit	RET

BLOCKDRAW	dc.w	FALSE,TRUE

	acode
PatEdDrawLineN	;V1.0
		;I(D0W)(YOFFSET#)
	jsr	HideBlockRange
	BGN
	moveq	#0,d7
	move.w	d0,d7
	bmi.s	PatEdDrawLineN_X
	jsr	GetActualPattEd
	move.l	a0,a2

	bsr	GetPEDRP
	bsr	PatEdMainDrMd
	bra	PatEdDrawActLine_IN
PatEdDrawLineN_X
	RET



	acode
DrawNoteSiFxVol
	andi.l	#$ff,d0
	lea.l	PEDSiFx_CONVTAB,a2
	exg	a0,a2
	jsr	ProcTabValuetoLong
	exg	a0,a2
	swap	d0
	move.w	d0,-2(a0)
	rol.l	#8,d0
	move.b	d0,(a0)
	move.w	#"--",-4(a0)
	RET

DrawNote_SETPITCH
		move.l	#"PITC",4(a0)
		move.b	#"H",8(a0)
	RET

DrawNote_PitchUp
		move.l	#"P Up",4(a0)
		move.b	#" ",8(a0)
	RET

DrawNote_PitchUp2
		move.l	#"P2Up",4(a0)
		move.b	#" ",8(a0)
	RET

DrawNote_PitchUp3
		move.l	#"P4Up",4(a0)
		move.b	#" ",8(a0)
	RET

DrawNote_PitchDown
		move.l	#"P Dw",4(a0)
		move.b	#"n",8(a0)
	RET

DrawNote_PitchDown2
		move.l	#"P2Dw",4(a0)
		move.b	#"n",8(a0)
	RET

DrawNote_PitchDown3
		move.l	#"P4Dw",4(a0)
		move.b	#"n",8(a0)
	RET

	acode
DrawNotePEDVol
	cmpi.b	#100,d0
	bhs.s	.VolHigh

	divu	#10,d0
	addi.b	#"0",d0
	move.b	d0,-1(a0)

	swap	d0
	addi.b	#"0",d0
	move.b	d0,(a0)
	rts
.VolHigh
	move.b	#"+",-1(a0)
	move.b	#"0",(a0)
	rts


	acode
ConvertNote_CPLX
	moveq	#0,d0
	move.b	NOTE_FX(a2),d0

	lea.l	Note_TXT,a3
	move.l	#CNOTE_EMPTYA,(a3)

	lea.l	FXDraw_CONVERTAB,a0
	jsr	ProcTabValuetoLong
	cmpi.l	#-1,d0
	beq.s	DrawNote_ERR
	move.l	d0,(a3)

	lea.l	4(a3),a0
	move.l	#CNOTE_EMPTYB,(a0)
	moveq	#0,d0
	move.b	NOTE_INSTR(a2),d0
	jsr	ConvDecBytePtr

	lea.l	4(a0),a0
	moveq	#0,d0
	move.b	NOTE_VOLUME(a2),d0
	bsr	DrawNotePEDVol
	RET

	acode
DrawNote_ERR
	jsr	WarnFlash
	RET


	IFNE BAREDITOR
CNOTE_EMPTYA	EQU	"----"
CNOTE_EMPTYB	EQU	"000-"
CNOTE_EMPTYC	EQU	"-"
	ELSE

CNOTE_EMPTYA	EQU	"    "
CNOTE_EMPTYB	EQU	"    "
CNOTE_EMPTYC	EQU	" "
	ENDC


	acode
ConvertNote
	;I(A0L)(NOTE_PTR)
	BGN
	move.l	a0,a2
	jsr	CheckNoteType
	cmpi.w	#NOTETYPEID_COMPLEXFX,d0
	beq.s	ConvertNote_CPLX
	
	lea.l	Note_TXT,a0
	move.l	#CNOTE_EMPTYA,(a0)


	moveq	#0,d0
	move.b	NOTE_PITCH(a2),d0



	cmpi.b	#-1,d0
	beq.s	DrawNote_NONOTE

		divu	Actual_FREQDEF+FREQDEF_OCTAVE,d0
		move.b	d0,d1
		andi.b	#$7,d1
		addi.b	#"0",d1

		swap	d0
		lsl.w	#1,d0
	
		lea.l	NoteNameB_TAB,a3
		move.w	(a3,d0.w),d3
		move.w	d3,(a0)
		move.b	d1,2(a0)

		cmpi.b	#VOLUME_SETPITCH,NOTE_VOLUME(a2)
		beq	DrawNote_SETPITCH
		cmpi.b	#VOLUME_PITCHUP,NOTE_VOLUME(a2)
		beq	DrawNote_PitchUp
		cmpi.b	#VOLUME_PITCHUP2,NOTE_VOLUME(a2)
		beq	DrawNote_PitchUp2
		cmpi.b	#VOLUME_PITCHUP3,NOTE_VOLUME(a2)
		beq	DrawNote_PitchUp3
		cmpi.b	#VOLUME_PITCHDOWN,NOTE_VOLUME(a2)
		beq	DrawNote_PitchDown
		cmpi.b	#VOLUME_PITCHDOWN2,NOTE_VOLUME(a2)
		beq	DrawNote_PitchDown2
		cmpi.b	#VOLUME_PITCHDOWN3,NOTE_VOLUME(a2)
		beq	DrawNote_PitchDown3

DrawNote_NONOTE

	lea.l	4(a0),a0
	move.l	#CNOTE_EMPTYB,(a0)
	moveq	#0,d0
	move.b	NOTE_INSTR(a2),d0
	jsr	ConvDecBytePtr
	bra.s	DrawNote_NOINSTR
	
DrawNote_NOFX
	cmpi.b	#VOLUME_PITCHUP,NOTE_VOLUME(a2)
	beq	DrawNote_PitchUp
	cmpi.b	#VOLUME_PITCHDOWN,NOTE_VOLUME(a2)
	beq	DrawNote_PitchDown
	cmpi.b	#VOLUME_PITCHUP2,NOTE_VOLUME(a2)
	beq	DrawNote_PitchUp2
	cmpi.b	#VOLUME_PITCHDOWN2,NOTE_VOLUME(a2)
	beq	DrawNote_PitchDown2
	cmpi.b	#VOLUME_PITCHUP3,NOTE_VOLUME(a2)
	beq	DrawNote_PitchUp3
	cmpi.b	#VOLUME_PITCHDOWN3,NOTE_VOLUME(a2)
	beq	DrawNote_PitchDown3

	lea.l	4(a0),a0
	move.l	#CNOTE_EMPTYB,(a0)
	moveq	#0,d0
	move.b	NOTE_INSTR(a2),d0
	cmpi.b	#-1,d0
	beq.s	DrawNote_NOINSTR
		jsr	ConvDecBytePtr
DrawNote_NOINSTR
	lea.l	4(a0),a0
	move.b	#CNOTE_EMPTYC,(a0)

	moveq	#0,d0
	move.b	NOTE_VOLUME(a2),d0
	beq.s	.exit
	cmpi.b	#100,d0
	bhi	DrawNoteSiFxVol
	bsr	DrawNotePEDVol
.exit	RET



PatEdMainDrMd:
	bsr	NGRNrm1DrMd	;overwrite mode
	bra	NGRDarkAPen

	acode
PatEdDrawFirstLine	;V1.0
	jsr	HideBlockRange
	BGN
	jsr	GetActualPattEd
	move.l	a0,a2

	bsr	GetPEDRP
	bsr	PatEdMainDrMd

	moveq	#0,d7
	bra.s	PatEdDrawActLine_IN

	acode
PatEdDrawLastLine	;V1.0
	jsr	HideBlockRange
	BGN
	jsr	GetActualPattEd
	move.l	a0,a2

	bsr	GetPEDRP
	cmp.l	#0,a1
	beq	PatEdDrawLineN_X
	bsr	PatEdMainDrMd


	move.w	PATTED_DISPNUMBLINES(a2),d7
	subq.w	#1,d7
	bra.s	PatEdDrawActLine_IN

	acode
PatEdDrawActLine	;V1.0
	jsr	HideBlockRange
	BGN
	jsr	GetActualPattEd
	move.l	a0,a2
	move.w	PATTED_CRSRYOFFSET(a2),d7

PatEdDrawActLine_IN

	bsr	GetPEDRP
	cmp.l	#0,a1
	beq	.exit

	jsr	PatEdCrsrOff
	move.l	PATTED_FIRSTNOTEDATA(a2),a3
	move.w	PATTED_CRSRX(a2),d0
	mulu	PATTED_NOTESIZE(a2),d0

	move.w	PATTED_CRSRY(a2),d1
	add.w	d7,d1
	mulu	PATTED_LINESIZE(a2),d1
	add.l	d0,d1
	lea.l	(a3,d1.l),a3

	move.l	PattedTxtBuf_PTR,a1
	clr.b	(a1)
	move.w	PATTED_CRSRY(a2),d0
	add.w	d7,d0

	move.b	#" ",NotePre_TXT
	move.l	TabulatorMem_PTR,a0
	tst.b	(a0,d0.w)
	beq.s	.NOTAB
		move.b	#"T",NotePre_TXT
.NOTAB

	jsr	ConvertToDecByte
	lea	DecByteSave,a0
	jsr	AddString

	move.w	PATTED_DISPNUMBTRACKS(a2),d5
	subq.w	#1,d5
	move.l	a3,a4



.loop		lea.l	NotePre_TXT(PC),a0
		jsr	AddString
		move.b	#" ",(a0)

		move.l	a4,a0

		bsr	ConvertNote
		lea.l	Note_TXT,a0

		cmpi.l	#10,NOTELEN
		beq.s	.wide

		cmpi.l	#CNOTE_EMPTYA,(a0)
		bne.s	.nosimple
		move.l	5(a0),(a0)
.nosimple
		clr.b	4(a0)
.wide		
		jsr	AddString
		move.l	VEX_NoteSize,d0
		lea.l	(a4,d0.w),a4


	dbf	d5,.loop
	move.l	VEX_LineSize,d0
	lea.l	(a3,d0.w),a3

	move.w	PATTED_DISPY(a2),d1
	add.w	FONT_H,d1
	move.w	d7,d0
	mulu	FONT_H,d0
	add.w	d0,d1

	bsr	GetPEDRP
	bsr	PatEdMainDrMd
	bsr	PEDDrawTxtLine
	move.b	#TRUE,PATTED_CRSRSTATE(a2)
	bsr	PatEdDrawCrsr
.exit	RET


PattedTxtBuf_PTR	dc.l	0,1024,FASTMEM
LockBuffer_PTR	dc.l	0,0,FASTMEM



	acode
SetPosNumb	;I(D0W)(POSNUMB)
	BGN
	jsr	GetActualPattEd
	move.w	d0,PATTED_ACTPOSNUM(a0)

	jsr	PosToPatNum
	RET

	acode


MoveBgnPattern
PattedUpdateDisp:	;V1.1
			;V1.1 : PattEdDrawStatus
	BGN
	jsr	DrawPattedTitle
	lea.l	PattedUpdate_OLD(PC),a2
	bsr	GetActualPattEd
	bsr	CalcActNoteData

	move.l	PATTED_FIRSTNOTEDATA(a0),d2
	move.w	PATTED_CRSRY(a0),d3
	move.w	PATTED_CRSRX(a0),d4
	cmp.l	(a2),d2
	bne.s	.slow
	cmp.w	4(a2),d3
	bne.s	.slow
	cmp.w	6(a2),d4
	beq.s	.quick
.slow	move.l	d2,(a2)
	move.w	d3,4(a2)
	move.w	d4,6(a2)
	bsr	PatEdDrawPattern
	bsr	ShowBlockRange
.quick	bsr	PattEdDrawStatus
	RET
PattedUpdate_OLD	dc.l	-1,-1

	acode
PattedUpdateReset
	puts	d0/a0
	lea.l	PattedUpdate_OLD(PC),a0
	moveq	#-1,d0
	move.l	d0,(a0)+
	move.l	d0,(a0)+
	gets	d0/a0
	rts


	acode
PatEdDrawTitle	;V1.0
	BGN
	jsr	GetActualPattEd
	move.l	a0,a2
	bsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit
	jsr	PatEdCrsrOff

	bsr	PatEdMainDrMd

	bsr	PEDBuildTitle
	move.w	PATTED_DISPY(a2),d1
	move.w	d1,d6
	bsr	PEDDrawTxtLine
	jsr	PatEdCrsrOn
.exit	RET

PatEdDrawTitleQ	;V1.0
	BGN
	jsr	GetActualPattEd
	move.l	a0,a2
	bsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit

	bsr	PatEdMainDrMd

	bsr	PEDBuildTitle
	move.w	PATTED_DISPY(a2),d1
	move.w	d1,d6
	bsr	PEDDrawTxtLine
.exit	RET



	acode
PatEdDrawPattern:	;V1.1
	;V1.1	VIRT_MSG -> NO UPDATE !!
	cmpi.b	#TRUE,VIRTUEL_MSG
	bne.s	.DO
		rts
.DO	BGN

	bsr	PatEdCrsrOff
	bsr	HideBlockRange
	jsr	CopyLockedNotes

	jsr	GetActualPattEd
	move.l	a0,a2

	bsr	GetPEDRP
	cmp.l	#0,a1
	beq	.exit


	IFNE	DIRECTPEDGFX
	tst.b	FASTGFX
	;bpl.s	.slow
	bra.s	.slow
	move.l	(a1),a3
	tst.l	(a3)
	beq	PatEdDrawPattern_FAST
.slow
	ENDC
	bsr	PatEdMainDrMd

	jsr	Set2PMask

	bsr	PEDBuildTitle
	move.w	PATTED_DISPY(a2),d1
	move.w	d1,d6
	bsr	PEDDrawTxtLine
	add.w	FONT_H,d6



	move.b	#TRUE,PATTED_CRSRSTATE(a2)
	move.w	PATTED_CRSRY(a2),d2
	move.w	PATTED_DISPNUMBLINES(a2),d7
	subq.w	#1,d7
	bmi.w	.quit

	move.l	PATTED_FIRSTNOTEDATA(a2),a3
	move.w	PATTED_CRSRX(a2),d0
	mulu	PATTED_NOTESIZE(a0),d0
	lea.l	(a3,d0.l),a3
	move.w	PATTED_CRSRY(a0),d0
	mulu	PATTED_LINESIZE(a0),d0
	lea.l	(a3,d0.l),a3

.Line_L
	move.l	PattedTxtBuf_PTR(PC),a1
	clr.b	(a1)

	move.b	#" ",NotePre_TXT
	move.l	TabulatorMem_PTR,a0
	tst.b	(a0,d2.w)
	beq.s	.NOTABULATOR
		move.b	#"T",NotePre_TXT
.NOTABULATOR
	move.w	d2,d0
	jsr	ConvertToDecByte
	lea	DecByteSave,a0
	jsr	AddString

	move.w	PATTED_DISPNUMBTRACKS(a2),d5
	subq.w	#1,d5

	move.l	a3,a4

.LineNote_L
		lea.l	NotePre_TXT(PC),a0
		jsr	AddString
		move.b	#" ",(a0)

		move.l	a4,a0
		jsr	ConvertNote
		lea.l	Note_TXT,a0
		cmpi.l	#10,NOTELEN
		beq.s	.wide

		cmpi.l	#CNOTE_EMPTYA,(a0)
		bne.s	.nosimple
		move.l	5(a0),(a0)
.nosimple	
		clr.b	4(a0)

.wide		jsr	AddString
		move.l	VEX_NoteSize,d0
		lea.l	(a4,d0.w),a4


	dbf	d5,.LineNote_L
	move.l	VEX_LineSize,d0
	lea.l	(a3,d0.l),a3

	move.w	d6,d1
	bsr	PEDDrawTxtLine
	add.w	FONT_H,d6

	addq.w	#1,d2

	dbf	d7,.Line_L
.quit

	bsr	GetPEDRP
	bsr	PatEdDrawCrsr
	bsr	ShowBlockRange
	jsr	SetOldPMask
.exit	RET


	IFNE	DIRECTPEDGFX
PatEdDrawPattern_FAST
	bsr	CalcPattedFAST

	move.l	PEDFASTCORR_RP,a1
	bsr	PatEdMainDrMd

	jsr	Set2PMask

	bsr	PEDBuildTitle
	move.w	PATTED_DISPY(a2),d1
	move.w	d1,d6
	bsr	PEDDrawTxtLineFAST
	add.w	FONT_H,d6

	move.w	PATTED_CRSRY(a2),d2
	move.w	PATTED_DISPNUMBLINES(a2),d7
	subq.w	#1,d7
	bmi.w	.exit2

	move.l	PATTED_FIRSTNOTEDATA(a2),a3
	move.w	PATTED_CRSRX(a2),d0
	mulu	PATTED_NOTESIZE(a0),d0
	lea.l	(a3,d0.l),a3
	move.w	PATTED_CRSRY(a0),d0
	mulu	PATTED_LINESIZE(a0),d0
	lea.l	(a3,d0.l),a3

.outloop	move.l	PattedTxtBuf_PTR(PC),a1
	clr.b	(a1)
	move.b	#" ",NotePre_TXT
	move.l	TabulatorMem_PTR,a0
	tst.b	(a0,d2.w)
	beq.s	.notab
		move.b	#"T",NotePre_TXT
.notab	move.w	d2,d0
	jsr	ConvertToDecByte
	lea	DecByteSave,a0
	jsr	AddString
	move.w	PATTED_DISPNUMBTRACKS(a2),d5
	subq.w	#1,d5
	move.l	a3,a4

.noteloop	lea.l	NotePre_TXT(PC),a0
		jsr	AddString
		move.b	#" ",(a0)
		move.l	a4,a0
		jsr	ConvertNote
		lea.l	Note_TXT,a0
		cmpi.l	#10,NOTELEN
		beq.s	.wide
		cmpi.l	#CNOTE_EMPTYA,(a0)
		bne.s	.nosimple
		move.l	5(a0),(a0)
.nosimple	clr.b	4(a0)
.wide		jsr	AddString
		move.l	VEX_NoteSize,d0
		lea.l	(a4,d0.w),a4
	dbf	d5,.noteloop


	move.l	VEX_LineSize,d0
	lea.l	(a3,d0.l),a3
	move.w	d6,d1
	bsr	PEDDrawTxtLineFAST
	add.w	FONT_H,d6
	addq.w	#1,d2
	dbf	d7,.outloop

.exit2	move.l	PEDFASTCORR_RP,a1
	jsr	PatEdDrawCrsr

	bsr	NGRNrm0DrMd
	jsr	Set2OnlyPMask
	move.b	#3,WrMsk_BAK

.exit	RET

	acode
PEDDrawTxtLineFAST:
	puts	d0-d1/a0-a1
	move.l	PEDFASTCORR_RP,a1
	sub.w	PATTED_TEXTPIXOFFSET(a2),d1
	move.l	PattedTxtBuf_PTR(PC),a0
	move.w	PATTED_DISPX(a2),d0
	add.w	PEDFASTCORR_XY,d0
	add.w	PEDFASTCORR_XY+2,d1
	jsr	DrawTextXY
	gets	d0-d1/a0-a1
	rts

	acode
CalcPattedFAST
	BGN
	moveq	#0,d0
	moveq	#1,d1
	moveq	#PATTEDWIN_ID,d2
	bsr	CorrectXYScr2Win
	move.w	d0,PEDFASTCORR_XY
	move.w	d1,PEDFASTCORR_XY+2

	move.l	MainScreen_PTR,a0
	lea.l	84(a0),a0
	move.l	a0,PEDFASTCORR_RP
	RET

PEDFASTCORR_XY	dc.l	0
PEDFASTCORR_RP	dc.l	0
	ENDC

	acode
CorrectXYScr2Win	;I(D0W,D1W,D2W)(X,Y,WIN_ID)
	puts	d2-d3/a0

	exg	d0,d2
	move.w	d1,d3

;	moveq	#PATTEDWIN_ID,d0
;	jsr	GetIDWindow
	jsr	GetPEDWindow
	cmp.l	#0,a0
	beq.s	.exit

	add.w	4(a0),d2
	add.w	6(a0),d3
	add.w	WINDOW_TOP,d3			;H CORRECTION
;	add.w	FONT_H,d3
	subq.w	#1,d3
	addi.w	#4,d2
	move.w	d2,d0
	move.w	d3,d1
.exit	gets	d2-d3/a0
	rts

	acode
PEDDrawTxtLine:	;I(D1W)(Y)
	puts	d0-d1/a0-a1/a5
	move.w	PATTED_DISPX(a2),d0
	sub.w	PATTED_TEXTPIXOFFSET(a2),d1
	bsr	GetPEDRP
	move.l	PattedTxtBuf_PTR(PC),a0
	jsr	DrawTextXY
	gets	d0-d1/a0-a1/a5
	rts

	acode
PEDBuildTitle
	BGN
	move.w	PATTED_CRSRX(a2),d0
	addq.w	#1,d0
	move.l	PattedTxtBuf_PTR(PC),a1
	clr.b	(a1)
	lea.l	FillLINETITLE_TXT(PC),a0
	jsr	AddString
	lea.l	PlayTrackInfo,a3
	move.w	PATTED_DISPNUMBTRACKS(a2),d7
	subq.w	#1,d7
	bmi.s	.exit
.loop		jsr	ConvertToDecByte
		lea	DecByteSave,a0
		jsr	AddString
		lea.l	Fill5_TXT(PC),a0
		cmpi.l	#10,NOTELEN
		beq.s	.large

		move.w	#"  ",(a0)
		tst.b	-1(a3,d0.w)
		bne.s	.MUTE
		move.b	#"M",(a0)
.MUTE
		clr.b	2(a0)
		bra.s	.draw

.large		move.b	#" ",(a0)
		move.l	#"    ",1(a0)
		tst.b	-1(a3,d0.w)
		bne.s	.lMUTE
		move.b	#"*",(a0)
		move.l	#"M   ",1(a0)
.lMUTE

.draw		jsr	AddString
		move.b	#" ",2(a0)
		addq.w	#1,d0
	dbf	d7,.loop
	move.l	PattedTxtBuf_PTR(PC),a0
	moveq	#2,d0
	bsr	ClipString
.exit	RET


ClipString	;I(D0W,A0L)(NUMB OF CHARS,STRINGPTR)
	puts	a0
.loop	tst.b	(a0)+
	bne.s	.loop
	sub.w	d0,a0
	clr.b	(a0)
	gets	a0
	rts


	acode
ScaleInsideWin	;V1.0
		;I(D0W,D1W,D2W,D3W,A0L)(%X,%Y,%W,%H,WIN)
	move.l	d4,-(a7)
	cmp.l	#0,a0
	beq.s	.exit


	move.w	8(a0),d4
	
	mulu	d4,d0
	mulu	d4,d2

	move.w	10(a0),d4
	mulu	d4,d1
	mulu	d4,d3

	moveq	#100,d4		;PERCENT
	divu	d4,d0
	divu	d4,d1
	divu	d4,d2
	divu	d4,d3

.exit	move.l	d4,(a7)+
	rts

	acode
HiScaleInsideWin	;V1.1

		;I(D0W,D1W,D2W,D3W,A0L)(%X,%Y,%W,%H,WIN)	;% = 1/1000 !
	puts	d4-d7/a1
	cmp.l	#0,a0
	beq.s	.exit

	move.l	124(a0),a1	;LAYER

	move.w	20(a1),d4
	sub.w	16(a1),d4
	mulu	d4,d0
	mulu	d4,d2

	move.w	20+2(a1),d4
	sub.w	16+2(a1),d4
	sub.w	FONT_H,d4
	mulu	d4,d1
	mulu	d4,d3

	move.w	20(a1),d4
	sub.w	4(a0),d4
	add.w	d4,d0

	move.w	20+2(a1),d4
	sub.w	4+2(a0),d4
	add.w	d4,d1


	move.l	#1000,d4		;PERCENT
	divu	d4,d0
	divu	d4,d1
	divu	d4,d2
	divu	d4,d3

	add.w	FONT_H,d1


.exit	gets	d4-d7/a1
	rts


	IFEQ NEWSYSTEM
	acode
ScaleAreaInsideWin	;V1.1

		;I(A0L,A1L,A2L)(WIN,AREA,WINADR)		;% = 1/1000 !
	BGN
	cmp.l	#0,a0
	beq	.exit
	cmp.l	#0,a1
	beq	.exit
	cmp.l	#0,a2
	beq	.exit

	move.l	a2,a3
	move.w	AREA_DEFX(a1),d0
	move.w	AREA_DEFY(a1),d1
	move.w	AREA_DEFW(a1),d2
	move.w	AREA_DEFH(a1),d3
	move.l	a1,a2

	move.l	124(a0),a1	;LAYER

	move.w	20(a1),d4
	sub.w	16(a1),d4

	move.l	AUTOWIN_TXTW(a3),d5
;	move.w	AREA_DEFTXTW(a2),d5
	mulu	FONT_W,d5
	divu	#10,d5
	sub.w	d5,d4
	mulu	d4,d0
	mulu	d4,d2

	move.w	20+2(a1),d4
	sub.w	16+2(a1),d4
	sub.w	FONT_H,d4
;	sub.w	#4,d4
;	move.w	AREA_DEFTXTH(a2),d5
	move.l	AUTOWIN_TXTH(a3),d5
	mulu	FONT_H,d5
	sub.w	d5,d4
	mulu	d4,d1
	mulu	d4,d3

	move.w	20(a1),d4
	sub.w	4(a0),d4
	add.w	d4,d0

	move.w	20+2(a1),d4
	sub.w	4+2(a0),d4
	add.w	d4,d1


	move.l	#1000,d4		;PERCENT
	divu	d4,d0
	divu	d4,d1
	divu	d4,d2
	divu	d4,d3

	moveq	#0,d5
	move.w	AREA_DEFTXTW(a2),d5
	mulu	FONT_W,d5
	divu	#10,d5
	add.w	d5,d2

	move.w	AREA_DEFTXTH(a2),d5
	mulu	FONT_H,d5
	divu	#10,d5
	add.w	d5,d3

	move.w	AREA_DEFTXTX(a2),d5
	mulu	FONT_W,d5
	divu	#10,d5
	add.w	d5,d0

	move.w	AREA_DEFTXTY(a2),d5
	mulu	FONT_H,d5
	divu	#10,d5
	add.w	d5,d1

	move.w	d0,AREA_X(a2)
	move.w	d1,AREA_Y(a2)
	move.w	d2,AREA_W(a2)

	cmpi.w	#AREAHEIGHT_FONT,AREA_DEFH(a2)
	bne.s	.NoSpecialH
		move.w	FONT_H,d3
.NoSpecialH
	move.w	d3,AREA_H(a2)
.exit	RET
	ENDC


	acode
HiScaleInsideRect	;V1.0
			;RECT dc.w X,Y,W,H (DEST SYSTEM)		
			;I(D0W,D1W,D2W,D3W,A0L)(%X,%Y,%W,%H,RECT)	;% = 1/1000 !
			;O(D0L,D1L,D2L,D3L)(X,Y,W,H)
	puts	d4
	cmp.l	#0,a0
	beq.s	.exit


	move.w	4(a0),d4
;	sub.w	(a0),d4
	mulu	d4,d0
	mulu	d4,d2

	move.w	6(a0),d4
;	sub.w	2(a0),d4
	mulu	d4,d1
	mulu	d4,d3

	move.l	#1000,d4		;PERMILLE
	divu	d4,d0
	divu	d4,d1
	divu	d4,d2
	divu	d4,d3

	move.l	#$ffff,d4
	and.l	d4,d0
	and.l	d4,d1
	and.l	d4,d2
	and.l	d4,d3


;	add.w	(a0),d0
;	add.w	2(a0),d1

.exit	gets	d4
	rts


	acode
HiScalePixel	;V1.0
		;I(D0W,D1W,A0L)(%X,%Y,RECT)
		;O(D0L,D1L)(X,Y)
	puts	d4
	cmp.l	#0,a0
	beq.s	.exit

	move.w	4(a0),d4
	mulu	d4,d0
	move.w	6(a0),d4
	mulu	d4,d1
	move.l	#1000,d4
	divu	d4,d0
	divu	d4,d1
	move.l	#$ffff,d4
	and.l	d4,d0
	and.l	d4,d1
	add.w	(a0),d0
	add.w	2(a0),d1
.exit	gets	d4
	rts


	acode
TestInitPatterns	;V1.0
	BGN
	move.l	NoteMem_PTR,a0
	move.l	First_PATHEAD,a1
	move.l	VEX_PattNumb,d7
	subq.l	#1,d7
	moveq	#PATHEAD_SIZEOF,d6
	move.l	VEX_PatternSize,d5
.loop		clr.w	PATHEAD_LINECOUNT(a1)
		move.l	a0,PATHEAD_NOTEDATAPTR(a1)
		lea.l	(a0,d5.l),a0
		move.w	#PATHEADST_DORESET,PATHEAD_STATUS(a1)
		lea.l	(a1,d6.w),a1
	dbf	d7,.loop
	bsr	InitNoteMem
	RET

	acode
InitNoteMem	;V1.0
	BGN
	move.l	NoteMem_PTR,a1
	cmp.l	#0,a0
	beq.s	.exit
	move.l	VEX_PattNumb,d6
	subq.l	#1,d6
	moveq	#NOTE_SIZEOF,d5
	moveq	#0,d0

.loop		move.l	VEX_NotePerPattern,d7
		subq.l	#1,d7

.loop2			move.b	#NOTEPITCH_NONOTE,NOTE_PITCH(a1)
			move.b	d0,NOTE_INSTR(a1)
			move.b	d0,NOTE_VOLUME(a1)
			move.b	d0,NOTE_FX(a1)
			lea.l	(a1,d5.w),a1
		dbf	d7,.loop2
	dbf	d6,.loop
.exit	RET






;--- GUI UPDATE ---------------------------------------------------------

WaitGfxSync:
	puts	d0-d1/a0-a1/a6
	GFX WaitTOF(a6)
	gets	d0-d1/a0-a1/a6
	rts


	acode
AdjustActualPattEd:	;V1.0
	BGN
	bsr	GetPEDBody
	cmp.l	#0,a1
	beq.s	.exit

	bsr	PatEdCrsrOff

	bsr	GetActualPattEd
	bsr	GetPEDBody
	move.w	d0,PATTED_DISPX(a0)
	move.w	d1,PATTED_DISPY(a0)
	move.w	d2,PATTED_WEIDTH(a0)
	move.w	d3,PATTED_HEIGHT(a0)
	move.l  a1,PATTED_RP(a0)

	bsr	InitPatEdDisp
	bsr	PatEdDrawPattern
	bsr	PattEdDrawStatus
	jsr	DrawPattedTitle
	bsr	PatEdCrsrOn
.exit	RET




	;--- SYSTEM ---

	acode
DrawMVolume
	puts	d0-d2
	move.l	#"SY31",d0		;Master Balance
	moveq	#0,d2
	move.b	SYSVOL,d2
	bsr	NGODrawDecWord3Char
	gets	d0-d2
	rts

	acode
DrawMBalance
	puts	d0-d2
	move.l	#"SY35",d0		;Master Balance
	moveq	#0,d2
	move.b	SYSVOL+2,d2
	bsr	NGODrawDecWord3Char
	gets	d0-d2
	rts

	acode
DrawSystemSetup:
	puts	d0-d3/a0
	moveq	#0,d2
	move.l	VexQuality,d3		;Quality
	mulu.l	#28867,d2:d3		;Sampling Rate
	divu.l	#100,d2:d3

	lea.l	DecLongSave,a0
	move.l	d3,d0
	jsr		ConvertToDecLong
	lea.l	DecLongSave+4,a0
	move.l	#"SY39",d0			;Freq
	lea.l	DecLongSave+4,a0
	bsr		NGODrawText

	move.l	#"SY3D",d0			;Speed
	move.l	VexSpeed,d2
	mulu	#6,d2
	lsr.l	#2,d2
	bsr		NGODrawDecWord3Char

	move.l	#"SY31",d0			;Master Volume
	moveq	#0,d2
	move.b	SYSVOL,d2
	bsr		NGODrawDecWord3Char

	move.l	#"SY35",d0			;Master Balance
	moveq	#0,d2
	move.b	SYSVOL+2,d2
	bsr		NGODrawDecWord3Char

	jsr		ShowDSPPlugGui
	gets	d0-d3/a0
	rts




	;--- NOTE ED ---
	acode
DrawEventStatusQ:	;V1.0 NG
	BGN
	cmpi.b	#TRUE,MACROPROCESS
	beq.s	.exit
	cmpi.w	#TRUE,MOD_RELOAD
	beq.s	.exit

	IFEQ SMALLGUI
	cmpi.w	#TRUE,ModifyEventInfo+10
	beq.s	.exit
	ENDC

	move.l	#"EVED",d0
	move.l	#"EED1",d1
	jsr	NGFindArea
	cmp.l	#0,a0
	beq.s	.exit

	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit

	jsr	GetActualPattEd
	move.l	a0,a4
	bsr	CalcDispEdOffsets
	jsr	CalcActNoteData
	;jsr	GetActualNotePtr

	;--- Update Note ---
	move.l	PATTED_ACTNOTEDATA(a4),a0
	cmpi.l	#NOTE_FULLEMPTY,(a0)
	beq.s	.exit

	move.l	(a0),d0
	cmp.l	LastEvent,d0
	beq.s	.exit
		move.l	d0,LastEvent
		bsr	DrawNoteEvent
		jsr	UpdateActWave
.exit	RET

	acode
DrawEventStatus:	;V1.0 NG
	BGN
	cmpi.b	#TRUE,MACROPROCESS
	beq.s	.exit
	cmpi.w	#TRUE,MOD_RELOAD
	beq.s	.exit

	IFEQ SMALLGUI
	cmpi.w	#TRUE,ModifyEventInfo+10
	beq.s	.exit
	ENDC

	move.l	#"EVED",d0
	move.l	#"EED1",d1
	jsr	NGFindArea
	cmp.l	#0,a0
	beq.s	.exit

	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit
	jsr	GetActualPattEd
	move.l	a0,a4
	bsr	CalcDispEdOffsets
	jsr	CalcActNoteData

	;--- Update Note ---
	move.l	PATTED_ACTNOTEDATA(a4),a0
	move.l	(a0),d0
	cmp.l	LastEvent,d0
	beq.s	.exit
		move.l	d0,LastEvent
		bsr	DrawNoteEvent
.exit	RET
LastEvent	dc.l	0		;Speedup !!!

	;--- PATTERN ED ---
	acode
PattEdDrawStatus:	;V1.2
	BGN
	cmpi.b	#TRUE,MACROPROCESS
	beq.s	.exit
	cmpi.w	#TRUE,MOD_RELOAD
	beq.s	.exit
	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit

	jsr	GetActualPattEd
	move.l	a0,a4
	bsr	CalcDispEdOffsets
	jsr	CalcActNoteData

	;--- Update Note ---
	move.l	PATTED_ACTNOTEDATA(a4),a0
	;jsr	DrawNoteEvent



	moveq	#0,d2
	move.l	PATTED_ACTUALSONGDATA(a4),a3
	move.w	POSITION_PATNUM(a3),d2

	;--- Song Pattern Nr ---
	;move.l	#"SV10",d0
	;jsr	NGODrawDecWord3Char

	;--- PatternED Pattern Nr ---
	move.l	#"PE01",d0
	jsr	NGODrawDecWord4Char

	;--- Keyboard Offset ---
	move.l	#"PE13",d0
	move.w	KeyboardTune,d2
	jsr	NGODrawDecWord3Char
.exit	RET







;--- SEQUENCE EDIT ---


	IFEQ DEMO

	acode
SequenzUp:
	IFNE AMINETDEMO
	rts
	ENDC
	puts	a0
	lea.l	MoveNextSeq(PC),a0
	bsr	DecShiftRepeat
	jsr	WaitGfxSync
	jsr	DrawSequence
	gets	a0
	rts

	acode
SequenzDwn:
	IFNE AMINETDEMO
	rts
	ENDC
	BGN
	lea.l	MovePrevSeq(PC),a0
	bsr	DecShiftRepeat
	jsr	WaitGfxSync
	bsr	DrawSequence
	RET
	
	ENDC


	acode
MoveLastSeq
	IFNE AMINETDEMO
	rts
	ENDC
	BGN
	lea.l	Test_SONG,a1
	move.w	#Test_SeqNumb-2,d0
	move.w	d0,SONG_SEQNUM(a1)
	mulu	#SEQUENCE_SIZEOF,d0
	move.l	SONG_FIRSTSEQ(a1),a2
	lea.l	(a2,d0.w),a2
	move.l	a2,SONG_ACTUALSEQ(a1)
	jsr	DrawSongStatus
	RET

	acode
DupActSeq
	IFNE AMINETDEMO
	rts
	ENDC
	BGN
	lea.l	Test_SONG,a0
	move.w	SONG_SEQNUM(a0),d0
	move.l	SONG_ACTUALSEQ(a0),d1
	cmpi.w	#Test_SeqNumb-2,d0
	bhs.s	.exit

	addi.l	#SEQUENCE_SIZEOF,SeqPuffer_PTR

	bsr	MoveLastSeq

	moveq	#Test_SeqNumb-3,d7
	sub.w	d0,d7
	bmi.s	.exit

	move.b	#TRUE,MACROPROCESS

.loop		bsr	MovePrevSeq
		bsr	CopyActSeq
		bsr	MoveNextSeq
		bsr	PasteActSeq
		bsr	MovePrevSeq
	dbf	d7,.loop


	move.w	d0,SONG_SEQNUM(a0)
	move.l	d1,SONG_ACTUALSEQ(a0)

	bsr	CopyActSeq
	bsr	MoveNextSeq
	bsr	PasteActSeq

	move.b	#FALSE,MACROPROCESS
	subi.l	#SEQUENCE_SIZEOF,SeqPuffer_PTR
	jsr	DrawSequence
.exit	RET


	acode
DelActSeq
	BGN
	addi.l	#SEQUENCE_SIZEOF,SeqPuffer_PTR
	lea.l	Test_SONG,a0
	move.w	SONG_SEQNUM(a0),d0
	move.l	SONG_ACTUALSEQ(a0),d1
	moveq	#Test_SeqNumb-3,d7
	sub.w	d0,d7
	bmi.s	.exit
	move.b	#TRUE,MACROPROCESS
.loop		bsr	MoveNextSeq
		bsr	CopyActSeq
		bsr	MovePrevSeq
		bsr	PasteActSeq
		bsr	MoveNextSeq
	dbf	d7,.loop
	move.w	d0,SONG_SEQNUM(a0)
	move.l	d1,SONG_ACTUALSEQ(a0)
	move.b	#FALSE,MACROPROCESS
	subi.l	#SEQUENCE_SIZEOF,SeqPuffer_PTR
	jsr	DrawSequence
.exit	RET

	acode
CopyActSeq
	IFNE AMINETDEMO
	rts
	ENDC
	BGN
	lea.l	Test_SONG,a2
	move.l	SONG_ACTUALSEQ(a2),a0
	move.l	SeqPuffer_PTR(PC),a1
	bsr	CopySequence
	RET

	acode
PasteActSeq
	IFNE AMINETDEMO
	rts
	ENDC
	BGN
	lea.l	Test_SONG,a2
	move.l	SONG_ACTUALSEQ(a2),a1
	move.l	SeqPuffer_PTR(PC),a0
	bsr	CopySequence
	jsr	DrawSongStatus
	RET

	acode
CutActSeq
	IFNE AMINETDEMO
	rts
	ENDC
	bsr	CopyActSeq
	bsr	DelActSeq
	jsr	DrawSongStatus
	rts

	acode
ClearActSeq
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a0

	clr.w	SEQUENCE_STARTPOS(a0)
	move.w	#1,SEQUENCE_LENGTH(a0)
	move.w	#1,SEQUENCE_LOOP(a0)
	move.w	#SEQINFO_PLAY,SEQUENCE_INFO(a0)
	clr.w	SEQUENCE_TUNE(a0)
	jsr	DrawSongStatus
	RET

SeqPuffer_PTR	dc.l	0,SEQUENCE_SIZEOF*3,FASTMEM

	acode
CopySequence	;V1.0
		;I(A0L,A1L)(SRC,DEST)
	puts	d0
	moveq	#SEQUENCE_SIZEOF,d0
	jsr	CopyMemory
	gets	d0
	rts



	acode
SelectSequenceType
	BGN
	move.l	#"SE2A",d0
	jsr	NGFindGadID
	cmp.l	#0,a0
	beq.s	.exit

	move.l	NGGAD_VALUE(a0),d7
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a2
	moveq	#SEQINFO_PLAY,d0
	IFNE AMINETDEMO
	bra.s	.ok
	ENDC
	tst.w	d7
	beq.s	.ok
	moveq	#SEQINFO_SKIP,d0
	subq.w	#1,d7
	beq.s	.ok	
	moveq	#SEQINFO_ENDSONG,d0
.ok	move.w	d0,SEQUENCE_INFO(a2)

	move.l	ActualNGWWIN_ID,d0
	lea.l	NGWin_Info,a6
	move.l	NGWI_ActiveWindowAdr(a6),a5
	jsr	PreClipWIN
	jsr	NGWDrawWindowID
	jsr	NGDrawGadsWindowID
	jsr	DrawPositionCacheReset
	jsr	DrawSongAll
	jsr	PostClipWIN

.exit	RET





	acode
SequenzSkip
	IFEQ AMINETDEMO
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a0
	move.w	#SEQINFO_SKIP,SEQUENCE_INFO(a0)
	bsr	DrawSequenceType
	RET
	ENDC

	acode
SequenzPlay
	IFEQ AMINETDEMO
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a0
	move.w	#SEQINFO_PLAY,SEQUENCE_INFO(a0)
	bsr	DrawSequenceType
	RET
	ENDC

	acode
SequenzLast
	IFEQ AMINETDEMO
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a0
	move.w	#SEQINFO_ENDSONG,SEQUENCE_INFO(a0)
	bsr	DrawSequenceType
	RET
	ENDC
	rts

	acode
ActSeqStartUp
	BGN

	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a0
	move.w	SEQUENCE_STARTPOS(a0),d2
	jsr	SetDecShiftKeyRaster
	
	add.w	d0,d2
	move.w	d2,d3
	add.w	SEQUENCE_LENGTH(a0),d2

	cmpi.w	#Test_PosNumb,d2
	bhi.s	.exit
	move.w	d3,SEQUENCE_STARTPOS(a0)

	move.w	d3,d2
	move.l	#"SV05",d0
	bsr	WaitGfxSync
	bsr	NGODrawDecWord3Char
.exit	RET

	acode
ActSeqStartDown
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a0
	jsr	SetDecShiftKeyRaster
	sub.w	d0,SEQUENCE_STARTPOS(a0)
	bpl.s	.exit
	clr.w	SEQUENCE_STARTPOS(a0)
.exit	
	move.w	SEQUENCE_STARTPOS(a0),d2
	move.l	#"SV05",d0
	bsr	WaitGfxSync
	bsr	NGODrawDecWord3Char
	RET

	acode
ActSeqLenUp
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a0

	jsr	SetDecShiftKeyRaster
	move.w	SEQUENCE_LENGTH(a0),d2
	add.w	d0,d2
	move.w	d2,d3

	add.w	SEQUENCE_STARTPOS(a0),d3
	cmpi.w	#Test_PosNumb,d3
	bhi.s	.exit

	move.w	d2,SEQUENCE_LENGTH(a0)
	move.l	#"SV07",d0
	bsr	WaitGfxSync
	bsr	NGODrawDecWord3Char
.exit	RET

	acode
ActSeqLenDown
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a0
	jsr	SetDecShiftKeyRaster
	sub.w	d0,SEQUENCE_LENGTH(a0)
	cmpi.w	#1,SEQUENCE_LENGTH(a0)
	bgt.s	.exit
	move.w	#1,SEQUENCE_LENGTH(a0)
.exit	
	move.w	SEQUENCE_LENGTH(a0),d2
	move.l	#"SV07",d0
	bsr	WaitGfxSync
	bsr	NGODrawDecWord3Char
	RET
	ENDC

	acode
ActSeqLoopDown
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a0
	jsr	SetDecShiftKeyRaster
	sub.w	d0,SEQUENCE_LOOP(a0)
	cmpi.w	#1,SEQUENCE_LOOP(a0)
	bgt.s	.exit
	move.w	#1,SEQUENCE_LOOP(a0)
.exit	
	move.w	SEQUENCE_LOOP(a0),d2
	move.l	#"SV08",d0
	bsr	WaitGfxSync
	bsr	NGODrawDecWord3Char
	RET
	ENDC

	acode
ActSeqLoopUp
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a0
	jsr	SetDecShiftKeyRaster
	add.w	d0,SEQUENCE_LOOP(a0)
	move.w	SEQUENCE_LOOP(a0),d2
	move.l	#"SV08",d0
	bsr	WaitGfxSync
	bsr	NGODrawDecWord3Char
	RET
	ENDC

	acode
ActSeqTuneUp
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a0
	jsr	SetOctaveKeyRaster
	add.w	d0,SEQUENCE_TUNE(a0)
	move.w	SEQUENCE_TUNE(a0),d2
	move.l	#"SV06",d0
	bsr	WaitGfxSync
	bsr	NGODrawSignByte3Char
	RET
	ENDC

	acode
ActSeqTuneDwn
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_SONG,a1
	move.l	SONG_ACTUALSEQ(a1),a0
	jsr	SetOctaveKeyRaster
	sub.w	d0,SEQUENCE_TUNE(a0)
	move.w	SEQUENCE_TUNE(a0),d2
	move.l	#"SV06",d0
	bsr	WaitGfxSync
	bsr	NGODrawSignByte3Char
	RET
	ENDC



;--- SEQUENCE ACTION ---




	acode
MovePrevSeq
	IFEQ AMINETDEMO
	puts	a0
	lea.l	Test_SONG,a0
	tst.w	SONG_SEQNUM(a0)
	beq.s	.exit
		subq.w	#1,SONG_SEQNUM(a0)
		subi.l	#SEQUENCE_SIZEOF,SONG_ACTUALSEQ(a0)
		;jsr	DrawSequence
.exit	gets	a0
	ENDC
	rts

	acode
MoveNextSeq
	IFEQ AMINETDEMO
	puts	d0/a0
	lea.l	Test_SONG,a0
	move.w	SONG_SEQNUM(a0),d0
	addq.w	#1,d0
	cmpi.w	#Test_SeqNumb-1,d0
	bhs.s	.exit
		move.w	d0,SONG_SEQNUM(a0)
		addi.l	#SEQUENCE_SIZEOF,SONG_ACTUALSEQ(a0)
		;jsr	DrawSongStatus
.exit	gets	d0/a0
	ENDC
	rts



	acode
MoveFirstPlayedSeq
	puts	a0-a1
	bsr	MoveFirstSeq
	lea.l	Test_SONG,a0
	move.l	SONG_ACTUALSEQ(a0),a1
	lea.l	-SEQUENCE_SIZEOF(a1),a1
	move.w	#-1,SONG_SEQNUM(a0)

MovePSeq_L
		lea.l	SEQUENCE_SIZEOF(a1),a1
		addq.w	#1,SONG_SEQNUM(a0)
		cmpi.w	#SEQINFO_PLAY,SEQUENCE_INFO(a1)
	bne.s	MovePSeq_L
	tst.w	SEQUENCE_LOOP(a1)
	beq.s	MovePSeq_L

	move.l	a1,SONG_ACTUALSEQ(a0)
	move.w	SEQUENCE_LOOP(a1),SONG_SEQCOUNTER(a0)
	gets	a0-a1
	rts

	acode
ResetSequenz
	puts	a1
	move.l	SONG_ACTUALSEQ(a0),a1
	move.w	SEQUENCE_LOOP(a1),SONG_SEQCOUNTER(a0)
	gets	a1
	rts

	acode
MoveFirstSeq
	puts	a0-a1
	lea.l	Test_SONG,a0
	move.l	SONG_FIRSTSEQ(a0),SONG_ACTUALSEQ(a0)
	clr.w	SONG_SEQNUM(a0)
	gets	a0-a1
	rts

	acode
InitSequences	;V1.0
	BGN
	lea.l	Test_SONG,a0
	move.l	SequenceMem_PTR,a1

	move.l	a1,SONG_FIRSTSEQ(a0)
	move.l	a1,SONG_ACTUALSEQ(a0)
	clr.w	SONG_SEQNUM(a0)
	
	move.l	a1,a0

	clr.w	SEQUENCE_STARTPOS(a0)
	move.w	#1,SEQUENCE_LENGTH(a0)
	move.w	#1,SEQUENCE_LOOP(a0)
	move.w	#SEQINFO_PLAY,SEQUENCE_INFO(a0)
	clr.w	SEQUENCE_TUNE(a0)
	move.w	#SEQINFO_ENDSONG,SEQUENCE_INFO+SEQUENCE_SIZEOF(a0)

	RET



	acode
InitSongDatas	;V2.0
	BGN
	move.l	TestSongData_PTR,a0
	move.l	#Test_PosNumb-1,d7
	moveq	#POSITION_SIZEOF,d6

InitSongDatas_L
		bsr	InitSongData
		lea.l	(a0,d6.w),a0
	dbf	d7,InitSongDatas_L
	RET

	acode
InitSongData	;V2.0
		;I(A0L)(SONGDATA)
	BGN
	move.w	#1,POSITION_LOOPNUMB(a0)
	clr.w	POSITION_LOOPCOUNT(a0)
	clr.w	POSITION_PATNUM(a0)
	clr.w	POSITION_STARTPOINT(a0)
	move.l	VEX_LinesPerPattern,d1
	move.w	d1,POSITION_LEN(a0)
	move.w	#Test_SongSpeed,POSITION_SPEED(a0)
	jsr	SetPatHeadPTR
	RET



	;--- SONG ---

DrawSongStatus:	;V1.0
	BGN
	cmpi.b	#TRUE,MACROPROCESS
	beq	.exit
	cmpi.w	#TRUE,MOD_RELOAD
	beq	.exit
	bsr	DrawPosition
	bsr	DrawSequence
	bsr	DrawSongStruct
.exit	RET



DrawSongStruct:
	puts	d0-d2
	move.l	VEX_LinesPerPattern,d2
	move.l	#"SV01",d0
	jsr	NGODrawDecWord4Char

	move.l	VEX_PattNumb,d2
	move.l	#"SV02",d0
	jsr	NGODrawDecWord4Char
	gets	d0-d2
	rts

	;--- POSITION ---


	acode
DrawPositionCacheReset:	;V1.0
	BGN
	moveq	#-1,d0
	lea.l	PosCache,a0
	moveq	#15-1,d1
.loop	move.w	d0,(a0)+
	dbf	d1,.loop
	RET

	acode
DrawPosition:
	BGN
	cmpi.b	#TRUE,MACROPROCESS
	beq	.exit
	cmpi.w	#TRUE,MOD_RELOAD
	beq	.exit




	jsr	GetActualPattEd
	cmp.l	#0,a0
	beq	.exit



	;--- POSITION ---
	move.l	a0,a4
	bsr	CalcDispEdOffsets
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a4),a0
	;--- POSITION ---

	move.w	PATTED_ACTPOSNUM(a4),d2
	move.l	#"SV09",d0
	cmp.w	PosCache,d2
	beq.s	.fast1
	move.w	d2,PosCache
	jsr	NGODrawDecWord3Char
.fast1
	move.l	PATTED_ACTUALSONGDATA(a4),a3
	move.w	POSITION_PATNUM(a3),d2
	move.l	#"SV10",d0
	cmp.w	PosCache+2,d2
	beq.s	.fast2
	move.w	d2,PosCache+2
	jsr	NGODrawDecWord3Char
.fast2

	move.w	POSITION_STARTPOINT(a3),d2
	move.l	#"SV11",d0
	cmp.w	PosCache+4,d2
	beq.s	.fast3
	move.w	d2,PosCache+4
	jsr	NGODrawDecWord3Char
.fast3

	move.w	POSITION_TUNE(a3),d2
	move.l	#"SV12",d0
	cmp.w	PosCache+6,d2
	beq.s	.fast4
	move.w	d2,PosCache+6
	jsr	NGODrawSignByte3Char
.fast4

	move.w	POSITION_LEN(a3),d2
	move.l	#"SV13",d0
	cmp.w	PosCache+8,d2
	beq.s	.fast5
	move.w	d2,PosCache+8
	jsr	NGODrawDecWord3Char
.fast5

	move.w	POSITION_LOOPNUMB(a3),d2
	move.l	#"SV14",d0
	cmp.w	PosCache+10,d2
	beq.s	.fast6
	move.w	d2,PosCache+10
	jsr	NGODrawDecWord3Char
.fast6

	move.w	POSITION_SPEED(a3),d2
	move.l	#"SV15",d0
	cmp.w	PosCache+12,d2
	beq.s	.fast7
	move.w	d2,PosCache+12
	jsr	NGODrawDecWord3Char
.fast7

.exit	RET


	;--- SEQUENCE ---

DrawSequence:	;V1.0
	BGN
	cmpi.b	#TRUE,MACROPROCESS
	beq	.exit
	cmpi.w	#TRUE,MOD_RELOAD
	beq	.exit

	;jsr	GetActualPattEd
	;cmp.l	#0,a0
	;beq	.exit
	;move.l	a0,a4
	;bsr	CalcDispEdOffsets
	;jsr	CalcActNoteData
	;move.l	PATTED_ACTNOTEDATA(a4),a0

	;--- SEQUENCE ---
	lea.l	Test_SONG,a3
	move.l	SONG_ACTUALSEQ(a3),a3

	move.w	Test_SONG+SONG_SEQNUM,d2
	move.l	#"SV03",d0
	addq.w	#1,d2
	jsr	NGODrawDecWord3Char

	move.w	SEQUENCE_STARTPOS(a3),d2
	move.l	#"SV05",d0
	jsr	NGODrawDecWord3Char

	move.w	SEQUENCE_TUNE(a3),d2
	move.l	#"SV06",d0
	jsr	NGODrawSignByte3Char

	move.w	SEQUENCE_LENGTH(a3),d2
	move.l	#"SV07",d0
	jsr	NGODrawDecWord3Char

	move.w	SEQUENCE_LOOP(a3),d2
	move.l	#"SV08",d0
	jsr	NGODrawDecWord3Char

	bsr	DrawSequenceType
.exit	RET


	;--- INSTRUMENT ---
DrawInstrumentReset:	;V1.0
	BGN
	moveq	#-1,d0
	lea.l	InstrumentCache,a0
	moveq	#20-1,d1
.loop	move.w	d0,(a0)+
	dbf	d1,.loop
	RET

	acode
DrawInstrument:	;v1.0
	IFNE SMALLGUI
	puts	d0-a6
	jsr	GetActualInstrNum		;Instrument Nr
	move.w	d0,d2
	move.l	#"WV01",d0
	cmp.w	InstrumentCache,d2
	beq.s	.fast
	move.w	d2,InstrumentCache
	jsr	NGODrawDecWord3Char
.fast	gets	d0-a6
	ENDC

	bsr	DrawInstrName
	jsr	DrawActualWave

	rts

	acode
DrawInstrName:	;V1.0
	BGN

	jsr	GetActualInstrument
	move.l	a0,a5
	jsr	GetActualInstrName
	move.l	a0,a4
	move.l	InstrName_PTR,a1
	clr.b	(a1)

	btst	#SPLAYFLAG_SUPERFAST,SAMPLENAME_PLAYFLAG(a4)
	beq.s	.NoFastPlay

		lea.l	InstrNoFASTPLAY_TXT,a0
		jsr	AddString

.NoFastPlay

	btst	#SPLAYFLAG_NODSP,SAMPLENAME_PLAYFLAG(a4)
	beq.s	.nodsp

	btst	#SPLAYFLAG_DODETUNE,SAMPLENAME_PLAYFLAG(a4)
	beq.s	.NoPosTune

		lea.l	InstrNoDSPPOS_TXT,a0
		jsr	AddString
		bra.s	.DNoPosTune

.NoPosTune
		lea.l	InstrNoDSP_TXT,a0
		jsr	AddString
		bra.s	.DNoPosTune

.nodsp	btst	#SPLAYFLAG_DODETUNE,SAMPLENAME_PLAYFLAG(a4)
	beq.s	.DNoPosTune
		lea.l	InstrNoTune_TXT,a0
		jsr	AddString
.DNoPosTune

	cmpi.w	#INSTRTYPE_KILL,INSTR_TYPE(a5)
	bne.s	.DNotkill
		lea.l	InstrKilled_TXT,a0
		move.l	InstrName_PTR,a1
		jsr	AddString
		bra	DrawInstrNameShow
.DNotkill

	cmpi.w	#INSTRTYPE_SILENT,INSTR_TYPE(a5)
	bne.s	DrawInstrParam_NotSilent
		lea.l	InstrSilent_TXT,a0
		jsr	AddString
DrawInstrParam_NotSilent

	lea.l	InstrNo_TXT,a0
	cmpi.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a4)
	beq.s	DrawInstrName_Type
	lea.l	InstrLooped_TXT,a0
	cmpi.b	#INSTRTYPE_LOOP,SAMPLENAME_INSTRTYPE(a4)
	beq.s	DrawInstrName_Type
	lea.l	InstrSustained_TXT,a0

DrawInstrName_Type
	jsr	AddString



	cmpi.b	#MULTISAMPLE_LINESRC,SAMPLENAME_MULTI(a4)
	bne.s	DrawI_NoVirt

		jsr	BuildLineTxt

		lea.l	LineSampleDef_Txt,a0
		jsr	AddString

		bra.s	DrawI_NoR

DrawI_NoVirt
	cmpi.b	#MULTISAMPLE_STEREOL,SAMPLENAME_MULTI(a4)
	bne.s	DrawI_NoL
		lea.l	InstrLeft_TXT,a0
		jsr	AddString
		bra.s	DrawI_NoR
DrawI_NoL
	cmpi.b	#MULTISAMPLE_STEREOR,SAMPLENAME_MULTI(a4)
	bne.s	DrawI_NoR
		lea.l	InstrRight_TXT,a0
		jsr	AddString
DrawI_NoR

	move.l	a4,a0
	jsr	AddString

DrawInstrNameShow	
	move.l  InstrName_PTR,a1
	move.l	#"WINS",d0
	jsr	NGWindowCheck
	cmp.l	#0,a0
	beq.s	.exit
	move.l	NGWIN_WPTR(a0),a0
	move.l	#-1,a2
	CALLINT	SetWindowTitles(a6)
	bsr	DrawInstrParam
.exit	RET

	acode
DrawInstrParam:	;V1.0	NG
	BGN
	jsr	GetActualInstrument
	move.l	a0,a5
	jsr	GetActualInstrName
	move.l	a0,a4


	move.l	#"WV1D",d0			;Filter
	moveq	#0,d2
	move.b	SAMPLENAME_FILTER(a4),d2
	cmp.w	InstrumentCache+2,d2
	beq.s	.fast1
	move.w	d2,InstrumentCache+2
	jsr	NGODrawSignByte3Char
.fast1

	move.b	SAMPLENAME_DOWNSAMPLE(a4),d2	;Downsample
	move.l	#"WV1A",d0
	cmp.w	InstrumentCache+4,d2
	beq.s	.fast2
	move.w	d2,InstrumentCache+4
	jsr	NGODrawDecWord3Char
.fast2

	move.l	#"WV21",d0
	move.b	SAMPLENAME_FINETUNE(a4),d2	;FineTune
	cmp.w	InstrumentCache+6,d2
	beq.s	.fast3
	move.w	d2,InstrumentCache+6
	jsr	NGODrawSignByte3Char
.fast3

	move.l	#"WV24",d0
	move.b	SAMPLENAME_TUNE(a4),d2		;Tune
	cmp.w	InstrumentCache+8,d2
	beq.s	.fast4
	move.w	d2,InstrumentCache+8
	jsr	NGODrawSignByte3Char
.fast4

	move.l	#"WV2F",d0
	move.b	SAMPLENAME_LOOPNUMB(a4),d2	;Loop Number
	cmp.w	InstrumentCache+10,d2
	beq.s	.fast5
	move.w	d2,InstrumentCache+10
	jsr	NGODrawDecWord3Char
.fast5

	move.l	#"WV07",d0
	move.b	SAMPLENAME_VOLUME(a4),d2	;Instrument Volume
	cmp.w	InstrumentCache+12,d2
	beq.s	.fast6
	move.w	d2,InstrumentCache+12
	jsr	NGODrawDecWord3Char
.fast6
	jsr	GetActualInstrNum		;Instrument Nr
	move.w	d0,d2
	move.l	#"WV01",d0
	cmp.w	InstrumentCache,d2
	beq.s	.fast7
	move.w	d2,InstrumentCache
	jsr	NGODrawDecWord3Char
.fast7



	moveq	#FALSE,d1
	btst	#SPLAYFLAG_NODSP,SAMPLENAME_PLAYFLAG(a4)	
	beq.s	.nodsp
	moveq	#TRUE,d1
.nodsp	move.l	#"WV0D",d0
	cmp.w	InstrumentCache+14,d1
	beq.s	.fast8
	move.w	d1,InstrumentCache+14
	jsr	NGSetGadBool
.fast8
	moveq	#FALSE,d1
	btst	#SPLAYFLAG_DODETUNE,SAMPLENAME_PLAYFLAG(a4)
	beq.s	.notune
	moveq	#TRUE,d1
.notune	move.l	#"WV0E",d0
	cmp.w	InstrumentCache+16,d1
	beq.s	.fast9
	move.w	d1,InstrumentCache+16
	jsr	NGSetGadBool
.fast9
	moveq	#FALSE,d1
	btst	#SPLAYFLAG_SUPERFAST,SAMPLENAME_PLAYFLAG(a4)
	beq.s	.nofast
	moveq	#TRUE,d1
.nofast	move.l	#"WV0C",d0
	cmp.w	InstrumentCache+18,d1
	beq.s	.fast10
	move.w	d1,InstrumentCache+18
	jsr	NGSetGadBool
.fast10

	moveq	#FALSE,d1
	cmpi.w	#INSTRTYPE_SILENT,INSTR_TYPE(a5)
	bne.s	.nomute
	moveq	#TRUE,d1
.nomute	move.l	#"WV0F",d0
	;cmp.w	InstrumentCache+20,d1
	;beq.s	.fast11
	;move.w	d1,InstrumentCache+20
	jsr	NGSetGadBool
.fast11

	jsr	DrawLoopType
.exit	RET


;--- SYSTEM DSP ACTION ---


	acode
EchoLenDown
	BGN
	move.l	DSP_ECHO_LEN,d1
	jsr	SetDecShiftKeyRaster
	sub.l	d0,d1
	cmpi.l	#1,d1
	bge.s	.exit
		moveq	#1,d1
.exit	move.l	d1,DSP_ECHO_LEN
	jsr	InitCalcBufferInfo

	move.l	#"SY52",d0		;Echo Len
	move.l	DSP_ECHO_LEN,d2
	bsr	NGODrawDecWord3Char
	RET

	acode
EchoLenUp
	BGN
	move.l	DSP_ECHO_LEN,d1
	jsr	SetDecShiftKeyRaster
	add.l	d0,d1
	cmp.l	MAXDSP_ECHO_LEN,d1
	bls.s	.OK
		jsr	WarnFlash
		move.l	MAXDSP_ECHO_LEN,d1
.OK
	move.l	d1,DSP_ECHO_LEN
	jsr	InitCalcBufferInfo
	move.l	#"SY52",d0		;Echo Len
	move.l	DSP_ECHO_LEN,d2
	bsr	NGODrawDecWord3Char
	RET

	acode
EchoLvlD
	puts	d2
	move.l	DSP_ECHO_LVL,d2
	subq.l	#1,d2
	bpl.s	.ok
	moveq	#0,d2
.ok	move.l	d2,DSP_ECHO_LVL
	bsr	DrawDspEchoLvl
	gets	d2
	rts

DSPECHO_LVL_MAX	EQU	127

	acode
EchoLvlU
	puts	d2
	move.l	DSP_ECHO_LVL,d2
	addq.l	#1,d2
	cmpi.l	#DSPECHO_LVL_MAX,d2
	bls.s	.ok
	moveq	#DSPECHO_LVL_MAX,d2
.ok	move.l	d2,DSP_ECHO_LVL
	bsr	DrawDspEchoLvl
	gets	d2
	rts

	acode
DelayD	puts	d0-d2
	subq.w	#1,DELAYINFO
	bpl.s	.ok
	clr.w	DELAYINFO
.ok	jsr	ValidateDelay
	move.l	#"SY62",d0		;Delay Len
	moveq	#0,d2
	move.w	DELAYINFO,d2
	bsr	NGODrawDecWord3Char
	gets	d0-d2
	rts

	acode
DelayU	puts	d0-d2
	addq.w	#1,DELAYINFO
	jsr	ValidateDelay
	move.l	#"SY62",d0		;Delay Len
	moveq	#0,d2
	move.w	DELAYINFO,d2
	bsr	NGODrawDecWord3Char
	gets	d0-d2
	rts

	acode
DelayD2	subq.w	#1,DELAYINFO+2
	bpl.s	.ok
	clr.w	DELAYINFO+2
.ok	jsr	ValidateDelay
	bsr	DrawDspDelayLvl	
	rts

	acode
DelayU2	addq.w	#1,DELAYINFO+2
	jsr	ValidateDelay
	bsr	DrawDspDelayLvl
	rts

	acode
HallD	puts	d0-d2
	subq.w	#1,HallInfo
	bpl.s	.ok
	clr.w	HallInfo
.ok	jsr	ValidateHall
	jsr	InitPostDspBufferInfo
	move.l	#"SY72",d0		;Echo Len
	moveq	#0,d2
	move.w	HallInfo,d2
	bsr	NGODrawDecWord3Char
	gets	d0-d2
	rts

	acode
HallU	puts	d0-d2
	addq.w	#1,HallInfo
	jsr	ValidateHall
	jsr	InitPostDspBufferInfo
	move.l	#"SY72",d0		;Echo Len
	moveq	#0,d2
	move.w	HallInfo,d2
	bsr	NGODrawDecWord3Char
	gets	d0-d2
	rts
	acode
HallD2
	subq.w	#1,HallInfo+2
	bpl.s	.ok
	clr.w	HallInfo+2
.ok	jsr	ValidateHall
	bsr	DrawDspHallLvl
	rts

	acode
HallU2
	addq.w	#1,HallInfo+2
	jsr	ValidateHall
	bsr	DrawDspHallLvl
	rts



;--- GUI OBJECT ACTION ---

NGACTION_DRAW		EQU	0
NGACTION_MOUSEON	EQU	$3
NGACTION_MOUSEMOVE	EQU	$4
NGACTION_MOUSEOFF	EQU	$5
NGACTION_ANIMATE	EQU	$6
NGACTION_GETSIZE	EQU	$1
NGACTION_GETBODYSIZE	EQU	$2


NGWIN_WPTR		EQU	0	;0=OFF
NGWIN_UP		EQU	4
NGWIN_RP		EQU	8
NGWIN_APEN		EQU	12
NGWIN_BPEN		EQU	16
NGWIN_DRMD		EQU	20
NGWIN_TITLE		EQU	32
NGWIN_MINI		EQU	NGWIN_TITLE+4		;BYTE: TRUE=MINImized
NGWIN_OLDXYWH		EQU	NGWIN_MINI+4		;WORD
NGWIN_OLDFLAGS		EQU	NGWIN_OLDXYWH+8
NGWIN_MOUSECLICK	EQU	NGWIN_OLDFLAGS+4	;BYTE: TRUE=MOUSEPRESSED
NGWIN_MOUSECLICK_XY	EQU	NGWIN_MOUSECLICK+4	;MOUSEXY(CLICKED)
NGWIN_MOUSE_XY		EQU	NGWIN_MOUSECLICK+8	;2xWORD, ACTUAL POS
NGWIN_ACTIVE		EQU	NGWIN_MOUSE_XY+4	;BYTE: TRUE=IS SELECTED WINDOW
NGWIN_NUMB		EQU	NGWIN_ACTIVE+4
NGWIN_ID		EQU	NGWIN_NUMB+4
NGWIN_SIGMASK		EQU	NGWIN_ID+4
NGWIN_AREADEF		EQU	NGWIN_SIGMASK+4
NGWIN_AREANUMB		EQU	NGWIN_AREADEF+4		;WORD ANZAHL AREAS

;--- START AREA SECTION ---
NGWIN_AREA		EQU	NGWIN_AREANUMB+4	;LONG FIRST AREA

NGWIN_SIZEOF		EQU	NGWIN_AREA+(NGArea_SIZEOF*6)

NGWTAGS_STARTX	EQU	10
NGWTAGS_STARTY	EQU	20
	

;--- NEW WINDOW SYSTEM : WINDOW DATA ----------------------------------

	;;;WINDOW_IDCMP	EQU	IDCMP_CLOSEWINDOW+$40+IDCMP_RAWKEY+IDCMP_MOUSEBUTTONS+IDCMP_MENUPICK+IDCMP_ACTIVEWINDOW+IDCMP_NEWSIZE ;+IDCMP_CHANGEWINDOW

	IFNE	DIRECTAMIGAAUDIO
WINDOW_IDCMP	EQU	IDCMP_CLOSEWINDOW+IDCMP_RAWKEY+IDCMP_MOUSEBUTTONS+IDCMP_MENUPICK+IDCMP_ACTIVEWINDOW+IDCMP_NEWSIZE ;+IDCMP_CHANGEWINDOW
	ELSE
WINDOW_IDCMP	EQU	IDCMP_CLOSEWINDOW+IDCMP_RAWKEY+IDCMP_MOUSEBUTTONS+IDCMP_MENUPICK+IDCMP_ACTIVEWINDOW+IDCMP_NEWSIZE+IDCMP_INTUITICKS ;+IDCMP_CHANGEWINDOW
	ENDC




NGWin_TAGS		dc.l	WA_CustomScreen,0

NGWINT_X		dc.l	WA_Left,NGWTAGS_STARTX
NGWINT_Y		dc.l	WA_Top,NGWTAGS_STARTY

NGWINT_W		dc.l	WA_Width,NGWINDOW_STDW
NGWINT_H		dc.l	WA_Height,NGWINDOW_STDH

NGWIN_TITLEADR		dc.l	WA_Title,NGWTitle_TXT

NGWIN_MINW		dc.l	WA_MinWidth,48
NGDWIN_MINH		dc.l	WA_MinHeight,20
NGWIN_MAXW		dc.l	WA_MaxWidth,-1
NGWIN_MAXH		dc.l	WA_MaxHeight,-1


			;dc.l	WA_Borderless,TRUE

			dc.l	WA_IDCMP,WINDOW_IDCMP
			dc.l	WA_GimmeZeroZero,TRUE
			;dc.l	WA_NoCareRefresh,TRUE
			;dc.l	WA_SmartRefresh,TRUE

			dc.l	WA_NewLookMenus,TRUE
			dc.l	WA_SizeGadget,TRUE
			dc.l	WA_DepthGadget,TRUE
			dc.l	WA_DragBar,TRUE
			dc.l	WA_CloseGadget,TRUE
			dc.l	WA_AutoAdjust,TRUE

			;dc.l	WA_Zoom,ZoomArray	;PTR to 4xWORD
			;dc.l	WA_Activate,TRUE

AutoWin_SCRTITLE	dc.l	WA_ScreenTitle,0

			dc.l	TAG_DONE


;--- NG WINDOWS END -------------------------------------------------


NGjmp	macro
	dc.l	\1-"AQ07",\2+733
	;dc.l	"" \1 "",\2
	endm


	acode
NGGadDoAction	;I(D0L,GADID)
	BGN
	lea.l	NGGadActionList,a6
	
.loop	move.l	(a6),d7
	beq.s	.exit

	addi.l	#"AQ07",d7

	lea.l	8(a6),a6
	cmp.l	d0,d7
	bne.s	.loop

	bsr	.NGRecordGadMsg

	move.l	-4(a6),a6
	sub.l	#733,a6
	jsr	(a6)
.exit	RET

	acode
.NGRecordGadMsg	;V1.0
	BGN
	move.l	-8(a6),d0
	addi.l	#"AQ07",d0

	moveq	#0,d1
	moveq	#NGRECMSGTYPE_GAD,d2
	cmpi.l	#"PE1I",d0
	beq.s	.exit2
	cmpi.l	#"PE1J",d0
	beq.s	.exit2
	cmpi.l	#"PE1K",d0
	beq.s	.exit2
	cmpi.l	#"PE1L",d0
	beq.s	.exit2
	cmpi.l	#"PE1M",d0
	beq.s	.exit2

	jsr	RecordMsg
.exit2	RET

	acode
NGRecordXXMsg	;V1.0
	BGN
	move.l	XXMsg,d0
	tst.l	d0
	beq.s	.exit
	moveq	#0,d1
	moveq	#NGRECMSGTYPE_GAD,d2
	cmpi.l	#"PE1I",d0
	beq.s	.exit
	cmpi.l	#"PE1J",d0
	beq.s	.exit
	cmpi.l	#"PE1K",d0
	beq.s	.exit
	cmpi.l	#"PE1L",d0
	beq.s	.exit
	cmpi.l	#"PE1M",d0
	beq.s	.exit
	jsr	RecordMsg
.exit	RET

	acode
XXMsg	dc.l	0


NGWINLIST_NUMB	EQU	-2


;--- NG GADGET MANAGER ---



NGGAD_GadDefPTR	EQU	0		;LONG PTR
NGGAD_GadID	EQU	4		;LONG
NGGAD_GadCode	EQU	8		;LONG
NGGAD_GadCodeB	EQU	NGGAD_GadCode+4
NGGAD_On	EQU	NGGAD_GadCodeB+4 ;BYTE TRUE=Visible, FALSE=OffScreen
NGGAD_Text	EQU	NGGAD_On+4		;LONG PTR
NGGAD_TextB	EQU	NGGAD_Text+4		;TEXT des Gadinhaltes

NGGAD_WinID	EQU	NGGAD_TextB+4	;LONG
NGGAD_AreaID	EQU	NGGAD_WinID+4	;LONG
NGGAD_WinPTR	EQU	NGGAD_AreaID+4	;LONG PTR
NGGAD_AreaPTR	EQU	NGGAD_WinPTR+4	;LONG PTR

NGGAD_ActionJSR	EQU	NGGAD_AreaPTR+4	;LONG PTR

NGGAD_XYWH	EQU	NGGAD_ActionJSR+4	;4xWORD
NGGAD_BODYXYWH	EQU	NGGAD_XYWH+8		;4xWORD	;INNER SIZE

NGGAD_VALUE	EQU	NGGAD_BODYXYWH+8
NGGAD_VALUEMIN	EQU	NGGAD_VALUE+4
NGGAD_VALUEMAX	EQU	NGGAD_VALUEMIN+4
NGGAD_VALUETYPE	EQU	NGGAD_VALUEMAX+4
NGGAD_VALUELIST	EQU	NGGAD_VALUETYPE+4	;Parameter Liste
;NGGAD_VALUE	EQU	

NGGADDEF_ON	EQU 11				;+ = ON

NGGADINFO_SIZEOF	EQU	NGGAD_VALUELIST+4


	acode
NGDrawAllGads	;V1.0
	BGN
	clr.w	NGGadNumbTotal
	tst.l	NGGadInfo_PTR
	beq.s	.exit
	lea.l	NGGadgetDef,a3
	move.l	NGGadInfo_PTR,a2
.next	clr.l	NGGadActWin+4
	tst.b	(a3)
	beq.s	.exit


	;--- WIN ID ---
	move.l	(a3)+,d0
	beq.s	.err
	move.l	d0,NGGadActWin
	;--- AREA ID ---
	move.l	(a3)+,d1
	beq.s	.err
	move.l	d1,NGGadActArea
	bsr	NGFindArea2
	move.l	a0,NGGadActArea+4
	tst.l	NGGadActArea+4
	beq.s	.skiparea	;AREA UNKNOWN
	move.l	NGArea_NGWIN(a0),NGGadActWin+4

	move.l	a2,a6
	bsr	NGGadPass1
	exg	a2,a6
	bsr	NGGadPass2
	exg	a2,a6

	lea.l	1(a3),a3
	bra.s	.next

.exit	RET
.err	ASSTXT	.text
	bra.s	.exit

.skiparea
	tst.b	(a3)+
	bne.s	.skiparea
	tst.b	(a3)+
	bne.s	.skiparea
	IFNE TESTPRGB
	move.l	NGGadActArea,.skiptxt
	ASSTXT	.skiptxt
	ENDC
	bra	.next

	IFNE TESTPRGB
.skiptxt dc.b	"---- Area Skip",0
	ENDC
.text	dc.b	"Error in Window Def",0
	even

NGH_Numb	EQU	0	;WORD Numb of Gads	
NGH_MaxH	EQU	2	;WORD largest Gad in H Groupe
NGH_RestX	EQU	4	;WORD Rest of Space
NGH_LinkedNumb	EQU	6

NGH_SIZEOF	EQU	8


NGGadHGrp_PTR	dc.l	0,NGH_SIZEOF*100,FASTMEM
NGGadInfo_PTR	dc.l	0,NGGADINFO_SIZEOF*800,FASTMEM

	acode
NGGadPass1	;V1.0 CALC POSITIONS
		;I(A2L,A3L)(NGGAD,GADDEF)
		;O(A2L,A3L)
	puts	d0-d7/a0-a1/a4-a6

	;--- Clear NGGadNumb inside Area ---


	clr.w	NGGadNumb

	;--- A5 = ACTUAL NGWIN ------
	move.l	NGGadActWin+4,a5
	;--- A4 = ACTUAL NGAREA -----
	move.l	NGGadActArea+4,a4
	movem.w	NGArea_XYWH(a4),d0-d3

	lea.l	NGWin_Info(PC),a6
	sub.w	NGWI_GadAreaSpacingXY(a6),d2
	movem.w	d0-d3,NGGadActNGArea_XYWH

	move.w	d3,NGGadActAreaHRemain

	;--- RESET HGRP ---
	move.l	NGGadHGrp_PTR(PC),a6
	move.w	#1,NGH_Numb(a6)
	move.w	#0,NGH_LinkedNumb(a6)
	move.w	NGGadActNGArea_XYWH+4(PC),NGH_RestX(a6)
	clr.w	NGGadHGrpNumb

.loop	;--- GAD DEF ---
	move.l	a3,NGGAD_GadDefPTR(a2)
	tst.b	(a3)
	beq	.exit

	;--- GAD ID ---
	move.l	(a3)+,d6
	;move.l	d6,.text
	;ASSTXT	.text
	move.l	d6,NGGAD_GadID(a2)
	move.b	#FALSE,NGGAD_On(a2)

	lea.l	1(a3),a3

	;--- GAD CODES ---
	move.l	(a3)+,d6		;CODE 1
	move.l	d6,NGGAD_GadCode(a2)	;e.g. "&-0B"
	move.l	(a3)+,d6		;CODE 2
	move.l	d6,NGGAD_GadCodeB(a2)	;e.g. "&-0B"

	lea.l	1(a3),a3

	move.l	a3,NGGAD_Text(a2)


	move.l	a5,NGGAD_WinPTR(a2)
	move.l	a4,NGGAD_AreaPTR(a2)

	move.l	NGGadActWin,NGGAD_WinID(a2)
	move.l	NGGadActArea,NGGAD_AreaID(a2)

	;--- IF INVISIBLE AREA/WINDOW: EXIT ---
	cmp.l	#0,a5
	beq	.skiptoNextArea
	cmp.l	#0,a4
	beq	.skiptoNextArea
	cmpi.b	#TRUE,NGArea_Active(a4)
	bne	.skiptoNextArea

	;--- Process Gadget ---
	move.l	NGGAD_Text(a2),a0
	move.l	#NGACTION_GETSIZE,d4
	bsr	NGObjectGad
	movem.w	d2-d3,NGGAD_XYWH+4(a2)

	sub.w	d2,NGH_RestX(a6)

	cmpi.b	#"&",NGGAD_GadCode(a2)
	bne.s	.nextgrp

	;--- Process H Groupe ---
	cmpi.b	#"&",NGGAD_GadCode+1(a2)
	bne.s	.nlink

	addq.w	#1,NGH_LinkedNumb(a6)

.nlink	addq.w	#1,NGH_Numb(a6)

	;ASSTXT	.grp
	;puts	d0
	;moveq	#0,d0
	;move.w	NGH_Numb(a6),d0
	;jsr	PrintAssDec
	;gets	d0
	bra.s	.skipgad

.nextgrp
	sub.w	d3,NGGadActAreaHRemain

	addq.w	#1,NGGadHGrpNumb
	lea.l	NGH_SIZEOF(a6),a6
	move.w	#1,NGH_Numb(a6)
	move.w	#0,NGH_LinkedNumb(a6)
	move.w	NGGadActNGArea_XYWH+4(PC),NGH_RestX(a6)

	;--- SKIP TEXT ---
.skipgad
	tst.b	(a3)+
	bne.s	.skipgad
	lea.l	NGGADINFO_SIZEOF(a2),a2
	addq.w	#1,NGGadNumb
	addq.w	#1,NGGadNumbTotal
	bra	.loop

.exit	gets	d0-d7/a0-a1/a4-a6
	rts

.skiptoNextArea
	tst.b	(a3)+
	bne.s	.skiptoNextArea
	clr.w	NGGadNumb
	bra.s	.exit	

	IFNE TESTPRGB
.grp	dc.b	"H Grp",0
.text	dc.l	0,0,0,0
	ENDC


NGGadActNGArea_XYWH	dc.w	0,0,0,0

NGGadActAreaStartX	dc.w	0
;NGGadActAreaPosXY	dc.w	0,0
;NGGadActAreaWRemain	dc.w	0

NGGadActAreaHRemain	dc.w	0

NGGadRemainInGrp dc.w	0	;ANZAHL GAD INNERHALB DER AKTUELLEN H GRP
NGGadHGrpNumb	dc.w	0	;ANZAHL H GRPs
NGGadNumb	dc.w	0	;ANZAHL GADGETS TOTAL
NGGadActWin	dc.l	0,0	;ID,PTR
NGGadActArea	dc.l	0,0	;ID,PTR
NGGadNumbTotal	dc.w	0
NGGadSpreadX	dc.w	0

	acode
NGGadPass2	;V1.0 DRAW GADGETS
		;I(A2L)(NGGAD)
	BGN
	move.w	NGGadNumb,d7
	subq.w	#1,d7
	bmi	.exit



	moveq	#0,d0
	move.w	NGGadHGrpNumb,d0
	;jsr	PrintAssDec

	;--- RESET HGRP ---
	clr.w	NGGadSpreadX
	move.l	NGGadHGrp_PTR(PC),a6
	move.w	NGH_Numb(a6),NGGadRemainInGrp

	tst.w	NGH_RestX(a6)
	bmi.s	.noXspread
	move.w	NGH_Numb(a6),d1
	subq.w	#1,d1
	beq.s	.noXspread

	sub.w	NGH_LinkedNumb(a6),d1
	beq.s	.noXspread
	tst.w	d1
	bmi.s	.noXspread


	moveq	#0,d0
	move.w	NGH_RestX(a6),d0
	;jsr	PrintAssDec
	divu	d1,d0
	move.w	d0,NGGadSpreadX
.noXspread

	;--- Spread Y Rest ---
	;move.w	d7,d6
	move.w	NGGadHGrpNumb,d6
	addq.w	#1,d6
	;tst.w	d7
	;beq.s	.negrest
	moveq	#0,d0
	move.w	NGGadActAreaHRemain,d0
	tst.w	d0
	bmi.s	.negrest
	divu	d6,d0
	move.w	d0,NGGadActAreaHRemain
	bra.s	.restok	
.negrest	clr.w	NGGadActAreaHRemain
.restok
	;moveq	#0,d0
	;move.w	NGGadActAreaHRemain,d0
	;jsr	PrintAssDec


	;--- A5 = ACTUAL NGWIN ------
	move.l	NGGAD_WinPTR(a2),a5
	move.l	NGGadActArea+4,a4
	;--- A4 = ACTUAL NGAREA -----
	move.l	NGGAD_AreaPTR(a2),a4
	move.l	a4,NGGadActArea+4
	move.l	NGGAD_WinID(a2),NGGadActWin
	move.l	NGGAD_AreaID(a2),NGGadActArea
	;--- IF INVISIBLE : EXIT ---
	cmp.l	#0,a5
	beq	.exit
	cmp.l	#0,a4
	beq	.exit
	cmpi.b	#TRUE,NGArea_Active(a4)
	bne	.exit


	;--- Get Area Coors ---
	movem.w	NGArea_XYWH(a4),d0-d3
	;movem.w	d0-d1,NGGadActAreaPosXY
	;movem.w	d2-d3,NGGadActAreaWRemain
	move.w	d0,NGGadActAreaStartX

	add.w	NGGadActAreaHRemain,d1
	sub.w	NGGadActAreaHRemain,d3

.loop	;--- GAD DEF ---
	;move.l	NGGAD_GadDefPTR(a2),a3
	;tst.b	(a3)
	;beq	.exit

	;--- Check Gad in range ---
	cmp.w	NGGAD_XYWH+6(a2),d3
	blo	.gadgettoolarge
;	cmp.w	NGGAD_XYWH+4(a2),d2
;	blo.s	.next


	;--- Save Coordinates ---
	movem.w	d0-d1,NGGAD_XYWH(a2)

	;--- Draw Gad ---
	move.l	NGGAD_Text(a2),a0
	move.l	NGArea_RP(a4),a1
	cmp.l	#0,a1
	beq	.exit

	move.b	#TRUE,NGGAD_On(a2)
	moveq	#NGACTION_DRAW,d4


	;--- BOOL GAD + = ON ---
	cmpi.b	#"+",NGGAD_GadCodeB+2(a2)
	bne.s	.noton

	moveq	#NGACTION_MOUSEON,d4

	;--- DRAW GADGET ---
.noton	puts	d7
	move.l	a0,NGGAD_TextB(a2)		;Enforcer Hit fixed
	move.l	NGDrawAllGads_WINDOWID,d7
	beq.s	.all
	cmp.l	NGGadActWin,d7
	bne.s	.skipdraw
.all	;move.l	a0,NGGAD_TextB(a2)


	;--- VALUE GADS UEBERSPRINGEN ---
	cmpi.b	#"V",NGGAD_GadCode+3(a2)
	beq	.skipvalue
	bsr	NGObjectGad
.skipvalue

.skipdraw
	gets	d7

	puts	d0
	moveq	#0,d0
	move.w	NGGadRemainInGrp,d0
	;jsr	PrintAssDec	
	gets	d0


	subq.w	#1,NGGadRemainInGrp
	tst.w	NGGadRemainInGrp
	beq.s	.next

.grpstart
	;--- IS GRP GADGET ---
	add.w	NGGAD_XYWH+4(a2),d0		;ADD GAD W

	cmpi.b	#"&",NGGAD_GadCode+1(a2)
	beq.s	.link

	add.w	NGGadSpreadX,d0
.link	bra.s	.next2


	;--- Next Row -----------------
.next	lea.l	NGH_SIZEOF(a6),a6
	;--- RESET HGRP ---
	move.w	NGH_Numb(a6),NGGadRemainInGrp
	puts	d0/d1
	clr.w	NGGadSpreadX
	tst.w	NGH_RestX(a6)
	bmi.s	.noXspread2
	move.w	NGH_Numb(a6),d1
	subq.w	#1,d1
	beq.s	.noXspread2

	sub.w	NGH_LinkedNumb(a6),d1
	beq.s	.noXspread2
	tst.w	d1
	bmi.s	.noXspread2



	moveq	#0,d0
	move.w	NGH_RestX(a6),d0
	divu	d1,d0
	move.w	d0,NGGadSpreadX
.noXspread2
	gets	d0/d1


	move.w	NGGadActAreaStartX,d0		;RESET X POS
	add.w	NGGAD_XYWH+6(a2),d1		;ADD GAD H
	sub.w	NGGAD_XYWH+6(a2),d3
	;--- Add Y Spacing ---
	add.w	NGGadActAreaHRemain,d1
	sub.w	NGGadActAreaHRemain,d3

.next2	lea.l	NGGADINFO_SIZEOF(a2),a2

	dbf	d7,.loop
	bra.s	.exit
.gadgettoolarge
	;--- dont draw remaining gadgets ---
	moveq	#0,d3
	moveq	#0,d2
.exit	RET

.text	dc.l	"Draw",0,0,0

NGWinCount	dc.l	0




NGWINPREFS_ID	EQU	"NWIN"

NGWINPE_NGWINID	EQU	0	;LONG
NGWINPE_XYWH	EQU	4	;4xWORD
NGWINPE_MINI	EQU	NGWINPE_XYWH+8	;BYTE

NGWINPE_SIZEOF	EQU	NGWINPE_MINI+2

	acode
ReadGuiPrefs	;V2.0
		;Fenster positionen speichern
	BGN
	lea.l	(GuiPrefs+(3*4)),a1
	move.l	#NGWINPREFS_ID,(a1)+		;ID
	move.l	#$00010000,(a1)+		;Version

	move.l	NGWinCount(PC),d7
	subq.l	#1,d7
	bmi.s	.leave

	move.l	NGWinList_PTR,a5

.loop	move.l	NGWIN_WPTR(a5),a0
	cmp.l	#0,a0
	beq.s	.next

	;--- WINDOW INFO SPEICHERN ---
	move.l	NGWIN_ID(a5),NGWINPE_NGWINID(a1)

	cmpi.b	#TRUE,NGWIN_MINI(a5)
	beq.s	.mini

	movem.w	4(a0),d0-d3
	movem.w	d0-d3,NGWINPE_XYWH(a1)
	bra.s	.nextb

.mini	movem.w	NGWIN_OLDXYWH(a5),d0-d3

.nextb	move.b	NGWIN_MINI(a5),NGWINPE_MINI(a1)
	movem.w	d0-d3,NGWINPE_XYWH(a1)
	lea.l	NGWINPE_SIZEOF(a1),a1
	lea.l	NGWIN_SIZEOF(a5),a5
.next	dbf	d7,.loop

.leave	clr.l	(a1)+
.exit	RET

	acode
SetGuiPrefs
	BGN
	clr.l	NGWinPosDef

	lea.l	(GuiPrefs+(3*4)),a1
	cmpi.l	#NGWINPREFS_ID,(a1)
	bne.s	.exit
	cmpi.l	#$00010000,4(a1)
	bne.s	.exit

	lea.l	8(a1),a1
	move.l	a1,NGWinPosDef

.exit	RET


NGWinPosDef	dc.l	0




	
	acode
NGOpenWinList	;V1.0
	BGN

	moveq	#0,d0
	moveq	#0,d1
	move.w	#NGWINDOW_STDW,d2
	move.w	#NGWINDOW_STDH,d3

	;--- Init NGWin_Info ---
	clr.l	NGWinCount

	lea.l	NGWin_Info(PC),a6
	clr.l	NGWI_OldStatusText(a6)
	clr.l	NGWI_StatusText(a6)

	;--- Start with Window build ---

	moveq	#0,d7			;D7 = ANZAHL WINDOWS
	lea.l	NGWinDef,a2
	tst.l	NGWinList_PTR
	beq.s	.exit
	move.l	NGWinList_PTR(PC),a5

.loop	addq.l	#1,NGWinCount
	move.b	(a2)+,d4
	beq.s	.exit

	clr.l	NGWIN_WPTR(a5)
	clr.l	NGWIN_SIGMASK(a5)
	clr.l	NGWIN_AREADEF(a5)
	clr.l	NGWIN_TITLE(a5)
	move.b	#FALSE,NGWIN_MINI(a5)

	move.l	NGWinCount,NGWIN_NUMB(a5)
	move.b	#FALSE,NGWIN_ACTIVE(a5)
	addq.w	#1,d7
	move.l	(a2)+,d5
	cmpi.b	#"+",d4
	bne.s	.skip


	lea.l	1(a2),a0
	move.l	a0,NGWIN_TITLE(a5)
	move.l	a5,a0
	lea.l	NGWin_TAGS,a1

	
	bsr	NGOpenWinSpecial
	;--- CASCADE WINDOWS ON OPEN ---
	addi.l	#50,d0
	addi.l	#30,d1


.skip	move.l	d5,NGWIN_ID(a5)
	lea.l	NGWIN_SIZEOF(a5),a5

.skipzero	move.b	(a2)+,d4
	bne.s	.skipzero
	bra.s	.loop		
	
.exit	move.w	d7,NGWinList_PTR+NGWINLIST_NUMB	
	bsr	NGDrawWinList
	;bsr	NGDrawAllGads
	bsr	NGActivateFirstWin
	RET

NGActivateFirstWin
	BGN
	move.w	NGWinList_PTR+NGWINLIST_NUMB,d7
	subq.w	#1,d7
	bmi.s	.exit

	move.l	NGWinList_PTR(PC),a5
.loop	tst.l	NGWIN_WPTR(a5)
	bne.s	.found
	dbf	d7,.loop

	lea.l	NGWIN_SIZEOF(a5),a5
.exit	RET

.found	move.l	NGWIN_WPTR(a5),a0
	CALLINT	ActivateWindow(a6)
	bra.s	.exit


NGOpenWinSpecial
	BGN
	tst.l	NGWinPosDef
	beq.s	.noxydef

	move.l	NGWinPosDef,a6

.loop	tst.l	(a6)
	beq.s	.noxydef

	cmp.l	NGWINPE_NGWINID(a6),d5
	beq.s	.setxy

	lea.l	NGWINPE_SIZEOF(a6),a6
	bra.s	.loop

.setxy	moveq	#0,d0
	moveq	#0,d1
	moveq	#0,d2
	moveq	#0,d3
	movem.w	NGWINPE_XYWH(a6),d0-d3
	;move.b	NGWINPE_MINI(a6),NGWIN_MINI(a5)
	movem.w	d0-d3,NGWIN_OLDXYWH(a5)
	;cmpi.b	#TRUE,NGWINPE_MINI(a6)
	;bne.s	.noxydef

	;--- OPEN AS MINI WIN ---

	;move.w	NGZoomedWin_W,d2
	;NGZoomedDist_W

.noxydef	bsr	NGOpenWinXYWH
	RET



NGZoomedWin_W	dc.w	640/8
NGZoomedDist_W	dc.w	640/8
NGZoomedWin_H	dc.w	0

NGZoomMiniWindow
	BGN
	move.l	MainScreen_PTR,a3
	tst.l	(a3)
	beq	.exit

	moveq	#0,d0
	move.w	12(a3),d0
	divu	#8,d0
	move.w	d0,NGZoomedWin_W
	move.w	d0,NGZoomedDist_W

	subi.w	#12,d0
	bmi.s	.toosmall

	addq.w	#2,d0
	move.w	d0,NGZoomedWin_W

.toosmall

	cmp.l	#0,a5
	beq.s	.exit
	tst.l	NGWIN_WPTR(a5)
	beq.s	.exit
	move.l	NGWIN_WPTR(a5),a0

	cmpi.b	#TRUE,NGWIN_MINI(a5)
	beq.s	.backtofull

	;--- SAVE OLD POS ---
	movem.w	4(a0),d0-d3
	movem.w	d0-d3,NGWIN_OLDXYWH(a5)

	;--- ZOOM TO MINIMAL POS ---
	move.b	#TRUE,NGWIN_MINI(a5)


	bsr	NGGetStandardGadH
	move.w	d0,d7

	move.l	NGWIN_NUMB(a5),d0
	subq.w	#1,d0
	bmi.s	.exit
	mulu	NGZoomedDist_W,d0
	moveq	#0,d1

	move.w	NGZoomedWin_W(PC),d2
	moveq	#0,d3
	move.b	55(a0),d3
	;--- GAD H DAZU ---
	add.w	d7,d3

	;--- UNTEN AM SCREEN PLAZIEREN ---
	move.w	14(a3),d1
	sub.w	d3,d1

	;move.l	24(a0),d7
	;move.l	d7,NGWIN_OLDFLAGS(a5)
	;andi.l	#$ffffffc8,d7
	;move.l	d7,24(a0)

	move.w	d3,NGZoomedWin_H
	bsr	NGSetWindowXYWH
	bra.s	.exit

.backtofull
	;move.l	NGWIN_OLDFLAGS(a5),24(a0)
	movem.w	NGWIN_OLDXYWH(a5),d0-d3
	move.b	#FALSE,NGWIN_MINI(a5)
	bsr	NGSetWindowXYWH

.exit	RET






	acode
NGCloseWinList	;V1.0
	BGN
	move.w	NGWinList_PTR+NGWINLIST_NUMB,d7
	subq.w	#1,d7
	bmi.s	.exit	

	tst.l	NGWinList_PTR
	beq.s	.exit

	move.l	NGWinList_PTR(PC),a0
.loop	bsr	NGCloseWin
	lea.l	NGWIN_SIZEOF(a0),a0
	dbf	d7,.loop

.exit	RET

	acode
NGOpenWinXYWH	;V1.0
	move.l	d0,NGWINT_X+4
	move.l	d1,NGWINT_Y+4
	move.l	d2,NGWINT_W+4
	move.l	d3,NGWINT_H+4

NGOpenWin	;I(A0L,A1L)(WINDOW_PTR,WINDOW_TAGS)
	BGN
	move.l	a0,a5
	;--- COPY TITLE ADR ---
	move.l	NGWIN_TITLE(a5),NGWIN_TITLEADR+4
	suba.l	a0,a0
	CALLINT	OpenWindowTagList(a6)
	move.l	d0,NGWIN_WPTR(a5)

	;--- RESET PARAMETERS ---
	clr.w	NGWIN_AREANUMB(a5)
	clr.l	NGWIN_SIGMASK(a5)
	clr.l	NGWIN_AREA(a5)
	clr.l	NGWIN_UP(a5)
	clr.l	NGWIN_RP(a5)
	move.b	#FALSE,NGWIN_MOUSECLICK(a5)
	clr.l	NGWIN_MOUSECLICK_XY(a5)
	clr.l	NGWIN_MOUSE_XY(a5)
	move.w	#-1,NGWIN_APEN(a5)
	move.w	#-1,NGWIN_BPEN(a5)
	move.l	#-1,NGWIN_DRMD(a5)
	tst.l	d0
	beq.s	.exit

	;--- INIT NGWIN STRUCT --------------------
	move.l	(a5),a0
	jsr	SetAutoMenuStrip

	jsr	GetWindowSignal
	move.l	d0,NGWIN_SIGMASK(a5)

	move.l	(a5),a0
	jsr	GetWindowUP
	move.l	a0,NGWIN_UP(a5)

	move.l	(a5),a0
	jsr	GetWindowRP
	move.l	a1,NGWIN_RP(a5)

	lea.l	NGWin_Info(PC),a4
	jsr	GetFontInfo
	movem.w	d0-d3,NGWI_GadFontW(a4)

	move.w	NGWI_GadFontH(a4),d0
	addq.w	#4,d0
	move.w	d0,NGWI_AreaFixWH+2(a4)
	move.w	#4,NGWI_AreaFixWH(a4)
.exit	RET


NGCloseWinId	;V1.1
	BGN
	bsr	NGFindWindow
	bsr	NGCloseWin
	RET


	acode
NGCloseWin	;V1.2
		;V1.2 Complete Windowlist Redraw
		;I(A0L)(WINDOW_PTR)
	BGN
	cmp.l	#0,a0
	beq.s	.exit
	move.l	a0,a5
	clr.l	NGWIN_RP(a5)
	tst.l	NGWIN_WPTR(a5)
	beq.s	.exit

	move.l	NGWIN_WPTR(a5),a4	;A4 = WINDOW PTR
	clr.l	NGWIN_WPTR(a5)
	;--- FREE MSGS ---
.nextmsg move.l	NGWIN_UP(a5),a0
	cmp.l	#0,a0
	beq.s	.nomsg
	CALLEXEC GetMsg
	tst.l	d0
	beq.s	.nomsg
	
	move.l	d0,a1
	CALLEXEC ReplyMsg
	bra.s	.nextmsg

	;--- REMOVE MSGPORT ---
.nomsg	moveq	#0,d0
	move.l	a4,a0
	CALLINT	ModifyIDCMP(a6)
	clr.l	NGWIN_UP(a5)

	;--- CLOSE WINDOW ---
	move.l	a4,a0	
	CALLINT	CloseWindow(a6)


	;Remove All Areas !!! to do


.exit	RET

	acode
NGOpenWindows	;V1.0
	BGN
	bsr	NGOpenWinList
	RET

	acode
NGCloseWindows
	BGN
	bsr	NGCloseWinList
.exit	RET


	acode
NGFindWindow	;V1.0
		;I(D0L)(WINDOW ID)
		;O(A0L)(NGWIN,0=UNKNOWN)
	puts	d7/a5
	suba.l	a0,a0

	tst.l	NGWinList_PTR
	beq.s	.exit

	move.w	NGWinList_PTR+NGWINLIST_NUMB,d7
	subq.w	#1,d7
	bmi.s	.exit
	move.l	NGWinList_PTR(PC),a5
.loop	cmp.l	NGWIN_ID(a5),d0
	beq.s	.found
	lea.l	NGWIN_SIZEOF(a5),a5
	dbf	d7,.loop
.exit	gets	d7/a5
	rts
.found	move.l	a5,a0
	bra.s	.exit


	acode
NGWindowCheck	;V1.0
		;I(D0L)(WINDOW ID)
		;O(A0L)(NGWIN,0=NOT ON SCREEN)
	bsr	NGFindWindow
	cmp.l	#0,a0
	beq.s	.exit
	tst.l	NGWIN_WPTR(a0)		;0= WINDOW OFF
	beq.s	.na
.exit	rts
.na	suba.l	a0,a0
	rts
		
	acode
NGDrawWinList	;V1.0
	BGN
	lea.l	NGAreaDef,a4

.loop	tst.b	(a4)
	beq.s	.exit

	move.l	(a4),d0
	bsr	NGWindowCheck
	cmp.l	#0,a0
	beq.s	.next

	move.l	a4,NGWIN_AREADEF(a0)
	bsr	NGWDrawWindow

.next	tst.b	(a4)+
	bne.s	.next
	bra.s	.loop

	;--- DRAW ALL NG GADS ---
.exit	bsr	NGDrawAllGads
	RET

	acode
NGWDrawWindowID	;V1.0
		;I(D0L)(NGWIN ID)
	BGN
	bsr	NGWindowCheck
	cmp.l	#0,a0
	beq.s	.exit
	move.l	NGWIN_AREADEF(a0),a4
	cmp.l	#0,a4
	beq.s	.exit
	bsr	NGWDrawWindow
.exit	RET	

	acode
NGWDrawWindow	;I(A0L,A4L)(NGWIN,NGAREADEF)
	BGN
	move.l	a0,a5
	bsr	NGWGetWindowXYWH

	moveq	#0,d4
	bsr	NGRDrawBack

	subq.w	#4,d2
	subq.w	#4,d3
	addq.w	#2,d0
	addq.w	#2,d1
	move.l	a4,a0
	bsr	NGWBuildAreas
	RET

;--- NGWIN MESSAGE PROCESSING ---

	acode
DoWithAllNGWindows	;V1.0
			;I(A4L)(JSR)
	BGN
	moveq	#0,d0
	tst.l	NGWinList_PTR
	beq.s	.exit
	move.w	NGWinList_PTR+NGWINLIST_NUMB,d7
	subq.w	#1,d7
	bmi.s	.exit
	move.l	NGWinList_PTR(PC),a5

.loop	move.l	NGWIN_ID(a5),d0
	jsr	(a4)
	lea.l	NGWIN_SIZEOF(a5),a5
	dbf	d7,.loop
.exit	RET

	acode
NGWGetSignalMask	;V1.0
			;O(D0L)(SIGNAL MASK)
	puts	d1/d7/a5
	moveq	#0,d0
	tst.l	NGWinList_PTR
	beq.s	.exit
	move.w	NGWinList_PTR+NGWINLIST_NUMB,d7
	subq.w	#1,d7
	bmi.s	.exit
	move.l	NGWinList_PTR(PC),a5
.loop	move.l	NGWIN_SIGMASK(a5),d1
	or.l	d1,d0
	lea.l	NGWIN_SIZEOF(a5),a5
	dbf	d7,.loop
.exit	gets	d1/d7/a5
	rts

	acode
ProcessAllNGWinMsg
	BGN
	lea.l	.do(PC),a4
	jsr	DoWithAllNGWindows
	RET
.do	move.l	a5,ActualNGWWIN
	bra.s	ProcessNGWindowIdMsg

	nop

	acode
ProcessNGWindowIdMsg	;I(D0L)(WINDOW ID)
	BGN
	move.l	d0,ActualNGWWIN_ID
	bsr	NGWindowCheck
	cmp.l	#0,a0
	beq.s	.exit
	move.l	NGWIN_WPTR(a0),a0
	lea.l	NGWINA_JUMPLIST(PC),a1
	jsr	ProcessWindowMsg
.exit	RET


CloseMyNGWin
	BGN
	move.l	ActualNGWWIN_ID,d0
	beq.s	.exit
	bsr	NGCloseWinId
.exit	RET



;--- DATA -----------------------------------------------------

		dc.w	0				;Anzahl Windows
NGWinList_PTR	dc.l	0,NGWIN_SIZEOF*20,FASTMEM


ActualNGWWIN	dc.l	0
ActualNGWWIN_ID	dc.l	0

NGWINA_JUMPLIST
	dc.l	IDCMP_RAWKEY,MRAWKEY_JL,22,$ff,FastKeyboard,0
	dc.l	IDCMP_MOUSEBUTTONS,NIL_JL,22,$ff,NGWButtons,0
	IFNE SMALLGUI
	dc.l	IDCMP_CLOSEWINDOW,NIL_JL,0,0,MAINEXIT,0
	ELSE
	dc.l	IDCMP_CLOSEWINDOW,NIL_JL,0,0,NGWinCloseMsg,0
	ENDC
	dc.l	IDCMP_NEWSIZE,NIL_JL,0,0,NGWinResizeMsg,0
	dc.l	IDCMP_ACTIVEWINDOW,NIL_JL,0,0,NGWWinActivateMsg,0
	dc.l	IDCMP_MENUPICK,MMENU_JL,22,$ffff,IMSGInfo,0
	dc.l	-1

;--- MESSAGE ---------------------------------------------------------------

	acode
NGWinCloseMsg
	BGN
	IFNE TESTPRGB
	move.l	ActualNGWWIN_ID,.text+1
	ASSTXT	.text
	ENDC

	;move.b	#TRUE,NGWIN_ACTIVE(a5)

	move.l	ActualNGWWIN,a5
	cmp.l	#0,a5
	beq.s	.exit

	lea.l	NGWin_Info(PC),a4
	move.l	a5,NGWI_ActiveWindowAdr(a4)

	bsr	NGZoomMiniWindow

	;bsr	NGSetWindowXYWH
.exit	RET

	IFNE TESTPRGB
.text	dc.b	"*----* NGWINDOW: Close",0
	ENDC

	acode
NGSetWindowXYWH	;V1.0
		;I(A5L)(NGWIN)
	BGN
	cmp.l	#0,a5
	beq.s	.exit
	tst.l	NGWIN_WPTR(a5)
	beq.s	.exit
	move.l	NGWIN_WPTR(a5),a0
	CALLINT	ChangeWindowBox(a6)

.exit	RET



	acode
NGWWinActivateMsg	;V1.0
	BGN
	IFNE TESTPRGB
	move.l	ActualNGWWIN_ID,.text+1
	ASSTXT	.text
	ENDC
	move.b	#TRUE,NGWIN_ACTIVE(a5)

	move.l	ActualNGWWIN,a5
	cmp.l	#0,a5
	beq.s	.exit

	lea.l	NGWin_Info(PC),a4
	move.l	a5,NGWI_ActiveWindowAdr(a4)
.exit	RET
	IFNE TESTPRGB
.text	dc.b	"*----* NGWINDOW: Activate",0
	ENDC

	acode
NGDrawAllGads_WINDOWID	dc.l	0

NGDrawGadsWindowID	;V1.0
			;I(D0L)(NGWIN ID)
	move.l	d0,NGDrawAllGads_WINDOWID	
	bsr	NGDrawAllGads
	clr.l	NGDrawAllGads_WINDOWID
	rts



;--- DSP POPUP GAGETS --------------------------------------

	acode
SelectDspEcho
	BGN
	move.l	#"SY59",d0
	jsr	NGFindGadID
	cmp.l	#0,a0
	beq.s	.exit
	move.l	NGGAD_VALUE(a0),d7
	cmpi.l	#4,d7
	bhi.s	.quit
	lea.l	DspAction_LIST,a2
	move.l	(a2,d7.w*4),a2
	jsr	(a2)
.quit	bsr	SelectDspDraw
	bsr	ShowDspStatus
.exit	RET

SelectDspDelay
	BGN
	move.l	#"SY69",d0
	jsr	NGFindGadID
	cmp.l	#0,a0
	beq.s	.exit
	move.l	NGGAD_VALUE(a0),d7
	cmpi.l	#2,d7
	bhi.s	.quit
	lea.l	DspActionDelay_LIST,a2
	move.l	(a2,d7.w*4),a2
	jsr	(a2)
.quit	bsr	SelectDspDraw
.exit	RET

SelectDspHall
	BGN
	move.l	#"SY79",d0
	jsr	NGFindGadID
	cmp.l	#0,a0
	beq.s	.exit
	move.l	NGGAD_VALUE(a0),d7
	cmpi.l	#2,d7
	bhi.s	.quit
	lea.l	DspActionDelay_LIST,a2
	move.l	(a2,d7.w*4),a2
	jsr	(a2)
.quit	bsr	SelectDspDraw
.exit	RET

SelectDspDraw
	move.l	ActualNGWWIN_ID,d0
	beq	.exit
	lea.l	NGWin_Info,a6
	move.l	NGWI_ActiveWindowAdr(a6),a5
	move.l	NGWIN_ID(a5),d0
	cmp.l	#0,a5
	jsr	PreClipWIN
	bsr	NGWDrawWindowID
	bsr	NGDrawGadsWindowID
	bsr	DrawSystemSetup
	jsr	ShowDspStatus
	jsr	PostClipWIN
.exit	rts



	acode
NGWinResizeMsg	;V1.0
	BGN
	move.l	ActualNGWWIN_ID,d0
	beq	.exit

	bsr	NGWDrawWindowID
	bsr	NGDrawGadsWindowID
	;bsr	NGDrawAllGads

	;--- INSTRUMENT ---
	cmpi.l	#"WINS",d0
	bne	.notinst
	jsr	DrawInstrumentReset
	jsr	DrawInstrument
	jsr	DrawInstrParam
	bra	.exit

	;--- SPECTRUM ---
.notinst	cmpi.l	#"WINA",d0		;SPECTRUM
	bne.s	.nota
	jsr	RedrawSpec
	bra	.exit

	;--- SONG ED ---
.nota	cmpi.l	#"WINB",d0		;SONG EDITOR
	bne.s	.notb
	jsr	DrawPositionCacheReset
	jsr	DrawSongAll
	bra.s	.exit

	;--- ASSIST ---
.notb	cmpi.l	#"WINC",d0		;ASSIST
	bne.s	.notc
	bsr	ShowBufferedAMsgs
	bsr	NGRedrawStatusText
	bra.s	.exit
.notc
	;--- PED ---
	cmpi.l	#"PTED",d0
	bne.s	.notped
	jsr	AdjustActualPattEd
	bra.s	.exit
.notped

	cmpi.l	#"CTRL",d0
	bne.s	.notsys

	bsr	DrawSystemSetup
	jsr	ShowDspStatus

	IFNE SMALLGUI
	jsr	DrawPositionCacheReset
	jsr	DrawSongAll
	bsr	ShowBufferedAMsgs
	jsr	GetActualInstrNum		;Instrument Nr
	jsr	DrawInstrumentReset
	jsr	DrawInstrument
	ENDC


	bra.s	.exit
.notsys
	IFEQ SMALLGUI
	cmpi.l	#"EVED",d0
	bne.s	.notevent
	clr.l	LastEvent
	jsr	ClrDrawNECache
	bsr	DrawEventStatus
	bsr	RedrawMEventAll
	bra	.exit
	ENDC
.notevent

.exit	RET
	IFNE TESTPRGB
.activetxt	dc.b	"ON",0
	ENDC


;--- NG AREA SYSTEM ----------------------------------------------
	adata
AnimateDelay	dc.l	8
InitActionDelay
	BGN
	moveq	#8,d0

	move.l	#8,d1
	divu.l	VexBufferNumb,d1
	mulu.l	d1,d0

	mulu.l	VexSpeed,d0
	divu.l	#175,d0

	cmpi.l	#2,d0
	bhs.s	.ok
	moveq	#2,d0
.ok	move.l	d0,AnimateDelay
	RET


	acode
NGGetInnerAreaData
		;V1.0
		;I(D0L,D1L)(NGWIN ID,NGAREA ID)
		;O(D0W-D3W,A0L,A1L,A5L)(XYWH,NGAREA,RP 0=OFF,NGWIN)
	suba.l	a1,a1
	bsr	NGFindArea
	cmp.l	#0,a0
	beq.s	.exit

	move.l	NGArea_RP(a0),a1
	movem.w	NGArea_XYWH(a0),d0-d3
.exit	rts
	


	acode
NGFindAreaWindow	;V1.0
		;I(D1L)(AREA ID)
		;O(D0L)(WINDOW ID)
	puts	d7/a0/a5

	tst.l	NGWinList_PTR
	beq.s	.notfound

	move.w	NGWinList_PTR+NGWINLIST_NUMB,d7
	subq.w	#1,d7
	bmi.s	.notfound
	move.l	NGWinList_PTR(PC),a5

.loop	move.l	NGWIN_ID(a5),d0
	bsr	NGFindArea
	cmp.l	#0,a0
	bne.s	.exit		;found it

	lea.l	NGWIN_SIZEOF(a5),a5
	dbf	d7,.loop
.notfound
	moveq	#0,d0
.exit	gets	d7/a0/a5
	rts



	acode
NGFindArea2	;V1.0
		;I(D0L,D1L)(NGWIN ID,NGAREA ID)
		;O(A0L)(NGAREA)
	puts	d0
	bsr	NGFindWindow
	move.l	a0,a5
	cmp.l	#0,a0
	beq.s	.exit

	move.l	d1,d0
	bsr	NGAreaIsActive
.exit	gets	d0
	rts

	acode
NGFindArea	;V1.0
		;I(D0L,D1L)(NGWIN ID,NGAREA ID)
		;O(A0L)(NGAREA,0=NOT OPEN/VISIBLE)
	puts	d0
	bsr	NGFindWindow
	move.l	a0,a5
	cmp.l	#0,a0
	beq.s	.exit

	move.l	d1,d0
	bsr	NGAreaIsActive
	cmpi.w	#TRUE,d0
	beq.s	.exit

	suba.l	a0,a0
.exit	gets	d0
	rts



	acode
NGWButtons
	BGN


	bsr	NGWDoAnimations
	move.b	#FALSE,Patted_MoveCrsr

	lea.l	NGWin_Info(PC),a6
	move.l	NGWI_ActiveWindowAdr(a6),a5
	cmp.l	#0,a5
	beq	.exit

	move.l	d4,d0
	andi.l	#$80,d0
	moveq	#FALSE,d7
	move.b	d7,NGWIN_MOUSECLICK(a5)
	tst.b	d0
	bne	.clr

	move.l	NGWIN_MOUSE_XY(a5),NGWIN_MOUSECLICK_XY(a5)
	moveq	#TRUE,d7
	move.b	d7,NGWIN_MOUSECLICK(a5)
	;--- TRACK MUTE ---
	move.l	NGWI_ActiveAreaAdr(a6),a0
	cmp.l	#0,a0
	beq.s	.noarea

	;--- CHECK LOOP RANGE ---
	cmpi.l	#"SWAV",NGArea_ID(a0)
	bne.s	.notloop

	jsr	CheckInstrument
	cmpi.b	#ISTATE_KILLED,d0
	beq.s	.notloop


	jsr	CheckNewLoopInstr
	cmpi.b	#TRUE,d0
	bne.s	.nonewl
	;--- CORRECT NEW LOOP ---
	move.w	NGArea_XYWH+4(a0),d1
	mulu	#3,d1
	divu	#4,d1
	add.w	NGArea_XYWH(a0),d1
	move.w	NGWIN_MOUSE_XY(a5),d0
	cmp.w	d1,d0
	bhs.s	.notloop
	

.nonewl	move.l	#DoLoopRange,NGWI_VERIFYJSR(a6)
	;clr.l	NGWI_ActiveGadAdr(a6)
	;bra	.exit

	;--- Pattern Editor ---
.notloop
	cmpi.l	#"PED2",NGArea_ID(a0)
	bne.s	.noarea
	;--- Get Mouse Pos ---
	movem.w	NGWIN_MOUSE_XY(a5),d0-d1
	bsr	ConvertMouseXYtoPEDXY
	bsr	PEDSetMute
	;bra	.exit
.noarea	
	IFNE TESTPRGB
	ASSTXT	.up
	ENDC

.clr	;--- GADGET ATION ---
	tst.b	d7
	beq	.mdwn

	;--- MOUSE GEDRUECKT ---

	clr.l	NGWI_AnimateGadAdr(a6)
	move.l	NGWI_ActiveGadAdr(a6),a0
	cmp.l	#0,a0
	beq	.nodrawoff

	move.l	a0,NGWI_AnimateGadAdr(a6)
	move.l	NGGAD_ActionJSR(a0),a3
	move.l	AnimateDelay,NGWI_ActionDelay(a6)
	moveq	#NGACTION_MOUSEON,d4

	cmpi.w	#"1B",NGGAD_GadCode+2(a0)
	beq.s	.ToogleGad
	bra	.drawgad

.ToogleGad
	
	cmpi.b	#"-",NGGAD_GadCodeB+2(a0)
	beq.s	.ToogleOn


	;--- TOOGLE OFF ---
	move.l	NGGAD_GadDefPTR(a0),a1
	moveq	#NGACTION_DRAW,d4
	move.b	#"-",NGGAD_GadCodeB+2(a0)
	move.b	#"-",NGGADDEF_ON(a1)
	bra.s	.drawToogle

.ToogleOn
	;--- TOOGLE ON ---
	move.l	NGGAD_GadDefPTR(a0),a1
	moveq	#NGACTION_MOUSEON,d4
	move.b	#"+",NGGAD_GadCodeB+2(a0)
	move.b	#"+",NGGADDEF_ON(a1)

.drawToogle
	bsr	.drawgadB
	move.l	NGGAD_GadID(a0),d0
	bsr	NGGadDoAction
	bra	.nodrawoff


	;--- MOUSE LOSGELASSEN ---
.mdwn	cmpi.b	#TRUE,Loopactive
	bne.s	.noloop2
	bsr	LoopSelect

	;--- VERIFY MODUS VERLASSEN ---
.noloop2
	clr.l	NGWI_VERIFYJSR(a6)

	move.l	NGWI_AnimateGadAdr(a6),a0
	cmp.l	#0,a0
	beq.s	.nodrawoff

	cmpi.w	#"1B",NGGAD_GadCode+2(a0)
	beq.s	.nodrawoff

	;--- Command ausfuehren ---
	move.l	NGGAD_ActionJSR(a0),a3
	move.l	NGGAD_GadID(a0),d0
	moveq	#NGACTION_DRAW,d4

	;--- Verifizieren ---
	move.l	NGWI_ActiveGadAdr(a6),a2
	cmp.l	#0,a2
	beq.s	.drawgad
	cmp.l	NGGAD_GadID(a2),d0
	bne.s	.drawgad
	bsr	NGGadDoAction

.drawgad
	IFEQ SMALLGUI
	move.w	#FALSE,ModifyEventInfo+10
	ENDC

	;--- TEXT UND VALUE GADS rausfiltern ---
	cmpi.b	#"V",NGGAD_GadCode+3(a0)
	beq	.nodrawoff
	cmpi.b	#"T",NGGAD_GadCode+3(a0)
	beq	.nodrawoff
	movem.w	NGGAD_XYWH(a0),d0-d3
	move.l	NGGAD_WinPTR(a0),a5
	move.l	NGWIN_RP(a5),a1
	move.l	NGGAD_Text(a0),a0
	jsr	(a3)
.nodrawoff
.nogadactive

.exit0	;jsr	PrintAssHex
	IFNE TESTPRGB
	ASSTXT	.text
	ENDC
.exit	RET

.drawgadB
	puts	d0/a0
	;--- TEXT UND VALUE GADS rausfiltern ---
	cmpi.b	#"V",NGGAD_GadCode+3(a0)
	beq	.ndrb
	cmpi.b	#"T",NGGAD_GadCode+3(a0)
	beq	.ndrb

	movem.w	NGGAD_XYWH(a0),d0-d3
	move.l	NGGAD_WinPTR(a0),a5
	move.l	NGWIN_RP(a5),a1
	move.l	NGGAD_Text(a0),a0
	jsr	(a3)
.ndrb	gets	d0/a0
	rts

	IFNE TESTPRGB
.dwn	dc.b	"Down",0
.up	dc.b	"Up",0
.text	dc.b	"NGWINDOW: MouseButtons",0
.gtext	dc.b	"---- GADID",0
	ENDC


	acode
NGWGetWindowXYWH	;I(A5L)(NGWIN)
			;O(D0W-D3W)(XYWH)
			;AUSMASSE DES BODY
	puts	a5
	move.l	(a5),a5
	moveq	#0,d0
	moveq	#0,d1
	moveq	#0,d2
	moveq	#0,d3
	move.w	112(a5),d2
	move.w	114(a5),d3
	subq.w	#1,d2
	subq.w	#1,d3
	gets	a5
	rts


Patted_MoveCrsr	dc.b	FALSE

	acode
NGWDoAnimations
	BGN
	;--- Check NGWInfo ---
	lea.l	NGWin_Info(PC),a5
	move.l	a5,a6
	tst.l	NGWI_ActiveWindowAdr(a6)
	beq	.exit

	;--- Goto Active NGWin ---
	move.l	(a5),a5
	tst.l	(a5)
	beq	.clear
	tst.l	NGWIN_RP(a5)
	beq	.clear




	;--- Update Mouse Pos ---
	move.l	(a5),a4
	bsr	GetMouseXYOfWindow
	movem.w	d0-d1,NGWIN_MOUSE_XY(a5)


	cmpi.w	#TRUE,ClipMouseRegion+8
	beq	.forceanimate


	IFNE TESTPRGB
	jsr	TESTDrawMouseCrsr
	ENDC
	tst.l	NGWI_VERIFYJSR(a6)
	bne	.doverify

	;--- Update Area ---
	IFNE TESTPRGB
	move.l	#"----",.areatxt
	move.l	#"----",.gadtxt
	ENDC
	clr.l	NGWI_ActiveAreaAdr(a6)
	clr.l	NGWI_ActiveGadAdr(a6)

	puts	a0
	bsr	NGFindAreaAtXY
	cmp.l	#0,a0
	bne.s	.doareas

	;--- Scroll PED Crsr R and D ---
	cmpi.b	#TRUE,NGWIN_MOUSECLICK(a5)
	bne	.noarea
	cmpi.b	#TRUE,Patted_MoveCrsr
	bne	.noarea

	puts	d2/a0
	jsr	GetActualPattEd

	move.w	PATTED_EDITXYWH(a0),d2
	cmp.w	d2,d0
	bgt.s	.chkscrollr
	jsr	CrsrLeft
	bra.s	.noscrollr
.chkscrollr
	add.w	PATTED_EDITXYWH+4(a0),d2
	cmp.w	d2,d0
	blo.s	.noscrollr
	jsr	CrsrRight
.noscrollr

	move.w	PATTED_EDITXYWH+2(a0),d2
	cmp.w	d2,d1
	bgt.s	.chkscrolld
	jsr	CrsrUp
	bra.s	.noscrolld

.chkscrolld
	add.w	PATTED_EDITXYWH+6(a0),d2
	cmp.w	d2,d1
	blo.s	.noscrolld
	jsr	CrsrDown
.noscrolld
	gets	d2/a0
	bra	.noarea

	;--- Area is active, do action  ---
.doareas
	IFNE TESTPRGB
	move.l	NGArea_ID(a0),.areatxt
	ENDC

	move.l	a0,NGWI_ActiveAreaAdr(a6)

	cmpi.l	#"SWAV",NGArea_ID(a0)
	bne.s	.notloop
	cmpi.b	#TRUE,NGWIN_MOUSECLICK(a5)
	beq.s	.notloop
	ASSTATUS Loopseltxt

	;--- Pattern Editor ---
.notloop
	cmpi.l	#"PED2",NGArea_ID(a0)
	bne.s	.dogads

	;--- Get Mouse Pos ---
	movem.w	NGWIN_MOUSE_XY(a5),d0-d1
	bsr	ConvertMouseXYtoPEDXY
	cmpi.b	#TRUE,NGWIN_MOUSECLICK(a5)
	beq.s	.mousepressed

	;--- Mouse nicht gedrueckt ---
	tst.w	d1
	bne.s	.nomute
	ASSTATUS	pedtxtc
	bra	.noarea
.nomute	ASSTATUS	pedtxt
	bra	.noarea

	;--- Mouse gedrueckt ---
.mousepressed
	cmpi.b	#TRUE,Patted_MoveCrsr
	bne.s	.noarea
	;--- PED CRSR bewegen ---
	bsr	PEDSetCrsrOffset
	ASSTATUS	pedtxtb
	bra	.noarea

	;--- Update Gad ---
.dogads	puts	a4
	move.l	NGWI_ActiveAreaAdr(a6),a4
	cmp.l	#0,a4
	beq.s	.nogad
	bsr	NGFindGadAtXY
	cmp.l	#0,a0
	beq.s	.nogad

	;IFNE TESTPRGB
	;move.l	NGGAD_GadID(a0),.gadtxt		;GADID ANZEIGEN
	;ASSTXT	.gadtxt
	;ENDC

	move.l	a0,NGWI_ActiveGadAdr(a6)
.nogad	gets	a4
.noarea	gets	a0


	;--- TEST: Draw ---
	cmpi.b	#TRUE,NGWIN_MOUSECLICK(a5)
	bne	.NOmouse


	;IFNE TESTPRGB
	;ASSTXT	.areatxt
	;ENDC

	;--- GAD OBJECT ANIMIEREN ---
.forceanimate
	puts	a0


	move.l	NGWI_AnimateGadAdr(a6),a0
	cmp.l	#0,a0
	beq.s	.nogadactive
	cmp.l	NGWI_ActiveGadAdr(a6),a0
	bne.s	.nogadactive

	tst.l	NGGAD_ActionJSR(a0)
	beq.s	.nogadactive
	cmpi.b	#"R",NGGAD_GadCodeB+3(a0)
	bne.s	.nogadactive

	cmpi.b	#"S",NGGAD_GadCode+3(a0)
	beq.s	.nodelay
	subq.l	#1,NGWI_ActionDelay(a6)		;Action Verzoergerung
	bpl.s	.nogadactive


.nodelay
	;--- REPEAT ACTION ---
	puts	d0-d4/a0-a5
	move.l	NGGAD_GadID(a0),d0
	bsr	NGGadDoAction
	move.l	NGGAD_ActionJSR(a0),a3
	movem.w	NGGAD_XYWH(a0),d0-d3
	move.l	NGGAD_WinPTR(a0),a5
	move.l	NGWIN_RP(a5),a1
	move.l	NGGAD_Text(a0),a0

	;--- REPEAT ACTION DRAW ---
	moveq	#NGACTION_ANIMATE,d4
	jsr	(a3)
	gets	d0-d4/a0-a5
.nogadactive
	gets	a0

	;--- DRAW MOUSE CRSR ---
	;move.l	NGWIN_RP(a5),a1
	;moveq	#1,d0
	;bsr	NGRenderSetAPen
	;moveq	#0,d0
	;bsr	NGRenderSetDrMd
	;movem.w	NGWIN_MOUSE_XY(a5),d0-d1
	;jsr	GFX_Draw
	;moveq	#20,d2
	;moveq	#10,d3
	;moveq	#2,d4
	;bsr	NGRDrawBorder
	bra.s	.exit

.NOmouse
	movem.l	MouseSeloldxy,d0-d1
	clr.l	MouseSeloldxy
	movem.l	d0-d1,MouseSeloldxy+8

.exit	RET
.clear	;--- CLEAR ACTIVE WINDOW ---
	IFNE TESTPRGB
	ASSTXT	.txt
	ENDC
	lea.l	NGWin_Info(PC),a5
	clr.l	NGWI_ActiveWindowAdr(a5)
	bra.s	.exit

.doverify
	move.l	NGWI_VERIFYJSR(a6),a6
	jsr	(a6)
	bra.s	.exit

	IFNE TESTPRGB
.txt	dc.b	"NG Window Cleared",0
.areatxt dc.b	"**** - Area at Mouse",0
.gadtxt	dc.b	"**** - Gad at Mouse",0
.txt2	dc.b	"NG Anim",0
	ENDC

	acode
GetMouseXYOfWindow	;I(A4L)(WINDOW)
			;O(D0W,D1W)(XY)
	move.w	108(a4),d0
	move.w	110(a4),d1

	;moveq	#0,d2
	;move.b	80(a4),d2
	;add.w	d2,d0
	;move.b	81(a4),d2
	;add.w	d2,d1
	;--- Mouse X correction ---
	;addq.w	#MOUSEXCORR,d0
	rts


	acode
PEDSetMute
	puts	d0-d1/a0
	tst.w	d0
	beq.s	.out
	tst.w	d1
	bne.s	.out
	subq.w	#1,d0
	subq.w	#1,d1

	bsr	GetActualPattEd
	add.w	PATTED_CRSRX(a0),d0
	bsr	MuteTrack
	move.b	#FALSE,Patted_MoveCrsr

.exit	gets	d0-d1/a0
	rts
.out	move.b	#TRUE,Patted_MoveCrsr
	bra.s	.exit

	acode
PEDSetCrsrOffset
	puts	d0-d1/a0
	tst.w	d0
	beq.s	.scrollleft
	tst.w	d1
	beq.s	.scrollup
	subq.w	#1,d0
	subq.w	#1,d1
	bsr	GetActualPattEd
	jsr	PatEdCrsrOff
	movem.w	d0-d1,PATTED_CRSRXOFFSET(a0)
	jsr	PatEdCrsrOn
	bsr	DrawEventStatus
.exit	gets	d0-d1/a0
	rts
.settab
.scrollleft
	bsr	CrsrLeft
	bra.s	.exit
.setmute
.scrollup
	bsr	CrsrUp
	bra.s	.exit


;CheckMouseTab
;		bra.s	CheckPatMouse_X
;		tst.w	d1
;		bmi.s	CheckPatMouse_X
;		andi.l	#$ffff,d1
;		divu	FONT_H,d1
;		move.w	d1,d2
;		add.w	PATTED_CRSRY(a2),d1
;		move.w	d1,d0
;		jsr	SetTabulator
;		move.w	d2,d0
;		jsr	PatEdDrawLineN
;	bra.s	CheckPatMouse_X

	acode
ConvertMouseXYtoPEDXY
	puts	d2-d3/a0-a1/a5
	bsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit

	bsr	GetActualPattEd
	andi.l	#$ffff,d0
	andi.l	#$ffff,d1

	sub.w	PATTED_EDITXYWH(a0),d0
	moveq	#3,d2
	mulu	FONT_W,d2
	sub.w	d2,d0
	add.w	PATTED_NOTEW(a0),d0

	divu	PATTED_NOTEW(a0),d0
	cmp.w	PATTED_DISPNUMBTRACKS(a0),d0
	bls.s	.wok
	move.w	PATTED_DISPNUMBTRACKS(a0),d0
.wok
	sub.w	PATTED_EDITXYWH+2(a0),d1
	divu	PATTED_NOTEH(a0),d1
	cmp.w	PATTED_DISPNUMBLINES(a0),d1
	bls.s	.hok
	move.w	PATTED_DISPNUMBLINES(a0),d1
.hok

.exit	andi.l	#$ffff,d0
	andi.l	#$ffff,d1
	gets	d2-d3/a0-a1/a5
	rts


;--- ASSIST STATUS ---


NGRedrawStatusText	;V1.0
			;Update of Assist Status Line
	BGN
	lea.l	NGWin_Info(PC),a6
	move.l	NGWI_StatusText(a6),a0
	move.l	a0,NGWI_OldStatusText(a6)
	cmp.l	#0,a0
	beq.s	.exit
	move.l	#"INF2",d0
	bsr	NGODrawText
.exit	RET


NGSetStatusText	;V1.0
		;I(A0L)(TEXT)
	BGN
	lea.l	NGWin_Info(PC),a6
	move.l	a0,NGWI_StatusText(a6)
	cmp.l	NGWI_OldStatusText(a6),a0
	beq.s	.exit

	move.l	a0,NGWI_OldStatusText(a6)
	cmp.l	#0,a0
	beq.s	.exit

	move.l	#"WINC",d0
	move.l	#"C002",d1
	bsr	NGRClearAreaID

	move.l	#"INF2",d0
	bsr	NGODrawText
.exit	RET


;--- NG GUI RENDER SYSTEM -----------------------------------------------


NGWI_ActiveWindowAdr	EQU	0			;ADR of NGWPtr
NGWI_ActiveGad		EQU	4

NGWI_LightPen		EQU	8			;PEN Ids
NGWI_DarkPen		EQU	10
NGWI_SpecialPen		EQU	12
NGWI_BackPen		EQU	14

NGWI_GadFontW		EQU	NGWI_LightPen+(16*2)	;WORD
NGWI_GadFontH		EQU	NGWI_GadFontW+2		;WORD
NGWI_GadFontBase	EQU	NGWI_GadFontH+2		;WORD
NGWI_GadAreaSpacingXY	EQU	NGWI_GadFontBase+4	;2xWORD

NGWI_SmallDistX		EQU	NGWI_GadAreaSpacingXY+4	;WORD
NGWI_SmallDistY		EQU	NGWI_SmallDistX+2

NGWI_AreaFixWH		EQU	NGWI_SmallDistX+4	;WORD XY CORRECTION
NGWI_AreaDistWH		EQU	NGWI_AreaFixWH+4
NGWI_AreaInnerWH	EQU	NGWI_AreaDistWH+4	;BODY CORRECTION

NGWI_ActiveAreaAdr	EQU	NGWI_AreaInnerWH+4
NGWI_ActiveGadAdr	EQU	NGWI_ActiveAreaAdr+4	;GADGET UNTER DER MOUSE
NGWI_OldStatusText	EQU	NGWI_ActiveGadAdr+4
NGWI_StatusText		EQU	NGWI_OldStatusText+4
NGWI_ActionDelay	EQU	NGWI_StatusText+4	;LONG , neg = do action
NGWI_AnimateGadAdr	EQU	NGWI_ActionDelay+4	;GADGET DAS In ACTION IST
NGWI_ActualValue	EQU	NGWI_AnimateGadAdr+4	;Wert des Aktuellen Sliders in Prozent

NGWI_VERIFYJSR		EQU	NGWI_ActualValue+4	;0= OFF
NGWI_VERIFYXYWH		EQU	NGWI_VERIFYJSR+4	;4x WORD
NGWI_VERIFYUNITS	EQU	NGWI_VERIFYXYWH+8	;WORD Anzahl Unterteilungen
NGWI_VERIFYVALUE	EQU	NGWI_VERIFYUNITS+4	;WORD Aktueller Wert
NGWI_VERIFYOLDVALUE	EQU	NGWI_VERIFYVALUE+2	;WORD alter Wert

			acode
NGActualAreaBodyXYWH	dc.w	0,0,0,0		;INNER BODY XYWH

NGWin_Info		dc.l	0
			dc.l	0
			dc.w	2,1,3,0	;PEN 1-16
			dc.w	0,0,0,0
			dc.w	0,0,0,0
			dc.w	0,0,0,0

			dc.w	6,8,6,8	;FONTW,H,BASE,SPACEING
			dc.w	6,2

			dc.w	2,2
			dc.w	4,12	;AREA FIX H,W
			dc.w	2,2	;AREA DISTANCE
			
			blk.l	100,0



NGArea_Active	EQU	0			;BYTE TRUE/FALSE
NGArea_ID	EQU	4			;0=LAST, LONG
NGArea_FULLXYWH	EQU	16			;WORD, BODY + BORDERs
NGArea_XYWH	EQU	24			;WORD, BODY
NGArea_Text	EQU	NGArea_XYWH+8
NGArea_TextEnd	EQU	NGArea_Text+4
NGArea_WH	EQU	NGArea_TextEnd+4	;2x LONG TEMP
NGArea_MaxH	EQU	NGArea_WH+8		;1x LONG TEMP
NGArea_RP	EQU	NGArea_MaxH+4
NGArea_NGWIN	EQU	NGArea_RP+4

NGArea_SIZEOF	EQU	NGArea_NGWIN+4



NGSetGadBoolOff
	puts	d1
	moveq	#FALSE,d1
	bsr.b	NGSetGadBool
	gets	d1
	rts
NGSetGadBoolOn
	puts	d1
	moveq	#TRUE,d1
	bsr.b	NGSetGadBool
	gets	d1
	rts
NGSetGadBool:	;I(D0L,D1L)(GADID,TRUE/FALSE)
	BGN
	jsr	NGFindGadID
	cmp.l	#0,a0
	beq.s	.exit
	move.l	NGGAD_GadDefPTR(a0),a1
	move.l	NGGAD_Text(a0),a2

	;--- TOOGLE ON ---
	move.b	#"+",NGGAD_GadCodeB+2(a0)
	move.b	#"+",NGGADDEF_ON(a1)
	cmpi.b	#TRUE,d1
	beq.s	.do

	;--- TOOGLE OFF ---
	move.b	#"-",NGGAD_GadCodeB+2(a0)
	move.b	#"-",NGGADDEF_ON(a1)
.do	move.l	a2,a0
	bsr	NGObjectRedraw
.exit	RET




	acode
;ConvertDecWord3Char	;V1.0
	;I(D0L)(VALUE)
	;O(A0L)(TEXT_PTR)
	;jsr	ConvertToDecWord
	;clr.b	DecWordSave+2+3
	;rts

	acode
NGODrawSignByte3Char
	puts	d0-d3/a0
	exg	d0,d2
	andi.l	#$ff,d0
	jsr	ConvertToSignDecByte
	move.l	SignDecByte_TXT,d3
	clr.b	d3
	move.l	d3,.txt
	move.l	d2,d0
	lea	.txt,a0
	bsr	NGObjectRedraw
	gets	d0-d3/a0
	rts
.txt	dc.b	"---",0


	acode
NGODrawDecWord3Char	;V1.0
			;I(D0L,D2W)(NGGAD ID,VALUE)
	BGN
	exg	d0,d2
	lea.l	DecWordSave,a0
	andi.l	#$ffff,d0
	jsr	ConvertToDecWord
	move.l	DecWordSave+2,d3
	clr.b	d3
	move.l	d3,.txt
	move.l	d2,d0

	lea	.txt,a0
	bsr	NGObjectRedraw

	RET
.txt	dc.b	"---",0

	acode
NGODrawDecWord4Char	;V1.0
			;I(D0L,D2W)(NGGAD ID,VALUE)
	BGN
	exg	d0,d2
	lea.l	DecWordSave,a0
	andi.l	#$ffff,d0
	jsr	ConvertToDecWord
	move.l	DecWordSave+1,d3
	move.l	d3,.txt
	move.l	d2,d0
	lea	.txt,a0
	bsr	NGObjectRedraw
	RET
.txt	dc.b	"----",0

	acode
NGODrawDecWord5Char
	BGN
	lea.l	DecLongSave,a0
	exg	d0,d2
	jsr	ConvertToDecLong
	lea.l	DecLongSave+5,a0
	exg	d0,d2
	bsr	NGODrawText
	RET


	acode
NGODrawFloatValue:	;V1.0
			;I(D0L,D2W)(ID, [*100], D2W[POS/NEG]
	BGN
	move.w	d2,d4
	tst.w	d2
	bpl.s	.plus
	neg.w	d2
.plus	exg	d0,d2
	lea.l	.temp(PC),a0
	jsr	ConvertToDecWord
	move.w	3(a0),d3
	move.b	#".",3(a0)
	move.w	d3,4(a0)

	tst.w	d4
	bpl.s	.Pl2
	move.b	#"-",(a0)
.Pl2
	cmpi.b	#" ",4(a0)
	bne.s	.M3
		move.b	#"0",4(a0)
.M3	lea.l	.temp(PC),a0
	clr.b	6(a0)
	move.l	d2,d0
	bsr	NGODrawText
	RET
.temp	blk.l	4,0


	acode
NGODrawFloatValue2:	;V1.0
			;I(D0L,D2W)(ID, [*100], D2W[POS/NEG]
	BGN
	move.w	d2,d4
	tst.w	d2
	bpl.s	.plus
	neg.w	d2
.plus	exg	d0,d2
	lea.l	.temp(PC),a0
	jsr	ConvertToDecWord
	move.l	1(a0),d3
	move.b	#".",1(a0)
	move.l	d3,2(a0)
	tst.w	d4
	bpl.s	.Pl2
	move.b	#"-",(a0)
.Pl2
	cmpi.b	#" ",4(a0)
	bne.s	.z0
	move.b	#"0",4(a0)
.z0	cmpi.b	#" ",3(a0)
	bne.s	.z1
	move.b	#"0",3(a0)
.z1	cmpi.b	#" ",2(a0)
	bne.s	.z2
	move.b	#"0",2(a0)
.z2
	lea.l	.temp(PC),a0
	clr.b	6(a0)
	move.l	d2,d0
	bsr	NGODrawText
	RET
.temp	blk.l	4,0


	acode
NGODrawText
NGObjectRedraw	;I(D0L,A0L)(NGGAD ID,TEXTPTR)
	BGN
	cmp.l	#0,a0
	beq.s	.exit
	move.w	NGGadNumbTotal,d7
	subq.w	#1,d7
	bmi.s	.exit
	tst.l	NGGadInfo_PTR
	beq.s	.exit
	move.l	NGGadInfo_PTR,a2
	lea.l	-NGGADINFO_SIZEOF(a2),a2
.loop	lea.l	NGGADINFO_SIZEOF(a2),a2
	cmp.l	NGGAD_GadID(a2),d0
	beq.s	.found
	dbf	d7,.loop
.exit	RET

.found	;move.l	a0,NGGAD_Text(a2)
	tst.l	NGGAD_WinPTR(a2)
	beq.s	.exit
	tst.l	NGGAD_AreaPTR(a2)
	beq.s	.exit
	cmpi.b	#TRUE,NGGAD_On(a2)
	bne.s	.exit
	move.l	NGGAD_AreaPTR(a2),a4
	move.l	NGGAD_WinPTR(a2),a5
	cmpi.b	#TRUE,NGArea_Active(a4)
	bne.s	.exit
	move.l	NGArea_RP(a4),a1
	cmp.l	#0,a1
	beq.s	.exit
	move.l	NGGAD_ActionJSR(a2),a6
	movem.w	NGGAD_XYWH(a2),d0-d3
	cmp.l	#0,a6
	beq.s	.exit
	moveq	#NGACTION_DRAW,d4

	cmpi.b	#"-",NGGAD_GadCodeB+2(a2)
	beq.s	.nrm
	;--- GADGET BOOL ON ---
	moveq	#NGACTION_MOUSEON,d4
.nrm	jsr	(a6)
	bra.s	.exit


;	acode
;NGFindGadAtMouse
;	puts	d1/a0/a4-a6
;	move.l	NGWin_Info,a6
;	move.l	NGWI_ActiveWindowAdr(a6),a5
;	move.l	NGWI_ActiveAreaAdr(a6),a4
;	movem.w	NGWIN_MOUSE_XY(a5),d0-d1
;	bsr	NGFindGadAtXY
;	moveq	#0,d0
;	cmp.l	#0,a0
;	beq.s	.exit
;	move.l	NGGAD_GadID(a0),d0
;.exit	gets	d1/a0/a4-a6
;	rts

	acode
NGFindGadAtXY	;I(D0W,D1W,A4L,A5)(X,Y,AREA,NGWIN)
		;O(A0L)(GAD,0=N/A)
	puts	d0-d7
	;GAD MOUSE CORR
	subq.w	#MOUSEXCORR-1,d0

	cmp.l	#0,a5					;WINDOW ACTIVE
	beq.s	.notfound
	cmp.l	#0,a4
	beq.s	.notfound

	tst.l	NGGadInfo_PTR
	beq.s	.notfound
	move.l	NGGadInfo_PTR,a0
	lea.l	-NGGADINFO_SIZEOF(a0),a0

	move.w	NGGadNumbTotal,d7
	subq.w	#1,d7
	bmi.s	.notfound

	move.l	NGArea_ID(a4),d6
.loop	
	lea.l	NGGADINFO_SIZEOF(a0),a0

	cmp.l	NGGAD_AreaID(a0),d6
	bne.s	.next

	movem.w	NGGAD_XYWH(a0),d2-d5
	cmp.w	d2,d0
	blo.s	.next
	cmp.w	d3,d1
	blo.s	.next
	add.w	d2,d4
	cmp.w	d4,d0
	bhi.s	.next
	add.w	d3,d5
	cmp.w	d5,d1
	bhi.s	.next
	bra.s	.found

.next	dbf	d7,.loop
.notfound
	suba.l	a0,a0
.found	gets	d0-d7
	rts

	acode
NGFindGadID	;I(D0L)()
		;O(A0L)(GAD,0=N/A)
	puts	d7
	tst.l	NGGadInfo_PTR
	beq.s	.notfound
	move.l	NGGadInfo_PTR,a0
	lea.l	-NGGADINFO_SIZEOF(a0),a0

	move.w	NGGadNumbTotal,d7
	subq.w	#1,d7
	bmi.s	.notfound

.loop	lea.l	NGGADINFO_SIZEOF(a0),a0

	cmp.l	NGGAD_GadID(a0),d0
	beq.s	.found
.next	dbf	d7,.loop
.notfound
	suba.l	a0,a0
.found	gets	d7
	rts

	acode
NGFindAreaAtXY
		;I(D0W,D1W,A5L)(X,Y,NGWIN)
		;O(A0L)(AREA,0=NA)
	puts	d2-d7
	cmp.l	#0,a5					;WINDOW ACTIVE
	beq.s	.notfound
	lea.l	NGWIN_AREA(a5),a0
	lea.l	-NGArea_SIZEOF(a0),a0
	move.w	NGWIN_AREANUMB(a5),d7
	subq.w	#1,d7
	bmi.s	.notfound

.loop	lea.l	NGArea_SIZEOF(a0),a0
	movem.w	NGArea_XYWH(a0),d2-d5
	cmp.w	d2,d0
	blo.s	.next
	cmp.w	d3,d1
	blo.s	.next
	add.w	d2,d4
	cmp.w	d4,d0
	bhi.s	.next
	add.w	d3,d5
	cmp.w	d5,d1
	bhi.s	.next
	bra.s	.found
.next	dbf	d7,.loop
.notfound
	suba.l	a0,a0
.found	gets	d2-d7
	rts

	

	acode
NGGetArea	;V1.0
		;I(D0L,A5L)(AREAID,NGWIN)
		;O(A0L)(AREA,0=NA)
	puts	d7
	cmp.l	#0,a5					;WINDOW ACTIVE
	beq.s	.notfound
	lea.l	NGWIN_AREA(a5),a0
	lea.l	-NGArea_SIZEOF(a0),a0
	move.w	NGWIN_AREANUMB(a5),d7
	subq.w	#1,d7
	bmi.s	.notfound

.loop	lea.l	NGArea_SIZEOF(a0),a0
	cmp.l	NGArea_ID(a0),d0
	beq.s	.found
	dbf	d7,.loop
.notfound
	suba.l	a0,a0
.found	gets	d7
	rts

	acode
NGAreaIsActive	;V1.2
		;I(D0L,A5L)(NGAREA ID,NGWIN)
		;O(D0L,A0L)(TRUE/FALSE,NGAREA)
	bsr	NGGetArea
	moveq	#FALSE,d0
	cmp.l	#0,a0
	beq.s	.exit
	cmpi.b	#TRUE,NGArea_Active(a0)
	bne.s	.exit
	moveq	#TRUE,d0
.exit	rts

	acode
NGWBuildAreas	;V1.0
		;I(D0W-D3W,A0L,A5)(XYWH,TEXT,NGWIN)
	BGN
	move.l	NGWIN_RP(a5),a1
	lea.l	NGWin_Info(PC),a4

	moveq	#0,d7	;0 areas
	move.w	d7,NGWIN_AREANUMB(a5)		;RESET AREANUMB

	lea.l	NGWIN_AREA(a5),a3		;GOTO FIRST AREA
	move.l	a0,a2
	move.l	(a2)+,d4			;ID
	move.b	(a2)+,d4
	beq	.exit
	cmpi.b	#"(",d4
	bne	.err

.next	addq.l	#1,d7
	move.l	a2,NGArea_Text(a3)		;AREATITLE
	bsr	NGWSkipKomma
	tst.b	d4
	beq.s	.err
	
	move.l	NGWIN_RP(a5),NGArea_RP(a3)
	move.l	a5,NGArea_NGWIN(a3)
	move.l	a2,NGArea_TextEnd(a3)
	subq.l	#1,NGArea_TextEnd(a3)

	
	move.l	(a2),d4				;D5=ID
	move.l	d4,NGArea_ID(a3)
	lea.l	5(a2),a2			;SKIP AREA ID

	;--- WEIDTH ---
	move.l	(a2)+,d4			;AREA WH
	move.l	d4,NGArea_WH(a3)
	bsr	NGWAnalyzeNum
	move.w	d4,NGArea_WH(a3)

	;--- HEIGTH ---
	move.l	(a2)+,d4
	move.l	d4,NGArea_WH+4(a3)
	bsr	NGWAnalyzeNum
	move.w	d4,NGArea_WH+4(a3)

	;--- MAX H ---
	puts	d4
	move.l	(a2)+,d4
	move.l	d4,NGArea_MaxH(a3)
	bsr	NGWAnalyzeNum
	move.w	d4,NGArea_MaxH(a3)
	gets	d4

	;--- GOTO NEXT AREA ---
	lea.l	NGArea_SIZEOF(a3),a3
.loop	move.b	(a2)+,d4
	beq.s	.ready
	cmpi.b	#"(",d4
	bne.s	.loop
	bra.s	.next
.ready	move.w	d7,NGWIN_AREANUMB(a5)
	tst.w	d7
	beq.s	.err	;No areas error

	lea.l	NGWIN_AREA(a5),a3
	bsr	NGDrawAreas
.exit	RET
.err	ASSTXT	Areaerrtxt
	clr.w	NGWIN_AREANUMB(a5)
	bra.s	.exit

	acode
NGWAnalyzeNum	;V1.0
		;IO(D4L)
	puts	d0-d3/d5-d7
	moveq	#8,d7
	moveq	#3-1,d6

	move.l	d4,d0
	moveq	#0,d4
.loop	mulu	#10,d4
	rol.l	d7,d0
	moveq	#0,d1
	move.b	d0,d1
	subi.b	#"0",d1
	add.w	d1,d4
	dbf	d6,.loop
	;move.l	d4,d0
	;jsr	WriteAssDecLong
	gets	d0-d3/d5-d7
	rts


	acode
NGRDrawAreaID	;V1.0
		;I(D0L,D1L)(NGWIN ID,NGAREA ID)
	BGN
	bsr	NGFindArea
	cmp.l	#0,a0
	beq.s	.exit

	move.l	NGArea_NGWIN(a0),a5
	movem.w	NGArea_FULLXYWH(a0),d0-d3

	moveq	#NGRBACKCLASS_AREA,d4
	bsr	NGRDrawBack

	move.l	NGArea_Text(a0),a0
	bsr	NGRemoveComma
	bsr	NGRDrawArea0
	bsr	NGUndoRemoveComma
.exit	RET

	acode
NGRClearAreaID	;V1.0
		;I(D0L,D1L)(NGWIN ID,NGAREA ID)
	BGN
	bsr	NGFindArea
	cmp.l	#0,a0
	beq.s	.exit
	move.l	NGArea_NGWIN(a0),a5
	movem.w	NGArea_XYWH(a0),d0-d3
	moveq	#NGRBACKCLASS_AREA,d4
	bsr	NGRDrawBack
.exit	RET

	acode
NGRemoveComma	;V1.0
		;I(A0L)(TEXT)
	puts	d0/a0
.loop	move.b	(a0)+,d0
	beq.s	.exit
	cmpi.b	#",",d0
	bne.s	.loop
.exit	lea.l	-1(a0),a0
	clr.b	(a0)
	move.b	d0,tempcomma+4
	move.l	a0,tempcomma
	gets	d0/a0
	rts

	acode
NGUndoRemoveComma
	puts	a0
	move.l	tempcomma,a0
	move.b	tempcomma+4,(a0)
	gets	a0
	rts
tempcomma	dc.w	0,0,0

	acode
NGDrawAreas	;V1.0
		;I(D7W)(Anzahl Areas)
	BGN
	tst.w	d7
	beq	.exit
	move.w	d7,d6
	subq.w	#1,d7

	move.w	NGWI_AreaFixWH+2(a4),d5
	add.w	NGWI_AreaDistWH+2(a4),d5
	mulu	d5,d6
	andi.l	#$ffff,d6
	sub.w	NGWI_AreaDistWH+2(a4),d6
	sub.w	d6,d3

	bsr	NGDrawAreasSubFix
	tst.w	d3
	bpl.s	.positive
	moveq	#0,d3

.positive	moveq	#0,d5
	;--- REST H in d5 ---
	move.w	d3,d5

.loop	move.b	#FALSE,NGArea_Active(a3)
	moveq	#0,d3
	tst.w	d5
	beq	.draw

	;--- CALC AREA H ---
.sizeok	move.w	NGArea_WH+4(a3),d3		;D3W = Height

	cmpi.b	#"g",NGArea_WH+4+3(a3)
	beq	.gadh
	cmpi.b	#"%",NGArea_WH+4+3(a3)
	bne	.test

	;--- AREA H VARIABLE ---
	mulu	d5,d3
	divu	#100,d3
	tst.w	NGArea_MaxH(a3)
	beq.s	.test

	;--- MAX H berechnen ---
	puts	d0
	move.w	NGArea_MaxH(a3),d0
	cmpi.b	#"g",NGArea_MaxH+3(a3)
	bne.s	.absmaxh
	bsr	NGMuluStandardGadH
.absmaxh
	move.w	d0,d6
	gets	d0
	cmp.w	d6,d3
	bls.s	.test
	sub.w	d6,d3
	;--- AREA REST H ERHOEHEN ---
	add.w	d3,d5
	add.w	d3,d5
	;--- NEUE H ---
	move.w	d6,d3
	bra.s	.test
.gadh	puts	d0
	move.w	d3,d0
	bsr	NGMuluStandardGadH
	move.w	d0,d3
	gets	d0

	;--- CHECK AREA SIZE AGAIN ---
.test	subq.w	#2,d3				;QUICKY!!!
	bpl.s	.pos2
	moveq	#0,d3
	bra.s	.draw
	
.pos2	move.b	#TRUE,NGArea_Active(a3)
	addq.w	#2,d3				;QUICKY!!!

.draw	add.w	NGWI_AreaFixWH+2(a4),d3
	move.l	NGArea_Text(a3),a0
	;--- DRAW AREA ---
	puts	d4-d7

	move.l	NGArea_TextEnd(a3),a2
	move.b	(a2),d7
	clr.b	(a2)
	movem.w	d0-d3,NGArea_FULLXYWH(a3)
	bsr	NGRDrawArea0
	move.b	d7,(a2)


	;--- SAVE AREA INNER BODY SIZE ---
	movem.w	NGActualAreaBodyXYWH,d4-d7
	movem.w	d4-d7,NGArea_XYWH(a3)
	gets	d4-d7

	;--- NEXT Y  -------------------------
	add.w	d3,d1
	add.w	NGWI_AreaDistWH+2(a4),d1
	lea.l	NGArea_SIZEOF(a3),a3
	clr.l	(a3)				;OBSOLETE
	dbf	d7,.loop

.exit	RET
.testtext	dc.b	"----",0,0

	acode
NGDrawAreasSubFix
	;--- FIXE BEREICHE WEGSUB ---
	puts	d7/a3
	lea.l	-NGArea_SIZEOF(a3),a3
.loop	lea.l	NGArea_SIZEOF(a3),a3

	cmpi.b	#"g",NGArea_WH+4+3(a3)		
	beq.s	.gadh

	cmpi.b	#"a",NGArea_WH+4+3(a3)		
	bne.s	.notabs


	;--- CORRECT AREA INNER HEIGHT ---	QUICKY!!!
	addq.w	#2,NGArea_WH+4(a3)

	sub.w	NGArea_WH+4(a3),d3
	tst.w	d3
	bpl.s	.notabs
	;--- ZERO FIX AREA ---
	clr.w	NGArea_WH+4(a3)

.notabs	dbf	d7,.loop
	gets	d7/a3
	rts

.gadh	puts	d0
	move.w	NGArea_WH+4(a3),d0
	bsr	NGMuluStandardGadH
	sub.w	d0,d3
	tst.w	d3
	bpl.s	.hok
	;--- ZERO FIX AREA ---
	clr.w	NGArea_WH+4(a3)
.hok	gets	d0
	bra.s	.notabs	


	acode
NGWSkipKomma
.loop	move.b	(a2)+,d4
	beq.s	.exit
	cmpi.b	#",",d4
	bne.s	.loop
.exit	rts	

	acode
NGRDrawArea0	;V1.0
		;I(D0W-D3W,A0L,A5)(XYWH,TEXT,NGWIN)
	BGN
	move.l	NGWIN_RP(a5),a1
	lea.l	NGWin_Info(PC),a4

	;--- GET TITLE HEIGHT ---
	move.w	NGWI_AreaFixWH+2(a4),d6
	;move.w	NGWI_GadFontH(a4),d6
	;addq.w	#4,d6

	;--- BODY BORDER ----------
	bsr	NGRNrm1DrMd
	bsr	NGRLightAPen
	add.w	d6,d1
	moveq	#0,d4
	move.w	d2,d5
	sub.w	d6,d3
	bmi.s	.skipbody

	movem.w	d0-d3,NGActualAreaBodyXYWH
	addq.w	#1,NGActualAreaBodyXYWH
	addq.w	#1,NGActualAreaBodyXYWH+2
	subq.w	#2,NGActualAreaBodyXYWH+4
	subq.w	#2,NGActualAreaBodyXYWH+6

	bsr	NGRDrawBorder
	bra.s	.title

.skipbody
	clr.l	NGActualAreaBodyXYWH+4	;CLEAR W and H

.title	sub.w	d6,d1
	subq.w	#1,d6
	move.w	d6,d3
	move.w	d0,d2

	;--- TEXT BORDER ---
	bsr	NGRGetTextLen
	exg	d0,d2
	moveq	#0,d4
	addq.w	#4,d2
	bsr	NGRDrawBorder

	bsr	NGRDarkAPen
	bsr	NGRNrm0DrMd

	;--- INACTIVE AREA ---
	puts	d0-d1
	add.w	d2,d0
	move.w	d5,d2
	addq.w	#1,d2
	bsr	NGRDrawPatternA
	gets	d0-d1

	;--- TEXT ---
	add.w	NGWI_GadFontBase(a4),d1
	addq.w	#2,d0
	addq.w	#2,d1
	bsr	NGRDrawTextXY
	addq.w	#1,d0
	bsr	NGRDrawTextXY
	RET





;--- NG OBJECTS ----------------------------------------------


	acode
NGMuluStandardGadH	;V1.0
			;O(D0W)(H)
	puts	d1-d5/a0
	move.w	d0,d5
	lea.l	.txt(PC),a0
	moveq	#NGACTION_GETSIZE,d4
	bsr	NGObjectGadBut0
	addq.w	#2,d3
	mulu.w	d3,d5
	move.w	d5,d0
	addq.w	#4,d0	;fuer Area border dist Korrektur
	gets	d1-d5/a0
	rts
.txt	dc.b	0,0

	acode
NGGetStandardGadH	;V1.0
			;O(D0W)(H)
	moveq	#1,d0
	bsr	NGMuluStandardGadH
	rts

	acode
NGObjectGad	
	cmpi.b	#"T",NGGAD_GadCode+3(a2)
	beq	.text
	cmpi.b	#"B",NGGAD_GadCode+3(a2)
	beq	.button
	cmpi.b	#"V",NGGAD_GadCode+3(a2)
	beq	.valueborder
	cmpi.b	#"P",NGGAD_GadCode+3(a2)
	beq	.popup
	cmpi.b	#"S",NGGAD_GadCode+3(a2)
	beq	.slider
	bra	.text

.text	move.l	#NGObjectGadText0,NGGAD_ActionJSR(a2)
	bra	NGObjectGadText0

.button	move.l	#NGObjectGadBut0,NGGAD_ActionJSR(a2)
	bra	NGObjectGadBut0

.valueborder
	move.l	#NGObjectGadVal0,NGGAD_ActionJSR(a2)
	bra	NGObjectGadVal0
.popup
	move.l	#NGObjectGadPop0,NGGAD_ActionJSR(a2)
	bra	NGObjectGadPop0
.slider
	move.l	#NGObjectGadSlider0,NGGAD_ActionJSR(a2)
	bra.s	NGObjectGadSlider0

;--- GADGET SLIDER -----------------------------------------------


	acode
NGObjectGadSlider0
	IFNE TESTPRGB
	;ASSTXT .sl1
	ENDC
	cmpi.w	#NGACTION_DRAW,d4
	beq.s	.draw
	cmpi.w	#NGACTION_GETSIZE,d4
	beq.s	.getsize
	cmpi.w	#NGACTION_MOUSEON,d4
	beq.s	.mouseon
	cmpi.w	#NGACTION_ANIMATE,d4
	beq.s	.animate
	rts

.getsize
	puts	d4-d5/a0
	lea.l	NGWin_Info(PC),a0
	move.w	NGWI_GadFontH(a0),d3
	movem.w	NGWI_SmallDistX(a0),d4-d5
	lsl.w	#1,d5
	add.w	d5,d3
	move.w	NGWI_GadFontW(a0),d2
	mulu	#7,d2
	subq.w	#4,d2
	move.l	d2,Slider0W
	addq.w	#4,d2
	addq.w	#1,d3

	IFNE TESTPRGB
	;ASSTXT .sl2
	ENDC
	gets	d4-d5/a0
	rts

.draw	bsr	NGRDrawSlider0
	move.w	#FALSE,ClipMouseRegion+8
	IFNE TESTPRGB
	;ASSTXT .sl3
	ENDC
	rts
.mouseon 
	IFNE TESTPRGB
	ASSTXT .sl4
	ENDC
	bsr	NGRDrawSlider0MouseOn
	bsr	NGSetMouseRegion
	rts


.animate 
	IFNE TESTPRGB
	ASSTXT .sl5
	ENDC
	bsr	NGClipMouseRegion
	bsr	NGRDrawSlider0MouseOn
	rts

	IFNE TESTPRGB
.sl1	dc.b	"Slider:",0
.sl2	dc.b	"Size",0
.sl5	dc.b	"Animate",0
.sl4	dc.b	"MouseOn",0
	ENDC

	acode
NGSetMouseRegion
	move.w	#TRUE,ClipMouseRegion+8
	rts

NGClipMouseRegion
	puts	d0-d1/a0
	cmpi.w	#TRUE,ClipMouseRegion+8
	bne.s	.exit
	movem.w	NGWIN_MOUSE_XY(a5),d0-d1
	lea.l	ClipMouseRegion(PC),a0
	bsr	NGClipRegionXY
	movem.w	d0-d1,NGWIN_MOUSE_XY(a5)
.exit	gets	d0-d1/a0
	rts

NGClipRegionXY
	puts	d2-d5
	movem.w	(a0),d2-d5
	cmp.w	d2,d0
	bge.s	.xok
	move.w	d2,d0
	bra.s	.xok2
.xok	add.w	d4,d2
	cmp.w	d2,d0
	ble.s	.xok2
	move.w	d2,d0
.xok2	cmp.w	d3,d1
	bge.s	.yok
	move.w	d3,d1
	bra.s	.yok2
.yok	add.w	d5,d3
	cmp.w	d3,d1
	ble.s	.yok2
	move.w	d3,d1
.yok2	gets	d2-d5
	rts


ClipMouseRegion	dc.w	0,0,0,0
		dc.w	FALSE
Slider0W	dc.l	10


GetSliderSize
	move.l	Slider0W,d2
	lea.l	NGWin_Info(PC),a6
	move.w	NGWI_GadFontH(a6),d3
	movem.w	NGWI_SmallDistX(a6),d4-d5
	lsl.w	#1,d4
	add.w	d4,d0
	sub.w	d4,d2
	lsl.w	#1,d5
	add.w	d5,d3
	addq.w	#1,d3
	rts

NGRDrawSlider0MouseOn
	;V1.0
	;I(D0-D3,D4W,A0L,A1L,A5L)(XYWH,ACTION,TEXT,RP,NGWIN)
	BGN
	bsr	GetSliderSize
	movem.w	d0-d3,ClipMouseRegion
	subi.w	#10,ClipMouseRegion
	addi.w	#20,ClipMouseRegion+4

	move.w	NGWIN_MOUSE_XY(a5),d7
	cmp.w	oldslider,d7
	beq.s	.exit
	move.w	d7,oldslider

	bsr	NGRDrawSlider0Bak
	bsr	NGRDrawSliderButton
.exit	RET
oldslider	dc.l	0,0

	acode
NGRDrawSlider0
	;V1.0
	;I(D0-D3,D4W,A0L,A1L,A5L)(XYWH,ACTION,TEXT,RP,NGWIN)
	BGN
	bsr	GetSliderSize
	bsr	NGRDrawSlider0Bak
	move.l	(a0),d4
	bsr	NGWAnalyzeNum
	move.l	d4,d7
	mulu	Slider0W+2,d7
	divu	#100,d7	
	add.w	d0,d7
	bsr	NGRDrawSliderButtonDo
	RET

NGRDrawSlider0Bak
	BGN
	;--- BACKGROUND ---
	moveq	#NGRBACKCLASS_GAD,d4
	;moveq	#NGRBACKCLASS_AREA,d4
	add.w	NGWI_GadFontW(a6),d2
	bsr	NGRDrawBack
	;--- BORDER ---
	moveq	#2,d4
	bsr	NGRDrawBorder
	RET

retrigtest	dc.l	0
doretrigtest	BGN
	move.l	retrigtest,d0
	jsr	PrintHexLong
	RET


NGRDrawSliderButton
	BGN
	lea.l	NGWin_Info(PC),a6
	move.l	NGWI_ActiveWindowAdr(a6),a5
	move.w	NGWIN_MOUSE_XY(a5),d7

	bsr	NGRDrawSliderButtonDo
	sub.w	d0,d7

	mulu	#100,d7
	divu	Slider0W+2,d7
	moveq	#0,d0
	move.w	d7,d0
	addq.w	#1,d0

	moveq	#0,d7
	move.w	d0,d7

	;jsr	PrintHexLong

	jsr	ConvertToDecByte
	move.l	DecByteSave,d0
	move.b	"%",d0
	move.l	d0,(a0)


	tst.w	d7
	bpl.s	.plus
	moveq	#0,d7
.plus	cmpi.l	#100,d7
	blo.s	.ok
	moveq	#100,d7
.ok	move.l	d7,NGWI_ActualValue(a6)
	RET

NGRDrawSliderButtonDo
	BGN
	addq.w	#1,d1
	subq.w	#2,d3

	move.w	d0,d6
	addi.w	#5,d6
	cmp.w	d6,d7
	bhi.s	.xok
	move.w	d6,d7
.xok
	moveq	#0,d6
	move.w	d0,d6
	add.l	Slider0W,d6
	subi.w	#3,d6

	cmp.w	d6,d7
	bls.s	.xok2
	move.w	d6,d7
.xok2
	bsr	.fill

	move.w	d7,d0


	move.w	d0,d7
	moveq	#4,d2
	sub.w	d2,d0
	lsl.w	#1,d2
	;moveq	#NGRBACKCLASS_GAD,d4
	;moveq	#NGRBACKCLASS_GADVALUE,d4
	;moveq	#NGRBACKCLASS_GADTEXT,d4
	;bsr	NGRDrawBack
	bsr	NGRSliderButBack
	moveq	#0,d4
	bsr	NGRDrawBorder

	bsr	NGRDarkAPen
	move.w	d7,d0
	move.w	d3,d2
	addq.w	#1,d1
	subq.w	#4,d2
	bsr	NGRDrawVLine
	addq.w	#2,d0

	;move.w	#%0101010101010101,34(a1)	;PATTERN
	;bsr	NGRDrawVLine
	;move.w	#-1,34(a1)
	RET

.fill	BGN
	addq.w	#4,d0
	addq.w	#2,d1
	subq.w	#4,d3
	move.w	d7,d2
	sub.w	d0,d2
	bsr	NGRSpecialAPen
	bsr	NGRNrm0DrMd
	;bsr	NGRDrawBar
	bsr	NGRDrawPatternC
	RET

MVolSet	BGN
	lea.l	NGWin_Info(PC),a6
	move.l	NGWI_ActualValue(a6),d0
	cmp.b	SYSVOL,d0
	beq.s	.exit
	move.b	d0,SYSVOL	
	bsr	DrawMVolume
.exit	RET

MBalSet	BGN
	lea.l	NGWin_Info(PC),a6
	move.l	NGWI_ActualValue(a6),d0
	cmp.b	SYSVOL+2,d0
	beq.s	.exit
	move.b	d0,SYSVOL+2	
	bsr	DrawMBalance
.exit	RET


;--- MODIFY EVENT --------------------------------------

	IFEQ SMALLGUI


	acode
MEventMax
	BGN
.rep	moveq	#0,d0
	move.w	ModifyEventInfo+6,d0
	lea.l	EditBuf,a0
	move.l	d0,(a0)
	lea.l	EventMax_TXT,a1
	moveq	#0,d1
	move.l	#255,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit
	move.l	(a0),d0
	move.w	d0,ModifyEventInfo+6

	bsr	RecalcMEvent
	bsr	DrawMEvent
.exit	RET




	acode
SetModifyFilter
	BGN
	jsr	GetActualNotePtr
	cmp.l	#0,a0
	beq.s	.exit
	moveq	#0,d0
	move.b	NOTE_FX(a0),d0
	move.b	d0,ModifyEventInfo+MODIFY_FILTER

	lea.l	FXDraw_CONVERTAB,a0
	jsr	ProcTabValuetoLong
	cmpi.l	#-1,d0
	beq.s	.nofx
	move.l	d0,ModFtxt+14
	ASSTXT	ModFtxt
	bra.s	.exit
.nofx	ASSTXT	ModFtxt2
	bra	.exit
.exit	RET

	acode
MEventMin
	BGN
.rep	moveq	#0,d0
	move.w	ModifyEventInfo+4,d0
	lea.l	EditBuf,a0
	move.l	d0,(a0)
	lea.l	EventMin_TXT,a1
	moveq	#0,d1
	move.l	#255,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit

	move.l	(a0),d0
	move.w	d0,ModifyEventInfo+4

	bsr	RecalcMEvent
	bsr	DrawMEvent
.exit	RET
	
	acode
MEventQuantize
	BGN
.rep	moveq	#0,d0
	move.w	ModifyEventInfo+12,d0
	lea.l	EditBuf,a0
	move.l	d0,(a0)
	lea.l	EventQuant_TXT,a1
	moveq	#1,d1
	move.l	#255,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit

	move.l	(a0),d0
	move.w	d0,ModifyEventInfo+12

	bsr	RecalcMEvent
	bsr	DrawMEvent
.exit	RET
	


	acode
MEventSet	BGN
	move.w	#TRUE,ModifyEventInfo+10
	lea.l	NGWin_Info(PC),a6
	move.l	NGWI_ActualValue(a6),d0
	move.w	d0,ModifyEventInfo
	bsr	RecalcMEvent
	bsr	DrawMEventVal
.exit	RET



RedrawMEventAll
	bsr	RecalcMEvent
	bsr	DrawMEvent
	bsr	EventMDrawBools
	rts

	acode
RecalcMEvent
	puts	d0-d2
	move.w	ModifyEventInfo+4,d1
	cmp.w	ModifyEventInfo+6,d1
	bls.s	.ok
	move.l	ModifyEventInfo+4,d1
	swap	d1
	move.l	d1,ModifyEventInfo+4
.ok
	move.w	ModifyEventInfo,d0
	;--- abs(end - start) ---
	move.w	ModifyEventInfo+6,d1
	sub.w	ModifyEventInfo+4,d1
	mulu	d1,d0
	divu	#100,d0

	moveq	#0,d2
	move.w	ModifyEventInfo+12,d2

	andi.l	#$ff,d0
	divu	d2,d0
	mulu	d2,d0
	

	;--- add start ---
	add.w	ModifyEventInfo+4,d0
	move.w	d0,ModifyEventInfo+8

	gets	d0-d2
	rts

DrawMEventVal
	puts	d0-d2
	moveq	#0,d2
	move.w	ModifyEventInfo+8,d2
	cmp.w	MECache,d2
	beq.s	.exit

	move.l	#"EE86",d0		;Slider Value
	move.w	d2,MECache
	bsr	NGODrawDecWord3Char
.exit	gets	d0-d2
	rts

	acode
DrawMEvent
	puts	d0-d2
	move.w	ModifyEventInfo+8,d2
	move.w	d2,MECache
	move.l	#"EE86",d0		;Slider Value
	bsr	NGODrawDecWord3Char

	move.w	ModifyEventInfo+4,d2
	move.l	#"EE81",d0		;Min
	bsr	NGODrawDecWord3Char

	move.w	ModifyEventInfo+6,d2
	move.l	#"EE83",d0		;Max
	bsr	NGODrawDecWord3Char
	gets	d0-d2
	rts
MECache		dc.w	0,0,0
SongPlayerPos_Y	dc.w	0
	acode
DoModifyEvent	;V2.0
		;I(A2L)(ACTUAL NOTE)
	BGN
	move.w	d1,d0
	
	
	cmpi.w	#TRUE,ModifyEventInfo+10
	bne	.exit

	move.w	SongPlayerPos_Y,d1
	bsr	CheckXYInBlockRange
	cmpi.w	#TRUE,d0
	bne.s	.exit
	;cmp.w	d0,d7
	;bne	.exit

	move.w	ModifyEventInfo+8,d0
	tst.b	ModifyEventInfo+2
	beq.s	.exit


	;--- DO EVENT FILTERING ---

	move.b	NOTE_FX(a2),d6
	tst.b	d6
	bne.s	.fx
	cmpi.b	#VOLUME_MAX,NOTE_VOLUME(a2)
	bhi.s	.exit
	;bra.s	.do

	;--- IS SPECIAL FX ---
.fx	
	;tst.b	ModifyEventInfo+MODIFY_FILTER
	;beq.s	.do
	cmp.b	ModifyEventInfo+MODIFY_FILTER,d6
	bne.s	.exit

	;--- DO PATTERN REDRAW ---	
.do	jsr	PattedUpdateReset	
	cmpi.b	#1,ModifyEventInfo+2
	beq.s	.vol
	cmpi.b	#2,ModifyEventInfo+2
	beq.s	.ins
	cmpi.b	#4,ModifyEventInfo+2
	beq.s	.pit

.ins	move.b	d0,NOTE_INSTR(a2)
	bra.s	.exit
.pit	move.b	d0,NOTE_PITCH(a2)
	bra.s	.exit
.vol	
	tst.b	d6
	bne.s	.isfx
	cmpi.b	#VOLUME_MAX,d0
	bls.s	.vok
	moveq	#VOLUME_MAX,d0
	bra.s	.isfx
.vok	cmpi.b	#VOLUME_MIN,d0
	bhs.s	.isfx
	moveq	#VOLUME_MIN,d0
.isfx	move.b	d0,NOTE_VOLUME(a2)

.exit	RET

EventModifyJSR	dc.l	0

	acode
EventMSwapV	;EE89
	andi.b	#%001,ModifyEventInfo+2
	bchg	#0,ModifyEventInfo+2
	tst.b	ModifyEventInfo+2
	beq.s	.clr
	bsr	SetModifyFilter
	move.l	#DoModifyEvent,EventModifyJSR
.exit	bsr	EventMDrawBools
	rts
.clr	clr.l	EventModifyJSR
	bra.s	.exit

	acode
EventMSwapI	;EE87
	andi.b	#%010,ModifyEventInfo+2
	bchg	#1,ModifyEventInfo+2
	tst.b	ModifyEventInfo+2
	beq.s	.clr
	bsr	SetModifyFilter
	move.l	#DoModifyEvent,EventModifyJSR
.exit	bsr	EventMDrawBools
	rts
.clr	clr.l	EventModifyJSR
	bra.s	.exit

	acode
EventMSwapP	;EE88
	andi.b	#%100,ModifyEventInfo+2
	bchg	#2,ModifyEventInfo+2
	tst.b	ModifyEventInfo+2
	beq.s	.clr
	bsr	SetModifyFilter
	move.l	#DoModifyEvent,EventModifyJSR
.exit	bsr	EventMDrawBools
	rts
.clr	clr.l	EventModifyJSR
	bra.s	.exit

EventMDrawBools
	BGN
	moveq	#FALSE,d1
	btst	#0,ModifyEventInfo+2
	beq.s	.off1
	moveq	#TRUE,d1
.off1	move.l	#"EE89",d0
	jsr	NGSetGadBool

	moveq	#FALSE,d1
	btst	#1,ModifyEventInfo+2
	beq.s	.off2
	moveq	#TRUE,d1
.off2	move.l	#"EE88",d0
	jsr	NGSetGadBool

	moveq	#FALSE,d1
	btst	#2,ModifyEventInfo+2
	beq.s	.off3
	moveq	#TRUE,d1
.off3	move.l	#"EE87",d0
	jsr	NGSetGadBool
	RET

MODIFY_FILTER	EQU	14

ModifyEventInfo	dc.w	0,0	;+ 0,2 Event, Type
		dc.w	0,100	;+ 4,6 Min, Max
		dc.w	0	;+ 8   Converted Value
		dc.w	FALSE	;+ 10  Do Convert
		dc.w	1	;+ 12  Quantize
		dc.b	0,0	;+ 14  Event Filter
	ENDC



MPitMax
	BGN
	move.l	#"050%",MTuneDef
	move.w	#50,MTune
	jsr	SetAudioPeriod

	move.l	#"SY3d",d0
	lea.l	MTuneDef,a0
	bsr	NGObjectRedraw
	RET	

MPitSet	BGN
	lea.l	NGWin_Info(PC),a6
	move.l	NGWI_ActualValue(a6),d0
	cmp.w	MTune,d0
	beq.s	.exit
		move.w	d0,MTune
		jsr	SetAudioPeriod
.exit	RET




MVolMax	
	BGN
	move.l	#"100%",MVolDef
	move.l	#"SY3b",d0
	lea	MVolDef,a0
	bsr	NGObjectRedraw
	move.b	#100,SYSVOL
	bsr	DrawMVolume
	RET

MBalMax	BGN
	move.l	#"050%",MBalDef
	move.l	#"SY3c",d0
	lea.l	MBalDef,a0
	bsr	NGObjectRedraw
	move.b	#50,SYSVOL+2
	bsr	DrawMBalance
	RET


;--- GADGET POPUP -----------------------------------------------


NGObjectGadPop0
	cmpi.w	#NGACTION_DRAW,d4
	beq.s	.draw
	cmpi.w	#NGACTION_GETSIZE,d4
	beq.s	.getsize
	cmpi.w	#NGACTION_MOUSEON,d4
	beq.s	.mouseon
	;cmpi.w	#NGACTION_ANIMATE,d4
	;beq.s	.animate
	rts

.getsize	puts	d0/d4-d5/a0
	bsr	NGRGetTextLenC
	move.w	d0,d2
	lea.l	NGWin_Info(PC),a0
	move.w	NGWI_GadFontH(a0),d3
	;move.w	NGWI_GadFontW(a0),d4
	;lsr.w	#1,d4
	;add.w	d4,d2
	;add.w	NGWI_GadFontW(a0),d2
	movem.w	NGWI_SmallDistX(a0),d4-d5
	lsl.w	#2,d4
	add.w	d4,d2
	lsl.w	#1,d5
	add.w	d5,d3
	subq.w	#1,d2
	gets	d0/d4-d5/a0
	rts
.draw	bsr	NGRDrawPop0
	rts
.mouseon bsr	NGRDrawPopMouseOn
	rts
.animate rts


NGRDrawPopMouseOn
	;V1.0
	;I(D0-D3,D4W,A0L,A1L,A5L)(XYWH,ACTION,TEXT,RP,NGWIN)
	puts	d0-d5/a6
	move.w	d0,d2
	bsr	NGRGetTextLenC
	exg	d0,d2
	lea.l	NGWin_Info(PC),a6
	move.w	#-1,NGWI_VERIFYOLDVALUE(a6)
	movem.w	NGWI_SmallDistX(a6),d4-d5
	lsl.w	#1,d4
	lsl.w	#1,d5
	add.w	d4,d0
	add.w	d4,d2
	addq.w	#2,d2
	move.w	NGWI_GadFontH(a6),d3
	add.w	d5,d3
	move.w	NGWI_SmallDistX+2(a6),d5
	movem.w	d0-d1,.popxy

	clr.w	NGWI_VERIFYUNITS(a6)
	jsr	NGRNrm0DrMd

.nextgad
	lea.l	1(a0),a0
	bsr	.obj1
	addq.w	#1,NGWI_VERIFYUNITS(a6)
	exg	d0,d7
	bsr	NGRGetLenC
	tst.w	d0
	beq.s	.exit
	exg	d0,d7
	lea.l	1(a0,d7.w),a0
	tst.b	-1(a0)
	beq.s	.exit
	bra.s	.nextgad

.exit	sub.w	.popxy+2,d1
	move.w	d1,d3
	move.w	.popxy+2,d1

	movem.w	d0-d3,NGWI_VERIFYXYWH(a6)
	move.l	#NGRAnimatePop0,NGWI_VERIFYJSR(a6)
	bsr	NGRDarkAPen
	subq.w	#1,d0
	subq.w	#1,d1
	addq.w	#3,d2
	addq.w	#3,d3
	bsr	NGRDrawUniBorderFast
	gets	d0-d5/a6
	rts

.obj1	puts	d0-d4
	addq.w	#2,d3
	cmpi.b	#"+",-1(a0)
	beq.s	.selected

	;--- NOT SELECTED ---
	moveq	#NGRBACKCLASS_AREA,d4
	bsr	NGRDrawBack
	;bsr	NGRDarkAPen
	;jsr	NGRDrawPatternC
	moveq	#NGRBORDERCLASS_DBL,d4
	bsr	NGRDrawBorder

	addq.w	#3,d0
	addq.w	#4,d1
	bsr	NGRDarkAPen
	bsr	NGRDrawTextXYGadFC

.exit2	gets	d0-d4
	add.w	d3,d1
	addq.w	#2,d1
	rts
	;--- SELECTED ---
.selected
	moveq	#NGRBACKCLASS_GADVALUE,d4
	bsr	NGRDrawBack
	;bsr	NGRBackAPen
	;jsr	NGRDrawPatternC
	moveq	#NGRBORDERCLASS_DBL,d4
	;moveq	#NGRBORDERCLASS_DWN2DARK,d4
	bsr	NGRDrawBorder
	addq.w	#3,d0
	addq.w	#4,d1
	bsr	NGRDarkAPen
	bsr	NGRDrawTextXYGadFC
	addq.w	#1,d0
	bsr	NGRDrawTextXYGadFC
	bra.s	.exit2

.popxy	dc.w	0,0

	acode
NGRDrawPop0
	;V1.0
	;I(D0-D3,D4W,A0L,A1L,A5L)(XYWH,ACTION,TEXT,RP,NGWIN)
	puts	d0-d5/a6
.nextgad
	lea.l	1(a0),a0
	cmpi.b	#"+",-1(a0)
	beq.s	.draw
	exg	d0,d7
	bsr	NGRGetLenC
	exg	d0,d7
	lea.l	1(a0,d7.w),a0
	bra.s	.nextgad

	
.draw	move.w	d0,d2
	bsr	NGRGetTextLenC
	exg	d0,d2

	lea.l	NGWin_Info(PC),a6
	clr.l	NGWI_VERIFYJSR(a6)
	movem.w	NGWI_SmallDistX(a6),d4-d5
	lsl.w	#1,d4
	lsl.w	#1,d5
	add.w	d4,d0
	add.w	d4,d2
	;addq.w	#2,d2

	move.w	NGWI_GadFontH(a6),d3
	add.w	d5,d3
	move.w	NGWI_SmallDistX+2(a6),d5

	;--- BACKGROUND ---
	;moveq	#NGRBACKCLASS_GAD,d4
	moveq	#NGRBACKCLASS_AREA,d4
	add.w	NGWI_GadFontW(a6),d2
	bsr	NGRDrawBack
	;--- BORDER ---
	moveq	#3,d4
	bsr	NGRDrawBorder

	puts	d0-d3
	add.w	d2,d0
	sub.w	NGWI_GadFontW(a6),d0
	move.w	NGWI_GadFontW(a6),d2
	subq.w	#5,d0
	addq.w	#5,d2
	bsr	NGRDrawPopIcon
	gets	d0-d3

	;--- TEXT ---
	subq.w	#2,d0
	addq.w	#3,d1
	bsr	NGRDarkAPen
	bsr	NGRDrawTextXYGadFC
	addq.w	#1,d0
	bsr	NGRDrawTextXYGadFC
	gets	d0-d5/a6
	rts

	acode
NGRAnimatePop0
	BGN
	lea.l	NGWin_Info(PC),a6
	movem.w	NGWI_VERIFYXYWH(a6),d0-d3
	move.l	NGWI_ActiveWindowAdr(a6),a5
	move.l	NGWIN_RP(a5),a1
	cmp.l	#0,a5
	beq	.exit
	cmp.l	#0,a1
	beq	.exit
	
	;--- WERT BERECHNEN ---
	moveq	#0,d5
	move.w	d3,d5
	divu	NGWI_VERIFYUNITS(a6),d5
	move.w	NGWIN_MOUSE_XY+2(a5),d6
	sub.w	d1,d6
	bpl.s	.ok
	moveq	#0,d6
.ok	andi.w	#$ffff,d6
	divu	d5,d6
	cmp.w	NGWI_VERIFYUNITS(a6),d6
	blo.s	.ok2
	move.w	NGWI_VERIFYUNITS(a6),d6
	subq.w	#1,d6
.ok2	puts	d0

	moveq	#0,d0
	move.w	d6,d0
	move.l	NGWI_AnimateGadAdr(a6),a0
	cmp.l	#0,a0
	beq.s	.nodraw

	;--- WERT IN GADGET SELBER SPEICHERN ---
	move.l	d0,NGGAD_VALUE(a0)
	cmp.w	NGWI_VERIFYOLDVALUE(a6),d0
	beq.s	.nodraw
	moveq	#NGACTION_MOUSEON,d4
	bsr	NGSetPopGadSelection
	move.w	d0,NGWI_VERIFYOLDVALUE(a6)
.nodraw	gets	d0


	;--- UMLAUF ANIMIEREN ---
	subq.w	#2,.timer
	bpl.s	.exit
	move.w	#2,.timer
	subq.w	#2,d0
	subq.w	#2,d1
	addq.w	#5,d2
	addq.w	#5,d3
	bsr	NGRNrm0DrMd
	bsr	NGRLightAPen
	movem.w	d0-d3,UmlaufRegion
	bsr	NGRDrawUniBorderFast
	move.w	.pattern,d6
	ror.w	#1,d6
	move.w	d6,.pattern
	move.w	d6,34(a1)
	bsr	NGRDarkAPen
	bsr	NGRDrawUniBorder
	move.w	#-1,34(a1)
.exit	RET
.timer		dc.w	0
.pattern	dc.w	%1111000011110000

NGSetPopGadID:	;V1.0
		;I(D0L,D2L)(NG GADID,VALUE)
	BGN
	bsr	NGFindGadID
	cmp.l	#0,a0
	beq.s	.exit
	moveq	#NGACTION_DRAW,d4
	move.l	d2,d0
	bsr	NGSetPopGadSelection
.exit	RET
	

DrawSequenceType:	;V1.0 NG
	BGN
	lea.l	Test_SONG,a3
	move.l	SONG_ACTUALSEQ(a3),a3
	moveq	#0,d2
	move.w	SEQUENCE_INFO(a3),d3
	beq.s	.DrawSeqType
	moveq	#1,d2
	cmpi.w	#SEQINFO_ENDSONG,d3
	bne.s	.DrawSeqType
	moveq	#2,d2
.DrawSeqType
	move.l	#"SE2A",d0
	bsr	NGSetPopGadID
	RET


NGSetPopGadSelection	;I(D0L,D4L,A0L)(VALUE,ACTIONTYPE,NG GAD)
	BGN
	cmp.l	#0,a0
	beq.s	.exit

	move.l	a0,a2
	move.l	NGGAD_TextB(a2),a0
	cmp.l	#0,a0			;ENFORCER HIT FIXED
	beq.s	.exit

	move.w	d0,d6
	moveq	#0,d7
.nextgad
	move.b	#"-",(a0)
	cmp.w	d7,d6
	bne.s	.next
	move.b	#"+",(a0)
.next	addq.w	#1,d7
	lea.l	1(a0),a0
	bsr	NGRGetLenC
	tst.w	d0
	beq.s	.exit
	lea.l	1(a0,d0.w),a0
	tst.b	-1(a0)
	beq.s	.exit2
	bra.s	.nextgad
.exit2	movem.w	NGGAD_XYWH(a2),d0-d3
	move.l	NGGAD_WinPTR(a2),a5
	move.l	NGWIN_RP(a5),a1
	move.l	NGGAD_TextB(a2),a0
	bsr	NGObjectGadPop0
.exit	RET

;--- GADGET BUTTON ------------------------------------------------

	acode
NGObjectGadBut0
	cmpi.w	#NGACTION_DRAW,d4
	beq.s	.draw
	cmpi.w	#NGACTION_GETSIZE,d4
	beq.s	.getsize
	cmpi.w	#NGACTION_MOUSEON,d4
	beq.s	.mouseon
	cmpi.w	#NGACTION_ANIMATE,d4
	beq.s	.animate
	rts

.getsize	puts	d0/d4-d5/a0
	bsr	NGRGetTextLen
	move.w	d0,d2
	lea.l	NGWin_Info(PC),a0
	move.w	NGWI_GadFontH(a0),d3
	movem.w	NGWI_SmallDistX(a0),d4-d5
	lsl.w	#2,d4
	add.w	d4,d2
	lsl.w	#1,d5
	add.w	d5,d3
	subq.w	#1,d2
	gets	d0/d4-d5/a0
	rts
.draw	bsr	NGRDrawGadget0
	rts
.mouseon
	bsr	NGRDrawGadget0On
	rts
.animate
	bsr	NGRDrawGadget0Animate
	rts




NGRDrawGadget0Animate	;V1.0
	;V1.0
	;I(D0-D3,D4W,A0L,A1L,A5L)(XYWH,ACTION,TEXT,RP,NGWIN)
	puts	d0-d5/a6

	move.w	d0,d2
	bsr	NGRGetTextLen
	exg	d0,d2
	lea.l	NGWin_Info(PC),a6
	movem.w	NGWI_SmallDistX(a6),d4-d5
	lsl.w	#1,d4
	lsl.w	#1,d5
	add.w	d4,d0
	add.w	d4,d2
	addq.w	#2,d2

	move.w	NGWI_GadFontH(a6),d3
	add.w	d5,d3
	move.w	NGWI_SmallDistX+2(a6),d5

	cmpi.w	#TRUE,Shift_KEY
	beq.s	.fast

	subq.w	#1,.timer
	bpl.s	.exit
	move.w	#1,.timer

	move.w	.pattern,d6
	ror.w	#1,d6
	bra.s	.slow

.fast	move.w	.pattern,d6
	ror.w	#1,d6

	;bsr	NGRNrm0DrMd
.slow	bsr	NGRNrm0DrMd
	bsr	NGRDrawBorder

	move.w	d6,.pattern
	move.w	d6,34(a1)

	bsr	NGRDarkAPen
	bsr	NGRDrawUniBorder

	move.w	#-1,34(a1)

.exit	gets	d0-d5/a6
	rts

.timer		dc.w	0
.pattern	dc.w	%1100111000111000


NGRDrawGadget0	;V1.0
	;V1.0
	;I(D0-D3,D4W,A0L,A1L,A5L)(XYWH,ACTION,TEXT,RP,NGWIN)
	puts	d0-d5/a6

	move.w	d0,d2
	bsr	NGRGetTextLen
	exg	d0,d2

	lea.l	NGWin_Info(PC),a6
	movem.w	NGWI_SmallDistX(a6),d4-d5
	lsl.w	#1,d4
	lsl.w	#1,d5
	add.w	d4,d0
	add.w	d4,d2
	addq.w	#2,d2

	move.w	NGWI_GadFontH(a6),d3
	add.w	d5,d3
	move.w	NGWI_SmallDistX+2(a6),d5

	;--- BACKGROUND ---
	moveq	#NGRBACKCLASS_GAD,d4
	bsr	NGRDrawBack
	;--- BORDER ---
	moveq	#3,d4
	bsr	NGRDrawBorder

	;--- TEXT ---
	addq.w	#3,d0
	addq.w	#3,d1
	bsr	NGRDarkAPen
	bsr	NGRDrawTextXYGadF
	addq.w	#1,d0
	bsr	NGRDrawTextXYGadF
	gets	d0-d5/a6
	rts

NGRDrawGadget0On	;V1.0
	;V1.0
	;I(D0-D3,D4W,A0L,A1L,A5L)(XYWH,ACTION,TEXT,RP,NGWIN)
	puts	d0-d5/a6

	move.w	d0,d2
	bsr	NGRGetTextLen
	exg	d0,d2

	lea.l	NGWin_Info(PC),a6
	movem.w	NGWI_SmallDistX(a6),d4-d5
	lsl.w	#1,d4
	lsl.w	#1,d5
	add.w	d4,d0
	add.w	d4,d2
	addq.w	#2,d2

	move.w	NGWI_GadFontH(a6),d3
	add.w	d5,d3
	move.w	NGWI_SmallDistX+2(a6),d5

	;--- BACKGROUND ---
	moveq	#NGRBACKCLASS_GADLIGHT,d4
	bsr	NGRDrawBack
	;--- BORDER ---
	moveq	#4,d4
	bsr	NGRDrawBorder

	;--- TEXT ---
	addq.w	#5,d0
	addq.w	#3,d1
	;bsr	NGRLightAPen
	;bsr	NGRDrawTextXYGadF

	bsr	NGRDarkAPen
	subq.w	#1,d0
	bsr	NGRDrawTextXYGadF
	subq.w	#1,d0
	bsr	NGRDrawTextXYGadF
	gets	d0-d5/a6
	rts


NGObjectGadText0
	;V1.0
	;I(D0-D3,D4W,A0L,A1L,A5L)(XYWH,ACTION,TEXT,RP,NGWIN)
	cmpi.w	#NGACTION_DRAW,d4
	beq.s	.draw
	cmpi.w	#NGACTION_GETSIZE,d4
	beq.s	.getsize

	cmpi.w	#NGACTION_MOUSEON,d4
	beq.s	.mouseon
	rts
.getsize	puts	d0/a0
	bsr	NGRGetTextLen
	move.w	d0,d2

	lea.l	NGWin_Info(PC),a0
	add.w	NGWI_SmallDistX(a0),d2
	add.w	NGWI_SmallDistX(a0),d2
	;add.w	NGWI_SmallDistX(a0),d2
	move.w	NGWI_GadFontH(a0),d3
	addq.w	#4,d3
	gets	d0/a0
	rts

.draw	BGN
	puts	d0
	bsr	NGRGetTextLen
	move.w	d0,d2
	gets	d0

	lea.l	NGWin_Info(PC),a6
	add.w	NGWI_SmallDistX(a6),d0
	add.w	NGWI_SmallDistX(a6),d0
	addq.w	#2,d1
	addq.w	#2,d0

	subq.w	#2,d2
	move.w	NGWI_GadFontH(a6),d3
	moveq	#NGRBACKCLASS_GADTEXT,d4
	bsr	NGRDrawBack

	bsr	NGRDarkAPen
	bsr	NGRDrawTextXYGadF
	RET

.mouseon
	rts
	;BGN
	;lea.l	NGWin_Info(PC),a6
	;add.w	NGWI_SmallDistX(a6),d0
	;add.w	NGWI_SmallDistX(a6),d0
	;addq.w	#2,d1
	;bsr	NGRLightAPen
	;bsr	NGRDrawTextXYGadF
	;RET




NGObjectGadVal0
	cmpi.w	#NGACTION_DRAW,d4
	beq.s	.draw
	cmpi.w	#NGACTION_GETSIZE,d4
	beq.s	.getsize
	cmpi.w	#NGACTION_MOUSEON,d4
	beq.s	.mouseon
	rts

.getsize	puts	d0/d4-d5/a0
	bsr	NGRGetTextLen
	move.w	d0,d2
	lea.l	NGWin_Info(PC),a0
	move.w	NGWI_GadFontH(a0),d3
	movem.w	NGWI_SmallDistX(a0),d4-d5
	lsl.w	#2,d4
	add.w	d4,d2
	lsl.w	#1,d5
	add.w	d5,d3
	gets	d0/d4-d5/a0
	rts

.draw	bsr	NGRDrawGadVal0
	rts

.mouseon
	bsr	NGRDrawGadget0On
	rts


NGRDrawGadVal0	;V1.0
	;V1.0
	;I(D0-D3,D4W,A0L,A1L,A5L)(XYWH,ACTION,TEXT,RP,NGWIN)
	puts	d0-d5/a6

	move.w	d0,d2
	bsr	NGRGetTextLen
	exg	d0,d2

	lea.l	NGWin_Info(PC),a6
	movem.w	NGWI_SmallDistX(a6),d4-d5
	lsl.w	#1,d4
	lsl.w	#1,d5
	add.w	d4,d0
	add.w	d4,d2
	addq.w	#3,d2
	addq.w	#1,d5

	move.w	NGWI_GadFontH(a6),d3
	add.w	d5,d3
	move.w	NGWI_SmallDistX+2(a6),d5

	;--- BACKGROUND ---
	moveq	#NGRBACKCLASS_GADVALUE,d4
	bsr	NGRDrawBack
	;--- BORDER ---
	moveq	#NGRBORDERCLASS_DBL2,d4
	bsr	NGRDrawBorder

	;--- TEXT ---
	addq.w	#3,d0
	addq.w	#3,d1
	bsr	NGRNrm0DrMd
	;bsr	NGRDarkAPen
	;bsr	NGRLightAPen

	bsr	NGRBackAPen
	bsr	NGRDrawTextXYGadF
	addq.w	#2,d0
	
	bsr	NGRDarkAPen
	bsr	NGRDrawTextXYGadF
	subq.w	#1,d0
	;bsr	NGRDarkAPen

	bsr	NGRDrawTextXYGadF
	gets	d0-d5/a6
	rts


	acode
NGRDrawTextXYGadFC:	;V1.0 (GADGET FONT)
	puts	d1/a4
	lea.l	NGWin_Info(PC),a4
	add.w	NGWI_GadFontBase(a4),d1
	bsr	NGRDrawTextCXY
	gets	d1/a4
	rts

	acode
NGRDrawTextCXY:	;V1.0
		;I(D0W,D1W,A0L,A1L)(XY,TEXT,RP)
	puts	d0-d1/a0-a1/a6
	;move.l	GFXBASE,a6
	puts	d0-d1/a0-a1
	;jsr	Move(a6)
	CALLGFX Move
	gets	d0-d1/a0-a1

	bsr	NGRGetLenC
	tst.w	d0
	beq.s	.exit
	;move.l	GFXBASE,a6
	;jsr	Text(a6)
	CALLGFX Text
.exit	gets	d0-d1/a0-a1/a6
	rts

	acode
NGRDrawTextXYGadF:	;V1.0 (GADGET FONT)
	puts	d1/a4
	lea.l	NGWin_Info(PC),a4
	add.w	NGWI_GadFontBase(a4),d1
	bsr	NGRDrawTextXY
	gets	d1/a4
	rts

	acode
NGRDrawTextXY:	;V1.0
		;I(D0W,D1W,A0L,A1L)(XY,TEXT,RP)
	puts	d0-d1/a0-a1/a6
	;move.l	GFXBASE,a6
	puts	d0-d1/a0-a1
	;jsr	Move(a6)
	CALLGFX Move
	gets	d0-d1/a0-a1

	bsr	NGRGetLen
	tst.w	d0
	beq.s	.exit
	;move.l	GFXBASE,a6
	;jsr	Text(a6)
	CALLGFX Text
.exit	gets	d0-d1/a0-a1/a6
	rts

	acode
NGRDrawText	;V1.0
		;I(D0W,D1W,A0L,A1L)(XY,TEXT,RP)
	puts	d0-d1/a0-a1/a6
	bsr	NGRGetLen
	tst.w	d0
	beq.s	.exit
	;move.l	GFXBASE,a6
	;jsr	Text(a6)
	CALLGFX Text
.exit	gets	d0-d1/a0-a1/a6
	rts

	acode
NGRGetLen	;V1.0
		;I(A0L)
		;O(D0W)
	puts	d1/a0
	move.l	a0,d1
.loop	tst.b	(a0)+
	bne.s	.loop
	move.l	a0,d0
	sub.w	d1,d0
	subq.w	#1,d0
	gets	d1/a0
	rts

	acode
NGRGetLenC	;V1.0
	puts	d1/a0
	move.l	a0,d1
.loop	cmpi.b	#",",(a0)
	beq.s	.exit
	tst.b	(a0)
	beq.s	.exit
	lea.l	1(a0),a0
	bra.s	.loop

.exit	move.l	a0,d0
	sub.w	d1,d0
	;subq.w	#1,d0
	gets	d1/a0
	rts


	acode
NGRGetTextLen	;V1.0
		;I(A0L)(TEXT)
		;O(D0L)(W)
	puts	d1/a0
	move.l	a0,d1
.loop	tst.b	(a0)+
	bne.s	.loop
	move.l	a0,d0
	sub.w	d1,d0
	subq.w	#1,d0
	lea.l	NGWin_Info(PC),a0
	move.w	NGWI_GadFontW(a0),d1
	mulu	d1,d0
	gets	d1/a0
	rts

	acode
NGRGetTextLenC	;V1.0
		;I(A0L)(TEXT)
		;O(D0L)(W)
		;auch bis Komma
	puts	d1/a0
	bsr	NGRGetLenC
	lea.l	NGWin_Info(PC),a0
	move.w	NGWI_GadFontW(a0),d1
	mulu	d1,d0
	gets	d1/a0
	rts

	;--- BACKGROUND CLASS ---

NGRBACKCLASS_MAX	EQU	6-1

NGRBACKCLASS_WIN	EQU	0
NGRBACKCLASS_AREA	EQU	1
NGRBACKCLASS_GAD	EQU	2
NGRBACKCLASS_GADVALUE	EQU	3
NGRBACKCLASS_GADLIGHT	EQU	4
NGRBACKCLASS_GADTEXT	EQU	5

	acode
NGRDrawBack:	;V1.0
		;I(D0W,D1W,D2W,D3W,D4W,D5W,A5L)(XYWH,TYPE,PARAM1,NGWIN)
	tst.l	(a5)
	bne.s	.go
	rts
.go	puts	a1/a3
	cmpi.w	#NGRBACKCLASS_MAX,d4
	bhi.s	.exit
	tst.w	d2
	beq.s	.exit
	tst.w	d3
	beq.s	.exit
	move.l	NGWIN_RP(a5),a1
	lea.l	NGRBackClass(PC),a3
	move.l	(a3,d4.w*4),a3
	jsr	(a3)
.exit	gets	a1/a3
	rts
NGRBackClass	dc.l	NGRDrawWindowBack,NGRDrawAreaBack,NGRGadBack,NGRGadValueBack,NGRGadBackB,NGRGadTextBack

NGRDrawWindowBack	;V1.0
		;I(D0W,D1W,D2W,D3W,D4W,D5W,A5L)(XYWH,RP,NGWIN)
	CHECKREG3 a1,NGRDrawWindowBack,.exit
	CHECKREG4 a5,NGRDrawWindowBack,.exit
	bsr	NGRNrm0DrMd
	bsr	NGRBackAPen
	bsr	NGRDrawBar
.exit	rts

NGRDrawAreaBack
	bra	NGRDrawWindowBack
NGRGadBack
	bra	NGRDrawWindowBack

NGRGadTextBack
	CHECKREG3 a1,NGRDrawWindowBack,.exit
	CHECKREG4 a5,NGRDrawWindowBack,.exit
	bsr	NGRNrm0DrMd
	bsr	NGRBackAPen
	;bsr	NGRSpecialAPen
	bsr	NGRDrawBar
	;bsr	NGRSpecialAPen
	;bsr	NGRDrawPatternB
.exit	rts

NGRGadValueBack
	CHECKREG3 a1,NGRDrawWindowBack,.exit
	CHECKREG4 a5,NGRDrawWindowBack,.exit
	bsr	NGRNrm0DrMd
	bsr	NGRBackAPen
	bsr	NGRDrawBar
	bsr	NGRSpecialAPen
	bsr	NGRDrawPatternB
.exit	rts

NGRSliderButBack
	CHECKREG3 a1,NGRDrawWindowBack,.exit
	CHECKREG4 a5,NGRDrawWindowBack,.exit
	bsr	NGRNrm0DrMd
	bsr	NGRSpecialAPen
	bsr	NGRDrawBar
	bsr	NGRDarkAPen
	bsr	NGRDrawPatternC
.exit	rts



NGRGadBackB	;GADGET ON
		;I(D0W-D3W,A1L)(XYWH,RP)
	CHECKREG3 a1,NGRDrawWindowBack,.exit
	CHECKREG4 a5,NGRDrawWindowBack,.exit
	bsr	NGRNrm0DrMd
	bsr	NGRBackAPen
	bsr	NGRDrawBar
	bsr	NGRLightAPen
	bsr	NGRDrawPatternC
.exit	rts

	acode
NGRDrawPatternB	;V1.0
		;I(D0W-D3W,A1L)(XYWH,RP)
	cmpi.b	#FALSE,FASTGFX
	beq.s	.go
	rts
.go	puts	d0-d3/a0-a1/a6
	CHECKREG3 a1,NGRDrawPattern,.exit
	tst.w	d2
	beq.s	.exit
	tst.w	d3
	beq.s	.exit
	move.w	#%0010010010010010,d7	;PATTERN
.loop	move.w	d7,34(a1)
	ror.w	#1,d7
	bsr	NGRDrawHLine
	addq.w	#1,d1
	subq.w	#1,d3
	bpl.s	.loop
	move.w	#-1,34(a1)
.exit	gets	d0-d3/a0-a1/a6
	rts

	acode
NGRDrawPatternC	;V1.0
		;I(D0W-D3W,A1L)(XYWH,RP)
	cmpi.b	#FALSE,FASTGFX
	beq.s	.go
	rts
.go	puts	d0-d3/a0-a1/a6
	CHECKREG3 a1,NGRDrawPattern,.exit
	tst.w	d2
	beq.s	.exit
	tst.w	d3
	beq.s	.exit
	move.w	#%1010101010101010,d7	;PATTERN
.loop	move.w	d7,34(a1)
	ror.w	#1,d7
	bsr	NGRDrawHLine
	addq.w	#1,d1
	subq.w	#1,d3
	bpl.s	.loop
	move.w	#-1,34(a1)
.exit	gets	d0-d3/a0-a1/a6
	rts


	acode
NGRDrawPatternA	;V1.0
		;I(D0W-D3W,A1L)(XYWH,RP)
	cmpi.b	#FALSE,FASTGFX
	beq.s	.go
	rts
.go	puts	d0-d3/a0-a1/a6
	CHECKREG3 a1,NGRDrawPattern,.exit
	tst.w	d2
	beq.s	.exit
	tst.w	d3
	beq.s	.exit

	move.l	#%10010010010010010010010010010010,d7	;Mosaic Pattern
	cmpi.b	#2,GUILook
	beq.s	.lookset

	move.l	#%10101010101010101010101010101010,d7	;Dark Pattern
	cmpi.b	#1,GUILook
	beq.s	.lookset

	move.l	#%00101101101110110110101001001010,d7	;Wild Mosaic Pattern
.lookset

.loop	move.w	d7,34(a1)
	rol.l	#1,d7
	bsr	NGRDrawHLine
	addq.w	#1,d1
	subq.w	#1,d3
	bpl.s	.loop
	move.w	#-1,34(a1)
.exit	gets	d0-d3/a0-a1/a6
	rts

NGRDrawVLine	;V1.0
		;I(D0W-D2W,A1L)(XYH,RP)
	puts	d0-d3/a0-a1/a6
	CHECKREG3 a1,NGRDrawHLine,.exit
	add.w	d1,d2
	move.w	d0,d3
	GFX	Move(a6)
	move.w	d3,d0
	move.w	d2,d1
	GFX	Draw(a6)
.exit	gets	d0-d3/a0-a1/a6
	rts


NGRDrawHLine	;V1.0
		;I(D0W-D2W,A1L)(XYW,RP)
	puts	d0-d3/a0-a1/a6
	CHECKREG3 a1,NGRDrawHLine,.exit
	add.w	d0,d2
	move.w	d1,d3
	GFX	Move(a6)
	move.w	d2,d0
	move.w	d3,d1
	GFX	Draw(a6)
.exit	gets	d0-d3/a0-a1/a6
	rts

	acode
NGRDrawBar	;V1.0
		;I(D0W-D3W,A1L)(XYWH,RP)
	puts	d0-d3/a0-a1/a6
	CHECKREG3 a1,NGRDrawBar,.exit
	tst.w	d2
	beq.s	.exit
	tst.w	d3
	beq.s	.exit
	add.w	d0,d2
	add.w	d1,d3
	GFX	RectFill(a6)
.exit	gets	d0-d3/a0-a1/a6
	rts

	;--- BORDER CLASS ---


NGRBORDERCLASS_MAX	EQU	7-1

NGRBORDERCLASS_UP	EQU	0
NGRBORDERCLASS_DWN	EQU	1
NGRBORDERCLASS_DBL	EQU	2
NGRBORDERCLASS_UP2DARK	EQU	3
NGRBORDERCLASS_UP2LIGHT	EQU	4
NGRBORDERCLASS_DWN2DARK	EQU	5
NGRBORDERCLASS_DBL2	EQU	6

	acode
NGRBorderClass	dc.l	NGRDrawUpBorder,NGRDrawDwnBorder,NGRDblBorder
		dc.l	NGRDrawUpBlackBorder,NGRDrawUpLightBorder
		dc.l	NGRDrawDwnBlackBorder,NGRDbl2Border


	acode
NGRDrawBorder:	;V1.0
		;I(D0W,D1W,D2W,D3W,D4W,D5W,A5L)(XYWH,TYPE,PARAM1,NGWIN)
	tst.l	(a5)
	bne.s	.go
	rts
.go	puts	a1/a3
	cmpi.w	#NGRBORDERCLASS_MAX,d4
	bhi.s	.exit
	tst.w	d2
	beq.s	.exit
	tst.w	d3
	beq.s	.exit
	move.l	NGWIN_RP(a5),a1
	lea.l	NGRBorderClass(PC),a3
	move.l	(a3,d4.w*4),a3
	jsr	(a3)
.exit	gets	a1/a3
	rts

	acode
NGRDblBorder	;V1.0
		;I(D0W-D3W,A1L,A5L)(XYWH,RP,NGWIN)
	puts	d0-d5/a4
	CHECKREG3 a1,NGRDblBorder,.exit
	CHECKREG4 a5,NGRDblBorder,.exit
	bsr	NGRDrawDwnBorder
	lea.l	NGWin_Info(PC),a4
	movem.w	NGWI_SmallDistX(a4),d4-d5
	add.w	d4,d0
	add.w	d5,d1
	sub.w	d4,d2
	sub.w	d4,d2
	sub.w	d5,d3
	sub.w	d5,d3
	bsr	NGRDrawUpBorder
.exit	gets	d0-d5/a4
	rts

NGRDbl2Border	;V1.0
		;I(D0W-D3W,A1L,A5L)(XYWH,RP,NGWIN)
	puts	d0-d3
	CHECKREG3 a1,NGRDblBorder,.exit
	CHECKREG4 a5,NGRDblBorder,.exit
	bsr	NGRDrawDwnBorder
	addq.w	#1,d0
	addq.w	#1,d1
	subq.w	#2,d2
	subq.w	#2,d3
	bsr	NGRDrawUpBorder
.exit	gets	d0-d3
	rts

NGRDrawDwnBlackBorder	;V1.0
	puts	d0-d3
	CHECKREG3 a1,NGRDrawUpBlackBorder,.exit
	CHECKREG4 a5,NGRDrawUpBlackBorder,.exit
	bsr	NGRDarkAPen
	bsr	NGRDrawUniBorderFast
	addq.w	#1,d0
	addq.w	#1,d1
	subq.w	#2,d2
	subq.w	#2,d3
	bsr	NGRDrawDwnBorder
.exit	gets	d0-d3
	rts

NGRDrawUpBlackBorder	;V1.0
	puts	d0-d3
	CHECKREG3 a1,NGRDrawUpBlackBorder,.exit
	CHECKREG4 a5,NGRDrawUpBlackBorder,.exit
	bsr	NGRDarkAPen
	bsr	NGRDrawUniBorderFast
	addq.w	#1,d0
	addq.w	#1,d1
	subq.w	#2,d2
	subq.w	#2,d3
	bsr	NGRDrawUpBorder
.exit	gets	d0-d3
	rts


NGRDrawUpLightBorder	;V1.0
	puts	d0-d3
	CHECKREG3 a1,NGRDrawUpBlackBorder,.exit
	CHECKREG4 a5,NGRDrawUpBlackBorder,.exit
	bsr	NGRLightAPen
	bsr	NGRDrawUniBorderFast
	addq.w	#1,d0
	addq.w	#1,d1
	subq.w	#2,d2
	subq.w	#2,d3
	bsr	NGRDrawUpBorder
.exit	gets	d0-d3
	rts


;	acode
;NGRDrawUpBorder	;V1.0
;		;I(D0W-D3W,A1L,A5L)(XYWH,RP,NGWIN)
;	puts	d0-d1
;	CHECKREG3 a1,NGRDrawUpBorder,.exit
;	CHECKREG4 a5,NGRDrawUpBorder,.exit
;	bsr	NGRLightAPen
;	add.w	d3,d1
;	jsr	GFX_Move
;	sub.w	d3,d1
;	jsr	GFX_Draw
;	add.w	d2,d0
;	jsr	GFX_Draw
;	bsr	NGRDarkAPen
;	add.w	d3,d1
;	jsr	GFX_Draw
;	sub.w	d2,d0
;	jsr	GFX_Draw
;.exit	gets	d0-d1
;	rts

	acode
NGRDrawUpBorder	;V1.0
		;I(D0W-D3W,A1L,A5L)(XYWH,RP,NGWIN)
	puts	d0-d7/a0-a2/a6
	CHECKREG3 a1,NGRDrawUpBorder,.exit
	CHECKREG4 a5,NGRDrawUpBorder,.exit
	move.l	a1,a2
	move.w	d0,d4
	move.w	d1,d5
	move.w	d2,d6
	move.w	d3,d7
	add.w	d0,d6
	add.w	d1,d7
	bsr	NGRLightAPen
	move.w	d4,d2
	move.w	d7,d3
	CALLGFX	RectFill	;left
	move.w	d4,d0
	move.w	d5,d1
	move.w	d6,d2
	move.w	d5,d3
	move.l	a2,a1
	CALLGFX	RectFill	;top
	move.w	d4,d0
	move.w	d7,d1
	move.w	d7,d3
	move.l	a2,a1
	bsr	NGRDarkAPen
	CALLGFX	RectFill	;bottom
	move.w	d6,d0
	move.w	d5,d1
	move.w	d6,d2
	move.w	d7,d3
	move.l	a2,a1
	CALLGFX	RectFill	;right
.exit	gets	d0-d7/a0-a2/a6
	rts


	acode
NGRDrawDwnBorder	;V1.0
		;I(D0W-D3W,A1L,A5L)(XYWH,RP,NGWIN)
	puts	d0-d7/a0-a2/a6
	CHECKREG3 a1,NGRDrawDwnBorder,.exit
	CHECKREG4 a5,NGRDrawDwnBorder,.exit
	move.l	a1,a2
	move.w	d0,d4
	move.w	d1,d5
	move.w	d2,d6
	move.w	d3,d7
	add.w	d0,d6
	add.w	d1,d7
	bsr	NGRDarkAPen
	move.w	d4,d2
	move.w	d7,d3
	CALLGFX	RectFill	;left
	move.w	d4,d0
	move.w	d5,d1
	move.w	d6,d2
	move.w	d5,d3
	move.l	a2,a1
	CALLGFX	RectFill	;top
	move.w	d4,d0
	move.w	d7,d1
	move.w	d7,d3
	move.l	a2,a1
	bsr	NGRLightAPen
	CALLGFX	RectFill	;bottom
	move.w	d6,d0
	move.w	d5,d1
	move.w	d6,d2
	move.w	d7,d3
	move.l	a2,a1
	CALLGFX	RectFill	;right
.exit	gets	d0-d7/a0-a2/a6
	rts


	acode
NGRDrawUniBorderFast	;V1.0
		;I(D0W-D3W,A1L,A5L)(XYWH,RP,NGWIN)
	puts	d0-d7/a0-a2/a6
	CHECKREG3 a1,NGRDrawUniBorder,.exit
	CHECKREG4 a5,NGRDrawUniBorder,.exit

	move.l	a1,a2
	move.w	d0,d4
	move.w	d1,d5
	move.w	d2,d6
	move.w	d3,d7
	add.w	d0,d6
	add.w	d1,d7
	
	move.w	d1,d3
	move.w	d6,d2
	CALLGFX	RectFill	;top

	move.l	a2,a1
	move.w	d4,d0
	move.w	d7,d1
	move.w	d6,d2
	move.w	d7,d3
	CALLGFX	RectFill	;bottom
	
	move.w	d6,d0		;right
	move.w	d5,d1
	move.l	a2,a1
	CALLGFX	RectFill

	move.l	a2,a1
	move.w	d4,d0
	move.w	d5,d1
	move.w	d4,d2
	CALLGFX	RectFill	;left

.exit	gets	d0-d7/a0-a2/a6
	rts

	acode
NGRDrawUniBorder	;V1.0
		;I(D0W-D3W,A1L,A5L)(XYWH,RP,NGWIN)
	puts	d0-d7/a0-a6
	CHECKREG3 a1,NGRDrawUniBorder,.exit
	CHECKREG4 a5,NGRDrawUniBorder,.exit
	add.w	d3,d1
	jsr	GFX_Move
	sub.w	d3,d1
	jsr	GFX_Draw
	add.w	d2,d0
	jsr	GFX_Draw
	add.w	d3,d1
	jsr	GFX_Draw
	sub.w	d2,d0
	jsr	GFX_Draw
	gets	d0-d7/a0-a6
.exit	rts


	acode
NGRRectInvert	;V1.0
		;(D0W-D3W,A1L,A5L)(XYWH,RP,NGWIN)
	tst.w	d2
	beq.s	.exit2
	tst.w	d3
	beq.s	.exit2
	puts	d0-a6

	CHECKREG3 a1,RectInvert,.exit
	;move.l	a1,a2
	;--- SET MODE ---
	bsr	NGRInvDrMd

	;--- SET APEN ---
	puts	d0
	moveq	#3,d0
	bsr	NGRenderSetAPen
	gets	d0

	;--- DRAW ---
	add.w	d0,d2
	add.w	d1,d3
	move.l	_GraphicsBase,a6
	CALLGFX	RectFill
.exit	gets	d0-a6
.exit2	rts



;--- VECTOR OBJ ------------------------------------------------


NGRDrawPopIcon:
	BGN
	bsr	NGRDrawBorder
	bsr	NGRLightAPen

	addq.w	#2,d1
	subq.w	#4,d3
	bmi.s	.exit
	subq.w	#4,d2
	bmi.s	.exit
	addq.w	#2,d0
	bsr	NGRLightAPen
	bsr	NGRDrawVecDownIcon
	addq.w	#1,d0
	bsr	NGRDarkAPen
	bsr	NGRDrawVecDownIcon	

.exit	RET

NGRDrawVecDownIcon:
	puts	d0-d3
	bsr	GFX_Move
	lsr.w	#1,d2
	add.w	d2,d0
	add.w	d3,d1
	bsr	GFX_Draw
	sub.w	d3,d1
	add.w	d2,d0
	bsr	GFX_Draw	
	gets	d0-d3
	rts



;--- NGR MODES n PENS -----------------------------------------


	acode
NGRGetLightAPen	;V1.0
	puts	a4
	lea.l	NGWin_Info(PC),a4
	move.w	NGWI_LightPen(a4),d0
	gets	a4
	rts

	acode
NGRGetDarkAPen	;V1.0
	puts	a4
	lea.l	NGWin_Info(PC),a4
	move.w	NGWI_DarkPen(a4),d0
	gets	a4
	rts

	acode
NGRLightAPen	;V1.0
	puts	d0/a4
	lea.l	NGWin_Info(PC),a4
	move.w	NGWI_LightPen(a4),d0
	bsr	NGRenderSetAPen
	gets	d0/a4
	rts

	acode
NGRDarkAPen	;V1.0
	puts	d0/a4
	lea.l	NGWin_Info(PC),a4
	move.w	NGWI_DarkPen(a4),d0
	bsr	NGRenderSetAPen
	gets	d0/a4
	rts

	acode
NGRSpecialAPen	;V1.0
	puts	d0/a4
	lea.l	NGWin_Info(PC),a4
	move.w	NGWI_SpecialPen(a4),d0
	bsr	NGRenderSetAPen
	gets	d0/a4
	rts

	acode
NGRBackAPen	;V1.0
	puts	d0/a4
	lea.l	NGWin_Info(PC),a4
	move.w	NGWI_BackPen(a4),d0
	bsr	NGRenderSetAPen
	gets	d0/a4
	rts

	acode
NGRenderSetAPen	;V1.0
		;I(D0L,A1L,A5L)(PEN_NR,RP,NGWIN)
	CHECKREG5 a5,NGRenderSetAPen,.exit2
	cmp.w	NGWIN_APEN(a5),d0
	bne.s	.go
	rts
.go	puts	a1
	CHECKREG3 a1,NGRenderSetAPen,.exit
	CHECKREG4 a5,NGRenderSetAPen,.exit
	move.w	d0,NGWIN_APEN(a5)
	jsr	GFX_APen
.exit	gets	a1
.exit2	rts

	acode
NGRenderSetBPen	;V1.0
		;I(D0L,A1L,A5L)(PEN_NR,RP,NGWIN)
	CHECKREG5 a5,NGRenderSetBPen,.exit2
	cmp.w	NGWIN_BPEN(a5),d0
	bne.s	.go
	rts
.go	puts	a1
	CHECKREG3 a1,NGRenderSetBPen,.exit
	CHECKREG4 a5,NGRenderSetBPen,.exit
	move.w	d0,NGWIN_BPEN(a5)
	jsr	GFX_BPen
.exit	gets	a1
.exit2	rts

	acode
NGRenderSetDrMd	;V1.0
		;I(D0L,A1L,A5L)(DRAWMODE,RP,NGWIN)
	CHECKREG5 a5,NGRenderSetDrMd,.exit2
	cmp.l	NGWIN_DRMD(a5),d0
	bne.s	.go
	rts
.go	puts	a1
	CHECKREG3 a1,NGRenderSetDrMd,.exit
	CHECKREG4 a5,NGRenderSetDrMd,.exit
	move.l	d0,NGWIN_DRMD(a5)
	jsr	GFX_DrMd
.exit	gets	a1
.exit2	rts

	acode
NGRNrm0DrMd
	puts	d0
	moveq	#0,d0
	bsr	NGRenderSetDrMd
	gets	d0
	rts

	acode
NGRNrm1DrMd
	puts	d0
	moveq	#1,d0
	bsr	NGRenderSetDrMd
	gets	d0
	rts

	acode
NGRInvDrMd
	puts	d0
	moveq	#3,d0
	bsr	NGRenderSetDrMd
	gets	d0
	rts


	IFNE TESTPRGB
TESTDrawMouseCrsr
	rts
	BGN
	lea.l	NGWin_Info(PC),a6
	move.l	NGWI_ActiveWindowAdr(a6),a5
	move.l	NGWIN_RP(a5),a1
	cmp.l	#0,a1
	beq.s	.exit
	cmp.l	#0,a5
	beq.s	.exit
	jsr	NGRDarkAPen
	jsr	GFX_Draw
.exit	RET
	ENDC

;--- NG RENDERING END -------------------------------------------------


DrawSongAll
	jsr	UpdatePosList
	jsr	DrawSequence
	bra	DrawSongStruct





	acode
GetWinDim	;I(A0L)(WINDOW)
		;O(D0L-D3L)(XYWH)
	puts	a0
	move.l	124(a0),a0	;LAYER
	moveq	#0,d2
	move.w	20(a0),d2
	moveq	#0,d3
	move.w	16(a0),d3
	moveq	#0,d0
	move.w	20+2(a0),d0
	moveq	#0,d1
	move.w	16+2(a0),d1
	sub.w	d3,d2
	sub.w	d1,d0
	exg	d3,d0
	gets	a0
	rts

SUPERQUICK	dc.b	0


	acode
WriteXYWH
	BGN
	jsr	WriteAssDecLong
	move.l	d1,d0
	jsr	WriteAssDecLong
	move.l	d2,d0
	jsr	WriteAssDecLong
	move.l	d3,d0
	jsr	WriteAssDecLong
	RET



	acode
HandleAllMsgs
	;BGN
	;move.l	PattedWin_PTR,a0
	;lea.l	PATTEDWIN_JUMPLIST,a1
	;jsr	ProcessWindowMsg
	;move.l	ControlWin_PTR,a0
	;lea.l	CONTROLWIN_JUMPLIST,a1
	;jsr	ProcessWindowMsg
	bra	ProcessAllNGWinMsg
	;RET

DoNil	rts

MBUT_JL dc.l	-1

NUMED_PI	EQU	0
NUMED_INSTR	EQU	1
NUMED_VOL	EQU	2

Actual_NED	dc.w	NUMED_VOL
FASTGFX		dc.b	FALSE

	IFEQ DEMO
	acode
KbdInsertTrackLine
	move.l	#"XXIL",XXMsg
	jsr	NGRecordXXMsg
	jmp	InsertTrackLine

KbdDeleteTrackLine
	move.l	#"XXIS",XXMsg
	jsr	NGRecordXXMsg
	jmp	DeleteTrackLine
	ENDC

	acode
KbdLoadNewSample
	move.l	#"XXNS",XXMsg
	jsr	NGRecordXXMsg
	jmp	LoadNewSample	

KbdDownInstr
	move.l	#"XXID",XXMsg
	jsr	NGRecordXXMsg
	jmp	DownInstr

KbdUpInstr
	move.l	#"XXIU",XXMsg
	jsr	NGRecordXXMsg
	jmp	UpInstr

	IFEQ DEMO
	
	acode
KbdSpace
	move.l	#"XXSP",XXMsg
	jsr	NGRecordXXMsg
	bra.l	Space

KbdReturn
	move.l	#"XXRT",XXMsg
	jsr	NGRecordXXMsg
	bra.l	MarkBlock
	ENDC


KbdPosNumDown
	move.l	#"XXPD",XXMsg
	jsr	NGRecordXXMsg
	bra.l	KeyPosNumDown

KbdPosNumUp
	move.l	#"XXPU",XXMsg
	jsr	NGRecordXXMsg
	bra.l	KeyPosNumUp


	IFEQ DEMO
KbdPatNumDown
	move.l	#"XXpD",XXMsg
	jsr	NGRecordXXMsg
	bra.l	KeyPatNumDown

KbdPatNumUp
	move.l	#"XXpU",XXMsg
	jsr	NGRecordXXMsg
	bra.l	KeyPatNumUp




KbdNoteInstrUp	move.l	#"XnIU",XXMsg
	jsr	NGRecordXXMsg
	bra.l	NoteInstrUp

KbdNoteInstrDown	move.l	#"XnID",XXMsg
	jsr	NGRecordXXMsg
	bra.l	NoteInstrDown

KbdPitchUp	move.l	#"XnPU",XXMsg
	jsr	NGRecordXXMsg
	bra.l	PitchUp

KbdPitchDown	move.l	#"XnPD",XXMsg
	jsr	NGRecordXXMsg
	bra.l	PitchDown

KbdVolumeUp	move.l	#"XnVU",XXMsg
	jsr	NGRecordXXMsg
	bra.l	VolumeUp

KbdVolumeDown	move.l	#"XnVD",XXMsg
	jsr	NGRecordXXMsg
	bra.l	VolumeDown

	ENDC





	acode
RedrawGUI
	BGN
	jsr	NGDrawWinList
	jsr	RedrawSpectrum
	jsr	DrawPositionCacheReset
	jsr	DrawSongAll
	jsr	ShowBufferedAMsgs
	jsr	NGRedrawStatusText
	jsr	AdjustActualPattEd
	jsr	DrawSystemSetup
	jsr	ShowDspStatus
	jsr	DrawEventStatus
	jsr	DrawInstrumentReset
	jsr	DrawInstrument
	IFEQ SMALLGUI
	jsr	RedrawMEventAll
	ENDC
	RET

	acode
ChangeWaveStyle
	subq.b	#1,WaveStyle
	bpl.s	.ok
	move.b	#3,WaveStyle
.ok	jsr	DrawActualWave
	rts

	acode
ToogleGUILook
	addq.b	#1,GUILook
	cmpi.b	#2,GUILook
	bls.s	.exit
	clr.w	GUILook
.exit	bsr	RedrawGUI
	rts

GUILook		dc.b	0			;General
WaveStyle	dc.b	0			;Wave Style
		dc.w	0			;(for safety)

	acode
SetMidiChannel	;V1.0	;MIDI
	BGN
	moveq	#15,d2
	moveq	#0,d1
	lea.l	MidiInputChannel,a0
	lea.l	Midireqtxt,a1
	jsr	ReqMinMaxLong
	move.l	MidiInputChannel,d0
	andi.b	#$0f,d0
	move.b	d0,d1
	addi.b	#$90,d1
	move.b	d1,MidiKeyOnMsg
	move.b	d0,d1
	addi.b	#$c0,d1
	move.b	d1,MidiPrgChange
	RET


	acode
SetEditPunch	;V1.0	;MIDI
	BGN
	moveq	#100,d2
	moveq	#0,d1
	lea.l	KeyboardEditPunch,a0
	lea.l	Midireqtxt2,a1
	jsr	ReqMinMaxLong
	move.l	KeyboardEditPunch,d0
	RET


	acode
MidiInputChannel	dc.l	0
KeyboardEditPunch	dc.l	100
LINEARVOLUME		dc.b	FALSE
MidiKeyOnMsg		dc.b	$90
MidiPrgChange		dc.b	$c0



	acode
ToogleLinVol
	eori.b	#-1,LINEARVOLUME
	rts


	acode
ToogleFASTGFX:	
	jsr	PatEdCrsrOff
	jsr	HideBlockRange
	eori.b  #-1,FASTGFX
	jsr	ShowBlockRange
	jsr	PatEdCrsrOn
	rts

CHGtestplace	eori.w	#-1,testplace
	rts

	acode
ShowBuf
	BGN
	move.l	BUFFERPTR,d0
	jsr	PrintAssHex
	move.l	BUFFERPTR+4,d0
	jsr	PrintAssHex
	RET
	
BUFFERPTR	dc.l	0,0

;	IFNE	SPECIAL
;Declick_on	dc.b	"Declick: On",0
;Declick_off	dc.b	"Declick: Off",0
;	acode
;ToogleDeclicking
;	lea.l	Declick_on(PC),a0
;	eori.b	#-1,Declicking
;	bne.s	.ok
;	lea.l	Declick_off(PC),a0
;.ok	bsr	PrintAssText
;	ENDC
;	rts


	acode
NUMValPrev
	IFEQ	DEMO
	subq.w	#1,Actual_NED
	bpl.s	NUMValPrev_X
	move.w	#NUMED_VOL,Actual_NED
NUMValPrev_X
	jsr	PattEdDrawStatus
	ENDC
	rts

	acode
NUMValNext
	IFEQ	DEMO
	puts	d0
	move.w	Actual_NED,d0
	addq.w	#1,d0
	move.w	d0,Actual_NED
	cmpi.w	#NUMED_VOL,d0
	bls.s	NUMValNext_X
		move.w	#NUMED_PI,Actual_NED
NUMValNext_X
	jsr	PattEdDrawStatus
	gets	d0
	ENDC
	rts

	acode
NUMValDwn
	BGN
	IFEQ	DEMO
	lea.l	NUMVal_JL(PC),a0
	move.w	Actual_NED(PC),d0
	move.l	4(a0,d0.w*8),a0
	jsr	(a0)
	ENDC
	RET

	acode
NUMValUp
	BGN
	IFEQ	DEMO
	lea.l	NUMVal_JL(PC),a0
	move.w	Actual_NED(PC),d0
	move.l	(a0,d0.w*8),a0
	jsr	(a0)
	ENDC
	RET

NUMVal_JL
	IFEQ	DEMO
	dc.l	PitchUp				;NUM 8
	dc.l	PitchDown			;NUM 5
	dc.l	NoteInstrUp			;NUM 9
	dc.l	NoteInstrDown			;NUM 6
	dc.l	VolumeUp			;NUM +
	dc.l	VolumeDown			;NUM -
	ENDC


LASTASSTEXT	dc.l	0,0
AssText_TXT	dc.l	0

MKMakeName
	BGN
	jsr	GetActualInstrName
	lea.l	MK_Name,a1
	exg	a0,a1
	clr.b	(a1)
	jsr	AddString
	move.b	MK_Name+9,d7
	cmpi.b	#"Z",d7
	bne.s	.ok
	moveq	#"0",d7
.ok	addq.b	#1,d7
	move.b	d7,MK_Name+9	
	RET




	acode
DecShiftRepeat	;V2.0
	puts	d0-d1
	jsr	SetDecShiftKeyRaster
	subq.w	#2,d0
	bmi.s	.exit

	move.b	MACROPROCESS,d1
	move.b	#TRUE,MACROPROCESS

.loop	jsr	(a0)
	dbf	d0,.loop

	move.b	#FALSE,MACROPROCESS

.exit	jsr	(a0)
	gets	d0-d1
	rts




;--- ASSIST ---------------------------------------------------------

	acode
ShowProjectName
	puts	a0-a1
	lea.l	tempstring,a1
	clr.b	(a1)
	lea.l	LoadProj_PRE,a0
	jsr	AddString
	move.l	FinalFileNameRT_PTR,a0
	jsr	AddString
	ASSTXT	tempstring
	gets	a0-a1
	rts

ShowTime
	puts	a0-a1
	lea.l	tempstring,a1
	clr.b	(a1)
	lea.l	TimeDur,a0
	jsr	AddString
	lea.l	TimeString_TXT,a0
	jsr	AddString
	ASSTXT	tempstring
	gets	a0-a1
	rts



	acode
ShowBufferedAMsgs
	puts	d0/a0
	move.l	LASTASSTEXT+4(PC),a0
	move.l	LASTASSTEXT(PC),d0
	bsr	PrintAssText
	move.l	d0,a0
	bsr	PrintAssText
	gets	d0/a0
	rts

	acode
PrintAssTextF
	puts	a0
	move.l	AssText_TXT(PC),a0
	bsr	PrintAssText
	gets	a0
	rts

	acode
PrintAssText	;V1.0 NG
	BGN
	cmp.l	#0,a0
	beq.s	PrintAssText_X
	move.l	LASTASSTEXT,LASTASSTEXT+4
	move.l	a0,LASTASSTEXT
	bsr	GetAssistData
	cmp.l	#0,a1
	beq.s	PrintAssText_ERR
	andi.l	#$ffff,d2
	moveq	#0,d7
	move.w	FONT_W(PC),d7
	divu	d7,d2
	andi.l	#$ffff,d2
	move.l	a0,a2
	moveq	#0,d0		;NUMB OF CHARS

PrintAssText_L
		move.b	(a2)+,d1
		beq.s	PrintAssText_WrLast
	
		addq.w	#1,d0
		cmp.w	d2,d0
		beq.s	PrintAssText_Write
	bra.s	PrintAssText_L	
PrintAssText_X	RET

PrintAssText_ERR
	jsr	WarnFlash
	bra.s	PrintAssText_X

PrintAssText_WrLast
	tst.w	d0
	beq.s	PrintAssText_X
	bsr	AssistText
	bra.s	PrintAssText_X

PrintAssText_Write
	puts	d7
	move.b	(a2),d7
	clr.b	(a2)
		bsr	AssistText
	move.b	d7,(a2)
	move.l	a2,a0
	gets	d7
	moveq	#0,d0
	bra.s	PrintAssText_L

	acode
AssistText
	;I(A0L)(TEXT)
	BGN
	tst.b	AssistScroll
	bne.s	.NS
		bsr	ScrollAss
.NS
	bsr	GetAssistData
	cmp.l	#0,a1
	beq.s	.exit

	add.w	d3,d1
	sub.w	FONT_H,d1
	add.w	FONT_BASE,d1
	jsr	DrawTextXY
.exit	RET
AssistScroll	dc.b	0
	even

GetAssistData	;V1.0
	puts	a0/a5
	;move.l	#"WINC",d0
	move.l	#"C001",d1
	bsr	NGFindAreaWindow
	bsr	NGGetInnerAreaData
	cmp.l	#0,a5
	bne.s	.ok
	suba.l	a1,a1
.ok	gets	a0/a5
	rts

	acode
ScrollAss	;V1.0 NG
	BGN
	bsr	GetAssistData
	cmp.l	#0,a1
	beq.s	.exit
	move.w	FONT_H,d7
	jsr	ScrollUpAreaFix
.exit	RET


;--- ASSIST END -----------------------------------------------------

	acode
SCOPE_BM	dc.l	0

SCANWEIDTH	EQU	4*2*8
SCANHEIGHT	EQU	400


SCOPEBM_H	dc.l	2048


	acode
AllocateScopeBM
	BGN
	move.l	SCANTRANSBIG_PTR,SCOPETRANS
	jsr	InitScopeTrans
	move.l	#SCANWEIDTH*2,d0
	move.l	SCOPEBM_H,d1	;1024
	moveq	#1,d2
	moveq	#0,d3
	suba.l	a0,a0
	GFX	AllocBitMap(a6)
	move.l	d0,SCOPE_BM
	RET

	acode
FreeScopeBM
	tst.l	SCOPE_BM
	bne	.go
	rts
.go	BGN
	move.l	SCOPE_BM,a0
	GFX	FreeBitMap(a6)
	RET


	acode
BuildScopeImage
	tst.l	SCOPE_BM
	bne.s	.go
	rts
.go	BGN
	move.l	#"SCOP",d0
	move.l	#"SCPA",d1
	jsr	NGFindArea
	cmp.l	#0,a0
	beq	BuildScopeImage_X
	move.l	NGArea_RP(a0),a1
	movem.w	NGArea_XYWH(a0),d0-d3
	cmp.l	#0,a1
	beq	BuildScopeImage_X


	cmpi.w	#1,FRAMENUMB+2
	beq.s	BuildScopeImage_Single

	move.l	#100*256,d7
	divu	FRAMENUMB+2,d7
	lsr.w	#8,d7
	jsr	CalcAreaPercLower
BuildScopeImage_Single
	move.w	d3,d7
	beq.s	BuildScopeImage_X

;	movem.l	SCOPE_POS,a0/a1

	move.l	SCOPE_BM(PC),a2
	move.l	8(a2),a2

	moveq	#0,d6
	move.w	SCOPE_LEN(PC),d6
	lsl.l	#8,d6

	divu	d7,d6
	andi.l	#$ffff,d6
	lsl.l	#8,d6
	moveq	#0,d5

	move.l	SCOPETRANS+8,d4	;BITMAP_OFFSET


	move.l	SCOPETRANS(PC),a3
	moveq	#0,d0

	move.l	SCOPEBUILD(PC),a4

	move.l	SCOPE_16BITPOS,a1
	lea.l	2(a1),a0

BuildScopeImage_L
		jsr	(a4)
		swap	d5
		add.l	d6,d5
		swap	d5
		lea.l	(a2,d4.w),a2
		lea.l	(a0,d5.w*4),a0
		lea.l	(a1,d5.w*4),a1
		clr.w	d5
	dbf	d7,BuildScopeImage_L
	jsr	CopyScope
BuildScopeImage_X
	RET

	acode
SetScopeTest
	puts	d0-d1
	movem.l	SCOPEBUILD,d0-d1
	exg	d0,d1
	movem.l	d0-d1,SCOPEBUILD
	gets	d0-d1
	rts

	acode
SCOPE_16BITPOS	dc.l	0
SCOPEBUILD	dc.l	BuildStereoScope,BuildDiffScope

	acode
BuildDiffScope
	IFNE	SYMPHPRO

	puts	d7
	moveq	#0,d7
	move.l	d7,(a2)+
	move.b	(a1),d0
	sub.b	(a0),d0
	bsr	BuildScopeUnit
	move.l	d7,(a2)+
	gets	d7

	ELSE

	puts	d7
	jsr	GetCopyBackShift
	move.w	(a1),d0
	sub.w	(a0),d0
	asr.w	d7,d0
	andi.w	#$ff,d0

	moveq	#0,d7
	move.l	d7,(a2)+
	bsr	BuildScopeUnit
	move.l	d7,(a2)+

	gets	d7
	ENDC

	rts





	acode
BuildStereoScope
	IFNE	SYMPHPRO

	move.b	(a1),d0
	bsr	BuildScopeUnit
	move.b	(a0),d0
	bsr	BuildScopeUnit

	ELSE

	puts	d7
	jsr	GetCopyBackShift
	move.w	(a1),d0
	asr.w	d7,d0
	andi.w	#$ff,d0
	bsr	BuildScopeUnit
	move.w	(a0),d0
	asr.w	d7,d0
	andi.w	#$ff,d0
	bsr	BuildScopeUnit
	gets	d7
	ENDC

	rts




	acode
BuildScopeUnit
	bra.s	BuildBigScopeUnit
	tst.b	d0
	bpl.s	.pos
	neg.b	d0
.pos	lsr.w	#2,d0
	move.l	(a3,d0.w*4),d1
	move.l	d1,(a2)+
	rts


	acode
BuildBigScopeUnit
	tst.b	d0
	bpl.s	.pos
	neg.b	d0
.pos	lsr.w	#1,d0
	move.l	(a3,d0.w*8),d1
	move.l	d1,(a2)+
	move.l	4(a3,d0.w*8),d1
	move.l	d1,(a2)+
	rts



	;SCOPETRANS	dc.l	SCANTRANSBIG_TAB,64,0
SCOPETRANS	dc.l	0,64,0



SCANTRANS_TAB
		dc.l	%00000000000000000000000000000000
		dc.l	%00000000000000010000000000000000
		dc.l	%00000000000000110000000000000000
		dc.l	%00000000000000111000000000000000
		dc.l	%00000000000001111000000000000000
		dc.l	%00000000000001111100000000000000
		dc.l	%00000000000011111100000000000000
		dc.l	%00000000000011111110000000000000
		dc.l	%00000000000111111110000000000000
		dc.l	%00000000000111111111000000000000
		dc.l	%00000000001111111111000000000000
		dc.l	%00000000001111111111100000000000
		dc.l	%00000000011111111111100000000000
		dc.l	%00000000011111111111110000000000
		dc.l	%00000000111111111111110000000000
		dc.l	%00000000111111111111111000000000
		dc.l	%00000001111111111111111000000000
		dc.l	%00000001111111111111111100000000
		dc.l	%00000011111111111111111100000000
		dc.l	%00000011111111111111111110000000
		dc.l	%00000111111111111111111110000000
		dc.l	%00000111111111111111111111000000
		dc.l	%00001111111111111111111111000000
		dc.l	%00001111111111111111111111100000
		dc.l	%00011111111111111111111111100000
		dc.l	%00011111111111111111111111110000
		dc.l	%00111111111111111111111111110000
		dc.l	%00111111111111111111111111111000
		dc.l	%01111111111111111111111111111000
		dc.l	%01111111111111111111111111111100
		dc.l	%11111111111111111111111111111100
		dc.l	%11111111111111111111111111111110
		dc.l	%11111111111111111111111111111111
		dc.l	%11111111111111111111111111111111
		dc.l	%11111111111111111111111111111111
		dc.l	%11111111111111111111111111111111
		dc.l	%11111111111111111111111111111111

;SCANTRANSBIG_TAB

SCANTRANSBIG_PTR	dc.l	0,4*8*64,FASTMEM


	acode
InitScopeTrans
	BGN
	move.l	SCANTRANSBIG_PTR(PC),a0

	move.l	#$00000000,d0
	move.l	#$80000000,d1


	moveq	#32-1,d7
.loop		move.l	d0,(a0)+
		move.l	d1,(a0)+
		lsl.l	#1,d0
		bset	#0,d0

		move.l	d0,(a0)+
		move.l	d1,(a0)+
		lsr.l	#1,d1
		bset	#31,d1

	dbf	d7,.loop
	RET

SCOPE_LEN	dc.w	0,0	;LEN IN SAMPLES
SCOPE_POSOLD	dc.l	-1

	acode
CopyScope	
	tst.l	SCOPE_BM
	bne.s	.go
	rts
.go	BGN
	move.l	#"SCOP",d0
	move.l	#"SCPA",d1
	jsr	NGFindArea
	cmp.l	#0,a0
	beq.s	.exit
	move.l	NGArea_RP(a0),a1
	movem.w	NGArea_XYWH(a0),d0-d3
	cmp.l	#0,a1
	beq.s	.exit

	cmpi.w	#128,d2
	bls.s	.wok
	move.w	d2,d6
	sub.w	#128,d6
	lsr.w	#1,d6
	add.w	d6,d0
	move.w	#128,d2


.wok	cmpi.w	#1,FRAMENUMB+2
	beq.s	.Single
	move.l	#100*256,d7
	divu	FRAMENUMB+2,d7
	lsr.w	#8,d7
	jsr	ScrollUpArea
	jsr	CalcAreaPercLower
.Single
	move.w	d2,d4
	move.w	d3,d5
	move.w	d1,d3
	move.w	d0,d2
	moveq	#0,d0
	moveq	#0,d1
	cmpi.w	#128,d4
	blo.s	.OK

	move.w	#128,d4
.OK
	move.l	SCOPE_BM(PC),a0
	move.l	#$0C0,d6
	GFX	BltBitMapRastPort(a6)
.exit	RET


;--- SCOPE END ---------------------------------------







;--- CHANGE CURRENT DIR ------------------------------

	acode
CDtoProgramDir
	BGN
	DOS	GetProgramDir(a6)
	move.l	d0,d1
	DOS	CurrentDir(a6)
	move.l	d0,OldProgDir
	RET
	acode
CDtoOldDir
	BGN
	move.l	OldProgDir,d1
	DOS	CurrentDir(a6)
	RET
OldProgDir	dc.l	0
NewMenu_PTR	dc.l	0

	acode
ShowMainTitle
	tst.b	DSPACTION_LIVE
	beq.s	DoShowMainTitle
	rts
DoShowMainTitle
	BGN
	jsr	BuildMainTitle
	move.l	MainScreen_PTR,a0
	moveq	#TRUE,d0
	CALLINT ShowTitle(a6)
	RET

;--- MEM CONTROL ------------------------------

	acode
CheckBufferMem
	BGN
	lea.l	CopyBuffer_PTR,a0
	move.l	#$00010016,MEM_DEBUG_INFO
	move.l	#$10000000,MEM_DEBUG_INFO+4
	jsr	CheckMem

	lea.l	DryDspBuffer_PTR,a0
	move.l	#$00010016,MEM_DEBUG_INFO
	move.l	#$10000000,MEM_DEBUG_INFO+4
	jsr	CheckMem
	RET

CheckResidentMem
	puts	a0
	move.l	#$00010017,MEM_DEBUG_INFO
	move.l	#$00000000,MEM_DEBUG_INFO+4	;0=1st
	lea.l	Resident_AUTOMEM,a0
	bsr	CheckMemList
	move.l	#$00010018,MEM_DEBUG_INFO
	move.l	#$00000000,MEM_DEBUG_INFO+4
	lea.l	Main_AUTOMEM,a0
	bsr	CheckMemList
	gets	a0
	rts
CheckMemList
	BGN
	move.l	a0,a1
.loop	move.l	(a1)+,a0
	cmpa.l	#-1,a0
	beq.s	.exit
	tst.l	(a0)
	beq.s	.loop
	jsr	CheckMem
	addq.l	#1,MEM_DEBUG_INFO+4
	bra.s	.loop
.exit	RET

;--- FONT ------------------------------------------------
	acode
AddFontW	;I(D0W,D2W)(X,CHARW)
		;O(D0W)(X)
	puts	d2
	mulu	FONT_W(PC),d2
	add.w	d2,d0
	gets	d2
	rts

	acode
XCharToPixel
	cmpi.l	#-1,d0
	beq.s	XCharToPixel_KeepX
		mulu	FONT_W(PC),d0
XCharToPixel_KeepX
	cmpi.l	#-1,d1
	beq.s	XCharToPixel_KeepY
		mulu	FONT_H(PC),d1
XCharToPixel_KeepY
	rts

	acode
CharToPixel	;I(D0W,D1W)(CHARW,CHARH)
		;O(D0L,D1L)(W,H[PIXEL])
	mulu	FONT_W(PC),d0
	mulu	FONT_H(PC),d1
	rts

	acode
InitFontDim	;I(A1L)(RP)
	move.w	$3a(a1),FONT_H
	move.w	60(a1),FONT_W
	move.w	62(a1),FONT_BASE
	move.w	64(a1),FONT_SPACING
	IFNE	DIRECTPEDGFX
	move.l	52(a1),WINDOW_FONT
	ENDC
	rts

GetFontInfo	;O(D0W-D3W)(W,H,BASE,SPACING)
	move.w	$3a(a1),d1
	move.w	60(a1),d0
	move.w	62(a1),d2
	move.w	64(a1),d3
	rts

	IFNE	DIRECTPEDGFX
	acode
SetScreenFont
	BGN
	move.l	MainScreen_PTR,a2
	lea.l	84(a2),a1
	move.l	WINDOW_FONT,a0
	GFX	SetFont(a6)
	RET

WINDOW_FONT	dc.l	0

	ENDC

	even
FONT_SPACING	dc.w	0
FONT_BASE	dc.w	0	;Baselinie
FONT_H		dc.w	8
FONT_W		dc.w	6
MENUFONT_W	dc.w	8,0	
MENUFONT_H	dc.w	14,14	;H, DY
WINDOW_TOP	dc.w	14



ScrModeRequest_PTR	dc.l	0
	dc.l	ASLSM_InitialDisplayID,$00069000!SUPERLACE_KEY

	dc.l	ASLSM_MinWidth,320
	dc.l	ASLSM_MinHeight,200
	dc.l	ASLSM_MinDepth,1

	dc.l	ASLSM_InitialDisplayWidth,640
	dc.l	ASLSM_InitialDisplayHeight,400
	dc.l	ASLSM_InitialDisplayDepth,2


	dc.l	ASLSM_DoWidth,TRUE
	dc.l	ASLSM_DoHeight,TRUE
	dc.l	ASLSM_DoDepth,TRUE
;	dc.l	ASLSM_DoAutoScroll,TRUE
;	dc.l	ASLSM_InitialInfoOpened,TRUE
	dc.l	TAG_DONE


	acode
ForceEvenBufNumb	;NEWBUFSYNC
	puts	d0
	move.l	VexBufferNumb,d0
	cmpi.l	#MAXBUFFERS,d0
	bls.s	.ok
	moveq	#MAXBUFFERS,d0
.ok	bclr	#0,d0
	move.l	d0,VexBufferNumb
	gets	d0
	jsr	InitActionDelay
	rts

	acode
SelectBufferNumb
	BGN
	moveq	#MAXBUFFERS,d2
	moveq	#MINBUFFERS,d1
	lea.l	VexBufferNumb,a0
	lea.l	SelectBuffer_TXT,a1
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit
	jsr	ForceEvenBufNumb		;NEWBUFSYNC
	jsr	RebuildSoundSystem
	bsr	DrawSystemSetup
.exit	RET

	acode
SelectAdjustVol
	BGN
	IFEQ DEMO
	move.l	#200,d2
	move.l	#1,d1

	lea.l	AdjustVol,a0
	lea.l	AdjustVol_TXT,a1
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit
	bsr	DoAdjustVolume
	ENDC
.exit	RET
	
	acode
SetMaxDspBuffer
	IFEQ AMINETDEMO
	BGN
	move.l	#255,d2
	moveq	#16,d1
	lea.l	MAXDSP_ECHO_LEN,a0
	lea.l	DspBuffer_TXT,a1

	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit

	move.l	(a0),d1
	cmp.l	DSP_ECHO_LEN,d1
	bhs.s	.ok
		move.l	d1,DSP_ECHO_LEN

.ok	jsr	RebuildSoundSystem
	jsr	InitCalcBufferInfo

.exit	RET

	ELSE
	acode
	BGN
	move.l	#24,d2
	moveq	#16,d1
	lea.l	MAXDSP_ECHO_LEN,a0
	lea.l	DspBuffer_TXT,a1

	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit

	move.l	(a0),d1
	cmp.l	DSP_ECHO_LEN,d1
	bhs.s	.ok
		move.l	d1,DSP_ECHO_LEN

.ok	jsr	RebuildSoundSystem
	jsr	InitCalcBufferInfo
.exit	RET
	ENDC


DELAY_NRM	EQU	0
DELAY_CROSS	EQU	1
DELAY_HALL	EQU	2
DELAY_CROSSHALL	EQU	3
DELAY_PITCH	EQU	0

DSP_OFF		EQU	0
DSP_ECHO	EQU	1
DSP_CROSSECHO	EQU	2
DSP_CROSSECHO2	EQU	3
DSP_CenterEcho	EQU	4

DSP_DELAY	EQU	1
DSP_CRDELAY	EQU	2
DSP_HALL	EQU	3
DSP_CRHALL	EQU	4
DSPPOST_MAX	EQU	4

DSP_CHORUS	EQU	1

DSP_MAX		EQU	5

DSPACTION_LIVE	dc.b	0	;0=YES, 1=NO! SEQUENZED

	acode
DeactivateDsp
	clr.b	DelayFX
	clr.b	POSTDSP_FLAG
	clr.l	POSTDSP
	move.b	#-1,PREDSP_UPDATE
	move.l	#DSP_OFF,DSPFX
	clr.w	VEXDSP_FLAG
	tst.b	DSPACTION_LIVE
	bne.s	RemoteDsp
		jsr	ShowMainTitle
RemoteDsp	rts

	acode
DspFilter
	eori.b	#-1,DSPFilterEcho
	jsr	ShowMainTitle
	rts


	adata
DspAction_LIST	
	dc.l	DspEchoOff
	dc.l	DspEcho
	dc.l	DspCrossEcho
	dc.l	DspCrossEcho2
	dc.l	DspCenterEcho
	dc.l	-1

	adata
DspActionDelay_LIST	
	dc.l	DspDelayOff
	dc.l	DspDelay
	dc.l	DspCrossDelay
	dc.l	-1

	adata
DspActionHall_LIST	
	dc.l	DspDelayOff
	dc.l	DspHall
	dc.l	DspCrossHall
	dc.l	-1

	acode
DspEchoOff
	clr.w	VEXDSP_FLAG
	move.l	#DSP_OFF,DSPFX
	tst.b	DSPACTION_LIVE
	bne.s	.RemoteDsp
	jsr	ShowMainTitle
.RemoteDsp	rts

	acode
DspDelayOff
	clr.b	DelayFX
	clr.b	POSTDSP_FLAG
	clr.l	POSTDSP
	tst.b	DSPACTION_LIVE
	bne.s	.RemoteDsp
	jsr	ShowMainTitle
.RemoteDsp	rts


	acode
DspEcho:
	move.b	#-1,PREDSP_UPDATE
	move.l	#DSP_ECHO,DSPFX
	move.l	#CopyDSP_Echo,PREDSP
	move.w	#1,VEXDSP_FLAG
	tst.b	DSPACTION_LIVE
	bne	RemoteDsp
	jsr	ShowMainTitle
	rts

	acode
DspCrossEcho:
	move.b	#-1,PREDSP_UPDATE
	move.l	#DSP_CROSSECHO,DSPFX
	move.l	#CopyDSP_CrossEcho,PREDSP
	move.w	#1,VEXDSP_FLAG
	tst.b	DSPACTION_LIVE
	bne	RemoteDsp
		jsr	ShowMainTitle
	rts

	acode
DspCrossEcho2:
	move.b	#-1,PREDSP_UPDATE
	move.l	#DSP_CROSSECHO2,DSPFX
	move.l	#CopyDSP_CrossEcho2,PREDSP
	move.w	#1,VEXDSP_FLAG
	tst.b	DSPACTION_LIVE
	bne	RemoteDsp
		jsr	ShowMainTitle
	rts

	acode
DspCenterEcho:
		move.b	#-1,PREDSP_UPDATE
		move.l	#DSP_CenterEcho,DSPFX
		move.l	#CopyDSP_CenterEcho,PREDSP
		move.w	#1,VEXDSP_FLAG
		tst.b	DSPACTION_LIVE
		bne.w	RemoteDsp
		jsr	ShowMainTitle
	rts



DspChorus
	bchg	#POSTCHOR,POSTDSP_FLAG
	bra.s	SetPostDsp
DspDelay
	bset	#POSTDELAY,POSTDSP_FLAG
	move.b	#DSP_DELAY,DelayFX
	bra.s	SetPostDsp
DspCrossDelay
	bset	#POSTDELAY,POSTDSP_FLAG
	move.b	#DSP_CRDELAY,DelayFX
	bra.s	SetPostDsp
DspHall
	bset	#POSTDELAY,POSTDSP_FLAG
	move.b	#DSP_HALL,DelayFX
	bra.s	SetPostDsp
DspCrossHall
	bset	#POSTDELAY,POSTDSP_FLAG
	move.b	#DSP_CRHALL,DelayFX
	bra.s	SetPostDsp

SelectPostFilter
	bchg	#POSTFILTER,POSTDSP_FLAG
	bra	SetPostDsp

SetPostDsp
	puts	d0/a0
	moveq	#0,d0
	move.b	DelayFX,d0
	cmpi.b	#DSPPOST_MAX,d0
	bls.s	SetPostDsp_ok
		moveq	#DSP_DELAY,d0
		move.b	d0,DelayFX
SetPostDsp_ok
	subq.w	#1,d0
	bmi.s	SetPostNoDly

	lea.l	DelayFXList,a0
	lea.l	(a0,d0.w*4),a0
	move.l	(a0),DelayFX+2

SetPostNoDly
	moveq	#0,d0
	tst.b	POSTDSP_FLAG
	beq.s	PostDspOff
		move.l	#PrepPostDsp,d0
PostDspOff	move.l	d0,POSTDSP
	gets	d0/a0
	jsr	ShowMainTitle
	rts

;	IFNE	RENDER
;
;HQMode	
;	puts	d0
;	move.l	#"On  ",d0
;	eori.b	#-1,RenderHQ
;	tst.b	RenderHQ
;	bne.s	HQModeSet
;	move.l	#"Off ",d0
;HQModeSet	move.l	d0,HQMode_TXT2
;	ASSTXT	HQMode_TXT
;	gets	d0
;	rts
;	acode
;SetSmoothLen
;	;LEVEL0 FOR STATIC SPHERE
;	rts
;	BGN
;	moveq	#0,d1
;	moveq	#64,d2
;	lea.l	SmoothNumb,a0
;	lea.l	SetSmoothLen_TXT,a1
;	jsr	ReqMinMaxLong
;	RET
;	ENDC

	acode
SystemSpeedDown
	BGN
	move.l	VexSpeed,d1
	jsr	SetDecShiftKeyRaster
	andi.l	#$ff,d0
	sub.l	d0,d1
	bmi.s	SystemSpeedDown_X
	cmpi.l	#50,d1
	blo.s	SystemSpeedDown_X
		move.l	d1,VexSpeed
		jsr	RebuildSoundSystem2
		jsr	ResetRelMasterTime
		jsr	DrawSystemSetup
SystemSpeedDown_X	
	jsr	InitActionDelay
	RET


	acode
SystemSpeedUp	;V1.1	*NEW
	BGN
	move.l	VexSpeed,d1
	jsr	SetDecShiftKeyRaster
	andi.l	#$ff,d0
	add.l	d0,d1
	cmpi.l	#800,d1
	bhi.s	SystemSpeedUp_X
		move.l	d1,VexSpeed
		jsr	RebuildSoundSystem2
		jsr	ResetRelMasterTime
		jsr	DrawSystemSetup
SystemSpeedUp_X	
	jsr	InitActionDelay
	RET

QUALITY_MIN	EQU	8
	IFEQ AMINETDEMO
		IFEQ DEMO
QUALFREQ_MAX	EQU	500000
QUALFREQ_MIN	EQU	4000
		ELSE
QUALFREQ_MAX	EQU	250000
QUALFREQ_MIN	EQU	4000
		ENDC
	ELSE
QUALFREQ_MAX	EQU	48000
QUALFREQ_MIN	EQU	8000
	ENDC

	acode
QualityUp	;V1.2	*NEW
	BGN
	lea.l	VexQuality,a0
	move.l	(a0),d2
	move.l	d2,d1
	jsr	SetDecShiftKeyRaster
	add.w	d0,d1
	andi.l	#$ffff,d1
	move.l	d1,(a0)
	jsr	GetSystemFreq
	cmpi.l	#QUALFREQ_MAX,d0
	bhi.s	.max
	jsr	RebuildSoundSystem2
	jsr	ResetRelMasterTime
	jsr	DrawSystemSetup
.exit	jsr	InitActionDelay
	RET
.max	move.l	d2,(a0)
	bra.s	.exit

	acode
QualityDown	;V1.2	*NEW
	BGN
	lea.l	VexQuality,a0
	move.l	(a0),d2
	move.l	d2,d1
	jsr	SetDecShiftKeyRaster
	sub.w	d0,d1
	bmi.s	.exit
	andi.l	#$ffff,d1
	move.l	d1,(a0)
	jsr	GetSystemFreq
	cmpi.l	#QUALFREQ_MIN,d0
	blo.s	.max
	jsr	RebuildSoundSystem2
	jsr	ResetRelMasterTime
	jsr	DrawSystemSetup
.exit	jsr	InitActionDelay
	RET
.max	move.l	d2,(a0)
	bra.s	.exit




	acode
SetSixteenVoices

	BGN
	jsr	StopActualSong
	lea.l	MainScreenVoc_TXT,a0
	move.b	#" ",(a0)+
	move.b	#"1",(a0)+
	move.b	#"6",(a0)+

	lea.l	VEX_Setup,a0
	move.w	#2,(a0)+
	move.w	#4,(a0)+
	move.w	#16,(a0)+
	bsr	DoRestart
	RET

	acode
SetThirtytwoVoices
	BGN
	jsr	StopActualSong
	lea.l	MainScreenVoc_TXT,a0
	move.b	#" ",(a0)+
	move.b	#"3",(a0)+
	move.b	#"2",(a0)+

	lea.l	VEX_Setup,a0
	move.w	#3,(a0)+
	move.w	#4,(a0)+
	move.w	#32,(a0)+
	bsr	DoRestart
	RET

SetSixtyFourVoices
	IFEQ	AMINETDEMO
	BGN
	jsr	StopActualSong
	lea.l	MainScreenVoc_TXT,a0
	move.b	#" ",(a0)+
	move.b	#"6",(a0)+
	move.b	#"4",(a0)+

	lea.l	VEX_Setup,a0
	move.w	#4,(a0)+
	move.w	#4,(a0)+
	move.w	#64,(a0)+
	bsr	DoRestart
	RET
	ENDC

Set128Voices
	IFEQ	AMINETDEMO
	BGN
	jsr	StopActualSong
	lea.l	MainScreenVoc_TXT,a0
	move.b	#"1",(a0)+
	move.b	#"2",(a0)+
	move.b	#"8",(a0)+

	lea.l	VEX_Setup,a0
	move.w	#5,(a0)+
	move.w	#4,(a0)+
	move.w	#128,(a0)+
 	bsr	DoRestart
	RET
	ENDC


Set256Voices
	IFEQ	AMINETDEMO
	BGN
	jsr	StopActualSong
	lea.l	MainScreenVoc_TXT,a0
	move.b	#"2",(a0)+
	move.b	#"5",(a0)+
	move.b	#"6",(a0)+

	lea.l	VEX_Setup,a0
	move.w	#6,(a0)+
	move.w	#4,(a0)+
	move.w	#256,(a0)+
	bsr	DoRestart
	RET
	ENDC
	rts

SetEightVoices
	BGN
	jsr	StopActualSong
	lea.l	MainScreenVoc_TXT,a0
	move.b	#" ",(a0)+
	move.b	#" ",(a0)+
	move.b	#"8",(a0)+

	lea.l	VEX_Setup,a0
	move.w	#1,(a0)+
	move.w	#4,(a0)+
	move.w	#8,(a0)+
	bsr	DoRestart
	RET




WIN_RP		EQU	50


	acode
UpdatePosListQ:	;V1.0
	BGN
	bra.s	UpdatePosListIN
	acode

UpdatePosList:	;V1.0 NGW
	BGN
	jsr	DrawPosition
UpdatePosListIN
	lea.l	Test_PATTED,a2
	move.l	PATTED_ACTUALSONGDATA(a2),a3

	move.l	#"WINB",d0
	move.l	#"B004",d1
	bsr	NGGetInnerAreaData
	cmp.l	#0,a0
	beq	.exit
	cmp.l	#0,a1
	beq	.exit
	lea.l	NGWin_Info(PC),a4
	add.w	NGWI_GadFontBase(a4),d1
	move.w	NGWI_GadFontH(a4),d5
	add.w	NGWI_GadAreaSpacingXY(a4),d0
	add.w	NGWI_GadAreaSpacingXY+2(a4),d1
	sub.w	NGWI_GadAreaSpacingXY(a4),d2
	sub.w	NGWI_GadAreaSpacingXY+2(a4),d3

	moveq	#0,d7
	move.w	d3,d7
	divu	d5,d7
	subq.w	#2,d7
	bmi.s	.exit

	jsr	NGRNrm1DrMd
	jsr	NGRDarkAPen
	lea.l	PosListtitle,a0
	jsr	DrawTextXY
	add.w	d5,d1
	addq.w	#1,d1

	jsr	NGRLightAPen
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a3
	moveq	#0,d6
	move.w	PATTED_ACTPOSNUM(a0),d6

.loop	bsr	.BuildPosLineTxt
	lea.l	POSITION_SIZEOF(a3),a3
	move.l	PosLine_TXT(PC),a0
	jsr	DrawTextXY
	add.w	d5,d1
	jsr	NGRDarkAPen
	;tst.w	d7
	;beq.s	.mark
.mark	addq.w	#1,d6
	dbf	d7,.loop
.exit	RET


	acode
.BuildPosLineTxt	;I(d6)
	puts	d0/d1/d6/a0/a1/a3
	move.l	PosLine_TXT(PC),a0
	move.l	d6,d0
	jsr	AddString3Word
	move.w	POSITION_PATNUM(a3),d0
	jsr	AddString3Word
	move.w	POSITION_STARTPOINT(a3),d0
	jsr	AddString3Word
	move.w	POSITION_LEN(a3),d0
	jsr	AddString3Word
	move.b	#" ",(a0)+
	move.w	POSITION_LOOPNUMB(a3),d0
	jsr	AddString3Word
	move.w	POSITION_SPEED(a3),d0
	jsr	AddString3Word
	moveq	#0,d0
	move.b	POSITION_TUNE+1(a3),d0
	jsr	ConvertToSignDecByte
	lea.l	SignDecByte_TXT,a1
	move.b	(a1)+,(a0)+
	move.b	(a1)+,(a0)+
	move.b	(a1)+,(a0)+
	clr.b	(a0)
	gets	d0/d1/d6/a0/a1/a3
	rts
PosLine_TXT	dc.l	0,128,FASTMEM

FRAMENUMB	dc.l	1


	acode
ScrollUpAreaFix
	;I(D0123W,D7W)(XYWH,DY%)
	BGN
	move.w	d7,d6
	bra.s	UpAreaFix_IN

	acode
ScrollUpArea
	;I(D0123W,D7W)(XYWH,DY%)
	BGN
	move.w	d3,d6
	mulu	d7,d6
	divu	#100,d6
UpAreaFix_IN

	move.w	d0,d4
	add.w	d2,d4
	move.w	d0,d2

	move.w	d1,d5
	add.w	d3,d5
	move.w	d1,d3

	move.w	d6,d1
	moveq	#0,d0
	bsr	GFX_ScrollRaster
	RET

	acode
NGScrollRaster
GFX_ScrollRaster
	puts	d0-d1/a0-a1
;	tst.b	FASTGFX
;	bpl.s	.slow
;	move.l	(a1),a0
;	tst.l	(a0)
;	bra.s	.slow
;cmpi.b	#TRUE,FASTGFXSCROLL
;beq.s	ScrollRasterFast
;.slow

	GFX	ScrollRaster(a6)

GFX_ScrollRaster_X	gets	d0-d1/a0-a1
	rts

;NGScrollRaster
	BGN
	move.l	a1,a0

	tst.w	d1
	bpl.s	.scrollup
	
	;GFX	ScrollRaster(a6)
	move.w	d1,d7
	move.w	d2,d0
	move.w	d3,d1
	sub.w	d7,d3

	sub.w	d0,d4
	sub.w	d1,d5
	add.w	d7,d5
	move.l	#$c0,d6
	GFX	ClipBlit(a6)
	bra.s	.exit
.scrollup
	move.w	d1,d7
	move.w	d2,d0
	move.w	d3,d1
	add.w	d7,d1
	sub.w	d0,d4
	sub.w	d1,d5
	;sub.w	d7,d5
	move.l	#$c0,d6
	GFX	ClipBlit(a6)
.exit	RET


BltBitMap	EQU	-30


GetPEDWindow	;V1.0 NG
		;O(A0L)(PED WINDOW)
	puts	d0
	move.l	#NGWIN_PED,d0
	jsr	NGWindowCheck
	gets	d0


	acode
;ScrollRasterFast
	puts	d2-d7/a2
;	bsr	ShowLayerInfo


	jsr	GetPEDWindow
	cmp.l	#0,a0
	beq.s	.exit


	;puts	d0
	;moveq	#PATTEDWIN_ID,d0
	;jsr	GetIDWindow
	;gets	d0
	
	sub.w	FONT_H,d5
	sub.w	d2,d4
	sub.w	d3,d5


	tst.w	d1
	bmi.s	.FastD

	add.w	4(a0),d2
	add.w	6(a0),d3

	add.w	WINDOW_TOP,d3			;H CORRECTION
	add.w	FONT_H,d3
	addi.w	#4,d2
	add.w	d2,d0
	add.w	d3,d1
	sub.w	FONT_H,d1
	sub.w	FONT_H,d3

.cont
	move.w	#$c0,d6
	moveq	#1,d7
	move.l	4(a1),a0
	move.l	a0,a1
	move.l	Blitmem_PTR,a2
	GFX	BltBitMap(a6)
.exit	gets	d2-d7/a2
	bra	GFX_ScrollRaster_X

.FastD
	add.w	4(a0),d2
	add.w	6(a0),d3
	add.w	WINDOW_TOP,d3			;H CORRECTION
	add.w	FONT_H,d3
	addi.w	#4,d2
	add.w	d2,d0
	add.w	d3,d1
	bra.s	.cont

Blitmem_PTR	dc.l	0,4096,CHIPMEM
FASTGFXSCROLL	dc.b	TRUE


	acode
;CPU_BltBitMap	;Up only
	BGN

	cmp.w	d0,d2
	blo.s	.exit
	

	move.l	8(a1),a2
	move.l	8(a1),a3

	move.w	(a1),d7
	andi.l	#$ffff,d7

	lsr.w	#3,d4

	andi.l	#$ffff,d0
	andi.l	#$ffff,d2
	
	lsr.w	#3,d0
	lsr.w	#3,d2

	mulu	d7,d1
	mulu	d7,d3

	add.l	d1,a2
	add.l	d3,a3
	add.l	d0,a2
	add.l	d2,a3

	subq.w	#1,d4
	move.l	a2,a4
	move.l	a3,a5

.loop2
	move.w	d4,d6
	move.l	a4,a2
	move.l	a5,a3


.loop
		move.b	(a2)+,(a3)+
		dbf	d6,.loop

	add.l	d7,a4
	add.l	d7,a5
	

	dbf	d7,.loop2



.exit	RET
	

	acode
CalcAreaPercLower	;V1.0
	puts	d4
	move.w	d3,d4
	mulu	d7,d4
	divu	#100,d4
	add.w	d3,d1
	sub.w	d4,d1
	move.w	d4,d3
	gets	d4
	rts


;--- REBUILD SOUND SYSTEM ------------------------------------

	acode
DoRestart	;V1.0
	jsr	StopActualSong
	jsr	StopAllChannels
	move.w	#FALSE,PLAYER_STATUS
	move.w	#TRUE,Restart_FLAG
	jsr	MAINEXIT
	jsr	SetResync		;(obsolete ??)
	jsr	ShowMainTitle
	rts

	acode
RebuildSoundSystem	;V1.1
	BGN
	move.w	#FALSE,IRQStuff_STATUS
	jsr	MultiTaskingOff
	jsr	SetZeroVolume

	IFNE DIRECTAMIGAAUDIO
	jsr	AudioDMAOff
	ENDC

	jsr	StopActualSong
	jsr	StopVoices

	IFNE DIRECTAMIGAAUDIO
	jsr	RemoveAudioIRQ
	ENDC

	jsr	FreeVoiceExpander
	jsr	PreCalcMemUsage	
	jsr	GetVoiceExpander
	cmpi.w	#FALSE,d0
	beq.s	RebuildSoundSystem_ERR
	jsr	JumpSetBuffer			;###
	jsr	BuildFreqList
	lea.l	Standard_KEYTRANS,a0
	jsr	InitKeyTrans
	clr.b	LowCPUWarn

	IFNE DIRECTAMIGAAUDIO
	jsr	SetAudioRegisters
	jsr	SetAudioIRQ
;	jsr	AudioDMAReset
	move.w	#$00ff,$9e+CUSTOMBASE
	jsr	AudioDMAOn
	ENDC

	jsr	ClrStreamCount
	jsr	SwapSyncBuffer			;###
	move.w	#TRUE,IRQStuff_STATUS
	jsr	MultiTaskingOn
	jsr	BuildSSTDynamic			;SuperSupportTable
	RET

RebuildSoundSystem_ERR
	jsr	MultiTaskingOn
	move.w	#FALSE,PLAYER_STATUS
	move.w	#TRUE,Restart_FLAG
	jsr	MAINEXIT
	RET


	acode
PreCalcMemUsage
	BGN
	bsr	CopyVexSetup
	bsr	InitVexVars
	move.w	CHANNEL_NUMB,d0
	mulu	#NOTE_SIZEOF,d0
	move.l	d0,VEX_LineSize
	move.w	CHANNEL_NUMB,d0
	move.l	VEX_LinesPerPattern,d1
	move.l	d1,TabulatorMem_PTR+MEM_SIZE
	mulu	#NOTE_SIZEOF,d1
	move.l	d1,VEX_TrackSize
	mulu	d1,d0
	move.l	d0,VEX_PatternSize
	move.l	d0,CALC_PatternLen
	move.l	d0,TrackBuffer_PTR+4
	move.l	d0,ActualBlock_PTR+4
	move.l	d0,UndoBuffer_PTR+4
	move.l	d0,LockBuffer_PTR+4
	move.l	VEX_LinesPerPattern,d0
	move.w	CHANNEL_NUMB,d1
	mulu	d1,d0
	move.l	d0,VEX_NotePerPattern
	move.l	CALC_PatternLen,d0
	move.l	VEX_PattNumb,d1
	mulu.l	d1,d0
	move.l	d0,NoteMem_PTR+4
	;jsr	SecurityCheck
	RET


	acode
RebuildSoundSystem2	;V1.1
	BGN
	jsr	MultiTaskingOff

	move.w	#FALSE,IRQStuff_STATUS

	IFNE DIRECTAMIGAAUDIO
	jsr	AudioDMAOff
	jsr	RemoveAudioIRQ
	ENDC

	jsr	FreeVoiceExpander
	jsr	PreCalcMemUsage2
	jsr	GetVoiceExpander
	cmpi.w	#FALSE,d0
	beq	RebuildSoundSystem_ERR
	jsr	JumpSetBuffer			;###
	jsr	BuildFreqList
	lea.l	Standard_KEYTRANS,a0
	jsr	InitKeyTrans
	clr.b	LowCPUWarn

	IFNE DIRECTAMIGAAUDIO
	jsr	SetAudioRegisters
	jsr	SetAudioIRQ
	move.w	#$00ff,$9e+CUSTOMBASE
	jsr	AudioDMAOn
	ENDC

	jsr	ClrStreamCount
	jsr	SwapSyncBuffer			;###

	move.w	#TRUE,IRQStuff_STATUS
	jsr	MultiTaskingOn
	RET

	acode
PreCalcMemUsage2
;	bsr	CopyVexSetup
	bsr	InitVexVars2
	rts

	IFNE OS3
OverSample3_PTR	dc.l	0,96000,FASTMEM
OverSample3	dc.l	1	;1,2,4,8


;	acode
;ToogleOS3
;	BGN
;	move.l	OverSample3,d0
;	lsl.l	#1,d0
;	cmpi.l	#8,d0
;	bls.s	.ok
;	moveq	#1,d0
;.ok	move.l	d0,OverSample3
;	jsr	RebuildSoundSystem2
;	bsr	DrawOS3Status
;	RET


	IFNE RENDER
	acode
SelectHQ
	BGN
	tst.l	ActualNGWWIN_ID
	beq.s	.exit
	move.l	#"SY4C",d0
	jsr	NGFindGadID
	cmp.l	#0,a0
	beq.s	.exit
	move.l	NGGAD_VALUE(a0),d7
	moveq	#1,d6
	tst.w	d7
	beq.s	.ok
	moveq	#2,d6
	cmpi.w	#1,d7
	beq.s	.ok
	moveq	#4,d6
	cmpi.w	#2,d7
	beq.s	.ok
	moveq	#8,d6
.ok	lea.l	NGWin_Info,a6
	move.l	NGWI_ActiveWindowAdr(a6),a5
	move.l	ActualNGWWIN_ID,d0
	beq	.exit
	jsr	PreClipWIN
	jsr	NGWDrawWindowID
	jsr	NGDrawGadsWindowID
	jsr	DrawSystemSetup
	jsr	ShowDspStatus
	jsr	PostClipWIN
	move.l	d6,OverSample3
	jsr	RebuildSoundSystem2
	jsr	DrawOS3Status
.exit	RET
	ENDC


	acode
DrawOS3Status
	move.l	#" Off",OS3_TXTb
	cmpi.l	#1,OverSample3
	beq.s	.draw
	move.l	#" 2x ",OS3_TXTb
	cmpi.l	#2,OverSample3
	beq.s	.draw
	move.l	#" 4x ",OS3_TXTb
	cmpi.l	#4,OverSample3
	beq.s	.draw
	move.l	#" 8x ",OS3_TXTb
.draw	ASSTXT	OS3_TXT
	rts

	ENDC	

	acode
InitVexVars2
	BGN
	move.l	VexQuality,d7
	move.l	VexSpeed,d6
	move.l	#124*100,d0
	divu	d7,d0
	andi.l	#$ffff,d0
	move.l	d0,VexPeriod
	move.l	#2886700,d3		;NEW Sync'ed calc
	divu.l	d0,d3
	mulu.l	#124,d3
	move.l	d6,d1			;divu #50*VexSpeed
	mulu.l	#50,d1
	divu.l	d1,d3

	andi.l	#$fffe,d3		;NEW:WORD BUFFER LEN
	IFNE OS3
	mulu.l	OverSample3,d3
	ENDC
	move.l	d3,VexBufferSize

	jsr	RecalcFreqBase

	move.l	VexBufferSize,d0
	lsl.l	#2,d0
	move.l	d0,CALCBUF_INFO+BUFINFO_BUFLEN
	move.l	d0,PostDspBUF_INFO+BUFINFO_BUFLEN
	move.l	d0,d1
	mulu.l	VexBufferNumb,d1
	move.l	d1,DryDspBuffer_PTR+MEM_SIZE
	move.l	d0,RenderBuffer_PTR+MEM_SIZE
	move.l	d0,ResoFilter_PTR+MEM_SIZE


	move.l	MAXDSP_ECHO_LEN,d1
	mulu	d1,d0
	move.l	d0,CopyBuffer_PTR+MEM_SIZE
	move.l	d0,PostDspBuffer_PTR+MEM_SIZE

	lea.l	Test_VOICEEXPANDER,a0
	move.l	VexBufferNumb,d0			;4
	puts	d0
	lsr.l	#1,d0
	move.l	d0,VexSyncBufNumb
	gets	d0
	move.w	d0,VOICEEXP_BUFFERPERAUDIO(a0)

	move.l	VexBufferSize,d0
	move.w	d0,VOICEEXP_SAMPLEPERFRAME(a0)

	move.l	VexPeriod,d0
	move.w	d0,VOICEEXP_PERIOD(a0)

	RET


	acode
InitVexVars
	BGN
	move.l	VEX_PattNumb,d0
	move.w	d0,Test_SONG

	mulu	#PATHEAD_SIZEOF,d0
	move.l	d0,First_PATHEAD+4

	move.l	VexQuality,d7
	move.l	VexSpeed,d6

	move.l	#124*100,d0
	divu	d7,d0
	andi.l	#$ffff,d0
	move.l	d0,VexPeriod

	move.l	#2886700,d3		;NEW Sync'ed calc
	divu.l	d0,d3
	mulu.l	#124,d3
	move.l	d6,d1			;divu #50*VexSpeed
	mulu.l	#50,d1
	divu.l	d1,d3

	puts	d0/d3/d4
	clr.w	LargeBufCount
InitVexVars_BuffChk
		move.l	VexBufferNumb,d4
		move.l	d3,d0
		mulu.l	d4,d0

		cmpi.l	#$ffff,d0			;### 1 Buffer Len, new: 2*
		blo.s	InitVexVars_BuffOk		;+#+ blo.s
			move.l	VexBufferNumb,d0
			subq.l	#1,d0
			move.l	d0,VexBufferNumb
			addq.w	#1,LargeBufCount
		bra.s	InitVexVars_BuffChk
InitVexVars_BuffOk				;d0: 1 Buffer Len
	tst.w	LargeBufCount
	beq.s	InitVexBufOk
		;jsr	PrintAssHex		;+#+
		;ASSTXT	LargeBuf_TXT
		jsr	ForceEvenBufNumb
InitVexBufOk
	gets	d0/d3/d4

							;VexBufferNumb
	andi.l	#$fffe,d3		;NEW:WORD BUFFER LEN
	IFNE OS3
	mulu.l	OverSample3,d3
	ENDC
	move.l	d3,VexBufferSize

	jsr	RecalcFreqBase

	move.l	VexBufferSize,d0
	lsl.l	#2,d0

	move.l	d0,CALCBUF_INFO+BUFINFO_BUFLEN
	move.l	d0,PostDspBUF_INFO+BUFINFO_BUFLEN
	move.l	d0,DryDspBuffer_PTR+MEM_SIZE
	move.l	d0,RenderBuffer_PTR+MEM_SIZE
	move.l	d0,ResoFilter_PTR+MEM_SIZE


	move.l	MAXDSP_ECHO_LEN,d1
	mulu	d1,d0
	move.l	d0,CopyBuffer_PTR+MEM_SIZE
	move.l	d0,PostDspBuffer_PTR+MEM_SIZE

	move.l	VexBufferNumb,d1


	lea.l	Test_VOICEEXPANDER,a0

	moveq	#0,d0					;Set Channel Numb
	move.w	CHANNEL_NUMB,d0
	move.w	d0,Song_CHNUMB
	move.w	d0,VOICEEXP_CHANNELNUMB(a0)

	moveq	#0,d0					;Set Audio Numb
	move.w	VexAudioNumb,d0
	move.w	d0,VOICEEXP_AUDIONUMB(a0)
	move.l	VexBufferNumb,d0			;4

	puts	d0
	lsr.l	#1,d0
	move.l	d0,VexSyncBufNumb
	gets	d0

	move.w	d0,VOICEEXP_BUFFERPERAUDIO(a0)
	move.l	VexBufferSize,d0
	move.w	d0,VOICEEXP_SAMPLEPERFRAME(a0)
	move.l	VexPeriod,d0
	move.w	d0,VOICEEXP_PERIOD(a0)
	RET


	acode
CopyVexSetup
	BGN
	lea.l	VEX_Setup,a0
	lea.l	VEX_StartSetup,a1
	move.w	(a0)+,(a1)+
	move.w	(a0)+,(a1)+
	move.w	(a0)+,(a1)+
	moveq	#0,d0
	move.w	CHANNEL_NUMB,d0
	divu	VexAudioNumb,d0
	move.w	d0,VexVoicesPerAudio
	RET



;--- INSTRUMENT OPERATIONS -----------------------------------------------


;--- LOOP SYSTEM ----------------------------------------------

	acode
DoLoopRange:
	BGN
	jsr	CheckInstrument
	cmpi.b	#ISTATE_KILLED,d0
	beq	.exit

	lea.l	NGWin_Info(PC),a6
	tst.l	NGWI_ActiveWindowAdr(a6)
	beq	.exit
	move.l	NGWI_ActiveAreaAdr(a6),a4
	move.l	NGWI_ActiveWindowAdr(a6),a5
	cmpi.b	#TRUE,NGWIN_MOUSECLICK(a5)
	bne	.exit

	cmpi.b	#TRUE,NGArea_Active(a4)
	bne.s	.exit

	ASSTATUS Loopseltxtb
	move.l	NGArea_RP(a4),a1
	movem.w	NGArea_XYWH(a4),d0-d3
	move.w	NGWIN_MOUSECLICK_XY(a5),d0
	move.w	NGWIN_MOUSE_XY(a5),d2

	move.w	NGArea_XYWH(a4),d7
	cmp.w	d7,d2
	bge.s	.ok1
	move.w	d7,d2
.ok1	

	move.w	NGArea_XYWH+4(a4),d6

	puts	d0
	bsr	CheckNewLoopInstr
	cmpi.b	#TRUE,d0
	bne.s	.notnewloop

	move.w	d6,d0
	lsr.w	#2,d0
	sub.w	d0,d6

.notnewloop
	gets	d0
	add.w	d6,d7
	
	cmp.w	d7,d2
	ble.s	.ok2
	move.w	d7,d2
.ok2
	;--- Draw Loop ---
	move.b	#TRUE,Loopactive
	bsr	NGRInvDrMd
	jsr	WaitGfxSync
	bsr	DRectFill
.exit	RET


	acode
DRectFill	;()(X1,Y1,X2,H)
		;D4=MODE
	BGN

	tst.l	MouseSeloldxy
	beq.s	.show
	cmp.w	MouseSeloldxy,d0
	bne.s	.new
	cmp.w	MouseSeloldxy+4,d2
	bne.s	.new
	bra.s	.exit

.new	puts	d0-d3
	movem.w	MouseSeloldxy,d0-d3
	bsr	.do
	gets	d0-d3

.show	movem.w	d0-d3,MouseSeloldxy
	bsr	.do
.exit	RET

.do	BGN
	add.w	d1,d3
	cmp.w	d0,d2
	bhi.s	.ok1
	exg	d0,d2
.ok1	cmp.w	d1,d3
	bhi.s	.ok2
	exg	d1,d3
.ok2	GFX	RectFill(a6)


	moveq	#0,d0
	move.w	MouseSeloldxy,d0
	move.w	MouseSeloldxy+4,d0

	moveq	#0,d0
	moveq	#0,d2
	move.w	NGArea_XYWH+4(a4),d2
	move.w	MouseSeloldxy,d0
	move.w	MouseSeloldxy+4,d1
	cmp.w	d0,d1
	bhi.s	.ok
	exg	d0,d1

.ok	sub.w	NGArea_XYWH(a4),d0
	mulu.l	#$10000,d0
	divu.l	d2,d0
	move.l	d0,d4

	moveq	#0,d0
	move.w	d1,d0
	sub.w	NGArea_XYWH(a4),d0
	mulu.l	#$10000,d0
	divu.l	d2,d0
	RET
MouseSeloldxy	dc.w	0,0,0,0	;Temp old Selection
		dc.w	0,0,0,0	;Final Selection at Mouse Up



LoopSelect
	BGN
	jsr	CheckInstrument
	cmpi.b	#ISTATE_KILLED,d0
	beq	.exit


	lea.l	NGWin_Info(PC),a6
	tst.l	NGWI_ActiveWindowAdr(a6)
	beq	.exit
	move.l	NGWI_ActiveAreaAdr(a6),a4
	move.l	NGWI_ActiveWindowAdr(a6),a5
	beq	.exit
	cmp.l	#0,a4
	beq	.exit
	cmp.l	#0,a5
	beq	.exit
	cmpi.b	#TRUE,NGArea_Active(a4)
	bne	.exit

	move.l	NGArea_RP(a4),a1
	movem.w	NGArea_XYWH(a4),d0-d3
	move.w	NGWIN_MOUSECLICK_XY(a5),d0


	moveq	#0,d0
	moveq	#0,d2
	move.w	NGArea_XYWH+4(a4),d2
	tst.w	d2
	beq	.exit

	move.w	MouseSeloldxy,d0
	move.w	MouseSeloldxy+4,d1
	cmp.w	d0,d1
	bhi.s	.ok
	exg	d0,d1

.ok	;--- FALLS 3/4 LOOP -> COOR ---
	jsr	CorrIfNewLoop
	exg	d0,d1
	jsr	CorrIfNewLoop
	exg	d0,d1


	sub.w	NGArea_XYWH(a4),d0
	mulu.l	#$20000,d0
	divu.l	d2,d0
	move.l	d0,d4

	moveq	#0,d0
	move.w	d1,d0
	sub.w	NGArea_XYWH(a4),d0
	mulu.l	#$20000,d0
	divu.l	d2,d0


	;--- LOOP IN INSTRUMENTNAME SPEICHERN ---
	move.l	d0,d1
	sub.l	d4,d1
	bmi	.exit

	jsr	GetActualInstrument	;A0L
	move.l	a0,a1
	jsr	GetActualInstrName	;A0L

	tst.w	d1
	bne.s	.notzero

	;--- ZERO LEN LOOP ---
	cmpi.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a0)
	beq.s	.setmax
	bclr	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	move.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a0)
	bra.s	.update

.setmax	moveq	#0,d0
	move.l	#100*$10000,d1
	bra.s	.set

.notzero
	move.l	d4,d0
	mulu.l	#50,d0
	mulu.l	#50,d1

.set	move.b	#INSTRTYPE_LOOP,SAMPLENAME_INSTRTYPE(a0)
	jsr	SetNewLoop
	bsr	NewRecalcLoop

.update	jsr	ForceUpdateActInstrType
	jsr	DrawActualWave
	jsr	DrawInstrName
	jsr	DrawLoopType
.exit	RET

CorrIfNewLoop
	puts	d1
	move.l	d0,d1
	jsr	CheckNewLoopInstr
	cmpi.b	#TRUE,d0
	bne.s	.exit
	mulu.l	#4,d1
	divu	#3,d1
.exit	move.l	d1,d0
	gets	d1
	rts
	
CheckNewLoopInstr	;O(D0L)(TRUE/FALSE)
	puts	a0
	moveq	#FALSE,d0
	jsr	GetActualInstrName
	tst.b	(a0)
	beq.s	.exit

	cmpi.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a0)
	beq.s	.exit
	btst	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	beq.s	.exit

	moveq	#TRUE,d0
.exit	gets	a0
	rts


	acode
UpdateChangedInstrType	;V2.0
	puts	a0/a1
	jsr	GetActualInstrument	;A0L
	move.l	a0,a1
	jsr	GetActualInstrName	;A0L
	tst.b	(a0)
	beq.s	.exit
		bsr	UpdateInstrType
.exit	gets	a0/a1
	rts

	acode
ForceUpdateActInstrType:	;V2.0
	puts	a0/a1
	jsr	GetActualInstrument	;A0L
	move.l	a0,a1
	jsr	GetActualInstrName	;A0L
	bsr	UpdateInstrType
	gets	a0/a1
	rts

	acode
UpdateInstrType	;V1.1
		;I(A0L,A1L)(InstrName,Instrument)
		;V1.1 : AutoSet INSTR_MULTI from InstrName
	puts	d0/a0-a2
	;cmpi.w	#INSTRTYPE_KILL,INSTR_TYPE(a1)
	;beq.s	UpdateChangedInstrType_X
	;cmpi.b	#MULTISAMPLE_STEREOL,SAMPLENAME_MULTI(a0)
	;bne.s	.nofastplaycopy
	;bclr	#SPLAYFLAG_SUPERFAST,SAMPLENAME_PLAYFLAG+SampleNameMaxLen(a0)
	;btst	#SPLAYFLAG_SUPERFAST,SAMPLENAME_PLAYFLAG(a0)
	;beq.s	.nofastplaycopy
	;bset	#SPLAYFLAG_SUPERFAST,SAMPLENAME_PLAYFLAG+SampleNameMaxLen(a0)
.nofastplaycopy

	move.b	SAMPLENAME_MULTI(a0),d0
	ext.w	d0
	move.w	d0,INSTR_MULTI(a1)

	move.b	SAMPLENAME_FINETUNE(a0),d0
	ext.w	d0
	move.w	d0,INSTR_FINETUNE(a1)

	move.b	SAMPLENAME_TUNE(a0),d0
	ext.w	d0
	move.w	d0,INSTR_TUNE(a1)

	moveq	#0,d0
	move.b	SAMPLENAME_PLAYFLAG(a0),d0
	move.b	d0,INSTR_PLAYFLAG(a1)

	move.b	SAMPLENAME_INSTRTYPE(a0),d0
	ext.w	d0
	cmpi.w	#INSTRTYPE_MAX,d0
	bhi.s	.exit

	lea.l	UpdateChangedInstrType_JL(PC),a2
	lea.l	(a2,d0.w),a2
	move.l	(a2),a2
	jsr	(a2)
.exit	gets	d0/a0-a2
	rts

UpdateChangedInstrType_JL	dc.l	UpdateChangedINONE,UpdateChangedILOOP,UpdateChangedISUST

	acode
UpdateChangedINONE
	move.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a0)
	move.w	#INSTRTYPE_NONE,INSTR_TYPE(a1)
	rts


	acode
SyncLoop
	BGN
	jsr	GetActualInstrName
	cmpi.b	#MULTISAMPLE_MONO,SAMPLENAME_MULTI(a0)
	beq.s	SyncLoop_X
	cmpi.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a0)
	beq.s	SyncLoop_X
	btst	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	beq.s	SyncLoop_X	
	cmpi.b	#MULTISAMPLE_STEREOL,SAMPLENAME_MULTI(a0)
	bne.s	SyncLoop_R
	jsr	GetNewLoop
	jsr	MoveNextInstrument
	jsr	GetActualInstrName
	jsr	SetNewLoop
	jsr	ForceUpdateActInstrType
	jsr	MovePrevInstrument
	bra.s	SyncLoop_X
SyncLoop_R
	jsr	GetNewLoop
	jsr	MovePrevInstrument
	jsr	GetActualInstrName
	jsr	SetNewLoop
	jsr	ForceUpdateActInstrType
	jsr	MoveNextInstrument
SyncLoop_X
	RET	

	acode
GetNewLoop	;V1.0
		;I(A0L)(SAMPLENAME_PTR)
		;O(D0L,D1L)(LoopStart,LoopLen)
	moveq	#0,d0
	moveq	#0,d1
	move.b	SAMPLENAME_LOOPSTART(a0),d0
	swap	d0
	move.w	SAMPLENAME_LOOPSTARTLO(a0),d0
	move.b	SAMPLENAME_LOOPLEN(a0),d1
	swap	d1
	move.w	SAMPLENAME_LOOPLENLO(a0),d1
	rts

	acode
SetNewLoop	;V1.0
		;I(D0L,D1L)(LoopStart,LoopLen)
		;I(A0L)(SAMPLENAME_PTR)
	puts	d0-d1
	move.w	d0,SAMPLENAME_LOOPSTARTLO(a0)
	swap	d0
	bset	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	move.b	d0,SAMPLENAME_LOOPSTART(a0)

	move.w	d1,SAMPLENAME_LOOPLENLO(a0)
	swap	d1
	move.b	d1,SAMPLENAME_LOOPLEN(a0)
	gets	d0-d1
	rts

	acode
CalcHiLooptoVal
	mulu.l	d0,d2:d3
	divu.l	#100*$10000,d2:d3
	IFNE	SYMPHPRO
	bclr	#0,d3
	ENDC		
	rts

	acode
UpdateChangedILOOP	;I(A0L,A1L)(INSTRNAME,INSTRUMENT)
	btst	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	beq.s	UpdateChangedILOOP_old
	bsr	NewRecalcLoop
	move.w	#INSTRTYPE_LOOP,INSTR_TYPE(a1)		;V1.2
	rts

	acode
NewRecalcLoop	;I(A0L,A1L)(INSTRNAME,INSTRUMENT)
	puts	d0-a6
	bsr	GetNewLoop
	bsr	GetRecalcedLoop
	move.l	INSTR_SAMPLEPTR(a1),d2
	add.l	d2,d0
	add.l	d2,d1
	move.l	d0,INSTR_SAMPLELOOPSTART(a1)
	move.l	d1,INSTR_SAMPLELOOPENDPTR(a1)
	gets	d0-a6
	rts

	acode
GetRecalcedLoop	;I(A1L)(INSTRUMENT)
		;I(D0L,D1L)(RELLOOP_B,RELLOOP_E)
		;O(D0L,D1L)(LOOPBEGIN_OFFS,LOOPEND_OFFS)
	puts	d2-a6
	move.l	INSTR_SAMPLEENDPTR(a1),d3
	sub.l	INSTR_SAMPLEPTR(a1),d3
	move.l	d3,d4
	bsr	CalcHiLooptoVal
	IFNE	SYMPHPRO
	bclr	#0,d3
	ENDC
	move.l	d3,d6				;d6L: BEGIN
	move.l	d4,d3
	add.l	d1,d0
	bsr	CalcHiLooptoVal
	add.l	INSTR_SAMPLEPTR(a1),d3
	cmp.l	INSTR_SAMPLEENDPTR(a1),d3
	bls.s	.ok
	move.l	INSTR_SAMPLEENDPTR(a1),d3
.ok	
	IFNE SYMPHPRO
	bclr	#0,d3
	ENDC
	sub.l	INSTR_SAMPLEPTR(a1),d3
	move.l	d3,d1
	move.l	d6,d0
	gets	d2-a6
	rts


	acode
UpdateChangedILOOP_old
	tst.b	SAMPLENAME_LOOPLEN(a0)
	beq.w	UpdateChangedINONE
	move.w	#INSTRTYPE_LOOP,INSTR_TYPE(a1)		;V1.2
	bsr	UpdateRecalcLoop
	rts

	acode
UpdateRecalcLoop	;V1.1
	BGN
	moveq	#0,d0
	move.b	SAMPLENAME_LOOPSTART(a0),d0
	lsl.w	#7,d0
	divu	#100,d0
	andi.l	#$ffff,d0
	move.l	INSTR_NUMBSAMPLES(a1),d1
	lsr.l	#7,d1
	mulu.l	d0,d1
	IFNE	SYMPHPRO
	addq.l	#1,d1
	bclr	#0,d1
	ENDC
	move.l	INSTR_SAMPLEPTR(a1),d2
		add.l	d1,d2
	move.l	d2,INSTR_SAMPLELOOPSTART(a1)	;SET
	move.l	d2,a2
	move.b	(a2),d3
	IFNE	SYMPHPRO
	move.w	(a2),d3
	ENDC

		
	moveq	#0,d0
	move.b	SAMPLENAME_LOOPLEN(a0),d0
	lsl.w	#7,d0
	divu	#100,d0
	andi.l	#$ffff,d0
	move.l	INSTR_NUMBSAMPLES(a1),d1
	lsr.l	#7,d1
	mulu.l	d0,d1
	IFNE	SYMPHPRO
	addq.l	#1,d1
	bclr	#0,d1

	puts	d0
	move.l	#$7fff,d0
	move.w	VEX_Setup+4,d6
	lsr.w	#1,d6
	divu	d6,d0

	IFNE TESTPRGB	
	jsr	PrintAssHex
	ENDC
	gets	d0


	ENDC
	add.l	d1,d2
	move.l	d2,a3

	
	IFNE	SYMPHPRO
	move.w	-(a3),d4
	bsr	LOOP_SCAN_TEST
	move.w	d4,d5
LOOP_SCAN_L
	move.w	(a3),d4
	bsr	LOOP_SCAN_TEST
	cmp.w	d4,d5
	bne.s	LOOP_FOUND
	subq.l	#4,a3
	cmp.l	a3,a2
	bhs.s	LOOP_FOUND
	addq.l	#2,a3
	bra.s	LOOP_SCAN_L
LOOP_FOUND
	move.l	a3,INSTR_SAMPLELOOPENDPTR(a1)	;SET
	RET

LOOP_SCAN_TEST
	sub.w	d3,d4
	bmi.s	LOOP_SCAN_P
	moveq	#0,d4
	rts
LOOP_SCAN_P
	moveq	#-1,d4
	rts



	ELSE
LOOP_SCAN
	move.b	(a3),d4		;AUTOLOOP 8BIT
	sub.b	d3,d4
	beq.s	LOOP_FOUND
	tst.b	d4
	bpl.s	LOOP_POS
	neg.b	d4
LOOP_POS
	cmpi.b	#6,d4
	blo.s	LOOP_FOUND
	subq.l	#2,a3
	cmp.l	a3,a2
	beq.s	LOOP_FOUND
	addq.l	#1,a3
	bra.s	LOOP_SCAN
LOOP_FOUND
	move.l	a3,INSTR_SAMPLELOOPENDPTR(a1)	;SET
	RET
	ENDC

	acode
UpdateChangedISUST	;V1.1
	btst	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	beq.s	UpdateChangedISUST_old

	bsr	NewRecalcLoop
	bra.s	UpdateChangedISUST_cont

UpdateChangedISUST_old
	tst.b	SAMPLENAME_LOOPLEN(a0)
	beq.w	UpdateChangedINONE
	bsr	UpdateRecalcLoop

UpdateChangedISUST_cont
	move.w	#INSTRTYPE_SUST,INSTR_TYPE(a1)
	move.l	INSTR_SAMPLELOOPENDPTR(a1),INSTR_SAMPLESUSTSTART(a1)

;	move.l	INSTR_SAMPLEPTR(a1),d2
;	add.l	INSTR_NUMBSAMPLES(a1),d2
;	move.l	d2,INSTR_SAMPLESUSTENDPTR(a1)

	move.l	INSTR_SAMPLEENDPTR(a1),INSTR_SAMPLESUSTENDPTR(a1)

;;;;	move.l	INSTR_SAMPLELOOPSTART(a1),INSTR_SAMPLEENDPTR(a1)

	moveq	#0,d0
	move.b	SAMPLENAME_LOOPNUMB(a0),d0
	move.w	d0,INSTR_LOOPNUMB(a1)	
	rts


	acode
MakeSimpleIofSample	;V1.2
			;I(D0L,D1W,A0L,A1L,A2L)(FreqOffset,Pri,SamplemanE_PTR,Instrument_PTR,SampleName_PTR)
			;V1.2	Added Loop Set Routines
	BGN
	move.w	#INSTRTYPE_NONE,INSTR_TYPE(a1)
	move.l	d0,INSTR_FREQOFFSET(a1)
	move.w	d1,INSTR_PRIORITY(a1)
	move.l	SAMPLEMANE_SIZE(a0),INSTR_NUMBSAMPLES(a1)
	move.l	SAMPLEMANE_PTR(a0),INSTR_SAMPLEPTR(a1)
	move.l	SAMPLEMANE_ENDPTR(a0),INSTR_SAMPLEENDPTR(a1)	;V1.1
	move.l	a2,a0	
	cmpi.b	#-1,SAMPLENAME_INSTRTYPE(a0)
	bne.s	.M1
	move.b	#4,SAMPLENAME_INSTRTYPE(a0)
.M1	bsr	UpdateInstrType
	RET



	acode
KillActualInstr	;V1.0
		;;; sollte in V2.0 immer success haben !!!! Kill StereoR -> Kill Both Samples
	BGN
	jsr	GetActualInstrName
	cmpi.b	#MULTISAMPLE_STEREOR,SAMPLENAME_MULTI(a0)
	beq.s	.exit
	cmpi.b	#MULTISAMPLE_STEREOL,SAMPLENAME_MULTI(a0)
	bne.s	.Mono
	jsr	MoveNextInstrument
	bsr	DoKillActualInstr
	jsr	MovePrevInstrument
.Mono	bsr	DoKillActualInstr
.exit	jsr	DrawInstrName
	RET

	IFEQ DEMO
DoAdjustVolume:	;V1.0
	BGN
	move.l	AdjustVol,d1
	move.l	#MaxNumb_Samples-1,d7
	move.l	SampleNames_PTR,a0
.loop	bsr	.do
	lea.l	SampleNameMaxLen(a0),a0
	dbf	d7,.loop
	RET
.do	tst.b	(a0)
	beq.s	.skip
	moveq	#0,d0
	move.b	SAMPLENAME_VOLUME(a0),d0
	tst.b	d0
	bne.s	.vok
	moveq	#100,d0
.vok	mulu	d1,d0
	divu	#100,d0

	tst.w	d0
	bne.s	.ok2
	moveq	#1,d0
.ok2	cmpi.w	#200,d0
	blo.s	.ok3
	move.w	#199,d0
.ok3	move.b	d0,SAMPLENAME_VOLUME(a0)
.skip	rts
	ENDC


ClearInstrNameList:
	puts	d0/a0
	move.l	#MaxNumb_Samples-1,d0
	move.l	SampleNames_PTR,a0
.loop	bsr	ClearIName
	lea.l	SampleNameMaxLen(a0),a0
	dbf	d0,.loop
	gets	d0/a0
	rts

	acode
ClearIName	;I(A0L)(SAMPLENAME)
	puts	d0-d1/a0
	move.w	#SampleNameMaxLen-1,d1
	moveq	#0,d0

.loop	move.b	d0,(a0)+
	dbf	d1,.loop
	gets	d0-d1/a0
	rts

	acode
DoKillActualInstr
	BGN
	jsr	GetActualInstrName
	bsr	ClearIName
	clr.b	(a0)
	move.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a0)
	clr.w	SAMPLENAME_LOOPSTARTLO(a0)
	clr.w	SAMPLENAME_LOOPLENLO(a0)
	clr.b	SAMPLENAME_LOOPSTART(a0)
	clr.b	SAMPLENAME_LOOPLEN(a0)
	clr.b	SAMPLENAME_FINETUNE(a0)
	clr.b	SAMPLENAME_TUNE(a0)
	clr.b	SAMPLENAME_PLAYFLAG(a0)
	clr.b	SAMPLENAME_DOWNSAMPLE(a0)
	clr.b	SAMPLENAME_FILTER(a0)
	clr.b	SAMPLENAME_LSFLAGS(a0)
	clr.b	SAMPLENAME_VOLUME(a0)
	clr.b	SAMPLENAME_RESO(a0)
	clr.b	SAMPLENAME_LOADFLAGS(a0)
	clr.b	SAMPLENAME_RESOFILTERFLAGS(a0)
	clr.b	SAMPLENAME_RESOFILTERNUMB(a0)
	clr.b	SAMPLENAME_VFADESTATUS(a0)
	move.b	#MULTISAMPLE_MONO,SAMPLENAME_MULTI(a0)
	jsr	GetActualInstrument	;A0L
	cmpi.w	#INSTRTYPE_KILL,INSTR_TYPE(a0)
	beq.s	.exit

	;--- remove it ---
	move.w	#INSTRTYPE_KILL,INSTR_TYPE(a0)
	lea.l	Test_INSTRMAN,a0
	move.w	INSTRMAN_ACTUALNUMB(a0),d2
	move.w	d2,d0
	move.l	SAMPLEMANLIST_PTR,a0
	mulu	#SAMPLEMANE_SIZEOF,d0
	lea.l	(a0,d0.l),a0
	jsr	FreeSample
	jsr	InitSampleManEntry
	jsr	DrawActualWave
.exit	RET

	acode
InstrLoopNumbDown
	BGN
	jsr	GetActualInstrument	;A0L
	move.l	a0,a1
	jsr	GetActualInstrName	;A0L
	cmpi.b	#1,SAMPLENAME_LOOPNUMB(a0)
	beq.s	.exit
	subq.w	#1,INSTR_LOOPNUMB(a1)
	subq.b	#1,SAMPLENAME_LOOPNUMB(a0)
	jsr	DrawInstrParam
	jsr	UpdateChangedInstrType
.exit	RET

	acode
InstrLoopNumbUp
	BGN
	jsr	GetActualInstrument	;A0L
	move.l	a0,a1
	jsr	GetActualInstrName	;A0L
	cmpi.b	#255,SAMPLENAME_LOOPNUMB(a0)
	beq.s	.exit
	addq.w	#1,INSTR_LOOPNUMB(a1)
	addq.b	#1,SAMPLENAME_LOOPNUMB(a0)
	jsr	DrawInstrParam
	jsr	UpdateChangedInstrType
.exit	RET

	acode
ToogleIFastPlay
	puts	a0
	jsr	GetActualInstrName
	bchg	#SPLAYFLAG_SUPERFAST,SAMPLENAME_PLAYFLAG(a0)
	jsr	UpdateChangedInstrType
	jsr	DrawInstrName
	gets	a0
	rts

	acode
ToogleIPosTune
	puts	a0
	jsr	GetActualInstrName
	bchg	#SPLAYFLAG_DODETUNE,SAMPLENAME_PLAYFLAG(a0)
	jsr	UpdateChangedInstrType
	jsr	DrawInstrName
	gets	a0
	rts

	acode
ToogleINoDsp
	BGN
	jsr	GetActualInstrName
	bchg	#SPLAYFLAG_NODSP,SAMPLENAME_PLAYFLAG(a0)

	jsr	UpdateChangedInstrType
	jsr	DrawInstrName
	RET


;--- LOOP TYPE ----------------------------------------------------

	acode
SetSilentInstr:
	BGN
	jsr	CheckInstrument
	cmpi.b	#ISTATE_KILLED,d0
	beq.s	.exit

	jsr	GetActualInstrument
	cmpi.w	#INSTRTYPE_KILL,INSTR_TYPE(a0)
	beq.s	.exit
	cmpi.w	#INSTRTYPE_SILENT,INSTR_TYPE(a0)
	beq.s	.m1
		move.w	#INSTRTYPE_SILENT,INSTR_TYPE(a0)
		jsr	DrawInstrName
.exit	RET
.m1		jsr	UpdateChangedInstrType
		jsr	DrawActualWave
		jsr	DrawInstrName
	bra.s	.exit


	acode
SelectLoopType:
	BGN
	jsr	DrawInstrumentReset
	move.l	#"WV08",d0
	jsr	NGFindGadID
	cmp.l	#0,a0
	beq.s	.exit

	jsr	CheckInstrument
	cmpi.b	#ISTATE_KILLED,d0
	beq.s	.draw

	move.l	NGGAD_VALUE(a0),d7
	tst.l	d7
	beq.s	.1shot
	cmpi.l	#1,d7
	beq.s	.loop
	bra.s	.sust


.draw	bsr	DrawLoopType

	lea.l	NGWin_Info,a6
	move.l	NGWI_ActiveWindowAdr(a6),a5
	move.l	NGWIN_ID(a5),d0
	cmp.l	#0,a5
	beq.s	.exit

	jsr	PreClipWIN
	jsr	NGWDrawWindowID
	jsr	NGDrawGadsWindowID
	;jsr	DrawInstrument
	jsr	DrawInstrName
	jsr	PostClipWIN
	jsr	DrawActualWave


.exit	RET
.1shot	bsr	SetSimpleInstr
	bra.s	.draw
.loop	bsr	SetLoopedInstr
	bra.s	.draw
.sust	bsr	SetSustainedInstr
	bra.s	.draw

SetSimpleInstr:
	BGN
	jsr	CheckInstrument
	cmpi.b	#ISTATE_KILLED,d0
	beq.s	.exit
	jsr	GetActualInstrName	;A0L
	move.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a0)
	jsr	UpdateChangedInstrType
.exit	RET

SetLoopedInstr:
	BGN
	jsr	CheckInstrument
	cmpi.b	#ISTATE_KILLED,d0
	beq.s	.exit
	jsr	GetActualInstrName	;A0L
	move.b	#INSTRTYPE_LOOP,SAMPLENAME_INSTRTYPE(a0)
	jsr	UpdateChangedInstrType
.exit	RET

SetSustainedInstr:
	BGN
	jsr	CheckInstrument
	cmpi.b	#ISTATE_KILLED,d0
	beq.s	.exit
	jsr	GetActualInstrName	;A0L
	move.b	#INSTRTYPE_SUST,SAMPLENAME_INSTRTYPE(a0)
	tst.b	SAMPLENAME_LOOPNUMB(a0)
	bne.s	.M1
	move.b	#1,SAMPLENAME_LOOPNUMB(a0)
.M1	jsr	UpdateChangedInstrType
.exit	RET

	acode
DrawLoopType:	;V1.0 NG
	BGN
	moveq	#0,d2
	jsr	CheckInstrument
	cmpi.b	#ISTATE_KILLED,d0
	beq.s	.draw
	jsr	GetActualInstrName
	moveq	#0,d2
	cmpi.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a0)
	beq.s	.draw
	moveq	#1,d2
	cmpi.b	#INSTRTYPE_LOOP,SAMPLENAME_INSTRTYPE(a0)
	beq.s	.draw
	moveq	#2,d2
.draw	move.l	#"WV08",d0

	cmp.w	InstrumentCache+22,d2
	beq.s	.fast
	move.w	d2,InstrumentCache+22
	bsr	NGSetPopGadID
.fast
.exit	RET

NewRegion	EQU	-516
AndRectRegion	EQU	-504
OrRectRegion	EQU	-510
DisposeRegion	EQU	-534

InstallClipRegion	EQU	-174

AndRegionXYWH	;V1.0
		;I(D0W-D3W,A0L)(XYWH,REGION)
	BGN
	cmp.l	#0,a0
	beq.s	.err

	movem.w	UmlaufRegion,d0-d3

	lea.l	.region,a1
	move.w	d0,(a1)
	move.w	d1,2(a1)
	add.w	d0,d2
	add.w	d1,d3
	move.w	d2,4(a1)
	move.w	d3,6(a1)
	CALLGFX	OrRectRegion
.exit	RET
.err	FLASH	f0f
	bra.s	.exit
.region	dc.w	0,0,100,100
UmlaufRegion	dc.w	0,0,0,0

PreClipWIN	;I(A5L,NGWIN)
	BGN
	CALLGFX	NewRegion
	move.l	d0,ClipWINRegion
	tst.l	d0
	beq.s	.err

	move.l	ClipWINRegion,a0
	moveq	#30,d0
	moveq	#30,d1
	moveq	#100,d2
	moveq	#100,d3
	bsr	AndRegionXYWH

	move.l	NGWIN_WPTR(a5),a4
	move.l	124(a4),ClipWINLayer
	tst.l	ClipWINLayer
	beq.s	.exit

	move.l	ClipWINLayer,a0
	move.l	ClipWINRegion,a1
	move.l	_LayersBase,a6
	jsr	InstallClipRegion(a6)
.exit	RET
.err	FLASH	f0f
	bra.s	.exit

PostClipWIN
	BGN
	;--- CLIP AUFLOESEN ---
	move.l	ClipWINLayer,a0
	cmp.l	#0,a0
	beq.s	.exit2
	suba.l	a1,a1
	move.l	_LayersBase,a6
	jsr	InstallClipRegion(a6)
	clr.l	ClipWINLayer

	;--- REGION FREE ---
.exit2	move.l	ClipWINRegion,a0
	cmp.l	#0,a0
	beq.s	.exit
	CALLGFX DisposeRegion
	clr.l	ClipWINRegion
.exit	RET

ClipWINLayer	dc.l	0
ClipWINRegion	dc.l	0


SST_SYS_GetMem			EQU	0
SST_SYS_FreeMem			EQU	4

SST_FILE_RequestFileName	EQU	100
SST_FILE_SetReqPattern		EQU	104
SST_FILE_SetReqDir		EQU	108
SST_FILE_GetFileName		EQU	112
SST_FILE_GetFileLen		EQU	116

SST_GFX_AssistText		EQU	200
SST_GFX_AssistDecLong		EQU	204
SST_GFX_AssistDecByte		EQU	208
SST_GFX_AssistHexLong		EQU	212

SST_AUDIO_GetChunkLen		EQU	400

SST_PTR_EXECBASE		EQU	1600
SST_PTR_INTBASE			EQU	1604
SST_PTR_DOSBASE			EQU	1608
SST_PTR_ASLBASE			EQU	1612
SST_PTR_REQTOOLSBASE		EQU	1616
SST_PTR_GFXBASE			EQU	1620

SST_PTR_Screen			EQU	1650

SST_ADR_ProcessorFlags		EQU	1800
SST_ADR_SystemFrequency		EQU	1804
SST_ADR_SystemBpm		EQU	1808
SST_ADR_ChunkLen		EQU	1812
SST_ADR_OversampleFlag		EQU	1816
SST_ADR_MaxAmplitude		EQU	1820	;$7fff in SymPRO
SST_ADR_BitPerSample		EQU	1824	;16 for 16 Bit Stream


	acode
EventEDLock	;v1.0
	eori.b	#-1,EventED_STATUS
	beq.s	.text2
	ASSTXT	Eventon
	bra.s	.exit
.text2
	ASSTXT	Eventoff
.exit	rts



	acode
TransResoDwn
	subi.w	#TRANSRESOSTEP,TransWResoDepth
	rts
TransResoUp
	addi.w	#TRANSRESOSTEP,TransWResoDepth
	rts


	IFNE DIRECTAMIGAAUDIO
	acode
EnterColorOrgan	;V1.0
	BGN
	cmpi.b	#TRUE,CLIST_ENABLED
	beq.s	.off
	jsr		MakeCopperList
	move.l	CopperList_PTR,a0
	jsr		ActivateCopList
	move.b	#TRUE,CLIST_ENABLED
	RET
.off
	jsr		SetOldCList
	move.b	#FALSE,CLIST_ENABLED
	RET
	ENDC

	acode
RedrawPED
	BGN
	move.l	#"PTED",d0
	move.l	#"PED2",d1
	jsr		NGRDrawAreaID
	jsr		AdjustActualPattEd
	RET

	acode
ClearPED
	BGN
	move.l	#"PTED",d0
	move.l	#"PED2",d1
	jsr		NGRDrawAreaID
	RET

	acode
ToogleViewDetail	;V1.0
	eori.b	#-1,PED_ViewDetail
	move.l	#10,NOTELEN
	tst.b	PED_ViewDetail
	beq.s	.ok
	move.l	#5,NOTELEN
.ok	bsr		RedrawPED
	rts


	acode
BuildSuperSupportTable
	bsr		BuildSSTStatic
	bsr		BuildSSTDynamic
	rts
	
	acode
BuildSSTStatic
	IFEQ	SYMPHPRO
	rts
	ENDC
	BGN
	move.l	SuperSupportTable_PTR,a0
	move.l	4,SST_PTR_EXECBASE(a0)
	move.l	_IntuitionBase,SST_PTR_INTBASE(a0)
	move.l	_DOSBase,SST_PTR_DOSBASE(a0)
	move.l	_AslBase,SST_PTR_ASLBASE(a0)
	move.l	_GraphicsBase,SST_PTR_GFXBASE(a0)
	move.l	_ReqToolsBase,SST_PTR_REQTOOLSBASE(a0)

	move.l	#GetMem,SST_SYS_GetMem(a0)
	move.l	#FreeMem,SST_SYS_FreeMem(a0)
	
	move.l	#PrintAssHex,SST_GFX_AssistHexLong(a0)
	move.l	#WriteAssDecLong,SST_GFX_AssistDecLong(a0)
	move.l	#PrintAssText,SST_GFX_AssistText(a0)
	move.l	#PrintAssDecByte,SST_GFX_AssistDecByte(a0)

	move.l	#GetStreamBufBytes,SST_AUDIO_GetChunkLen(a0)

	move.l	#GetFileName,SST_FILE_GetFileName(a0)
	move.l	#SetFileRequestPat,SST_FILE_SetReqPattern(a0)
	move.l	#SetFileRequestPath,SST_FILE_SetReqDir(a0)
	move.l	#SimpleFileRequest,SST_FILE_RequestFileName(a0)
	move.l	#FileLength,SST_FILE_GetFileLen(a0)

	moveq	#0,d0
	move.w	Processor_FLAGS,d0
	move.l	d0,SST_ADR_ProcessorFlags(a0)

	move.l	#$7fff,SST_ADR_MaxAmplitude(a0)
	move.l	#16,SST_ADR_BitPerSample(a0)

	RET

	acode
BuildSSTDynamic	;V1.0
	IFEQ	SYMPHPRO
	rts
	ENDC
	BGN
	move.l	SuperSupportTable_PTR,a0
	jsr	GetStreamBufBytes
	move.l	d0,SST_ADR_ChunkLen(a0)
	jsr	GetSystemFreq
	move.l	d0,SST_ADR_SystemFrequency(a0)
	move.w	OverSamp_FLAG,d0
	ext.l	d0
	move.l	d0,SST_ADR_OversampleFlag(a0)
	move.l	VexSpeed,d0
	mulu	#6,d0
	lsr.w	#2,d0
	move.l	d0,SST_ADR_SystemBpm(a0)
	RET


	acode
GetFileName	;V1.0
	move.l	FinalFileNameRT_PTR,a0
	rts

	acode
DSPPlugLoad	;V1.0						;DSP PLUGIN
	IFEQ	SYMPHPRO
	rts
	ENDC
	BGN
	lea.l	DSPPLUG_MATCH,a0
	jsr	SetFileRequestPat

	moveq	#PBUFID_DSP,d0
	jsr	GetPathBuf
	lea.l	DSPLoad_TXT,a0
	jsr	SimpleFileRequest
	jsr	SavePathBuf

	tst.w	d0
	beq.w	DSPPlugLoad_X

	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	DSPPLUG_MATCH+2,a1
	jsr	AddExtention

	bsr	DSPPlugCleanup
	jsr	FlushCaches

	move.l	#MODE_OLDFILE,d0
	jsr	EasyDOpenFFN
	tst.l	d0
	beq.w	DSPPlugLoad_X

	jsr	GetFileName	
	jsr	FileLength
	move.l	d0,d7
	lea.l	DSPPlugInMem_PTR(PC),a0
	move.l	d0,4(a0)
	jsr	GetMem
	tst.l	d0
	beq	DSPPlugLoad_ERR

	move.l	d7,d0
	move.l	DSPPlugInMem_PTR,a0
	jsr	EasyDRead
	tst.l	d0
	beq	DSPPlugLoad_RERR

	jsr	FlushCaches

	move.l	DSPPlugInMem_PTR,a0
	cmpi.l	#"Symp",(a0)+
	bne.s	DSPPlugLoad_RERR
	cmpi.l	#"honi",(a0)+
	bne.s	DSPPlugLoad_RERR
	cmpi.l	#"e DS",(a0)+
	bne.s	DSPPlugLoad_RERR
	cmpi.l	#"P Pl",(a0)+
	bne.s	DSPPlugLoad_RERR
	cmpi.l	#"ugin",(a0)+
	bne.s	DSPPlugLoad_RERR
	cmpi.w	#1,(a0)+
	bne.s	DSPPlugLoad_RERR
	cmpi.w	#0,(a0)+
	bne.s	DSPPlugLoad_RERR

	jsr	EasyDClose
	jsr	AnalyzeDSPParamDef
	move.b	#TRUE,DSPPlug_INMEM
	jsr	ShowDSPPlugGui
DSPPlugLoad_X
	RET

DSPPlugLoad_RERR
	lea.l	DSPPlugInMem_PTR(PC),a0
		move.l	#$00010003,MEM_DEBUG_INFO
		move.l	#$00000000,MEM_DEBUG_INFO+4
	jsr	FreeMem
DSPPlugLoad_ERR
	lea.l	NoDSPPlugMem_TXT,a0
	jsr	PrintAssText
	clr.l	DSPGUIDefMem
	bsr	ShowDSPPlugGui
	jsr	EasyDClose
	bra.s	DSPPlugLoad_X

	acode
NotifyDSPPlugIn
	cmpi.b	#TRUE,DSPPlug_INMEM
	bne.s	.exit
	cmpi.b	#TRUE,DSPPLUG_STATUS
	beq.s	.mark
.exit	rts
.mark	BGN
	bsr	GetDSPPlugInJL
	jsr	24(a6)
	RET

	acode
StrBgn	tst.b	(a0)+
	bne.s	StrBgn
	rts

	acode
AnalyzeDSPParamDef
	BGN
	bsr	GetDSPPlugInJL
	move.l	SuperSupportTable_PTR,a0
	jsr	(a6)

	lea.l	DSPGUIDefMem,a2

	clr.l	(a2)
	tst.b	(a0)
	beq.s	AnalDSPGUIDef_X		;No GUI Def

	lea.l	16(a2),a1

	move.l	a1,(a2)+
	move.l	a1,(a2)+

	moveq	#0,d7

.loop1	tst.b	(a0)
	beq.s	AnalDSPGUIDef_X
	move.l	a1,(a2)
	move.l	a0,DSPPLUGGUI_TXT(a1)

	bsr	StrBgn

	move.l	(a0),d0
	move.l	(a0),DSPPLUGGUI_PARAM(a1)	;INIT
	addq.l	#4,a0

	move.l	(a0),d0
	move.l	(a0),DSPPLUGGUI_MIN(a1)	;MIN
	addq.l	#4,a0


	move.l	(a0),d0
	move.l	(a0),DSPPLUGGUI_MAX(a1)	;MAX
	addq.l	#4,a0


	move.l	d7,DSPPLUGGUI_ID(a1)
	addq.l	#1,d7
	lea.l	DSPPLUGGUI_SIZEOF(a1),a1
	bra.s	.loop1
	
AnalDSPGUIDef_X
	RET

	acode
ShowDSPPlugGui
	BGN
	cmpi.b	#TRUE,DSPPlug_INMEM
	bne.s	.empty	;ShowDSPEmptyGui
	move.l	DSPGUIDefMem,a5
	tst.l	DSPGUIDefMem
	beq.s	.empty

	move.l	DSPPLUGGUI_TXT(a5),a0
	move.l	#"SY95",d0
	moveq	#10,d1
	jsr	NGODrawTextLen

	move.l	DSPPLUGGUI_PARAM(a5),d2
	move.l	#"SY98",d0
	jsr	NGODrawDecWord5Char
.exit	RET
.empty	lea.l	.DSPEGui_TXT(PC),a0
	move.l	#"SY95",d0
	jsr	NGODrawText
	lea.l	.DSPEGui_TXT+5(PC),a0
	move.l	#"SY98",d0
	jsr	NGODrawText
	bra.s	.exit
.DSPEGui_TXT	dc.b	"----------",0

	acode
NGODrawTextLen	;I(D0L,D1W,A0L)(ID,LEN,PTR)
	BGN
	move.l	d0,d2

	bsr	NGRGetLen
	sub.w	d0,d1
	neg.w	d1

	lea.l	.txtb,a1
	clr.b	(a1)
	jsr	AddString

	lea.l	.txtb,a0
	lea.l	(a0,d1.w),a0
	move.l	d2,d0
	jsr	NGODrawText
	
	RET
.txt	blk.b	16,32
.txtb	blk.b	16,0



;.DSPEGui_TXT2	dc.b	"------",0
;DSPEGui_TXT3	dc.b	"       ",0
;DSPEGui_TXT4	dc.b	"      ",0

	acode
DSPPlugInMem_PTR	dc.l	0,0,FASTMEM

DSPPLUGGUI_TXT		EQU	0
DSPPLUGGUI_PARAM	EQU	4
DSPPLUGGUI_MIN		EQU	8
DSPPLUGGUI_MAX		EQU	12
DSPPLUGGUI_ID		EQU	16
DSPPLUGGUI_SIZEOF	EQU	5*4




	acode
DSPPlugOn
	cmpi.b	#TRUE,DSPPlug_INMEM
	beq.s	.ok
	rts

.ok	BGN
	move.b	#TRUE,DSPPLUG_STATUS
	jsr	GetDSPPlugInJL
	jsr	28(a6)
	RET

DSPPlugOff
	BGN
	move.b	#FALSE,DSPPLUG_STATUS
	tst.b	DSPPlug_INMEM
	beq.s	.exit

	jsr	GetDSPPlugInJL
	jsr	32(a6)

.exit	RET

	acode
GetDSPGUIDefMemPtrs
	move.l	DSPGUIDefMem,d0
	move.l	DSPGUIDefMem+4,d1
	move.l	DSPGUIDefMem+8,d2
	rts

	acode
DSPPlugReportValue
	BGN
	cmpi.b	#TRUE,DSPPlug_INMEM
	bne.s	.exit
	tst.l	DSPGUIDefMem
	beq.s	.exit

	move.l	DSPGUIDefMem,a0
	move.l	DSPPLUGGUI_PARAM(a0),d0
	move.l	DSPPLUGGUI_ID(a0),d1
	jsr	GetDSPPlugInJL
	jsr	16(a6)
.exit	RET

	acode
DSPPlugCleanup
	BGN
	bsr	DSPPlugOff
	tst.b	DSPPlug_INMEM
	beq.s	.exit
		jsr	GetDSPPlugInJL
		jsr	4(a6)
		move.b	#FALSE,DSPPlug_INMEM

		lea.l	DSPPlugInMem_PTR(PC),a0
		move.l	#$00010003,MEM_DEBUG_INFO
		move.l	#$00000000,MEM_DEBUG_INFO+4
		jsr	FreeMem
.exit	clr.l	DSPGUIDefMem
	RET

	acode
DSPParamPrev
	BGN
	cmpi.b	#TRUE,DSPPlug_INMEM
	bne.s	.exit
	bsr	GetDSPGUIDefMemPtrs
	tst.l	d0
	beq.s	.exit
	cmp.l	d0,d1
	beq.s	.exit
	subi.l	#DSPPLUGGUI_SIZEOF,DSPGUIDefMem
	jsr	ShowDSPPlugGui
.exit	RET

	acode
DSPParamNext
	BGN
	cmpi.b	#TRUE,DSPPlug_INMEM
	bne.s	.exit
	bsr	GetDSPGUIDefMemPtrs
	tst.l	d0
	beq.s	.exit
	cmp.l	d0,d2
	beq.s	.exit
	addi.l	#DSPPLUGGUI_SIZEOF,DSPGUIDefMem
	jsr	ShowDSPPlugGui
	
.exit	RET

	acode
DSPParamDown
	BGN
	cmpi.b	#TRUE,DSPPlug_INMEM
	bne.s	.exit
	move.l	DSPGUIDefMem,a0
	tst.l	(a0)
	beq.s	.exit
	jsr	SetDecShiftKeyRaster
	move.l	DSPPLUGGUI_PARAM(a0),d1
	sub.l	d0,d1
	cmp.l	DSPPLUGGUI_MIN(a0),d1
	bge.s	.range
		move.l	DSPPLUGGUI_MIN(a0),d1
.range	move.l	d1,DSPPLUGGUI_PARAM(a0)
	jsr	ShowDSPPlugGui
	jsr	DSPPlugReportValue
.exit	RET

	acode
DSPParamUp
	BGN
	cmpi.b	#TRUE,DSPPlug_INMEM
	bne.s	.exit
	move.l	DSPGUIDefMem,a0
	tst.l	(a0)
	beq.s	.exit
	jsr	SetDecShiftKeyRaster
	add.l	DSPPLUGGUI_PARAM(a0),d0
	cmp.l	DSPPLUGGUI_MAX(a0),d0
	ble.s	.range
		move.l	DSPPLUGGUI_MAX(a0),d0
.range	move.l	d0,DSPPLUGGUI_PARAM(a0)
	jsr	ShowDSPPlugGui
	jsr	DSPPlugReportValue
.exit	RET

DSPPLUGHEAD_SIZEOF	EQU	6*4


	acode
GetDSPPlugInJL
	move.l	DSPPlugInMem_PTR,a6
	lea.l	DSPPLUGHEAD_SIZEOF(a6),a6
	rts	

	acode
ProcDSPPlugIn
	bsr	GetDSPPlugInJL
	jsr	8(a6)
	rts

;	acode
;MVolD	puts	d0
;	bsr	SetDecShiftKeyRaster
;	sub.b	d0,SYSVOL
;	bpl.s	.exit
;	clr.w	SYSVOL
;.exit	jsr	WaitGfxSync
;	jsr	DrawMVolume
;	gets	d0
;	rts
;	acode
;MVolU	puts	d0
;	bsr	SetDecShiftKeyRaster
;	add.b	d0,SYSVOL
;	cmpi.b	#MAXMASTERVOL,SYSVOL
;	bls.s	.exit
;	move.b	#MAXMASTERVOL,SYSVOL
;.exit	jsr	WaitGfxSync
;	jsr	DrawMVolume
;	gets	d0
;	rts
;	acode
;BalD	puts	d0
;	bsr	SetDecShiftKeyRaster
;	sub.b	d0,SYSVOL+2
;	bpl.s	.exit
;	clr.w	SYSVOL+2
;.exit	jsr	WaitGfxSync
;	jsr	DrawMBalance
;	gets	d0
;	rts
;	acode
;BalU	puts	d0
;	bsr	SetDecShiftKeyRaster
;	add.b	d0,SYSVOL+2
;	cmpi.b	#100,SYSVOL+2
;	bls.s	.exit
;	move.b	#100,SYSVOL+2
;.exit	jsr	WaitGfxSync
;	jsr	DrawMBalance
;	gets	d0
;	rts

LCom
	BGN
	IFEQ	DEMO
	jsr	GetActualNotePtr
	move.b	NOTE_FX(a0),NoteSave+NOTE_FX
	ENDC
	RET

	acode
SCom
	BGN
	IFEQ	DEMO
	jsr	GetActualNotePtr
	move.b	NoteSave+NOTE_FX,NOTE_FX(a0)
	jsr	PatEdDrawActLine
	jsr	DrawEventStatus
	ENDC
	RET

	acode
LICom
	BGN
	IFEQ	DEMO
	jsr	GetActualNotePtr
	move.b	NOTE_INSTR(a0),NoteSave+NOTE_INSTR
	ENDC
	RET

	acode
SICom
	BGN
	IFEQ	DEMO
	jsr	GetActualNotePtr
	move.b	NoteSave+NOTE_INSTR,NOTE_INSTR(a0)
	jsr	PatEdDrawActLine
	jsr	DrawEventStatus
	ENDC
	RET

	acode
LPCom
	BGN
	IFEQ	DEMO
	jsr	GetActualNotePtr
	move.b	NOTE_PITCH(a0),NoteSave+NOTE_PITCH
	ENDC
	RET

	acode
SPCom
	BGN
	IFEQ	DEMO
	jsr	GetActualNotePtr
	move.b	NoteSave+NOTE_PITCH,NOTE_PITCH(a0)
	jsr	PatEdDrawActLine
	jsr	DrawEventStatus
	ENDC
	RET

	acode
LVCom
	BGN
	IFEQ	DEMO
	jsr	GetActualNotePtr
	move.b	NOTE_VOLUME(a0),NoteSave+NOTE_VOLUME
	ENDC
	RET

	acode
SVCom
	BGN
	IFEQ	DEMO
	FLASH	0f0
	jsr	GetActualNotePtr
	move.b	NoteSave+NOTE_VOLUME,NOTE_VOLUME(a0)
	jsr	PatEdDrawActLine
	jsr	DrawEventStatus
	ENDC
	RET

NoteSave	dc.l	0

	acode
InstrFineTuneDown
	BGN
	jsr	GetActualInstrName
	jsr	SetDecShiftKeyRaster
	sub.b	d0,SAMPLENAME_FINETUNE(a0)
	jsr	UpdateChangedInstrType
	jsr	DrawInstrName
	RET


	acode
InstrFineTuneUp
	BGN
	jsr	GetActualInstrName
	jsr	SetDecShiftKeyRaster
	add.b	d0,SAMPLENAME_FINETUNE(a0)
	jsr	UpdateChangedInstrType
	jsr	DrawInstrName
	RET

	acode
InstrTuneDown
	BGN
	jsr	GetActualInstrName
	move.b	SAMPLENAME_TUNE(a0),d1
	cmpi.b	#-24,d1
	beq.s	.exit

	jsr	SetOctaveKeyRaster
	sub.b	d0,d1
	cmpi.b	#-24,d1
	bge.s	.ok
		moveq	#-24,d1
.ok	move.b	d1,SAMPLENAME_TUNE(a0)
	jsr	UpdateChangedInstrType
	jsr	DrawInstrName
.exit	RET

	acode
InstrTuneUp
	BGN
	jsr	GetActualInstrName
	move.b	SAMPLENAME_TUNE(a0),d1
	cmpi.b	#24,d1
	beq.s	.exit

	jsr	SetOctaveKeyRaster
	add.b	d0,d1
	cmpi.b	#24,d1
	ble.s	.ok
		moveq	#24,d1
.ok	move.b	d1,SAMPLENAME_TUNE(a0)
	jsr	UpdateChangedInstrType
	jsr	DrawInstrName
.exit	RET

	acode
SetOctaveKeyRaster
		;O(D0L)(1 or 12)
	moveq	#1,d0
	cmpi.w	#TRUE,Shift_KEY
	beq.s	SetOctShiftRaster_X
	rts
SetOctShiftRaster_X	moveq	#0,d0
	move.w	Actual_FREQDEF+FREQDEF_OCTAVE,d0
	rts

	acode
SetDecShiftKeyRaster
		;O(D0L)(1 or 10)
	moveq	#1,d0
	cmpi.w	#TRUE,Shift_KEY
	beq.s	SetDecShiftRaster_X
	rts
SetDecShiftRaster_X
	moveq	#10,d0
	rts

	acode
SetPosNegShiftRaster
		;O(D0L)(1 or -1)
	moveq	#1,d0
	cmpi.w	#TRUE,Shift_KEY
	bne.s	SetPosNegShiftRaster_X
		moveq	#-1,d0
SetPosNegShiftRaster_X	rts


;MIDILIB BEGIN ------------------------------------------------
	IFNE	MIDILIB

MIDIPITCH_TUNE	EQU	36

;OpenMidiDevice	EQU	-$cc
;CloseMidiDevice	EQU	-$d2

UnlockCAMD	EQU	-$24

CreateMidiA	EQU	-$2a
DeleteMidi	EQU	-$30

AddMidiLinkA	EQU	-$54

GetMidi		EQU	-$90
MidiMsgLen	EQU	-$c0
MidiMsgType	EQU	-$ba

;       GetMidi -- Get next MidiMsg from buffer.

;       BOOL GetMidi (struct MidiNode *mn, MidiMsg *msg)
;                             a0                 a1

;       Gets the next MidiMsg from mn->MsgQueue.
;       It is definitely not safe to call this if there's no MsgQueue.

;   INPUTS
;       mn - pointer to MidiNode.
;       msg - pointer to buffer to place MidiMsg removed from
;         queue.

;   RESULTS
;       TRUE if a MidiMsg was actually copied in msg.  FALSE
;       if the buffer was empty.

;   SEE ALSO
;       WaitMidi()



	acode
InitMidi	;v1.0
	BGN
	bsr	DeInitMidi
	ASSTXT	OpenCamd

	clr.l	CAMDMidiNode

	tst.l	_CamdBase
	bne.s	.libok

	ASSTXT	NoCAMDlib
	bra	.exit


.libok	lea.l	CreateNode_TAGS(PC),a0
	CALLMIDI CreateMidiA
	move.l	d0,CAMDMidiNode
	tst.l	d0
	beq.s	.nodeerr1
	tst.l	d0
	bpl.s	.nodeok

	clr.l	CAMDMidiNode
.nodeerr1	
	ASSTXT	NoMidiNode
	bra.s	.exit

.nodeok	ASSTXT	MidiNodeOk
	

	move.l	CAMDMidiNode,a0
	move.l	#MLTYPE_Receiver,d0
	lea.l	openmidilink_TAGS(PC),a1
	CALLMIDI AddMidiLinkA
	move.l	d0,CAMDMidiLinkIn
	tst.l	d0
	beq.s	.err1
	cmpi.l	#-1,d0
	beq.s	.err2

	ASSTXT	MidiLinkOk
	bra.s	.exit

.err1
.err2	clr.l	CAMDMidiLinkIn
	ASSTXT	NoCamdMIDI
	bsr	DeInitMidi

.exit	clr.l	MidiAKey
	RET


	acode
CAMDMidiNode	dc.l	0
CAMDMidiLinkIn	dc.l	0

	acode
CreateNode_TAGS	dc.l	MIDI_Name,MidiName_TXT
		dc.l	MIDI_SysExSize,10000
		dc.l	MIDI_BufferSize,10000
		dc.l	MIDI_RecvSignal,SIGBREAKB_CTRL_E
		dc.l	TAG_DONE

	acode
openmidilink_TAGS	
		dc.l	MLINK_Name,MLInName
		dc.l	MLINK_Location,MLLocation
		dc.l	MLINK_ErrorCode,0
		dc.l	TAG_DONE



	acode
DeInitMidi	;v1.0
	BGN
	tst.l	_CamdBase
	beq.s	.exit
	tst.l	CAMDMidiNode
	beq.s	.exit

	ASSTXT	ClMidiNode
	move.l	CAMDMidiNode,a0
	CALLMIDI DeleteMidi
.exit	
	clr.l	MidiAKey
	RET



	acode
CheckMidiMsg	;v1.0
	BGN
	clr.l	MidiAKey

	tst.l	_CamdBase
	beq	.exit
	tst.l	CAMDMidiNode
	beq	.exit
	tst.l	CAMDMidiLinkIn
	beq	.exit


	;--- Midi ok, get a message ------------------
.nextmsg
	move.l	CAMDMidiNode,a0
	move.l	midimsgbufferPtr,a1
	cmp.l	#0,a1
	beq	.exit
	clr.l	(a1)
	clr.l	4(a1)

	CALLMIDI GetMidi
	tst.l	d0
	beq	.exit

	move.l	midimsgbufferPtr,a0
	move.b	(a0),d7			;d7: Msg Type

	cmp.b	MidiKeyOnMsg,d7
	bne.s	.nokeyon
	tst.b	2(a0)
	beq.s	.nextmsg

	;--- KEY ON MSG 9x --------------------------------------
	moveq	#0,d0
	move.b	1(a0),d0

	subi.b	#MIDIPITCH_TUNE,d0
	move.w	d0,MidiAKey
	move.b	2(a0),d0
	move.w	d0,MidiAKey+2
	mulu	#100,d0
	divu	#128,d0
	tst.l	KeyboardEditPunch
	beq.s	.dynamicpunch
	move.l	KeyboardEditPunch,d0
.dynamicpunch	
	move.w	d0,KeyboardPunch

	jsr	PlayMidiKeyboard
	bra.s	.nextmsg

	; --- OTHER MIDI MSG ---------------------------------
.nokeyon
	cmp.b	MidiPrgChange,d7
	bne.s	.noinstrselect

	; --- MIDI: $Cx = GOTO INSTRUMENT --------------------
	moveq	#0,d0
	move.b	1(a0),d0
	andi.w	#$7f,d0
	jsr	GotoInstrNum	
	bra	.nextmsg

.noinstrselect
	cmpi.b	#$fa,(a0)
	beq.s	.midisongstart
	cmpi.b	#$fb,(a0)
	beq.s	.midisongcont
	cmpi.b	#$fc,(a0)
	beq.s	.midisongstop


	ASSTXT	UnknownMsgIn
	move.l	a0,a1
	moveq	#2-1,d0
	jsr	PrintHexBlock
	bra	.nextmsg
.midisongstart
	jsr	PlayActualSong
	bra	.nextmsg
.midisongcont
	jsr	PlayFromActualPos
	bra	.nextmsg
.midisongstop
	jsr	StopSong2
	bra	.nextmsg

.exit	
	move.l	KeyboardEditPunch,d0
	move.w	d0,KeyboardPunch
	RET


	acode
midimsgbufferPtr	dc.l	0,10000,FASTMEM
MidiAKey			dc.w	0,0	;Pitch,Vol
KeyboardPunch		dc.w	100	;1-100


	ENDC
;MIDILIB END --------------------------------------------------

	acode
SetOS14Bit	;Set OS
	BGN
	IFNE	TOCCATA
	jsr	StopToccata
	ENDC
	move.w	#-1,OverSamp_FLAG
	move.l	#CopyBackStreamOS14Bit_Stereo,COPYBACK_JR
	jsr		RecalcFreqSystem
	jsr		ShowMainTitle
	IFNE DIRECTAMIGAAUDIO
	move.w	#$00ff,$9e+CUSTOMBASE
	ENDC
	jsr		AdjustAudioRegs
	RET
	
	acode
SetOS9Bit	;Set OS
	BGN
	IFNE	TOCCATA
	jsr		StopToccata
	ENDC
	move.w	#-1,OverSamp_FLAG
	move.l	#CopyBackStreamOS9Bit_Stereo,COPYBACK_JR
	jsr		RecalcFreqSystem
	jsr		ShowMainTitle
	IFNE DIRECTAMIGAAUDIO
	move.w	#$00ff,$9e+CUSTOMBASE
	ENDC
	jsr		AdjustAudioRegs
	RET
	
;SetStereoMode
;	BGN
;	IFNE	TOCCATA
;	jsr	StopToccata
;	ENDC
;	clr.w	OverSamp_FLAG
;	jsr	RecalcFreqSystem
;	move.l	#CopyBackStream8Bit_Stereo,COPYBACK_JR
;	jsr	ShowMainTitle
;	move.w	#$00ff,$9e+CUSTOMBASE
;	jsr	AdjustAudioRegs
;	RET

	acode
SetStereo9Mode					;clicks
	BGN
	IFNE	TOCCATA
	jsr		StopToccata
	ENDC
	jsr		SetZeroVolume
	clr.w	OverSamp_FLAG
	jsr		RecalcFreqSystem
	move.l	#CopyBackStream9Bit_Stereo,COPYBACK_JR
	jsr		ShowMainTitle
	IFNE DIRECTAMIGAAUDIO
	move.w	#$00ff,$9e+CUSTOMBASE
	ENDC
	jsr		AdjustAudioRegs
	RET

;SetExternMode
;	BGN
;	IFNE	TOCCATA
;	tst.l	TOCCATABASE
;	beq.s	SetExternMode_X
;	clr.b	ExtResync
;	bsr		SetStereo9Mode
;	jsr		GetToccata
;	cmpi.w	#TRUE,d0
;	bne.s	SetExternMode_ERR
;	jsr		RecalcFreqSystem
;	move.l	#CopyBack_Extern,COPYBACK_JR
;	jsr		ShowMainTitle
;	move.w	#$00ff,$9e+CUSTOMBASE
;	ENDC
;SetExternMode_X
;	RET
;SetExternMode_ERR
;	IFNE	TOCCATA
;	jsr		FreeToccataBuffers
;	jsr		SetStereo9Mode
;		ENDC
;	bra.s	SetExternMode_X

	acode
	dc.l	SetStereo14Mode
StartupMode	tst.l	StartupMode-4
	bne.s	StartupMode_do
	rts
StartupMode_do
	puts	a0
	move.l	StartupMode-4(PC),a0
	jsr	(a0)
	clr.l	StartupMode-4
	gets	a0
	rts

	acode
SetStereo14Mode
	BGN
	clr.w	OverSamp_FLAG
	jsr		RecalcFreqSystem

	IFNE	TOCCATA
	jsr		StopToccata
	ENDC

	IFNE	SOUND14BIT
	move.l	#CopyBackStream14Bit_Stereo,COPYBACK_JR
	ENDC


	jsr		ShowMainTitle
	jsr		AdjustAudioRegs
	RET

	acode
SetZeroVolume
	IFNE DIRECTAMIGAAUDIO
	BGN
	moveq	#0,d0
	moveq	#0,d1
	bra.s	setvol_IN
	ENDC
	rts

	acode
AdjustAudioRegs
	BGN
	IFNE DIRECTAMIGAAUDIO
	moveq	#64,d0
	moveq	#64,d1

setvol_IN
	cmpi.l	#CopyBackStream14Bit_Stereo,COPYBACK_JR
	beq.s	AdjustAudioRegs_14Bit
	cmpi.l	#CopyBackStreamOS14Bit_Stereo,COPYBACK_JR
	beq.s	AdjustAudioRegs_14Bit

	cmpi.l	#CopyBackStream14Bit_Surround,COPYBACK_JR
	beq.s	AdjustAudioRegs_14Bit
	cmpi.l	#CopyBackStream14Bit_Left,COPYBACK_JR
	beq.s	AdjustAudioRegs_14Bit
	cmpi.l	#CopyBackStream14Bit_Right,COPYBACK_JR
	beq.s	AdjustAudioRegs_14Bit
	cmpi.l	#CopyBackStream14Bit_Mono,COPYBACK_JR
	beq.s	AdjustAudioRegs_14Bit
	bra.s	AdjustAudioRegs_do
AdjustAudioRegs_14Bit
	moveq	#1,d1
AdjustAudioRegs_do
	move.w	d0,$dff0a8
	nop
	move.w	d0,$dff0b8
	nop
	move.w	d1,$dff0c8
	nop
	move.w	d1,$dff0d8
	nop
	ENDC
	RET

	acode
SetMonoSurrMode
	BGN
	IFNE	TOCCATA
	jsr	StopToccata
	ENDC
	clr.w	OverSamp_FLAG
	jsr	RecalcFreqSystem
	move.l	#CopyBackStream14Bit_Surround,COPYBACK_JR
	jsr	ShowMainTitle
	jsr	AdjustAudioRegs
	RET

	acode
SetMonoMode
	BGN
	IFNE	TOCCATA
	jsr	StopToccata
	ENDC
	clr.w	OverSamp_FLAG
	jsr	RecalcFreqSystem
	move.l	#CopyBackStream14Bit_Mono,COPYBACK_JR
	jsr	ShowMainTitle
	jsr	AdjustAudioRegs
	RET

	acode
SetLeftSurrMode
	BGN
	IFNE	TOCCATA
	jsr	StopToccata
	ENDC
	clr.w	OverSamp_FLAG
	jsr	RecalcFreqSystem
	move.l	#CopyBackStream14Bit_Left,COPYBACK_JR
	jsr	ShowMainTitle
	jsr	AdjustAudioRegs
	RET

	acode
SetRightSurrMode
	BGN
	IFNE	TOCCATA
	jsr	StopToccata
	ENDC
	clr.w	OverSamp_FLAG
	jsr	RecalcFreqSystem
	move.l	#CopyBackStream14Bit_Right,COPYBACK_JR
	jsr	ShowMainTitle
	jsr	AdjustAudioRegs
	RET

	acode
RecalcFreqBase
	puts	d0
	move.l	VexPeriod,d0
	mulu	#131,d0
	tst.w	OverSamp_FLAG
	beq.s	.ToogleOS
	lsl.l	#1,d0
.ToogleOS	
	IFNE OS3
	divu.l	OverSample3,d0
	ENDC

	move.l	d0,System_FreqBase
	gets	d0
	rts

	acode
RecalcFreqSystem
	jsr	RecalcFreqBase	
	jsr	BuildFreqList
	jsr	BuildSSTDynamic
	rts

	acode
RecordMacro	;V2.0
	jsr	ToogleRecordMsg
	cmpi.w	#TRUE,AnalyzeMsgRECORD_FLAG
	bne	.exit
	jsr	AnalyzeMsgInitRecord
.exit	jsr	ShowMainTitle
	rts

	acode
ReplayMacro	;V2.0
	BGN
	jsr	BackupPattern
	jsr	BackupPatternOff
	jsr	ForceStopRecordMsg
	jsr	ShowMainTitle
	jsr	ReplayRecordedMsg
	jsr	DrawEventStatus
	jsr	PatEdDrawPattern
	jsr	BackupPatternOn
	RET


;--- GFX LIBRARY -------------------------------------------

	acode
ConvertHexLine	;V1.0
		;I(A0L,A1L,D0W)(MEM,DESTTXT,NUMB_H)
		BGN
		exg	a0,a1
		move.l	d0,d1
		subq.w	#1,d1
DrawHexBlockL	move.l	(a1)+,d0
			bsr.b	ConvertToHexLong
			addq.l	#8,a0
		dbf	d1,DrawHexBlockL		
		RET



	acode
ConvertDumpLine	;V1.0
		;I(A0L,A1L,D0W)(MEM,DESTTXT,NUMB_H)
	BGN
	move.l	a0,a2
	exg	a0,a1
	move.l	d0,d1
	subq.w	#1,d1
	move.w	d1,d2
DrawDumpL	move.l	(a1)+,d0
		bsr.b	ConvertToHexLong
		addq.l	#8,a0
		move.b	#" ",(a0)+
	dbf	d1,DrawDumpL

	move.b	#" ",(a0)+
DrawDumpL2
		move.b	(a2)+,(a0)+
		move.b	(a2)+,(a0)+
		move.b	(a2)+,(a0)+
		move.b	(a2)+,(a0)+
	dbf	d2,DrawDumpL2
	RET


	acode
ConvertToHexLong ;V1.0
		 ;I(D0L,A0L)(VALUE,TEXT_PTR)
	BGN
	moveq	#7,d2
	lea     HexList(PC),a1
CHLloop	rol.l	#4,d0
		move.w	d0,d1	
		andi.w	#$f,d1
		move.b	(a1,d1.w),(a0)+
	dbf	d2,CHLloop
	RET


	acode
DrawDecByte	;V2.0
		;I(D0B,A1L)(VALUE,RP)
		;PRINTS A DecByte AT ACTUAL CRSRPOS
	BGN
	jsr	ConvertToDecByte
	lea	DecByteSave,a0
	moveq	#3,d0
	GFX	Text(a6)
	RET

	acode
DrawSignDecByte ;V1.1
		;I(D0B,A1L)(SIGN VALUE,RP)
	;cmpi.b	#100,d0
	tst.b	d0
	bpl.w	DrawDecByte
	BGN
	bsr	ConvertToSignDecByte
	lea.l	SignDecByte_TXT(PC),a0
	moveq	#3,d0
	GFX	Text(a6)
	RET
SignDecByte_TXT	dc.b	"-00",0

	acode
ConvertToSignDecByte	;V1.0
			;I(D0B)(VALUE)
	BGN
	lea.l	SignDecByte_TXT(PC),a0
	move.b	#" ",(a0)
	tst.b	d0
	bpl.s	.Draw
	cmpi.b	#-100,d0
	bgt.s	.N2
	move.b	#"=",(a0)
	neg.b	d0
	bra.s	.Draw
.N2	move.b	#"-",(a0)
	neg.b	d0
.Draw	jsr	ConvertToDecByte
	lea	DecByteSave,a2
	move.b	1(a2),1(a0)
	move.b	2(a2),2(a0)
	RET


	acode
DrawSignDecByteXY
	puts	d0
	bsr.w	GFX_Move
	move.w	d2,d0
	andi.l	#$ff,d0
	bsr	DrawSignDecByte
	gets	d0
	rts

	acode
DrawDecByteXY	;V1.0
	puts	d0
	bsr.w	GFX_Move
	move.w	d2,d0
	andi.l	#$ff,d0
	bsr.w	DrawDecByte
	gets	d0
	rts

	acode
WriteAssNum:
	BGN
	lea.l	AssNum(PC),a0
	clr.b	4(a0)
	bsr	AddString3Word
	ASSTXT	AssNum
	RET
AssNum	dc.l	0,0

	acode
WriteAssDecLong:
	puts	a0
	lea.l	DecLongSave(PC),a0
	jsr	ConvertToDecLong
	clr.b	10(a0)
	ASSTXT	DecLongSave
	gets	a0
	rts

PrintRenderInfoSize	;V1.0
	BGN
	move.w	#"B ",.DecLongSave2
	moveq	#0,d7
	cmpi.l	#16000,d0
	bls.s	.exit
	move.w	#"Kb",.DecLongSave2
	moveq	#1,d7
	divu.l	#1000,d0
	cmpi.l	#5000,d0
	blo.s	.exit
	move.w	#"Mb",.DecLongSave2
	divu.l	#1000,d0
	moveq	#2,d7
.exit	swap	d7
	move.w	d0,d7
	cmp.l	RIlastvalue,d7
	beq.s	.exit2
	lea.l	.DecLongSave,a0
	jsr	ConvertToDecLong
	ASSTXT	.DecLongSave
.exit2	RET
.DecLongSave	dc.b	"           "
.DecLongSave2	dc.b	"B ",0,0
RIlastvalue	dc.w	0,0



	acode
AddString3Word	;I(D0W,A0L)(Number[1..9999],STRING_PTR)
	puts	a1
	move.l	a0,a1
	lea.l	DecWordSave(PC),a0
	jsr	ConvertToDecWord
	lea.l	DecWordSave+2(PC),a0

	move.b	(a0)+,(a1)+
	move.b	(a0)+,(a1)+
	move.b	(a0)+,(a1)+
	move.b	#" ",(a1)+
	move.l	a1,a0
	gets	a1
	rts

	acode
AddString3Word2	;I(D0W,A0L)(Number[1..9999],STRING_PTR)
	puts	a0-a1
	move.l	a0,a1
	lea.l	DecWordSave(PC),a0
	jsr	ConvertToDecWord
	lea.l	DecWordSave+2(PC),a0
	move.b	(a0)+,(a1)+
	move.b	(a0)+,(a1)+
	move.b	(a0),(a1)
	gets	a0-a1
	rts


	acode
DecWordXY3Char	;V1.0
	puts	d0-d1/a0-a1/a6
	bsr.w	GFX_Move
	move.w	d2,d0

	lea.l	DecWordSave(PC),a0
	jsr	ConvertToDecWord
	moveq	#3,d0
	lea.l	DecWordSave+2(PC),a0
	GFX	Text(a6)
	gets	d0-d1/a0-a1/a6
	rts

	acode
DrawDecWordXY	;V1.0
	puts	d0
	bsr.w	GFX_Move
	move.w	d2,d0
	bsr.b	DrawDecWord
	gets	d0
	rts

	acode
ConvertToDecLong	;V1.0
			;I(D0L,A0L)(NUM,TEXT)
	movem.l	d0-d5/a0-a1,-(a7)
	moveq	#"0",d5
	move.l	d0,d2
	moveq	#0,d1
	move.l	a0,a1
	lea.l	10(a0),a0
	move.w	#9,d4
DecLSLOOP
	divu.l	#10,d1:d2
		move.b	d1,d3
		andi.b	#$f,d3
		add.b	d5,d3
		move.b	d3,-(a0)
	moveq	#0,d1
	dbf	d4,DecLSLOOP
	moveq	#8,d0
DecLongClr_L	cmp.b	(a1),d5
		bne.s	DecLongClr_X
		move.b	#" ",(a1)+
		dbf	d0,DecLongClr_L
DecLongClr_X	movem.l	(a7)+,d0-d5/a0-a1
	rts

	acode
DrawDecWord	;V2.0
	BGN
	lea.l	DecWordSave(PC),a0
	jsr	ConvertToDecWord
	moveq	#5,d0
	GFX	Text(a6)
	RET
DecWordSave	dc.l	0,0,0,0

	acode
DrawDecLong	;V2.0
	BGN
	bsr	GFX_Move
	lea.l	DecLongSave(PC),a0
	move.l	d2,d0
	jsr	ConvertToDecLong
	moveq	#10,d0
	GFX	Text(a6)
	RET
DecLongSave	dc.l	0,0,0,0

	acode
DrawHexLong	;V1.0
		;I(D0,A1)(VALUE,RP)
		;PRINTS A HEXLONG AT ACTUAL CRSRPOS
	movem.l	d0-d2/a0-a3/a5/a6,-(a7)
	move.l	a1,a5
	lea	HexLongSave,a2
	move.w	#7,d2
WHLloop	lea	HexList,a3
		rol.l	#4,d0
		move.l	d0,d1	
		andi.l	#$f,d1
		move.b	(a3,d1),(a2)+
	 dbf	d2,WHLloop
	;move.l	GFXBASE,a6
		lea	HexLongSave,a0
		move.l	#8,d0
		move.l	a5,a1
		;jsr	Text(a6)
		CALLGFX Text
	movem.l	(a7)+,d0-d2/a0-a3/a5/a6
	rts	
HexList	dc.b	"0123456789ABCDEF"
HexLongSave	dc.b	"........"
	even

	acode
DrawHexLongXY	;V2.0
		;I(X,Y,VALUE,RP)(d0,d1,d2,A1)
	bsr	GFX_Move
	exg	d0,d2
	bsr	DrawHexLong
	exg	d0,d2
	rts	

	acode
DrawText	;V1.0
		;(A0L,A1L)(STR,RP)
	puts	d0-d1/a0-a1/a6
	CHECKREG3 a1,DrawText,.exit
	jsr	GetLen
	GFX	Text(a6)
.exit	gets	d0-d1/a0-a1/a6
	rts

TextLength	EQU	-54



TextLen:	;V1.0
		;(A0L,A1L)(STR,RP)
	puts	d1/a0-a1/a6
	CHECKREG3 a1,TextLen,.exit
	GFX	TextLength(a6)
.exit	gets	d1/a0-a1/a6
	rts

	acode
DrawTextXY:	;V1.0
		;(A0L,A1L,D0W,D1W)(STR,RP,X,Y)
	bsr.w	GFX_Move
	bsr	DrawText
	rts

	acode
GFX_WritePixel
	CHECKREG3 a1,GFX_WritePixel,.exit
	puts	d0-d1/a0-a1/a6
	GFX	WritePixel(a6)
	gets	d0-d1/a0-a1/a6
.exit	rts


	acode
GFX_Text:	
	puts	d0-d1/a0-a1/a6
	CHECKREG3 a1,GFX_Text,.exit
	GFX	Text(a6)
.exit	gets	d0-d1/a0-a1/a6
	rts

	acode
GFX_Move:
	puts	d0-d1/a0-a1/a6
	CHECKREG3 a1,GFX_Move,.exit
	GFX	Move(a6)
.exit	gets	d0-d1/a0-a1/a6
	rts

	acode
DrawLine:
	CHECKREG3 a1,DrawLine,.exit
	bsr	GFX_Move
	exg	d2,d0
	exg	d3,d1
	bsr	GFX_Draw
	exg	d2,d0
	exg	d3,d1
.exit	rts
	
	acode
GFX_Draw:
	CHECKREG3 a1,GFX_Draw,.exit
	puts	d0-d1/a0-a1/a6
	GFX	Draw(a6)	
	gets	d0-d1/a0-a1/a6
.exit	rts

GFX_APen:	puts	d0-d1/a0-a1/a6
	CHECKREG3 a1,GFX_APen,.exit
	GFX	SetAPen(a6)	
.exit	gets	d0-d1/a0-a1/a6
	rts

GFX_BPen:	puts	d0-d1/a0-a1/a6
	CHECKREG3 a1,GFX_BPen,.exit
	move.w	d0,OLD_BPEN
	GFX	SetBPen(a6)	
.exit	gets	d0-d1/a0-a1/a6
	rts
OLD_BPEN	dc.w	0

	acode
GFX_DrMd:	puts	d0-d1/a0-a1/a6
	CHECKREG3 a1,GFX_DrMd,.exit
	cmp.l	#0,a1
	beq.s	.exit
	GFX	SetDrMd(a6)
.exit	gets	d0-d1/a0-a1/a6
	rts

	acode
Normal0Mode	BGN
	moveq	#0,d0
	bsr	GFX_DrMd
	RET		
	acode
NormalMode	BGN
	moveq	#1,d0
	bsr	GFX_DrMd
	RET		

;	acode
;InverseMode	BGN
;	moveq	#3,d0
;	bsr	GFX_DrMd
;	RET		

;-----------------------------------------------------------

AudioIRQ	EQU	$70


	acode
GetProcessor
	BGN
	move.l	EXECBASE,a6
	move.w	AttnFlags(a6),d0
	move.b	#FALSE,Processor_FLUSH
	btst	#AFB_68040,d0
	beq.s	No040Processor
		move.b	#TRUE,Processor_FLUSH
No040Processor
	move.w	d0,Processor_FLAGS
	RET
Processor_FLAGS	dc.w	0
Processor_FLUSH	dc.b	FALSE	;(-1=DO FLUSH)
	even


	acode
FlushCaches
	BGN
	CALLEXEC CacheClearU
	RET
;---------------------------------------------------------






BuildLineSample_SRCNUMB	dc.w	0
BuildLineINFO_PTR	dc.l	0,512,FASTMEM

LINENAMEID		EQU	"ViRT"	;only visual info, not to be used for real ID !!!

	;LINENAMEDUR		EQU	"DUR "
	;LINENAMEMOLL		EQU	"MOLL "


BUILDINFO_ESIZEOF	EQU	4

LINENAME_ID		EQU	0
LINENAME_ZERO		EQU	4
LINENAME_VERSION	EQU	6	;unused
LINENAME_MIXINFO	EQU	8	;unused

LINENAME_EOS		EQU	12	;NULL


LINENAME_SRCNUMB	EQU	14
LINENAME_HEADLEN	EQU	16
LINENAME_SRCDEFLEN	EQU	18

LINEHEAD_SIZEOF	EQU	20


LINESRCDEF_NPITCH	EQU	0
LINESRCDEF_NINSTRUMENT	EQU	2
LINESRCDEF_NVOLUME	EQU	3

LINESRCDEF_SIZEOF	EQU	4

LOOPSTEPFAK_INIT	EQU	3

	acode
GetLoopStep	;V1.0
		;O(D2L)(LOOPSTEP)
	puts	d0-d1/d3/a0
	jsr	GetActualInstrument
	move.l	INSTR_NUMBSAMPLES(a0),d0
	move.l	#100*$10000,d1
	divu.l	d0,d1
	move.l	d1,d0
	tst.l	d0
	bne.s	.ok
		moveq	#1,d0
.ok
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.ok2
	move.l	LOOPSTEPFAK(PC),d3
	mulu.l	d3,d0

	mulu	#33,d3
	lsr.l	#5,d3
	addi.l	#LOOPSTEPFAK_INIT/2,d3
	cmpi.l	#$10000,d3
	blo.s	.ok3
		move.l	#$ffff,d3
.ok3	move.l	d3,LOOPSTEPFAK

	bra.s	.exit
.ok2	move.l	#LOOPSTEPFAK_INIT,LOOPSTEPFAK

.exit	move.l	d0,d2
	lsl.l	#1,d2
	gets	d0-d1/d3/a0
	rts

LOOPSTEPFAK	dc.l	LOOPSTEPFAK_INIT

	acode
LoopLeft
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq.s	.exit
	bsr	GetLoopStep
	btst	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	beq.s	.new
	move.b	#TRUE,QuickLoopRedraw
.new
	bset	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	jsr	GetNewLoop
	sub.l	d2,d0
	bpl.s	.ok
	add.l	d2,d0
	move.l	d0,d2
	moveq	#0,d0
.ok	add.l	d2,d1
	jsr	SetNewLoop
	jsr	ForceUpdateActInstrType
	jsr	DrawInstrument
.exit	RET

	acode
LoopRight
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq.s	.exit
	bsr	GetLoopStep
	btst	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	beq.s	.new
	move.b	#TRUE,QuickLoopRedraw
.new
	bset	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	jsr	GetNewLoop
	add.l	d2,d0
	sub.l	d2,d1
	bpl.s	.ok
		add.l	d2,d1
		sub.l	d2,d0
.ok	
	jsr	SetNewLoop
	jsr	ForceUpdateActInstrType
	jsr	DrawInstrument
.exit	RET

QuickLoopRedraw	dc.b	FALSE

	acode
LoopSmaller
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq.s	.exit
	bsr	GetLoopStep
	btst	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	beq.s	.new
	move.b	#TRUE,QuickLoopRedraw
.new
	bset	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	jsr	GetNewLoop
	sub.l	d2,d1
	bmi.s	.err
	tst.l	d1
	beq.s	.err
.cont	
	jsr	SetNewLoop
	jsr	ForceUpdateActInstrType
	jsr	DrawInstrument
.exit	RET
.err	add.l	d2,d1
	bra.s	.cont

	acode
LoopLarger
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq.s	.exit
	bsr	GetLoopStep
	btst	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	beq.s	.new
	move.b	#TRUE,QuickLoopRedraw
.new
	bset	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	jsr	GetNewLoop
	add.l	d2,d1
	move.l	d1,d3
	add.l	d0,d3
	cmpi.l	#100*$10000,d3
	bls.s	.ok
		move.l	#100*$10000,d3
		sub.l	d0,d3
		move.l	d3,d1
.ok	
	jsr	SetNewLoop
	jsr	ForceUpdateActInstrType
	jsr	DrawInstrument
.exit	RET

	acode
RangeClr
	BGN
	jsr	GetActualInstrName
	bclr	#SNINFO_RANGED,SAMPLENAME_INFO(a0)
	clr.b	SAMPLENAME_RANGEBGN(a0)
	clr.b	SAMPLENAME_RANGELEN(a0)
	jsr	DrawInstrName
	RET

	acode
RangeLoop
	BGN
	jsr	GetActualInstrName
	bset	#SNINFO_RANGED,SAMPLENAME_INFO(a0)
	move.b	SAMPLENAME_LOOPSTART(a0),SAMPLENAME_RANGEBGN(a0)
	move.b	SAMPLENAME_LOOPLEN(a0),SAMPLENAME_RANGELEN(a0)
	jsr	DrawInstrName
	RET

	acode
SetRvsLineSample
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq.s	.exit
	bchg	#LSFLAGS_RVS,SAMPLENAME_LSFLAGS(a0)
	bsr	ReMakeSample
	jsr	DrawInstrName
.exit	RET

	acode
SetMirrSample
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq.s	.exit
	bchg	#LSFLAGS_MIRROR,SAMPLENAME_LSFLAGS(a0)
	bsr	ReMakeSample
	jsr	DrawInstrName
.exit	RET

	acode
SetFilter	;V2.0
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq.s	.exit
	jsr	SetPosNegShiftRaster
	add.b	d0,SAMPLENAME_FILTER(a0)
	bsr	ReMakeSample
	jsr	DrawInstrName
.exit	RET

	IFEQ SMALLGUI
SetFilter2
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq.s	.exit
	move.l	a0,a2
.rep	move.b	SAMPLENAME_FILTER(a2),d0
	extb.l	d0
	lea.l	EditBuf,a0
	move.l	d0,(a0)
	lea.l	LPFilter_TXT,a1
	moveq	#-32,d1
	move.l	#127,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit
	move.l	(a0),d0
	move.b	d0,SAMPLENAME_FILTER(a2)
	bsr	ReMakeSample
	jsr	DrawInstrName
.exit	RET

	IFNE	NEWFILTER
	acode
SetSampleVolFade	;V1.0
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq	.exit
	move.l	a0,a2

	clr.b	SAMPLENAME_VFADESTATUS(a2)
	;cmpi.w	#TRUE,Shift_KEY



	ASSTATUS SampleVFade


	lea.l	.editbuffer,a0
	lea.l	SampleVFadeBgn,a1
	moveq	#0,d1
	move.l	#100,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq	.abort
	lea.l	.editbuffer+4,a0
	lea.l	SampleVFadeEnd,a1
	moveq	#0,d1
	move.l	#100,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq	.abort

	move.b	#2,SAMPLENAME_VFADESTATUS(a2)
	move.l	.editbuffer,d2
	move.b	d2,SAMPLENAME_VFADEBGN(a2)
	move.l	.editbuffer+4,d2
	move.b	d2,SAMPLENAME_VFADEEND(a2)

.ok	bsr	ReMakeSample
	jsr	DrawInstrName
.exit	RET
.abort	ASSTATUS	SampleVFadeClr
	bra.s	.ok

.editbuffer	dc.l	100,0,100,0,0,0

	acode
SetResoFilter	;V1.0
	BGN
	moveq	#"L",d6
	move.b	d6,ResoFilterLP
	move.b	d6,ResoFilterLPb
	move.b	d6,ResoFilterAbort
	move.b	d6,ResoFilterSweep
	move.b	d6,ResoFilterStatic+7

	jsr	GetActualInstrName
	tst.b	(a0)
	beq	.exit
	move.l	a0,a2
	clr.b	SAMPLENAME_RESOFILTERFLAGS(a2)
	moveq	#0,d7
	cmpi.w	#TRUE,Shift_KEY
	beq	SetResoFilterHP


	ASSTATUS ResoFilterLP

	lea.l	.editbuffer,a0
	lea.l	LPResoFilter_TXT,a1
	moveq	#0,d1
	move.l	#255,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq	.abort
	lea.l	.editbuffer+4,a0
	lea.l	LPResoFilterB_TXT,a1
	moveq	#0,d1
	move.l	#255,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq	.abort

	;--- 1 POL static
	moveq	#%01,d7
	move.b	#1,SAMPLENAME_RESOFILTERNUMB(a2)
	move.l	.editbuffer,d0
	move.b	d0,SAMPLENAME_RESOFILTER(a2)
	move.l	.editbuffer+4,d0
	move.b	d0,SAMPLENAME_RESOFILTER+1(a2)


	ASSTATUS	ResoFilterLPb
	lea.l	.editbuffer+8,a0
	lea.l	LPResoFilter_TXT,a1
	moveq	#0,d1
	move.l	#255,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.static
	lea.l	.editbuffer+12,a0
	lea.l	LPResoFilterB_TXT,a1
	moveq	#0,d1
	move.l	#255,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.static

	;--- 2 POL fading
	moveq	#%0101,d7
	move.b	#2,SAMPLENAME_RESOFILTERNUMB(a2)
	move.l	.editbuffer+8,d0
	move.b	d0,SAMPLENAME_RESOFILTER+2(a2)
	move.l	.editbuffer+12,d0
	move.b	d0,SAMPLENAME_RESOFILTER+3(a2)
	ASSTATUS	ResoFilterSweep	
.ok	move.b	d7,SAMPLENAME_RESOFILTERFLAGS(a2)
	bsr	ReMakeSample
	jsr	DrawInstrName
.exit	RET
.abort	ASSTATUS	ResoFilterAbort
	bra.s	.ok
.static	ASSTATUS	ResoFilterStatic
	bra.s	.ok

.editbuffer	dc.l	30,0,30,0,0,0



SetResoFilterHP
	moveq	#"H",d6
	move.b	d6,ResoFilterLP
	move.b	d6,ResoFilterLPb
	move.b	d6,ResoFilterAbort
	move.b	d6,ResoFilterSweep
	move.b	d6,ResoFilterStatic+7

	ASSTATUS ResoFilterLP
	lea.l	.editbuffer,a0
	lea.l	LPResoFilter_TXT,a1
	moveq	#0,d1
	move.l	#255,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq	.abort
	lea.l	.editbuffer+4,a0
	lea.l	LPResoFilterB_TXT,a1
	moveq	#0,d1
	move.l	#255,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq	.abort

	;--- 1 POL static
	moveq	#%11,d7
	move.b	#1,SAMPLENAME_RESOFILTERNUMB(a2)
	move.l	.editbuffer,d0
	move.b	d0,SAMPLENAME_RESOFILTER(a2)
	move.l	.editbuffer+4,d0
	move.b	d0,SAMPLENAME_RESOFILTER+1(a2)


	ASSTATUS	ResoFilterLPb
	lea.l	.editbuffer+8,a0
	lea.l	LPResoFilter_TXT,a1
	moveq	#0,d1
	move.l	#255,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.static
	lea.l	.editbuffer+12,a0
	lea.l	LPResoFilterB_TXT,a1
	moveq	#0,d1
	move.l	#255,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.static

	;--- 2 POL fading
	moveq	#%1111,d7
	move.b	#2,SAMPLENAME_RESOFILTERNUMB(a2)
	move.l	.editbuffer+8,d0
	move.b	d0,SAMPLENAME_RESOFILTER+2(a2)
	move.l	.editbuffer+12,d0
	move.b	d0,SAMPLENAME_RESOFILTER+3(a2)
	ASSTATUS	ResoFilterSweep	
.ok	move.b	d7,SAMPLENAME_RESOFILTERFLAGS(a2)
	bsr	ReMakeSample
	jsr	DrawInstrName
.exit	RET
.abort	ASSTATUS	ResoFilterAbort
	bra.s	.ok
.static	ASSTATUS	ResoFilterStatic
	bra.s	.ok
.editbuffer	dc.l	30,0,30,0,0,0
	ENDC

	ENDC
	;SMALLGUI

	acode
SetSamplePreOverS	;V2.0
	BGN
	lea.l	SAMPLEPreOverS,a0
	lea.l	SetSamplePreOverS_TXT,a1
	moveq	#1,d1
	moveq	#4,d2
	jsr	ReqMinMaxLong
	RET

	acode
SetScopeFrames
	BGN
	lea.l	FRAMENUMB,a0
	lea.l	ScopeFrame_TXT,a1	
	moveq	#1,d1
	moveq	#50,d2
	jsr	ReqMinMaxLong
	RET

;	acode
;InitSampleBoost
;	move.l	#100,SAMPLEBOOST_BAK
;UpdateSampleBoost
;	BGN
;	move.l	SAMPLEBOOST_BAK,SAMPLEBOOST
;	bra.s	InitSampleB_LINK

	acode
SetSampleBoost
NGSetSampleBoost	;V1.0
	BGN
	tst.l	NGSampleBoost
	bne.s	.ok
	move.l	#NGSAMPLEBOOST_DEFAULT,NGSampleBoost

.ok	lea.l	NGSampleBoost,a0
	lea.l	SetSampleBoost_TXT,a1	
	moveq	#1,d1
	move.l	#10000,d2
	jsr	ReqMinMaxLong
	RET

SetNoiseLimit
	BGN
	lea.l	VL_PROCVLIMIT-2,a0
	lea.l	ProcVLimit_TXT,a1	
	moveq	#1,d1
	moveq	#99,d2
	jsr	ReqMinMaxLong
	jsr	InitVolumeList
	RET



SetNoiseFilter
	BGN
	lea.l	NoiseFilt,a0
	lea.l	NoiseFilt_TXT,a1	
	moveq	#0,d1
	moveq	#MAXANTIALIAS,d2
	jsr	ReqMinMaxLong
	RET
NoiseFilt	dc.l	0

SetStPitchDiff
	BGN
	lea.l	PITCHDIFF,a0
	lea.l	PitchDiff_TXT,a1	
	moveq	#0,d1
	move.l	#1000,d2
	jsr	ReqMinMaxLong
	RET



	acode
	;V2.0
ExtractSetQuality
	IFEQ AMINETDEMO
	BGN
	IFEQ	DEMO
	lea.l	SAVE8BIT_QUALITY-2,a0
	lea.l	SetEx8bQuality_TXT,a1	
	moveq	#8,d2
	moveq	#4,d1
	jsr	ReqMinMaxLong
	ENDC
ExtractSetQuality_X
	RET
	ENDC
	rts

	acode
SetStSampleDiff	;V2.0
	BGN
	lea.l	SAMPLEDIFF,a0
	lea.l	SampleDiff_TXT,a1	
	moveq	#0,d1
	move.l	#2000,d2
	jsr	ReqMinMaxLong

	move.l	#"SY85",d0
	move.w	SAMPLEDIFF+2,d2
	jsr	NGODrawDecWord4Char
	RET

	acode
SetInstrNr	;V2.0
	BGN
	lea.l	templong,a0
	lea.l	GotoInstr_TXT,a1
	moveq	#0,d1
	move.l	#255,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit

	move.l	templong,d0
	jsr	GotoInstrNum
.exit	RET



	acode
SampleDiffD
	BGN
	jsr	SetDecShiftKeyRaster
	sub.w	d0,SAMPLEDIFF+2
	bpl.s	.OK
	clr.l	SAMPLEDIFF
.OK
	move.l	#"SY85",d0
	move.w	SAMPLEDIFF+2,d2
	jsr	NGODrawDecWord4Char
	RET

	acode
SampleDiffU
	BGN
	jsr	SetDecShiftKeyRaster
	add.w	d0,SAMPLEDIFF+2
	cmpi.w	#2000,SAMPLEDIFF+2
	bls.s	.ok
	move.w	#2000,SAMPLEDIFF+2
.ok
	move.l	#"SY85",d0
	move.w	SAMPLEDIFF+2,d2
	jsr	NGODrawDecWord4Char
	RET

	acode
PitchDiffD
	BGN
	jsr	SetDecShiftKeyRaster
	sub.w	d0,PITCHDIFF+2
	bpl.s	.OK
	clr.l	PITCHDIFF
.OK
	move.l	#"SY81",d0
	move.w	PITCHDIFF+2,d2
	jsr	NGODrawDecWord3Char
	RET

	acode
PitchDiffU
	BGN
	jsr	SetDecShiftKeyRaster
	add.w	d0,PITCHDIFF+2
	move.l	#"SY81",d0
	move.w	PITCHDIFF+2,d2
	jsr	NGODrawDecWord3Char
	RET

	acode
SetSampleVol	;V2.0
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq.s	.exit
	move.l	a0,a2

	moveq	#0,d0
	move.b	SAMPLENAME_VOLUME(a2),d0
	lea.l	EditBuf,a0
	move.l	d0,(a0)
	lea.l	SetSampleVol_TXT,a1	

	moveq	#0,d1
	move.l	#199,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit

	move.l	(a0),d0
	move.b	d0,SAMPLENAME_VOLUME(a2)
	bsr	ReMakeSample
	jsr	DrawInstrName
.exit	RET

	acode
ReMakeSample
	BGN
	jsr	GetActualInstrName
	cmpi.b	#MULTISAMPLE_LINESRC,SAMPLENAME_MULTI(a0)
	bne.s	ReMakeSample_Disk
		jsr	ReBuildLineSample
ReMakeSample_X	RET
ReMakeSample_Disk	jsr	ReloadActualSample
	bra.s	ReMakeSample_X


	acode
SetDownSample	;V2.0
	BGN
	jsr	GetActualInstrName
	jsr	SetPosNegShiftRaster
	add.b	d0,SAMPLENAME_DOWNSAMPLE(a0)
	tst.b	SAMPLENAME_DOWNSAMPLE(a0)
	bpl.s	SetDownSample_X
		jsr	WarnFlash
		clr.b	SAMPLENAME_DOWNSAMPLE(a0)
SetDownSample_X	bsr	ReMakeSample
	jsr	DrawInstrName
	RET

	acode
AutoReCalcLineSamples
	jsr	SaveInstrumentNum
	jsr	AutoCalcLineSamples
	jsr	LoadInstrumentNum
	jsr	DrawInstrument
	jsr	DrawInstrParam
	rts

	acode
AutoCalcLineSamples	;V1.0
	BGN
	jsr	MoveFirstInstrument

	move.l	#MaxNumb_Samples-1,d7

AutoCalcLineSamples_L
		jsr	GetActualInstrName
		cmpi.b	#MULTISAMPLE_LINESRC,SAMPLENAME_MULTI(a0)
		bne	AutoCalcLineSamples_NEXT

			bsr	BackupIName
				bsr	ReBuildLineSample
			bsr	RecallIName
;			jsr	DrawInstrName	

AutoCalcLineSamples_NEXT
		jsr	HandleAllMsgs
		jsr	MoveNextInstrument
	dbf	d7,AutoCalcLineSamples_L

	jsr	MoveFirstInstrument
	jsr	DrawInstrument

	RET

RecallIName
	BGN
	moveq	#(SampleNameMaxLen/4)-1,d0
	lea.l	INameBak,a1
	exg	a0,a1
	bra.s	BackupIName_L
BackupIName
	BGN
	moveq	#(SampleNameMaxLen/4)-1,d0
	lea.l	INameBak,a1
BackupIName_L	move.l	(a0)+,(a1)+
	dbf	d0,BackupIName_L
	RET



TRANSWAVE_STEPS	EQU	80

TRANSWAVE_NUM1	EQU	0
TRANSWAVE_NUM2	EQU	2
TRANSWAVE_PTR1	EQU	4
TRANSWAVE_END1	EQU	8
TRANSWAVE_PTR2	EQU	12
TRANSWAVE_END2	EQU	16

TRANSWAVE_NUM	EQU	0
TRANSWAVE_VOL	EQU	2
TRANSWAVE_BGN	EQU	4
TRANSWAVE_END	EQU	8

TRANSWAVE_SIZEOF	EQU	16

GetInstrumentNameNum
	move.l	SampleNames_PTR,a0
	mulu	#SampleNameMaxLen,d0
	lea.l	(a0,d0.l),a0
	rts

BuildNewTransWave
	BGN
	bsr	ReqInstrument
	tst.w	d0
	beq.w	.exit
	move.l	d1,.data
	bsr	ReqInstrument
	tst.w	d0
	beq.w	.exit
	move.l	d1,.data+4


	lea.l	BuildTransSample_TEMP,a5

	move.l	.data,d0
	jsr	GetInstrument
	move.l	a0,a1
	jsr	GetInstrumentNameNum
	move.l	a0,a4
	jsr	GetNewLoop
	move.l	d0,(a5)+
	move.l	d1,(a5)+
	jsr	GetRecalcedLoop
	move.l	INSTR_SAMPLEPTR(a1),d2
	add.l	d2,d0
	add.l	d2,d1
	move.l	d0,TransWave_Info+4
	move.l	d1,TransWave_Info+8
	move.l	.data,d0
	move.w	d0,TransWave_Info
	move.w	d0,(a5)+


	move.l	.data+4,d0
	jsr	GetInstrument
	move.l	a0,a1
	jsr	GetInstrumentNameNum
	move.l	a0,a4
	jsr	GetNewLoop
	move.l	d0,(a5)+
	move.l	d1,(a5)+
	jsr	GetRecalcedLoop
	move.l	INSTR_SAMPLEPTR(a1),d2
	add.l	d2,d0
	add.l	d2,d1
	move.l	d0,TransWave_Info+TRANSWAVE_PTR2
	move.l	d1,TransWave_Info+TRANSWAVE_END2
	move.l	.data+4,d0
	move.w	d0,TransWave_Info+TRANSWAVE_NUM2
	move.w	d0,(a5)+

	jsr	GetActualInstrName
	lea.l	LINEHEAD_SIZEOF(a0),a4
	lea.l	BuildTransSample_TEMP,a5
	move.l	(a5)+,TRANSWAVE_BGN(a4)
	move.l	(a5)+,TRANSWAVE_END(a4)
	move.w	(a5)+,TRANSWAVE_NUM(a4)

	lea.l	TRANSWAVE_SIZEOF(a4),a4
	move.l	(a5)+,TRANSWAVE_BGN(a4)
	move.l	(a5)+,TRANSWAVE_END(a4)
	move.w	(a5)+,TRANSWAVE_NUM(a4)
	bra	BuildTransSample_IN
.exit	RET
.data	dc.l	0,0

ReqInstrument
	puts	d2-a1
	move.l	#127,d2
	moveq	#0,d1
	lea.l	InstNum,a0
	lea.l	ReqInstrTXT,a1
	jsr	ReqMinMaxLong
	move.l	InstNum,d1
	gets	d2-a1
	rts


	acode
RebuildTransSample
	jsr	GetActualInstrName
	lea.l	LINEHEAD_SIZEOF(a0),a5

	moveq	#0,d0
	move.w	TRANSWAVE_NUM(a5),d0
	move.w	d0,TransWave_Info+TRANSWAVE_NUM1
	jsr	GetInstrument

	move.l	TRANSWAVE_BGN(a5),d0
	move.l	TRANSWAVE_END(a5),d1
	
	move.l	a0,a1
	jsr	GetRecalcedLoop
	move.l	INSTR_SAMPLEPTR(a1),d2
	add.l	d2,d0
	add.l	d2,d1
	move.l	d0,TransWave_Info+4
	move.l	d1,TransWave_Info+8

	lea.l	TRANSWAVE_SIZEOF(a5),a5


	move.w	TRANSWAVE_NUM(a5),d0
	move.w	d0,TransWave_Info+TRANSWAVE_NUM2
	jsr	GetInstrument

	move.l	TRANSWAVE_BGN(a5),d0
	move.l	TRANSWAVE_END(a5),d1
	
	move.l	a0,a1
	jsr	GetRecalcedLoop
	move.l	INSTR_SAMPLEPTR(a1),d2
	add.l	d2,d0
	add.l	d2,d1
	move.l	d0,TransWave_Info+TRANSWAVE_PTR2
	move.l	d1,TransWave_Info+TRANSWAVE_END2

	bra	BuildTransSample_IN

	acode
BuildTransSample
	BGN
	lea.l	BuildTransSample_TEMP,a5

	jsr	GetActualInstrName
	move.l	a0,a4
	jsr	GetNewLoop
	move.l	d0,(a5)+
	move.l	d1,(a5)+
	jsr	GetActualInstrument
	move.l	a0,a1
	jsr	GetRecalcedLoop
	move.l	INSTR_SAMPLEPTR(a1),d2
	add.l	d2,d0
	add.l	d2,d1

	move.l	d0,TransWave_Info+4
	move.l	d1,TransWave_Info+8
	jsr	GetActualInstrNum
	move.w	d0,TransWave_Info
	move.w	d0,(a5)+

	jsr	MoveNextMonoInstrument	

	jsr	GetActualInstrName
	move.l	a0,a4
	jsr	GetNewLoop
	move.l	d0,(a5)+
	move.l	d1,(a5)+
	jsr	GetActualInstrument
	move.l	a0,a1
	jsr	GetRecalcedLoop
	move.l	INSTR_SAMPLEPTR(a1),d2
	add.l	d2,d0
	add.l	d2,d1

	move.l	d0,TransWave_Info+TRANSWAVE_PTR2
	move.l	d1,TransWave_Info+TRANSWAVE_END2
	jsr	GetActualInstrNum
	move.w	d0,TransWave_Info+TRANSWAVE_NUM2
	move.w	d0,(a5)+

	jsr	MoveNextMonoInstrument

	jsr	GetActualInstrName
	lea.l	LINEHEAD_SIZEOF(a0),a4
	lea.l	BuildTransSample_TEMP,a5
	move.l	(a5)+,TRANSWAVE_BGN(a4)
	move.l	(a5)+,TRANSWAVE_END(a4)
	move.w	(a5)+,TRANSWAVE_NUM(a4)
	lea.l	TRANSWAVE_SIZEOF(a4),a4
	move.l	(a5)+,TRANSWAVE_BGN(a4)
	move.l	(a5)+,TRANSWAVE_END(a4)
	move.w	(a5)+,TRANSWAVE_NUM(a4)

BuildTransSample_IN
	jsr	SaveActInstrName
	jsr	KillActualInstr		;no name clear !
	jsr	LoadActInstrName
	moveq	#0,d0
	jsr	GetActualSampleManagerEntry
	jsr	InitSampleManEntry
	move.l	a0,a1
	
	move.l	TransWave_Info+8,d0
	sub.l	TransWave_Info+4,d0
	beq.w	.exit
	mulu	#TRANSWAVE_STEPS,d0

	IFEQ SYMPHPRO
	move.l	d0,SAMPLEMANE_SIZE(a1)		;8bit
	move.l	#SAMPLEMAN_MEMTYPE,SAMPLEMANE_MEMTYPE(a1)
	lsr.l	#1,d0
	ELSE

	lsl.l	#1,d0				;16bit
	move.l	d0,SAMPLEMANE_SIZE(a1)
	move.l	#SAMPLEMAN_MEMTYPE,SAMPLEMANE_MEMTYPE(a1)
	lsr.l	#2,d0
	ENDC

	move.l	d0,SAMPLEMANE_SAMPLENUMB(a1)
	lea.l	SAMPLEMANE_PTR(a1),a0
	jsr	GetMem
	tst.l	d0
	beq.w	.exit

	move.w	#TRUE,SAMPLEMANE_USED(a1)


	move.l	SAMPLEMANE_PTR(a1),d0
	add.l	SAMPLEMANE_SIZE(a1),d0			;PTR to lAST!! sample
	subq.l	#SAMPLELENGTHB,d0
	move.l	d0,SAMPLEMANE_ENDPTR(a1)		;SET ENDPTR
	addq.l	#SAMPLELENGTHB,d0


	move.l	TransWave_Info+4,a0
	move.l	SAMPLEMANE_PTR(a1),a2

	moveq	#TRANSWAVE_STEPS-1,d7
	
	moveq	#0,d5
	move.b	#FALSE,StatusTransReso1

.loop2	move.l	TransWave_Info+8,d0
	sub.l	TransWave_Info+4,d0
	move.l	d0,d2					;max 1
	lsr.l	#1,d0

	moveq	#0,d3					;Act

	move.l	TransWave_Info+TRANSWAVE_END2,d4	;max 2
	sub.l	TransWave_Info+TRANSWAVE_PTR2,d4
	move.l	TransWave_Info+TRANSWAVE_PTR2,a3	;source 2 ptr

	subq.w	#1,d0					;d0: steps
	bmi.w	.exit

	move.l	TransWave_Info+4,a0			;a0: source 1 ptr

	addq.w	#1,d5
	IFNE	TESTPRGB
	bsr	TransResoSource1
	ENDC

.loop		move.w	(a0)+,d1

		muls	d7,d1
		divs	#TRANSWAVE_STEPS,d1

		move.l	d3,d6
		mulu	d4,d6
		divu	d2,d6
		move.w	(a3,d6.w*2),d6

		muls	d5,d6
		divs	#TRANSWAVE_STEPS,d6		


		add.w	d1,d6
		move.w	d6,(a2)+


		addq.w	#1,d3

		dbf	d0,.loop	


	dbf	d7,.loop2


	;jsr	AntiknackVirt
	;move.b	#1,AKTYPE
	;jsr	NewPrepareSample
	;clr.b	AKTYPE

	jsr	GetActualInstrName
	move.b	#MULTISAMPLE_LINESRC,SAMPLENAME_MULTI(a0)
	move.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a0)
	move.l	#LINENAMEID,LINENAME_ID(a0)
	clr.b	LINENAME_ZERO(a0)
	move.w	#1,LINENAME_VERSION(a0)			;1= TRANSWAVE
	clr.w	LINENAME_EOS(a0)
	clr.w	LINENAME_MIXINFO(a0)
	move.w	#2,LINENAME_SRCNUMB(a0)
	move.w	#10,LINENAME_SRCDEFLEN(a0)		;NEW: Transwave cycl num
	move.w	#LINEHEAD_SIZEOF,LINENAME_HEADLEN(a0)

	move.l	a0,a2
	jsr	GetActualInstrument
	move.l	a0,a1
	jsr	GetActualSampleManagerEntry
	move.l	a0,a4
	jsr	NewPrepareSampleIn
	moveq	#0,d0
	moveq	#0,d1
	jsr	MakeSimpleIofSample
	jsr	ForceUpdateActInstrType
	jsr	DrawInstrument
.exit	RET


	acode
TransResoSource1
	puts	d0-d7/a0-a2
	tst.l	ResoSource1Ptr
	beq	.exit

	cmpi.b	#TRUE,StatusTransReso1
	beq.s	.cont
	move.b	#TRUE,StatusTransReso1

	
	puts	d0
	move.l	ResoSource1Ptr,a1

.copyl	move.w	(a3)+,d1
	move.w	d1,(a1)+
	dbf	d0,.copyl
	gets	d0

	move.w	TransWResoDepth,TransWResoDepth+2
.cont	
	move.l	ResoSource1Ptr,a0
	move.l	a0,a1	;bgn 1
	move.l	a0,a2	;bgn 2
	bclr	#0,d0
	add.l	d0,a2

	moveq	#0,d2
	move.w	TransWResoDepth+2,d2
	beq.s	.exit

	addq.w	#1,TransWResoDepth+2
	lsl.l	#5,d2
	add.l	#1,d2

	lsr.w	#1,d0

.loop	move.w	(a0),d1
	lea.l	4(a0),a0

	divs.w	d2,d1
	ext.l	d1

	move.w	(a1),d3
	ext.l	d3
	sub.l	d1,d3

	;asl.l	#4,d3	;*16
	;divs	#18,d3

	cmpi.l	#16300,d3
	ble.s	.ok1
	move.w	#16300,d3
.ok1	cmpi.l	#-16367,d3
	bge.s	.ok2
	move.w	#-16367,d3
.ok2
	move.w	d3,(a1)+

	
	move.w	(a2),d3
	ext.l	d3
	sub.l	d1,d3
	;asl.l	#4,d3	;*16
	;divs	#17,d3


	cmpi.l	#16300,d3
	ble.s	.ok1b
	move.w	#16300,d3
.ok1b	cmpi.l	#-16367,d3
	bge.s	.ok2b
	move.w	#-16367,d3

.ok2b
	move.w	d3,(a2)+
	dbf	d0,.loop

.skip
	move.l	ResoSource1Ptr,a3
.exit	gets	d0-d7/a0-a2
	rts

ResoOffset		dc.w	0
ResoSource1Ptr		dc.l	0,20000,FASTMEM
TransWResoDepth		dc.w	1,0

TransWave_Info		dc.w	0,0	;id1, id2
			dc.l	0,0,0,0	;start1, start2
StatusTransReso1	dc.b	FALSE	;(is first time)



	acode
ReBuildLineSample	;V1.0
	BGN
	jsr	GetActualInstrName
	cmpi.w	#1,LINENAME_VERSION(a0)
	beq.w	RebuildTransSample

	move.w	LINENAME_SRCNUMB(a0),d7
	move.w	d7,BuildLineSample_SRCNUMB

	move.w	LINENAME_HEADLEN(a0),d6
	move.w	LINENAME_SRCDEFLEN(a0),d5

	lea.l	(a0,d6.w),a0
	subq.w	#1,d7
	move.l	BuildLineINFO_PTR(PC),a1
ReBuildLineSampleName_L
		move.b	NOTE_PITCH(a0),NOTE_PITCH(a1)
		move.b	NOTE_INSTR(a0),NOTE_INSTR(a1)
		move.b	NOTE_VOLUME(a0),NOTE_VOLUME(a1)
		lea.l	(a0,d5.w),a0
		lea.l	BUILDINFO_ESIZEOF(a1),a1
	dbf	d7,ReBuildLineSampleName_L
	bra	BuildLineSample_EXT

	acode
CloneToLineSample	;V2.0
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq.s	CloneToLineSample_X

	move.l	BuildLineINFO_PTR(PC),a2

		move.b	#24,NOTE_PITCH(a2)
		jsr	GetActualInstrNum
		move.b	d0,NOTE_INSTR(a2)
		move.b	#100,NOTE_VOLUME(a2)

	moveq	#1,d6
	move.w	d6,BuildLineSample_SRCNUMB
	jsr	MoveNextInstrument
	jsr	KillActualInstr
	jsr	ResetLineSampleParams
	bra	BuildLineSample_EXT
CloneToLineSample_X	RET

	acode
ResetLineSampleParams
	BGN
	jsr	GetActualInstrName
	bclr	#LSFLAGS_RVS,SAMPLENAME_LSFLAGS(a0)
	bclr	#LSFLAGS_MIRROR,SAMPLENAME_LSFLAGS(a0)
	bclr	#LSFLAGS_16BIT,SAMPLENAME_LSFLAGS(a0)
	bclr	#LSFLAGS_ASQUEUE,SAMPLENAME_LSFLAGS(a0)

	clr.b	SAMPLENAME_RESO(a0)
	clr.b	SAMPLENAME_FILTER(a0)
	clr.b	SAMPLENAME_DOWNSAMPLE(a0)
	clr.b	SAMPLENAME_RESOFILTERFLAGS(a0)
	clr.b	SAMPLENAME_RESOFILTERNUMB(a0)
	clr.b	SAMPLENAME_VFADESTATUS(a0)
	RET

	acode
BuildRowSample	;V1.0
	BGN

	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1

	move.l	BuildLineINFO_PTR(PC),a2
	moveq	#0,d6

	move.w	PATTED_LINESIZE(a0),d5
	move.w	PATTED_NUMBVOICES(a0),d7
	subq.w	#1,d7
	bmi.w	BuildLineSample_X

BuildRSCountSamples_L

		cmpi.b	#NOTEPITCH_NONOTE,NOTE_PITCH(a1)
		beq.s	BuildRSCountSamples_M

			move.b	NOTE_PITCH(a1),NOTE_PITCH(a2)
			move.b	NOTE_INSTR(a1),NOTE_INSTR(a2)
			move.b	NOTE_VOLUME(a1),NOTE_VOLUME(a2)
			lea.l	BUILDINFO_ESIZEOF(a2),a2
			addq.w	#1,d6

BuildRSCountSamples_M
	lea.l	(a1,d5.w),a1
	dbf	d7,BuildRSCountSamples_L

	move.w	d6,BuildLineSample_SRCNUMB

	jsr	KillActualInstr
	clr.b	LineSampleFlag
	jsr	GetActualInstrName
	bsr	ResetLineSampleParams
	bset	#LSFLAGS_ASQUEUE,SAMPLENAME_LSFLAGS(a0)
	move.b	SAMPLENAME_LSFLAGS(a0),LineSampleFlag
	bra.s	BuildLineSample_EXT

	acode
BuildLineSample	;V2.0
	BGN

	lea.l	Test_PATTED,a0
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1

	move.l	BuildLineINFO_PTR(PC),a2

	move.w	CHANNEL_NUMB,d7
	subq.w	#1,d7
	bmi.w	BuildLineSample_X

	moveq	#0,d6

BuildLSCountSamples_L
		cmpi.b	#NOTEPITCH_NONOTE,NOTE_PITCH(a1)
		beq.s	BuildLSCountSamples_M
		move.b	NOTE_PITCH(a1),NOTE_PITCH(a2)
		move.b	NOTE_INSTR(a1),NOTE_INSTR(a2)
		move.b	NOTE_VOLUME(a1),NOTE_VOLUME(a2)
		lea.l	BUILDINFO_ESIZEOF(a2),a2
		addq.l	#1,d6
BuildLSCountSamples_M
	lea.l	NOTE_SIZEOF(a1),a1
	dbf	d7,BuildLSCountSamples_L

	move.w	d6,BuildLineSample_SRCNUMB

	bsr	ResetLineSampleParams

BuildLineSample_EXT
	jsr	SaveActInstrName
	bsr	SaveLineSampleFlag
	jsr	KillActualInstr

	move.w	BuildLineSample_SRCNUMB,d6
	tst.w	d6
	beq.w	BuildLineSample_X


	jsr	GetActualSampleManagerEntry
	move.l	a0,a1
	move.l	a0,a4

	move.l	BuildLineINFO_PTR(PC),a2
	moveq	#0,d0
	move.b	NOTE_INSTR(a2),d0
	jsr	GetSampleManagerEntry
	move.l	a0,a3

	move.w	Sample_STANDARD,SAMPLEMANE_OVERSAMPLING(a1)
	move.w	Sample_STANDARD+2,SAMPLEMANE_LN(a1)
	move.w	Sample_STANDARD+4,SAMPLEMANE_PITCH(a1)
	move.w	Sample_STANDARD+6,SAMPLEMANE_FINETUNE(a1)

	bsr	GetLineSampleLen
	clr.l	SAMPLEMANE_PTR(a1)

	move.l	d0,SAMPLEMANE_SIZE(a1)
	beq.w	BuildLineSample_X
	move.l	#SAMPLEMAN_MEMTYPE,SAMPLEMANE_MEMTYPE(a1)
	move.l	d1,SAMPLEMANE_SAMPLENUMB(a1)
	lea.l	SAMPLEMANE_PTR(a1),a0
	jsr	GetMem
	tst.l	d0
	beq.w	ERR_NoLineSMem

	move.l	SAMPLEMANE_PTR(a1),d0
	add.l	SAMPLEMANE_SIZE(a1),d0			;PTR to lAST!! sample

	subq.l	#SAMPLELENGTHB,d0
	move.l	d0,SAMPLEMANE_ENDPTR(a1)		;SET ENDPTR
	addq.l	#SAMPLELENGTHB,d0

	subq.l	#2,d0
	move.l	d0,LineSampleEnd_PTR			;16BIT;16BIT

	tst.l	SAMPLEMANE_PTR(a4)
	beq.w	BuildLineSample_X
	move.w	#TRUE,SAMPLEMANE_USED(a4)


	bsr	BuildLineSetVolDiv
	move.w	BuildLineSample_SRCNUMB,d6
	subq.w	#1,d6
	move.l	BuildLineINFO_PTR(PC),a2

	bsr	GetLSPitchBase

	move.l	SAMPLEMANE_PTR(a4),a1
	moveq	#0,d2

BuildLineS_Copy2

	bsr	GetLSPitch


	moveq	#0,d0
	move.b	NOTE_INSTR(a2),d0
	jsr	GetSampleManagerEntry
	move.l	SAMPLEMANE_SIZE(a0),d1
	move.l	SAMPLEMANE_PTR(a0),a0
	move.l	SAMPLEMANE_SIZE(a4),d7

	bsr	BuildLineSMoveDestPtr

	move.l	a0,a5
	add.l	d1,a5

	move.l	SAMPLEMANE_SIZE(a4),d7
	lsr.l	#1,d7					;CORR

	lsl.l	#1,d3
	subq.l	#1,d7
	bmi.w	BuildLineSample_X

	IFEQ	SYMPHPRO
	lea.l	1(a0),a0				;May cause error ???
	ENDC
	exg	d3,d0
	jsr	CorrectPREPExpand
	exg	d3,d0

	IFEQ	SYMPHPRO
	subq.l	#1,d7
	bmi.s	BuildLineS_ExitL1

	subq.l	#1,a5
	bmi.s	BuildLineS_ExitL1			;NEW VIRTUAL MIX
BuildLineS_Copy1
		cmp.l	a0,a5				;Memory 
		blo.s	BuildLineS_ExitL1

		cmp.l	LineSampleEnd_PTR,a1
		bhi.s	BuildLineS_ExitL1		;Post last sample ERR !!! FIXED

		move.b	(a0),d0				;Pre Oversampling Correction
		extb.l	d0
		add.w	d0,(a1)+

		add.l	d3,d2
		swap	d2
		lea.l	(a0,d2.w),a0
		clr.w	d2
		swap	d2

 		subq.l	#1,d7
	bpl.s	BuildLineS_Copy1

	ELSE

	subq.l	#1,d7
	bmi.s	BuildLineS_ExitL1

	subq.l	#2,a5
	bmi.s	BuildLineS_ExitL1			;NEW VIRTUAL MIX

BuildLineS_Copy1					;16BIT VERSION
		cmp.l	a0,a5
		blo.s	BuildLineS_ExitL1

		cmp.l	LineSampleEnd_PTR,a1
		bhi.s	BuildLineS_ExitL1

		move.w	(a0),d0
		ext.l	d0
		divs	BuildLineSample_SRCNUMB,d0

		add.w	d0,(a1)+

		add.l	d3,d2
		swap	d2
		lea.l	(a0,d2.w*2),a0
		clr.w	d2
		swap	d2

 		subq.l	#1,d7
	bpl.s	BuildLineS_Copy1
	ENDC

BuildLineS_ExitL1
	lea.l	BUILDINFO_ESIZEOF(a2),a2
	dbf	d6,BuildLineS_Copy2

	jsr	LoadActInstrName

	
	jsr	AntiknackVirt
	move.b	#1,AKTYPE
	jsr	NewPrepareSampleIn
	clr.b	AKTYPE

	jsr	GetActualInstrName
	move.l	a0,SAMPLEMANE_FILENAMEPTR(a4)
	move.b	#MULTISAMPLE_LINESRC,SAMPLENAME_MULTI(a0)
;	move.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a0)
;	clr.b	SAMPLENAME_LOOPSTART(a0)
;	clr.b	SAMPLENAME_LOOPLEN(a0)

	move.l	#LINENAMEID,LINENAME_ID(a0)
	clr.b	LINENAME_ZERO(a0)
	clr.w	LINENAME_VERSION(a0)
	clr.w	LINENAME_EOS(a0)

	move.w	BuildLineSample_SRCNUMB,d7
	move.w	d7,LINENAME_SRCNUMB(a0)
	move.w	#LINEHEAD_SIZEOF,LINENAME_HEADLEN(a0)
	move.w	#LINESRCDEF_SIZEOF,LINENAME_SRCDEFLEN(a0)

	lea.l	LINEHEAD_SIZEOF(a0),a1
	subq.w	#1,d7
	move.l	BuildLineINFO_PTR(PC),a0

BuildLineSampleName_L
		move.b	NOTE_PITCH(a0),NOTE_PITCH(a1)
		move.b	NOTE_INSTR(a0),NOTE_INSTR(a1)
		move.b	NOTE_VOLUME(a0),NOTE_VOLUME(a1)
		lea.l	BUILDINFO_ESIZEOF(a0),a0
		lea.l	LINESRCDEF_SIZEOF(a1),a1
	dbf	d7,BuildLineSampleName_L
	jsr	GetActualInstrName
	move.l	a0,a2
	jsr	GetActualInstrument
	move.l	a0,a1
	jsr	GetActualSampleManagerEntry
	moveq	#0,d0
	moveq	#0,d1
	jsr	MakeSimpleIofSample
	jsr	LoadLineSampleFlag
	jsr	ForceUpdateActInstrType
	jsr	DrawInstrument
BuildLineSample_X
	clr.b	LineSampleFlag
	RET
ERR_NoLineSMem
	jsr	PrintActInstrInfo
	ASSTXT ERRNoLSMem
	bra.s	BuildLineSample_X

	acode
GetLSPitchBase	;V1.0
		;I(A2L)(NOTE_PTR)
		;O(D3L,D4W)(SAMPLE_PITCHBASE=$10000,NOTEPITCH_BASE)
	puts	d0
	moveq	#0,d4
	move.b	NOTE_PITCH(a2),d4
	bsr	BuildLineGetPitchTune
	add.b	d0,d4
	moveq	#1,d3
	swap	d3
	gets	d0
	rts

GetLSPitch	;V1.0
		;I(D4W,A2L)(NOTEPITCH_BASE,NOTE_PTR)
		;O(D3L)(SAMPLE_PITCHADD)
	puts	d0-d2/a0
	moveq	#0,d1
	move.b	NOTE_PITCH(a2),d1
	bsr	BuildLineGetPitchTune
	add.b	d0,d1

	sub.w	d4,d1
	asl.w	#2,d1
	lea.l	BuildLineSample_FREQBASE,a0
	move.l	(a0,d1.w),d3

	cmpi.b	#VOLUME_COMMAND,NOTE_VOLUME(a2)
	blo.s	BuildLineS_NoCommand

	cmpi.b	#VOLUME_PITCHDOWN3,NOTE_VOLUME(a2)
	blo.s	BuildLineS_NoComPitch

	cmpi.b	#VOLUME_PITCHUP,NOTE_VOLUME(a2)
	bhi.s	BuildLineS_NoComPitch

	move.l	d3,d0
	cmpi.b	#VOLUME_PITCHUP,NOTE_VOLUME(a2)
	beq.s	.BuildLineS_PU1
	cmpi.b	#VOLUME_PITCHUP2,NOTE_VOLUME(a2)
	beq.s	.BuildLineS_PU2
	cmpi.b	#VOLUME_PITCHUP3,NOTE_VOLUME(a2)
	beq.s	.BuildLineS_PU3

	neg.l	d0
	cmpi.b	#VOLUME_PITCHDOWN,NOTE_VOLUME(a2)
	beq.s	.BuildLineS_PD1
	cmpi.b	#VOLUME_PITCHDOWN2,NOTE_VOLUME(a2)
	beq.s	.BuildLineS_PD2
	cmpi.b	#VOLUME_PITCHDOWN3,NOTE_VOLUME(a2)
	beq.s	.BuildLineS_PD3
	bra.s	BuildLineS_NoComPitch

.BuildLineS_PD1	asr.l	#PITCHFXSHIFT,d0
	bra.s	.BuildLineS_PX
.BuildLineS_PD2	asr.l	#PITCHFXSHIFT-1,d0
	bra.s	.BuildLineS_PX
.BuildLineS_PD3	asr.l	#PITCHFXSHIFT-2,d0
	bra.s	.BuildLineS_PX

.BuildLineS_PU1	lsr.l	#PITCHFXSHIFT,d0
	bra.s	.BuildLineS_PX
.BuildLineS_PU2	lsr.l	#PITCHFXSHIFT-1,d0
	bra.s	.BuildLineS_PX
.BuildLineS_PU3	lsr.l	#PITCHFXSHIFT-2,d0
	bra	.BuildLineS_PX
.BuildLineS_PX
	add.l	d0,d3

BuildLineS_NoComPitch
BuildLineS_NoCommand
	gets	d0-d2/a0
	rts


TuneLSLength
	puts	d0
	
	mulu.l	#$10000,d0:d5
	divu.l	d3,d0:d5

	mulu.l	#$10000,d0:d6
	divu.l	d3,d0:d6

	gets	d0
	rts

BuildLineSMoveDestPtr
	btst	#LSFLAGS_ASQUEUE,LineSampleFlag
	bne.s	BuildLineSMoveDestPtr_X
		move.l	SAMPLEMANE_PTR(a4),a1
BuildLineSMoveDestPtr_X	rts

BuildLineSetVolDiv
	moveq	#1,d5
	btst	#LSFLAGS_ASQUEUE,LineSampleFlag
	bne.s	BuildLineSMoveDestPtr_X
		moveq	#0,d5
		move.w	BuildLineSample_SRCNUMB,d5
	rts

SaveLineSampleFlag
	BGN
	jsr	GetActualInstrName
	btst	#LSFLAGS_ASQUEUE,LineSampleFlag

	bne.s	SaveLineSampleFlag_X

	lea.l	LineSampleFlag(PC),a2

	move.b	SAMPLENAME_LSFLAGS(a0),(a2)+
	move.b	SAMPLENAME_FILTER(a0),(a2)+
	move.b	SAMPLENAME_INSTRTYPE(a0),(a2)+
	move.b	SAMPLENAME_LOOPSTART(a0),(a2)+
	move.b	SAMPLENAME_LOOPLEN(a0),(a2)+
	move.b	SAMPLENAME_LOOPNUMB(a0),(a2)+
	move.b	SAMPLENAME_FINETUNE(a0),(a2)+
	move.b	SAMPLENAME_TUNE(a0),(a2)+
	move.b	SAMPLENAME_PLAYFLAG(a0),(a2)+
	move.b	SAMPLENAME_DOWNSAMPLE(a0),(a2)+
	move.b	SAMPLENAME_VOLUME(a0),(a2)+
	move.b	SAMPLENAME_RESO(a0),(a2)+
	move.w	SAMPLENAME_LOOPSTARTLO(a0),(a2)+
	move.w	SAMPLENAME_LOOPLENLO(a0),(a2)+

	move.b	SAMPLENAME_RESOFILTERFLAGS(a0),(a2)+
	move.b	SAMPLENAME_RESOFILTERNUMB(a0),(a2)+
	move.l	SAMPLENAME_RESOFILTER(a0),(a2)+
	move.l	SAMPLENAME_RESOFILTER+4(a0),(a2)+
	move.l	SAMPLENAME_VFADESTATUS(a0),(a2)+

	
SaveLineSampleFlag_X	RET	
LineSampleFlag	blk.l	64,0

LoadLineSampleFlag
	BGN
	jsr	GetActualInstrName
	lea.l	LineSampleFlag(PC),a2
	move.b	(a2)+,SAMPLENAME_LSFLAGS(a0)
	move.b	(a2)+,SAMPLENAME_FILTER(a0)
	move.b	(a2)+,SAMPLENAME_INSTRTYPE(a0)
	move.b	(a2)+,SAMPLENAME_LOOPSTART(a0)
	move.b	(a2)+,SAMPLENAME_LOOPLEN(a0)
	move.b	(a2)+,SAMPLENAME_LOOPNUMB(a0)
	move.b	(a2)+,SAMPLENAME_FINETUNE(a0)
	move.b	(a2)+,SAMPLENAME_TUNE(a0)
	move.b	(a2)+,SAMPLENAME_PLAYFLAG(a0)
	move.b	(a2)+,SAMPLENAME_DOWNSAMPLE(a0)
	move.b	(a2)+,SAMPLENAME_VOLUME(a0)
	move.b	(a2)+,SAMPLENAME_RESO(a0)
	move.w	(a2)+,SAMPLENAME_LOOPSTARTLO(a0)
	move.w	(a2)+,SAMPLENAME_LOOPLENLO(a0)

	move.b	(a2)+,SAMPLENAME_RESOFILTERFLAGS(a0)
	move.b	(a2)+,SAMPLENAME_RESOFILTERNUMB(a0)
	move.l	(a2)+,SAMPLENAME_RESOFILTER(a0)
	move.l	(a2)+,SAMPLENAME_RESOFILTER+4(a0)
	move.l	(a2)+,SAMPLENAME_VFADESTATUS(a0)
	RET	

CorrectPREPExpand
	;I(D0L)(OLD->NEW)
	puts	d1
	move.l	SAMPLEPreOverS,d1
	subq.l	#1,d1
	beq.s	CorrectPREP_X
	lsl.l	d1,d0
CorrectPREP_X	gets	d1
	rts

CorrectPREPShorten
	;I(D0L)(OLD->NEW)
	puts	d1
	move.l	SAMPLEPreOverS,d1
	subq.l	#1,d1
	beq.s	CorrectPREP_X
	lsr.l	d1,d0
	gets	d1
	rts

GetLineSampleLen
	puts	d2-d7/a0-a6
	move.l	SAMPLEMANE_SIZE(a0),d0
	move.l	SAMPLEMANE_SAMPLENUMB(a0),d1

	jsr	CorrectPREPShorten
	exg	d0,d1
	jsr	CorrectPREPShorten
	exg	d0,d1

	btst	#LSFLAGS_ASQUEUE,LineSampleFlag
	bne.s	GetLineSampleLen_ISROW
GetLineSampleLen_X	grts	d2-d7/a0-a6

GetLineSampleLen_ISROW
	move.w	BuildLineSample_SRCNUMB,d7
	subq.w	#1,d7

	move.l	BuildLineINFO_PTR(PC),a2

	bsr	GetLSPitchBase

	moveq	#0,d1
	moveq	#0,d2
GetLineSampleLen_ISROWL
		moveq	#0,d0
		move.b	NOTE_INSTR(a2),d0
		jsr	GetSampleManagerEntry
		move.l	SAMPLEMANE_SIZE(a0),d5
		move.l	SAMPLEMANE_SAMPLENUMB(a0),d6

		bsr	GetLSPitch
		bsr	TuneLSLength

		add.l	d5,d2
		add.l	d6,d1
		lea.l	BUILDINFO_ESIZEOF(a2),a2
	dbf	d7,GetLineSampleLen_ISROWL
	move.l	d2,d0
	jsr	CorrectPREPShorten
	exg	d0,d1
	jsr	CorrectPREPShorten
	exg	d0,d1
	bra.s	GetLineSampleLen_X

BuildLineGetPitchTune
	BGNB
	moveq	#0,d0
	move.b	NOTE_INSTR(a2),d0
	jsr	GetInstrument
	move.w	INSTR_TUNE(a0),d0
	RETB

	acode
CopyMemory
	BGN
	move.l	EXECBASE,a6
	jsr	-624(a6)
	RET

;=== SPECTRUM =============================================

	acode
GetSpectrumRP	;V1.1
	puts	d0-d3/a0/a5
	move.l	#"WINA",d0
	move.l	#"A001",d1
	jsr	NGGetInnerAreaData
	move.l	a5,SpectrumNGWIN
	gets	d0-d3/a0/a5
	rts
SpectrumNGWIN	dc.l	0


	acode
RedrawSpecFull:
	puts	d0
	move.l	#"WINA",d0
	jsr	NGWDrawWindowID
	jsr	RedrawSpec
	gets	d0
	rts

	acode
RedrawSpec:
	;V1.0
	BGN
	jsr	GetSpectrumRP
	cmp.l	#0,a1
	beq.s	.exit
	jsr	InitSpecNoteAdd
	jsr	DrawSpecHarmGround
.exit	RET

	acode
DrawSpecHarmGround	;V1.0 NG
	BGN
	move.l	#"WINA",d0
	move.l	#"A001",d1
	jsr	NGGetInnerAreaData

	move.w	d2,d7
	divu	#36,d7
	move.w	d7,SpecUnitSIZE
	move.w	d3,d7
	divu	#36,d7
	cmp.w	SpecUnitSIZE,d7
	bhs.s	.ok
	move.w	d7,SpecUnitSIZE
.ok

	cmp.l	#0,a1
	beq.s	.exit
	movem.w	d0-d3,Harm_RECSYS

	jsr	NGRNrm0DrMd
	jsr	NGRDarkAPen

	moveq	#0,d2
	moveq	#7-1,d7
	jsr	Set1PMask
.loop		bsr	DrawSpecHarmGCircle
		addi.w	#NOTEPITCH_OCTAVE,d2
	dbf	d7,.loop
	jsr	SetOldPMask

	move.w	#SPEC_PITCHNONE,SpecLivePitch
	clr.w	SpecNoteNumb

	jsr	NGRInvDrMd
	jsr	NGRSpecialAPen

.exit	RET

	acode
DrawSpecHarmGCircle
	BGN
	move.l	d2,d3
	move.l	d2,d0
	bsr	GetHarmPixel

	bsr	GetSpectrumRP
	cmp.l	#0,a1
	beq.s	.exit

	jsr	GFX_Move
	moveq	#11-1,d7
	addq.w	#1,d2
.loop	move.l	d2,d0
		bsr	GetHarmPixel
		jsr	GFX_Draw
		addq.w	#1,d2
	dbf	d7,.loop
	move.l	d3,d0
	bsr	GetHarmPixel
	jsr	GFX_Draw
.exit	RET

SPEC_PITCHNONE	EQU	$8000

	acode
DrawSpecUnitTest	;V1.0
			;I(D0W)(PITCH)
	BGN
	bsr	GetSpectrumRP
	cmp.l	#0,a1
	beq.s	.exit
	move.w	SpecLivePitch(PC),d4
	cmpi.w	#SPEC_PITCHNONE,d4
	beq.s	.First

	exg	d0,d4
		bsr	GetHarmPixel
		bsr	DrawSpecUnit
	move.w	d4,d0

.First
	move.w	d0,SpecLivePitch
	bsr	GetHarmPixel
	bsr	DrawSpecUnit
.exit	RET
SpecLivePitch	dc.w	SPEC_PITCHNONE

PitchToNoteOctave	;V1.0
			;I(D0W)(PITCH)
			;O(D0W,D1W)(NOTE[0..11],OCTAVE[1..5])
	andi.l	#$ffff,d0
	divu	#NOTEPITCH_OCTAVE,d0
	move.w	d0,d1
	swap	d0
	rts

	acode
GetHarmPixel	;I(D0W)(PITCH)
		;O(D0W)(D1W)(X%,Y%) PERMILLE
	puts	d2-d3/a0
	bsr	PitchToNoteOctave
	lea.l	HarmSpec_Base(PC),a0
	move.w	d1,d3
	movem.w	(a0,d0.w*4),d0-d1
	move.w	#75,d2
	lsl.w	#3,d3
	sub.w	d3,d2

	muls.w	d2,d0
	muls.w	d2,d1

	moveq	#4,d2
;	add.w	d3,d2
	asr.l	d2,d0
	add.w	#500,d0
	asr.l	d2,d1
	add.w	#500,d1

	lea.l	Harm_RECSYS(PC),a0
	jsr	HiScalePixel
	gets	d2-d3/a0
	rts

Harm_RECSYS	dc.w	0,0,0,0
HarmSpec_Base		dc.w	0,-100,50,-86,86,-50,100,0,86,50,50,86	;0..150
			dc.w	0,100,-50,86,-86,50,-100,0,-86,-50,-50,-86

	acode
InitSpecNoteAdd
	BGN
	move.l	SpecBuffer_PTR(PC),a2
	lea.l	512(a2),a2
	move.l	a2,SpecNoteAdd_PTR
	move.l	a2,SpecNoteAdd_PTR+4
	lea.l	SPECNOTEBUF_SIZE(a2),a2
	move.l	a2,SpecNoteAdd_PTR+8
	clr.w	SpecNoteAdd_PTR-2
	RET

SwapSpecBuf
	BGN
	movem.l	SpecNoteAdd_PTR+4,d0-d1
	exg	d0,d1
	movem.l	d0-d1,SpecNoteAdd_PTR+4
	RET

	acode	
UpdateDrawSpectrum
	cmpi.w	#TRUE,PLAYER_STATUS
	beq.s	DrawSpectrum
	rts

	acode
DrawSpectrum
	BGN
	bsr	GetSpectrumRP
	cmp.l	#0,a1
	beq	DrawSpectrumOrgan

	move.l	SpecNoteAdd_PTR,d6
	move.l	SpecNoteAdd_PTR+8,SpecNoteAdd_PTR


	move.l	SpecNoteAdd_PTR+4(PC),a2
	sub.l	a2,d6
	lsr.l	#2,d6
	move.l	d6,d0
	subq.w	#1,d6
	bmi.s	.exit

		
	moveq	#NOTE_SIZEOF,d7

	bsr	SpecEraseOldNote

	move.l	SpecBuffer_PTR(PC),a5
	moveq	#0,d5				;D5 NUMB OF NOTES

.loop
		;tst.b	(a3)+			;MUTED
		;beq.s	.next
		moveq	#0,d0

		puts	a0
		move.l	a2,a0
		jsr	GetNotePitch
		gets	a0

		cmpi.b	#NOTEPITCH_NONOTE,d0
		beq.s	.next

		jsr	UpdateColorOrgan
		bsr	SpecAddNote

.next	
	lea.l	(a2,d7.w),a2
	dbf	d6,.loop
	tst.w	d5
	beq.s	.exit

	move.w	d5,SpecNoteNumb
	subq.w	#1,d5
	move.l	SpecBuffer_PTR(PC),a5
.loop2
		move.w	(a5)+,d0
		bsr	GetHarmPixel
		bsr	DrawSpecUnit
	dbf	d5,.loop2
.exit	bsr	SwapSpecBuf
	move.w	#(SPECNOTEBUF_SIZE/4)-1,SpecNoteAdd_PTR-2
.exit2	RET

	acode
DrawSpectrumOrgan
	move.l	SpecNoteAdd_PTR,d6
	move.l	SpecNoteAdd_PTR+8,SpecNoteAdd_PTR
	move.l	SpecNoteAdd_PTR+4(PC),a2
	sub.l	a2,d6
	lsr.l	#2,d6
	move.l	d6,d0
	subq.w	#1,d6
	bmi.s	.exit
	moveq	#NOTE_SIZEOF,d7
	clr.w	SpecNoteNumb
	move.l	SpecBuffer_PTR(PC),a5
	moveq	#0,d5				;D5 NUMB OF NOTES
.loop	moveq	#0,d0
	puts	a0
	move.l	a2,a0
	jsr	GetNotePitch
	gets	a0
	cmpi.b	#NOTEPITCH_NONOTE,d0
	beq.s	.next
	jsr	UpdateColorOrgan
.next	lea.l	(a2,d7.w),a2
	dbf	d6,.loop
	tst.w	d5
	beq.s	.exit
	move.w	d5,SpecNoteNumb
	subq.w	#1,d5
	move.l	SpecBuffer_PTR(PC),a5
.exit	bsr	SwapSpecBuf
	move.w	#(SPECNOTEBUF_SIZE/4)-1,SpecNoteAdd_PTR-2
.exit2	RET



		dc.w	0		;Counter
SpecNoteAdd_PTR	dc.l	0,0,0

	acode
SpecEraseOldNote
	tst.w	SpecNoteNumb
	bne.s	.do
	rts
.do	BGN
	bsr	GetSpectrumRP
	cmp.l	#0,a1
	beq.s	.exit

	move.w	SpecNoteNumb,d5
	clr.w	SpecNoteNumb
	subq.w	#1,d5
	move.l	SpecBuffer_PTR(PC),a5
.loop		move.w	(a5)+,d0
		bsr	GetHarmPixel
		bsr	DrawSpecUnit
	dbf	d5,.loop
.exit	RET

	acode
GetNotePitch	;V1.0
		;I(A0L)(NOTE_PTR)
		;O(D0W)(NOTE_PITCH[==NO_NOTE]
	puts	d1/a0
	jsr	CheckNoteType
	cmpi.w	#NOTETYPEID_NONE,d0
	beq.s	GetNotePitch_Ill
	cmpi.w	#NOTETYPEID_NOTEON,d0
	beq.s	GetNotePitch_Ok

	cmpi.w	#NOTETYPEID_COMPLEXFX,d0
	beq.s	GetNotePitch_Complex

	swap	d0
	cmpi.b	#VOLUME_SETPITCH,d0
	beq.s	GetNotePitch_Ok
	bra.s	GetNotePitch_Ill

GetNotePitch_Complex
	swap	d0
	cmpi.b	#FX_FROMANDPITCH,d0
	beq.s	GetNotePitch_Ok
	cmpi.b	#FX_ADDHALVTONE,d0
	beq.s	GetNotePitch_Ok
	cmpi.b	#FX_PSLIDETO,d0
	beq.s	GetNotePitch_Ok
	bra.s	GetNotePitch_Ill

GetNotePitch_Ok
	moveq	#0,d1
	move.b	NOTE_PITCH(a0),d1

	moveq	#0,d0
	move.b	NOTE_INSTR(a0),d0
	jsr	GetInstrument
	move.l	d1,d0

	btst	#SPLAYFLAG_DODETUNE,INSTR_PLAYFLAG(a0)
	bne.s	GetNotePitch_X

		add.w	PatternTune,d0

GetNotePitch_X
	gets	d1/a0
	rts
	
GetNotePitch_Ill
		moveq	#NOTEPITCH_NONOTE,d0
	bra.s	GetNotePitch_X


SpecAddNote
	tst.w	d5
	beq.s	SpecAddNote_Do

	puts	d7/a4
	move.l	SpecBuffer_PTR(PC),a4
	move.w	d5,d7
	subq.w	#1,d7
SpecAddNote_Check
		cmp.w	(a4)+,d0
		beq.s	SpecAddNote_X
	dbf	d7,SpecAddNote_Check
	gets	d7/a4
SpecAddNote_Do
	addq.w	#1,d5
	move.w	d0,(a5)+
	rts
SpecAddNote_X
	gets	d7/a4
	rts

SPECMINSIZE		EQU	3
SPECNOTEBUF_SIZE	EQU	2048


	acode
	IFNE 1
DrawSpecUnit:
		movem.l	d0-a6,-(sp)
		;jsr	nullsub_1
		movea.l	a1,a5
		movem.w	(SPEC_SIZE).l,d6-d7
		move.w	d0,d2
		move.w	d1,d3
		add.w	d6,d2
		add.w	d7,d3
		sub.w	d6,d0
		sub.w	d7,d1
		movea.l	(_GraphicsBase).l,a6
		jsr	-$132(a6)

loc_E3F6:
		movea.l	a5,a1
		movem.l	(sp)+,d0-a6
		rts
SPEC_SIZE:	dc.w 3, 3

	ELSE
DrawSpecUnit	;V1.0
		;I(D0W,D1W)(X,Y)
	BGN
	move.w	SpecUnitSIZE,d6
	cmpi.w	#SPECMINSIZE,d6
	bhi.s	.ok
	move.w	#SPECMINSIZE,d6
.ok	move.w	d6,d7
	jsr	Set2OnlyPMask
	move.l	a1,a5
;	movem.w	SPEC_SIZE,d6-d7
	move.w	d0,d2
	move.w	d1,d3
	add.w	d6,d2
	add.w	d7,d3
	sub.w	d6,d0
	sub.w	d7,d1
	GFX	RectFill(a6)
	move.l	a5,a1
	RET
;SPEC_SIZE	dc.w	SPECMINSIZE,SPECMINSIZE
	ENDC
SpecUnitSIZE	dc.w	0

SpecNoteNumb	dc.w	0
SpecBuffer_PTR	dc.l	0,4096+(2*SPECNOTEBUF_SIZE),FASTMEM

;=== SPECTRUM END =========================================



	acode
DuplicatePosition	;V1.1

		IFNE	DEMO
	rts
		ELSE
	jsr	InsertPosition
	jsr	CopyPosition
	jsr	PosNumUp
	jsr	PastePosition
	jsr	UpdatePosList
	rts
		ENDC



	acode
DuplicatePattern	;V1.0
	IFNE	DEMO
	rts
	ELSE
	jsr	CopyPattern
	jsr	PatternUp
	jsr	PastePattern
	jsr	UpdatePosList
	rts
	ENDC


	acode
CutActualTrack
	IFNE	DEMO
	rts
	ELSE
	jsr	BackupPattern
	jsr	CopyActualTrack
	jsr	ClearActualTrack
	jsr	DrawEventStatusQ
	rts
	ENDC



;--- TABULATOR -----------------------------------------------


	acode
MoveTab	;V1.0
	BGN
	move.l	TabulatorMem_PTR,a1
	move.l	VEX_LinesPerPattern,d7
	subq.l	#1,d7
	moveq	#0,d0
	move.l	a1,a2
	move.w	d7,d6
.ScanL
		tst.b	(a2)+
		beq.s	.Fail
			addq.w	#1,d0
.Fail
	dbf	d6,.ScanL
	tst.w	d0
	beq.s	.exit


	lea.l	Test_PATTED,a0
	move.l	a1,a2
	move.w	PATTED_CRSRY(a0),d0
	add.w	PATTED_CRSRYOFFSET(a0),d0
	lea.l	1(a2,d0.w),a2
	
	move.w	d7,d6
	sub.w	d0,d6
	bmi.s	.M2
	subq.w	#1,d6
	bmi.s	.M2
	addq.w	#1,d0
.L1
		tst.b	(a2)+
		bne.s	.Succes
		addq.w	#1,d0
	dbf	d6,.L1

.M2
	move.l	a1,a2
	move.w	d7,d6
	moveq	#0,d0
.L2
		tst.b	(a2)+
		bne.s	.Succes
		addq.w	#1,d0
	dbf	d6,.L2
	bra.s	.exit

.Succes
	jsr	PattEdMoveToLine
.exit	RET


	acode
SetQuaterTabs	;V1.0
	BGN
	moveq	#4,d1
	moveq	#-1,d2
	move.l	TabulatorMem_PTR,a0
	move.l	VEX_LinesPerPattern,d0
	move.b	d2,(-1,a0,d0.w)
	divu.l	d1,d0
	move.w	d1,d7
	subq.w	#1,d7
.loop	move.b	d2,(a0)
	lea.l	(a0,d0.w),a0
	dbf	d7,.loop
	RET

SetTab	;V1.0
	cmpi.w	#TRUE,Shift_KEY
	bne.w	MoveTab
	puts	d0/a0
	lea.l	Test_PATTED,a0
	move.w	PATTED_CRSRY(a0),d0
	add.w	PATTED_CRSRYOFFSET(a0),d0
	bsr	SetTabulator
	gets	d0/a0

	rts

SetTabulator	;V1.0
		;I(D0W)
	BGN

	move.l	TabulatorMem_PTR(PC),a1
	eori.b	#-1,(a1,d0.w)
	jsr	PatEdDrawActLine

	RET

SpeedUp
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	addq.w	#1,POSITION_SPEED(a2)
	;move.w	POSITION_SPEED(a2),d2
	;move.l	#"SV15",d0
	;jsr	NGODrawDecWord3Char
	jsr	DrawPosition
	jsr	UpdatePosListQ
	RET
	ENDC
	rts

SpeedDown
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	cmpi.w	#1,POSITION_SPEED(a2)
	beq.s	.exit
		subq.w	#1,POSITION_SPEED(a2)
		;move.w	POSITION_SPEED(a2),d2
		;move.l	#"SV15",d0
		;jsr	NGODrawDecWord3Char
		jsr	DrawPosition
		jsr	UpdatePosListQ
.exit	RET
	ENDC


;--- PREFS --------------------------------------------------------

	IFNE SAVEENCODED
EncodeArea	;V1.0
	BGN
	move.w	#"A0",d0

	lsr.l	#1,d5
	subq.w	#2,d5
	bmi.s	.exit
.loop	sub.w	d0,(a5)+
	addq.w	#1,d0
	dbf	d5,.loop
.exit	RET

SaveArea	;V1.0
	BGN
	move.l	#MODE_NEWFILE,d0
	move.l	a4,d1
	jsr	EasyDOpen
	move.l	a5,a0
	move.l	d5,d0
	jsr	EasyDWrite
	jsr	EasyDClose
	RET
	

SaveEncodedStrings	;V1.0
	BGN
	lea.l	Encode_START,a5
	move.l	#Encode_END-Encode_START,d5
	lea.l	.gui_txt,a4
	bsr	EncodeArea
	bsr	SaveArea
	bsr	DecodeArea
	RET
.gui_txt	dc.b	"ram:GUI.text",0
	ENDC

LoadArea	;V1.0
	BGN
	move.l	#MODE_OLDFILE,d0
	move.l	a4,d1
	jsr	EasyDOpen
	move.l	a5,a0
	move.l	d5,d0
	jsr	EasyDRead
	jsr	EasyDClose
	RET
	
	;--- strings dekodieren ---
DecodeStrings
	BGN
	lea.l	Encode_START,a5
	move.l	#Encode_END-Encode_START,d5
	bsr	DecodeArea
	RET
	
DecodeArea	;V1.0
	BGN
	move.w	#"A0",d0

	lsr.l	#1,d5
	subq.w	#2,d5
	bmi.s	.exit
.loop	add.w	d0,(a5)+
	addq.w	#1,d0
	dbf	d5,.loop
.exit	RET


;gui_txt	dc.b	"work:Assembler/GUI.text",0
;LoadEncodedStrings
;	BGN
;	lea.l	Encode_START,a5
;	move.l	#Encode_END-Encode_START,d5
;	lea.l	gui_txt,a4
;	bsr	LoadArea
;	lea.l	gui_txt,a0
;	clr.l	(a0)+
;	clr.l	(a0)+
;	clr.l	(a0)+
;	clr.l	(a0)+
;	clr.l	(a0)+
;	clr.l	(a0)+
;	RET


	acode
LoadDefaultPrefs
	cmpi.b	#TRUE,DefaultPrefs
	beq.s	LoadDefPref
	rts
LoadDefPref
	BGN
	move.b	#FALSE,DefaultPrefs

	lea.l	DefaultPrefs_TXT(PC),a0
	move.l	FinalFileNameRT_PTR,a1
	jsr	CopyString

	move.l	#MODE_OLDFILE,d0
	jsr	EasyDOpenFFN
	tst.l	d0
	beq.w	LoadPrefs_X

	move.l	#Prefs_SIZE,d0
	lea.l	GuiPrefsHead,a0
	jsr	EasyDRead
	tst.l	d0
	beq.w	LoadPrefs_X

		bra	SetPrefs_LINK




;SetLateDefaultPrefs
;	rts
;	cmpi.b	#TRUE,DefaultPrefs+1
;	beq.s	DoLateDefPref
;	rts
;DoLateDefPref	
;	move.b	#FALSE,DefaultPrefs+1
;	BGN
;	bra.s	SetPrefs_LINK

DefaultPrefs	dc.b	TRUE,FALSE


	acode
PrepareCDDA
	BGN
	lea.l	.reqfile_TXT,a0
	jsr	SimpleFileRequest
	tst.w	d0
	beq.w	.exit

	lea.l	.temp,a0
	lea.l	.text,a1
	moveq	#0,d1
	move.l	#10000,d2
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit

	tst.l	.temp
	beq.s	.exit

	move.l	.temp,d6

	move.l	FinalFileNameRT_PTR,a0
	move.l	#MODE_OLDFILE,d0
	jsr	EasyDOpenFFN
	tst.l	d0
	beq.s	.end

	jsr	GetFileName	
	jsr	FileLength
	tst.l	d0
	beq.s	.end

	andi.l	#$fffffffc,d0
	jsr	WriteAssDecLong

	move.l	d0,d7	;d7=actual length
	move.l	d7,d5
	divu.l	d6,d5
	addq.l	#1,d5
	mulu.l	d6,d5
	sub.l	d7,d5
	move.l	d5,d0
	
	jsr	WriteAssDecLong

	move.l	d0,d6
	lsr.l	#2,d6
	subq.l	#1,d6
	bmi.s	.end



	move.l	d7,d1

.loop	moveq	#0,d0
	jsr	EasyDWriteLong
	tst.l	d0
	beq.s	.end
	addq.l	#4,d1
	dbf	d6,.loop

	;EasyDWriteLong  ;V1.0 I(D0L,D1L)(VALUE,OFFSET)


	

.end	jsr	EasyDClose
.exit	RET

.temp		dc.l	2352
.text		dc.b	"Block Size (e.g. 2352)",0
.reqfile_TXT	dc.b	"CDDA File Name",0

	acode
LoadPrefs
	BGN
	lea.l	Prefs_MATCH,a0
	jsr	SetFileRequestPat
	lea.l	PrefsDir_TXT,a0
	jsr	SetFileRequestPath

	lea.l	LoadPrefs_TXT,a0
	jsr	SimpleFileRequest
	tst.w	d0
	beq.w	LoadPrefs_X

	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	Prefs_MATCH+2,a1
	jsr	AddExtention

	move.l	#MODE_OLDFILE,d0
	jsr	EasyDOpenFFN
	tst.l	d0
	beq.s	LoadPrefs_X

		move.l	#Prefs_SIZE,d0
		lea.l	GuiPrefsHead,a0
		jsr	EasyDRead
		tst.l	d0
		beq.s	LoadPrefs_X


SetPrefs_LINK
		cmpi.l	#"SYM",GuiPrefsHead
		bne.s	LoadPrefs_ILL
		cmpi.l	#"PRFS",GuiPrefsHead+4
		bne.s	LoadPrefs_ILL
		cmpi.w	#$0001,GuiPrefsHead+8
		bhi.s	LoadPrefs_ILL

		cmpi.w	#$0001,GuiPrefsHead+8
		bhs.s	LoadPrefs_REV1
		jsr	SetAudioPrefs
		;jsr	SetGuiPrefs
		bra.s	LoadPrefs_X

LoadPrefs_REV1
		move.b	GuiPrefsHead+10,d0
		lea.l	SetPrefs_LIST(PC),a0

LoadPrefs_L
		move.w	(a0)+,d1
		cmpi.w	#-1,d1
		beq.s	LoadPrefs_X

		move.w	(a0)+,d2
		move.l	(a0)+,a1
		cmp.w	#PREFSVER,d1
		bhi.s	LoadPrefs_L
		btst	d2,d0
		bne.s	LoadPrefs_L
		jsr	(a1)
	bra.s	LoadPrefs_L

LoadPrefs_X	jsr	EasyDClose
	RET
LoadPrefs_ILL
	ASSTXT	noprefs_TXT
	bra.s	LoadPrefs_X

SetPrefs_LIST
	dc.w	$0001,PREFS_GUI
	dc.l	SetGuiPrefs
	dc.w	$0001,PREFS_AUDIO
	dc.l	SetAudioPrefs
	dc.w	$0001,PREFS_STRUCT
	dc.l	SetStructPrefs
	dc.w	-1

SavePrefs
	BGN
	lea.l	DefaultPrefs_TXT(PC),a0
	move.l	FinalFileNameRT_PTR,a1
	jsr	CopyString
	bra.s	SavePrefs_LINK

SavePrefsAs
	BGN
	lea.l	Prefs_MATCH,a0
	jsr	SetFileRequestPat
	lea.l	PrefsDir_TXT,a0
	jsr	SetFileRequestPath
	lea.l	SavePrefsAs_TXT,a0
	jsr	SimpleFileRequest
	tst.w	d0
	beq.w	SavePrefsAs_X

	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	Prefs_MATCH+2,a1
	jsr	AddExtention
SavePrefs_LINK

	move.l	#"SYM",GuiPrefsHead
	move.l	#"PRFS",GuiPrefsHead+4
	move.l	#$00010000,GuiPrefsHead+8
	move.b	Prefs,GuiPrefsHead+10		;FLAGS

	jsr	ReadGuiPrefs
	jsr	BuildAudioPrefs
	jsr	BuildStructPrefs

	move.l	#MODE_NEWFILE,d0
	jsr	EasyDOpenFFN
	tst.l	d0
	beq.s	SavePrefsAs_X

	move.l	#Prefs_SIZE,d0
	lea.l	GuiPrefsHead,a0
	jsr	EasyDWrite

SavePrefsAs_X	
	jsr	EasyDClose
	RET


	IFNE DEMO
DefaultPrefs_TXT	dc.b	"ENVARC:SymphNGPlayer.prefs",0
	ELSE
DefaultPrefs_TXT	dc.b	"ENVARC:SymphonieNG.prefs",0
	ENDC


Prefs	dc.b	0	;1=BIT OFF


PREFS_AUDIO		EQU	1
PREFS_GUI		EQU	2
PREFS_STRUCT		EQU	3


	acode
TAudioPrefs	bchg	#PREFS_AUDIO,Prefs
	rts
TVideoPrefs	bchg	#PREFS_GUI,Prefs
	rts
TStructPrefs	bchg	#PREFS_STRUCT,Prefs
	rts





PREFLPTR	EQU	0
PREFWPTR	EQU	1
PREFBPTR	EQU	2
PREFBLK		EQU	3

PREFTYPE_MAX	EQU	2

PREFSVER	EQU	$0001

BuildAudioPrefs
	BGN
	lea.l	APrefs_MAKELIST,a0
	move.l	(a0)+,a1
	jsr	MakePrefs
	RET

BuildStructPrefs
	BGN
	lea.l	StructPrefs_MAKELIST,a0
	move.l	(a0)+,a1
	jsr	MakePrefs
	RET


SetAudioPrefs
	BGN
	btst	#PREFS_AUDIO,Prefs
	bne.s	SetAudioPrefs_X

	lea.l	APrefs_MAKELIST,a0
	move.l	(a0)+,a1
	jsr	SetPrefs

	tst.w	VL_PROCVLIMIT
	bne.s	.ok1

	move.w	#PROCVLIMIT_INIT,VL_PROCVLIMIT
.ok1
	;jsr	DrawSystemSetup
	;jsr	ShowDspStatus
	;jsr	ForceEvenBufNumb		;NEWBUFSYNC
	;jsr	RebuildSoundSystem
	;	jsr	DrawSystemSetup
	;	jsr	PattedUpdateDisp
	;	jsr	ShowMainTitle
	;	jsr	UpdateSampleBoost
SetAudioPrefs_X
	RET

SetStructPrefs
	BGN
	btst	#PREFS_STRUCT,Prefs
	bne.s	SetStructPrefs_X

	lea.l	StructPrefs_MAKELIST,a0
	move.l	(a0)+,a1
	jsr	SetPrefs
	;jsr	UpdateChannelNumb
	;jsr	DoRestart
SetStructPrefs_X
	RET

;UpdateChannelNumb
;	BGN
;	move.w	CHANNEL_NUMB,d0
;	lea.l	ChannelNumb_JL-8(PC),a0
;
;UpdateChannelNumb_L
;		lea.l	8(a0),a0
;		movem.l	(a0),d1/a1
;		cmpi.l	#-1,d1
;		beq.s	UpdateChannelNumb_X
;		cmp.w	d0,d1
;		bne.s	UpdateChannelNumb_L;
;
;	jsr	(a1)
;UpdateChannelNumb_X	RET


MakePrefs
	BGN
	lea.l	MPrefUnit_JL(PC),a3
MakePrefUnit_L
	move.l	(a0)+,d0
	cmpi.l	#PREFTYPE_MAX,d0
	bhi.s	MakePrefUnit_X
		lea.l	(a3,d0.w*4),a2
		move.l	(a2),a2
		jsr	(a2)
	bra.s	MakePrefUnit_L
MakePrefUnit_X	RET

MakeULPTR
	move.l	(a0)+,a5
	move.l	(a5),(a1)+
	rts
MakeUWPTR
	move.l	(a0)+,a5
	move.w	(a5),(a1)+
	rts
MakeUBPTR
	move.l	(a0)+,a5
	move.b	(a5),(a1)+
	rts
MPrefUnit_JL	dc.l	MakeULPTR,MakeUWPTR,MakeUBPTR

SetPrefs
	BGN
	lea.l	SPrefUnit_JL(PC),a3
SetPrefUnit_L
	move.l	(a0)+,d0
	cmpi.l	#PREFTYPE_MAX,d0
	bhi.s	SetPrefUnit_X
		lea.l	(a3,d0.w*4),a2
		move.l	(a2),a2
		jsr	(a2)
	bra.s	SetPrefUnit_L
SetPrefUnit_X	RET

SetULPTR
	move.l	(a0)+,a5
	move.l	(a1)+,(a5)
	rts
SetUWPTR
	move.l	(a0)+,a5
	move.w	(a1)+,(a5)
	rts
SetUBPTR
	move.l	(a0)+,a5
	move.b	(a1)+,(a5)
	rts
SPrefUnit_JL	dc.l	SetULPTR,SetUWPTR,SetUBPTR



;--- GFX PRINT ---------------------------------------------------


	acode
PrintAssDecByte	;(D0B)
	BGN
	jsr	ConvertToDecByte
	lea	DecByteSave,a0
	jsr	PrintAssText
	RET

	acode
PrintDblAssHex
	BGN
	lea.l	AssHex-9(PC),a0
	jsr	ConvertToHexLong
	move.l	d1,d0
	lea.l	AssHex(PC),a0
	jsr	ConvertToHexLong
	lea.l	AssHex-9(PC),a0
	move.b	#" ",8(a0)
	jsr	PrintAssText
	RET

	acode
PrintHexLong
PrintAssHex	;(D0L)
	BGN
	lea.l	AssHex(PC),a0
	jsr	ConvertToHexLong
	jsr	PrintAssText
	RET

	acode
PrintDblAssString	;(A0L,A1L)(Shows TXT1 & TXT2)
	puts	a0
	bsr	ClrAssString
	bsr	AddAssString
	move.l	a1,a0
	bsr	AddAssString
	bsr	DisplayAssString
	gets	a0
	rts
ClrAssString
	puts	a0
	move.l	TempAssString(PC),a0
	clr.b	(a0)
	gets	a0
	rts
AddAssString
	;I(a0)(TXT)
	BGN
	move.l	TempAssString(PC),a1
	tst.b	(a0)
	beq.s	AddAssString_X
		jsr	AddString
AddAssString_X
	RET

DisplayAssString
	BGN
	move.l	TempAssString(PC),a0
	tst.b	(a0)
	beq.s	DisplayAStr_X
		jsr	PrintAssText

		clr.b	(a0)
DisplayAStr_X	RET




;--- EASY DOS --------------------------------------------------------

	acode
EasyDOpenFFN
	;I(D0L)(MODE)
	puts	d1/a0

	jsr	ClrAssString
	lea.l	EasyDO,a0

	cmpi.l	#MODE_NEWFILE,d0
	bne.s	EasyDOpenNEW
		lea.l	EasyDOLD,a0
EasyDOpenNEW

	jsr	AddAssString
	move.l	FinalFileNameRT_PTR,a0
	jsr	AddAssString
	jsr	DisplayAssString

	move.l	FinalFileNameRT_PTR,d1
	bsr	EasyDOpen
	gets	d1/a0
	rts

	acode
EasyDFindFile	;V1.0	3.3d
		;I(D1L)(FILENAME)
		;O(D0L)(0=NOT EXISTANT)
	puts	d1-d7/a0-a6
	;move.l	a0,d1
	move.l	#ACCESS_READ,d2
	DOS	Lock(a6)
	move.l	d0,d7
	tst.l	d0
	beq.s	.exit
	move.l	d7,d1
	DOS	UnLock(a6)
.exit	move.l	d7,d0
	gets	d1-d7/a0-a6
	rts

Overwrite_TestFFN	;V1.0	3.3d
	BGN
	move.b	#TRUE,Overwrite_STATUS
	cmpi.b	#TRUE,EasyDOpen_SAFE
	bne.s	.exit
	move.l	FinalFileNameRT_PTR,d1
	jsr	EasyDFindFile
	tst.l	d0
	beq.s	.notexist
	lea.l	Overwrite_CTXT,a0
	jsr	MulitChoiceRequest
	tst.w	d0
	bne.s	.exit
	move.b	#FALSE,Overwrite_STATUS
.notexist
.exit	RET


Overwrite_STATUS	dc.b	FALSE				;FALSE = NOPE
Overwrite_CTXT		dc.b	"File Exists. Overwrite ?",0	;3.3d
			dc.b	"Yes|Abort",0


EasyDOpen	;V1.0
	;I(D0L,D1L)(MODE,FILENAME)
	;O(D0L:0=ERROR)
	puts	d1-a6

	bsr	EasyDClrBLen

	move.l	d0,d2
	cmpi.l	#MODE_NEWFILE,d2
	bne.s	.notsafe
	cmpi.b	#TRUE,EasyDOpen_SAFE
	bne.s	.notsafe	
	bsr	EasyDFindFile
	tst.l	d0
	beq.s	.notsafe

	lea.l	Overwrite_CTXT,a0
	jsr	MulitChoiceRequest
	tst.w	d0
	beq.s	.cancel
.notsafe
	DOS	Open(a6)
	tst.l	d0
	bne.s	.OK
	ASSTXT	EasyDOERR
.OK
	move.l	d0,EasyDHandle
.exit	gets	d1-a6
	rts
.cancel	moveq	#0,d0
	bra.s	.exit

EasyDOpen_SAFE	dc.b	FALSE


	acode
Wait5Secs
	BGN
	move.l	#3*50,d1
	DOS	Delay(a6)
	RET

EasyDClose	;V1.0 ()
	BGN
	move.l	EasyDHandle(PC),d1
	beq.s	EasyDClose_X
		ASSTXT	Done_TXT
		DOS	Close(a6)
EasyDClose_X	
	lea.l	EasyDWBuf_PTR(PC),a0
		move.l	#$00010006,MEM_DEBUG_INFO
		move.l	#$00000000,MEM_DEBUG_INFO+4
	jsr	FreeMem
	clr.l	EasyDHandle
	RET

	acode
ReqMinMaxLong	;V1.1 I(D1L,D2L)(MIN,MAX)
	puts	d1-a6
	move.l	(a0),d6
.loop	jsr	LongRequest
	tst.w	d0
	beq.s	.cancel
	move.l	(a0),d0
	cmp.l	d0,d1
	ble.s	.checkmax
	move.l	d1,(a0)
	bra.s	.loop
.checkmax
	cmp.l	d0,d2
	bge.s	.ok
	move.l	d2,(a0)
	bra.s	.loop
.ok	move.l	d0,d6
	moveq	#-1,d0
.cancel	move.l	d6,(a0)
	gets	d1-a6
	rts


	acode
	IFNE RENDER
ReqFileBLen
	BGN
	move.l	#8,d1
	move.l	#10000,d2
	lea.l	EasyBufLen(PC),a0
	lea.l	RBufLen_TXT,a1

	moveq	#10,d6
	move.l	(a0),d7
	lsr.l	d6,d7
	move.l	d7,(a0)
	jsr	ReqMinMaxLong
	move.l	(a0),d7
	lsl.l	d6,d7
	move.l	d7,(a0)
	RET

	ENDC

	acode
EasyDGetBuf	;I(D0L)(MIN)
	BGN
	clr.b	EasyDWBuf_STATUS

	move.l	d0,d6
	lsl.l	#1,d6
	move.l	EasyBufLen(PC),d7
	lea.l	EasyDWBuf_PTR(PC),a0

.loop	move.l	d7,4(a0)

	jsr	GetMem
	tst.l	d0
	bne.s	.found		;success

	clr.l	(a0)

	lsr.l	#1,d7
	cmp.l	d6,d7
	bhs.s	.loop
	RET

.found	move.l	d7,d0
	jsr	WriteAssDecLong			;show buffer length
	jsr	WriteAssDecLong

	move.l	d7,EasyDWBuf_MAXLEN
	bsr	EasyDWBufInit
	RET

EasyDWBufInit
	BGN
	move.l	EasyDWBuf_PTR(PC),EasyDWBuf_APTR
	clr.l	EasyDWBuf_LEN
	RET

	acode
EasyDFlushBuf
	tst.l	EasyDWBuf_PTR
	bne.s	.go
	rts
.go	puts	a0
	move.l	EasyDWBuf_LEN,d0
	move.l	EasyDWBuf_PTR(PC),a0
	bsr	EasyDWrite
	gets	a0
	rts

	acode
EasyDWriteBuf	;V1.0 I(D0L,A0L)(LEN,PTR)
		;O(D0L:0=ERROR)
	tst.b	EasyDWBuf_STATUS
	beq.s	.go

	bsr	EasyDGetBuf

.go	tst.l	EasyDWBuf_PTR
	beq.s	EasyDWrite

	puts	d1-a6

	move.l	EasyDWBuf_LEN,d7
	add.l	d0,d7

	cmp.l	EasyDWBuf_MAXLEN,d7
	bls.s	.memwrite
	
	move.l	d0,d7

	bsr	EasyDFlushBuf
	tst.l	d0
	beq.s	.err
	bsr	EasyDWBufInit

	move.l	d7,d0
	
.memwrite
	move.l	EasyDWBuf_APTR,a1
	jsr	CopyMemory
	add.l	d0,EasyDWBuf_APTR

	move.l	d7,EasyDWBuf_LEN
	moveq	#-1,d0
	
.err	gets	d1-a6
	rts

EASYDBUFLENGTH	EQU	256000


	acode
EasyDGetBLen
	move.l	EasyBufLen+4(PC),d0
	rts

EasyDClrBLen	clr.l	EasyBufLen+4
	rts

	acode
EasyDWrite	;V1.0 I(D0L,A0L)(LEN,PTR)
		;O(D0L:0=ERROR)
	puts	d1-a6
	move.l	a0,d2
	move.l	d0,d3
	moveq	#0,d0

	move.l	EasyDHandle(PC),d1
	beq.s	.err

		DOS	Write(a6)

	tst.l	d0
	bpl.s	.exit
		moveq	#0,d0

.err	tst.l	d0
	bne.s	.exit
		ASSTXT	EasyDWERR

.exit	add.l	d0,EasyBufLen+4
	gets	d1-a6
	rts

EasyDHandle	dc.l	0

EasyDWriteLong	;V1.0 I(D0L,D1L)(VALUE,OFFSET)
		;O(D0L:0=ERROR)
	puts	d1-a6
	move.l	d0,EasyDLong
	move.l	d1,d2
	move.l	EasyDHandle(PC),d1
	moveq	#-1,d3
	DOS	Seek(a6)
	lea.l	EasyDLong(PC),a0
	moveq	#4,d0
	bsr	EasyDWrite
	gets	d1-a6
	rts
EasyDLong	dc.l	0


EasyDRead	;V1.0 I(D0L,A0L)(LEN,PTR)
		;O(D0L:0=ERROR)
	puts	d1-a6
	move.l	a0,d2
	move.l	d0,d3
	moveq	#0,d0
	move.l	EasyDHandle(PC),d1
	beq.s	EasyDRead_X
		DOS	Read(a6)
	tst.l	d0
	bpl.s	EasyDRead_X
		moveq	#-1,d0
EasyDRead_X
	addq.l	#1,d0
	tst.l	d0
	bne.s	EasyDRead_OK
		ASSTXT	EasyDRERR
EasyDRead_OK
	gets	d1-a6
	rts


;--- SAMPLE BANK -------------------------------------------------

	acode
SaveInstrSetup
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	SampleList_MATCH,a0
	jsr	SetFileRequestPat

	lea.l	SaveInstrSetup_TXT,a0
	moveq	#PBUFID_SBANK,d0
	jsr	GetPathBuf
	jsr	SimpleFileRequest
	jsr	SavePathBuf
	tst.w	d0
	beq.s	SaveInstrSetup_X
		bsr	SaveActualInstruments
SaveInstrSetup_X	RET
	ENDC

LoadActualBlock	;V1.0 : 3.3d
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Block_MATCH,a0
	jsr	SetFileRequestPat
	lea.l	LoadActualBlock_TXT,a0
	moveq	#PBUFID_SBANK,d0
	jsr	GetPathBuf
	jsr	SimpleFileRequest
	jsr	SavePathBuf
	tst.w	d0
	bne.s	.do
.exit	RET

.do	move.l	ActualBlock_PTR,a3		;a3 BlockPtr
	cmpa.l	#0,a3
	beq.s	.exit

	lea.l	ActualBlock_INFO,a2		;a2 BlockInfoPtr

	move.l	#MODE_OLDFILE,d0
	jsr	EasyDOpenFFN
	tst.l	d0
	beq.s	.exit


	jsr	EasyDReadLong
	tst.l	d1
	beq	.err
	cmpi.l	#BLOCKFILE_IDENT,d0
	bne	.err
	jsr	EasyDReadLong
	tst.l	d1
	beq	.err
	cmpi.l	#1,d0
	bne	.err

	jsr	EasyDReadLong
	jsr	EasyDReadLong			;W
	tst.l	d1
	beq	.err
	move.l	d0,d2
	beq	.err

	jsr	EasyDReadLong
	jsr	EasyDReadLong			;H
	tst.l	d1
	beq	.err
	move.l	d0,d3
	beq	.err

	jsr	EasyDReadLong
	jsr	EasyDReadLong
	tst.l	d1
	beq.s	.err
	cmpi.l	#4,d0
	bne.s	.err

	jsr	EasyDReadLong
	jsr	EasyDReadLong
	tst.l	d1
	beq.s	.err
	tst.l	d0
	beq.s	.err

	move.w	d2,BLOCKINFO_W(a2)
	move.w	d3,BLOCKINFO_H(a2)

	move.l	a3,a0
	jsr	EasyDRead
	tst.l	d1
	beq.s	.err

	
	jsr	EasyDReadLong
	tst.l	d1
	beq.s	.nodiz
	jsr	EasyDReadLong
	tst.l	d1
	beq.s	.nodiz
	tst.l	d0
	beq.s	.nodiz

	lea.l	Block_Diz,a0
	clr.b	(a0)
	move.l	#256,d0
	jsr	EasyDRead
	tst.l	d1
	beq.s	.nodiz
	tst.b	(a0)
	beq.s	.nodiz
	jsr	PrintAssText
	
.nodiz	jsr	EasyDClose
	bra	.exit

.err	jsr	EasyDClose
	clr.w	BLOCKINFO_W(a2)
	clr.w	BLOCKINFO_H(a2)
	bra	.exit
	ENDC


EasyDReadLong	;V1.0	3.3d
	puts	a0
	lea.l	EasyDLong,a0
	move.l	#4,d0
	jsr	EasyDRead
	move.l	d0,d1
	move.l	(a0),d0
	gets	a0
	rts


SaveActualBlock	;V1.0	3.3d
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Block_MATCH,a0
	jsr	SetFileRequestPat

	lea.l	SaveActualBlock_TXT,a0
	moveq	#PBUFID_SBANK,d0
	jsr	GetPathBuf
	jsr	SimpleFileRequest
	jsr	SavePathBuf
	tst.w	d0
	bne.s	.do
.exit	RET

.do	
	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	Block_MATCH+2,a1
	jsr	AddExtention

	
	lea.l	ActualBlock_INFO,a2		;a2 BlockInfoPtr
	tst.w	BLOCKINFO_W(a2)
	beq.s	.exit
	tst.w	BLOCKINFO_H(a2)
	beq.s	.exit

	move.l	ActualBlock_PTR,a3		;a3 BlockPtr
	cmpa.l	#0,a3
	beq.s	.exit

	lea.l	Block_HEAD,a0
	moveq	#0,d0
	move.w	BLOCKINFO_W(a2),d0
	move.l	d0,12(a0)
	move.l	d0,d7
	move.w	BLOCKINFO_H(a2),d0
	move.l	d0,20(a0)
	mulu.l	d0,d7
	mulu	#4,d7
	move.l	d7,36(a0)

	move.b	#TRUE,EasyDOpen_SAFE
	move.l	#MODE_NEWFILE,d0
	jsr	EasyDOpenFFN
	move.b	#FALSE,EasyDOpen_SAFE
	tst.l	d0
	beq	.exit

	move.l	#Block_HEADEND-Block_HEAD,d0
	lea.l	Block_HEAD,a0
	jsr	EasyDWrite
	move.l	d7,d0
	move.l	a3,a0
	jsr	EasyDWrite

	move.l	#255,d0
	lea.l	Block_Diz,a0
	lea.l	Block_Diz_TXT,a1
	jsr	StringRequest
	tst.b	(a0)
	beq.s	.nodiz
	tst.w	d0
	beq.s	.nodiz

	move.l	#Block_Diz_HEADEND-Block_Diz_HEAD,d0
	lea.l	Block_Diz_HEAD,a0
	jsr	EasyDWrite

.nodiz	jsr	EasyDClose
	bra	.exit
	ENDC


BLOCKFILE_IDENT			EQU	"SymB"
BLOCKFILE_VERSION		EQU	1

; MODHEADTYPE_CHANNELNUMB
; MODHEADTYPE_TRACKLEN

; BLOCKINFO_FLAG	EQU	0
; BLOCKINFO_X	EQU	2
; BLOCKINFO_Y	EQU	4
; BLOCKINFO_X2	EQU	6
; BLOCKINFO_Y2	EQU	8
; BLOCKINFO_W	EQU	10
; BLOCKINFO_H	EQU	12


Block_HEAD
	dc.l	BLOCKFILE_IDENT,BLOCKFILE_VERSION	;0
	dc.l	MODHEADTYPE_CHANNELNUMB,0		;8
	dc.l	MODHEADTYPE_TRACKLEN,0			;16
	dc.l	MODHEADTYPE_NOTESIZE,4			;24
	dc.l	MODHEADTYPE_NOTEDATA,0			;32
Block_HEADEND

Block_Diz_HEAD		dc.l	MODHEADTYPE_STRING,256
Block_Diz		blk.b	256,0
Block_Diz_HEADEND


	acode
LoadInstrSetup
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	SampleList_MATCH,a0
	jsr	SetFileRequestPat

	lea.l	LoadInstrSetup_TXT,a0
	moveq	#PBUFID_SBANK,d0
	jsr	GetPathBuf
	jsr	SimpleFileRequest
	jsr	SavePathBuf
	tst.w	d0
	beq.s	LoadInstrSetup_X
		bsr	LoadActualInstruments
		bsr	AutoLoadSamples
		jsr	AutoCalcLineSamples
LoadInstrSetup_X	RET

	ENDC

	acode
ReloadInstrSetup
	bsr	AutoLoadSamples
	jmp	AutoCalcLineSamples(PC)


SaveActualProject
	IFNE	DEMO
	rts
	ELSE
	BGN

	move.l	FinalFileNameRT_PTR,a1
	move.l	ProjectName_PTR,a0
	tst.b	(a0)
	beq	SaveActualProject_X

	jsr	CopyString
	move.b	ProjectName_PTR-4,MODULE_SONGTYPE
	bra.s	SaveActualProject_LINK
	ENDC

SaveActualProjectAs
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Song_MATCH,a0
	jsr	SetFileRequestPat
	lea.l	SongDir_TXT,a0
	jsr	SetFileRequestPath

	lea.l	SaveActualProject_TXT,a0


	moveq	#PBUFID_SONG,d0
	jsr	GetPathBuf
	jsr	GetTempProj
	jsr	SimpleFileRequest
	jsr	SavePathOnlyBuf
	tst.w	d0
	beq.s	SaveActualProject_X
	;jsr	SavePathBuf
	

	ENDC

	IFNE	DEMO
	rts
	ELSE
	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	Song_EXT,a1
	jsr	AddExtention2
	jsr	SavePathBuf

	move.b	#TRUE,MODULE_SONGTYPE
	move.b	#TRUE,EasyDOpen_SAFE

SaveActualProject_LINK
	
	jmp	SaveActualModule_LINKSONG

;	bsr	SaveActualSong
;	bsr	SaveActualInstruments
;	bsr	SaveActualSongData
;	bsr	SaveActualSequence



	move.b	#FALSE,MODULE_SONGTYPE

	move.l	FinalFileNameRT_PTR,a1
	move.l	ProjectName_PTR,a0
	tst.b	(a0)
	beq	SaveActualProject_X
	jsr	CopyString


SaveActualProject_X	
	move.b	#FALSE,EasyDOpen_SAFE
	RET



	ENDC


	acode
EasyBufLen		dc.l	256*1024,0
EasyDWBuf_APTR		dc.l	0
EasyDWBuf_LEN		dc.l	0
EasyDWBuf_MAXLEN	dc.l	0
EasyDWBuf_PTR		dc.l	0,0,FASTMEM

ChannelNumb_JL						;BUG FIXED
	dc.l	4,DoNil			;SetFourVoices
	dc.l	8,SetEightVoices
	dc.l	16,SetSixteenVoices
	dc.l	32,SetThirtytwoVoices
	IFEQ AMINETDEMO
	dc.l	64,SetSixtyFourVoices
	dc.l	128,Set128Voices
	dc.l	256,Set256Voices
	ENDC
	dc.l	-1

			dc.l	0,0,0
AssHex			dc.l	0,0,0

ModHead_PTR		dc.l	0,MKHEAD_SIZEOF,FASTMEM
ModSong_PTR		dc.l	0,128000,FASTMEM
ModuleDiz_PTR		dc.l	0,0,FASTMEM
ModuleDiz2_PTR		dc.l	0,0,FASTMEM
TempAssString		dc.l	0,512,FASTMEM
TabulatorMem_PTR	dc.l	0,0,FASTMEM	;to be inited


MODFILE_IDENT				EQU	"SymM"
MODFILE_VERSION				EQU	1

MODHEADTYPE_CHANNELNUMB		EQU	-1	; TYPE,PARAMETER:LONG
MODHEADTYPE_TRACKLEN		EQU	-2
MODHEADTYPE_PATTERNNUMB		EQU	-3
MODHEADTYPE_SAMPLENUMB		EQU	-4
MODHEADTYPE_NOTESIZE		EQU	-5
MODHEADTYPE_SYSTEMSPEED		EQU	-6
MODHEADTYPE_ISSONG		EQU	-7

MODHEADTYPE_SONGDATA		EQU	-10	; TYPE,BLOCKLEN:LONG,BLOCKDATA...
MODHEADTYPE_SAMPLE		EQU	-11
MODHEADTYPE_EMPTYSAMPLE		EQU	-12	;1 SINGLE LONG !!!
MODHEADTYPE_NOTEDATA		EQU	-13
MODHEADTYPE_SAMPLENAMES		EQU	-14
MODHEADTYPE_SEQUENCE		EQU	-15
MODHEADTYPE_INFOTEXT		EQU	-16
MODHEADTYPE_DELTASAMPLE		EQU	-17
MODHEADTYPE_DELTA16		EQU	-18

MODHEADTYPE_INFOOBJ		EQU	-20
MODHEADTYPE_INFOTYPE		EQU	-19
MODHEADTYPE_STRING		EQU	-21	;3.3d

MODHEADTYPE_EOF			EQU	0

;--- NG -----------------------------------------------------------------
MODHEADTYPE_NGSAMPLEBOOST	EQU	10
MODHEADTYPE_PITCHDIFF		EQU	11
MODHEADTYPE_SAMPLEDIFF		EQU	12



	acode
LoadActualModule:
	jsr	ClrLockState
	BGN
	cmpi.b	#TRUE,SONGFILEIO
	beq	LoadActualModule_Xc

	jsr	HideBlockRange
	jsr	PatEdCrsrOff

	move.b	#TRUE,SONGFILEIO

	jsr	PattedUpdateReset
	jsr	FreeModuleDiz
	jsr	FreeModuleDiz2

	cmpi.w	#TRUE,MOD_RELOAD
	beq.s	ReLoadActualModule



	move.b	#FALSE,MODULE_SONGTYPE


	lea.l	SoundModule_MATCH,a0
	jsr	SetFileRequestPat

	lea.l	ModuleDir_TXT,a0
	jsr	SetFileRequestPath

	lea.l	LoadMod_TXT,a0
	moveq	#PBUFID_MOD,d0
	jsr	GetPathBuf
	jsr	SimpleFileRequest
	jsr	SavePathOnlyBuf
	tst.w	d0
	beq.w	LoadActualModule_X
	jsr	SavePathBuf

	jsr	SetTempProj
	jsr	StopActualSong
	jsr	DeactivateDsp	
	jsr	RedrawSpectrum

;	move.l	FinalFileNameRT_PTR,a0
;	jsr	ClipExtension
;	lea.l	SoundModule_EXT(PC),a1
;	jsr	AddExtention

	move.l	FinalFileNameRT_PTR,a0
	move.l	ProjectName_PTR,a1
	jsr	CopyString
	move.b	#FALSE,ProjectName_PTR-4
	jsr	ShowProjectName

ReLoadActualModule
	
	jsr	DeactivateDsp
	move.b	#TRUE,SONGFILEIO

	puts	a0
	move.l	SAMPLEMANLIST_PTR,a0
	jsr	FreeAllSamples
	jsr	InitSampleManagement
	gets	a0

	move.w	#FALSE,MOD_RELOAD

.reload	move.l	FinalFileNameRT_PTR,d1
	move.l	#MODE_OLDFILE,d2

	DOS	Open(a6)
	move.l	d0,a5
	beq.w	LoadActualModule_ERR

		move.l	#LoadActualModule_HEAD,d2
		moveq	#8,d3
		move.l	a5,d1
		DOS	Read(a6)			;ModHead


		lea.l	LoadActualModule_HEAD,a0

		cmpi.l	#"XPKF",(a0)
		bne.s	.NotXPKPacked
		;--- XPK Unpack --------------
		ASSTXT	UnpackXpk_TXT
		move.l	a5,d1
		DOS	Close(a6)
		move.l	FinalFileNameRT_PTR,a0
		lea.l	UnpackedName,a1
		jsr	UnpackXPKFile
		cmpi.w	#FALSE,d0
		beq.s	.NotXPKPacked
		move.b	#TRUE,DeleteTempXPKFile
		exg	a0,a1
		jsr	CopyString
		bra	.reload


.NotXPKPacked	cmpi.l	#MODFILE_IDENT,(a0)
		bne.w	LoadActualModule_NOSYM
		tst.l	4(a0)
		beq.w	LoadActualModule_READERR
		cmpi.l	#MODFILE_VERSION,4(a0)
		bhi.w	LoadActualModule_READERR

		
			;cmpi.w	#TRUE,LOAD_NOINSTRUMENTS
			;beq.s	LoadActualModule_NOIRESET
LoadActualModule_NOIRESET
	move.b	#TRUE,SONGFILEIO

			jsr	MoveFirstInstrument

			move.w	#FALSE,MOD_RELOAD+6
			bsr	LoadModuleParts

		move.l	a5,d1
		DOS	Close(a6)


	cmpi.w	#TRUE,MOD_RELOAD
	beq.w	LoadActualModule_Xb


	cmpi.w	#TRUE,LoadHunkPart_RERROR
	beq.s	LoadActualModule_HUNKERR

	cmpi.w	#TRUE,LOAD_NOINSTRUMENTS
	beq.s	LoadActualModule_PUREMOD
	cmpi.b	#TRUE,MODULE_SONGTYPE
	bne.s	LoadActualModule_PUREMOD
		bsr	AutoLoadSamples
		move.b	#TRUE,ProjectName_PTR-4
LoadActualModule_PUREMOD
	move.b	#TRUE,SONGFILEIO

		bsr	AutoCalcLineSamples
LoadActualModule_HUNKERR
		lea.l	Test_PATTED,a0
		jsr	HideBlockRange
		jsr	PattedUpdateDisp
		jsr	PatEdCrsrOn
		jsr	RebuildSoundSystem
		jsr	UpdatePosList
		jsr	MoveFirstInstrument
		jsr	DrawInstrument
		jsr	InitPSong
		jsr	MoveFirstPosition
		jsr	DrawSongStatus

	cmpi.w	#TRUE,LoadHunkPart_RERROR
	beq.s	LoadActualModule_X
	ASSTXT	Done_TXT
	bsr	DelTempXPKFile
	move.w	#FALSE,AutoLoadMod
	cmpi.w	#TRUE,BatchProc
	bne.s	LoadActualModule_X
	move.w	#TRUE,AutoPlayMod

LoadActualModule_X	
LoadActualModule_Xb
	move.b	#FALSE,SONGFILEIO
LoadActualModule_Xc
	RET


LoadActualModule_READERR
		move.l	a5,d1
		DOS	Close(a6)
LoadActualModule_ERR
		ASSTXT ErrLoadMod
		move.w	#FALSE,BatchProc
		move.w	#FALSE,AutoLoadMod
	bra.s	LoadActualModule_X

	acode
DelTempXPKFile
	BGN
	cmpi.b	#TRUE,DeleteTempXPKFile
	bne.s	.exit
	move.l	#UnpackedName,d1
	DOS	DeleteFile(a6)

	move.b	#FALSE,DeleteTempXPKFile
.exit	RET



MKF_IDENT	EQU	$438
MKF_NUMPAT	EQU	950
MKF_SAMPLEDEF	EQU	$14

MKFSDEF_NAME	EQU	0
MKFSDEF_LOOPLEN	EQU	0
MKFSDEF_LEN	EQU	22
MKFSDEF_SIZEOF	EQU	30

MKHEAD_SIZEOF	EQU	$43c


	acode
LoadActualModule_NOSYM
	move.l	a5,d1
	DOS		Close(a6)

	move.l	FinalFileNameRT_PTR,d1
	move.l	#MODE_OLDFILE,d2
	DOS		Open(a6)
	move.l	d0,a5
	beq.w	LoadActualModule_ERR


	lea.l	ModHead_PTR(PC),a0
	jsr		GetMem
	tst.l	d0
	beq		.nomem

	move.l	ModHead_PTR,d2
	move.l	#MKHEAD_SIZEOF,d3
	move.l	a5,d1
	DOS		Read(a6)			;ModHead
	move.l	ModHead_PTR,a0
	cmpi.l	#"M.K.",$438(a0)
	bne		.noMK

	ASSTXT	PTMod_TXT	
	move.l	#2500,NGSampleBoost
	move.b	#TRUE,MKFORMAT

	bsr		MKLoadSongData
	move.b	#"A",MK_Name+9
	bsr		MKLoadSamples

	ASSTXT	Done_TXT
	lea.l	ModHead_PTR(PC),a0
	jsr		FreeMem
	move.l	a5,d1
	DOS		Close(a6)

	lea.l	Test_PATTED,a0
	jsr		HideBlockRange
	jsr		PattedUpdateDisp
	jsr		PatEdCrsrOn
	jsr		RebuildSoundSystem
	jsr		UpdatePosList
	jsr		MoveFirstPosition

	jsr		MoveFirstInstrument
	jsr		DrawInstrument

	bra		LoadActualModule_X


.noMK
	cmpi.l	#"Exte",(a0)
	bne.s	.noXM
	cmpi.l	#"nded",4(a0)
	bne.s	.noXM
	cmpi.l	#" Mod",8(a0)
	bne.s	.noXM
	cmpi.l	#"ule:",12(a0)
	bne.s	.noXM

	ASSTXT	XMFormat_TXT

.noXM

.err	
	lea.l	ModHead_PTR(PC),a0
	jsr		FreeMem
	move.l	a5,d1
	DOS		Close(a6)
	bra		LoadActualModule_ERR

.nomem
	ASSTXT	XMnomem_TXT
	move.l	a5,d1
	DOS		Close(a6)
	bra		LoadActualModule_ERR

	acode
MKBuildPosList	;V1.0 (D0W,A0L)(POSITIONS,POS_PTR)
	BGN

	jsr		MoveFirstSeq

	move.l	a0,a2
	move.l	TestSongData_PTR,a0
	moveq	#POSITION_SIZEOF,d6
	subq.w	#1,d0
	bmi.s	.exit

	lea.l	Test_SONG,a3
	move.l	SONG_ACTUALSEQ(a3),a4
	move.w	#0,SEQUENCE_LENGTH(a4)

	moveq	#0,d2
.loop
	addq.w	#1,SEQUENCE_LENGTH(a4)
	move.b	(a2)+,d2
	bsr		.MKInitSongData
	lea.l	(a0,d6.w),a0
	dbf		d0,.loop
.exit	RET

.MKInitSongData	;V1.0
		;I(A0L)(SONGDATA)
	BGN
	move.w	#1,POSITION_LOOPNUMB(a0)
	clr.w	POSITION_LOOPCOUNT(a0)
	move.w	d2,POSITION_PATNUM(a0)
	clr.w	POSITION_STARTPOINT(a0)

	move.w	#4,POSITION_SPEED(a0)

	move.l	VEX_LinesPerPattern,d1
	cmpi.l	#64,d1
	bls.s	.setlen
	moveq	#64,d1
	cmpi.l	#128,VEX_LinesPerPattern
	bne.s	.setlen
	move.w	#128,d1
	move.w	#2,POSITION_SPEED(a0)
.setlen
	move.w	d1,POSITION_LEN(a0)

	jsr	SetPatHeadPTR
	RET


	acode
MKLoadSongData
	BGN

	lea.l	$3b6(a0),a0

	ASSTXT	MKNUMBPOS_TXT
	moveq	#0,d0
	move.b	(a0),d0
	jsr	WriteAssDecLong

	lea.l	2(a0),a0		;count patterns
	moveq	#0,d1

	bsr	MKBuildPosList


.count
	move.b	(a0)+,d2
	cmp.b	d2,d1
	bhi.s	.skip
	move.b	d2,d1
.skip
	dbf	d0,.count

	moveq	#0,d0
	move.b	d1,d0
	addq.w	#1,d0
	move.l	d0,d7
	ASSTXT	MKNOPAT_TXT
	jsr	WriteAssDecLong

	mulu	#1024,d0

	lea.l	ModSong_PTR(PC),a0
	move.l	d0,MEM_SIZE(a0)
	jsr	GetMem
	tst.l	d0
	beq.s	.exit

	move.l	a5,d1
	move.l	ModSong_PTR,d2
	move.l	ModSong_PTR+MEM_SIZE(PC),d3
	DOS	Read(a6)
	tst.l	d0
	beq.w	.readerr
	bmi.w	.readerr

	move.l	ModSong_PTR,a0
	bsr	MKConvertSongData

.readerr
	lea.l	ModSong_PTR(PC),a0
	jsr	FreeMem

.exit	RET


	acode
MKConvertSongData	;I(A0L,D7L)(SONG,NUMBOFPATTERNS)
	BGN
	move.l	NoteMem_PTR,a1

	moveq	#0,d4
	move.w	CHANNEL_NUMB,d4
	subq.w	#8,d4
	mulu	#4,d4
	subq.w	#1,d7

	move.w	CHANNEL_NUMB,d3
	mulu	#4,d3

.looppatterns
	moveq	#64-1,d5

.looplines
	moveq	#4-1,d6

.loop
	move.l	(a0)+,d0
	;IFNE TESTPRGB
	;jsr PrintHexLong
	;ENDC
	bsr	MKConvertEvent
	;IFNE TESTPRGB
	;jsr PrintHexLong
	;ENDC

	cmpi.l	#128,VEX_LinesPerPattern
	bne.s	.no128b

	move.l	d1,(a1,d3.w)
	move.l	d1,4(a1,d3.w)

.no128b
	move.l	d0,(a1)+
	move.l	d0,(a1)+
	dbf	d6,.loop

	lea.l	(a1,d4.w),a1
	cmpi.l	#128,VEX_LinesPerPattern
	bne.s	.no128

	lea.l	(a1,d3.w),a1

.no128
	dbf	d5,.looplines
	dbf	d7,.looppatterns
	RET

	acode
MKConvertEvent
	puts	d2-d7/a0-a6
	tst.l	d0
	beq		.empty
	move.w	d0,d1
	move.w	d0,d6
	andi.w	#$fff,d6		;D6 = 2nd FX
	move.l	d0,d2
	andi.l	#$f000f000,d2
	move.l	d2,d3
	lsr.w	#8,d2
	lsr.w	#4,d2

	rol.l	#8,d3
	add.b	d3,d2
	andi.l	#$3f,d2			;sample
	subq.b	#1,d2

	;tst.w	d2
	;beq.s	.empty

	swap	d0
	andi.l	#%111111111111,d0
	andi.l	#%111111111111,d1	;fx
	move.l	d0,d3			;d3 period

	moveq	#0,d0
	cmpi.w	#856,d3
	bhi.s	.nopitch
	cmpi.w	#113,d3
	blo.s	.nopitch
	bsr		MKGetpitch
	bra.s	.fx

.nopitch	move.l	#NOTE_FULLEMPTY,d0

.fx	move.w	#100*256,d0

	move.w	d1,d7			;fx conversion
	lsr.w	#8,d7
	cmpi.b	#$c,d7
	bne.s	.nofx

	andi.w	#$ff,d1
	mulu	#100,d1
	divu	#64,d1

	cmpi.w	#100,d1
	bhi.s	.exit
	tst.w	d1
	bne.s	.vok
	moveq	#1,d1

.vok	lsl.w	#8,d1
	move.w	d1,d0

.nofx
	move.b	d2,d0			;set instrument
	cmpi.b	#-1,d2
	beq.s	.empty			;is 255 instrumentNr

.exit
	bsr	MKConvert2ndFX
	gets	d2-d7/a0-a6
	rts

.empty
	move.l	#NOTE_FULLEMPTY,d0
	bra.s	.exit

MKConvert2ndFX
	;I(D6W)($0xxx)
	;O(D1L)(2nd FX)
	puts	d0
	move.l	#NOTE_FULLEMPTY,d1
	bsr		MKCPitchSlideD
	bsr		MKCPitchSlideU
	bsr		MKCVSlideD
	bsr		MKCVSlideU
.exit	
	gets	d0
	rts

MKCVSlideU
	cmpi.w	#$A10,d6
	blo.s	.exit
	cmpi.w	#$A1f,d6
	bhi.s	.exit
	move.l	#FX_VOLUMESLIDEUP*$1000000,d1
.exit	rts

MKCVSlideD
	cmpi.w	#$A00,d6
	blo.s	.exit
	cmpi.w	#$A0f,d6
	bhi.s	.exit
	move.l	#FX_VOLUMESLIDEDOWN*$1000000,d1
.exit	rts

MKCPitchSlideD
	cmpi.w	#$200,d6
	blo.s	.exit
	cmpi.w	#$2ff,d6
	bhi.s	.exit
	move.l	#FX_PITCHSLIDEUP*$1000000,d1
.exit	rts

MKCPitchSlideU
	cmpi.w	#$100,d6
	blo.s	.exit
	cmpi.w	#$1ff,d6
	bhi.s	.exit
	move.l	#FX_PITCHSLIDEDOWN*$1000000,d1
.exit	rts

	acode
MKGetpitch
	puts	a0/d4
	lea.l	MKperiodconv,a0
	move.l	#$010000,d0
.loop
	move.w	(a0)+,d4
	cmpi.w	#-1,d4
	beq.s	.exit
	cmp.w	d4,d3
	bhs.s	.exit
	addi.l	#$010000,d0
	bra.s	.loop
.exit
	subi.l	#$040000,d0
	bpl.s	.ok

	move.l	#$010000,d0
.ok
	andi.l	#$ff0000,d0
	gets	a0/d4
	rts

	acode
MKLoadSamples
	jsr		MoveFirstInstrument
	ASSTXT	MK_AnalyzeSample

	move.l	a0,a4
	lea.l	MKF_SAMPLEDEF(a4),a3
	moveq	#31-1,d7

.loop
	moveq	#0,d0
	move.w	MKFSDEF_LEN(a3),d0
	tst.l	d0
	bne.s	.load
	jsr		DoKillActualInstr
	jsr		MoveNextInstrument
	bra.s	.next

.load
	lsl.l	#1,d0
	IFNE	TESTPRGB
	jsr	WriteAssDecLong
	ENDC
	jsr	MKLoadSample
.next
	lea.l	MKFSDEF_SIZEOF(a3),a3
	dbf	d7,.loop

	rts

	acode
MKLoadSample
	BGN
	lea.l	SampleTemp_PTR(PC),a4
	clr.l	(a4)
	move.l	d0,MEM_SIZE(a4)

	move.l	a4,a0
	jsr		GetMem
	move.l	(a4),d2
	beq.w	.nomem

	move.l	a5,d1
	move.l	MEM_SIZE(a4),d3
	DOS		Read(a6)
	tst.l	d0
	beq.w	.readerr
	bmi.w	.readerr

	bsr		MKExctractSamples

	move.l	(a4),d2
	jsr		DoKillActualInstr
	bsr		MKMakeName
	jsr		NewLoadHunkBuildSample
	jsr		DrawInstrument
	jsr		MoveNextInstrument

	move.l	#$00010007,MEM_DEBUG_INFO
	move.l	#$00000000,MEM_DEBUG_INFO+4

	lea.l	SampleTemp_PTR(PC),a0
	jsr		FreeMem

.exit	RET
.readerr
.nomem
	bra.s	.exit

	acode
MKExctractSamples
	BGN
	move.l	#MK_Name,d1
	move.l	#MODE_NEWFILE,d2
	DOS		Open(a6)
	move.l	d0,a5
	beq		.openerr

	moveq	#0,d0
	move.l	a5,d1
	move.l	SampleTemp_PTR,d2
	move.l	SampleTemp_PTR+4,d3
	DOS		Write(a6)

	move.l	a5,d1
	DOS		Close(a6)
.openerr RET

	acode
LoadModuleReadLong
		;O(D0L,D1L)(NUMB[read],LONG)
	movem.l	d2-a6,-(a7)
	lea.l	LoadActualModule_TEMP(PC),a4
	move.l	a4,d2
	moveq	#4,d3
	move.l	a5,d1
	DOS		Read(a6)
	move.l	(a4),d1
	movem.l	(a7)+,d2-a6
	rts
LoadActualModule_TEMP	dc.l	0

	acode
LoadModuleParts
		;I(A5L)(FILEHANDLE)
		;
	BGN
	move.w	#FALSE,LoadHunkPart_RERROR
	move.b	#FALSE,RELOADGO_FLAG
	clr.l	NGSampleBoost

	lea.l	LoadModuleParts_JL(PC),a4


.loop
	bsr	LoadModuleReadLong
	tst.l	d1
	beq.s	.exit
	tst.l	d0
	beq.s	.exit
	bmi.s	.exit

	move.l	a4,a3

.loop2
	jsr	HandleAllMsgs
	move.l	(a3)+,d2
	tst.l	d2
	beq.s	.unknownhunk
	move.l	(a3)+,a0
	cmp.l	d1,d2
	bne.s	.loop2

	jsr	(a0)
	cmpi.b	#TRUE,RELOADGO_FLAG
	beq.s	.exit
	cmpi.w	#TRUE,LoadHunkPart_RERROR
	bne.s	.loop
	bra.s	.exit

.unknownhunk
	ASSTXT	LoadModskip_TXT
	tst.l	d1
	beq.s	.exit
	tst.l	d1
	bmi.s	.SkipHunk
	jsr		LoadModuleReadLong
	bra.s	.loop
.SkipHunk
	bsr		LoadModuleReadLong
	tst.l	d0
	beq.w	.error
	bmi.w	.error
	move.l	d1,d2
	move.l	a5,d1
	jsr		DOSSkip
	cmpi.l	#-1,d0
	beq.w	.error
	bra.s	.loop

.exit
	IFNE	TESTREQHANDLE
	jsr		EndInfoRequest
	ENDC
	RET
.error	
	ASSTXT ErrLoadHunk
	jsr		WarnFlash
	move.w	#TRUE,LoadHunkPart_RERROR
	RET

	acode
LoadSkipLong	
	BGN
	bsr		LoadModuleReadLong
	RET

	acode
LoadModuleParts_JL
	dc.l	MODHEADTYPE_NGSAMPLEBOOST,LoadNGSampleBoost
	dc.l	MODHEADTYPE_PITCHDIFF,LoadSkipLong  
	dc.l	MODHEADTYPE_SAMPLEDIFF,LoadSkipLong

	dc.l	MODHEADTYPE_CHANNELNUMB,LoadHCHANNELN
	dc.l	MODHEADTYPE_TRACKLEN,LoadHunkTRACKLEN
	dc.l	MODHEADTYPE_PATTERNNUMB,LoadHunkPATTERNNUMB
	dc.l	MODHEADTYPE_SAMPLENUMB,LoadHunkSAMPLENUMB
	dc.l	MODHEADTYPE_NOTESIZE,LoadHunkNOTESIZE
	dc.l	MODHEADTYPE_SYSTEMSPEED,LoadHunkSYSTEMSPEED

	dc.l	MODHEADTYPE_SONGDATA,LoadHunkSONGDATA
	dc.l	MODHEADTYPE_DELTASAMPLE,LoadHunkDeltaSAMPLE
	dc.l	MODHEADTYPE_DELTA16,LoadHunkDelta16
	dc.l	MODHEADTYPE_SAMPLE,LoadHunkSAMPLE
	dc.l	MODHEADTYPE_EMPTYSAMPLE,LoadHunkEMPTYSAMPLE
	dc.l	MODHEADTYPE_NOTEDATA,LoadHunkNOTEDATA
	dc.l	MODHEADTYPE_SAMPLENAMES,LoadHunkSAMPLENAMES
	dc.l	MODHEADTYPE_SEQUENCE,LoadHunkSEQUENCE
	dc.l	MODHEADTYPE_INFOTEXT,LoadHunkINFOTEXT
	;dc.l	MODHEADTYPE_INFOTYPE,LoadHunkSetInfoObj
	dc.l	MODHEADTYPE_INFOOBJ,LoadHunkINFOTEXT2
	dc.l	MODHEADTYPE_ISSONG,LoadHunkLoadSongSamples
	dc.l	0,0

LoadModuleInfo	blk.l	10,0	;obsolete ??

RELOADGO_FLAG	dc.b	FALSE
	even

LoadHunkSAMPLE_DELTA	dc.w	FALSE,FALSE

	acode
LoadHunkReloadGo
	move.b	#TRUE,RELOADGO_FLAG
	rts

	acode
LoadHunkDelta16	;V1.0
	cmpi.w	#TRUE,MOD_RELOAD
	beq.s	LoadHunkReloadGo
	BGN
	move.w	#TRUE,LoadHunkSAMPLE_DELTA+2
	move.w	#FALSE,LoadHunkSAMPLE_DELTA
	bra.s	LoadHunkSAMPLE_IN

LoadHunkDeltaSAMPLE	;V1.0
	cmpi.w	#TRUE,MOD_RELOAD
	beq.s	LoadHunkReloadGo
	BGN
	move.w	#TRUE,LoadHunkSAMPLE_DELTA
	move.w	#FALSE,LoadHunkSAMPLE_DELTA+2
	bra.s	LoadHunkSAMPLE_IN

	acode
LoadHunkSAMPLE		;V1.1
	cmpi.w	#TRUE,MOD_RELOAD
	beq.s	LoadHunkReloadGo
	BGN
	move.w	#FALSE,LoadHunkSAMPLE_DELTA
	move.w	#FALSE,LoadHunkSAMPLE_DELTA+2

LoadHunkSAMPLE_IN
	bsr		LoadModuleReadLong
	tst.l	d0
	beq.w	LoadHunkPartERR
	bmi.w	LoadHunkPartERR
	lea.l	SampleTemp_PTR(PC),a4

	clr.l	(a4)
	move.l	d1,MEM_SIZE(a4)
	beq		LoadHunkSAMPLE_X

	move.l	a4,a0
	jsr		GetMem
	move.l	(a4),d2
	beq.w	LoadHunkPartERR			;Low Mem Error

	move.l	a5,d1
	move.l	MEM_SIZE(a4),d3
	DOS		Read(a6)
	tst.l	d0
	beq.w	LoadHunkSAMPLE_ERR
	bmi.w	LoadHunkSAMPLE_ERR

	cmpi.w	#TRUE,LoadHunkSAMPLE_DELTA+2
	bne.s	LoadHunkSAMPLE_Pak2

	move.l	(a4),d2
	beq.s	LoadHunkSAMPLE_Unpacked
	move.l	MEM_SIZE(a4),d3
	beq.s	LoadHunkSAMPLE_Unpacked

	bsr		Delta16UnPackBlk

	bra.s	LoadHunkSAMPLE_Unpacked

LoadHunkSAMPLE_Pak2
	cmpi.w	#TRUE,LoadHunkSAMPLE_DELTA
	bne.s	LoadHunkSAMPLE_Unpacked

	move.l	(a4),d2
	beq.s	LoadHunkSAMPLE_Unpacked
	move.l	MEM_SIZE(a4),d3
	beq.s	LoadHunkSAMPLE_Unpacked

	bsr		DeltaUnPackModuleBlock

LoadHunkSAMPLE_Unpacked
	bsr		NewLoadHunkBuildSample
	jsr		DrawInstrument
	bsr		MoveNextMonoInstrument

	move.l	a4,a0
	tst.l	(a0)
	beq.s	LoadHunkSAMPLE_X
	move.l	#$00010007,MEM_DEBUG_INFO
	move.l	#$00000000,MEM_DEBUG_INFO+4
	jsr		FreeMem

LoadHunkSAMPLE_X	RET
SampleTemp_PTR	dc.l	0,0,PUPMEM

LoadHunkSAMPLE_ERR
	move.l	a4,a0
	move.l	#$00010007,MEM_DEBUG_INFO
	move.l	#$00000001,MEM_DEBUG_INFO+4
	jsr		FreeMem
	bra		LoadHunkPartERR

	acode
MoveNextMonoInstrument
	BGN
	jsr		MoveNextInstrument
	jsr		GetActualInstrName
	cmpi.b	#MULTISAMPLE_STEREOR,SAMPLENAME_MULTI(a0)
	bne.s	MoveNextMonoInstrument_X

	jsr	MoveNextInstrument

MoveNextMonoInstrument_X
	RET

LoadHunkEMPTYSAMPLE	
	cmpi.w	#TRUE,MOD_RELOAD
	beq.w	LoadHunkReloadGo
	bsr		MoveNextInstrument
	rts

LoadHCHANNELN	BGN
	lea.l	MOD_RELOAD+4(PC),a4
	bsr		LoadModuleReadLong
	move.l	d1,LoadModuleInfo

	cmpi.w	#TRUE,(a4)
	bne.s	LoadHCHANNELN_N

	move.w	CHANNEL_NUMB,4(a4)
	move.w	d1,6(a4)
	cmp.w	CHANNEL_NUMB,d1
	beq.s	LoadHCHANNELN_X
	move.w	#TRUE,2(a4)
	bra.s	LoadHCHANNELN_X

LoadHCHANNELN_N
	cmp.w	CHANNEL_NUMB,d1
	bne.s	LoadHunkPart_SetReload
LoadHCHANNELN_X	RET

MOD_RELOAD	dc.w	FALSE,0		;+0
	dc.w	FALSE,FALSE	;+4 0SONGCONVERTER STATUS, 2DO CONVERT ?
	dc.w	0,0,0,0		;+8 (4CHANNELS,6MODCHANNELS,8PATLEN,10MODPATLEN)
	dc.w	0		;+16 MODPATT#

ToogleSongConv
	eori.w	#-1,MOD_RELOAD+4
	rts


LoadHunkLoadSongSamples
	BGN
	bsr	LoadModuleReadLong
	RET

LoadHunkPart_SetReload
	move.w	#TRUE,MOD_RELOAD
	move.w	d1,MOD_RELOAD+2

	cmpi.w	#4,d1
	bne.s	HunkSetChan0
	;jsr	SetFourVoices
	bra.s	HunkSetChan6
	RET

HunkSetChan0
	cmpi.w	#8,d1
	bne.s	HunkSetChan1
	jsr		SetEightVoices
	RET

HunkSetChan1
	cmpi.w	#16,d1
	bne.s	HunkSetChan2
	jsr		SetSixteenVoices
	RET

HunkSetChan2
	cmpi.w	#32,d1
	bne.s	HunkSetChan3
	jsr		SetThirtytwoVoices
	RET

HunkSetChan3
	IFEQ	AMINETDEMO
	cmpi.w	#64,d1
	bne.s	HunkSetChan4
	jsr		SetSixtyFourVoices
	RET
	ENDC

HunkSetChan4
	IFEQ	AMINETDEMO
	cmpi.w	#128,d1
	bne.s	HunkSetChan5
	jsr		Set128Voices
	RET
	ENDC

HunkSetChan5
	IFEQ	AMINETDEMO
	cmpi.w	#256,d1
	bne.s	HunkSetChan6
	jsr		Set256Voices
	RET
	ENDC
	
HunkSetChan6
	move.w	#TRUE,LoadHunkPart_RERROR
	move.w	#FALSE,MOD_RELOAD
	bra		LoadHunkPartERR


LoadHunkTRACKLEN
	BGN
	lea.l	MOD_RELOAD+4(PC),a4
	bsr		LoadModuleReadLong
	move.l	d1,LoadModuleInfo+4

	move.l	VEX_LinesPerPattern,d2

	cmpi.w	#TRUE,(a4)
	bne.s	LoadHunkTRACKLEN_N

	move.w	d2,8(a4)
	move.w	d1,10(a4)
	cmp.w	d2,d1
	beq.s	LoadHunkTRACKLEN_X
	move.w	#TRUE,2(a4)
	bra.s	LoadHunkTRACKLEN_X

LoadHunkTRACKLEN_N
	cmp.w	d2,d1
	beq.s	LoadHunkTRACKLEN_X
	move.l	d1,VEX_LinesPerPattern

	move.w	#TRUE,MOD_RELOAD
	move.w	#TRUE,MAINEXIT_FLAG
LoadHunkTRACKLEN_X
	RET



LoadHunkSAMPLENUMB	;V1.2 NEW: SAMLEBOOST INTO MOD
	BGN

	bsr		LoadModuleReadLong
	move.l	d1,d2

	andi.l	#$ffff,d1
	move.l	d1,LoadModuleInfo+12

	swap	d2
	andi.l	#$ff,d2
	;--- DEFAULT NG SAMPLEBOOST ---
	move.l	#NGSAMPLEBOOST_DEFAULT,d7	;= 33%
	move.w	VEX_Setup,d6
	lsr.w	d6,d7
	move.l	d7,NGSampleBoost


	tst.b	d2
	beq.s	.nosampleboost

	;--- OLD SAMPLEBOOST ---
	;move.l	d2,SAMPLEBOOST_BAK
	mulu	#10000,d2
	divu	#200,d2
	move.w	VEX_Setup,d3
	lsr.w	d3,d2
	move.l	d2,NGSampleBoost

	;jsr	UpdateSampleBoost	;OBSOLETE
	ASSTXT	Sampleboost_TXT

.nosampleboost
	RET

	acode
LoadNGSampleBoost	;NG SAMPLEBOOST
	BGN
	bsr	LoadModuleReadLong
	move.l	d1,NGSampleBoost
	ASSTXT	NGtxt
	RET

	acode
LoadHunkPATTERNNUMB	BGN
	bsr		LoadModuleReadLong
	move.l	d1,LoadModuleInfo+8
	move.l	d1,d2
	swap	d2
	andi.l	#$ffff,d1	;POSITION NUMBER
	andi.l	#$ffff,d2	;PATTERN NUMBER	[0=64]

	tst.l	d2
	bne.s	LoadHunk_PatDef
	moveq	#64,d2	;SET IF OLD MOD FORMAT

LoadHunk_PatDef
	move.w	d2,MOD_RELOAD+12+4
	bsr	LoadHunkPATTERNNUMBSet
	RET

ToogleKeepPatternMumb
	eori.w	#-1,KeepPatternMumb
	rts

KeepPatternMumb	dc.w	FALSE

LoadHunkPATTERNNUMBSet
	BGN
	IFNE AMINETDEMO
	move.w	#FALSE,KeepPatternMumb
	ENDC
	cmpi.w	#TRUE,KeepPatternMumb
	bne.s	LoadHunkPNS_M1
	cmp.l	VEX_PattNumb,d2
	bls.s	LoadHunkPATTERNNUMB_OK
LoadHunkPNS_M1
	cmp.l	VEX_PattNumb,d2
	beq.s	LoadHunkPATTERNNUMB_OK
	move.l	d2,VEX_PattNumb
	move.w	#TRUE,MOD_RELOAD
	move.w	#TRUE,MAINEXIT_FLAG
LoadHunkPATTERNNUMB_OK	RET

	acode
LoadHunkNOTESIZE	BGN
	bsr		LoadModuleReadLong
	move.l	d1,LoadModuleInfo+16
	RET

LoadHunkSYSTEMSPEED	BGN
	bsr		LoadModuleReadLong
	move.l	d1,LoadModuleInfo+20
	move.l	d1,VexSpeed
	RET

LoadHunkSONGDATA	
	cmpi.w	#TRUE,MOD_RELOAD
	beq.w	LoadHunkReloadGo
	BGN
	bsr		LoadModuleReadLong
	tst.l	d0
	beq.w	LoadHunkPartERR
	bmi.w	LoadHunkPartERR

	move.l	d1,d3
	move.l	a5,d1
	move.l	TestSongData_PTR,d2

;	DOS	Read(a6)
	bsr		ReadUnpack

	bsr		UpdatePatHeadPtrs	;;; is ??? necessary ???:YES

	RET


LoadHunkSEQUENCE	
	cmpi.w	#TRUE,MOD_RELOAD
	beq.w	LoadHunkReloadGo
	BGN
	bsr		LoadModuleReadLong
	tst.l	d0
	beq.w	LoadHunkPartERR
	bmi.w	LoadHunkPartERR
	move.l	d1,d3
	move.l	a5,d1
	move.l	SequenceMem_PTR,d2
;	DOS	Read(a6)
	bsr		ReadUnpack
	RET

LoadHunkINFOTEXT	
	cmpi.w	#TRUE,MOD_RELOAD
	beq.w	LoadHunkReloadGo
	BGN
	bsr		LoadModuleReadLong
	tst.l	d0
	beq.w	LoadHunkPartERR
	bmi.w	LoadHunkPartERR
	lea.l	ModuleDiz_PTR(PC),a0
	move.l	d1,4(a0)
	addq.l	#4,4(a0)
	jsr		GetMem
	tst.l	(a0)
	beq.w	LoadHunkPartERR
	move.l	(a0),d2
	move.l	d1,d3
	move.l	a5,d1
	DOS		Read(a6)
	RET



LoadHunkINFOTEXT2
	cmpi.w	#TRUE,MOD_RELOAD
	beq.w	LoadHunkReloadGo
	BGN
	bsr		LoadModuleReadLong
	tst.l	d0
	beq.w	LoadHunkPartERR
	bmi.w	LoadHunkPartERR
	lea.l	ModuleDiz2_PTR(PC),a0
	move.l	d1,4(a0)
	addq.l	#4,4(a0)
	jsr		GetMem
	tst.l	(a0)
	beq.w	LoadHunkPartERR
	move.l	(a0),d2
	move.l	d1,d3
	move.l	a5,d1
	DOS		Read(a6)
	RET

LoadHunkSetInfoObj
	BGN
	RET

LoadHunkNOTEDATA	
	cmpi.w	#TRUE,MOD_RELOAD
	beq.w	LoadHunkReloadGo
	BGN
	bsr		LoadModuleReadLong
	tst.l	d0
	beq.w	LoadHunkPartERR
	bmi.w	LoadHunkPartERR


	move.l	d1,d3
	beq.w	LoadHunkPartERR

	cmpi.w	#TRUE,MOD_RELOAD+6
	beq.s	LoadHunkConvNoteData

	move.l	a5,d1
	move.l	NoteMem_PTR,d2

	bsr		ReadUnpack
;	DOS		Read(a6)
	RET



LoadHunkConvNoteData
	move.l	d1,d3
	beq.w	ConvNoteData_ERR

	moveq	#0,d0
	move.w	MOD_RELOAD+10,d0
	mulu	MOD_RELOAD+14,d0
	moveq	#NOTE_SIZEOF,d1
	mulu	MOD_RELOAD+16,d1
	mulu.l	d0,d1


	lea.l	NoteConvMem(PC),a0
	clr.l	MEM_PTR(a0)
	move.l	d1,MEM_SIZE(a0)
	jsr		GetMem
	tst.l	d0
	beq.w	LoadHunkPartERR		;NO MEM


	move.l	a5,d1
	move.l	(a0),d2
;	DOS		Read(a6)
	jsr		ReadUnpack

	lea.l	MOD_RELOAD+4(PC),a2
	move.l	NoteConvMem(PC),a0
	move.l	NoteMem_PTR,a1
	moveq	#NOTE_SIZEOF,d0


	move.w	4(a2),d1
	sub.w	6(a2),d1
	bmi.s	ConvNoteData_ERR
	mulu	d0,d1		;d1: LINEOFFSET SRC

	move.l	VEX_LineSize,d3
	move.w	8(a2),d2
	sub.w	10(a2),d2
	bmi.s	ConvNoteData_ERR
	mulu	d3,d2


	move.w	12(a2),d5
	subq.w	#1,d5
	bmi.s	ConvNoteData_ERR
ConvNoteData_L3

	move.w	10(a2),d6
	subq.w	#1,d6
	bmi.s	ConvNoteData_ERR
ConvNoteData_L2

		move.w	6(a2),d7
		subq.w	#1,d7
		bmi.s	ConvNoteData_ERR
ConvNoteData_L1
			jsr	CopyNote
			lea.l	(a0,d0.w),a0
			lea.l	(a1,d0.w),a1
		dbf	d7,ConvNoteData_L1
		lea.l	(a1,d1.w),a1
	dbf	d6,ConvNoteData_L2
	lea.l	(a1,d2.w),a1
	dbf	d5,ConvNoteData_L3

	lea.l	NoteConvMem(PC),a0
		move.l	#$00010009,MEM_DEBUG_INFO
		move.l	#$00000000,MEM_DEBUG_INFO+4
	jsr	FreeMem

	RET	
ConvNoteData_ERR
		lea.l	NoteConvMem(PC),a0
		move.l	#$00010009,MEM_DEBUG_INFO
		move.l	#$00000001,MEM_DEBUG_INFO+4
		jsr	FreeMem
	bra	LoadHunkPartERR

NoteConvMem	dc.l	0,0,PUPMEM

LoadHunkSAMPLENAMES	
	cmpi.w	#TRUE,MOD_RELOAD
	beq.w	LoadHunkReloadGo
	BGN
	bsr	LoadModuleReadLong
	tst.l	d0
	beq.s	LoadHunkPartERR
	bmi.s	LoadHunkPartERR

	move.l	d1,d3
	beq.s	LoadHunkPartERR
	move.l	a5,d1
	move.l	SampleNames_PTR,d2

;	DOS	Read(a6)
	bsr	ReadUnpack

	RET

LoadHunkPartERR
	ASSTXT ErrLoadHunk
	jsr	WarnFlash
	move.w	#TRUE,LoadHunkPart_RERROR
	RET
LoadHunkPart_RERROR	dc.w	FALSE




NewLoadHunkBuildSample	;I(A4L)(TEMPSAMPLEMEM_PTR)
	BGN
	jsr	GetActualInstrName
	cmpi.b	#MULTISAMPLE_STEREOR,SAMPLENAME_MULTI(a0)
	beq.w	NewLoadHunkBuildSample_X

	lea.l	LoadTempSample_MEM,a2
	move.l	(a4),(a2)
	move.l	4(a4),4(a2)
	move.l	8(a4),8(a2)

	lea.l	NewLoadSample_INFO,a5
	jsr	NewLoadSampleHunk

	move.l	(a2),(a4)
	clr.l	(a2)

NewLoadHunkBuildSample_X	RET

FreeModuleDiz2
	BGN
	lea.l	ModuleDiz2_PTR(PC),a0
	tst.l	MEM_PTR(a0)
	beq.s	.exit
		move.l	#$00010008,MEM_DEBUG_INFO
		move.l	#$00000002,MEM_DEBUG_INFO+4
	jsr	FreeMem
	clr.l	MEM_PTR(a0)
	clr.l	MEM_SIZE(a0)
.exit	RET

FreeModuleDiz
	BGN
	lea.l	ModuleDiz_PTR(PC),a0		;enforcer hit fixed
	tst.l	MEM_PTR(a0)
	beq.s	.exit
		move.l	#$00010008,MEM_DEBUG_INFO
		move.l	#$00000001,MEM_DEBUG_INFO+4
	jsr	FreeMem
	clr.l	MEM_PTR(a0)
	clr.l	MEM_SIZE(a0)
.exit	RET

SelectModuleDiz:
	IFNE	DEMO
	rts
	ELSE
	BGN
	bsr	FreeModuleDiz

	lea.l	All_MATCH,a0
	jsr	SetFileRequestPat
	lea.l	SelectModuleDiz_TXT,a0
	jsr	SimpleFileRequest
	tst.w	d0
	beq	.exit2

	move.l	FinalFileNameRT_PTR,a0
	jsr	FileLength
	tst.l	d0
	beq.s	.exit

	lea.l	ModuleDiz_PTR(PC),a0
	move.l	d0,4(a0)
	addq.l	#4,4(a0)
	jsr	GetMem
	tst.l	(a0)
	beq.s	.exit

	move.l	FinalFileNameRT_PTR,d1
	move.l	#MODE_OLDFILE,d2
	DOS	Open(a6)
	tst.l	d0
	beq.s	.ERRX
	move.l	d0,a5

	move.l	ModuleDiz_PTR,d2
	move.l	ModuleDiz_PTR+4,d3
	move.l	a5,d1
	DOS	Read(a6)
	tst.l	d0
	bmi.s	.ERRX2
	move.l	a5,d1
	DOS	Close(a6)
	bsr	ShowSongInfo
.exit	RET
.ERRX2	move.l	a5,d1
	DOS	Close(a6)
.ERRX	bsr	FreeModuleDiz
	jsr	WarnFlash
	bra.s	.exit
.exit2	ASSTXT	DizCleared_TXT
	bra.s	.exit
	ENDC

	acode
ShowSongInfoAll
	jsr	ShowSongInfo
	jsr	ShowSongInfo2
	rts

	acode
ShowSongInfo
	BGN
	move.l	ModuleDiz_PTR,a0
	jsr	InfoRequest
	RET

SelectModuleDiz2:
	IFNE	DEMO
	rts
	ELSE
	BGN
	bsr	FreeModuleDiz2

	lea.l	All_MATCH,a0
	jsr	SetFileRequestPat
	lea.l	SelectModuleDiz2_TXT,a0
	jsr	SimpleFileRequest
	tst.w	d0
	beq	SelectModuleDiz2_X2

	move.l	FinalFileNameRT_PTR,a0
	jsr	FileLength
	tst.l	d0
	beq.s	SelectModuleDiz2_X

	lea.l	ModuleDiz2_PTR(PC),a0
	move.l	d0,4(a0)
	addq.l	#4,4(a0)
	jsr	GetMem
	tst.l	(a0)
	beq.s	SelectModuleDiz2_X

	move.l	FinalFileNameRT_PTR,d1
	move.l	#MODE_OLDFILE,d2
	DOS	Open(a6)
	tst.l	d0
	beq.s	SelectModuleDiz2_ERRX
	move.l	d0,a5

	move.l	ModuleDiz2_PTR,d2
	move.l	ModuleDiz2_PTR+4,d3
	move.l	a5,d1
	DOS	Read(a6)
	tst.l	d0
	bmi.s	SelectModuleDiz2_ERRX2
	move.l	a5,d1
	DOS	Close(a6)
	bsr	ShowSongInfo2
SelectModuleDiz2_X	RET

SelectModuleDiz2_ERRX2
	move.l	a5,d1
	DOS	Close(a6)
SelectModuleDiz2_ERRX
	bsr	FreeModuleDiz2
	jsr	WarnFlash
	bra.s	SelectModuleDiz2_X
SelectModuleDiz2_X2
	ASSTXT	DizCleared_TXT
	bra.s	SelectModuleDiz2_X
	ENDC



ShowSongInfo2:	;v2.0	mit Multiview !!!
	BGN
	tst.l	ModuleDiz2_PTR
	beq.s	.exit
	tst.l	ModuleDiz2_PTR+4
	beq.s	.exit

	move.l	#TempDizName,d1
	move.l	#MODE_NEWFILE,d0	
	jsr	EasyDOpen
	tst.l	d0
	beq.s	.useold

	move.l	ModuleDiz2_PTR,a0
	move.l	ModuleDiz2_PTR+4,d0
	jsr	EasyDWrite
	tst.l	d0
	beq.s	.useold

	jsr	EasyDClose
	jsr	ShowInfoExtern
.exit	RET
.useold	;--- Open Failed, use old InfoRequest ---
	move.l	ModuleDiz2_PTR,a0
	jsr	InfoRequest
	bra.s	.exit
;Command_TXT	dc.b	"c:Multiview WINDOW PUBSCREEN=SymphonieEditor "
;TempDizName	dc.b	"t:testdiz",0
;	even

InfoObjType	dc.w	1,0		;1,0 =pic
		dc.l	0
		dc.l	0
		dc.l	0

Command_TAGS	dc.l	TAG_DONE

	acode
ShowInfoExtern:
	BGN
	tst.l	InfoObjType
	beq.s	.nrm

	cmpi.l	#$10000,InfoObjType
	beq.s	.pic

.nrm	ASSTXT	Command_TXT
	move.l	#Command_TXT,d1
	move.l	#Command_TAGS,d2
	DOS	SystemTagList(a6)
.exit	RET

.pic	ASSTXT	CommandPic_TXT
	move.l	#CommandPic_TXT,d1
	move.l	#Command_TAGS,d2
	DOS	SystemTagList(a6)
	bra.s	.exit





;--- EXTRACT SAMPLES ----------------------------------------------

	acode
ExtractActual8Bit:
	IFEQ AMINETDEMO
	move.b	#TRUE,Ex8Bit	
	bsr	ExtractActualModule
	move.b	#FALSE,Ex8Bit	
	rts
	ENDC

	acode
ExtractActualModule:
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	SoundModule_MATCH,a0
	jsr	SetFileRequestPat

	lea.l	ModuleDir_TXT,a0
	jsr	SetFileRequestPath

	lea.l	ExtractMod_TXT,a0
	moveq	#PBUFID_MOD,d0
	jsr	GetPathBuf
	jsr	SimpleFileRequest
	jsr	SavePathBuf
	tst.w	d0
	beq.w	ExtractActualModule_X

	ASSTXT	Extracting_TXT
	jsr	StopActualSong

	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	SoundModule_EXT,a1
	jsr	AddExtention

	move.l	FinalFileNameRT_PTR,d1
	move.l	#MODE_OLDFILE,d2

	DOS	Open(a6)
	move.l	d0,a5				;A5:HANDLE
	beq.w	ExtractActualModule_ERR

		move.l	#ExtractActualModule_HEAD,d2
		moveq	#8,d3
		move.l	a5,d1
		DOS	Read(a6)			;ModHead

		lea.l	ExtractActualModule_HEAD(PC),a0
		cmpi.l	#MODFILE_IDENT,(a0)
		bne.w	ExtractActualModule_READERR
		tst.l	4(a0)
		beq.w	ExtractActualModule_READERR
		cmpi.l	#MODFILE_VERSION,4(a0)
		bhi.w	ExtractActualModule_READERR

			move.l	SAMPLEMANLIST_PTR,a0
			jsr	FreeAllSamples
			jsr	InitSampleManagement
			jsr	MoveFirstInstrument

			bsr	ExtractModuleParts

		move.l	a5,d1
		DOS	Close(a6)

		jsr	MoveFirstInstrument
		jsr	DrawActualWave

		ASSTXT	Done_TXT

ExtractActualModule_X	
	RET
ExtractActualModule_READERR
		move.l	a5,d1
		DOS	Close(a6)
ExtractActualModule_ERR
		ASSTXT ErrLoadMod
		jsr	WarnFlash
	bra.s	ExtractActualModule_X
ExtractActualModule_HEAD	blk.b	8,0

ExtractModuleParts
		;I(A5L)(FILEHANDLE)
		;
	BGN
	move.w	#FALSE,ExtractHunkPart_RERROR

	lea.l	ExtractModuleParts_JL(PC),a4

ExtractModuleParts_L
		bsr	LoadModuleReadLong
		tst.l	d1
		beq.s	ExtractModuleParts_X
		tst.l	d0
		beq.s	ExtractModuleParts_X
		bmi.s	ExtractModuleParts_X

		move.l	a4,a3
ExtractModuleParts_L2
		move.l	(a3)+,d2
		tst.l	d2
		bne.s	.hunkfound
		;--- End of Mod ? ---
		tst.l	d1
		beq.s	ExtractModuleParts_X

		;--- Unknown Hunk ----------------
		tst.l	d1
		bmi.s	.skipchunk
		bsr	ExtractHunkReadLong
		bra.s	.next		
.skipchunk	bsr	ExtractHunkSkip
		bra.s	.next

.hunkfound	move.l	(a3)+,a0
		cmp.l	d1,d2
		bne.s	ExtractModuleParts_L2
		jsr	(a0)
.next		cmpi.w	#TRUE,ExtractHunkPart_RERROR
		bne.s	ExtractModuleParts_L

ExtractModuleParts_X	RET

ExtractModuleParts_JL
	dc.l	MODHEADTYPE_NGSAMPLEBOOST,ExtractHunkReadLong
	dc.l	MODHEADTYPE_PITCHDIFF,ExtractHunkReadLong
	dc.l	MODHEADTYPE_SAMPLEDIFF,ExtractHunkReadLong

	dc.l	MODHEADTYPE_CHANNELNUMB,ExtractHunkReadLong
	dc.l	MODHEADTYPE_TRACKLEN,ExtractHunkReadLong
	dc.l	MODHEADTYPE_PATTERNNUMB,ExtractHunkReadLong
	dc.l	MODHEADTYPE_SAMPLENUMB,ExtractHunkReadLong
	dc.l	MODHEADTYPE_NOTESIZE,ExtractHunkReadLong
	dc.l	MODHEADTYPE_SYSTEMSPEED,ExtractHunkReadLong

	dc.l	MODHEADTYPE_SONGDATA,ExtractHunkSkip
	dc.l	MODHEADTYPE_SAMPLE,ExtractHunkSAMPLE
	dc.l	MODHEADTYPE_DELTASAMPLE,ExtractHunkDeltaSAMPLE
	dc.l	MODHEADTYPE_DELTA16,ExtractHunkDelta16SAMPLE
	dc.l	MODHEADTYPE_EMPTYSAMPLE,ExtractHunkEMPTYSAMPLE
	dc.l	MODHEADTYPE_NOTEDATA,ExtractHunkSkip
	dc.l	MODHEADTYPE_SAMPLENAMES,ExtractHunkSAMPLENAMES
	dc.l	MODHEADTYPE_SEQUENCE,ExtractHunkSkip
	dc.l	MODHEADTYPE_INFOTEXT,ExtractHunkSkip
	dc.l	0,0
	
ExtractModuleInfo	blk.l	10,0


ExtractHunkDeltaSAMPLE
	move.w	#TRUE,DeltaExtract
	bsr	ExtractHunkSAMPLE
	move.w	#FALSE,DeltaExtract
	rts

ExtractHunkDelta16SAMPLE
	move.w	#TRUE,DeltaExtract+2
	bsr	ExtractHunkSAMPLE
	move.w	#FALSE,DeltaExtract+2
	rts


DeltaExtract	dc.w	FALSE,FALSE

ExtractHunkSAMPLE	BGN
	bsr	LoadModuleReadLong
	tst.l	d0
	beq.w	ExtractHunkPartERR
	bmi.w	ExtractHunkPartERR
	lea.l	SampleTemp_PTR(PC),a4

	clr.l	(a4)
	move.l	d1,MEM_SIZE(a4)
	beq.w	ExtractHunkSAMPLE_X

		move.l	a4,a0
		jsr	GetMem
		move.l	(a0),d2
		beq.w	ExtractHunkPartERR			;Low Mem Error

		move.l	a5,d1
		move.l	MEM_SIZE(a4),d3
		DOS	Read(a6)
		tst.l	d0
		beq.w	ExtractHunkSAMPLE_ERR
		bmi.w	ExtractHunkSAMPLE_ERR

		cmpi.w	#TRUE,DeltaExtract+2
		beq.s	ExtractHSMP_D16
		cmpi.w	#TRUE,DeltaExtract
		beq.s	ExtractHSMP_D8
		bra.s	ExtractHunkSAMPLE_Unpacked

ExtractHSMP_D8
			move.l	(a4),d2
			move.l	MEM_SIZE(a4),d3
			bsr	DeltaUnPackModuleBlock
			bra.s	ExtractHunkSAMPLE_Unpacked

ExtractHSMP_D16
			move.l	(a4),d2
			move.l	MEM_SIZE(a4),d3
			bsr	Delta16UnPackBlk
			bra.s	ExtractHunkSAMPLE_Unpacked
	
		nop		

ExtractHunkSAMPLE_Unpacked

		jsr	SaveTempSample

		jsr	GetActualInstrName
		cmpi.b	#MULTISAMPLE_STEREOL,SAMPLENAME_MULTI(a0)
		bne.s	ExtractHunkSAMPLE_MONO
			jsr	MoveNextInstrument			;;;NEW
ExtractHunkSAMPLE_MONO
		jsr	MoveNextInstrument


		move.l	a4,a0
		move.l	#$00010010,MEM_DEBUG_INFO
		move.l	#$00000000,MEM_DEBUG_INFO+4
		jsr	FreeMem
		clr.l	SampleTemp_PTR

ExtractHunkSAMPLE_X	RET

ExtractHunkSAMPLE_ERR
		ASSTXT ErrLoadMod
		move.l	a4,a0
		move.l	#$00010010,MEM_DEBUG_INFO
		move.l	#$00000001,MEM_DEBUG_INFO+4
		jsr	FreeMem
		clr.l	SampleTemp_PTR
	bra	ExtractHunkPartERR

SaveTempSample
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq.s	SaveTempSample_X

	tst.l	SampleTemp_PTR
	beq.s	SaveTempSample_X
	tst.l	SampleTemp_PTR+4
	beq.s	SaveTempSample_X

SaveTempS_NameScan_NEW
	move.l	a0,d1
SaveTempS_NameScan_L
	move.b	(a0)+,d0
	tst.b	d0
	beq.s	SaveTempS_NameScan_FINAL

	cmpi.b	#":",d0
	beq.s	SaveTempS_NameScan_NEW
	cmpi.b	#"/",d0
	beq.s	SaveTempS_NameScan_NEW
	bra.s	SaveTempS_NameScan_L
	
SaveTempS_NameScan_FINAL
	subq.l	#2,d1
	move.l	d1,a0
	move.b	#"t",(a0)
	move.b	#":",1(a0)
	move.l	#MODE_NEWFILE,d2
	DOS	Open(a6)
	move.l	d0,a5
	beq.s	SaveTempSample_X

	move.l	a5,d1
	move.l	SampleTemp_PTR,d2
	move.l	SampleTemp_PTR+4,d3
	cmpi.b	#FALSE,Ex8Bit
	beq.s	SaveTempSample_NoC
	bsr	ConvTempSample
SaveTempSample_NoC
	DOS	Write(a6)

	move.l	a5,d1
	DOS	Close(a6)

SaveTempSample_X	RET



			dc.w	0
SAVE8BIT_QUALITY	dc.w	8


	acode
ConvTempSample
	puts	d0-d1/d6-d7/a0-a3
	move.l	d2,a0

	cmpi.l	#"MAES",(a0)
	beq.s	ConvTempSample_do
	cmpi.l	#"RIFF",(a0)
	beq.s	ConvTempSample_wav

	bra.s	ConvTempSample_X

ConvTempSample_do

	move.l	a0,a1
	
	tst.l	12(a0)
	beq.w	ConvTempSample_STEREO

	move.l	RenderMaestroHead_ADR,d1
	lea.l	(a0,d1.l),a0

	move.l	d3,d7
	sub.l	d1,d7
	lsr.l	#1,d7
	tst.l	d7
	beq.s	ConvTempSample_X

	move.l	d7,d3


	moveq	#16,d6
	sub.w	SAVE8BIT_QUALITY,d6

ConvTempSample_L
	move.w	(a0)+,d0
	asr.w	d6,d0
	move.b	d0,(a1)+
	subq.l	#1,d7
	bne.s	ConvTempSample_L
	
ConvTempSample_X
	gets	d0-d1/d6-d7/a0-a3
	rts


	acode
ConvTempSample_wav
	move.l	a0,a1

	cmpi.l	#"WAVE",8(a0)
	bne.s	ConvTempSample_X
	cmpi.l	#"data",$24(a0)
	bne.s	ConvTempSample_X
	cmpi.w	#$1000,34(a0)	;16bit ?
	bne.s	ConvTempSample_X

	cmpi.w	#$0200,22(a0)	;stereo ?	;#####
	beq.s	ConvTempSample_WAVSte
	cmpi.w	#$0100,22(a0)	;mono ?
	bne.s	ConvTempSample_X

	moveq	#WAVHEAD_SIZE,d1
	lea.l	(a0,d1.l),a0

	

	move.l	d3,d7
	sub.l	d1,d7
	lsr.l	#1,d7
	tst.l	d7
	beq.s	ConvTempSample_X

	move.l	d7,d3

	moveq	#8,d6
	sub.w	SAVE8BIT_QUALITY,d6

ConvTempSample_wavL
	move.b	1(a0),d0
	asr.b	d6,d0
	move.b	d0,(a1)+
	lea.l	2(a0),a0
	subq.l	#1,d7
	bne.s	ConvTempSample_wavL

	bra.s	ConvTempSample_X



ConvTS_MEM	dc.l	0,0,FASTMEM


	acode
ConvTempSample_X2
	gets	a0-a1/d0-d7
	bra.s	ConvTempSample_X

ConvTempSample_WAVSte
	puts	a0-a1/d0-d7
	move.l	RenderMaestroHead_ADR,d1
	lea.l	(a0,d1.l),a1

	moveq	#WAVHEAD_SIZE,d1
	lea.l	(a0,d1.l),a0


	move.l	d3,d7
	sub.l	d1,d7
	lsr.l	#2,d7
	tst.l	d7
	beq.s	ConvTempSample_X2

ConvTempSample_PreWav_L
	move.b	1(a0),d0
	move.b	d0,(a1)
	move.b	3(a0),d0
	move.b	d0,2(a1)
	lea.l	4(a0),a0
	lea.l	4(a1),a1
	subq.l	#1,d7
	bne.s	ConvTempSample_PreWav_L

	gets	a0-a1/d0-d7


ConvTempSample_STEREO		;Converts maestro stereo and wave stereo(preconverted)
	move.l	RenderMaestroHead_ADR,d1
	
	lea.l	(a0,d1.l),a0

	move.l	d3,d7
	sub.l	d1,d7
	lsr.l	#1,d7
	beq.w	ConvTempSample_X

	puts	a0
	lea.l	ConvTS_MEM(PC),a0
	move.l	d7,MEM_SIZE(a0)
	jsr	GetMem
	gets	a0
	tst.l	d0



	move.l	ConvTS_MEM(PC),a2
	

	move.l	d7,d3

	lsr.l	#1,d7
	beq.w	ConvTempSample_X



	
	puts	d6-d7	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	moveq	#8,d6
	sub.w	SAVE8BIT_QUALITY,d6

ConvTempSample_SL
	move.l	(a0)+,d0
	lsr.w	#8,d0
	asr.b	d6,d0
	
	move.b	d0,(a1)+
	swap	d0
	lsr.w	#8,d0
	asr.b	d6,d0

	move.b	d0,(a2)+
	subq.l	#1,d7
	bne.s	ConvTempSample_SL
	gets	d6-d7

	move.l	ConvTS_MEM(PC),a0


ConvTempSample_SL2
	move.b	(a0)+,d0
	move.b	d0,(a1)+
	subq.l	#1,d7
	bne.s	ConvTempSample_SL2


	lea.l	ConvTS_MEM(PC),a0
		move.l	#$00010011,MEM_DEBUG_INFO
		move.l	#$00000000,MEM_DEBUG_INFO+4
	jsr	FreeMem

	move.l	d3,IFF_HEAD1+4
	move.l	d3,IFF_HEAD+4

	puts	d3
	lsr.l	#1,d3
	move.l	d3,IFF_HEAD+20
	gets	d3

	addi.l	#$6c,IFF_HEAD+4

	puts	d0-d7/a0-a6
	move.l	a5,d1
	move.l	#IFF_HEAD,d2
	move.l	#(IFF_HEADE-IFF_HEAD),d3
	DOS	Write(a6)
	gets	d0-d7/a0-a6


	gets	d0-d1/d6-d7/a0-a3
	rts




	acode

ExtractHunkEMPTYSAMPLE	
	bsr	MoveNextInstrument
	rts

ExtractHunkReadLong	BGN
	bsr	LoadModuleReadLong
	RET

ExtractHunkSkip	BGN
	bsr	LoadModuleReadLong
	tst.l	d0
	beq.w	ExtractHunkPartERR
	bmi.w	ExtractHunkPartERR
	move.l	d1,d2
	move.l	a5,d1
	jsr	DOSSkip
	cmpi.l	#-1,d0
	beq.w	ExtractHunkPartERR
	RET




ExtractHunkSAMPLENAMES	BGN
	bsr	LoadModuleReadLong
	tst.l	d0
	beq.s	ExtractHunkPartERR
	bmi.s	ExtractHunkPartERR

	move.l	d1,d3
	beq.s	ExtractHunkPartERR
	move.l	a5,d1
	move.l	SampleNames_PTR,d2

;	DOS	Read(a6)

	bsr	ReadUnpack

	RET

ExtractHunkPartERR
	ASSTXT ErrLoadHunk
	move.w	#TRUE,ExtractHunkPart_RERROR
	RET
ExtractHunkPart_RERROR	
		dc.w	FALSE
		ENDC
	rts



DOSSkip
	puts	d1-a6
	moveq	#OFFSET_CURRENT,d3
	DOS	Seek(a6)	
	gets	d1-a6
	rts


	acode
SaveActualModule
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	SoundModule_MATCH,a0
	jsr	SetFileRequestPat
	lea.l	ModuleDir_TXT,a0
	jsr	SetFileRequestPath

	lea.l	SaveMod_TXT,a0
	moveq	#PBUFID_MOD,d0
	jsr	GetPathBuf
	jsr	GetTempProj
	jsr	SimpleFileRequest
	jsr	SavePathOnlyBuf
	tst.w	d0
	beq.w	SaveActualModule_X
	;jsr	SavePathBuf

	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	SoundModule_EXT,a1
	jsr	AddExtention2
	jsr	SavePathBuf

	move.b	#FALSE,MODULE_SONGTYPE

	move.b	#TRUE,EasyDOpen_SAFE

SaveActualModule_LINKSONG
	IFNE	SHAREWARE
	puts	d0-a6
	lea.l	Share1_CTXT,a0
	jsr	MulitChoiceRequest
	gets	d0-a6
	ENDC

	move.b	MODULE_SONGTYPE,ProjectName_PTR-4

	lea.l	Test_PATTED,a0
	lea.l	ActualModule_HEAD(PC),a1
	bsr	BuildModuleHeader

	puts	a0-a1
	lea.l	tempstring,a1
	clr.b	(a1)
	lea.l	SaveProj_PRE,a0
	jsr	AddString
	move.l	FinalFileNameRT_PTR,a0
	jsr	AddString
	ASSTXT	tempstring
	gets	a0-a1


	jsr	Overwrite_TestFFN
	cmpi.b	#TRUE,Overwrite_STATUS
	bne	SaveActualModule_ERR

	move.l	FinalFileNameRT_PTR,d1
	move.l	#MODE_NEWFILE,d2
	DOS	Open(a6)
	move.l	d0,a5				;A5:HANDLE
	beq.w	SaveActualModule_ERR

		move.l	#ActualModule_HEAD,d2
		move.l	#ActualModule_HEADEND-ActualModule_HEAD,d3
		cmpi.b	#TRUE,MODULE_SONGTYPE
		beq.s	SaveActualModule_AsSong
			subq.l	#8,d3
SaveActualModule_AsSong	move.l	a5,d1
		;jsr	FlushCaches
		DOS	Write(a6)			;ModHead

		move.l	#MODHEADTYPE_SAMPLENAMES,d1	;IDENT		:LONG
		move.l	SampleNames_PTR,d2		;DATA_PTR	:BYTEs
		move.l	SampleNames_PTR+4,d3		;DATA_LEN	:LONG
		cmpi.b	#TRUE,PACKSONG
		bne.s	NoPackSongA
		jsr	PackData
		ASSTXT2	Instr_TXT,Packed_TXT
NoPackSongA
		bsr	WriteModuleBlock		;SAMPLENAMES
		tst.l	d0
		bmi.w	SaveActualModule_WRITEERR

		move.l	#MODHEADTYPE_SONGDATA,d1	;SONGDATA
		move.l	TestSongData_PTR,d2
		move.l	TestSongData_PTR+4,d3
		cmpi.b	#TRUE,PACKSONG
		bne.s	NoPackSongB
		jsr	PackData
		ASSTXT2	Pos_TXT,Packed_TXT
NoPackSongB
		bsr	WriteModuleBlock
		tst.l	d0
		bmi.w	SaveActualModule_WRITEERR

		move.l	#MODHEADTYPE_NOTEDATA,d1	;NOTEDATA
		move.l	NoteMem_PTR,d2
		move.l	NoteMem_PTR+4,d3

		cmpi.b	#TRUE,PACKSONG
		bne.s	NoPackSongC
		jsr	PackData
		ASSTXT2	Song_TXT,Packed_TXT
NoPackSongC
		bsr	WriteModuleBlock
		tst.l	d0
		bmi.w	SaveActualModule_WRITEERR


		move.l	#MODHEADTYPE_SEQUENCE,d1	;SEQUENCE
		move.l	SequenceMem_PTR,d2
		move.l	SequenceMem_PTR+4,d3
		cmpi.b	#TRUE,PACKSONG
		bne.s	NoPackSongD
		jsr	PackData
		ASSTXT2	Seq_TXT,Packed_TXT
NoPackSongD
		bsr	WriteModuleBlock
		tst.l	d0
		bmi.w	SaveActualModule_WRITEERR

		move.l	#MODHEADTYPE_INFOTEXT,d1	;MODULE DIZ
		move.l	ModuleDiz_PTR,d2
		beq.s	WriteModule_NoDiz
		move.l	ModuleDiz_PTR+4,d3
		beq.s	WriteModule_NoDiz
		bsr	WriteModuleBlock
		tst.l	d0
		bmi	SaveActualModule_WRITEERR
		ASSTXT	Dizwrite_TXT

WriteModule_NoDiz
		moveq	#MODHEADTYPE_INFOOBJ,d1		;MODULE DIZ OBJ
		move.l	ModuleDiz2_PTR,d2
		beq.s	WriteModule_NoDiz2
		move.l	ModuleDiz2_PTR+4,d3
		beq.s	WriteModule_NoDiz2
		bsr	WriteModuleBlock
		tst.l	d0
		bmi.s	SaveActualModule_WRITEERR
		ASSTXT	Dizwrite2_TXT

		moveq	#MODHEADTYPE_INFOTYPE,d1
		move.l	#InfoObjType,d2
		moveq	#16,d3
		bsr	WriteModuleBlock
		bmi.s	SaveActualModule_WRITEERR

WriteModule_NoDiz2

		bsr	WriteModuleSamples

		move.l	a5,d1
		DOS	Close(a6)

	move.l	FinalFileNameRT_PTR,a0
	move.l	ProjectName_PTR,a1
	jsr	CopyString
	jsr	DrawPattedTitle

	ASSTXT	Done_TXT
SaveActualModule_X	
	move.b	#FALSE,MODULE_SONGTYPE
	jsr	FreeModuleDiz
	jsr	FreeModuleDiz2
	move.b	#FALSE,EasyDOpen_SAFE

	RET

SaveActualModule_WRITEERR
		move.l	a5,d1
		DOS	Close(a6)
SaveActualModule_ERR
		ASSTXT Errsavefile
		ASSTXT Fail_TXT
	bra.s	SaveActualModule_X

ActualModule_HEAD
	dc.l	MODFILE_IDENT,MODFILE_VERSION	;0
	dc.l	MODHEADTYPE_CHANNELNUMB,0	;8
	dc.l	MODHEADTYPE_TRACKLEN,0		;16
	dc.l	MODHEADTYPE_PATTERNNUMB,0	;24
	dc.l	MODHEADTYPE_SAMPLENUMB,0	;32
	dc.l	MODHEADTYPE_NOTESIZE,0		;40
	dc.l	MODHEADTYPE_SYSTEMSPEED,0	;48
	dc.l	MODHEADTYPE_NGSAMPLEBOOST,0	;56
	dc.l	MODHEADTYPE_PITCHDIFF,0		;
	dc.l	MODHEADTYPE_SAMPLEDIFF,0

	dc.l	MODHEADTYPE_ISSONG,0		;MUST BE LAST ENTRY !!
ActualModule_HEADEND


	acode
WriteModuleSamples	;V1.0
			;I(A5L)(FILE_HANDLE)
	cmpi.b	#TRUE,MODULE_SONGTYPE
	bne.s	WriteModuleSamples_Do
		rts
WriteModuleSamples_Do	BGN
	move.l	SampleNames_PTR,a4
	move.l	#MaxNumb_Samples-1,d7
	cmpi.w	#TRUE,PACKSAMPLE
	bne.s	WriteModuleSamples_L
	ASSTXT	Delta_TXT
WriteModuleSamples_L
	move.l	a4,a0
	tst.b	(a0)
	beq.w	WriteModuleSamp_Empty

	cmpi.b	#INSTRTYPE_KILL,SAMPLENAME_INSTRTYPE(a0)
	beq.w	WriteModuleSamp_Empty

	cmpi.b	#MULTISAMPLE_LINESRC,SAMPLENAME_MULTI(a0)
	beq.w	WriteModuleSamp_Empty

	cmpi.b	#MULTISAMPLE_STEREOR,SAMPLENAME_MULTI(a0)
	beq.w	WriteModuleSamples_NEXT			;;;

	jsr	FileLength
	move.l	d0,d6					;D6L: FILELENGTH
	beq.w	WriteModuleSamp_Empty

		lea.l	WriteModuleSamp_MEM(PC),a0
		move.l	d6,MEM_SIZE(a0)
		jsr	GetMem
		tst.l	(a0)
		beq.w	SaveModSamp_NOMEMERR

		move.l	a4,d1
		move.l	#MODE_OLDFILE,d2
		DOS	Open(a6)
		move.l	d0,d5				;D5L: SAMPLE_HANDLE
		beq.w	SaveModSamp_OPENERR


		move.l	d5,d1
		move.l	WriteModuleSamp_MEM,d2
		move.l	WriteModuleSamp_MEM+MEM_SIZE,d3
		DOS	Read(a6)
		tst.l	d0
		bmi.s	SaveModSamp_READERR

		move.l	d5,d1
		DOS	Close(a6)

		IFNE	INCXPK
		puts	a0
		lea.l	WriteModuleSamp_MEM(PC),a0
		jsr	UnpackXPKMem
		gets	a0
		ENDC

		move.l	#MODHEADTYPE_SAMPLE,d1
		move.l	WriteModuleSamp_MEM,d2
		move.l	WriteModuleSamp_MEM+4,d3

		cmpi.w	#TRUE,PACKSAMPLE
		bne.s	SaveModSamp_Unpacked
		
			moveq	#MODHEADTYPE_DELTASAMPLE,d1
			bsr	DeltaPackModuleBlock

SaveModSamp_Unpacked
		bsr	WriteModuleBlock
		tst.l	d0
		bmi.s	SaveModSamp_WRITEERR

		lea.l	WriteModuleSamp_MEM(PC),a0
		move.l	#$00010011,MEM_DEBUG_INFO
		move.l	#$00000001,MEM_DEBUG_INFO+4
		jsr	FreeMem
		bra.s	WriteModuleSamples_NEXT


SaveModSamp_READERR
			move.l	d5,d1
			DOS	Close(a6)
SaveModSamp_OPENERR
		lea.l	WriteModuleSamp_MEM(PC),a0
		move.l	#$00010011,MEM_DEBUG_INFO
		move.l	#$00000002,MEM_DEBUG_INFO+4
		jsr	FreeMem
SaveModSamp_NOMEMERR
		ASSTXT WriteModErr_TXT
		bra.s	WriteModuleSamp_Empty

SaveModSamp_WRITEERR
		lea.l	WriteModuleSamp_MEM(PC),a0
		move.l	#$00010011,MEM_DEBUG_INFO
		move.l	#$00000003,MEM_DEBUG_INFO+4
		jsr	FreeMem
		ASSTXT WriteModErr_TXT
		bra.s	WriteModuleSamples_X		

WriteModuleSamples_NEXT
	lea.l	SampleNameMaxLen(a4),a4
	dbf	d7,WriteModuleSamples_L

WriteModuleSamples_X
	RET

WriteModuleSamp_MEM		dc.l	0,0,PUPMEM
WriteModuleSamp_EMPTYSAMPLE	dc.l	MODHEADTYPE_EMPTYSAMPLE

WriteModuleSamp_Empty
		move.l	a5,d1
		move.l	#WriteModuleSamp_EMPTYSAMPLE,d2
		moveq	#4,d3
		;jsr	FlushCaches
		DOS	Write(a6)
		tst.l	d0
		beq.s	WriteModuleSamples_ERR
	bpl.s	WriteModuleSamples_NEXT

WriteModuleSamples_ERR
		jsr	WarnFlash
	bra.s	WriteModuleSamples_X



WriteModuleBlock	;V1.0
			;I(D1L,D2L,D3L,A5L)(IDENT,BLOCKLEN,BLOCKPTR,FILE_HANDLE)
			;O(D0L)(Bytes Written:NEG=ERR)
	movem.l	d1-a6,-(a7)
;	bsr	PackData

	movem.l	d2-d3,WriteModuleBlock_TEMP+8
	lea.l	WriteModuleBlock_TEMP(PC),a0

	move.l	d1,(a0)
	move.l	d3,4(a0)

	cmpi.w	#TRUE,PACKRESULT
	bne.s	WriteModuleHead_Unpacked

		addi.l	#PACKHEAD_SIZEOF,4(a0)



WriteModuleHead_Unpacked
	move.l	a0,d2
	move.l	#8,d3
	move.l	a5,d1
	;jsr	FlushCaches
	DOS	Write(a6)
	tst.l	d0
	bmi.s	WriteModuleBlock_X

	cmpi.w	#TRUE,PACKRESULT
	bne.s	WriteModuleBlock_Unpacked

		move.l	#PACKHEAD,d2
		moveq	#PACKHEAD_SIZEOF,d3
		move.l	a5,d1
		;jsr	FlushCaches
		DOS	Write(a6)
		tst.l	d0
		bmi.s	WriteModuleBlock_X

WriteModuleBlock_Unpacked
	movem.l	WriteModuleBlock_TEMP+8,d2-d3
	move.l	a5,d1
	;jsr	FlushCaches
	DOS	Write(a6)
WriteModuleBlock_X	movem.l	(a7)+,d1-a6
	bsr	FreePackMem
	move.w	#FALSE,PACKRESULT
	rts
WriteModuleBlock_TEMP	dc.l	0,0,0,0

BuildModuleHeader	;V1.1
	BGN
	moveq	#0,d0
	move.w	PATTED_NUMBVOICES(a0),d0
	move.l	d0,12(a1)
	move.w	PATTED_LINESPERPATTERN(a0),d0
	move.l	d0,20(a1)

	move.l	VEX_PattNumb,d0			;NEW
	move.w	d0,28(a1)
	move.l	VEX_PosNumb,d0
	move.w	d0,28+2(a1)

	move.l	#MaxNumb_Samples,d0

	;swap	d0				;1.1 SAMPLEBOOST INTO MOD
	;move.l	SAMPLEBOOST_BAK,d1
	;move.b	d1,d0
	;swap	d0

	move.l	d0,36(a1)

	move.w	PATTED_NOTESIZE(a0),d0
	move.l	d0,44(a1)
	move.l	VexSpeed,52(a1)

	move.l	NGSampleBoost,56+4(a1)

	RET
	ENDC


	acode
ToogleModDeltaWrite
	eori.w	#-1,PACKSAMPLE
	rts

TooglePackSong
	eori.b	#-1,PACKSONG
	rts
	
PACKSONG	dc.b	FALSE
	even
PACKSAMPLE	dc.w	FALSE


	acode
DeltaPackModuleBlock	;V1.0
	btst	#LSFLAGS_16BIT,SAMPLENAME_LSFLAGS(a4)
	beq.s	DeltaPack8ModuleBlock

	moveq	#MODHEADTYPE_DELTA16,d1
	BGN
	lea.l	PackDelta16(PC),a5
	bsr	Proc16ModBlk
	RET

PACK16BUF_LEN	EQU	4096

Proc16ModBlk
	BGN
	move.l	#PACK16BUF_LEN,d0
	move.l	d2,a0
	subq.l	#1,d3
	bmi.s	Proc16ModBlk_X
Proc16ModBlk_L
		sub.l	d0,d3
		bmi.s	Proc16ModBlk_X
		jsr	(a5)
		lea.l	(a0,d0.l),a0
		bra.s	Proc16ModBlk_L
Proc16ModBlk_X	RET

Delta16Buf_PTR	dc.l	0,PACK16BUF_LEN*2,FASTMEM

DeltaPack8ModuleBlock	;V1.0
	BGN		;I(D1L,D2L,D3L)(IDENT,BLOCKLEN,BLOCKPTR)
	move.l	d2,a0
	subq.l	#2,d3
	bmi.s	DeltaPackModuleBlock_X

	move.b	(a0)+,d4

DeltaPackModuleBlock_L
		move.b	(a0),d0
		move.b	d0,d5
		sub.b	d4,d0
		move.b	d0,(a0)+
		move.b	d5,d4
		subq.l	#1,d3
	bpl.s	DeltaPackModuleBlock_L
DeltaPackModuleBlock_X	RET


PD16Precode
	BGN
	move.l	a0,a1
	move.l	Delta16Buf_PTR(PC),a2
	lsr.l	#1,d0
	subq.w	#1,d0
	move.w	d0,d7

PackDelta16_L
		move.w	(a0)+,d2
		move.b	d2,(a1)+
		lsr.w	#8,d2
		move.b	d2,(a2)+
	dbf	d0,PackDelta16_L

	move.l	Delta16Buf_PTR(PC),a0
PackDelta16_L2
		move.b	(a0)+,d2
		move.b	d2,(a1)+
	dbf	d7,PackDelta16_L2
	RET

PackD162
	BGN
	subq.w	#2,d0
	move.b	(a0)+,d2

PackD162_L
		move.b	(a0),d3
		move.b	d3,d4
		sub.b	d2,d4
		move.b	d4,(a0)+
		move.b	d3,d2
	dbf	d0,PackD162_L
	RET

UnpackD162
	BGN
	subq.w	#2,d0
	move.b	(a0)+,d2
UnPackD162_L
		add.b	(a0),d2
		move.b	d2,(a0)+
	dbf	d0,UnPackD162_L
	RET

PackDelta16
	bsr	PD16Precode
	bsr	PackD162
	rts

UnPackDelta16
	bsr	UnpackD162
	bsr	PD16preUncode
	rts

PD16preUncode
	BGN
	move.l	a0,a3

	move.l	Delta16Buf_PTR(PC),a2

	move.l	d0,d7
	lsr.l	#1,d0
	lea.l	(a0,d0.w),a1
	subq.w	#1,d0

UnPackDelta16_L
		move.b	(a1)+,d2
		lsl.w	#8,d2
		move.b	(a0)+,d2
		move.w	d2,(a2)+
	dbf	d0,UnPackDelta16_L

	move.l	Delta16Buf_PTR(PC),a0
	move.l	a3,a1
	move.l	d7,d0
	jsr	CopyMemory
	RET


Delta16UnPackBlk	;V1.0
	BGN		;I(D2L,D3L)(BLOCKPTR,BLOCKLEN)
	lea.l	UnPackDelta16(PC),a5
	bsr	Proc16ModBlk
	RET
	

DeltaUnPackModuleBlock	;V1.0
	BGN		;I(D2L,D3L)(BLOCKPTR,BLOCKLEN)
	move.l	d2,a0
	move.b	(a0)+,d4
DeltaUnpackModuleBlock_L
		subq.l	#1,d3
		beq.s	DeltaUnpackModuleBlock_X
		add.b	(a0),d4
		move.b	d4,(a0)+
	bra.s	DeltaUnpackModuleBlock_L
DeltaUnpackModuleBlock_X	RET


	;DELTA PACK END ----------------------------------------------

AddExtention2
	BGN
	jsr	AddExtention
	move.l	FileNameRT_PTR,a0
	jsr	ClipExtension
	jsr	AddExtention
	RET

AddExtention
	BGN
	exg	a0,a1
	jsr	AddString
	RET

ClipFileNameExt
	BGN
	move.l	FinalFileNameRT_PTR,a0
	bsr	ClipExtension
	RET

ClipExtension
	BGN
ClipExtension_L	move.b	(a0)+,d0
	beq.s	ClipExtension_X
	cmpi.b	#".",d0
	bne.s	ClipExtension_L
	clr.b	-1(a0)
ClipExtension_X	RET

SaveActualInstruments
	IFNE	DEMO
	rts
	ELSE
	BGN


	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	SampleList_EXT,a1
	jsr	AddExtention
	move.l	FinalFileNameRT_PTR,d1
	move.l	#MODE_NEWFILE,d2
	DOS	Open(a6)
	move.l	d0,a5			;A4:HANDLE
	beq.s	SaveActualInstruments_X
	move.l	a5,d1
	move.l	SampleNames_PTR,d2
	move.l	SampleNames_PTR+4,d3

	DOS	Write(a6)

	move.l	a5,d1
	DOS	Close(a6)
	ASSTXT	Done_TXT
SaveActualInstruments_X	RET
	ENDC


LOAD_NOINSTRUMENTS	dc.w	FALSE

	acode
LoadActualProject
	jsr	ClrLockState
	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN
	cmpi.b	#TRUE,SONGFILEIO
	beq	LoadActualProject_Xc
	move.b	#TRUE,SONGFILEIO
	
	jsr	PattedUpdateReset
	move.b	#FALSE,MODULE_SONGTYPE
	move.w	#FALSE,MOD_RELOAD
	lea.l	Song_MATCH,a0
	jsr	SetFileRequestPat
	lea.l	SongDir_TXT,a0
	jsr	SetFileRequestPath

	lea.l	LoadActualProject_TXT,a0
	moveq	#PBUFID_SONG,d0
	jsr	GetPathBuf
	jsr	SimpleFileRequest
	jsr	SavePathBuf
	tst.w	d0
	beq.s	LoadActualProject_X

	move.l	FinalFileNameRT_PTR,a0
	move.l	ProjectName_PTR,a1
	jsr	CopyString

	jsr	SetTempProj
	jsr	StopActualSong
	jsr	DeactivateDsp
	jsr	ShowProjectName

	bsr	LoadActualSong
	cmpi.w	#TRUE,MOD_RELOAD
	beq.s	LoadActualProject_ModX
	cmpi.b	#TRUE,MODULE_SONGTYPE
	beq.s	LoadActualProject_Mod2X

	bsr	LoadActualInstruments	;OBSOLETE
	bsr	LoadActualSongData
	bsr	LoadActualSongSeq
	bsr	AutoLoadSamples
	bsr	AutoCalcLineSamples

LoadActualProject_Mod2X
		move.b	#FALSE,MODULE_SONGTYPE
LoadActualProject_ModX

	
	lea.l	Test_PATTED,a0
	jsr	PattedUpdateDisp
	jsr	UpdatePosList
LoadActualProject_X	
	move.b	#FALSE,SONGFILEIO
LoadActualProject_Xc	
	;jsr	FlushCaches
	RET


	ENDC
SONGFILEIO	dc.b	FALSE

	acode
LoadActualInstruments
	IFNE	DEMO
	rts
	ELSE
	BGN
	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	SampleList_EXT,a1
	jsr	AddExtention

	move.l	FinalFileNameRT_PTR,d1
	move.l	#MODE_OLDFILE,d2
	DOS	Open(a6)

	move.l	d0,a5			;A4:HANDLE
	beq.s	LoadActualInstruments_X

	move.l	a5,d1
	move.l	SampleNames_PTR,d2
	move.l	SampleNames_PTR+4,d3
	DOS	Read(a6)
	move.l	a5,d1
	DOS	Close(a6)

	ASSTXT	Done_TXT

LoadActualInstruments_X	RET
	even
	ENDC



LoadActualSong
	jsr	HideBlockRange
	IFNE	DEMO
	rts
	ELSE
	BGN

	jsr	PattedUpdateReset
	jsr	FreeModuleDiz
	jsr	FreeModuleDiz2

	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	Song_EXT,a1
	jsr	AddExtention
	move.l	FinalFileNameRT_PTR,d1
	move.l	#MODE_OLDFILE,d2
	DOS	Open(a6)
	move.l	d0,a5			;A5:HANDLE
	beq.s	LoadActualSong_X

	move.l	a5,d1
	move.l	NoteMem_PTR,d2
	move.l	d2,a4
	moveq	#4,d3
	DOS	Read(a6)
	cmpi.l	#MODFILE_IDENT,(a4)
	beq.s	LINK_LoadasMod


	move.l	a5,d1
	DOS	Close(a6)
	move.l	FinalFileNameRT_PTR,d1
	move.l	#MODE_OLDFILE,d2
	DOS	Open(a6)
	move.l	d0,a5
	beq.s	LoadActualSong_X

	move.l	a5,d1
	move.l	NoteMem_PTR,d2
	move.l	NoteMem_PTR+4,d3
	DOS	Read(a6)

	move.l	a5,d1
	DOS	Close(a6)
LoadActualSong_X	RET
	ENDC

LINK_LoadasMod
	move.l	a5,d1
	DOS	Close(a6)
	move.b	#TRUE,MODULE_SONGTYPE
	bra	ReLoadActualModule

LoadActualSongData
	IFNE	DEMO
	rts
	ELSE
	BGN
	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	SongData_EXT,a1
	jsr	AddExtention

	move.l	FinalFileNameRT_PTR,d1
	move.l	#MODE_OLDFILE,d2
	DOS	Open(a6)
	move.l	d0,a5			;A4:HANDLE
	beq.s	LoadActualSongData_X

	move.l	a5,d1
	move.l	TestSongData_PTR,d2
	move.l	TestSongData_PTR+4,d3
	DOS	Read(a6)
	move.l	a5,d1
	DOS	Close(a6)

	bsr	UpdatePatHeadPtrs

LoadActualSongData_X	RET
	ENDC

LoadActualSongSeq
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	InitSequences

	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	SongSeq_EXT,a1
	jsr	AddExtention

	move.l	FinalFileNameRT_PTR,d1
	move.l	#MODE_OLDFILE,d2
	DOS	Open(a6)
	move.l	d0,a5			;A4:HANDLE
	beq.s	LoadActualSongSeq_X

		move.l	a5,d1
		move.l	SequenceMem_PTR,d2
		move.l	SequenceMem_PTR+4,d3
		DOS	Read(a6)
		move.l	a5,d1
		DOS	Close(a6)

LoadActualSongSeq_X	RET

	ENDC

PACKINFO_UNPACKED	EQU	0
PACKINFO_LONGS		EQU	1
PACKINFO_DBLLONG	EQU	2
PACKINFO_NULLBYTES	EQU	3
PACKINFO_BYTES		EQU	4
PACKINFO_END		EQU	-1

PACK_INFO	EQU	0
PACK_NUMB	EQU	1
PACK_DATA	EQU	2

PACK_HEADSIZE	EQU	2


ReadUnpack
	BGN
	move.l	d2,d7		;DEST
	move.l	d3,d6

	lea.l	PACKMEM(PC),a0
	move.l	d3,4(a0)
	jsr	GetMem

	move.l	PACKMEM(PC),d2
	tst.l	d2
	beq.s	ReadUnpack_NOMEM


	DOS	Read(a6)

	jsr	UnpackData	

	jsr	FreePackMem
	
ReadUnpack_NOMEM	RET

UnpackData
	BGN
	move.l	PACKMEM(PC),a0

	move.l	d7,a1

	cmpi.l	#"PACK",(a0)
	bne.s	UnpackData_NotPacked
	cmpi.w	#TRUE,4(a0)
	bne.s	UnpackData_NotPacked
	

	lea.l	10(a0),a0

UnpackData_L
		moveq	#0,d2
		move.b	(a0)+,d2
		cmpi.b	#PACKINFO_END,d2
		beq.s	UnpackData_X
		cmpi.b	#PACKINFO_NULLBYTES,d2
		bhi.s	UnpackData_ERR
		lea.l	Unpack_JL(PC),a2
		move.l	(a2,d2.w*4),a2
		jsr	(a2)
	bra.s	UnpackData_L

UnpackData_X	
	RET

UnpackData_ERR
        ASSTXT	ERRUnpacked_TXT
	bra.s	UnpackData_X	

UnpackData_NotPacked
	move.l	d6,d0
	bsr	CopyMemory
	bra.s	UnpackData_X

Unpack_JL	dc.l	DoUnpackNone,DoUnpackLongs,DoUnpackDblLong,DoUnpackNullBytes

DoUnpackNone
	puts	d0
	moveq	#0,d0
	move.b	(a0)+,d0
	bsr	CopyMemory
	lea.l	(a0,d0.w),a0
	lea.l	(a1,d0.w),a1
	gets	d0
	rts

DoUnpackDblLong
	puts	d0
	move.l	(a0)+,d0
	move.l	d0,(a1)+
	move.l	d0,(a1)+
	gets	d0
	rts

DoUnpackLongs
	puts	d0-d1
	moveq	#0,d1
	move.b	(a0)+,d1
	move.l	(a0)+,d0

	subq.l	#1,d1
	bmi.s	DoUnpackLongs_X

DoUnpackLongs_L
		move.l	d0,(a1)+
	dbf	d1,DoUnpackLongs_L

DoUnpackLongs_X
	gets	d0-d1
	rts

DoUnpackNullBytes
	puts	d0
	moveq	#0,d0
	move.b	(a0)+,d0
	subq.w	#1,d0
UnpackNullBytes_L
		clr.b	(a1)+
	dbf	d0,UnpackNullBytes_L
	gets	d0
	rts

UnpackNone
	puts	d0
	moveq	#0,d0
	move.b	(a0)+,d0
	bsr	CopyMemory
	gets	d0
	rts


PackData	;V1.0
		;I(D2L,D3L)(PTR,LEN)
	IFNE	NOPACKDATA
	rts
	ENDC
	puts	d0-d1/d4-d7/a0-a6
	move.w	#FALSE,PACKRESULT

	lea.l	PACKMEM(PC),a0
	move.l	d3,4(a0)
	jsr	GetMem
	tst.l	(a0)
	beq.s	PackData_Fail

	move.l	(a0),a1

	move.l	d2,a0

	move.l	d3,d0
	move.l	d0,PACKRESULT+2

	moveq	#0,d7

	lea.l	Pack_JL(PC),a5

	bsr	ClearPackNone

PackData_L
		moveq	#0,d4
		moveq	#PACKINFO_UNPACKED,d5

		bsr	CheckDblLong
		bsr	PackUseHigh
		bsr	CheckLongs
		bsr	PackUseHigh
		bsr	CheckNullBytes
		bsr	PackUseHigh

		lea.l	(a5,d5.w*4),a6
		move.l	(a6),a6
		jsr	(a6)

	tst.l	d0
	bne.s	PackData_L

	bsr	WritePackNone

	cmpi.w	#TRUE,PACKRESULT
	bne.s	PackData_Fail

		move.b	#PACKINFO_END,(a1)	;SUCCESS
		addq.l	#1,d7		;LAST BYTE (PACKEND)
		move.l	d7,d3
		move.l	PACKMEM(PC),d2

PackData_Fail
	gets	d0-d1/d4-d7/a0-a6
	rts


FreePackMem
	BGN
	lea.l	PACKMEM(PC),a0
	tst.l	(a0)
	beq.s	FreePackMem_X
	move.l	#$00010012,MEM_DEBUG_INFO
	move.l	#$00000000,MEM_DEBUG_INFO+4
	jsr	FreeMem
	clr.l	(a0)
FreePackMem_X
	RET

Pack_JL	dc.l	PackNone,PackLongs,PackDbLong,PackNullBytes

ClearPackNone
	move.l	a0,NONEPACKINFO+4
	clr.l	NONEPACKINFO
	rts

WritePackNone
	puts	d0/a0
	move.l	NONEPACKINFO,d0
	tst.l	d0
	beq.s	WritePackNone_X

	move.b	#PACKINFO_UNPACKED,(a1)+
	move.b	d0,(a1)+

	addq.l	#2,d7
	add.l	d0,d7

	move.l	NONEPACKINFO+4(PC),a0
	bsr	CopyMemory
	lea.l	(a1,d0.l),a1


WritePackNone_X


	gets	d0/a0

	bsr	ClearPackNone

	rts

PackNone
	cmpi.l	#255,NONEPACKINFO
	bne.s	PackNone_OK
	bsr	WritePackNone
PackNone_OK
	lea.l	1(a0),a0
	subq.l	#1,d0
	addq.l	#1,NONEPACKINFO
	rts

NONEPACKINFO	dc.l	0,0	;NUMBER, START

PackNullBytes
	bsr	WritePackNone
	puts	d2

	moveq	#0,d2
	move.b	PACKNULLBYTES(PC),d2

	move.b	#PACKINFO_NULLBYTES,(a1)+
	move.b	d2,(a1)+

	sub.l	d2,d0
	lea.l	(a0,d2.w),a0
	addq.l	#2,d7
	gets	d2

	move.w	#TRUE,PACKRESULT
	bsr	ClearPackNone
	rts

PackDbLong
	bsr	WritePackNone
	puts	d2
	move.l	(a0),d2
	move.b	#PACKINFO_DBLLONG,(a1)+
	move.l	d2,(a1)+
	subq.l	#8,d0
	lea.l	8(a0),a0
	addq.l	#5,d7
	gets	d2
	move.w	#TRUE,PACKRESULT
	bsr	ClearPackNone
	rts


PackLongs
	bsr	WritePackNone
	puts	d4-d5
	moveq	#0,d5
	move.b	PACKEDLONGS,d5

	move.l	(a0),d4
	move.b	#PACKINFO_LONGS,(a1)+
	move.b	d5,(a1)+
	move.l	d4,(a1)+
	lsl.l	#2,d5
	sub.l	d5,d0
	lea.l	(a0,d5.w),a0
	addq.l	#6,d7

	gets	d4-d5
	move.w	#TRUE,PACKRESULT
	bsr	ClearPackNone
	rts

PackUseHigh
	cmp.l	d4,d1
	bls.s	PackUseHigh_Keep
	move.l	d1,d4
	move.l	d2,d5
PackUseHigh_Keep
	rts

CheckDblLong
	;I(A0L,D0L)(
	;O(D1L,D2L)(GAIN,PACKID) how many bytes LESS will result
	puts	d7
	move.l	d0,d7
	lsr.l	#2,d7
	subq.l	#1,d7
	bmi.s	CheckDblLong_Fail
	tst.l	d7
	beq.s	CheckDblLong_Fail
	move.l	(a0),d2		;D2L SCAN PATTERN
	cmp.l	4(a0),d2
	bne.s	CheckDblLong_Fail
	moveq	#(8-(1+4)),d1	
CheckDblLong_X
	moveq	#PACKINFO_DBLLONG,d2
	gets	d7
	rts
CheckDblLong_Fail
	moveq	#0,d1
	bra.s	CheckDblLong_X

CheckLongs
	;I(A0L,D0L)(
	;O(D1L,d2L)(GAIN,PACKID) how many bytes LESS will result
	puts	d3/d7/a0

	move.l	d0,d7
	lsr.l	#2,d7
	subq.l	#1,d7
	bmi.s	CheckLongs_Fail
	tst.l	d7
	beq.s	CheckLongs_Fail

	move.l	(a0)+,d2		;D2L SCAN PATTERN
	moveq	#0,d3		;D3L COUNT

CheckLongs_L
		addq.l	#1,d3
		cmp.l	(a0)+,d2
		bne.s	CheckLongs_END

		subq.l	#1,d7
	bne.s	CheckLongs_L

CheckLongs_END
	cmpi.l	#256,d3
	blo.s	CheckLongs_OK
		move.l	#255,d3
CheckLongs_OK

	move.b	d3,PACKEDLONGS



	subq.l	#1,d3
	beq.s	CheckLongs_Fail


	addq.l	#PACK_HEADSIZE,d3
	move.l	d3,d1

CheckLongs_X
	gets	d3/d7/a0
	moveq	#PACKINFO_LONGS,d2
	rts

CheckLongs_Fail
	moveq	#0,d1
	bra.s	CheckLongs_X

PACKEDLONGS	dc.b	0
PACKNULLBYTES	dc.b	0
	even

CheckNullBytes
	;I(A0L,D0L)(
	;O(D1L,d2L)(GAIN,PACKID) how many bytes LESS will result
	puts	d3/d7/a0
	tst.b	(a0)
	bne.s	CheckNullBytes_Fail
	move.l	d0,d7
	subq.l	#1,d7
	bmi.s	CheckNullBytes_Fail
	tst.l	d7
	beq.s	CheckNullBytes_Fail

	moveq	#-1,d3		;D3L COUNT
CheckNullBytes_L
		addq.l	#1,d3
		tst.b	(a0)+
		bne.s	CheckNullBytes_END
	subq.l	#1,d7
	bne.s	CheckNullBytes_L

CheckNullBytes_END
	cmpi.l	#3,d3
	blo.s	CheckNullBytes_Fail

	cmpi.l	#256,d3
	blo.s	CheckNullBytes_OK
		move.l	#255,d3
CheckNullBytes_OK

	move.b	d3,PACKNULLBYTES
	subq.l	#2,d3
	move.l	d3,d1
CheckNullBytes_X
	gets	d3/d7/a0
	moveq	#PACKINFO_NULLBYTES,d2
	rts


CheckNullBytes_Fail
	moveq	#0,d1
	bra.s	CheckNullBytes_X

PACKHEAD_SIZEOF	EQU	10

PACKMEM		dc.l	0,0,FASTMEM

UpdatePatHeadPtrs
	BGN
	move.l	TestSongData_PTR,a0
	move.l	#Test_PosNumb-1,d7
UpdatePatHeadPtrs_L
		jsr	SetPatHeadPTR
		lea.l	POSITION_SIZEOF(a0),a0
	dbf	d7,UpdatePatHeadPtrs_L
	RET





	acode
AutoLoadSamples	;V1.2
		;1.2:	RELOADSAMPLE_STATUS
	BGN
	jsr	MoveFirstInstrument

	lea.l	Test_INSTRMAN,a5
	move.w	INSTRMAN_MAXNUMB(a5),d7
	beq.s	AutoLoadSamples_X
	subq.w	#1,d7

	move.l	SampleNames_PTR,a2
	move.l	SAMPLEMANLIST_PTR,a3
	move.l	FirstEntry_INSTR,a4

	move.l	a3,a0
	jsr	FreeAllSamples
	move.l	a3,a0
	jsr	InitSampleManagement

AutoLoadSamples_L
		jsr	GetActualInstrName
		tst.b	(a0)
		beq.s	AutoLoadSamples_NEXT
		cmpi.b	#MULTISAMPLE_LINESRC,SAMPLENAME_MULTI(a0)
		beq.s	AutoLoadSamples_NEXT
		cmpi.b	#MULTISAMPLE_STEREOR,SAMPLENAME_MULTI(a0)
		beq.s	AutoLoadSamples_NEXT
		cmpi.b	#INSTRTYPE_KILL,SAMPLENAME_INSTRTYPE(a0)
		beq.s	AutoLoadSamples_NEXT

		jsr	ReloadActualSample
		;jsr	DrawInstrument
AutoLoadSamples_NEXT
		jsr	HandleAllMsgs
		jsr	MoveNextInstrument
	dbf	d7,AutoLoadSamples_L
AutoLoadSamples_X	jsr	DrawInstrument
	RET



SaveActInstrName
	BGN
	jsr	GetActualInstrName	;A0L
	move.l	TempInstrName_PTR(PC),a1
	jsr	CopyInstrName
	RET

LoadActInstrName
	BGN
	jsr	GetActualInstrName	;A0L
	move.l	TempInstrName_PTR(PC),a1
	exg	a0,a1
	jsr	CopyInstrName
	RET

TempInstrName_PTR	dc.l	0,SampleNameMaxLen,PUPMEM


NLSAMPLE_NEW	EQU	0
NLSAMPLE_RELOAD	EQU	1

NLSINFO_TYPE		EQU	0	;NEW/RELOAD
NLSINFO_BODYTYPE	EQU	2	;MONO/STEREO
NLSINFO_BODYPTR		EQU	4
NLSINFO_BODYLEN		EQU	8

NLSINFO_ACTUALINAME	EQU	20
NLSINFO_ACTUALINSTR	EQU	24
NLSINFO_ACTSAMPLEMANE	EQU	28


	acode
NewLoadSampleHunk
	BGN
	lea.l	NewLoadSample_INFO,a5
	moveq	#NLSAMPLE_RELOAD,d0
	jsr	GetActualInstrName
	move.l	a0,NLSINFO_ACTUALINAME(a5)
	move.w	d0,NLSINFO_TYPE(a5)
	moveq	#TRUE,d0
	bra	NewLoadSample_HUNKIN



SAMPLERESOLUTION	dc.w	8	;8BIT




	acode
SetCustomScreenPrefs
	BGN
	lea.l	TempPrefs_Head,a2
	move.l	sm_DisplayID(a0),d0
	move.l	d0,20(a2)
	move.l	sm_DisplayWidth(a0),d0
	move.w	d0,24(a2)
	move.l	sm_DisplayHeight(a0),d0
	move.w	d0,26(a2)
	move.w	sm_DisplayDepth(a0),d0
	move.w	d0,28(a2)
	move.w	#1,30(a2)	;Mode Custom Screen
	RET

TEMPPREFS_SIZE	EQU	24*128	;+32

TEMPPREFS_VERSION	EQU	8
TEMPPREFS_MENUPREF	EQU	16*128

	acode
SetMenuPrefs
	BGN
	lea.l	TempPrefs_Head(PC),a0
	cmpi.l	#1,TEMPPREFS_VERSION(a0)
	blo.w	.exit
	cmpi.l	#1,TEMPPREFS_VERSION+4(a0)
	blo.w	.exit
	move.l	PathBuf_PTR,a0
	lea.l	TEMPPREFS_MENUPREF(a0),a0



	lea.l	MT_Flag1,a2
	bsr	SetMPStat
	move.l	d0,AutoUpdate_DrPos+4

	lea.l	MT_Flag2,a2
	bsr	SetMPStat
	move.l	d0,AutoUpdate_NextLine+4

	lea.l	MT_Flag3,a2
	bsr	SetMPStat
	move.l	d0,AutoUpdate_Spectrum+4

	lea.l	MT_Flag4,a2
	bsr	SetMPStat
	move.l	d0,AutoUpdate_Scopes+4

	lea.l	MT_Flag5,a2
	bsr	SetMPStat
	move.l	d0,InstrUpdate

	lea.l	MT_Flag6,a2
	bsr	SetMPStat
	move.b	d0,ForceUpdate

	lea.l	MT_Flag7,a2
	bsr	SetMPStat
	move.b	d0,AutoActWindow

	lea.l	MT_Flag8,a2
	bsr	SetMPStat
	move.b	d0,FORCEKNACK

	IFEQ DEMO
	lea.l	MT_Flag9,a2
	bsr	SetMPStat
	move.b	d0,PACKSONG

	lea.l	MT_Flag10,a2
	bsr	SetMPStat
	move.w	d0,PACKSAMPLE
	ENDC

	lea.l	MT_Flag11,a2			;2.4f rel 4
	bsr	SetMPStat
	move.b	d0,FASTGFX

.exit	RET





	acode
SetMPStat
	move.b	(a0)+,d0
	move.b	(a0)+,d1
	tst.b	d0
	bne.s	.do
	moveq	#1,d0
	rts
.do	move.b	d1,1(a2)
	cmpi.b	#" ",d1
	bne.s	.set
	moveq	#FALSE,d0
	rts
.set	moveq	#TRUE,d0
	rts

	acode
MakeMenuPrefs	;v1.1
	BGN
	move.l	PathBuf_PTR,a0
	lea.l	TEMPPREFS_MENUPREF(a0),a0
	
	lea.l	AutoUpdate_DrPos+4,a1
	bsr	AddMPStat
	lea.l	AutoUpdate_NextLine+4,a1
	bsr	AddMPStat
	lea.l	AutoUpdate_Spectrum+4,a1
	bsr	AddMPStat
	lea.l	AutoUpdate_Scopes+4,a1
	bsr	AddMPStat
	lea.l	InstrUpdate,a1
	bsr	AddMPStat
	lea.l	ForceUpdate,a1		;byte !!
	bsr	AddMPStat
	lea.l	AutoActWindow,a1	;b
	bsr	AddMPStat
	lea.l	FORCEKNACK,a1		;b
	bsr	AddMPStat	
	lea.l	PACKSONG,a1
	bsr	AddMPStat
	lea.l	PACKSAMPLE,a1
	bsr	AddMPStat
	lea.l	FASTGFX,a1		;FASTGFX
	bsr	AddMPStat


	move.b	#FALSE,(a0)+
	RET


AddMPStat
	move.b	#" ",d0
	tst.b	(a1)
	beq.s	.ok
	move.b	#"+",d0
.ok	move.b	#TRUE,(a0)+
	move.b	d0,(a0)+
	rts	

	acode
LoadTempPrefs
	BGN

	move.l	#MODE_OLDFILE,d2
	move.l	#TempPrefs_TXT,d1
	DOS	Open(a6)
	tst.l	d0
	beq.w	.openfail
	move.l	d0,EasyDHandle

	lea.l	TempPrefs_Head(PC),a0
	move.l	a0,d2
	moveq	#32,d3
	move.l	EasyDHandle,d1
	moveq	#0,d0
	DOS	Read(a6)
	tst.l	d0
	bmi.w	.readfail

	lea.l	TempPrefs_Head(PC),a0
	cmpi.l	#"STMP",(a0)
	bne	.readfail
	cmpi.l	#"PREF",4(a0)
	bne	.readfail

	move.w	16(a0),GUILook			;GUI Look

	move.l	PathBuf_PTR,a0
	move.l	#TEMPPREFS_SIZE,d3
	move.l	a0,d2
	move.l	EasyDHandle,d1
	moveq	#0,d0
	DOS	Read(a6)
	tst.l	d0
	bmi.s	.readfail

	lea.l	TempPrefs_Head(PC),a0		;Set Screen Mode
	cmpi.w	#1,30(a0)
	bne	.wbmode

	;lea.l	ScrModeRequest_PTR,a1
	;move.l	20(a0),8(a1)
	;moveq	#0,d0
	;move.w	24(a0),d0
	;move.l	d0,40(a1)
	;move.w	26(a0),d0
	;move.l	d0,48(a1)
	;move.w	28(a0),d0
	;move.l	d0,56(a1)

.wbmode
	bsr	SetMenuPrefs

	move.l	EasyDHandle,d1
	DOS	Close(a6)
	RET

.readfail
	move.l	EasyDHandle,d1
	DOS	Close(a6)
.openfail
.err	jsr	InitPathBuf
	RET

SaveTempPrefs
	BGN
	move.l	#1,TempPrefs_Head+TEMPPREFS_VERSION
	move.l	#1,TempPrefs_Head+TEMPPREFS_VERSION+4

	bsr	MakeMenuPrefs

	move.l	#MODE_NEWFILE,d0
	move.l	#TempPrefs_TXT,d1
	jsr	EasyDOpen
	tst.l	d0
	beq.s	.exit

	lea.l	TempPrefs_Head(PC),a0

	move.w	GUILook,16(a0)

	moveq	#32,d0
	jsr	EasyDWrite

	move.l	PathBuf_PTR,a0
	move.l	#TEMPPREFS_SIZE,d0
	jsr	EasyDWrite

	jsr	EasyDClose
.exit	RET

PathBuf_PTR	dc.l	0,TEMPPREFS_SIZE,PUPMEM

TempPrefs_Head	dc.b	"STMPPREF"
		dc.l	1,1		;1.1: 24*128 Size
		dc.l	0,0,0,0		;+16 GUI Defs
					;Screenmode defs



PBUFID_SAMPLE	EQU	0
PBUFID_SONG	EQU	1
PBUFID_MOD	EQU	2
PBUFID_SBANK	EQU	3
PBUFID_DSP	EQU	4
PBUFID_RENDER	EQU	5
;PBUFID_	EQU	6



	acode
ClearTempProj
	puts	a0
	move.l	TempProjName,a0
	clr.b	(a0)
	gets	a0
	rts

	acode
InitPathBuf
	BGN
	lea.l	SampleDir_TXT,a0	;0 SAMPLE
	move.l	PathBuf_PTR,a1
	jsr	CopyString

	lea.l	SongDir_TXT,a0	;1 SONG
	lea.l	256(a1),a1
	jsr	CopyString

	lea.l	ModuleDir_TXT,a0	;2 MODULE
	lea.l	256(a1),a1
	jsr	CopyString

	lea.l	SongDir_TXT,a0	;3 SAMPLEBANK
	lea.l	256(a1),a1
	jsr	CopyString

	lea.l	DSPPLUG_Dir,a0	;4 DSP
	lea.l	256(a1),a1
	jsr	CopyString

	lea.l	SampleDir_TXT,a0	;5 RENDER
	lea.l	256(a1),a1
	jsr	CopyString
	RET

	acode
SetTempProj:
	BGN
	move.l	FileNameRT_PTR,a0
	move.l	TempProjName,a1
	jsr	CopyString
	RET

	acode
GetTempProj:
	BGN
	move.l	TempProjName,a0
	move.l	ProjectName_PTR,a2
	tst.b	(a0)
	beq.s	.exit
	move.l	FileNameRT_PTR,a1
	jsr	CopyString
.exit	RET

	acode
GetPathBuf:	;I(D0W)(NUMB)
	puts	d0/a0
	move.w	d0,PathBufID
	move.l	PathBuf_PTR,a0
	lsl.l	#8,d0
	lea.l	(a0,d0.w),a0
	jsr	SetFileRequestPath
	lea.l	128(a0),a0
	move.l	FileNameRT_PTR,a1
	jsr	CopyString
	gets	d0/a0
	rts

	acode
SavePathBuf:
	puts	d0/a0-a1
	move.w	PathBufID,d0
	move.l	PathBuf_PTR,a0
	lsl.l	#8,d0
	lea.l	(a0,d0.w),a1
	jsr	GetReqPath
	jsr	CopyString
	move.l	FileNameRT_PTR,a0
	lea.l	128(a1),a1
	jsr	CopyString
	gets	d0/a0-a1
	rts

	acode
SavePathOnlyBuf:
	puts	d0/a0-a1
	move.w	PathBufID,d0
	move.l	PathBuf_PTR,a0
	lsl.l	#8,d0
	lea.l	(a0,d0.w),a1
	jsr	GetReqPath
	jsr	CopyString

	;jsr	ClearTempProj
	gets	d0/a0-a1
	rts


	acode
NewLoadSample	;V1.0
		;I(D0W)(TYPE)
	BGN
	lea.l	NewLoadSample_INFO,a5

	jsr	GetActualInstrName
	move.l	a0,NLSINFO_ACTUALINAME(a5)
	cmpi.b	#MULTISAMPLE_STEREOR,SAMPLENAME_MULTI(a0)
	beq.w	NewLoadSample_X

	move.w	d0,NLSINFO_TYPE(a5)
	cmpi.w	#NLSAMPLE_NEW,d0
	bne.s	NewLoadSample_KeepName

	lea.l	All_MATCH,a0
	jsr	SetFileRequestPat

	moveq	#PBUFID_SAMPLE,d0
	jsr	GetPathBuf

	lea.l	LoadNewSample_TXT,a0
	jsr	SimpleFileRequest
	jsr	SavePathBuf

	tst.w	d0
	beq.w	NewLoadSample_X
	jsr	KillActualInstr

	

	move.l	FinalFileNameRT_PTR,a0
	move.l	NLSINFO_ACTUALINAME(a5),a1
	jsr	CopyString
	move.l	NLSINFO_ACTUALINAME(a5),a0
	jsr	InitSampleName

NewLoadSample_KeepName
	move.l	NLSINFO_ACTUALINAME(a5),a0
	jsr	LoadTempSample
	cmpi.w	#TRUE,d0
	bne.w	NewLoadSample_ERR

NewLoadSample_HUNKIN
	jsr	GetTempSampleBody

	cmpi.w	#16,SAMPLERESOLUTION
	bne.s	NewLoadSample_M
		puts	a5
		move.l	NLSINFO_ACTUALINAME(a5),a5
		bset	#LSFLAGS_16BIT,SAMPLENAME_LSFLAGS(a5)	;for DELTAPACK16
		gets	a5
NewLoadSample_M

	cmpi.w	#NEWST_STEREO,d1
	beq.s	NewLoadSample_Stereo

	move.w	d1,NLSINFO_BODYTYPE(a5)
	move.l	a0,NLSINFO_BODYPTR(a5)
	move.l	d0,NLSINFO_BODYLEN(a5)

	move.l	NLSINFO_ACTUALINAME(a5),a0
	move.b	#MULTISAMPLE_MONO,SAMPLENAME_MULTI(a0)
	bsr	MakeFinalSample
	bra.s	NewLoadSample_X

NewLoadSample_Stereo
	move.w	d1,NLSINFO_BODYTYPE(a5)
	move.l	a0,NLSINFO_BODYPTR(a5)
	lsr.l	#1,d0
	move.l	d0,d7
	move.l	d0,NLSINFO_BODYLEN(a5)
	move.l	NLSINFO_ACTUALINAME(a5),a1
	move.b	#MULTISAMPLE_STEREOL,SAMPLENAME_MULTI(a1)

	move.w	SAMPLERESOLUTION,d6
	bsr	MakeFinalSample
	move.w	d6,SAMPLERESOLUTION


	bsr	MoveNextInstrument
	jsr	GetActualInstrName
	exg	a0,a1
	jsr	CopyString
	move.b	#MULTISAMPLE_STEREOR,SAMPLENAME_MULTI(a1)
	move.l	a1,NLSINFO_ACTUALINAME(a5)
	move.l	NLSINFO_BODYPTR(a5),a0
	add.l	d7,a0
	move.l	a0,NLSINFO_BODYPTR(a5)
	bsr	MakeFinalSample
	jsr	MovePrevInstrument

NewLoadSample_X
	RET
NewLoadSample_ERR
		jsr	PrintActInstrInfo
		ASSTXT ErrTempSample
		jsr	FreeTempSample
	bra.s	NewLoadSample_X

	acode
MakeFinalSample
	;I(A5L)(NLSINFO)
	;O(D0W)(SUCCESS)
	BGNB
	jsr	GetActualSampleManagerEntry
	move.l	a0,a4				;a4:SAMPLEMANE
	move.l	a0,NLSINFO_ACTSAMPLEMANE(a5)
	jsr	FreeSample
	jsr	InitSampleManEntry

	jsr	GetActualInstrument
	move.l	a0,NLSINFO_ACTUALINSTR(a5)
	move.l	a0,a3				;A3L:ACTUAL INSTRUMENT

	move.l	NLSINFO_BODYLEN(a5),d0

	cmpi.w	#8,SAMPLERESOLUTION
	beq.s	NLSResolOk
		lsr.l	#1,d0			;16BITSAMPLE
NLSResolOk
	move.l	d0,SAMPLEMANE_SAMPLENUMB(a4)

	moveq	#0,d2
	move.w	SAMPLEMANE_LN(a4),d2

	cmpi.w	#8,SAMPLERESOLUTION
	beq.s	NLSResolOk2
		lsr.w	#1,d2			;16BITSAMPLE
NLSResolOk2

	move.l	NLSINFO_BODYLEN(a5),d0
	lsl.l	d2,d0				;*2
	IFNE	SYMPHPRO
	lsl.l	#1,d0
	ENDC
	move.l	d0,SAMPLEMANE_SIZE(a4)
	lea.l	SAMPLEMANE_PTR(a4),a0
	jsr	GetMem
	tst.l	d0
	beq.w	MakeFinalSample_ERR

	move.l	NLSINFO_BODYPTR(a5),a0
	move.l	SAMPLEMANE_PTR(a4),a1
	move.l	NLSINFO_BODYLEN(a5),d0
	move.l	EXECBASE,a6			;CopySample
	jsr	-624(a6)

	move.w	#TRUE,SAMPLEMANE_USED(a4)	;Prepare Sample
	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0
	move.w	VexVolumeShift,d1
	move.l	SAMPLEMANE_PTR(a4),a0

	cmpi.w	#16,SAMPLERESOLUTION
	beq.s	NLSResolOk3
		jsr	Convert8to16Bit
NLSResolOk3

	move.w	#8,SAMPLERESOLUTION			;8BIT

	jsr	NewPrepareSample
	move.l	SAMPLEMANE_PTR(a4),a0
	move.l	SAMPLEMANE_SIZE(a4),d0
	add.l	d0,a0

	subq.l	#1,a0					;NEW sym2.5
	IFNE SYMPHPRO
	subq.l	#1,a0
	ENDC
	move.l	a0,SAMPLEMANE_ENDPTR(a4)

	move.l	NLSINFO_ACTUALINAME(a5),SAMPLEMANE_FILENAMEPTR(a4)

	moveq	#0,d0
	moveq	#0,d1
	move.w	#INSTRTYPE_NONE,INSTR_TYPE(a3)
	move.l	d0,INSTR_FREQOFFSET(a3)
	move.w	d1,INSTR_PRIORITY(a3)
	move.l	SAMPLEMANE_SIZE(a4),INSTR_NUMBSAMPLES(a3)
	move.l	SAMPLEMANE_PTR(a4),INSTR_SAMPLEPTR(a3)
	move.l	SAMPLEMANE_ENDPTR(a4),INSTR_SAMPLEENDPTR(a3)
	moveq	#TRUE,d0

	jsr	ForceUpdateActInstrType
	RETB

MakeFinalSample_ERR
	jsr	PrintActInstrInfo
	ASSTXT	ErrTempSample
	moveq	#FALSE,d0
	RETB


InitSampleName	;I(A0L)(SAMPLENAME_PTR)
	BGN
	move.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a1)
	clr.b	SAMPLENAME_LOOPSTART(a1)
	clr.b	SAMPLENAME_LOOPLEN(a1)
	clr.w	SAMPLENAME_LOOPSTARTLO(a1)
	clr.w	SAMPLENAME_LOOPLENLO(a1)
	RET


NEWST_MONO	EQU	0
NEWST_STEREO	EQU	1


GetTempSampleBody	;V1.1
			;O(D0L,D1W,A0L)(BODYLEN[BYTE],TYPE[MONO/STEREO],BODYPTR)

			;V1.1:	AIFF support

	puts	d2-d7/a1-a6
	lea.l	LoadTempSample_MEM(PC),a5

	move.l	MEM_PTR(a5),a0
	move.l	MEM_SIZE(a5),d0

	cmpi.l	#"FORM",(a0)
	bne.w	GetTempSampleBody_WAVE2	;WAVE2 -> NEW
	cmpi.l	#"AIFF",8(a0)
	beq.w	GetTempSampleBody_AIFF
	cmpi.l	#"MAUD",8(a0)
	beq.w	GetTempSampleBody_MAUD
	cmpi.l	#"8SVX",8(a0)
	bne.w	GetTempSampleBody_WAVE

	move.w	#"8 ",aifformat_TXT
	move.l	#"MONO",aifformat_TXT+8
	move.w	#"  ",aifformat_TXT+8+4

	jsr	SearchForIffBody
	cmpi.w	#IFFSAMPLE_STEREO,d1
	bne.s	.mark
		moveq	#NEWST_STEREO,d1
		move.l	#"STER",aifformat_TXT+8
		move.w	#"EO",aifformat_TXT+8+4

.mark	move.l	#"8SVX",NameFormat_TXT+4
	cmpi.b	#TRUE,AUTOLOADSAMPLE
	beq	.skip
	ASSTXT	NameFormat_TXT
.skip	cmpi.w	#IFFSAMPLE_STEREO,d1
	bne.w	GetTempSampleBody_RAW

GetTempSampleBody_X
	gets	d2-d7/a1-a6
	rts

	acode
GetTempSampleBody_AIFF
	moveq	#NEWST_MONO,d1
	move.w	#8,SAMPLERESOLUTION

	move.l	d0,d4			;d4: length

	lea.l	12(a0),a2

.scan_L	move.l	(a2)+,d2
	move.l	(a2)+,d3

	cmpi.l	#"SSND",d2
	beq.s	GetTSAIFF_bodyfound
	
	sub.l	d3,d4
	bmi	GetTempSampleBody_RAW
	lea.l	(a2,d3.l),a2
	bra.s	.scan_L


;	ASSTXT	aif_TXT
	bra	GetTempSampleBody_RAW

	moveq	#NEWST_MONO,d1
	move.w	#8,SAMPLERESOLUTION
	;move.w	#16,SAMPLERESOLUTION			;16BIT
	;moveq	#NEWST_STEREO,d1

GetTSAIFF_bodyfound
	move.l	#"AIFF",NameFormat_TXT+4
	move.w	#"8 ",aifformat_TXT
	move.l	#"MONO",aifformat_TXT+8
	move.w	#"  ",aifformat_TXT+8+4

	cmpi.w	#16,26(a0)
	bne.s	.no16bit
		move.w	#"16",aifformat_TXT
		move.w	#16,SAMPLERESOLUTION	
.no16bit

	move.l	a0,a3
	move.l	d3,d0
	move.l	a2,a0

	cmpi.w	#1,20(a3)
	beq.s	.nostereo
		move.l	#"STER",aifformat_TXT+8
		move.w	#"EO",aifformat_TXT+8+4

		moveq	#NEWST_STEREO,d1	
		jsr	ConvertMaestro
.nostereo
	cmpi.b	#TRUE,AUTOLOADSAMPLE
	beq	GetTempSampleBody_X
	ASSTXT	NameFormat_TXT
	bra	GetTempSampleBody_X

	acode
GetTempSampleBody_MAUD
	cmpi.l	#"MHDR",12(a0)
	bne	GetTempSampleBody_WAVE

	move.w	#"8 ",aifformat_TXT
	move.l	#"MONO",aifformat_TXT+8
	move.w	#"  ",aifformat_TXT+8+4

	moveq	#NEWST_MONO,d1

	move.w	#8,SAMPLERESOLUTION
	cmpi.l	#$00100010,24(a0)
	bne.s	GetTempSB_MAUD8Bit
		move.w	#16,SAMPLERESOLUTION			;16BIT
		move.w	#"16",aifformat_TXT
GetTempSB_MAUD8Bit

	cmpi.w	#$0002,36(a0)
	bne.s	GetTempSB_MAUDmono
		moveq	#NEWST_STEREO,d1
		move.l	#"STER",aifformat_TXT+8
		move.w	#"EO",aifformat_TXT+8+4

GetTempSB_MAUDmono

	moveq	#100,d2
	move.l	a0,a2
GetTempSB_MAUDscan_L
		cmpi.l	#"MDAT",(a2)+
		beq.s	GetTempSB_MAUDBODY
	dbf	d2,GetTempSB_MAUDscan_L
	bra	GetTempSampleBody_RAW


GetTempSB_MAUDBODY

	move.l	(a2)+,d0
	move.l	a2,a0


	bsr	ConvUnsignByteTOSignByte
	puts	d0-d1/a0



	gets	d0-d1/a0



	bsr	ConvertMaestro
;	bra	GetTempSample_Set16Bit

	move.l	#"MAUD",NameFormat_TXT+4
	cmpi.b	#TRUE,AUTOLOADSAMPLE
	beq	.skip
	ASSTXT	NameFormat_TXT
.skip
	bra	GetTempSampleBody_X

GetTempSampleBody_WAVE
	cmpi.l	#"RIFF",(a0)
	bne.s	GetTempSampleBody_RAW
	cmpi.l	#"WAVE",8(a0)
	bne.s	GetTempSampleBody_RAW
	cmpi.l	#"data",$24(a0)
	bne.s	GetTempSampleBody_RAW

	cmpi.w	#$1000,34(a0)
	beq.s	SampleBody_WAVE16Bit


	lea.l	WAVHEAD_SIZE(a0),a0
	subi.l	#WAVHEAD_SIZE,d0


	bsr	ConvUnsignByteTOSignByte

GetTempSampleBody_RAW
	moveq	#NEWST_MONO,d1

	cmpi.l	#"MAES",(a0)
	beq.w	GetTempSample_Maestro

	cmpi.l	#ID16BIT,(a0)
	bne.w	GetTempSampleBody_X

	clr.l	(a0)
GetTempSample_Set16Bit
	move.w	#16,SAMPLERESOLUTION			;16BIT
	bra	GetTempSampleBody_X

SampleBody_WAVE16Bit
	moveq	#NEWST_MONO,d1
	move.w	#16,SAMPLERESOLUTION			;16BIT

	move.l	40(a0),d0
	jsr	LongIntelToMot

	bclr	#0,d0


	cmpi.w	#$0200,22(a0)				;#####
	bne.s	SampleBody_WAVE16Mono
		moveq	#NEWST_STEREO,d1
		bclr	#1,d0
SampleBody_WAVE16Mono



	lea.l	44(a0),a0

	puts	d0-d2/a0
	lsr.l	#1,d0
SampleBodyWAVE_L
		move.w	(a0),d1
			move.w	d1,d2
			lsl.w	#8,d1
			lsr.w	#8,d2
			move.b	d2,d1
		move.w	d1,(a0)+
	subq.l	#1,d0
	bne.s	SampleBodyWAVE_L
	gets	d0-d2/a0

	move.w	#16,SAMPLERESOLUTION			;16BIT
	bsr	ConvertMaestro
	bra	GetTempSampleBody_X


LongIntelToMot
	bsr	WordIntelToMot
	swap	d0
	bsr	WordIntelToMot
	rts

WordIntelToMot
	puts	d1
	move.w	d0,d1
	lsl.w	#8,d0
	lsr.w	#8,d1
	move.b	d1,d0
	gets	d1
	rts



GetTempSampleBody_WAVE2				;WAVE : NEW
	move.w	#"8 ",aifformat_TXT
	move.l	#"MONO",aifformat_TXT+8
	move.w	#"  ",aifformat_TXT+8+4

	lea.l	(a0,d0.l),a4			;end of sample

	cmpi.l	#"RIFF",(a0)
	bne	GetTempSampleBody_RAW
	cmpi.l	#"WAVE",8(a0)
	bne	GetTempSampleBody_RAW

;	ASSTXT	WaveFormat_TXT


	lea.l	12(a0),a0
GetTempSampleBody2_L

	move.l	(a0)+,d2
	move.l	(a0)+,d3	

	move.l	d2,WaveCHNK_ID
	IFNE TESTPRGB
	ASSTXT	WaveCHNK_ID
	ENDC

	bsr	IntelLongToMot_D3

	cmpi.l	#"data",d2
	beq	GetTempSampleBody2_data
	cmpi.l	#"fmt ",d2
	beq	GetTempSampleBody2_format
	cmpi.l	#"fact",d2
	beq	GetTempSampleBody2_unsupported


GetTempSampleBody2_cont
	lea.l	(a0,d3.l),a0
	cmpa.l	a0,a4
	blo	GetTempSampleBody_RAW
	bra.s	GetTempSampleBody2_L	

GetTempSampleBody2_format				;HUNK WAVE fmt
	cmpi.l	#$0e,d3
	bne.s	.ok
	cmpi.l	#"data",16(a0)
	bne.s	.ok
	moveq	#16,d3

.ok	moveq	#NEWST_MONO,d1
	move.w	#8,SAMPLERESOLUTION			;16BIT

	cmpi.w	#$0200,2(a0)
	bne.s	.mono
	move.l	#"STER",aifformat_TXT+8
	move.w	#"EO",aifformat_TXT+8+4

	moveq	#NEWST_STEREO,d1
.mono
	
	cmpi.w	#$0800,14(a0)
	beq.s	.8bit
	move.w	#"16",aifformat_TXT

	move.w	#16,SAMPLERESOLUTION
.8bit

	bra.s	GetTempSampleBody2_cont

GetTempSampleBody2_data					;HUNK WAV data
	move.l	#"WAV ",NameFormat_TXT+4
	cmpi.b	#TRUE,AUTOLOADSAMPLE
	beq	.skip
	ASSTXT	NameFormat_TXT
.skip
	IFNE	TESTPRGB
	ASSTXT	body_TXT
	ENDC
	move.l	d3,d0


	lea.l	(a0,d0.l),a5
	cmpa.l	a5,a4
	bhs.s	.lenok

	move.l	a5,d4
	sub.l	a4,d4
	sub.l	d4,d0
	
	ASSTXT	IllegalSLen_TXT

.lenok	
	cmpi.w	#16,SAMPLERESOLUTION
	beq.s	.conv16
	jsr	ConvIntelTOMotChunk			; convert 8 bit
	bra	GetTempSampleBody_X

.conv16							;16 BIT SAMPLES only
	bclr	#0,d0
	cmpi.w	#NEWST_MONO,d1
	beq.s	.mono
	bclr	#1,d0
.mono
	move.l	d0,d4
	jsr	ConvUnsignByteTOSignByte16
	jsr	ConvertMaestro
	bra	GetTempSampleBody_X

	acode
GetTempSampleBody2_unsupported				;HUNK WAV fact
	ASSTXT	WAVfact_TXT

	bra	GetTempSampleBody2_cont

	acode
ConvUnsignByteTOSignByte16
	BGN
	move.l	d0,d2
	lsr.l	#1,d2
	subq.l	#1,d2

.loop		move.w	(a0),d0

		move.w	d0,d1
		lsl.w	#8,d0
		lsr.w	#8,d1
		move.b	d1,d0

		move.w	d0,(a0)+
	subq.l	#1,d2
	bne.s	.loop
	RET



ConvIntelTOMotChunk
	cmpi.w	#8,SAMPLERESOLUTION
	beq.s	ConvUBtoSB_do
	bra.s	ConvUnsignByteTOSignByte16

ConvUnsignByteTOSignByte
	cmpi.w	#8,SAMPLERESOLUTION
	beq.s	ConvUBtoSB_do
	rts
ConvUBtoSB_do
	puts	d0-d1/a0
	subq.l	#1,d0
.loop		moveq	#0,d1
		move.b	(a0),d1
		subi.w	#128,d1
		move.b	d1,(a0)+
		subq.l	#1,d0
	bne.s	.loop
	gets	d0-d1/a0
	rts

IntelLongToMot_D3
	puts	d0
	move.l	d3,d0
	jsr	LongIntelToMot
	IFNE	TESTPRGB
	jsr	PrintAssHex
	ENDC
	move.l	d0,d3
	gets	d0
	rts


GetTempSample_Maestro
	move.w	#"16",aifformat_TXT
	move.l	#"MONO",aifformat_TXT+8
	move.w	#"  ",aifformat_TXT+8+4

	tst.l	12(a0)
	bne.s	GetTSMaestroMono
		moveq	#NEWST_STEREO,d1
		move.l	#"STER",aifformat_TXT+8
		move.w	#"EO",aifformat_TXT+8+4

GetTSMaestroMono
	puts	d1
	move.l	RenderMaestroHead_ADR,d1
	lea.l	(a0,d1.l),a0
	sub.l	d1,d0
	gets	d1

	move.w	#16,SAMPLERESOLUTION			;16BIT
	bsr	ConvertMaestro
	move.l	#"MAES",NameFormat_TXT+4
	cmpi.b	#TRUE,AUTOLOADSAMPLE
	beq	.skip
	ASSTXT	NameFormat_TXT
.skip

	bra	GetTempSampleBody_X

ConvertMaestro	;16BIT ONLY !!!
		;CONVERT HDR to SEPARATE FORMAT
	cmpi.l	#NEWST_STEREO,d1		;only stereo needed
	beq.s	ConvertMaestroDo
	rts
ConvertMaestroDo
	puts	d0-d7/a0-a3
	move.l	d0,d2
	move.l	a0,a2
	lsr.l	#1,d0
	move.l	d0,TempMaestro+4
	lea.l	TempMaestro(PC),a0
	jsr	GetMem
	tst.l	d0
	beq.s	ConvertMaestro_X

	move.l	d2,d7
	lsr.l	#1,d7
	move.l	a2,a1
	move.l	a2,a0
	move.l	TempMaestro(PC),a3

	cmpi.w	#8,SAMPLERESOLUTION
	beq.s	Convert8BitMaestro_L

	lsr.l	#1,d7
ConvertMaestro_L
		move.l	(a0)+,d0
		move.w	d0,(a1)+
		swap	d0
		move.w	d0,(a3)+
		subq.l	#1,d7
	bne.s	ConvertMaestro_L

ConvertMaestro_EX
	move.l	TempMaestro(PC),a0
	move.l	d2,d0
	lsr.l	#1,d0
	jsr	CopyMemory
	lea.l	TempMaestro(PC),a0
	move.l	#$00010013,MEM_DEBUG_INFO
	move.l	#$00000000,MEM_DEBUG_INFO+4
	jsr	FreeMem
ConvertMaestro_X
	gets	d0-d7/a0-a3
	rts

Convert8BitMaestro_L
		move.w	(a0)+,d0
		move.b	d0,(a1)+
		lsr.w	#8,d0
		move.b	d0,(a3)+
		subq.l	#1,d7
	bne.s	Convert8BitMaestro_L
	bra.s	ConvertMaestro_EX

TempMaestro	dc.l	0,0,FASTMEM

FreeTempSample
	BGN
	lea.l	LoadTempSample_MEM(PC),a0
	tst.l	(a0)
	beq.s	FreeTempSample_X
	move.l	#$00010005,MEM_DEBUG_INFO
	move.l	#$00000003,MEM_DEBUG_INFO+4
	jsr	FreeMem
	clr.l	(a0)
FreeTempSample_X	RET


	acode
LoadTempSample	;I(A0L)(FILENAME_PTR)
		;O(D0W)(SUCCESS:TRUE/FALSE)
	puts	d1-a6
	moveq	#FALSE,d7
	bsr	FreeTempSample

	move.l	a0,a4			;A4:FILENAME
	jsr	FileLength
	move.l	d0,d5			;D5L:FILELENGTH
	beq.s	LoadTempSample_ERR
	
	lea.l	LoadTempSample_MEM(PC),a0
	move.l	d5,MEM_SIZE(a0)
	jsr	GetMem
	tst.l	d0
	beq.s	LoadTempSample_ERR

	move.l	#MODE_OLDFILE,d2
	move.l	a4,d1
	DOS	Open(a6)
	tst.l	d0
	beq.s	LoadTempSample_ERR
	move.l	d0,a5			;A5L:HANDLE
	
	move.l	a5,d1
	move.l	LoadTempSample_MEM(PC),d2
	move.l	d5,d3
	DOS	Read(a6)
	tst.l	d0
	bmi.s	LoadTempSample_ERR2

	move.l	a5,d1
	DOS	Close(a6)

	IFNE	INCXPK
	jsr	UnpackTempSample
	ENDC

	moveq	#TRUE,d7

LoadTempSample_X	move.l	d7,d0
	gets	d1-a6
	rts
LoadTempSample_ERR2
	move.l	a5,d1
	DOS	Close(a6)

LoadTempSample_ERR
	bsr	PrintActInstrInfo
	ASSTXT ErrTempSample2
	bra.s	LoadTempSample_X

PrintActInstrInfo
	BGN
	bsr	GetActualInstrNum
	andi.b	#$ff,d0
	jsr	ConvertToDecByte
	lea	DecByteSave,a0
	move.l	a4,a1
	jsr	PrintDblAssString
	RET

LoadTempSample_MEM	dc.l	0,0,PUPMEM
;RegisterV	dc.l	0			;Security


	IFNE	INCXPK
	acode
UnpackTempSample
	BGN
	lea.l	LoadTempSample_MEM(PC),a0
	jsr	UnpackXPKMem
	RET
	ENDC

	acode
ExportSample
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	CheckInstrument
	cmpi.b	#ISTATE_KILLED,d0
	beq.s	.exit

	lea.l	All_MATCH,a0
	jsr	SetFileRequestPat
	lea.l	Exporttxt,a0

	moveq	#PBUFID_SAMPLE,d0
	jsr	GetPathBuf
	jsr	SimpleFileRequest
	jsr	SavePathBuf
	tst.w	d0
	beq.s	.exit
	jsr	GetActualSampleManagerEntry
	move.l	a0,a2
	move.l	#MODE_NEWFILE,d0
	jsr	EasyDOpenFFN
	tst.l	d0
	beq.s	.exit

	move.l	SAMPLEMANE_PTR(a2),a0
	move.l	SAMPLEMANE_SIZE(a2),d0

	move.l	(a0),d7
	IFNE	SYMPHPRO
	move.l	#"16BT",(a0)
	ENDC
	jsr	EasyDWrite
	jsr	EasyDClose

	move.l	d7,(a0)
.exit	RET

	ENDC

	acode
ReloadActualSample	;V1.0
	BGN
	jsr	GetActualInstrName
	cmpi.b	#MULTISAMPLE_STEREOR,SAMPLENAME_MULTI(a0)
	bne.s	.ok

	jsr	MovePrevInstrument
	moveq	#NLSAMPLE_RELOAD,d0
	bsr	NewLoadSample
	jsr	MoveNextInstrument
	jsr	DrawInstrument
.exit	RET
.ok	moveq	#NLSAMPLE_RELOAD,d0
	bsr	NewLoadSample
	jsr	DrawInstrument
	bra.s	.exit


LoadNewSample	;V1.0
	BGN
	move.b	#FALSE,AUTOLOADSAMPLE
	cmpi.w	#TRUE,Shift_KEY
	beq.s	.ChangeSample

	moveq	#NLSAMPLE_NEW,d0
	bsr	NewLoadSample
	jsr	DrawActualWave
	jsr	DrawInstrName
.exit	move.b	#TRUE,AUTOLOADSAMPLE
	RET

.ChangeSample
	lea.l	All_MATCH,a0
	jsr	SetFileRequestPat
	lea.l	SampleDir_TXT,a0
	jsr	SetFileRequestPath
	lea.l	ReselectSample_TXT,a0
	moveq	#PBUFID_SAMPLE,d0
	jsr	GetPathBuf
	jsr	SimpleFileRequest
	jsr	SavePathBuf
	tst.w	d0
	beq.s	.exit
	jsr	GetActualInstrName
	move.l	a0,a1
	move.l	FinalFileNameRT_PTR,a0
	jsr	CopyString
	jsr	ReloadActualSample
	;jsr	DrawActualWave
	;jsr	DrawInstrName
	bra.s	.exit


IFFSAMPLE_MONO		EQU	0
IFFSAMPLE_STEREO	EQU	1


	acode
SearchForIffBody
NewSearchForIffBody	;v2.0
	puts	d2-d7/a2-a6
	moveq	#IFFSAMPLE_MONO,d1
	lea.l	(a0,d0.l),a3
	lea.l	12(a0),a2
	move.l	4(a0),d5
	moveq	#0,d0

.loop	tst.b	(a2)
	bne.s	.Skip		;V2.0
	lea.l	1(a2),a2

.Skip	move.l	(a2)+,d2	
	cmpa.l	a3,a2
	bhs.s	.exit
	cmpi.l	#"BODY",d2
	beq.s	.BF
	cmpi.l	#"VHDR",d2
	beq.s	.BV
	cmpi.l	#"CHAN",d2
	beq.s	.BC
.Cont	move.l	(a2)+,d4
	lea.l	(a2,d4.l),a2
	bra.s	.loop
.exit	gets	d2-d7/a2-a6
	rts
.BC	move.l	4(a2),d4
	andi.l	#6,d4				;2=L, 4=R
	cmpi.l	#6,d4
	bne.s	.Cont
		moveq	#IFFSAMPLE_STEREO,d1
	bra.s	.Cont

.BV	;--- Loop Info, Rate Info ---
	bra.s	.Cont

.BF	move.l	(a2),d0
	lea.l	4(a2),a0
	bra.s	.exit


WAVHEAD_SIZE	EQU	11*4





	IFNE	INCXPK

	acode
UnpackXPKFile	;I(A0L,A1L)
		;O(D0L)(UNPACK:TRUE/FALSE)
	puts	d1-a6
	move.l	a0,.XPKTags+4
	move.l	a1,.XPKTags+4+8
	tst.l	_XpkBase
	beq.s	.nounpack
	
	lea.l	.XPKTags(PC),a0
	CALLXPK	Unpack
	tst.l	d0
	bne.s	.nounpack

	moveq	#TRUE,d0
	bra.s	.exit
.nounpack	moveq	#FALSE,d0
.exit	gets	d1-a6
	rts
.XPKTags
	dc.l	XPK_InName,0
	dc.l	XPK_OutName,0
	dc.l	XPK_GetError,XPKErrMsg
	dc.l	TAG_DONE

	acode
UnpackXPKMem	;I(A0L)(MEMPTR)
	BGN
	tst.l	_XpkBase
	beq.s	UnpackXPKMem_FinalX
	move.l	a0,a5
	
UnpackXPK_redo
	move.l	4(a5),d0
	move.l	(a5),a0
	cmpi.l	#"XPKF",(a0)
	beq.s	UnpackXPK_do
;	cmpi.l	#"PP20",(a0)
;	beq.s	UnpackXPK_do
	bra.s	UnpackXPKMem_FinalX

UnpackXPK_do
	move.l	a0,XPKTags+4
	move.l	d0,XPKTags+4+8
	lea.l	XPKTags(PC),a0
	CALLXPK	Unpack
	tst.l	d0
	bne.s	UnpackXPKMem_ERR

	move.l	a5,a0
	move.l	#$00010014,MEM_DEBUG_INFO
	move.l	#$00000000,MEM_DEBUG_INFO+4
	jsr	FreeMem
	move.l	a5,a0
	move.l	XPK_UNPACKEDLEN,MEM_SIZE(a0)
	jsr	GetMem
	tst.l	d0
	beq.s	UnpackOutMem_ERR

	move.l	XPK_UNPACKEDLEN(PC),d0
	move.l	XPKBuffer_PTR(PC),a0
	move.l	(a5),a1
	jsr	CopyMemory
	bsr	FreeXPKBuffer
UnpackXPKMem_X
	bra	UnpackXPK_redo


UnpackXPKMem_FinalX

	RET

UnpackOutMem_ERR
	ASSTXT	XPKErrMsg2
	bsr	FreeXPKBuffer
	bra.s	UnpackXPKMem_FinalX

UnpackXPKMem_ERR
	ASSTXT	XPKErrMsg
	bra.s	UnpackXPKMem_FinalX

FreeXPKBuffer
	BGN
	move.l	XPKBuffer_PTR,a1
	move.l	XPKBuffer_LEN,d0
	tst.l	d0
	beq.s	FreeXPKBuffer_X
	CALLEXEC	FreeMem
FreeXPKBuffer_X	clr.l	XPKBuffer_LEN
	RET
	ENDC

XPK_UNPACKEDLEN	dc.l	0

XPKBuffer_LEN	dc.l	0
XPKBuffer_PTR	dc.l	0

XPKTags
	IFNE	INCXPK
	dc.l	XPK_InBuf,0				;PTR to PACKED DATA
	dc.l	XPK_InLen,0				;LENGTH

	dc.l	XPK_GetOutBuf,XPKBuffer_PTR		;OUTPUT
	dc.l	XPK_GetOutBufLen,XPKBuffer_LEN

	dc.l	XPK_GetOutLen,XPK_UNPACKEDLEN		;UNPACKED DATA LENGTH
	dc.l	XPK_GetError,XPKErrMsg
	
	dc.l	TAG_DONE

	ENDC


;--- DRAW WAVE REGION -------------------------------------------------


	acode
GetWaveArea	;V1.1
		;O(D0W-D3W,A1L,A5L)(XYWH,RP,NGW)
	puts	a0
	move.l	#"WINS",d0
	move.l	#"SWAV",d1
	jsr	NGGetInnerAreaData
	cmp.l	#0,a0
	beq.s	.zero
	cmp.l	#0,a5
	beq.s	.zero
	tst.l	(a5)
	beq.s	.zero
.exit	gets	a0
	rts
.zero	suba.l	a1,a1
	bra.s	.exit	


	acode
DrawActualWave	;V1.2
	BGN
	jsr	NGCheckWaveSizeOk
	tst.b	d7
	bne	.exit

	lea.l	Test_INSTRMAN,a2
	move.w	INSTRMAN_ACTUALNUMB(a2),d2
	move.l	SAMPLEMANLIST_PTR,a3
	mulu	#SAMPLEMANE_SIZEOF,d2
	lea.l	(a3,d2.l),a3

	clr.w	OLDSAPOL_LINE

	cmpi.w	#TRUE,SAMPLEMANE_USED(a3)
	bne	.err2

	move.l	SAMPLEMANE_PTR(a3),a0
	move.l	SAMPLEMANE_SIZE(a3),d4	
	tst.l	d4
	beq	.err2
	cmp.l	#0,a0
	beq	.err2
	
	;--- NGWIN ---
	bsr	GetWaveArea
	cmp.l	#0,a1
	beq	.err
	jsr	NGRDarkAPen

	puts	a0
	jsr	GetActualInstrName
	cmpi.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a0)
	beq.s	.nrm
	btst	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	beq.s	.nrm
	;--- NG SAMPLELOOP ---
	puts	d4
	move.w	d2,d4	;View correction to 3/4
	lsr.w	#2,d2
	sub.w	d2,d4
	move.w	d4,d2
	gets	d4
	bra.s	.nrm2
.nrm	move.b	#FALSE,QuickLoopRedraw
.nrm2	gets	a0

	cmpi.b	#TRUE,QuickLoopRedraw
	beq.s	.qck
	bsr	NGDrawWave
.qck	bsr	DrawLoopRange
	bsr	DrawInstrFilterStatus

.exit	RET

.err	bsr	BGClearWaveB
	IFNE TESTPRGB
	ASSTXT .txt
	ENDC
	bra.s	.exit

.err2	bsr	BGClearWaveB
	IFNE TESTPRGB
	ASSTXT .txt2
	ENDC
	bra.s	.exit

	IFNE TESTPRGB
.txt	dc.b	"DrawActualWave:RP Error",0
.txt2	dc.b	"DrawActualWave:No Sample Error",0
	ENDC


	acode
DrawInstrFilterStatus	;V1.1
	BGN
	jsr	GetActualInstrName
	tst.b	(a0)
	beq	.exit
	move.l	a0,a2
	tst.b	SAMPLENAME_RESOFILTERNUMB(a2)
	beq	.exit
	tst.b	SAMPLENAME_RESOFILTERFLAGS(a2)
	beq	.exit

	move.w	#"LP",ResoFilter_TXT
	btst	#1,SAMPLENAME_RESOFILTERFLAGS(a2)
	beq.s	.lp
	move.w	#"HP",ResoFilter_TXT

.lp	moveq	#0,d0
	move.b	SAMPLENAME_RESOFILTER(a2),d0
	lea.l	ResoFilter_TXT+5,a0
	jsr	AddString3Word2
	moveq	#0,d0
	move.b	SAMPLENAME_RESOFILTER+1(a2),d0
	lea.l	ResoFilter_TXT+10,a0
	jsr	AddString3Word2
	moveq	#0,d0
	move.b	SAMPLENAME_RESOFILTER+2(a2),d0
	lea.l	ResoFilter_TXTb+2,a0
	jsr	AddString3Word2
	moveq	#0,d0
	move.b	SAMPLENAME_RESOFILTER+3(a2),d0
	lea.l	ResoFilter_TXTb+7,a0
	jsr	AddString3Word2

	bsr	GetWaveArea
	cmp.l	#0,a1
	beq	.exit
	jsr	NGRDarkAPen
	jsr	NGRNrm0DrMd
	clr.b	ResoFilter_TXTb
	cmpi.b	#1,SAMPLENAME_RESOFILTERNUMB(a2)
	beq.s	.fpt1
	move.b	#"-",ResoFilter_TXTb
.fpt1	lea.l	ResoFilter_TXT,a0
	jsr	NGRDrawTextXYGadFC
	addq.w	#1,d0
	jsr	NGRDrawTextXYGadFC

.exit	RET
ResoFilter_TXT	dc.b	"LPF (000 r000)"
ResoFilter_TXTb	dc.b	"-(000 r000)",0


	acode
NGLimitYDraw
	puts	d1
	bsr	NGLimitY
	jsr	GFX_Draw
	gets	d1
	rts

	acode
NGLimitYPixel
	puts	d1
	bsr	NGLimitY
	jsr	GFX_WritePixel
	gets	d1
	rts


	acode
NGLimitYMove
	puts	d1
	bsr	NGLimitY
	jsr	GFX_Move
	gets	d1
	rts

	acode
NGLimitY
	puts	d4-d7
	movem.w	NGDrawLimits,d4-d7
	cmp.w	d1,d5
	bhi.s	.toolowy
	cmp.w	d1,d7
	blo.s	.toohighy
	bra.s	.inrange	
.toohighy
	move.w	d7,d1
	bra.s	.inrange
.toolowy
	move.w	d5,d1
	bra	.inrange

.inrange
	gets	d4-d7
	rts	

NGSetDrawLimits
	movem.w	d0-d1,NGDrawLimits
	movem.w	d2-d3,NGDrawLimits+4
	add.w	d0,NGDrawLimits+4
	add.w	d1,NGDrawLimits+6
	rts
NGDrawLimits	dc.w	0,0,0,0

	acode
BGClearWave:	;V1.0
	BGN
	;move.l	#"WINS",d0
	;move.l	#"SWAV",d1
	;jsr	NGRClearAreaID

	;move.l	NGArea_NGWIN(a0),a5
	;movem.w	NGArea_XYWH(a0),d0-d3
	moveq	#NGRBACKCLASS_AREA,d4
	jsr	NGRDrawBack
	RET

BGClearWaveB:	;V1.0
	BGN
	move.l	#"WINS",d0
	move.l	#"SWAV",d1
	jsr	NGRClearAreaID
	RET

	IFNE TESTPRGB

	acode
NGDrawTestWave:	;V2.0 NG
		;I(D0W-D3W,D4L,A1,A5)(XYWH,DATA,RP,NGWIN)
	BGN
	RET
	bsr	GetWaveArea
	cmp.l	#0,a1
	beq	.exit
	jsr	NGRDarkAPen


	move.l	#100,d4
	lea.l	.testdata,a0


	moveq	#100,d7

.draw	bsr	.drawpixel
	dbf	d7,.draw
.exit	RET

.drawpixel	;high speed !!!

	move.l	a5,a1
	move.w	d7,d0
	move.w	d7,d1
	GFX	WritePixel(a6)
	rts

.graphW	dc.l	0
.testdata
	dc.l	0

	ENDC

	acode
NGCheckWaveSizeOk	;O(D0=0 : OK)
	puts	d0-d6/a0-a6
	move.l	#"WINS",d0
	move.l	#"SWAV",d1
	jsr	NGGetInnerAreaData
	cmpi.w	#40,d2
	blo.s	.ill
	cmpi.w	#6,d3
	blo.s	.ill
	cmp.l	#0,a1
	beq.s	.ill
	moveq	#0,d7
.exit	gets	d0-d6/a0-a6
	rts
.ill	moveq	#-1,d7
	bra.s	.exit

	acode
NGDrawWave:	;V2.0 NG
		;I(D0W-D3W,D4L,A1,A5)(XYWH,DATA,RP,NGWIN)
	puts	d0-d7
	bsr	NGCheckWaveSizeOk
	tst.b	d7
	bne.s	.toosmall

	bsr	BGClearWave
	move.l	d0,d7

	bsr	NGSet1PMask
	jsr	NGRDarkAPen
	jsr	NGRNrm0DrMd
	exg	d0,d7
	bsr	.draw
	exg	d0,d7
	bsr	NGSetPMask
.toosmall
	gets	d0-d7
	rts

.draw	BGN
	move.l	d4,a4
	andi.l	#$ffff,d2
	move.l	d2,.graphW
	subq.w	#1,d2
	bmi	.err

	bsr	NGSetDrawLimits
	lsr.w	#1,d3			;h/2 faktor
	add.w	d3,d1
	move.w	d1,d5			;y Mitte

	move.l	NGSampleBoost,d6	;divisor
	beq	.exit
	;--- faktoren korrektur ---
	mulu	#328,d6
	divu	#200,d6
	lsr.w	#1,d3	

	move.w	(a0),d1
	muls	d3,d1
	divs	d6,d1
	add.w	d5,d1

	movem.w	d3/d6/d5,DrawWaveInfo

	bsr	NGLimitYMove
	moveq	#0,d4

	tst.b	WaveStyle
	beq.s	.fline
	cmpi.b	#3,WaveStyle
	beq.s	.line
	bra.s	.pixel

.line	move.l	a4,d7
	mulu.l	d4,d7
	divu.l	.graphW,d7
	lsr.l	#1,d7			;16 BIT SAMPLES

	move.w	(a0,d7.l*2),d1
	muls	d3,d1
	divs	d6,d1
	add.w	d5,d1
	bsr	NGLimitYDraw

	addq.w	#1,d0			;xpos
	addq.w	#1,d4			;counter ( 0 = first)
	dbf	d2,.line
	bra	.exit


.fline
	lsr.w	#1,d2
	beq	.exit

.loop	move.l	a4,d7
	mulu.l	d4,d7
	divu.l	.graphW,d7
	lsr.l	#1,d7			;16 BIT SAMPLES

	move.w	(a0,d7.l*2),d1
	muls	d3,d1
	divs	d6,d1
	add.w	d5,d1
	bsr	NGLimitYDraw

	addq.w	#2,d0			;xpos
	addq.w	#2,d4			;counter ( 0 = first)
	dbf	d2,.loop
	bra	.exit

.pixel	move.l	a1,a5
	move.l	a0,a3
	cmpi.b	#2,WaveStyle
	beq.s	.hirespixel

	move.l	a4,d7
	lsr.l	#2,d7
	move.l	d7,a4
.ploop	;--- 4xPixel ---
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	addq.w	#1,d0			;xpos
	dbf	d2,.ploop
.exit	RET

.hirespixel
	move.l	a4,d7
	lsr.l	#4,d7
	move.l	d7,a4

.hipixl	
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	bsr	.drawpixel
	addq.w	#1,d0
	dbf	d2,.hipixl
	bra.s	.exit


	acode
.drawpixel	;high speed !!!
	move.l	a4,d7
	mulu.l	d4,d7
	divu.l	.graphW,d7
	lsr.l	#1,d7			;16 BIT SAMPLES
	move.w	(a3,d7.l*2),d1
	muls	d3,d1
	divs	d6,d1
	add.w	d5,d1
	bsr	NGLimitY
	CHECKREG3 a1,drawpixel,.exit
	puts	d0
	move.l	a5,a1
	GFX	WritePixel(a6)
	gets	d0
	addq.w	#1,d4
	rts

.err	
	IFNE TESTPRGB
	ASSTXT	.txt
	ENDC
	bra	.exit
	IFNE TESTPRGB
.txt	dc.b	"DrawActualWave: illegal Width",0	
	ENDC

	acode
.graphW		dc.l	0

DrawWaveInfo	dc.w	0,0,0



	acode
GFX_SetWrMsk
	move.b	d0,24(a1)
	rts

	acode
Set1PMask:
	tst.b	FASTGFX
	bpl	.exit
	;move.b	24(a1),WrMsk_BAK
	;move.b	#1,24(a1)
.exit	rts

	acode
Set2OnlyPMask:
	;move.b	#3,24(a1)
	rts

	acode
Set2PMask:
	;move.b	24(a1),WrMsk_BAK
	;move.b	#3,24(a1)
	;tst.b	FASTGFX
	;bpl.s	.exit
	;move.b	#1,24(a1)
.exit	rts

	acode
SetOldPMask:
	;tst.b	FASTGFX
	;bpl.s	.exit
	;move.b	WrMsk_BAK,24(a1)
.exit	rts

WrMsk_BAK	dc.b	0



	acode
NGSet1PMask:	;I(A1L)(RP)
		;O(D0B)(OLDMASK)
	;tst.b	FASTGFX
	;bpl.s	.exit
	move.b	24(a1),d0
	move.b	#1,24(a1)
.exit	rts

NGSetPMask	;I(A1L,D0B)(RP,MASK)
	move.b	d0,24(a1)
	rts


	acode
DrawLoopRange	;V2.0 NG
		;I(D0W,D1W,D2W,D3W,D4L,A0L,A1L)(XYWH,LEN,PTR)
	BGN
	bsr	NGCheckWaveSizeOk
	tst.b	d7
	bne.s	.exit

	move.l	#"WINS",d0
	move.l	#"SWAV",d1
	jsr	NGGetInnerAreaData
	cmp.l	#0,a5
	beq	.exit
	cmp.l	#0,a1
	beq	.exit

	;move.w	#-1,VertLine_Info
	jsr	GetActualInstrName
	cmpi.b	#INSTRTYPE_NONE,SAMPLENAME_INSTRTYPE(a0)
	beq.s	.exit

	btst	#LSFLAGS_NEWLOOP,SAMPLENAME_LSFLAGS(a0)
	beq.s	.old

	bsr	DrawNewLoopRange
	bra.s	.exit

.old	move.b	#FALSE,QuickLoopRedraw
	bsr	DrawOldLoopRange
.exit	move.b	#FALSE,QuickLoopRedraw
	RET

;--- NEW LOOP RANGE ------------------------------------------------

	acode
ClearNewLoopRange
	BGN
	move.l	#"WINS",d0
	move.l	#"SWAV",d1
	jsr	NGGetInnerAreaData
	move.w	d2,d5
	lsr.w	#2,d2
	add.w	d2,d0
	add.w	d2,d0
	add.w	d2,d0
	sub.w	d2,d5
	sub.w	d2,d5
	sub.w	d2,d5
	move.w	d5,d2
	bsr	BGClearWave
	RET



FLICKERFREELOOP	EQU	0

	acode
DrawNewLoopRange:	;V1.0
	BGN
	IFEQ FLICKERFREELOOP
	bsr	ClearNewLoopRange
	ENDC
	puts	d0
	bsr	NGSet1PMask
	bsr	.DrawNewLoopDetail
	bsr	NGSetPMask
	gets	d0

	cmpi.b	#TRUE,QuickLoopRedraw
	bne.s	.slow
	bsr	InvertOldLoopRect
.slow	bsr	DrawNewLoopRec
	RET

	acode
.DrawNewLoopDetail	;V1.1
	BGN
	move.l	a0,a2
	jsr	GetNewLoop
	move.l	d0,d6
	move.l	d1,d7
	move.l	#"WINS",d0
	move.l	#"SWAV",d1
	jsr	NGGetInnerAreaData
	jsr	NGRDarkAPen
	jsr	NGRNrm0DrMd
	IFNE FLICKERFREELOOP
	bsr	.ClearVLinePrep
	ENDC
	puts	d1/d3
	;--- Mini Range Berechnen ---
	add.w	d2,d0
	lsr.w	#3,d2   ;             d0
	sub.w	d2,d0	;|----|----|..|..|

	;--- d7 = Anzahl Linien ---
	move.w	d2,d7
	subq.w	#2,d7
	bmi.s	.exit
	tst.w	d7
	beq.s	.exit

	jsr	GetActualInstrument
	move.l	a0,a2
	move.l	INSTR_SAMPLELOOPSTART(a2),a3
	move.l	INSTR_SAMPLELOOPENDPTR(a2),a4
	lea.l	2(a4),a4	;16 BIT
	addq.w	#1,d0
	movem.w	DrawWaveInfo,d4/d6/d5

	move.l	a1,a5
	move.l	_GraphicsBase,a6

	;--- RECHTS(START)---
	puts	d0/d7
.loop	move.w	(a3)+,d1
	muls	d4,d1
	divs	d6,d1
	add.w	d5,d1
	bsr	.LDrawVLine
	addq.w	#1,d0
	dbf	d7,.loop
	gets	d0/d7

	subq.w	#1,d0
	;--- LINKS(END) ---
.loop2	move.w	-(a4),d1
	subq.w	#1,d0
	muls	d4,d1
	divs	d6,d1
	add.w	d5,d1
	bsr	.LDrawVLine
	dbf	d7,.loop2
	gets	d1/d3

	add.w	d1,d3
	move.w	d3,d5
	bsr	.LDrawVLine
.exit	RET


;.xLDrawVLine	;I(D0,D1,D5)(X,Y,Y2)
;	puts	d0-d1
;	move.w	d0,d2
;	move.l	a5,a1
;	jsr	Move(a6)
;	move.w	d5,d1
;	move.w	d2,d0
;	move.l	a5,a1
;	jsr	Draw(a6)
;	gets	d0-d1
;	rts

.LDrawVLine	;I(D0,D1,D5)(X,Y,Y2)
	IFNE FLICKERFREELOOP
	bsr	.ClearVLine
	ENDC
	puts	d0-d1/d3
	move.w	d0,d2
	move.w	d5,d3
	cmp.w	d1,d3
	bhs.s	.ok
	exg	d1,d3
.ok	move.l	a5,a1
	jsr	RectFill(a6)
	gets	d0-d1/d3
	rts

	IFNE FLICKERFREELOOP
.ClearVLinePrep	;I(D0W)(X)
	puts	d0-d3
	move.l	a1,.ClearVLInfo
	move.l	a5,.ClearVLInfo+4
	add.w	d1,d3
	movem.w	d1/d3,.ClearVLInfo+8	
	gets	d0-d3
	rts
.ClearVLInfo	dc.l	0,0,0,0


.ClearVLine	;I(D0W)(X)
	puts	d0-d3/a5
	move.l	.ClearVLInfo+4,a5
	move.l	.ClearVLInfo,a1
	jsr	NGRBackAPen

	move.w	d0,d2
	movem.w	.ClearVLInfo+8,d1/d3
	jsr	RectFill(a6)

	move.l	.ClearVLInfo+4,a5
	move.l	.ClearVLInfo,a1
	jsr	NGRDarkAPen
	gets	d0-d3/a5
	rts
	ENDC

	acode
DrawNewLoopRec
	BGN
	move.w	d2,d4
	lsr.w	#2,d4
	sub.w	d4,d2
	bmi.s	.exit

	jsr	GetActualInstrument
	move.l	a0,a2
	jsr	NGRInvDrMd
	jsr	NGRDarkAPen

	move.l	INSTR_SAMPLEPTR(a2),d4
	move.l	INSTR_SAMPLELOOPSTART(a2),d7
	sub.l	d4,d7
	move.l	INSTR_SAMPLEENDPTR(a2),d5
	sub.l	d4,d5
	
	andi.l	#$ffff,d2
	mulu.l	d2,d6:d7
	divu.l	d5,d6:d7
	add.w	d0,d7
	swap	d0
	move.w	d7,d0
	swap	d0

	move.l	INSTR_SAMPLELOOPENDPTR(a2),d7
	sub.l	d4,d7
	
	mulu.l	d2,d6:d7
	divu.l	d5,d6:d7
	add.w	d0,d7

	swap	d0
	move.w	d7,d2

	add.w	d1,d3
	move.l	_GraphicsBase,a6
	movem.l	d0-d3/a1/a6,OldLoopInv
	GFX	RectFill(a6)
.exit	RET

	acode
InvertOldLoopRect:	;V1.0
	BGN
	movem.l	OldLoopInv,d0-d3/a1/a6
	cmp.l	#0,a1
	beq.s	.exit
	jsr	NGRInvDrMd
	jsr	NGRDarkAPen
	movem.l	OldLoopInv,d0-d3/a1/a6
	GFX	RectFill(a6)
.exit	RET

OldLoopInv
	blk.l	16,0



;--- OLD LOOP RANGE ----------------------------------------------
	
	acode
DrawOldLoopRange
	BGN
	move.l	a0,a2

	moveq	#0,d6
	move.b	SAMPLENAME_LOOPSTART(a0),d6
	moveq	#0,d7
	move.b	SAMPLENAME_LOOPLEN(a0),d7

	;--- NGWIN ---
	move.l	#"WINS",d0
	move.l	#"SWAV",d1
	jsr	NGGetInnerAreaData

	mulu	d2,d6
	divu	#100,d6
	mulu	d2,d7
	divu	#100,d7

	move.w	d7,d2
	add.w	d6,d0
	add.w	d0,d2
	jsr	NGRDarkAPen
	jsr	NGRInvDrMd
	add.w	d1,d3
	move.l	_GraphicsBase,a6
	puts	d0-a6
	GFX	RectFill(a6)
	gets	d0-a6


	sub.w	d1,d3
	lsr.w	#1,d3
	add.w	FONT_BASE,d1	
	move.w	d2,d4
	add.w	d0,d4
	lsr.w	#1,d4
	addq.w	#2,d0

	;--- LOOP BEREICHE ANSCHREIBEN ---
	moveq	#0,d2
	move.b	SAMPLENAME_LOOPSTART(a2),d2
	jsr	NGRNrm0DrMd
	jsr	DrawDecByteXY
	addq.w	#1,d0
	jsr	DrawDecByteXY
	move.b	SAMPLENAME_LOOPLEN(a2),d2
	add.w	d3,d1
	move.w	d4,d0
	jsr	DrawDecByteXY
	addq.w	#1,d0
	jsr	DrawDecByteXY
.exit	RET







;--- SAMPLE MANAGER --------------------------------------------------





SAMPLEMANE_USED		EQU	0
SAMPLEMANE_OVERSAMPLING	EQU	2
SAMPLEMANE_LN		EQU	4

SAMPLEMANE_PTR		EQU	6
SAMPLEMANE_SIZE		EQU	10	;LONG Samplelength in Bytes
SAMPLEMANE_MEMTYPE	EQU	14

SAMPLEMANE_FILENAMEPTR	EQU	18
SAMPLEMANE_PITCH	EQU	22	;;;to remove !!!
SAMPLEMANE_FINETUNE	EQU	24	;;;to remove !!!

SAMPLEMANE_SAMPLENUMB	EQU	26	;Numb of Samples
SAMPLEMANE_ENDPTR	EQU	30	;LONG

SAMPLEMANE_ORGPTR		EQU	34
SAMPLEMANE_ORGSIZE		EQU	38	;LONG Samplelength in Bytes
SAMPLEMANE_INFO			EQU	42	;BYTE: COPY OF SAMPLENAME_INFO

SAMPLEMANE_SIZEOF	EQU	56



	acode
InitSampleManagement:	;V1.0
		;(I)(A0L)(FIRST SAMPLEMAN_ENTRY)
	BGN
	move.l	#MaxNumb_Samples-1,d7
	moveq	#SAMPLEMANE_SIZEOF,d6
.loop		bsr	InitSampleManEntry
		lea.l	(a0,d6.l),a0
	dbf	d7,.loop
	RET

	acode
InitSampleManEntry:	;V1.0
		;(I)(A0L)(SAMPLEMAN_ENTRY)
	BGN
	move.w	#FALSE,SAMPLEMANE_USED(a0)
	move.w	Sample_STANDARD,SAMPLEMANE_OVERSAMPLING(a0)
	move.w	Sample_STANDARD+2,SAMPLEMANE_LN(a0)
	move.w	Sample_STANDARD+4,SAMPLEMANE_PITCH(a0)
	move.w	Sample_STANDARD+6,SAMPLEMANE_FINETUNE(a0)

	clr.l	SAMPLEMANE_PTR(a0)
	clr.l	SAMPLEMANE_SIZE(a0)
	move.l	#SAMPLEMAN_MEMTYPE,SAMPLEMANE_MEMTYPE(a0)
	clr.l	SAMPLEMANE_SAMPLENUMB(a0)
	RET
Sample_STANDARD	dc.w	2,1
		dc.w	24
		dc.w	100


GetActualSampleManagerEntry:	;V1.0
	;I()
	;O(A0L)(SampleManager_Entry PTR)
	move.l	d0,-(a7)
	bsr	GetActualInstrNum
	move.l	SAMPLEMANLIST_PTR,a0
	mulu	#SAMPLEMANE_SIZEOF,d0
	lea.l	(a0,d0.l),a0
	move.l	(a7)+,d0
	rts

GetSampleManagerEntry:		;V1.0
	;I(D0W)(Sample #)
	;O(A0L)(SampleManager_Entry PTR)
	move.l	d0,-(a7)
	move.l	SAMPLEMANLIST_PTR,a0
	mulu	#SAMPLEMANE_SIZEOF,d0
	lea.l	(a0,d0.l),a0
	move.l	(a7)+,d0
	rts



;INSTRUMENT STRUCTURES




INSTRMAN_ACTUAL		EQU	0	;obsolete ?
INSTRMAN_FIRST		EQU	4
INSTRMAN_ENTRYSIZE	EQU	8	;WORD

INSTRMAN_ACTUALNUMB	EQU	10	;WORD [0..n-1]
INSTRMAN_MAXNUMB	EQU	12	;n-1




INSTR_TYPE		EQU	0
INSTR_PRIORITY		EQU	2	;UNUSED
INSTR_FREQOFFSET	EQU	4
INSTR_SAMPLEPTR		EQU	8
INSTR_NUMBSAMPLES	EQU	12	;LONG 	real, nicht raw !
INSTR_SAMPLEENDPTR	EQU	16	;LONG

INSTR_SAMPLELOOPSTART	EQU	20	;LONG	INSTRTYPE_LOOP
INSTR_SAMPLELOOPENDPTR	EQU	24	;LONG

INSTR_LOOPNUMB		EQU	28
INSTR_SAMPLESUSTSTART	EQU	30	;LONG	INSTRTYPE_LOOP
INSTR_SAMPLESUSTENDPTR	EQU	34	;LONG

INSTR_MULTI		EQU	38	;WORD
INSTR_FINETUNE		EQU	42	;SIGNED WORD
INSTR_TUNE		EQU	44	;SIGNED WORD
INSTR_PLAYFLAG		EQU	46	;FLAGS : WORD
INSTR_PREPINFO		EQU	48	;FLAGS : BYTE BIT0:FORCED DOWNSAMPLE DONE 0=NO
INSTR_PREPDS		EQU	49	;FLAGS : BYTE NUMB +DOWNSAMPLES

INSTR_SAMPLEPOS		EQU	60	;ACTUAL SAMPLE POSITION

;INSTR_INFO		EQU	50	;BYTE: COPY OF SAMPLENAME_INFO


INSTR_SIZEOF		EQU	64






	acode
MoveFirstInstrument
	puts	a0
	lea.l	Test_INSTRMAN(PC),a0
	clr.w	INSTRMAN_ACTUALNUMB(a0)
	gets	a0
	rts

	acode
SaveInstrumentNum
	puts	a0
	lea.l	Test_INSTRMAN(PC),a0
	move.w	INSTRMAN_ACTUALNUMB(a0),ActualInstrumentNum
	gets	a0
	rts

	acode
LoadInstrumentNum
	cmpi.w	#-1,ActualInstrumentNum
	bne.s	.ok
	rts
.ok	puts	a0
	lea.l	Test_INSTRMAN(PC),a0
	move.w	ActualInstrumentNum,INSTRMAN_ACTUALNUMB(a0)
	gets	a0
	rts

	acode
InitInstrList:	;V1.1
	BGN
	lea.l	FastIHandle_INSTRLIST,a1
	move.l	#MaxNumb_Samples-1,d7

.loop	move.l	a0,(a1)+
	move.w	#INSTRTYPE_KILL,INSTR_TYPE(a0)
	lea.l	INSTR_SIZEOF(a0),a0
	dbf	d7,.loop
	move.l	#-1,(a1)
	RET

	acode
GetActualInstrument	;V1.0
			;O(A0L)(INSTR_PTR)
	puts	d0
	lea.l	Test_INSTRMAN(PC),a0
	move.w	INSTRMAN_ACTUALNUMB(a0),d0
	mulu	#INSTR_SIZEOF,d0
	move.l	FirstEntry_INSTR,a0
	lea.l	(a0,d0.l),a0
	gets	d0
	rts

	acode
GetInstrument	;V1.0
		;I(D0W)(INSTR#)
		;O(A0L)(INSTR_PTR)
	puts	d0
	mulu	#INSTR_SIZEOF,d0
	move.l	FirstEntry_INSTR,a0
	lea.l	(a0,d0.l),a0
	gets	d0
	rts

	acode
GetActualInstrName	;V1.0
	puts	d0
	move.l	SampleNames_PTR,a0
	jsr	GetActualInstrNum
	mulu	#SampleNameMaxLen,d0
	lea.l	(a0,d0.l),a0
	gets	d0
	rts

	acode
GetActualInstrNum	;V1.0
			;O(D0W)(INSTRNUM)
	puts	a0
	lea.l	Test_INSTRMAN(PC),a0
	move.w	INSTRMAN_ACTUALNUMB(a0),d0
	gets	a0
	rts

	acode
GotoInstrNum	;V1.0
	puts	d0-d1
	exg	d0,d1
	bsr	GetActualInstrNum
	cmp.w	d0,d1
	beq.s	.exit
	exg	d0,d1
	bsr	SetActualInstrNum
	jsr	DrawInstrument
.exit	gets	d0-d1
	rts

	acode
SetActualInstrNum	;V1.0
			;I(D0W)(INSTRNUM)
	puts	a0
	lea.l	Test_INSTRMAN(PC),a0
	move.w	d0,INSTRMAN_ACTUALNUMB(a0)
	gets	a0
	rts

	acode
MoveNextInstrument	;V1.0
	puts	d0/a0
	lea.l	Test_INSTRMAN(PC),a0
	move.w	INSTRMAN_ACTUALNUMB(a0),d0
	cmp.w	INSTRMAN_MAXNUMB(a0),d0
	beq.s	.exit
		addq.l	#4,INSTRMAN_ACTUAL(a0)
		addq.w	#1,INSTRMAN_ACTUALNUMB(a0)
.exit	gets	d0/a0
	rts

MovePrevInstrument	;V1.0
	puts	a0
	lea.l	Test_INSTRMAN(PC),a0
	tst.w	INSTRMAN_ACTUALNUMB(a0)
	beq.s	.exit
		subq.l	#4,INSTRMAN_ACTUAL(a0)
		subq.w	#1,INSTRMAN_ACTUALNUMB(a0)
.exit	gets	a0
	rts


	;--- SAMPLE PREP BEGIN -----------------------------------


KNACKSTEPSMAX	EQU	2000
KNACKMAXVOL	EQU	1024
KNACKDIVLN	EQU	10

ToogleForceAKnack
	eori.b	#-1,FORCEKNACK
	rts

SetKnackDeepth
	BGN
	moveq	#0,d1
	move.l	#KNACKSTEPSMAX,d2
	lea.l	KNACKSTEPS(PC),a0
	lea.l	KnackDeep_TXT,a1
	jsr	ReqMinMaxLong
	RET

	even

AKTYPE	dc.b	0	;0=NRM, 1=VIRT

	acode
AntiKnack16	;V1.4
		;I(D0L,A0L)(SAMPLES,SRC=DEST)
		;1.2:	REWRITTEN -> FINER ANTIKNACK ALGORITHM
		;	NOW HIGH KNACKSTEPS POSSIBLE
		;	SMALL SAMPLES : NO ANTIKNACK (MEM TRASHING)
		;1.3:	ADJUSTABLE ANTI-KNACK LENGTH
		;1.4:   New ALGORITHMUS
	BGN

	lea.l	(a0,d0.l*2),a1


	move.l	KNACKSTEPS,d6
	cmpi.l	#8,d6
	blo.w	AntiKnack16_X
	
	cmp.l	d6,d0
	blo.s	AntiKnack16_X

	subq.w	#1,d6
	move.w	d6,d7


	subq.w	#1,d7	
	bmi.s	AntiKnack16_X


	moveq	#1,d5
	move.l	#$7fff,d4
	divu	d6,d4
	moveq	#15,d2

	move.l	d7,KNACKLEN

	cmpi.b	#FALSE,FORCEKNACK
	bne.s	AntiKnack16_do1

	tst.w	(a0)
	beq.s	AntiKnack16_M

AntiKnack16_do1
	clr.w	(a0)+

AntiKnack16_L1	move.w	(a0),d1
		move.w	d5,d3
		mulu	d4,d3
		muls	d3,d1
		asr.l	d2,d1		
		move.w	d1,(a0)+
		addq.w	#1,d5
	dbf	d7,AntiKnack16_L1

AntiKnack16_M
	move.l	a1,a0
	tst.b	AKTYPE
	bne.s	ForceAKOut
	cmpi.b	#FALSE,FORCEKNACK
	bne.s	ForceAKOut
	tst.w	-2(a0)
	beq.s	AntiKnack16_X

ForceAKOut
	move.l	KNACKLEN,d7
	moveq	#1,d5
	clr.w	-(a0)

AntiKnack16_L2	
		move.w	-(a0),d1
		move.w	d5,d3
		mulu	d4,d3
		muls	d3,d1
		asr.l	d2,d1		
		move.w	d1,(a0)
		addq.w	#1,d5
	dbf	d7,AntiKnack16_L2
AntiKnack16_X	RET

	acode
MaximizeSample16to100	;V1.0
		;I(D0L,A0L)(SAMPLES,SRC=DEST)
	BGN
	moveq	#100,d5
	bra.s	MaximizeSample16_in

	acode
MaximizeSample16	;V2.0
		;I(D0L,A0L)(SAMPLES,SRC=DEST)
	BGN
	puts	a0
	jsr	GetActualInstrName
	moveq	#0,d5
	move.b	SAMPLENAME_VOLUME(a0),d5
	gets	a0

MaximizeSample16_in	bsr	GetSampleRange16

	andi.l	#$ffff,d1
	andi.l	#$ffff,d2
	tst.w	d1
	bpl.s	MaximizeSample16_M1
		neg.w	d1
MaximizeSample16_M1

	tst.w	d2
	bpl.s	MaximizeSample16_M2
		neg.w	d2
MaximizeSample16_M2

	cmp.w	d2,d1
	bhi.s	MaximizeSample16_M3
		exg	d2,d1
MaximizeSample16_M3

	bsr	BoostSample16

MaximizeSample16_X	
	RET

BOOSTLIMIT16	EQU	31000
BOOSTFACBASE	EQU	32000
NOISELIMIT	EQU	20


	acode
PrintHexBlock
	BGN
	move.w	d0,d1
.loop	move.l	(a0)+,d0
	jsr	PrintAssHex
	dbf	d1,.loop
	RET

NGMAXIMUM	EQU	$7fff


	acode
PrintAssDec	jmp	WriteAssDecLong


	acode
BoostSample16	;V1.0 NGSampleboost
		;I(D0L,D1W,D3W,D4W,A0L)(SAMPLES,MAXVALUE,SAMPLEVOLUME,GLOBALVOL,SRC)
	BGN
	clr.w	.CompStatus
	move.l	d0,d7
	move.l	a0,a5

	moveq	#100,d3
	tst.w	d5
	bne.s	.volok
	moveq	#100,d5

.volok	move.w	d5,d3

	cmpi.w	#100,d3
	bls.s	.volok2

	move.w	d3,.CompStatus
	subi.w	#100,.CompStatus

	moveq	#100,d3
	moveq	#100,d5

.volok2	move.l	NGSampleBoost,d4

	;DEBUG
	tst.w	d1
	bne.s	.ok
	exg	d1,d2
	tst.w	d1
	beq.s	.err
.ok	move.l	a0,a2

	cmpi.l	#NGMAXIMUM,d1
	blo.s	.maxok

	move.l	#NGMAXIMUM,d1
.maxok
	;--- D1 : MAXIMUM 

	move.l	#$7ff0,d2
	mulu	d5,d2
	divu	#100,d2
	mulu	d4,d2
	divu	#10000,d2

	;--- D2 : Faktor

.loop	subq.l	#1,d0
	bmi.s	.exit
	move.w	(a0),d3
	muls	d2,d3
	divs	d1,d3
	move.w	d3,(a0)+
	bra.s	.loop

.exit	move.l	d7,d0
	move.w	d5,d1
	move.l	a5,a0
	tst.w	.CompStatus
	beq.s	.err
	bsr	.DoCompress
	;bsr	ProccessXBoost
.err	RET

.DoCompress	
	BGN

	move.w	.CompStatus,d6
	moveq	#100,d5
	sub.w	d6,d5


	move.l	NGSampleBoost,d7
	mulu	#32767,d7
	divu	#10000,d7
	IFNE TESTPRGB
	jsr	PrintD7
	ENDC

	move.w	d7,d2
	lsr.w	#1,d7

	IFNE TESTPRGB
	jsr	PrintD7
	ENDC

	move.w	d7,d1
	mulu	d5,d1
	divu	#100,d1

	IFNE TESTPRGB
	jsr	PrintD1
	ENDC

	move.w	d2,d4
	sub.w	d1,d4

	IFNE TESTPRGB
	jsr	PrintD4
	ENDC


	;--- PHASE 1 ---
.loop2	subq.l	#1,d0
	bmi.s	.exit2
	move.w	(a0),d3
	bsr	.compword
	move.w	d3,(a0)+
	bra.s	.loop2
.exit2	RET


.compword
	tst.w	d3
	bpl.s	.plus
	neg.w	d3
	bsr	.plus
	neg.w	d3
	rts

.plus	cmp.w	d1,d3
	bhi.s	.upper

	mulu	d4,d3
	divu	d1,d3

	rts

.upper	
	sub.w	d1,d3

	mulu	d1,d3
	divu	d4,d3

	add.w	d4,d3
	rts	

.CompStatus	dc.w	0

	IFNE TESTPRGB
PrintD7
	puts	d0
	move.l	d7,d0
	jsr 	PrintHexLong
	gets	d0
	rts

PrintD1
	puts	d0
	move.l	d1,d0
	jsr 	PrintHexLong
	gets	d0
	rts

PrintD4
	puts	d0
	move.l	d4,d0
	jsr 	PrintHexLong
	gets	d0
	rts
	ENDC



	IFNE	NEWMAXIMIZE
GetSampleRange16	;V1.2
		;I(D0L,A0L)(SAMPLES,SRC=DEST)
		;O(D1W,D2W)(loWORD,hiWORD)
	puts	d0/d3-a6
	subq.l	#1,d0
	bmi.s	GetSampleRange16_X
	move.w	(a0)+,d1
	move.w	d1,d2

GetSampleRange16_L		;D1 lo, D2:hi
	subq.l	#1,d0
	bmi.s	GetSampleRange16_X
	move.w	(a0)+,d3
		cmp.w	d1,d3
		bge.s	GetSampleRange16_LoStays
			move.w	d3,d1
			bra.s	GetSampleRange16_L
GetSampleRange16_LoStays
		cmp.w	d2,d3
		ble.s	GetSampleRange16_L
			move.w	d3,d2
	bra.s	GetSampleRange16_L
GetSampleRange16_X
	gets	d0/d3-a6
	rts

;Convert16to8Bit	;I(D0L,A0L)(SAMPLES,SRC=DEST)
	BGN
	move.l	a0,a1
	moveq	#2,d1
.loop	move.b	(a0),(a1)+
	lea.l	(a0,d1.w),a0
	subq.l	#1,d0
	bne.s	.loop
	RET

;Convert8to16Bit	;I(D0L,A0L)(SAMPLES,SRC=DEST)	;8BIT
	BGN
	move.l	a0,a1
	lea.l	(a0,d0.l),a0
	lea.l	(a1,d0.l*2),a1

.loop		move.b	-(a0),d1
		ext.w	d1
		move.w	d1,-(a1)
	subq.l	#1,d0
	bne.s	.loop
	RET


;AKVIRTSCAN	EQU	
	acode
AntiknackVirt
	BGN
	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0
	move.l	SAMPLEMANE_PTR(a4),a0
AntiknackVirt_L
		tst.w	(a0)+
		bne.s	AntiknackVirt_do
		subq.l	#1,d0
		bne.s	AntiknackVirt_L
	RET
AntiknackVirt_do
	move.w	(a0),d0
	ext.l	d0
	divs	#2,d0
	move.w	d0,-2(a0)
	RET
	

testplace	dc.w	FALSE


	ELSE
GetSampleRange16	;V1.1
		;I(D0L,A0L)(SAMPLES,SRC=DEST)
		;O(D1W,D2W)(loWORD,hiWORD)
	puts	d0/d3-a6
	subq.l	#1,d0
	bmi.s	GetSampleRange16_X
	move.w	(a0)+,d1

	subq.l	#1,d0
	bmi.s	GetSampleRange16_X
	move.w	(a0)+,d2
	cmp.w	d1,d2
	bge.s	GetSampleRange16_L
		exg	d1,d2

GetSampleRange16_L		;D1 lo, D2:hi
	subq.l	#1,d0
	bmi.s	GetSampleRange16_X
	move.w	(a0)+,d3
		cmp.w	d1,d3
		bge.s	GetSampleRange16_LoStays
			move.w	d3,d1
			bra.s	GetSampleRange16_L
GetSampleRange16_LoStays
		cmp.w	d2,d3
		ble.s	GetSampleRange16_L
			move.w	d3,d2
	bra.s	GetSampleRange16_L
GetSampleRange16_X
	gets	d0/d3-a6
	rts

Convert16to8Bit	;I(D0L,A0L)(SAMPLES,SRC=DEST)
	BGN
	move.l	a0,a1
	moveq	#2,d1
.loop	move.b	(a0),(a1)+
	lea.l	(a0,d1.w),a0
	subq.l	#1,d0
	bne.s	.loop
	RET

Convert8to16Bit	;V2.0 I(D0L,A0L)(SAMPLES,SRC=DEST)	;16 BIT
	BGN
	move.l	a0,a1
	lea.l	(a0,d0.l),a0
	lea.l	(a1,d0.l*2),a1
.loop	move.b	-(a0),d1
	ext.w	d1
	asl.w	#7,d1		;V2.0
	move.w	d1,-(a1)
	subq.l	#1,d0
	bne.s	.loop
	RET


;AKVIRTSCAN	EQU	
	acode
AntiknackVirt
	BGN
	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0
	move.l	SAMPLEMANE_PTR(a4),a0
AntiknackVirt_L
		tst.w	(a0)+
		bne.s	AntiknackVirt_do
		subq.l	#1,d0
		bne.s	AntiknackVirt_L
	RET
AntiknackVirt_do
	move.w	(a0),d0
	ext.l	d0
	divs	#2,d0
	move.w	d0,-2(a0)
	RET
	

testplace	dc.w	FALSE
	ENDC





	acode
NewPrepareSample
	BGN
	jsr	GetActualSampleManagerEntry
	move.l	a0,a4
	bsr	NewPrepareSampleIn
	RET

	acode
;NewPrepareSampleIn
;	BGN
;	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0
;	move.l	SAMPLEMANE_PTR(a4),a0
;	jsr	ProcessRvsLineSample		;OK
;	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0
;	move.l	SAMPLEMANE_PTR(a4),a0
;	jsr	ProcessIFiltSample
;	move.w	VexVolumeShift,d1
;	andi.l	#$ffff,d1
;	bsr	AntiKnack16			;OK SWAPPED POS WITH MaximizeSample16
;	bsr	MaximizeSample16		;OK
;	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0	;OK
;	move.l	SAMPLEMANE_PTR(a4),a0
;	jsr	ProcessSampleResonance
;	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0
;	move.l	SAMPLEMANE_PTR(a4),a0
;	jsr	ProcessSampleNFilter		;GURU FIXED
;	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0	;POST DOWNSAMPLE
;	move.l	SAMPLEMANE_PTR(a4),a0
;	jsr	ProcessDownsample		;OK
;	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0	;OK
;	move.l	SAMPLEMANE_PTR(a4),a0
;	tst.l	NoiseFilt
;	beq.s	.skipantialias
;	jsr	AntialiasSample
;.skipantialias
;	jsr	PrepareSample16To8
;	RET


	acode
NewPrepareSampleIn	;V2.0
	BGN
	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0
	move.l	SAMPLEMANE_PTR(a4),a0
	jsr	ProcessRvsLineSample

	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0
	move.l	SAMPLEMANE_PTR(a4),a0
	jsr	ProcessIFiltSample

	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0	;POST DOWNSAMPLE
	move.l	SAMPLEMANE_PTR(a4),a0
	jsr	ProcessDownsample

	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0	;Volume Fade
	move.l	SAMPLEMANE_PTR(a4),a0
	jsr	ProcessVolumeFade

	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0	;Resonanz HP/LP Filter
	move.l	SAMPLEMANE_PTR(a4),a0
	jsr	ProcessResoLPFilter


;	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0	;OK
;	move.l	SAMPLEMANE_PTR(a4),a0
;	jsr	ProcessSampleResonance
;	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0
;	move.l	SAMPLEMANE_PTR(a4),a0
;	jsr	ProcessSampleNFilter		;GURU FIXED



	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0	;OK
	move.l	SAMPLEMANE_PTR(a4),a0
	move.l	NoiseFilt,d7
	puts	a0				;V2.0
	jsr	GetActualInstrName
	moveq	#0,d6
	move.b	SAMPLENAME_FILTER(a0),d6
	gets	a0
	tst.b	d6
	bpl.s	.pos

	moveq	#0,d6
.pos	add.w	d6,d7
	jsr	AntialiasSample

	moveq	#0,d1
	move.w	VexVolumeShift,d1		;V2.0 moved to the end
	bsr	AntiKnack16
	bsr	MaximizeSample16
	jsr	PrepareSample16To8
	RET



	acode
doAnitaliasB	;I(D0L,A0L)(SAMPLES,SAMPLE_PTR)
	BGN
	;FLASH	0ff

	subq.l	#2,d0
	bmi.s	.exit
	move.l	d0,d7

	move.w	(a0),d0
	ext.l	d0

.loop	move.w	(a0),d1
	ext.l	d1
	asl.l	#1,d1
	add.l	d0,d1
	divs.l	#3,d1
	move.w	d1,(a0)+
	move.l	d1,d0

	subq.l	#1,d7
	bpl.s	.loop
.exit	RET


	acode	
AntialiasSample	;V2.1 I(D0L,A0L)(SAMPLES,SAMPLE_PTR)
	;v2.1	addq.l #1,d1 before doing a asr.l #1,d1
	puts	d7
	tst.b	d7
	beq.s	.exit

	subq.l	#1,d7
	bpl.s	.mloop
.exit	gets	d7
	rts

.mloop	bsr	doAnitaliasB
	dbf	d7,.mloop
	bra.s	.exit





	acode
PrepareSample16To8
NGPrepareSample	;V1.0	I: 16BIT SAMPLE
		;	O:  8BIT SAMPLE
		;I(D0L,D1W,A0L)(SAMPLES,VOLUMESHIFT,SRC=DEST)
		;INTERPOLATION ALGORITHMUS
		;TYPE: SIMPLE
	BGN
	lea.l	(a0,d0.l*2),a0
	move.l	a0,a1
	lea.l	(a1,d0.l*2),a1
	subi.l	#2,d0	
	bmi.s	.exit
	move.w	-(a0),d2
	move.w	d2,-(a1)
	ext.l	d2
.loop	move.w	-(a0),d4
	ext.l	d4
	move.l	d4,d3
	add.l	d2,d3
	asr.l	#1,d3
	move.w	d3,-(a1)
	move.w	d4,-(a1)
	move.l	d4,d2
	subq.l	#1,d0
	bpl.s	.loop
	move.w	d4,-(a1)
.exit	RET


	acode
ProcessDownsample	;V1.0	16BIT
			;I(D0L,A0L)(SAMPLES,SRC=DEST)
	BGN
	move.l	a0,a1
	jsr	GetActualInstrument
	move.l	a0,a2
	jsr	GetActualInstrName
	moveq	#0,d7
	move.b	SAMPLENAME_DOWNSAMPLE(a0),d7
	move.l	SAMPLEPreOverS,d6
	add.l	d6,d7
	subq.l	#1,d7
	
	move.l	Actual_FREQDEF,a3
	move.w	FREQLIST_UNITPEROCTAVE(a3),d5
	mulu	d6,d5
	move.w	d5,FREQLIST_OFFSET(a3)

;	move.w	d5,Actual_FREQDEF+FREQDEF_OCTAVE
;	move.l	SAMPLEPreOverS,d6
;	subq.w	#1,d6
;	beq.s	ProcessDownsample_NRM
;	moveq	#0,d5
;	move.b	SAMPLENAME_TUNE(a0),d5
;	PreDownsample_L:
;		add.w	Actual_FREQDEF+FREQDEF_OCTAVE,d5
;		cmpi.w	#24,d5
;		bhi.s	PreDownsample_DONE
;		addq.l	#1,d7
;		move.l	d5,d4
;	dbf	d6,PreDownsample_L
;	PreDownsample_DONE
;	move.b	d4,
;	ProcessDownsample_NRM:

	tst.b	d7
	bmi.s	ProcessDownsample_X
	subq.w	#1,d7
	bmi.s	ProcessDownsample_X
ProcessDownsample_L2
		bsr	ProcessDownsampleDo
	dbf	d7,ProcessDownsample_L2
ProcessDownsample_X	RET

	acode
ProcessDownsampleDo
	BGN
	move.l	d0,d6
	tst.b	d7
	bmi.w	ProcessDownsampleDo_NEG

	lea.l	SAMPLEMANE_PTR(a4),a1

	lea.l	ProcessSampleTemp_PTR(PC),a0

	clr.l	MEM_PTR(a0)
	move.l	MEM_SIZE(a1),d1
	lsl.l	#1,d1
	move.l	d1,MEM_SIZE(a0)
	move.l	MEM_TYPE(a1),MEM_TYPE(a0)
	jsr	GetMem
	tst.l	d0
	beq.s	ERRNoDSMem

	move.l	SAMPLEMANE_SAMPLENUMB(a4),d0
	move.l	d0,d7
	lsl.l	#1,d0
	move.l	d0,SAMPLEMANE_SAMPLENUMB(a4)

	move.l	SAMPLEMANE_PTR(a4),a0
	move.l	ProcessSampleTemp_PTR(PC),a1

	subq.l	#1,d7
	bmi.s	ERRNoDSMem

	move.w	(a0)+,d1
	ext.l	d1
.loop		move.w	d1,(a1)+
		move.w	(a0)+,d2
		ext.l	d2
		add.l	d2,d1
		asr.l	#1,d1
		move.w	d1,(a1)+
		move.l	d2,d1
		subq.l	#1,d7
	bne.s	.loop

	lea.l	SAMPLEMANE_PTR(a4),a0
	move.l	#$00010004,MEM_DEBUG_INFO
	move.l	#$00000000,MEM_DEBUG_INFO+4
	jsr	FreeMem

	lea.l	ProcessSampleTemp_PTR(PC),a1
	move.l	(a1)+,SAMPLEMANE_PTR(a4)
	move.l	(a1)+,SAMPLEMANE_SIZE(a4)	
	move.l	SAMPLEMANE_PTR(a4),d0
	add.l	SAMPLEMANE_SIZE(a4),d0
	subq.l	#SAMPLELENGTHB,d0
	move.l	d0,SAMPLEMANE_ENDPTR(a4)	;PTR TO LAST SAMPLE <> PTR TO PTR+LENGTH
	move.l	(a1)+,SAMPLEMANE_MEMTYPE(a4)	
	RET
ERRNoDSMem
	jsr	PrintActInstrInfo
	ASSTXT ErrNoDSMem_TXT
ProcessDownsampleDo_NEG	RET
ProcessSampleTemp_PTR	dc.l	0,0,FASTMEM


	acode
ProcessRvsLineSample	;V1.0	16BIT
		;I(D0L,A0L)(SAMPLES,SRC=DEST)
	puts	d0-d2/a0-a1
	bsr	ProcessMirrorSample

	move.l	a0,a1
	jsr	GetActualInstrName
	btst	#LSFLAGS_RVS,SAMPLENAME_LSFLAGS(a0)
	beq.s	.exit

	move.l	a1,a0
	add.l	d0,a1
	add.l	d0,a1

	moveq	#SAMPLELENGTH,d2
	lsr.l	#1,d0
.loop	subq.l	#1,d0
	bmi.s	.exit
		move.w	(a0),d1
		move.w	-(a1),(a0)
		move.w	d1,(a1)
		lea.l	(a0,d2.w),a0
	bra.s	.loop
.exit	gets	d0-d2/a0-a1
	rts


RESOFILTER_FREQ		EQU	0
RESOFILTER_RESO		EQU	1
RESOFILTER_SIZEOF	EQU	2

	IFNE NEWFILTER
	acode
ProcessResoLPFilter	;V1.0	16BIT
		;I(D0L,A0L)(SAMPLES,SRC=DEST)
	BGN
	move.l	a0,a1
	jsr	GetActualInstrName

	lea.l	SAMPLENAME_RESOFILTER(a0),a6
	move.b	SAMPLENAME_RESOFILTERFLAGS(a0),d7
	move.b	d7,ResoFilter_FLAGS
	tst.b	d7
	beq.s	.exit
	tst.l	d0
	beq.s	.exit

	btst	#0,d7
	beq.s	.exit
	lsr.b	#1,d7
	bsr	.do
.exit	RET

.do	
	;--- Filter Begin ---
	moveq	#0,d1
	move.b	RESOFILTER_FREQ(a6),d1
	move.l	d1,ResoFilter_DATA
	move.l	d1,ResoFilter_DATA+8
	moveq	#0,d1
	move.b	RESOFILTER_RESO(a6),d1
	move.l	d1,ResoFilter_DATA+4
	move.l	d1,ResoFilter_DATA+12


	cmpi.b	#1,SAMPLENAME_RESOFILTERNUMB(a0)
	beq.s	.static

	;--- Filter End ---
	moveq	#0,d1
	move.b	RESOFILTER_FREQ+2(a6),d1
	move.l	d1,ResoFilter_DATA+8
	moveq	#0,d1
	move.b	RESOFILTER_RESO+2(a6),d1
	move.l	d1,ResoFilter_DATA+12

.static	move.l	d0,ResoFilter_SAMPLES
	bsr	.filter
	rts

.filter	BGN
	moveq	#0,d2
	moveq	#0,d3
	moveq	#0,d4
	moveq	#0,d5
	moveq	#0,d6
.loop	move.w	(a1),d1
	asr.w	#1,d1
	bsr	ResoFilterCalcPara
	bsr	ResoFilter
	move.w	d1,(a1)+
	subq.l	#1,d0
	bne.s	.loop
	RET

ResoFilterCalcPara
	BGN
	;--- FREQ FADE ---
	move.l	ResoFilter_DATA+8,d2
	sub.l	ResoFilter_DATA,d2
	move.l	ResoFilter_SAMPLES,d5
	move.l	d5,d3
	sub.l	d0,d3
	muls.l	d2,d4:d3
	divs.l	d5,d4:d3
	add.l	ResoFilter_DATA,d3
	move.l	d3,ResoFilter_FREQ

	;--- RESO FADE ---
	move.l	ResoFilter_DATA+8+4,d2
	sub.l	ResoFilter_DATA+4,d2
	move.l	ResoFilter_SAMPLES,d5
	move.l	d5,d3
	sub.l	d0,d3
	muls.l	d2,d4:d3
	divs.l	d5,d4:d3
	add.l	ResoFilter_DATA+4,d3
	move.l	d3,ResoFilter_RESO
	RET

ResoFilter
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	ResoFilter_FREQ(PC),d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	ResoFilter_FREQ(PC),d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	move.l	ResoFilter_RESO(PC),d6
	muls.l	d2,d6
	asr.l	#6,d6
	add.l	d6,d2
.noreso
	;d2=LP, D4=HP
	asr.l	#2,d2
	move.l	d2,d1
	btst	#1,ResoFilter_FLAGS
	beq.s	.LP
	move.l	d4,d1
.LP	cmpi.l	#32767,d1
	bgt.s	.setmax
	cmpi.l	#-32767,d1
	blt.s	.setmin
	rts
.setmax	move.w	#32767,d1
	rts
.setmin	move.w	#-32767,d1
	rts

ResoFilter_SAMPLES dc.l	0
ResoFilter_FREQ	dc.l	0
ResoFilter_RESO	dc.l	0
ResoFilter_DATA	dc.l	0,0,0,0
ResoFilter_FLAGS dc.b	0




	acode
ProcessVolumeFade
		;V1.0	16BIT
		;I(D0L,A0L)(SAMPLES,SRC=DEST)
	BGN
	move.l	a0,a1
	jsr	GetActualInstrName
	cmpi.b	#2,SAMPLENAME_VFADESTATUS(a0)
	bne.s	.exit
	bsr	.do
.exit	RET

.do	
	;--- Filter Begin ---
	moveq	#0,d1
	move.b	SAMPLENAME_VFADEBGN(a0),d1
	mulu	#327,d1
	move.l	d1,ResoFilter_DATA

	moveq	#0,d1
	move.b	SAMPLENAME_VFADEEND(a0),d1
	mulu	#327,d1
	move.l	d1,ResoFilter_DATA+8

	move.l	d0,ResoFilter_SAMPLES
	bsr	.go
	rts

.go	BGN

.loop	move.w	(a1),d1
	bsr	.CalcPara
	bsr	.ProcessSample
	move.w	d1,(a1)+
	subq.l	#1,d0
	bne.s	.loop
	RET

.CalcPara
	BGN
	;--- FREQ FADE ---
	move.l	ResoFilter_DATA+8,d2
	sub.l	ResoFilter_DATA,d2
	move.l	ResoFilter_SAMPLES,d5
	move.l	d5,d3
	sub.l	d0,d3
	muls.l	d2,d4:d3
	divs.l	d5,d4:d3
	add.l	ResoFilter_DATA,d3
	move.l	d3,.Param1
	RET
.Param1	dc.l	0

.ProcessSample
	move.l	.Param1,d2
	muls	d2,d1
	divs	#32700,d1
	rts

	ENDC

	acode
ProcessMirrorSample	;V1.0	16BIT
		;I(D0L,A0L)(SAMPLES,SRC=DEST)
	puts	a0-a1
	move.l	a0,a1
	jsr	GetActualInstrName
	btst	#LSFLAGS_MIRROR,SAMPLENAME_LSFLAGS(a0)
	beq.s	.exit
	move.l	a1,a0
	bsr	InvertSample
.exit	gets	a0-a1
	rts

InvertSample	;V1.0
	puts	d0-d1/a0
.loop	subq.l	#1,d0
	bmi.s	.exit
		move.w	(a0),d1
		neg.w	d1
		move.w	d1,(a0)+
	bra.s	.loop
.exit	gets	d0-d1/a0
	rts


MINSCANRANGE	EQU	256	;Samples
MAXSAMPLEAMP	EQU	$7fff
MINSAMPLEAMP	EQU	MAXSAMPLEAMP/2
SAMPLELENGTH	EQU	2	;16BIT

MakeD0WPos
	tst.w	d0
	bmi.s	DoMakeD0WPos
	rts
DoMakeD0WPos
	neg.w	d0
	rts

	acode
ProcessIFiltSample	;V1.0	16BIT
			;I(D0L,A0L)(SAMPLES,SRC=DEST)
	BGN
	lea.l	IFiltSample(PC),a6
	;move.l	NoiseFilt,d6
	move.l	a0,a1
	jsr	GetActualInstrName
	moveq	#0,d7
	move.b	SAMPLENAME_FILTER(a0),d7

	;add.l	d6,d7	
	tst.l	d7
	beq.s	.exit
	tst.b	d7
	bpl.s	.exit
;	bpl.s	.GO
		ext.w	d7
		neg.w	d7
		lea.l	NegIFiltSample(PC),a6
.GO	move.l	a1,a0
	subq.w	#1,d7

.loop		jsr	(a6)
	dbf	d7,.loop

.exit	RET


	acode
IFiltSample	;V2.1	16BIT
		;I(D0L,A0L)(SAMPLES,SRC=DEST)
	puts	d0-d2/d4/a0
	subq.l	#4,d0
	bmi.s	.exit
	tst.l	d0
	beq.s	.exit
	moveq	#1,d4
	move.w	(a0),d2
	ext.l	d2

.loop		move.l	d2,d1
		move.w	(a0),d2
		;ext.l	d1
		ext.l	d2
		add.l	d1,d2
		asr.l	d4,d2
		move.w	d2,(a0)+

	subq.l	#1,d0
	bne.s	.loop
.exit	gets	d0-d2/d4/a0
	rts

	acode
ShrinkSample	;V1.0 I(D0L,A0L)(SAMPLES,SRC=DEST)
	puts	d0-d3/a1
	tst.l	d0
	beq.s	.exit
	moveq	#1,d3
.loop	move.w	(a1),d2
	asr.w	d3,d1
	move.w	d2,(a1)+
	subq.l	#1,d0
	bne.s	.loop
.exit	gets	d0-d3/a1
	rts

	acode
NegIFiltSample	;V1.0
		;I(D0L,A0L)(SAMPLES,SRC=DEST)
	bsr	ShrinkSample
	puts	d0-a6
	tst.l	d0
	beq.s	.exit

		moveq	#1,d3			;Filto Depth
		moveq	#1,d4
		move.w	(a1),d2
.loop		move.w	d2,d1
		move.w	(a1),d2
		ext.l	d1
		ext.l	d2
		asr.l	d3,d1
		sub.l	d1,d2
		asr.l	d4,d2
		move.w	d2,(a1)+
	subq.l	#1,d0
	bne.s	.loop
.exit	gets	d0-a6
	rts




SAMPLEBOOST_LB	EQU	8

	;--- SAMPLE PREP END -----------------------------------------

	acode
FreeAllSamples	;V1.0
	BGN
	move.l	#MaxNumb_Samples-1,d7
.loop	bsr	FreeSample
		lea.l	SAMPLEMANE_SIZEOF(a0),a0
	dbf	d7,.loop
	RET

FreeSample	;V1.01
		;(I)(A0L)(SAMPLEMAN_ENTRY)
	BGN
	cmpi.w	#FALSE,SAMPLEMANE_USED(a0)
	beq.s	.exit
		move.w	#FALSE,SAMPLEMANE_USED(a0)
		lea.l	SAMPLEMANE_PTR(a0),a0
	move.l	#$00010004,MEM_DEBUG_INFO
	move.l	#$00000003,MEM_DEBUG_INFO+4
		jsr	FreeMem
.exit	RET


	acode
FileLength	;v1.0
		;I(A0L)(FILENAME)
		;O(D0L)LENGTH)
	BGNB
	move.l	a0,d1

	move.l	#ACCESS_READ,d2		

	DOS	Lock(a6)
	move.l	d0,d1
	move.l	d0,d6
	tst.l	d0
	beq.s	FileLengthERR

	move.l	FLInfo_PTR(PC),d2
	DOS	Examine(a6)				
	move.l	FLInfo_PTR(PC),a0
	move.l	124(a0),d7
	move.l	d6,d1
	DOS	UnLock(a6)		

	move.l	d7,d0
FileLengthX
	RETB
FileLengthERR
	moveq	#0,d0
	ASSTXT ErrNoFileLen
	bra.s	FileLengthX

FLInfo_PTR	dc.l	0,512,FASTMEM

	acode
FreeFile	;V1.0
		;I(D0L)(FILEMANAGER)
	BGN
	tst.l	d0
	beq.s	FreeFileX
		subi.l	#12,d0
		move.l	d0,a0
		lea.l	LoadFile_PTR(PC),a0
	move.l	#$00010015,MEM_DEBUG_INFO
	move.l	#$00000000,MEM_DEBUG_INFO+4
		jsr	FreeMem		
FreeFileX	RET

	acode
LoadFile	;V1.0
		;I(A0L)(FileName)
		;O(D0L)(FILE_PTR:FILEMANAGER)
		BGNB
		move.l	a0,a2		;A2:FILENAME
		bsr	FileLength
		move.l	d0,d4		;D4:FILELEN
		beq.s	LoadFileERR

		addi.l	#12,d4
		move.l	d4,LoadFile_PTR+4
		subi.l	#12,d4

		lea.l	LoadFile_PTR(PC),a0
		jsr	GetMem
		tst.l	d0
		beq.s	LoadFileERR

		lea.l	LoadFile_PTR(PC),a0	;A3:FILE_PTR
		move.l	(a0),a3 			;copy memheader (size etc.)
		move.l	(a0)+,(a3)+
		move.l	(a0)+,(a3)+
		move.l	(a0)+,(a3)+

		move.l	a2,d1
		move.l	#MODE_OLDFILE,d2
		DOS	Open(a6)
		move.l	d0,a4			;A4:HANDLE
		beq.s	LoadFileERR
			move.l	a4,d1 		;FILEHANDLE
			move.l	a3,d2 		;BUFFER
			move.l	d4,d3 		;LENGTH
			DOS	Read(a6)
		move.l	a4,d1
		DOS	Close(a6)

		move.l	A3,d0

LoadFileX	RETB

LoadFile_PTR	dc.l	0,0,FASTMEM

LoadFileERR	moveq	#0,d0
		jsr	WarnFlash
		bra.s	LoadFileX

	acode
ClrFileName
	BGN
	move.w	#512-1,d0
.loop	clr.b	(a0)+
	dbf	d0,.loop
	RET

	acode
CopyInstrName
	puts	d0/a0-a1
	move.w	#SampleNameMaxLen-1,d0
.loop	move.b	(a0)+,(a1)+
	dbf	d0,.loop
	gets	d0/a0-a1
	rts
	acode
SetEditJump
	BGN
	lea.l	JumpLen(PC),a0
	move.l	(a0),d7
	lea.l	EditJump_TXT,a1
	moveq	#1,d1
	move.l	VEX_LinesPerPattern,d2
	subq.l	#1,d2
	jsr	ReqMinMaxLong
	RET

	acode
KeyPosNumDown	;V1.0
	puts	a0
	lea.l	PosNumDown,a0
	jsr	DecShiftRepeat
	jsr	DrawEventStatus
	gets	a0
	rts

	acode
KeyPosNumUp
	puts	a0
	lea.l	PosNumUp,a0
	jsr	DecShiftRepeat
	jsr	DrawEventStatus
	gets	a0
	rts

	acode
KeyPatNumDown
	puts	a0
	lea.l	PatternDown,a0
	jsr	DecShiftRepeat
	jsr	PattedUpdateDisp
	jsr	DrawEventStatus
	gets	a0
	rts

	acode
KeyPatNumUp
	puts	a0
	lea.l	PatternUp,a0
	jsr	DecShiftRepeat
	jsr	PattedUpdateDisp
	jsr	DrawEventStatus
	gets	a0
	rts



	acode
PatternDown	;V1.2
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	jsr	GetActualPattEd
	move.l	PATTED_ACTUALSONGDATA(a0),a1
	move.w	POSITION_PATNUM(a1),d0
	tst.w	d0
	beq.s	.exit

		subq.w	#1,d0
		move.w	d0,POSITION_PATNUM(a1)
		subi.l	#PATHEAD_SIZEOF,POSITION_PATHEADPTR(a1)

.exit	cmpi.b	#TRUE,MACROPROCESS
	beq.s	.nogfx
	jsr	PattedUpdateDisp
	jsr	UpdatePosList

.nogfx	jsr	PatEdCrsrOn
	RET
	ENDC

	acode
PatternUp	;V1.2
	IFNE	DEMO
	rts
	ELSE
	BGN
	jsr	HideBlockRange
	jsr	PatEdCrsrOff
	jsr	GetActualPattEd
	move.l	PATTED_ACTUALSONGDATA(a0),a1
	move.w	POSITION_PATNUM(a1),d0
	move.l	VEX_PattNumb,d1
	subq.w	#1,d1
	cmp.w	d1,d0
	beq.s	.exit

		addq.w	#1,d0
		move.w	d0,POSITION_PATNUM(a1)
		addi.l	#PATHEAD_SIZEOF,POSITION_PATHEADPTR(a1)

.exit	cmpi.b	#TRUE,MACROPROCESS
	beq.s	.nogfx
	jsr	PattedUpdateDisp
	jsr	UpdatePosList

.nogfx	jsr	PatEdCrsrOn
	RET
	ENDC

	IFEQ DEMO
	acode
KeySwapRecordState
	BGN
	bsr	SwapRecordState
	bsr	DrawRecordStatus
	RET
	ENDC

DrawRecordStatus
	puts	d0-d1
	move.w	RECORD_STATUS,d1
	move.l	#"SE01",d0
	jsr	NGSetGadBool
	gets	d0-d1
	rts

SwapRecordState	
	IFEQ	DEMO
	eori.w	#-1,RECORD_STATUS
	jsr	ShowMainTitle
	ENDC
	rts
RECORD_STATUS
	dc.w	FALSE,TRUE



	IFEQ DEMO
	acode
Space	BGN
	jsr	GetPEDRP
	cmp.l	#0,a1
	beq.s	.exit
	jsr	HideBlockRange
	jsr	ProcessInstrPaint
.exit	RET
	ENDC

	acode
DownInstr	;V1.1
	BGN
	jsr	GetActualInstrNum
	tst.w	d0
	beq.s	.exit
	moveq	#1-1,d0
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.loop
	moveq	#10-1,d0
.loop	jsr	MovePrevInstrument
	jsr	DrawActualWave
	dbf	d0,.loop
	jsr	DrawInstrName
	IFNE SMALLGUI
	jsr	DrawInstrument
	ENDC
.exit	RET

	acode
UpInstr		;V1.1
	BGN
	moveq	#1-1,d0
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.loop
	moveq	#10-1,d0
.loop	jsr	MoveNextInstrument
	jsr	DrawActualWave
	dbf	d0,.loop
	jsr	DrawInstrName
	IFNE SMALLGUI
	jsr	DrawInstrument
	ENDC
	RET

	acode
TrackLenUp	;V1.0
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a1
	moveq	#1,d0
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.m
	moveq	#10,d0
.m	add.w	d0,POSITION_LEN(a1)
	move.l	VEX_LinesPerPattern,d1
	cmp.w	POSITION_LEN(a1),d1
	bhs.s	.exit
	move.w	d1,POSITION_LEN(a1)
.exit	jsr	DrawPosition
	jsr	UpdatePosListQ
	RET

	ENDC
	rts

	acode
TrackLenDown	;V1.0
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a1
	moveq	#1,d0
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.M
	moveq	#10,d0
.M	sub.w	d0,POSITION_LEN(a1)
	bmi.s	.X
	beq.s	.X
	bra.s	.draw
.X	move.w	#1,POSITION_LEN(a1)
.draw	jsr	DrawPosition
	jsr	UpdatePosListQ
	RET
	ENDC

	acode
LoopUp		;V1.0
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a1
	moveq	#1,d0
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.M
	moveq	#10,d0
.M	add.w	d0,POSITION_LOOPNUMB(a1)
	jsr	DrawPosition
	jsr	UpdatePosListQ
	RET
	ENDC

	acode
LoopDown	;V1.0
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a1
	moveq	#1,d0
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.M
	moveq	#10,d0
.M	sub.w	d0,POSITION_LOOPNUMB(a1)
	bmi.s	.X
	beq.s	.X
	bra.s	.draw
.X	move.w	#1,POSITION_LOOPNUMB(a1)
.draw	jsr	DrawPosition
	jsr	UpdatePosListQ
	RET
	ENDC

	acode
StartPosUp	;V1.0
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	moveq	#1,d0
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.M
	moveq	#10,d0
.M	add.w	d0,POSITION_STARTPOINT(a2)
	jsr	DrawPosition
	jsr	UpdatePosListQ
	RET
	ENDC

	acode
StartPosDown	;V1.0
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	moveq	#1,d0
	cmpi.w	#TRUE,Shift_KEY
	bne.s	.M
	moveq	#10,d0
.M	sub.w	d0,POSITION_STARTPOINT(a2)
	bpl.s	.X
	clr.w	POSITION_STARTPOINT(a2)
.X	jsr	DrawPosition
	jsr	UpdatePosListQ
	RET
	ENDC

	acode
PosTuneUp	;V1.0
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	jsr	SetOctaveKeyRaster
	add.w	d0,POSITION_TUNE(a2)
PosTuneUpS
	jsr	DrawPosition
	jsr	UpdatePosListQ
	RET
	ENDC

	acode
PosTuneDown	;V1.0
	IFNE	DEMO
	rts
	ELSE
	BGN
	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a2
	jsr	SetOctaveKeyRaster
	sub.w	d0,POSITION_TUNE(a2)
	bra.s	PosTuneUpS
	ENDC


	acode
SetUpdatePos
	move.l	#TRUE,AutoUpdate_DrPos
	jsr	ResetGotoNextLine
	rts

	acode
SetUpdateSeq
	move.l	#TRUE,AutoUpdate_DrSeq
	rts

UpdateDrawSequence
	jsr	DrawSequence
	move.l	#FALSE,AutoUpdate_DrSeq
	rts

	acode
SetRowOffset
	BGN
	jsr	PatEdCrsrOff
	jsr	GetActualPattEd
	move.l	PATTED_ACTUALSONGDATA(a0),a1
	move.w	POSITION_STARTPOINT(a1),PATTED_CRSRY(a0)
	clr.w	PATTED_CRSRYOFFSET(a0)
	jsr	PatEdCrsrOn
	RET

	acode
UpdateDrawPosition
	BGN
	jsr	SetRowOffset
	jsr	UpdatePosList
	jsr	PattedUpdateDisp
	jsr	DrawEventStatus
	jsr	UpdateActWave
	move.l	#FALSE,AutoUpdate_DrPos
	RET

	acode
ResetGotoNextLine
	clr.w	GotoNextLine_COUNTER
	move.l	#FALSE,AutoUpdate_NextLine
	rts
GotoNextLine_COUNTER	dc.w	0

	acode
SetGotoNextLine
	move.l	#TRUE,AutoUpdate_NextLine
	addq.w	#1,GotoNextLine_COUNTER
	rts

	acode
UpdateGotoNextLine
	cmpi.w	#TRUE,PLAYER_STATUS
	bne.s	.GotoX
	cmpi.w	#TRUE,AutoUpdate_DrPos+UPENTRY_ENABLE
	beq.s	.do
.GotoX	rts
.do	BGN
	lea.l	GotoNextLine_COUNTER(PC),a2
	move.w	(a2),d0
	beq.s	.exit
.loop	jsr	GetActualPattEd
	jsr	PattEdMoveNextLine
	subq.w	#1,d0
	bne.s	.loop
.exit	clr.w	(a2)
	jsr	DrawEventStatusQ
	move.l	#FALSE,AutoUpdate_NextLine
	RET



	acode
IMSGInfo	;V1.0	RELEASE
	IFEQ	TESTPRGB
	rts
	ELSE
	BGN
	move.l	d4,d0				;Enforcer Hit fixed
	IFNE	SHOWMSGINT
	jsr	PrintAssHex
	ENDC
	RET
	ENDC

	acode
GetMsgShift
	puts	d1
	move.l	#FALSE,Shift_KEY
	move.l	6*4(a0),d1

	btst	#2,d1
	beq.s	GetMsgShift_noL
	move.w	#TRUE,ShiftL_KEY

GetMsgShift_noL	andi.l	#3,d1
	tst.b	d1
	beq.s	GetMsgShift_X
	move.w	#TRUE,Shift_KEY
GetMsgShift_X	gets	d1
	rts
MAINEXIT	move.w	#TRUE,MAINEXIT_FLAG
	rts

	acode
GetSystemFreq:
	puts	d2-d3
	moveq	#0,d2
	move.l	VexQuality,d3
	mulu.l	#28867,d2:d3
	divu.l	#100,d2:d3
	move.l	d3,d0
	gets	d2-d3
	rts

	acode
GetRealSystemFreq:	;V1.0 mit OS3
	puts	d2-d3
	moveq	#0,d2
	move.l	VexQuality,d3
	mulu.l	#28867,d2:d3
	divu.l	#100,d2:d3
	move.l	d3,d0
	mulu.l	OverSample3,d0
	gets	d2-d3
	rts


	acode
DecWordXY5Char	;V1.0
	cmp.l	#0,a1
	bne.s	DecWordXY5Char_do
	rts
DecWordXY5Char_do
	BGN
	jsr	GFX_Move
	lea.l	DecLongSave,a0
	moveq	#0,d0
	move.w	d2,d0
	jsr	ConvertToDecLong
	moveq	#5,d0
	lea.l	DecLongSave+5,a0
	tst.w	d2
	bne.s	DecWordXY5Char_ok
		move.b	#"0",4(a0)
DecWordXY5Char_ok
	GFX	Text(a6)
	RET

;	acode
;DrawActualEvent	;V1.0
;	BGN
;	cmpi.b	#TRUE,MACROPROCESS
;	beq.s	.exit
;	cmpi.w	#TRUE,MOD_RELOAD
;	beq.s	.exit
;	jsr	GetActualNotePtr
;	cmpi.l	#NOTE_FULLEMPTY,(a0)
;	beq.s	.exit
;		;jsr	DrawNoteEvent
;		bsr	UpdateActWave
;.exit	RET

	acode
UpdateActWave	;V1.0
	BGN
	tst.l	InstrUpdate
	beq.s	.exit

	jsr	GetActualNotePtr
	cmpi.b	#FX_FROMANDPITCH,NOTE_FX(a0)
	beq.s	.do
	jsr	CheckNoteType
	cmpi.w	#NOTETYPEID_NOTEON,d0
	beq.s	.do
	cmpi.b	#FX_REPLAYFROM,NOTE_FX(a0)
	bne.s	.exit
	cmpi.b	#NOTEPITCH_NONOTE,NOTE_PITCH(a0)
	beq.s	.exit

.do	moveq	#0,d0
	move.b	NOTE_INSTR(a0),d0
	jsr	GotoInstrNum
.exit	RET

	acode
BuildLT_Trans
	move.l	#"Tran",(a4)+
	move.l	#"sWav",(a4)+
	move.w	#"e ",(a4)+
	clr.b	(a4)+
	RET

	acode
BuildLineTxt	;V1.0
	BGN
	lea.l	LineSampleDef_Txt,a1
	move.l	a1,a4
	clr.b	(a4)

	jsr	GetActualInstrName

	move.w	LINENAME_VERSION(a0),d4
	move.w	LINENAME_SRCNUMB(a0),d7
	move.w	LINENAME_HEADLEN(a0),d6
	move.w	LINENAME_SRCDEFLEN(a0),d5
	lea.l	(a0,d6.w),a0

	cmpi.w	#1,d4
	beq.s	BuildLT_Trans



	move.b	NOTE_INSTR(a0),d4

	subq.w	#1,d7
	bmi.s	BuildLineTxt_X	
	bne.s	BuildLineTxt_L

	move.l	#"Remi",(a4)+
	move.l	#"x   ",(a4)+
	bra.s	BuildLineTxt_X

BuildLineTxt_L
		cmp.b	NOTE_INSTR(a0),d4
		bne.s	BuildLineTxt_Mix
		lea.l	(a0,d5.w),a0
	dbf	d7,BuildLineTxt_L
	move.l	#"Chor",(a4)+
	move.l	#"d   ",(a4)+
	bra.s	BuildLineTxt_X
BuildLineTxt_Mix
	move.l	#"Over",(a4)+
	move.l	#"lay ",(a4)+
	bra	BuildLineTxt_X
BuildLineTxt_X
	moveq	#0,d0
	move.b	d4,d0
	jsr	ConvertToDecByte
	lea	DecByteSave,a0			;Instrument Src #
	move.b	(a0)+,(a4)+
	move.b	(a0)+,(a4)+
	move.b	(a0)+,(a4)+
	clr.b	(a4)
	RET

	acode
InitProjectTitle
	BGN
	move.b	#TRUE,ProjectName_PTR-4
	move.l	ProjectName_PTR,a1
	clr.b	(a1)
	RET

	acode
DrawPattedTitle	;V2.0 NG
	BGN
	lea.l	ProjSong_TXT,a0
	cmpi.b	#TRUE,ProjectName_PTR-4
	beq.s	.T1
	lea.l	ProjMod_TXT,a0		;PROJECT TYPE
.T1	move.l	PattedTit_PTR,a1
	jsr	CopyString
	move.l	ProjectName_PTR,a0
	tst.b	(a0)
	bne.s	.T2
	lea.l	EmptyProject_TXT,a0		;UNNAMED PROJECT
.T2	jsr	AddString

	;--- DRAW PATTED TITLE ---
	move.l	#"PTED",d0
	jsr	NGFindWindow
	cmp.l	#0,a0
	beq.s	.exit
		move.l	(a0),a0
		cmp.l	#0,a0
		beq.s	.exit
		move.l	#-1,a2
		CALLINT	SetWindowTitles(a6)
.exit	RET

	acode
FillUpSpaces	;V1.0
	puts	d0-d1/a0
	moveq	#" ",d1
	subq.w	#1,d0
.loop	tst.b	(a0)+
	beq.s	.clr
	dbf	d0,.loop
	clr.b	(a0)+
.exit	gets	d0-d1/a0
	rts
.clr	subq.l	#1,a0
.clrl	move.b	d1,(a0)+
	dbf	d0,.clrl
	clr.b	(a0)+
	bra.s	.exit


KEYTRANS_KEYDEF		EQU	0
KEYTRANS_KEYDEFUPPER	EQU	4
KEYTRANS_FASTFRQTRANS	EQU	4+4
KEYTRANS_FASTFRQSIZE	EQU	8+4	;PRIV
KEYTRANS_FASTFRQMEMTYPE	EQU	12+4	;PRIV
KEYTRANS_ENTRIES	EQU	16+4
KEYTRANS_FREQLIST	EQU	18+4



	IFNE	MIDILIB
	acode
PlayMidiKeyboard	;V1.0
	;MIDI
	BGN
	jsr	CheckInstrument
	tst.w	d0
	bne.s	.exit

	jsr	GetActualInstrument
	move.l	a0,a1
	jsr	GetActualInstrName
	move.l	a0,a2

	tst.l	MidiAKey
	beq.s	.exit

	move.w	MidiAKey,d0
	move.w	d0,d1
	lsl.w	#3,d0

	lea.l	Standard_KEYTRANS,a0

	bra	PlayKeyNote_In
.exit	RET

;	cmpi.b	#MULTISAMPLE_STEREOL,SAMPLENAME_MULTI(a2)
;	bne.s	FastKeyboard_X
;
;	btst	#SPLAYFLAG_SUPERFAST,SAMPLENAME_PLAYFLAG(a2)
;	bne.s	FastKeyboard_X
;
;	lea.l	SampleNameMaxLen(a2),a2
;	cmpi.b	#MULTISAMPLE_STEREOR,SAMPLENAME_MULTI(a2)
;	bne.s	FastKeyboard_X
;		lea.l	INSTR_SIZEOF(a1),a1
;		move.w	RECORD_STATUS,d7
;			move.w	#FALSE,RECORD_STATUS
;			jsr	PlayKeyNote
;		move.w	d7,RECORD_STATUS
;FastKeyboard_X	
;
;	RET
	ENDC



	acode
PlayKeyNote	;V2.1
		;I(D0B,A0L,A1L,A2L)(ASCII_KEY,KEYTRANS,INSTRUMENT,INSTRNAME)
		;V2.1 POSTUNE
	BGN
	move.l	KEYTRANS_FASTFRQTRANS(a0),a0
	andi.w	#$00ff,d0
	btst	#7,d0
	bne.w	PlayKeyNote_X

	lsl.w	#3,d0
	move.w	4(a0,d0.w),d1		;NOTE#


PlayKeyNote_In
	add.w	KeyboardTune,d1

	puts	a0
	move.w	d1,d2
	btst	#SPLAYFLAG_DODETUNE,SAMPLENAME_PLAYFLAG(a2)
	bne.s	PlayKeyNote_NoPosTune

	lea.l	Test_PATTED,a0
	move.l	PATTED_ACTUALSONGDATA(a0),a0
	add.w	POSITION_TUNE(a0),d1

PlayKeyNote_NoPosTune
	gets	a0
	move.l	(a0,d0.w),d0		;NOTE FREQ
	cmpi.l	#-1,d0
	beq.s	PlayKeyNote_X


	move.w	d1,d0
	add.w	INSTR_TUNE(a1),d0
	jsr	GetNoteFreq


	cmpi.w	#TRUE,ShiftL_KEY
	beq.s	PlayKeyNote_Upper
	cmpi.w	#TRUE,Shift_KEY
	beq.s	PlayKeyNote_Upper
	bra.s	PlayKeyNote_M1
PlayKeyNote_Upper
		lsl.l	#1,d0
		add.w	Actual_FREQDEF+FREQDEF_OCTAVE,d1
		add.w	Actual_FREQDEF+FREQDEF_OCTAVE,d2
PlayKeyNote_M1
		move.l	a1,a0
		bsr.w	PlayFreq

	move.w	d1,d0
	jsr	DrawSpecUnitTest
	IFEQ	DEMO
	cmpi.w	#TRUE,RECORD_STATUS
	bne.s	PlayKeyNote_X
		move.w	d2,d0
		lea.l	Test_INSTRMAN,a1
		move.w	INSTRMAN_ACTUALNUMB(a1),d1
		lea.l	Test_PATTED,a0
		jsr	BackupPattern
		jsr	HideBlockRange
		bsr	SetNote
	ENDC
PlayKeyNote_X	RET

	acode
InitKeyTrans	;V1.1
		;I(A0L)(KEYTRANS)
	BGN
	move.l	a0,a4
	move.w	KEYTRANS_ENTRIES(a4),d7	
	subq.w	#1,d7
	bmi.s	.exit
	move.l	KEYTRANS_FASTFRQTRANS(a4),a1			;CLEAR
	moveq	#-1,d6
.loop	move.l	d6,(a1)+
	dbf	d7,.loop
	move.l	KEYTRANS_KEYDEF(a4),a3
	bsr.b	DoInitKeyTrans
	move.l	KEYTRANS_KEYDEFUPPER(a4),a3
	bsr.b	DoInitKeyTrans
.exit	RET

	acode
DoInitKeyTrans
	cmp.l	#0,a3
	beq.s	.exit

	moveq	#0,d6
	move.w	(a3)+,d6					;D6:START

.loop		moveq	#0,d5
		move.b	(a3)+,d5
		tst.b	d5
		beq.s	.exit
		lsl.w	#3,d5
		move.l	d6,d0
		move.l	KEYTRANS_FREQLIST(a4),a0
			jsr	GetNoteFreq
		move.l	KEYTRANS_FASTFRQTRANS(a4),a0
		move.l	d0,(a0,d5.w)
		move.w	d6,4(a0,d5.w)
		addq.w	#1,d6
	bra.s	.loop
.exit	rts



;--- INIT SONG -----------------------------------------------

	acode
SetPatHeadPTR	;V1.0
		;I(A0L)(SONGDATA)
	puts	a0-a1/d0
	move.l	a0,a1
	move.w	POSITION_PATNUM(a0),d0
	mulu	#PATHEAD_SIZEOF,d0
	move.l	First_PATHEAD,a0
	lea.l	(a0,d0.l),a0
	move.l	a0,POSITION_PATHEADPTR(a1)
	gets	a0-a1/d0
	rts


;--- PLAY SONG - IRQ ---------------------------------------------------


	acode
PlaySong	;V2.2b
		;I(A0L)(SONG)
	cmpi.w	#TRUE,PLAYER_STATUS
	beq.s	.do
	rts
.do	BGN
	move.l	a0,a5
	neg.b	SignalACount
	bmi.s	.skip
	jsr	SignalAutoUpdate	; NEW POSITION

.skip	subq.w	#1,SONG_SPEEDCOUNT(a5)
	bne.s	.exit
		move.l	SONG_ACTSONGDATA(a5),a4
		move.w	SONG_SPEED(a5),SONG_SPEEDCOUNT(a5)
		bsr.b	PlaySongData
.exit	RET


	acode
PlaySongData	;V1.0

		;I(A4L,A5L)(ACTUALPOSITION_PTR,SONG_PTR)
	move.l	POSITION_PATHEADPTR(a4),a3
	bsr.w	PlaySongPattern
	cmpi.w	#TRUE,d0
	bne.s	.exit

	subq.w	#1,POSITION_LOOPCOUNT(a4)
	bne.s	.exit

		subq.w	#1,SONG_SEQCOUNT(a5)		;Next SongData
		beq.s	.PlayNextSeq

		lea.l	POSITION_SIZEOF(a4),a4
		move.l	a4,SONG_ACTSONGDATA(a5)
		move.w	POSITION_SPEED(a4),SONG_SPEED(a5)

		jsr	MovePosUp
		jsr	SetUpdatePos
.exit	rts

	acode
.PlayNextSeq
		jsr	SetUpdateSeq
		move.l	SONG_ACTUALSEQ(a5),a2
		cmpi.w	#SEQINFO_ENDSONG,SEQUENCE_INFO(a2)
		beq.s	.Reset


		subq.w	#1,SONG_SEQCOUNTER(a5)
		bne.s	.LoopSequenz

.SeqSkipped
		lea.l	SEQUENCE_SIZEOF(a2),a2
		move.l	a2,SONG_ACTUALSEQ(a5)
		addq.w	#1,SONG_SEQNUM(a5)
		cmpi.w	#Test_SeqNumb-1,SONG_SEQNUM(a5)
		bhs.s	.Stop
		beq.s	.Reset

		cmpi.w	#SEQINFO_SKIP,SEQUENCE_INFO(a2)
		beq.s	.SeqSkipped
		cmpi.w	#SEQINFO_ENDSONG,SEQUENCE_INFO(a2)
		beq.s	.Reset
		tst.w	SEQUENCE_LOOP(a2)
		beq.s	.SeqSkipped

		jsr	ResetRelTime
		move.w	SEQUENCE_LOOP(a2),SONG_SEQCOUNTER(a5)
		jsr	BackupActTime

.LoopSequenz
		move.l	a5,a0
		bsr.w	ReInitSongSeq
		jsr	GotoFirstPosition
		jsr	SetUpdatePos
		jsr	ResetGotoNextLine
	bra.s	.exit

	acode
.Stop	jsr	StopSong
.Reset				;PLAY NEXT SEQUENZ
	move.l	a5,a0
	jsr	MoveFirstPlayedSeq	;MAY FAIL !!!!
	bsr.w	ReInitSong		;SONG_SPEEDCOUNT ?
	jsr	ResetRelMasterTime

	jsr	GotoFirstPosition
	jsr	SetUpdatePos		;CORRECT
	jsr	ResetGotoNextLine
	jsr	BackupActTime
	jsr	SetUpdateSeq
	IFNE	RENDER
	move.b	#-1,Rend_EXIT
	ENDC
	bra	.exit

	acode
PlaySongPattern	;V2.1
		;I(A3L,A4L,A5L)(PATHEAD,SONGDATA,SONG_PTR)
		;O(D0W)(PATTERN FINISHED:TRUE/FALSE)
	cmpi.w	#PATHEADST_PLAYING,PATHEAD_STATUS(a3)
	beq.s	PlaySongPatternDo

		move.l	a4,ActualSongData
		move.w	POSITION_LEN(a4),PATHEAD_LINECOUNT(a3)
		move.w	POSITION_TUNE(a4),d2
		add.w	SequenzTune,d2
		move.w	d2,PatternTune
		move.l	PATHEAD_NOTEDATAPTR(a3),a2
		move.w	POSITION_STARTPOINT(a4),d2
	IFEQ DEMO
		move.w	d2,SongPlayerPos_Y
	ENDC
		move.w	SONG_LINESIZE(a5),d3
		mulu	d3,d2
		lea.l	(a2,d2.w),a2
		move.l	a2,PATHEAD_ACTUALLINEPTR(a3)
		move.w	#PATHEADST_PLAYING,PATHEAD_STATUS(a3)

PlaySongPatternDo

		move.l	PATHEAD_ACTUALLINEPTR(a3),a2
		move.l	a2,VEX_ACTUALLINE
		bsr.b	PlayStereoPatLine
		move.l	a2,PATHEAD_ACTUALLINEPTR(a3)

	IFEQ DEMO
	addq.w	#1,SongPlayerPos_Y
	ENDC
	moveq	#FALSE,d0
	subq.w	#1,PATHEAD_LINECOUNT(a3)
	bne.s	PlaySongPattern_X
		jsr	ResetGotoNextLine		;ONLY IF CRSR SCROLLING!!!
		jsr	SetUpdatePos
		moveq	#TRUE,d0
		move.w	#PATHEADST_DORESET,PATHEAD_STATUS(a3)
PlaySongPattern_X	rts


	acode
PlayStereoPatLine	;SUB
		;(A2L,A4L,A5L)(ACTUAL LINE,ACTUAL PATTERN,SONG_PTR)
		; NEW TRACK SETUP : LRLRLRLRLRLR...
	bsr	SetGotoNextLine

	movem.l	d1-d7/a6,-(a7)
	move.w	SONG_NUMBVOICES(a5),d7
	lsr.w	#1,d7
	move.w	d7,d2
	subq.w	#1,d7

	moveq	#0,d1					;D1=CHANNEL
	moveq	#1,d2
	lea.l	PlayTrackInfo,a1

PlayStereoPatLine_L
		bsr	PlayLineNote
		lea.l	NOTE_SIZEOF(a2),a2
		exg	d1,d2
		tst.b	PlayStereoCheck
		bne.s	PlayStereoP_Check

PlayStereoNote_NRM
		move.b	#-1,DOSAMPLEDIFF
			bsr	PlayLineNote
		clr.b	DOSAMPLEDIFF
		lea.l	NOTE_SIZEOF(a2),a2
PlayStereoNote_CONT
		clr.b	PlayStereoCheck
		exg	d1,d2
		addq.w	#2,d1				;Left Channels
		addq.w	#2,d2				;Right Channels
	dbf	d7,PlayStereoPatLine_L
PlayStereoPatLine_X	movem.l	(a7)+,d1-d7/a6
	rts


	acode
PlayStereoNote2
	gets	d0/a0
PlayStereoNote
	lea.l	-NOTE_SIZEOF(a2),a2
	addq.b	#1,NOTE_INSTR(a2)
	bsr	PlayLineNoteExp
	subq.b	#1,NOTE_INSTR(a2)
	lea.l	NOTE_SIZEOF*2(a2),a2
	bra.s	PlayStereoNote_CONT

PlayStereoP_Check
	cmpi.l	#NOTE_FULLEMPTY,(a2)
	beq.s	PlayStereoNote
	puts	d0/a0
		move.l	a2,a0
		jsr	CheckNoteType
		cmpi.w	#NOTETYPEID_NONE,d0
		beq.s	PlayStereoNote2
		cmpi.w	#NOTETYPEID_SIMPLEFX,d0
		bne.s	PlayStereoP_Check2
			cmpi.b	#VOLUME_MAX,NOTE_VOLUME(a2)
			bls.s	PlayStereoNote2
PlayStereoP_Check2
	gets	d0/a0
	bra.s	PlayStereoNote_NRM

PlayLineNoteExp
	move.b	#-1,DOSAMPLEDIFF
	bsr	PlayLineNote
	clr.b	DOSAMPLEDIFF
	rts

PatternTune	dc.w	0

	acode
PlayLineNote:	;V1.4
		;SUB
		;(D1W,A2L,A4L,A5L)(CHANNEL,ACTUAL NOTE,ACTUAL PATTERN,SONG_PTR)

		;1.1	Nonote, Volume is Zero -> Volume will not be changed.
		;1.2	Instr_tune
		;1.3	pos_tune
	tst.b	(a1)+
	bne.s	.go1
	rts
.go1	cmpi.l	#NOTE_FULLEMPTY,(a2)
	bne.s	.go
	rts

.go	BGN
	IFEQ SMALLGUI
	tst.l	EventModifyJSR
	beq.s	PlayLineNote_ForceMono
	move.l	EventModifyJSR,a6
	jsr	(a6)
	ENDC
PlayLineNote_ForceMono
	tst.w	SpecNoteAdd_PTR-2
	beq.s	.nospecadd

	subq.w	#1,SpecNoteAdd_PTR-2
	move.l	SpecNoteAdd_PTR,a0
	move.l	(a2),(a0)
	lea.l	4(a0),a0
	move.l	a0,SpecNoteAdd_PTR

.nospecadd
	cmpi.b	#FX_MIN,NOTE_FX(a2)
	bge.w	PlayLineNote_IsComplexFX
	cmpi.b	#NOTEPITCH_NONOTE,NOTE_PITCH(a2)
	beq.w	PlayLineNote_NoNote

		moveq	#0,d0
		move.b	NOTE_INSTR(a2),d0
		lea.l	Test_INSTRMAN(PC),a1
		mulu	INSTRMAN_ENTRYSIZE(a1),d0
		move.l	INSTRMAN_FIRST(a1),a1
		move.l	(a1,d0.l),a1

		moveq	#0,d0
		move.b	NOTE_PITCH(a2),d0
		add.w	INSTR_TUNE(a1),d0
		tst.w	PatternTune
		beq.s	.NoPosTune

		btst	#SPLAYFLAG_DODETUNE,INSTR_PLAYFLAG(a1)
		bne.s	.NoPosTune
			add.w	PatternTune(PC),d0
.NoPosTune
		move.b	NOTE_VOLUME(a2),d3
		move.l	SONG_FREQLIST(a5),a0
		bsr.w	GetNoteFreq

		cmpi.w	#MULTISAMPLE_STEREOL,INSTR_MULTI(a1)
		bne.s	.NoStereo
			move.b	#-1,PlayStereoCheck
.NoStereo

		move.l	a1,a4
		lea.l	Test_VOICEEXPANDER(PC),a5
		move.w	VOICEEXP_SAMPLESTRUCTSIZE(a5),d2
		mulu	d2,d1
		move.l	VOICEEXP_FIRSTSAMPLEPTR(a5),a0
		lea.l	(a0,d1.w),a0

		move.l	(a2),SAMPLE_LASTNOTE(a0)
		clr.l	SAMPLE_DESTFREQUENZ(a0)

		bsr	ClearInstrSaPos

		tst.b	d3
		bne.s	.NoteNrmV
			moveq	#VOLUME_MAX,d3
.NoteNrmV

		bsr	StartSample


		RET


	acode
PlayLineNote_NoNote
		lea.l	Test_VOICEEXPANDER(PC),a5
		move.w	VOICEEXP_SAMPLESTRUCTSIZE(a5),d2
		mulu	d2,d1
		move.l	VOICEEXP_FIRSTSAMPLEPTR(a5),a0
		lea.l	(a0,d1.w),a0

		moveq	#0,d3
		move.b	NOTE_VOLUME(a2),d3
		beq	PlayLineNote_X

	cmpi.b	#VOLUME_COMMAND,d3
	bhi.s	PlayLineNote_ISVOLCOMMAND
		lsl.w	#8,d3
		move.w	d3,SAMPLE_VOLUME(a0)
		move.b	#-1,SAMPLE_DECLICK(a0)		;FADESAMPLE
	bra	PlayLineNote_X

	acode
PlayLineNote_ISVOLCOMMAND
	lea.l	VOLUMECOM_JL(PC),a1
	subi.w	#VOLUMECOMBASE,d3
	bmi.s	PlayLineNote_VError
	move.l	(a1,d3.w*4),a1
	jmp	(a1)


VOLUMECOMBASE	EQU	VOLUME_PITCHDOWN3


	acode
PlayLineNote_VError
	jsr	WarnFlash
	bra	PlayLineNote_X

	acode
PlayLineNote_SpeedDown
	moveq	#1,d0
	lea.l	Test_SONG(PC),a5
	cmp.w	SONG_SPEED(a5),d0
	bhs	PlayLineNote_X
		sub.w	d0,SONG_SPEED(a5)
	bra	PlayLineNote_X

	acode
PlayLineNote_SpeedUp
	lea.l	Test_SONG(PC),a5
	addq.w	#1,SONG_SPEED(a5)
	bra	PlayLineNote_X

	acode
ClearInstrSaPos
	puts	a6
	move.l	SAMPLE_INSTRUMENTPTR(a0),a6
	cmp.l	#0,a6
	beq.s	.exit
		clr.l	INSTR_SAMPLEPOS(a6)
.exit	gets	a6
	rts

	acode
PlayLineNote_StopSample
		bsr	ClearInstrSaPos
		move.w	#SAMPLEST_PENDING,SAMPLE_STATUS(a0)
		move.b	#-1,SAMPLE_FADEOUT(a0)		;FADESAMPLE

	bra	PlayLineNote_X

	acode
PlayLineNote_ContSample
		cmpi.b	#TRUE,SAMPLE_ENDREACHED(a0)
		beq.w	PlayLineNote_X
			move.w	#SAMPLEST_INUSE,SAMPLE_STATUS(a0)
			move.b	#-1,SAMPLE_DECLICK(a0)		;FADESAMPLE
	bra	PlayLineNote_X

	acode
PlayLineNote_KeyOff
		cmpi.w	#INSTRTYPE_SUST,SAMPLE_INSTRUMENTTYPE(a0)
		bne.w	PlayLineNote_X
			move.l	SAMPLE_SUSTSTARTPTR(a0),SAMPLE_PTR(a0)
			move.l	SAMPLE_SUSTENDPTR(a0),SAMPLE_ENDPTR(a0)
			move.w	#-1,SAMPLE_LOOPNUMB(a0)
			move.b	#-1,SAMPLE_DECLICK(a0)
	bra	PlayLineNote_X


	acode
PlayLineNote_PitchUp
		move.l	SAMPLE_FREQUENZ(a0),d0
		lsr.l	#PITCHFXSHIFT,d0
		add.l	d0,SAMPLE_FREQUENZ(a0)
	bra	PlayLineNote_X

	acode
PlayLineNote_PitchUp2
		move.l	SAMPLE_FREQUENZ(a0),d0
		lsr.l	#PITCHFXSHIFT-1,d0
		add.l	d0,SAMPLE_FREQUENZ(a0)
	bra	PlayLineNote_X

	acode
PlayLineNote_PitchUp3
		move.l	SAMPLE_FREQUENZ(a0),d0
		lsr.l	#PITCHFXSHIFT-2,d0
		add.l	d0,SAMPLE_FREQUENZ(a0)
	bra	PlayLineNote_X

	acode
PlayLineNote_PitchDown
		move.l	SAMPLE_FREQUENZ(a0),d0
		lsr.l	#PITCHFXSHIFT,d0
		sub.l	d0,SAMPLE_FREQUENZ(a0)
	bra	PlayLineNote_X

	acode
PlayLineNote_PitchDown2
		move.l	SAMPLE_FREQUENZ(a0),d0
		lsr.l	#PITCHFXSHIFT-1,d0
		sub.l	d0,SAMPLE_FREQUENZ(a0)
	bra	PlayLineNote_X

	acode
PlayLineNote_PitchDown3
		move.l	SAMPLE_FREQUENZ(a0),d0
		lsr.l	#PITCHFXSHIFT-2,d0
		sub.l	d0,SAMPLE_FREQUENZ(a0)
;;;	bra	PlayLineNote_X
PlayLineNote_X	RET

	acode
PlayLineNote_IsComplexFX
		moveq	#0,d0
		move.b	NOTE_FX(a2),d0
		cmpi.b	#FX_MAX,d0
		bhi.s	PlayLineNote_ComplexFXErr

		lea.l	ComplexFX_JMP(PC),a0
		move.l	(a0,d0.w*4),a0
		jmp	(a0)

	acode
PlayLineNote_ComplexFXErr
	jsr	WarnFlash
	bra	PlayLineNote_X

	acode
PlayLineNote_FxVSlideDown
		jsr	PlayNoteGetSample
		moveq	#0,d3
		move.b	NOTE_VOLUME(a2),d3
		lsl.w	#VOLUMESLIDE_LN,d3
			neg.w	d3
			move.w	d3,SAMPLE_VOLSLIDE(a0)
		bra	PlayLineNote_X

	acode
PlayLineNote_FxVSlideUp
		jsr	PlayNoteGetSample
		moveq	#0,d3
		move.b	NOTE_VOLUME(a2),d3
			lsl.w	#VOLUMESLIDE_LN,d3
			move.w	d3,SAMPLE_VOLSLIDE(a0)
		bra	PlayLineNote_X

	acode
PlayLineNote_FxPSlideDown
		jsr	PlayNoteGetSample
		moveq	#0,d3
		move.b	NOTE_VOLUME(a2),d3
		neg.w	d3
		move.w	d3,SAMPLE_PITCHSLIDE(a0)
		bra	PlayLineNote_X

	acode
PlayLineNote_FxPSlideUp
		jsr	PlayNoteGetSample
		moveq	#0,d3
		move.b	NOTE_VOLUME(a2),d3
		move.w	d3,SAMPLE_PITCHSLIDE(a0)
		bra	PlayLineNote_X

	acode
ReplayFXSetSpeed
		puts	d0/a5
		moveq	#0,d0
		move.b	NOTE_VOLUME(a2),d0
		beq	ReplayFXSetSpeed_Zero
			lea.l	Test_SONG(PC),a5
			move.w	d0,SONG_SPEED(a5)
ReplayFXSetSpeed_Zero	gets	d0/a5
		bra	PlayLineNote_X

	acode
PlayLNFilter	puts	d0-d3/a6
	jsr	PlayNoteGetSample	;FX_Filter

;	cmpi.b	#10,NOTE_PITCH(a2)
;	bhs.s	.filterclear
	cmpi.b	#5,NOTE_PITCH(a2)
	bhs.s	.globalfilter

	moveq	#0,d3
	move.b	NOTE_VOLUME(a2),d3

	bsr	GetRealSystemFreq
	mulu.l	#36000,d3
	divu.l	d0,d3

	cmpi.l	#400,d3
	bls.s	.ok
	move.w	#400,d3
.ok	move.w	d3,SAMPLE_FILTERFREQ(a0)

	moveq	#0,d3
	move.b	NOTE_INSTR(a2),d3
	move.w	d3,SAMPLE_FILTERRESO(a0)
	move.b	NOTE_PITCH(a2),SAMPLE_FILTERTYPE(a0)

	tst.b	NOTE_PITCH(a2)
	beq.s	.clr
	tst.b	NOTE_VOLUME(a2)
	beq.s	.clr
.exit	gets	d0-d3/a6
	bra	PlayLineNote_X
.clr	clr.l	SAMPLE_FILTERBUF(a0)
	clr.l	SAMPLE_FILTERBUF+4(a0)
	clr.l	SAMPLE_FILTERBUF+8(a0)
	bra.s	.exit
.filterclear
	clr.b	NOTE_PITCH(a2)
	bra.s	.exit

.globalfilter
sfdf	FLASH	fff
	move.b	NOTE_PITCH(a2),d3
	sub.b	#5,d3


	move.b	d3,RTFILTER_FILTERTYPE(a6)
	lea.l	RTPOSTFILTERWET(PC),a6
	moveq	#0,d3
	move.b	NOTE_VOLUME(a2),d3
	bsr	GetRealSystemFreq
	mulu.l	#36000,d3
	divu.l	d0,d3
	cmpi.l	#400,d3
	bls.s	.ok2
	move.w	#400,d3

.ok2	move.l	d3,RTFILTER_FILTERFREQ(a6)
	moveq	#0,d3
	move.b	NOTE_INSTR(a2),d3
	move.l	d3,RTFILTER_FILTERRESO(a6)
	tst.b	NOTE_PITCH(a2)
	beq.s	.clr2
	tst.b	NOTE_VOLUME(a2)
	beq.s	.clr2
.exit2	gets	d0-d3/a6
	bra	PlayLineNote_X
.clr2	clr.l	RTFILTER_FILTERBUF(a0)
	clr.l	RTFILTER_FILTERBUF+4(a0)
	clr.l	RTFILTER_FILTERBUF+8(a0)
	bra.s	.exit2


RTPOSTFILTERWET	blk.l	20,0

RTFILTER_FILTERFREQ	EQU	0
RTFILTER_FILTERRESO     EQU     4
RTFILTER_FILTERBUF      EQU     12	
RTFILTER_FILTERTYPE     EQU     8


	;I(A0L,A1L,A2L,D0W)(RTFILTER_STRUCT,OLDPTR,PTR,LEN)
RTResoFilterPostMix
	cmpi.b	#1,RTFILTER_FILTERTYPE(a0)
	beq.w	RTResoFilterPostMixLP
	cmpi.b	#2,RTFILTER_FILTERTYPE(a0)
	beq.w	RTResoFilterPostMixHP
	cmpi.b	#3,RTFILTER_FILTERTYPE(a0)
	beq.w	RTResoFilterPostMixBP
	rts

RTResoFilterPostMixHP
	puts	d0-d7/a1-a2
	subq.w	#1,d0
	movem.l	RTFILTER_FILTERBUF(a0),d2-d4
	move.l	RTFILTER_FILTERFREQ(a0),d7
	cmpi.l	#CFILTER_MAXFREQ,d7
	bls.s	.freqOK
	move.l	#CFILTER_MAXFREQ,d7
.freqOK	tst.l	RTFILTER_FILTERRESO(a0)
	beq.s	.donoreso
	cmpi.l	#CFILTER_MAXRESO,RTFILTER_FILTERRESO(a0)
	bls.s	.loop
	move.l	#CFILTER_MAXRESO,RTFILTER_FILTERRESO(a0)
.loop	move.w	(a2),d1
	;--- FILTER MIT RESO ---
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	d7,d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	d7,d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	move.l	RTFILTER_FILTERRESO(a0),d6
	muls.l	d2,d6
	asr.l	#6,d6
	add.l	d6,d2
	asr.l	#2,d2
	move.l	d2,d1
	;-----------------------
	move.w	d4,(a1)
	clr.w	(a2)
	lea.l	4(a2),a2
	lea.l	4(a1),a1
	dbf	d0,.loop
.exit	movem.l	d2-d4,RTFILTER_FILTERBUF(a0)
	gets	d0-d7/a1-a2
	rts
.donoreso
.loopnr	move.w	(a2),d1
	;--- HP FILTER OHNE RESO ---
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	d7,d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	d7,d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	asr.l	#2,d2
	move.l	d2,d1
	move.w	d4,(a1)
	clr.w	(a2)
	lea.l	4(a2),a2
	lea.l	4(a1),a1
	dbf	d0,.loopnr
	bra.s	.exit

RTResoFilterPostMixBP
	puts	d0-d7/a1-a2
	subq.w	#1,d0
	movem.l	RTFILTER_FILTERBUF(a0),d2-d4
	move.l	RTFILTER_FILTERFREQ(a0),d7
	cmpi.l	#CFILTER_MAXFREQ,d7
	bls.s	.freqOK
	move.l	#CFILTER_MAXFREQ,d7
.freqOK	tst.l	RTFILTER_FILTERRESO(a0)
	beq.s	.donoreso
	cmpi.l	#CFILTER_MAXRESO,RTFILTER_FILTERRESO(a0)
	bls.s	.loop
	move.l	#CFILTER_MAXRESO,RTFILTER_FILTERRESO(a0)
.loop	move.w	(a2),d1
	;--- FILTER MIT RESO ---
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	d7,d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	d7,d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	move.l	RTFILTER_FILTERRESO(a0),d6
	muls.l	d2,d6
	asr.l	#6,d6
	add.l	d6,d2
	asr.l	#2,d2
	move.l	d2,d1
	;-----------------------
	sub.w	d4,(a2)
	sub.w	d1,(a2)
	move.w	(a2),(a1)
	clr.w	(a2)
	lea.l	4(a2),a2
	dbf	d0,.loop
.exit	movem.l	d2-d4,RTFILTER_FILTERBUF(a0)
	gets	d0-d7/a1-a2
	rts
.donoreso
.loopnr	move.w	(a2),d1
	;--- BP FILTER OHNE RESO ---
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	d7,d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	d7,d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	asr.l	#2,d2
	move.l	d2,d1
	sub.w	d4,(a2)
	sub.w	d1,(a2)
	move.w	(a2),(a1)
	clr.w	(a2)
	lea.l	4(a2),a2
	dbf	d0,.loopnr
	bra.s	.exit
.temp	dc.w	0

	;LP Filter
RTResoFilterPostMixLP
	puts	d0-d7/a1-a2
	subq.w	#1,d0
	movem.l	RTFILTER_FILTERBUF(a0),d2-d4
	move.l	RTFILTER_FILTERFREQ(a0),d7
	cmpi.l	#CFILTER_MAXFREQ,d7
	bls.s	.freqOK
	move.l	#CFILTER_MAXFREQ,d7
.freqOK	tst.l	RTFILTER_FILTERRESO(a0)
	beq.s	.donoreso
	cmpi.l	#CFILTER_MAXRESO,RTFILTER_FILTERRESO(a0)
	bls.s	.loop
	move.l	#CFILTER_MAXRESO,RTFILTER_FILTERRESO(a0)
.loop	move.w	(a2),d1
	;--- FILTER MIT RESO ---
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	d7,d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	d7,d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	move.l	RTFILTER_FILTERRESO(a0),d6
	muls.l	d2,d6
	asr.l	#6,d6
	add.l	d6,d2
	asr.l	#2,d2
	move.l	d2,d1
	;-----------------------
	add.w	d1,(a1)
	clr.w	(a2)
	lea.l	4(a2),a2
	dbf	d0,.loop
.exit	movem.l	d2-d4,RTFILTER_FILTERBUF(a0)
	gets	d0-d7/a1-a2
	rts
.donoreso
.loopnr	move.w	(a2),d1
	;--- FILTER OHNE RESO ---
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	d7,d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	d7,d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	asr.l	#2,d2
	move.l	d2,d1
	move.w	d1,(a1)
	clr.w	(a2)
	lea.l	4(a2),a2
	dbf	d0,.loopnr
	bra.s	.exit







	acode
ReplayFXSetFromAdd
		puts	d2-d3
		jsr	PlayNoteGetSample
		moveq	#0,d3
		move.b	NOTE_VOLUME(a2),d3
		beq.s	SetFromAdd_Quick
		move.l	SAMPLE_ENDPTR(a0),d2
		sub.l	SAMPLE_STARTPTR(a0),d2
		mulu.l	d3,d2
		lsr.l	#8,d2
SetFromAdd_In	move.l	d2,SAMPLE_FROMADD(a0)
		gets	d2-d3
		bra	PlayLineNote_X
	acode
SetFromAdd_Quick
		moveq	#0,d2
		bra.s	SetFromAdd_In

	acode
ReplayFXFromAdd
		puts	d2-d3
		jsr	PlayNoteGetSample

		move.b	NOTE_VOLUME(a2),d3
		extb.l	d3
		move.l	SAMPLE_ENDPTR(a0),d2
		sub.l	SAMPLE_STARTPTR(a0),d2
		muls.l	d3,d2				;WARN(LONG SAMPLES)
		moveq	#FROMADDSTEP_LN,d3
		asr.l	d3,d2
		add.l	d2,SAMPLE_FROMADD(a0)

		gets	d2-d3
		bra	PlayLineNote_X

	acode
PlayLineNote_SetDsp
		moveq	#0,d0
		move.b	DSPNOTE_LEVEL(a2),d0
		move.l	d0,DSP_ECHO_LVL

		clr.b	DSPREINITECHO
		move.b	DSPNOTE_BUF(a2),d0

		tst.b	d0
		beq.s	PlayLineNote_SetDspErr

		cmp.l	MAXDSP_ECHO_LEN,d0
		bhi.s	PlayLineNote_SetDspErr
		cmp.l	DSP_ECHO_LEN,d0
		beq.s	PlayLineNote_PlayLNNoReEcho
			move.b	#-1,DSPREINITECHO
PlayLineNote_PlayLNNoReEcho
		move.l	d0,DSP_ECHO_LEN

		move.b	DSPNOTE_TYPE(a2),d0
		lea.l	DSPFX_LIST(PC),a0
		move.l	(a0,d0.w*4),a0
		moveq	#1,d0
		move.b	d0,DSPACTION_LIVE
			jsr	(a0)		;Remote Dsp !!
		swap	d0
		move.b	d0,DSPACTION_LIVE


		tst.b	DSPREINITECHO
		beq.w	PlayLineNote_X
		jsr	InitCalcBufferInfo
		bra	PlayLineNote_X

	acode
PlayLineNote_SetDspErr
	jsr	WarnFlash
	bra	PlayLineNote_X

	acode
PlayLineNote_SetDelay
		moveq	#0,d0
		move.b	DSPNOTE_LEVEL(a2),d0
		move.w	d0,DELAYINFO+2

		move.b	DSPNOTE_BUF(a2),d0
		move.w	d0,DELAYINFO

		bsr	ValidateDelay

		move.b	DSPNOTE_TYPE(a2),d0
		lea.l	DSPDELAY_LIST(PC),a0
		move.l	(a0,d0.w*4),a0
		moveq	#1,d0
		move.b	d0,DSPACTION_LIVE
			jsr	(a0)		;Remote Dsp !!
		swap	d0
		move.b	d0,DSPACTION_LIVE

;		jsr	InitCalcBufferInfo
		bra	PlayLineNote_X

	acode
Play_FxAddPitch
		jsr	PlayNoteGetSample
		move.b	NOTE_VOLUME(a2),d3
		extb.l	d3
		move.l	SAMPLE_FREQUENZ(a0),d0
		moveq	#FXADDPITCH_LN,d2
		lsr.l	d2,d0
		muls.l	d3,d0
		add.l	d0,SAMPLE_FREQUENZ(a0)
		bra	PlayLineNote_X

	acode
PlayCV4	move.b	NOTE_VOLUME(a2),d3	;d4: Pan 0..128..255
	ext.w	d3
	moveq	#0,d4
	move.b	NOTE_INSTR(a2),d4	;d3: Amplitude
	muls	#256,d3
	jsr	PlayNoteGetSample

	move.w	d3,SAMPLE_CVOL(a0)
	move.w	d3,SAMPLE_CVOL+SAMPLE_SIZEOF(a0)
	cmpi.w	#128,d4
	beq	PlayLineNote_X
	cmpi.w	#128,d4
	blt.s	.left
.right	
	move.w	#255,d5
	sub.w	d4,d5
	muls	d5,d3
	divs	#128,d3
	move.w	d3,SAMPLE_CVOL(a0)
	bra	PlayLineNote_X

.left	muls	d4,d3
	divs	#128,d3
	move.w	d3,SAMPLE_CVOL+SAMPLE_SIZEOF(a0)
	bra	PlayLineNote_X



	acode
PNoteCV
	moveq	#0,d3
	move.b	NOTE_PITCH(a2),d3
	cmpi.b	#CV_MAX,d3
	bhi	PlayLineNote_VError
	lea.l	PlayCVList(PC),a0
	move.l	(a0,d3.w*4),a0
	jmp	(a0)
	acode
PlayCV0
	move.b	NOTE_VOLUME(a2),d3
	ext.w	d3
	muls	#256,d3
	jsr	PlayNoteGetSample
	move.w	d3,SAMPLE_CVOL(a0)
	bra	PlayLineNote_X

PlayCV1
	jsr	WarnFlash
	bra	PlayLineNote_X

	;move.b	NOTE_VOLUME(a2),d3
	;ext.w	d3
	;asl.w	#4,d3
	;jsr	PlayNoteGetSample
	;move.w	d3,SAMPLE_CVOLADD(a0)
	;clr.w	SAMPLE_CVTYPE(a0)
	;bra	PlayLineNote_X

PlayCV2
PlayCV3
	jsr	WarnFlash
	bra	PlayLineNote_X

	;move.b	NOTE_VOLUME(a2),d3
	;ext.w	d3
	;asl.w	#4,d3
	;jsr	PlayNoteGetSample
	;move.w	d3,SAMPLE_DESTVOL(a0)
	;ext.l	d3
	;move.w	SAMPLE_CVOL(a0),d2
	;ext.l	d2
	;sub.l	d2,d3
	;moveq	#0,d2
	;move.b	NOTE_PITCH(a2),d2
	;divs	d2,d3
	;move.w	d3,SAMPLE_CVOLADD(a0)
	;move.w	#1,SAMPLE_CVTYPE(a0)
	;bra	PlayLineNote_X

	acode
PNoteCVAdd
	moveq	#0,d3
	move.b	NOTE_PITCH(a2),d3
	lsl.w	#4,d3
	move.b	NOTE_INSTR(a2),d2
	or.b	d2,d3
	lsl.w	#4,d3
	move.b	NOTE_VOLUME(a2),d2
	or.b	d2,d3
	bra	PlayLineNote_X

	acode
Play_FxAddHalvTone
		move.b	NOTE_VOLUME(a2),d3


		jsr	PlayNoteGetSample
		lea.l	SAMPLE_LASTNOTE(a0),a2
		add.b	d3,NOTE_PITCH(a2)

		jsr	PlayNoteGetInstr
		jsr	PlayNotePitch

		bra	PlayLineNote_X
	acode
Play_FxAddVol
		jsr	PlayNoteGetSample
		move.b	NOTE_VOLUME(a2),d3
		ext.w	d3
		asl.w	#FXADDVOL_LN,d3

		move.w	SAMPLE_VOLUME(a0),d0
		add.w	d3,d0
		cmpi.w	#VOLUME_MIN*$100,d0
		blt.s	PlayLNVAdd_MinVol

		cmpi.w	#(100*$100),d0
		bgt.w	PlayLineNote_X		
		move.w	d0,SAMPLE_VOLUME(a0)
		bra	PlayLineNote_X

	acode
PlayLNVAdd_MinVol
		move.w	#VOLUME_MIN*$100,SAMPLE_VOLUME(a0)
		bra	PlayLineNote_X

	acode
PlayNotePSLIDETO
		jsr	PlayNoteGetInstr
		jsr	PlayNoteGetSample
		move.l	SAMPLE_FREQUENZ(a0),d7
			jsr	PlayNotePitch
			move.l	SAMPLE_FREQUENZ(a0),SAMPLE_DESTFREQUENZ(a0)
		move.l	d7,SAMPLE_FREQUENZ(a0)
		moveq	#0,d3
		move.b	NOTE_VOLUME(a2),d3
		move.w	d3,SAMPLE_PSLIDETOSPD(a0)
		tst.w	d3
		bne.w	PlayLineNote_X
		clr.l	SAMPLE_DESTFREQUENZ(a0)
		bra	PlayLineNote_X


		move.l	SAMPLE_FREQUENZ(a0),d0
			jsr	PlayNotePitch
			move.l	SAMPLE_FREQUENZ(a0),SAMPLE_DESTFREQUENZ(a0)
		lsr.l	#1,d0
		move.l	d0,SAMPLE_FREQUENZ(a0)
		moveq	#0,d3
		move.b	NOTE_VOLUME(a2),d3
		move.w	d3,SAMPLE_PSLIDETOSPD(a0)
		bra	PlayLineNote_X

	acode
PlayNoteRETRIG
		jsr	PlayNoteGetSample
		moveq	#0,d3
		move.b	NOTE_INSTR(a2),d3
		addq.w	#1,d3
		move.w	d3,SAMPLE_RETRIGCYCL(a0)
		move.w	d3,SAMPLE_RETRIGCOUNT(a0)
		move.b	NOTE_VOLUME(a2),d3
		addq.w	#1,d3
		move.w	d3,SAMPLE_RETRIGNUMB(a0)
	bra	PlayLineNote_X

	acode
PlayNoteShEmphasis
		jsr	PlayNoteGetSample
		move.b	NOTE_VOLUME(a2),SAMPLE_VFADE(a0)
		moveq	#0,d3
		move.b	NOTE_INSTR(a2),d3
		move.w	d3,SAMPLE_VFADESTART(a0)
		move.b	NOTE_PITCH(a2),d3
		move.w	d3,SAMPLE_VFADEEND(a0)
	bra	PlayLineNote_X

	acode
ReplayFXStartPitch
		jsr	PlayNoteGetInstr
		jsr	PlayNoteGetSample
		jsr	PlayNotePitch
		jsr	PlayNoteInstr
		moveq	#0,d3
		move.b	NOTE_VOLUME(a2),d3
	bra.s	LineNote_ReplayFrom

	acode
ReplayFXStartSample
		jsr	PlayNoteGetInstr
		jsr	PlayNoteGetSample
		cmpi.b	#NOTEPITCH_NONOTE,NOTE_PITCH(a2)
		beq.s	ReplayFXStartSample_NoI
		jsr	PlayNoteInstr
ReplayFXStartSample_NoI
		moveq	#0,d3
		move.b	NOTE_VOLUME(a2),d3

LineNote_ReplayFrom


		tst.w	SAMPLE_SAVIBDEPTH(a0)
		beq.s	LineNote_ReplayFromNoVib

			move.w	SAMPLE_SAVIBLFOACTUAL(a0),d0
			move.l	SaVibratoTab_PTR,a1
			lsr.w	#1,d0
			move.w	(a1,d0.w*2),d0
			addi.w	#$7f,d0
			mulu	SAMPLE_SAVIBDEPTH(a0),d0
			lsr.l	#8,d0
			mulu	d3,d0
			lsr.l	#8,d0
			sub.w	d0,d3
			bpl.s	LineNote_ReplayFromNoVib
			moveq	#0,d3

LineNote_ReplayFromNoVib

		move.l	SAMPLE_ENDPTR(a0),d2
		move.l	SAMPLE_STARTPTR(a0),d1
		sub.l	d1,d2
		lsr.l	#8,d2
		mulu	d3,d2
		add.l	d2,d1

		IFNE	SYMPHPRO
		bclr	#0,d1
		ENDC
		move.l	d1,SAMPLE_PTR(a0)
		move.l	d1,SAMPLE_RETRIGPTR(a0)

		move.l	SAMPLE_FROMADD(a0),d4
		move.l	SAMPLE_ENDPTR(a0),d2
		move.l	SAMPLE_STARTPTR(a0),d1
		sub.l	d1,d2
		lsr.l	#8,d2
		mulu	d3,d2
		add.l	d2,d4
		tst.l	d4
		bpl.s	LineNote_ReplayFrom_BGNOK
			move.l	d2,d4
			neg.l	d4
			move.l	d4,SAMPLE_FROMADD(a0)	;NEW MODIFICATION
			moveq	#0,d4
LineNote_ReplayFrom_BGNOK
		add.l	d4,d1
		IFNE	SYMPHPRO
		bclr	#0,d1
		ENDC
		move.l	d1,SAMPLE_PTR(a0)
		move.l	d1,SAMPLE_RETRIGPTR(a0)
		move.b	#FALSE,SAMPLE_ENDREACHED(a0)
		move.w	#SAMPLEST_INUSE,SAMPLE_STATUS(a0)
		move.b	#-1,SAMPLE_DECLICK(a0)		;FADESAMPLE
		clr.l	SAMPLE_HIOFFSET(a0)
	bra	PlayLineNote_X

	acode
PlayLineNote_DspOn
	bra	PlayLineNote_X
	acode
PlayLineNote_DspOff
	bra	PlayLineNote_X

	acode
PlayLineNote_Vibrato
	jsr	PlayNoteGetSample
	move.b	NOTE_VOLUME(a2),SAMPLE_VIBDEPTH+1(a0)
	move.b	NOTE_INSTR(a2),SAMPLE_VIBLFOADD+1(a0)
	tst.w	NOTE_VI(a2)
	bne.w	PlayLineNote_X
	clr.w	SAMPLE_VIBLFOACTUAL(a0)
	bra	PlayLineNote_X

	acode
PlayLineNote_Tremolo
	jsr	PlayNoteGetSample
	move.b	NOTE_VOLUME(a2),SAMPLE_TREMDEPTH+1(a0)
	move.b	NOTE_INSTR(a2),SAMPLE_TREMLFOADD+1(a0)
	tst.w	NOTE_VI(a2)
	bne.w	PlayLineNote_X
	clr.w	SAMPLE_TREMLFOACTUAL(a0)
	bra	PlayLineNote_X

	acode
PlayLineNote_SampleVib
	jsr	PlayNoteGetSample
	move.b	NOTE_VOLUME(a2),SAMPLE_SAVIBDEPTH+1(a0)
	move.b	NOTE_INSTR(a2),SAMPLE_SAVIBLFOADD+1(a0)
	;bra	PlayLineNote_X				BUG FIXED

	tst.w	NOTE_VI(a2)
	bne.w	PlayLineNote_X

	clr.w	SAMPLE_SAVIBLFOACTUAL(a0)
	clr.w	SAMPLE_SAVIBDEPTH(a0)

	bra	PlayLineNote_X


	acode
InitSong	;V1.3
		;1.2	Sequence
		;1.3	SONG_LineSize
		;I(A0L)(SONG)
	BGN
	bsr	UpdateSongSeqPtr
	move.l	Actual_FREQDEF(PC),SONG_FREQLIST(a0)

	move.w	#Test_PosNumb,SONG_NUMBSONGDATA(a0)

	move.l	SONG_ACTUALSEQ(a0),a2
	move.w	SEQUENCE_LENGTH(a2),SONG_SEQCOUNT(a0)		;INIT SONG
	move.w	SONG_SPEED(a0),SONG_SPEEDCOUNT(a0)
	move.l	SONG_FIRSTSONGDATA(a0),a1

	move.w	SONG_NUMBVOICES(a0),d2
	mulu	#NOTE_SIZEOF,d2
	move.w	d2,SONG_LINESIZE(a0)

	move.w	SEQUENCE_TUNE(a2),SequenzTune

	move.w	SEQUENCE_STARTPOS(a2),d2
	mulu	#POSITION_SIZEOF,d2
	add.l	d2,a1
	move.l	a1,SONG_ACTSONGDATA(a0)

	move.w	SONG_NUMBSONGDATA(a0),d7	;SONG_NUMBSONGDATA ist falsch !!!! DEBUG
	subq.w	#1,d7

	move.l	SONG_FIRSTSONGDATA(a0),a5
;;;	move.w	#0,SONG_POSITION(a0)

	move.w	POSITION_SPEED(a1),SONG_SPEED(a0)


;	move.l	#Test_PosNumb-1,d7
InitSong_L
		move.l	a5,a0
		jsr	SetPatHeadPTR
		move.l	POSITION_PATHEADPTR(a5),a3
		move.w	#PATHEADST_DORESET,PATHEAD_STATUS(a3)

		move.w	POSITION_LOOPNUMB(a5),POSITION_LOOPCOUNT(a5)
		move.l	(a5),a4
		lea.l	POSITION_SIZEOF(a5),a5
	dbf	d7,InitSong_L

	RET


	acode
GetPlayedPosSeq
	puts	d1-a6
	moveq	#0,d7

	moveq	#0,d6

	lea.l	Test_SONG,a1
	move.w	SONG_SEQNUM(a1),d6
	move.l	d6,d0
	mulu	#SEQUENCE_SIZEOF,d0
	move.l	SONG_FIRSTSEQ(a1),a0
	lea.l	(a0,d0.w),a0
	bra.s	GetPlayedPos_L

	acode
GetPlayedPos
	puts	d1-a6
	moveq	#0,d7

	moveq	#0,d6
	lea.l	Test_SONG,a1
	move.w	SONG_SEQNUM(a1),d0
	mulu	#SEQUENCE_SIZEOF,d0
	move.l	SONG_FIRSTSEQ(a1),a0

GetPlayedPos_L
	tst.w	SEQUENCE_LOOP(a0)
	beq.s	GetPlayedPos_Next
	cmpi.w	#SEQINFO_SKIP,SEQUENCE_INFO(a0)
	beq.s	GetPlayedPos_Next	
	cmpi.w	#SEQINFO_ENDSONG,SEQUENCE_INFO(a0)
	beq.s	GetPlayedPos_End	
	tst.w	SEQUENCE_LENGTH(a0)
	beq.s	GetPlayedPos_Next

	moveq	#0,d5
	move.w	SEQUENCE_LENGTH(a0),d5
	add.l	d5,d7	

GetPlayedPos_Next	
	lea.l	SEQUENCE_SIZEOF(a0),a0

	addq.w	#1,d6
	cmpi.w	#Test_SeqNumb,d6
	blo.s	GetPlayedPos_L

GetPlayedPos_End
	move.l	d7,d0
	IFNE	TESTPRGB
	jsr	WriteAssDecLong
	ENDC
	gets	d1-a6
	rts

	acode
UpdateSongSeqPtr
	puts	d0/a0-a1
	lea.l	Test_SONG,a1
	move.w	SONG_SEQNUM(a1),d0
	mulu	#SEQUENCE_SIZEOF,d0
	move.l	SONG_FIRSTSEQ(a1),a0
	lea.l	(a0,d0.w),a0
	move.l	a0,SONG_ACTUALSEQ(a1)
	move.w	SEQUENCE_TUNE(a0),SequenzTune
	gets	d0/a0-a1
	rts

	acode
ReInitSong	;V1.3
		;1.2	Sequence
		;1.3	SONG_LineSize
		;I(A0L)(SONG)
	BGN
	bsr	UpdateSongSeqPtr
	move.l	SONG_ACTUALSEQ(a0),a2
	move.w	SEQUENCE_LENGTH(a2),SONG_SEQCOUNT(a0)		;INIT SONG

	move.w	SONG_NUMBVOICES(a0),d2
	mulu	#NOTE_SIZEOF,d2
	move.w	d2,SONG_LINESIZE(a0)

	move.w	SEQUENCE_TUNE(a2),SequenzTune


	move.w	SEQUENCE_STARTPOS(a2),d2
	mulu	#POSITION_SIZEOF,d2
	move.l	SONG_FIRSTSONGDATA(a0),a1
	lea.l	(a1,d2.l),a1
	move.l	a1,SONG_ACTSONGDATA(a0)			;A1L FIRST SONGDATA

	move.w	POSITION_SPEED(a1),SONG_SPEED(a0)
	move.w	POSITION_SPEED(a1),SONG_SPEEDCOUNT(a0)

;	move.w	SEQUENCE_LENGTH(a2),SONG_NUMBSONGDATA(a0)

	move.w	SONG_NUMBSONGDATA(a0),d7	;SONG_NUMBSONGDATA ist OBSOLETE ??
	subq.w	#1,d7

	move.l	SONG_FIRSTSONGDATA(a0),a5
;;;	move.w	#0,SONG_POSITION(a0)



	move.l	#Test_PosNumb-1,d7
ReInitSong_L
		move.l	a5,a0
		jsr	SetPatHeadPTR
		move.l	POSITION_PATHEADPTR(a5),a3
		move.w	#PATHEADST_DORESET,PATHEAD_STATUS(a3)

		move.w	POSITION_LOOPNUMB(a5),POSITION_LOOPCOUNT(a5)
		move.l	(a5),a4
		lea.l	POSITION_SIZEOF(a5),a5
	dbf	d7,ReInitSong_L

	RET

	acode
ReInitSongSeq	;V1.3
		;1.2	Sequence
		;1.3	SONG_LineSize
		;I(A0L)(SONG)
	BGN
	bsr	UpdateSongSeqPtr
	move.l	SONG_ACTUALSEQ(a0),a2
	move.w	SEQUENCE_LENGTH(a2),SONG_SEQCOUNT(a0)		;INIT SONG

	move.w	SONG_NUMBVOICES(a0),d2
	mulu	#NOTE_SIZEOF,d2
	move.w	d2,SONG_LINESIZE(a0)

	move.w	SEQUENCE_TUNE(a2),SequenzTune


	move.w	SEQUENCE_STARTPOS(a2),d2
	mulu	#POSITION_SIZEOF,d2
	move.l	SONG_FIRSTSONGDATA(a0),a1
	lea.l	(a1,d2.l),a1
	move.l	a1,SONG_ACTSONGDATA(a0)			;A1L FIRST SONGDATA

	move.w	POSITION_SPEED(a1),SONG_SPEED(a0)
	move.w	POSITION_SPEED(a1),SONG_SPEEDCOUNT(a0)

;	move.w	SEQUENCE_LENGTH(a2),SONG_NUMBSONGDATA(a0)

	move.w	SONG_NUMBSONGDATA(a0),d7	;SONG_NUMBSONGDATA ist OBSOLETE ??
	subq.w	#1,d7

	move.l	SONG_FIRSTSONGDATA(a0),a5
;;;	move.w	#0,SONG_POSITION(a0)



	move.l	#Test_PosNumb-1,d7
ReInitSongSeq_L
		move.l	a5,a0
		;;;jsr	SetPatHeadPTR
		move.l	POSITION_PATHEADPTR(a5),a3
		move.w	#PATHEADST_DORESET,PATHEAD_STATUS(a3)

		move.w	POSITION_LOOPNUMB(a5),POSITION_LOOPCOUNT(a5)
		move.l	(a5),a4
		lea.l	POSITION_SIZEOF(a5),a5
	dbf	d7,ReInitSongSeq_L

	RET


	IFNE RENDER
	acode
PlayRendSong
	BGN
	jsr	GetPlayedPos
	tst.l	d0
	beq.s	PlayRendSong_X
	eori.b	#-1,SOUNDRENDER
	bsr	PlayActualSong
	eori.b	#-1,SOUNDRENDER
PlayRendSong_X	RET
	ENDC
	
	acode
InitPSong
	BGN
	lea.l	Test_SONG,a0
	jsr	MoveFirstPlayedSeq
	jsr	InitSong
	jsr	MoveFirstPosition
	jsr	SetUpdatePos
	jsr	ResetGotoNextLine

	jsr	ResetRelMasterTime


	RET


	acode
PlayActualSong	BGN
	jsr	GetPlayedPos
	tst.l	d0
	beq.s	.exit

	ASSTXT	PlaySo_TXT
	jsr	BlockRangeOff
	jsr	ResetChannels
	lea.l	Test_SONG,a0
	jsr	MoveFirstPlayedSeq
	jsr	InitSong
	jsr	MoveFirstPosition
	jsr	SetUpdatePos
	jsr	ResetGotoNextLine

	jsr	ResetRelMasterTime

	IFNE	RENDER
	tst.b	SOUNDRENDER
	bne.s	PlayASRender
	ENDC

	move.w	#TRUE,PLAYER_STATUS
	jsr	ShowSongInfo
	jsr	ShowSongInfo2
	jsr	DrawSequence
.exit	RET



	IFNE	RENDER
	acode
PlayASRender
	clr.l	RIlastvalue
	jsr	GetAssistData
	jsr	NGRNrm1DrMd

	ASSTXT	PlayRen_TXT

	lea.l	Rend_MATCH,a0
	jsr	SetFileRequestPat

	moveq	#PBUFID_RENDER,d0
	jsr	GetPathBuf

	lea.l	Rend_TXT,a0
	jsr	SimpleFileRequest
	jsr	SavePathBuf
	tst.w	d0
	beq	.exit

	move.l	FinalFileNameRT_PTR,a0

	move.w	#TRUE,PLAYER_STATUS
	bsr	SetRenderMode
	clr.l	RendLen

	move.l	#MODE_NEWFILE,d0
	jsr	EasyDOpenFFN
	tst.l	d0
	beq.w	.ERR


	jsr	PrintRenderInfo

	clr.b	Rend_EXIT
	clr.l	RendLen

	jsr	ScrollAss

	bsr	WritePreRend
	clr.b	Render_SILENCE


	move.b	#-1,EasyDWBuf_STATUS		;Buffer Start
	jsr	EasyDClrBLen

	ASSTATUS RenderBgnStatus

.loop	jsr	CheckResidentMem
		jsr	CheckBufferMem
		jsr	ProcessAllNGWinMsg

		tst.b	Rend_EXIT
		bne.s	.X

		lea.l	Test_SONG(PC),a0
		bsr	PlaySong
		bsr	CheckForcedUpdate
		bsr	ChangeBuffers
		bsr	CopyVoiceBuffer


		tst.b	Render_SILENCE
		beq.s	.SKIP

			move.l	RendLen+4,d0
			move.l	RenderBuffer_PTR(PC),a0
			add.l	d0,RendLen

			;jsr	EasyDWrite
			jsr	EasyDWriteBuf		;Buffered
			tst.l	d0
			beq	.ERR

.SKIP	jsr	ProcessAutoUpdate

		;move.l	ControlWin_PTR,a0
		;lea.l	CONTROLWIN_JUMPLIST,a1
		;jsr	ProcessWindowMsg

	
		move.l	RendLen,d0
		move.b	#-1,AssistScroll
		;jsr	EasyDGetBLen
		;jsr	WriteAssDecLong
		Jsr	PrintRenderInfoSize
		clr.b	AssistScroll

		bsr	LMButton
	beq.s	.loop


.X	jsr	EasyDFlushBuf			;Buffered
.QUIT	jsr	EasyDGetBLen
	jsr	WriteAssDecLong
	bsr	WritePostRend

.exit	;move.w	#FALSE,IRQStuff_STATUS

	jsr	EasyDClose
	move.w	#FALSE,PLAYER_STATUS

	ASSTATUS RenderEnd0
	jsr	Wait5Secs

	move.l	#1,OverSample3
	jsr	DrawOS3Status
	ASSTXT	RenderDone_TXT

	jsr	ResetChannels
	IFEQ	SOUND14BIT
	jsr	SetStereo9Mode
	ELSE
	jsr	SetStereo14Mode
	ENDC

	jsr	SetResync
	;jsr	RebuildSoundSystem		;Test
	;jsr	DoRestart

	ASSTATUS RenderEnd1	

	move.l	#"SY4C",d0
	moveq	#0,d2
	jsr	NGSetPopGadID
	RET
.ERR
	ASSTXT	RendERR_TXT
	bra	.QUIT

	acode
WritePreRend
	moveq	#0,d0
	move.b	RenderF,d0
	lea.l	RenderPre_TAB(PC),a0
	jsr	ProcTabLongtoLong
	move.l	d0,a0
	tst.l	d0
	bmi.s	NoPreRend
		jsr	(a0)
NoPreRend
	rts

WritePostRend
	move.l	PostRend_JSR(PC),a0
	jsr	(a0)	
	rts
PostRend_JSR	dc.l	RendNil



RendWConv_JSR	dc.l	RendNil		;Word
RendConv_JSR	dc.l	RendNil		;Byte

RenderPre_TAB	dc.l	0,RendPre0,1,RendPre1,2,RendPre2,3,RendPre3,-1,-1

RendNil	rts

RendPre0
	move.l	#RendNil,PostRend_JSR
	move.l	#RendNil,RendConv_JSR
	move.l	#RendNil,RendWConv_JSR
	rts

RendPre1
	move.l	#RendPost1,PostRend_JSR
	move.l	#RendNil,RendWConv_JSR
	move.l	#RendNil,RendConv_JSR
	lea.l	RenderMaestroHead_ADR+4,a0
	jsr	GetSystemFreq
	move.l	d0,20(a0)

	clr.l	12(a0)
	cmpi.b	#1,RenderMode+1
	beq.s	MaestroH_Stereo
		move.l	#$00010000,12(a0)
MaestroH_Stereo
	lea.l	RenderMaestroHead_ADR,a0
	move.l	(a0)+,d0
	jsr	EasyDWrite
	rts

RendPre2
	move.l	#RendPost2,PostRend_JSR
	move.l	#RendNil,RendWConv_JSR
	move.l	#RendNil,RendConv_JSR

	lea.l	RenderWaveHead_ADR+4,a0
	jsr	GetSystemFreq

	moveq	#0,d0
	move.b	RenderMode,d0

	moveq	#1,d1
	cmpi.b	#8,d0
	beq.s	RendP2_M1
		moveq	#2,d1
RendP2_M1
	move.b	d0,34(a0)		;SAMPLERESOLUTION

	move.w	#$0100,d0

	cmpi.b	#0,RenderMode+1
	beq.s	RendP2_M2
		move.w	#$0200,d0	;Stereo
		lsl.w	#1,d1
RendP2_M2

	move.w	d0,22(a0)
	move.b	d1,32(a0)		;BYTEPERSAMPLE

	lea.l	RenderWaveHead_ADR,a0
	move.l	(a0)+,d0
	jsr	EasyDWrite

	rts

RendPGetLen
	;move.l	RendLen,d0
	jsr	EasyDGetBLen
	rts

RendPost0
	rts

RendPost1
	bsr	RendPGetLen
	moveq	#0,d1
	move.w	RendSampDivLn,d1
	add.w	RendSampDivLn+2,d1
	lsr.l	d1,d0

	moveq	#16,d1
	jsr	EasyDWriteLong
	rts

RendPost2
	bsr	RendPGetLen
	move.l	d0,d2

	jsr	LongSwapEndian
	moveq	#40,d1
	jsr	EasyDWriteLong

	move.l	d2,d0
	addi.l	#36,d0
	jsr	LongSwapEndian
	moveq	#4,d1
	jsr	EasyDWriteLong

	rts

RendPre3				;AIFF FORMAT
	move.l	#RendPost3,PostRend_JSR
	move.l	#RendNil,RendWConv_JSR
	move.l	#RendNil,RendConv_JSR
	;move.l	#RendPost3,PostRend_JSR
	;move.l	#RendConvMaud16,RendWConv_JSR
	;move.l	#RendConvMaud8,RendConv_JSR

	;jsr	GetSystemFreq
	;move.w	d0,30(a0)	;FREQ

	lea.l	RenderAiffHead_ADR,a0
	move.l	#RenderAiffHead_ADRE-RenderAiffHead_ADR,d0
	jsr	EasyDWrite
	rts

RendPost3	;AIFF VARIANT I
	bsr	RendPGetLen		;Sample Chunk len
	move.l	#RenderAiffHead_ADRE-RenderAiffHead_ADR-4,d1
	jsr	EasyDWriteLong

	bsr	RendPGetLen		;Sample Number (len / 4)
	lsr.l	#2,d0
	move.l	#22,d1
	jsr	EasyDWriteLong

	bsr	RendPGetLen		;Total File le
	addi.l	#RenderAiffHead_ADRE-RenderAiffHead_ADR-8,d0
	moveq	#4,d1
	jsr	EasyDWriteLong
	rts


RenderAiffHead_ADR
	dc.l	"FORM",$00066D5E,"AIFF"

	dc.l	"COMM",$00000012
	dc.l	$00020006,$3e1c0010,$400EAC44,$00000000
	dc.w	0

	dc.l	"SSND",$00066BDC
RenderAiffHead_ADRE





RendPDiv	dc.l	1



	acode
PrintRenderInfo
	BGN
	bsr	RenderFormatDrawBools
	jsr	GetAssistData
	cmp.l	#0,a1
	beq.s	.exit
	jsr	DrawOS3Status
	moveq	#0,d0
	move.b	RenderF,d0
	lea.l	RenderF_TAB,a0
	jsr	ProcTabLongtoLong
	move.l	d0,a0
	tst.l	d0
	bmi.s	.NoRendText
	jsr	PrintAssText
.NoRendText
	moveq	#0,d0
	move.w	RenderMode,d0
	lea.l	RendMdTxtList,a0
	jsr	ProcTabLongtoLong
	move.l	d0,a0
	tst.l	d0
	bmi.s	.exit
	jsr	PrintAssText
	moveq	#FALSE,d1
	tst.b	RenderMode+2
	beq.s	.nodos
	moveq	#TRUE,d1
	lea.l	RendDos,a0
	jsr	PrintAssText
.nodos	move.l	#"SY45",d0
	jsr	NGSetGadBool
.exit	RET

	acode
RenderFormatDrawBools
	BGN
	moveq	#0,d3
	move.b	RenderF,d3
	lea.l	RendMdTypeList,a0	
.next	move.l	(a0)+,d2
	move.l	(a0)+,d0
	moveq	#FALSE,d1
	cmp.b	d3,d2
	bne.s	.off1
	moveq	#TRUE,d1
.off1	jsr	NGSetGadBool
	tst.l	(a0)
	bpl.s	.next
	RET



	acode
RenderCheckSilence
	tst.b	Render_SILENCE
	beq.s	.go
	rts
.go	puts	d0/a1
	subq.w	#1,d0
.Silence_L
		tst.l	(a1)+
		bne.s	.found
	dbf	d0,.Silence_L
.exit	gets	d0/a1
	rts
.found
	move.b	#-1,Render_SILENCE
	bra.s	.exit

CopyBackRender
	;--- DO OVERSAMPLE 3 ---
	IFNE OS3
	bsr	DoOversample3
	ENDC

	puts	a0
	move.l	d0,RendLen+4

	bsr	RenderCheckSilence
	cmpi.b	#16,RenderMode
	beq.s	CopyBackRend16

	andi.l	#$ffff,d0

	cmpi.b	#1,RenderMode+1
	beq.s	CopyBackRendSte

	move.l	RenderBuffer_PTR(PC),a0
	subq.w	#1,d0
	jsr	GetCopyBackShift
.loop	move.l	(a1)+,d5
		asr.w	d7,d5
		bsr	ByteToDos
		move.b	d5,(a0)+
	dbf	d0,.loop
	gets	a0
	rts

	acode
CopyBackRendSte

	move.l	d0,d5
	lsl.l	#1,d5
	move.l	d5,RendLen+4

	move.l	RenderBuffer_PTR(PC),a0
	subq.w	#1,d0
	jsr	GetCopyBackShift
.loop	move.l	(a1)+,d5
		asr.w	d7,d5
		bsr	ByteToDos
		move.b	d5,(a0)+
		swap	d5
		asr.w	d7,d5
		bsr	ByteToDos
		move.b	d5,(a0)+
	dbf	d0,.loop
	gets	a0
	rts


	acode
CopyBackRend16
	andi.l	#$ffff,d0

	move.l	d0,d5
	lsl.l	#1,d5
	cmpi.b	#1,RenderMode+1
	beq.w	CopyBackRend16Ste

	move.l	d5,RendLen+4

	move.l	RenderBuffer_PTR(PC),a0
	subq.w	#1,d0

	;jsr	GetCopyBack16BitShift

	puts	d0/a0
.loop	move.l	(a1)+,d5
		;asl.w	d7,d5
		move.l	d5,(a0)+
	dbf	d0,.loop
	gets	d0/a0
	move.l	a0,a1
.loop2	move.l	(a1)+,d5
		bsr	WordToDos
		move.w	d5,(a0)+
	dbf	d0,.loop2

	gets	a0
	rts

	acode
CopyBackRend16Ste
	lsl.l	#1,d5
	move.l	d5,RendLen+4
	move.l	RenderBuffer_PTR(PC),a0
	subq.w	#1,d0

.loop2	move.l	(a1)+,d5
	bsr	WordToDos
	swap	d5
	bsr	WordToDos
	swap	d5
	move.l	d5,(a0)+
	dbf	d0,.loop2
	gets	a0
	rts


RendConvMaud16
	rts
RendConvMaud8
	addi.b	#$80,d5
	rts

WordSwapEndian
	puts	d1
	move.b	d0,d1
	lsr.w	#8,d0
	lsl.w	#8,d1
	or.w	d1,d0
	gets	d1
	rts

LongSwapEndian
	bsr	WordSwapEndian
	swap	d0
	bsr	WordSwapEndian
	rts	

	acode
WordToDos
	puts	a0
	move.l	RendWConv_JSR(PC),a0
	jsr	(a0)
	gets	a0
	tst.b	RenderMode+2
	bne.s	WordToDosDo
	rts
WordToDosDo
	move.w	d5,WordConv
	move.b	WordConv+1,d5
	lsl.w	#8,d5
	move.b	WordConv,d5
	rts

	acode
ByteToDos
	puts	a0
	move.l	RendConv_JSR(PC),a0
	jsr	(a0)
	gets	a0
	tst.b	RenderMode+2
	bne.s	ByteToDosDo
	rts
ByteToDosDo	addi.b	#128,d5
	rts

WordConv	dc.l	0

	ENDC

	IFNE	RENDER
	acode
RendFRaw	move.b	#0,RenderF
		jsr	PrintRenderInfo
		rts
RendFMaestro	move.b	#1,RenderF
		move.b	#0,RenderMode+2
		bsr	Rend16
		jsr	PrintRenderInfo
		rts
RendFWave	move.b	#2,RenderF
		move.b	#-1,RenderMode+2
		jsr	PrintRenderInfo
		rts
RendFMaud	move.b	#3,RenderF
		move.b	#0,RenderMode+2
		jsr	PrintRenderInfo
		rts

RendF	move.b	#0,RenderF
		jsr	PrintRenderInfo
		rts

InitRenderPrefs
	bsr	Rend16
	bsr	RendSte
	bsr	RendFWave
	rts

	acode	
Rend16	puts	d0
	move.b	#16,RenderMode
	move.w	#1,RendSampDivLn
	jsr	PrintRenderInfo
	move.l	#"SY42",d0
	jsr	NGSetGadBoolOn
	move.l	#"SY41",d0
	jsr	NGSetGadBoolOff
	gets	d0
	rts

	acode
Rend8B	puts	d0
	move.b	#8,RenderMode
	move.w	#0,RendSampDivLn
	jsr	PrintRenderInfo
	move.l	#"SY42",d0
	jsr	NGSetGadBoolOff
	move.l	#"SY41",d0
	jsr	NGSetGadBoolOn
	gets	d0
	rts

	acode
RendMo	move.b	#0,RenderMode+1
	move.w	#0,RendSampDivLn+2
	jsr	PrintRenderInfo
	puts	d0
	move.l	#"SY44",d0
	jsr	NGSetGadBoolOff
	move.l	#"SY43",d0
	jsr	NGSetGadBoolOn
	gets	d0
	rts

	acode
RendSte	move.b	#1,RenderMode+1
	move.w	#1,RendSampDivLn+2
	jsr	PrintRenderInfo
	puts	d0
	move.l	#"SY44",d0
	jsr	NGSetGadBoolOn
	move.l	#"SY43",d0
	jsr	NGSetGadBoolOff
	gets	d0
	rts

	rts

	acode
RendMSDos
	eori.b	#-1,RenderMode+2
	jsr	PrintRenderInfo
	rts

RendSampDivLn	dc.w	0,1
RenderMode	dc.b	16,1,0	;+0 BITDEPTH,    +1 0=MON0 1=STEREO,    +2 DOSMODE [0=NOPE, -1=YES]

	acode
SetRenderMode
	BGN
	clr.w	OverSamp_FLAG
	jsr	RecalcFreqSystem
	move.l	#CopyBackRender,COPYBACK_JR
	IFNE DIRECTAMIGAAUDIO
	move.w	#$00ff,$9e+CUSTOMBASE
	ENDC
	RET



SmoothNumb	dc.l	0,1
RendLen		dc.l	0,0		;TOTAL (SAMPLES), BUFLEN (SAMPLES)
Rend_EXIT	dc.b	0	;-1 =FORCE EXIT
SOUNDRENDER	dc.b	0	;0=nope, -1=yes
	ENDC




	IFNE	RENDER
	acode
SmoothStSample	;16BIT
	tst.l	SmoothNumb
	bne.s	.SmoothStSampleDo
	rts
	acode
.SmoothStSampleDo
	puts	d7
	move.l	SmoothNumb(PC),d7
	subq.l	#1,d7

.loop	puts	a1
		bsr	.SmoothSample
		lea.l	2(a1),a1
		bsr	.SmoothSample
	gets	a1
	dbf	d7,.loop
	gets	d7
	rts



	acode
.SmoothSample
	puts	d0-d7/a0-a1
	subq.w	#2,d0
.SmoothSample_L
		lea.l	4(a1),a1
		move.w	(a1),d5
		cmp.w	4(a1),d5
		beq.s	.SmoothCheck
.SmoothSample_IN
	dbf	d0,.SmoothSample_L
.SmoothSample_X
	gets	d0-d7/a0-a1
	rts


	acode
.SmoothNext
	tst.b	d0
	subq.w	#1,d0
	bmi.s	.SmoothSample_X
	beq.s	.SmoothSample_X
;	lea.l	4(a0),a1
	bra.s	.SmoothSample_L
	

SMOOTHBGN	EQU	0	;BIT
SMOOTHEND	EQU	1	;BIT

	acode
.SmoothCheck	;(D5W:COMPARE VALUE ,A1L:FIRST SAMPLE)
	move.l	a1,a0
.SmoothCheck_L
	lea.l	4(a0),a0
	cmp.w	(a0),d5
	dbne	d0,.SmoothCheck_L


.DoSmooth	;D0W -1 = NO SMOOTH END
	moveq	#0,d3
	move.l	a0,d2			;A0L LAST SAMPLE
	sub.l	a1,d2
	lsr.l	#2,d2			;D2L SMOOTH LENGTH

	tst.w	d0
	beq.s	.ChkSmoothBgn

	cmpi.w	#-1,d0
	beq.s	.ChkSmoothBgn

	move.w	4(a0),d4
	sub.w	d5,d4
	exg	d4,d0
	jsr	MakeD0WPos
	exg	d4,d0
	cmpi.w	#1,d4
	bls.s	.ChkSmoothBgn

	bset	#SMOOTHEND,d3


.ChkSmoothBgn
	move.w	-4(a1),d4
	sub.w	d5,d4
	exg	d4,d0
	jsr	MakeD0WPos
	exg	d4,d0
	cmpi.w	#1,d4
	bls.s	.Smoothen

	bset	#SMOOTHBGN,d3
	
.Smoothen
	ext.l	d5

	tst.b	d3
	beq.s	.SmoothNext

	btst	#SMOOTHBGN,d3
	beq.s	.Smoothen_END

	move.w	-4(a1),d4
	ext.l	d4
	add.l	d5,d4
	asr.l	#1,d4
	move.w	d4,(a1)
.Smoothen_END
	btst	#SMOOTHEND,d3
	beq.w	.SmoothNext
	move.w	(a0),d4
	ext.l	d4
	add.l	d5,d4
	asr.l	#1,d4
	move.w	d4,-4(a0)
	bra	.SmoothNext

	acode
ToogleSmooth
	eori.b	#-1,SmoothStatus
	rts

	ENDC

	acode
PlayActualSeq	BGN
	jsr	GetPlayedPosSeq
	tst.l	d0
	beq.s	PlayActualSeq_X

	ASSTXT	PlaySe_TXT
	jsr	BlockRangeOff
	jsr	ResetChannels
	lea.l	Test_SONG,a0
	jsr	InitSong
	jsr	ResetRelTime
	jsr	ResetSequenz
	jsr	MoveFirstPosition
	jsr	SetUpdatePos
	jsr	ResetGotoNextLine

	move.w	#TRUE,PLAYER_STATUS
PlayActualSeq_X	RET

	acode
StopSong2
	jsr	SpecEraseOldNote
	jsr	RedrawSpecFull
	jsr	ShowMainTitle
StopSong
	IFNE	RENDER
	tst.b	SOUNDRENDER
	bne	StopSongRender
	ENDC

	jsr	BlockRangeOn
	ASSTXT	Stop_TXT
	jsr	CheckResidentMem
StopActualSong
	move.w	#FALSE,PLAYER_STATUS
	jsr	StopAllChannels
	jsr	SpecEraseOldNote
	jsr	RedrawSpecFull
	rts


StopSong3
	ASSTXT	Stop_TXT
	jsr	CheckResidentMem
	move.w	#FALSE,PLAYER_STATUS
	;jsr	StopAllChannels
	jsr	SpecEraseOldNote
	jsr	RedrawSpecFull
	rts

StopSong4
	ASSTXT	Stop2_TXT
	jsr	CheckResidentMem
	move.w	#FALSE,PLAYER_STATUS
	;jsr	StopAllChannels
	jsr	SpecEraseOldNote
	jsr	RedrawSpecFull
	rts


RedrawSpectrum
	jsr	SpecEraseOldNote
	jsr	RedrawSpec
	rts

	IFNE	RENDER
	acode
StopSongRender
	move.b	#-1,Rend_EXIT
	rts
	ENDC

	acode
PlayFromActualPos	;V2.0
	BGN
	jsr	BlockRangeOff
	jsr	StopAllChannels
	lea.l	Test_SONG,a0
	jsr	InitSong
	jsr	ResetRelTime
	jsr	UpdatePatHeadPtrs
	lea.l	Test_PATTED,a2
	move.w	PATTED_ACTPOSNUM(a2),d0
	move.l	PATTED_ACTUALSONGDATA(a2),a1
	move.l	a1,SONG_ACTSONGDATA(a0)
	move.w	POSITION_SPEED(a1),SONG_SPEED(a0)	
	move.l	SONG_ACTUALSEQ(a0),a2
	move.w	SEQUENCE_LENGTH(a2),d1
	add.w	SEQUENCE_STARTPOS(a2),d1
	sub.w	d0,d1
	bmi.s	.illpos
	tst.w	d1
	bne.s	.ok

.illpos	move.w	#Test_PosNumb,d1
	sub.w	d0,d1

.ok	move.w	d1,SONG_SEQCOUNT(a0)		;ANZAHL POS
	jsr	SetUpdatePos
	jsr	ResetGotoNextLine
	move.w	#TRUE,PLAYER_STATUS
	jsr	PatEdDrawTitle

	moveq	#0,d0
	lea.l	Test_PATTED,a2
	move.w	PATTED_ACTPOSNUM(a2),d0

	move.w	d0,d2
	lea.l	DecWordSave,a0
	jsr	ConvertToDecWord
	lea.l	PlayPo_TXT+22,a1

	lea.l	DecWordSave+2,a0
	move.b	(a0)+,(a1)+
	move.b	(a0)+,(a1)+
	move.b	(a0)+,(a1)+

	lea.l	DecWordSave,a0
	move.w	d1,d0
	jsr	ConvertToDecWord
	lea.l	PlayPo_TXT+23+11,a1
	lea.l	DecWordSave+2,a0
	move.b	(a0)+,(a1)+
	move.b	(a0)+,(a1)+
	move.b	(a0)+,(a1)+

	lea.l	DecWordSave,a0
	move.w	d1,d0
	add.w	d2,d0
	subq.w	#1,d0
	jsr	ConvertToDecWord
	lea.l	PlayPo_TXT+23+6,a1
	lea.l	DecWordSave+2,a0
	move.b	(a0)+,(a1)+
	move.b	(a0)+,(a1)+
	move.b	(a0)+,(a1)+
	ASSTXT	PlayPo_TXT
	RET

	acode
ForceAllTracksOff
	movem.l	d0/a0,-(a7)
	lea.l	PlayTrackInfo,a0
	move.w	CHANNEL_NUMB,d0
	subq.w	#1,d0
ForceAllTracksOff_L	clr.b	(a0)+
		dbf	d0,ForceAllTracksOff_L
	movem.l	(a7)+,d0/a0
	rts

	acode
ForceAllTracksOn
	movem.l	d0/a0,-(a7)
	lea.l	PlayTrackInfo,a0
	move.w	CHANNEL_NUMB,d0
	subq.w	#1,d0
ForceAllTracksOn_L	move.b	#-1,(a0)+
	dbf	d0,ForceAllTracksOn_L
	movem.l	(a7)+,d0/a0
	rts

	acode
PlayActualPattern
	ASSTXT	PlayPa_TXT
	jsr	BlockRangeOff
	BGN
	jsr	SetUpdatePos
	jsr	ResetGotoNextLine

	lea.l	Test_SONG,a0
	jsr	ForcePlayOnePattern

	move.w	#TRUE,PLAYER_STATUS
	jsr	PatEdDrawTitle
	RET
	acode
ProcTabValuetoLong	;V1.0
			;I(D0B,A0L)(VALUE,CONVERTAB)
	puts	d1-d2
ProcTabValuetoLong_L
		movem.l	(a0)+,d1-d2
		cmpi.l	#-1,d2
		bne.s	ProcTabValuetoLong_N
			cmpi.l	#-1,d1
			beq.s	ProcTabValuetoLong_F
ProcTabValuetoLong_N
	cmp.b	d1,d0
	bne.s	ProcTabValuetoLong_L

ProcTabValuetoLong_F
		move.l	d2,d0
	gets	d1-d2
	rts

	acode
ProcTabLongtoLong	;V1.0
			;I(D0B,A0L)(VALUE,CONVERTAB)
	puts	d1-d2
ProcTabLongtoLong_L
		movem.l	(a0)+,d1-d2
		cmpi.l	#-1,d2
		bne.s	ProcTabLongtoLong_N
			cmpi.l	#-1,d1
			beq.s	ProcTabLongtoLong_F
ProcTabLongtoLong_N
	cmp.l	d1,d0
	bne.s	ProcTabLongtoLong_L
ProcTabLongtoLong_F
		move.l	d2,d0
	gets	d1-d2
	rts



	acode
ClearNote
	;V1.0
	;I(A0L)(PETTED)
	BGN
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1

	move.b	#NOTEPITCH_NONOTE,NOTE_PITCH(a1)
	clr.b	NOTE_INSTR(a1)
	clr.b	NOTE_VOLUME(a1)
	clr.b	NOTE_FX(a1)
	
	jsr	PattEdMoveNextLine	;;;NEW
	RET

SETNOTE_PITCHB	EQU	0
SETNOTE_INSTRB	EQU	1
SETNOTE_VOLB	EQU	2

	acode
ToogleSoloMode
	eori.b	#-1,SingleKeyboard
	rts
SingleKeyboard	dc.b	0

	acode
ToogleSetNoteP
	bchg	#SETNOTE_PITCHB,SetNote_PREFS
	rts
ToogleSetNoteI
	bchg	#SETNOTE_INSTRB,SetNote_PREFS
	rts
ToogleSetNoteV
	bchg	#SETNOTE_VOLB,SetNote_PREFS
	rts

	acode
SetNote		;V1.0
		;I(D0W,D1W,A0L)(NOTE#,INSTR#,PETTED)
	BGN
	move.b	SetNote_PREFS,d7
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a1
	
	btst	#SETNOTE_PITCHB,d7
		bne.s	SetNote_NP
		move.b	d0,NOTE_PITCH(a1)
SetNote_NP

	btst	#SETNOTE_INSTRB,d7
		bne.s	SetNote_NI
		move.b	d1,NOTE_INSTR(a1)
SetNote_NI

	btst	#SETNOTE_VOLB,d7
	bne.s	.skipv

		
		move.w	KeyboardPunch,d2
		tst.w	d2
		bne.s	.volok
		moveq	#100,d2
.volok		move.b	d2,NOTE_VOLUME(a1)

.skipv	jsr	CopyLockedNotes
	jsr	PatEdDrawActLine

	cmpi.w	#TRUE,PLAYER_STATUS
	bne.s	.scroll

	lea.l	AutoUpdate_DrPos,a2
	cmpi.l	#TRUE,UPENTRY_ENABLE(a2)
	bne.s	.scroll

	lea.l	AutoUpdate_NextLine,a2
	cmpi.l	#TRUE,UPENTRY_ENABLE(a2)
	beq.s	SetNote_X

.scroll
		jsr	PattEdMoveNextLines
SetNote_X
	RET


	acode
CheckNoteIsFX	;V1.0
	moveq	#FALSE,d0
	cmpi.b	#FX_MAX,NOTE_FX(a0)
	bhi.s	CheckNoteIsFX_X
	cmpi.b	#FX_MIN,NOTE_FX(a0)
	blo.s	CheckNoteIsFX_X
		moveq	#TRUE,d0
CheckNoteIsFX_X	rts

	acode
GetActNote	;V1.0 DOUBLE ??
		;O(A0L)(ACTUALNOTE_PTR)
	puts	d0-d7/a1-a6
	jsr	GetActualPattEd
	jsr	CalcActNoteData
	move.l	PATTED_ACTNOTEDATA(a0),a0
	gets	d0-d7/a1-a6
	rts

	acode
PlayNote	;V1.0
		;I(D0L,A0L)(NOTE[0..24],INSTRUMENT)
	puts	d0/a0
	bsr.w	GetNoteFreq
	bsr.b	PlayFreq
	gets	d0/a0
	rts

	acode
PlayFreq	;V1.2
		;I(D0L,A0L)(FREQ,INSTRUMENT)
	BGN
	lea.l	Test_VOICEEXPANDER(PC),a5
	move.l	a0,a4
	bsr.w	GetFreeChannel				;GET CHANNEL

	tst.b	SingleKeyboard
	beq.s	.multi

	lea.l	Test_VOICEEXPANDER(PC),a0
	move.l	VOICEEXP_FIRSTSAMPLEPTR(a0),a0

.multi	cmp.l	#0,a0
	beq.s	.exit
	moveq	#VOLUME_MAX,d3
	move.w	KeyboardPunch,d3
	tst.w	d3
	bne.s	.volok
	moveq	#1,d3
.volok	bsr	StartSample
.exit	RET

	acode
TakeChannel	;V1.1
		;I(D0L)(CHANNEL#)
		;O(A0L)(SAMPLE_PTR)
	movem.l	d1/a1,-(a7)
	lea.l	Test_VOICEEXPANDER(PC),a1
	move.w	VOICEEXP_SAMPLESTRUCTSIZE(a1),d1
	mulu	d0,d1
	move.l	VOICEEXP_FIRSTSAMPLEPTR(a1),a0
	movem.l  (a7)+,d1/a1
	rts

	acode
StopAllChannels	;V1.0
	BGN
	move.w	CHANNEL_NUMB,d7
	subq.w	#1,d7
	lea.l	Test_VOICEEXPANDER(PC),a2
	move.l	VOICEEXP_FIRSTSAMPLEPTR(a2),a1

.loop		move.w	#SAMPLEST_PENDING,SAMPLE_STATUS(a1)
		clr.l	SAMPLE_LASTSAMPLE(a1)
		clr.w	SAMPLE_VOLSLIDE(a1)
		clr.w	SAMPLE_PITCHSLIDE(a1)
		move.w	#VOLUME_MAX*$100,SAMPLE_VOLUME(a1)
		clr.b	SAMPLE_DECLICK(a1)

		clr.w	SAMPLE_VIBDEPTH(a1)
		clr.w	SAMPLE_VIBLFOACTUAL(a1)
		clr.w	SAMPLE_TREMDEPTH(a1)
		clr.w	SAMPLE_TREMLFOACTUAL(a1)
		clr.w	SAMPLE_SAVIBDEPTH(a1)
		clr.w	SAMPLE_SAVIBLFOACTUAL(a1)
		clr.l	SAMPLE_DESTFREQUENZ(a1)
		clr.l	SAMPLE_INSTRUMENTPTR(a1)
		clr.b	SAMPLE_VFADE(a1)

		move.w	#100*256,SAMPLE_CVOL(a1)
		clr.w	SAMPLE_CVOLADD(a1)
		clr.w	SAMPLE_CVTYPE(a1)
		clr.w	SAMPLE_DESTVOL(a1)

		clr.l	SAMPLE_FILTERFREQ(a1)
		clr.l	SAMPLE_FILTERBUF(a1)
		clr.w	SAMPLE_FILTERTYPE(a1)

		move.b	#TRUE,SAMPLE_ENDREACHED(a1)
		lea.l	SAMPLE_SIZEOF(a1),a1
	dbf	d7,.loop
	bsr	ClearSaPoPtrs
	RET

	acode
ResetChannels	;V1.0
	BGN
	move.w	CHANNEL_NUMB,d7
	subq.w	#1,d7
	lea.l	Test_VOICEEXPANDER(PC),a2
	move.l	VOICEEXP_FIRSTSAMPLEPTR(a2),a1

.loop		move.w	#SAMPLEST_PENDING,SAMPLE_STATUS(a1)
		clr.l	SAMPLE_LASTSAMPLE(a1)
		clr.w	SAMPLE_VOLSLIDE(a1)
		clr.w	SAMPLE_PITCHSLIDE(a1)
		move.w	#VOLUME_MAX*$100,SAMPLE_VOLUME(a1)
		clr.b	SAMPLE_DECLICK(a1)
		clr.l	SAMPLE_FROMADD(a1)
		clr.w	SAMPLE_VIBDEPTH(a1)
		clr.w	SAMPLE_VIBLFOACTUAL(a1)
		clr.w	SAMPLE_TREMLFOACTUAL(a1)
		clr.w	SAMPLE_TREMDEPTH(a1)
		clr.w	SAMPLE_SAVIBDEPTH(a1)
		clr.w	SAMPLE_SAVIBLFOACTUAL(a1)
		clr.l	SAMPLE_DESTFREQUENZ(a1)
		clr.b	SAMPLE_VFADE(a1)
		clr.l	SAMPLE_INSTRUMENTPTR(a1)
		move.w	#100*256,SAMPLE_CVOL(a1)
		clr.w	SAMPLE_CVOLADD(a1)
		clr.w	SAMPLE_CVTYPE(a1)
		clr.w	SAMPLE_DESTVOL(a1)
		move.b	#TRUE,SAMPLE_ENDREACHED(a1)
		lea.l	SAMPLE_SIZEOF(a1),a1
	dbf	d7,.loop
	bsr	ClearSaPoPtrs
	RET

	acode
ClearSaPoPtrs
	puts	d0/a0
	move.l	FirstEntry_INSTR,a0
	move.l	#MaxNumb_Samples-1,d0
.loop		clr.l	INSTR_SAMPLEPOS(a0)
		lea.l	INSTR_SIZEOF(a0),a0
	dbf	d0,.loop
	gets	d0/a0
	rts

	acode
GetFreeChannel	;V1.2
	puts	d6-d7/a1-a2

	move.w	CHANNEL_NUMB,d7
	subq.w	#2,d7

	lea.l	Test_VOICEEXPANDER(PC),a2
	move.l	VOICEEXP_FIRSTSAMPLEPTR(a2),a1
	move.w	VOICEEXP_SAMPLESTRUCTSIZE(a5),d6
.loop		cmpi.w	#SAMPLEST_PENDING,SAMPLE_STATUS(a1)
		beq.s	.found
		lea.l	(a1,d6.w),a1
	dbf	d7,.loop
.quit	suba.l	a0,a0
.exit	gets	d6-d7/a1-a2
	rts
.found	move.l	a1,a0
	bra.s	.exit

	acode
SetNrmFreqBase
	move.l	#Normal_FREQDEF,Actual_FREQDEF
	bsr	BuildFreqList
	rts

	acode
SetFreq1	move.l	#Math_FREQDEF,Actual_FREQDEF
	bsr	BuildFreqList
	rts
	acode
SetFreq2	move.l	#Math_FREQDEF2,Actual_FREQDEF
	bsr	BuildFreqList
	rts

FREQDEF_PTR	EQU	0
FREQDEF_OCTAVE	EQU	4

FREQLIST_NUMBER		EQU	0
FREQLIST_OFFSET		EQU	2
FREQLIST_OCTAVES	EQU	4
FREQLIST_UNITPEROCTAVE	EQU	6
FREQLIST_LISTPTR	EQU	8
FREQLIST_BASE		EQU	12




	acode
GetNoteFreq:	;V2.1
		;I(A0L,D0W)(FREQLIST,NOTEVALUE[0..255])
		;O(D0L)(FREQUENZ)
	puts	a0
	andi.l	#$ffff,d0
	cmpi.w	#NOTEPITCHMAX,d0
	bls.s	.ok
	moveq	#NOTEPITCHMAX,d0
	IFNE TESTPRGB
	jsr	WarnFlash
	ENDC
.ok	move.l	Actual_FREQDEF(PC),a0
	add.w	FREQLIST_OFFSET(a0),d0
	bpl.s	.ok2
	IFNE TESTPRGB
	jsr	WarnFlash
	ENDC
.ok2	move.l	FREQLIST_LISTPTR(a0),a0
	move.l	(a0),a0
	move.l	(a0,d0.l*4),d0
	gets	a0
	rts


	acode
BuildFreqList	;V2.0
		;I()
	BGN
	move.l	Actual_FREQDEF(PC),a1
	move.w	FREQLIST_UNITPEROCTAVE(a1),Actual_FREQDEF+FREQDEF_OCTAVE
	move.l	FREQLIST_LISTPTR(a1),a2
	move.l	(a2),a2

	move.l	System_FreqBase,d0

	moveq	#-2,d3				;START AT FREQ/4

	move.w	FREQLIST_OCTAVES(a1),d6
	subq.w	#1,d6

BuildFreqList_L1
	move.l	FREQLIST_BASE(a1),a0
	move.w	FREQLIST_UNITPEROCTAVE(a1),d7
	subq.w	#1,d7


BuildFreqList_L2
	moveq	#0,d2
	move.w	(a0)+,d2
	mulu.l	d0,d1:d2
	divu.l	#3500,d1:d2

	tst.w	d3
	beq.s	BuildFreqList_O0
	bmi.s	BuildFreqList_ONEG
	lsl.l	d3,d2
	bra.s	BuildFreqList_O0

BuildFreqList_ONEG
	neg.w	d3
	lsr.l	d3,d2
	neg.w	d3

BuildFreqList_O0
	move.l	d2,(a2)+
	dbf		d7,BuildFreqList_L2

	addq.w	#1,d3			;OCTAVE UP
	dbf		d6,BuildFreqList_L1
	RET

	;_VOICEEXPANDER STRUCT
VOICEEXP_CHANNELNUMB		EQU	0
VOICEEXP_SAMPLESTRUCTSIZE 	EQU	2
VOICEEXP_NUMBCHANNELSACTIVE EQU	4
VOICEEXP_FIRSTSAMPLEPTR		EQU	6
VOICEEXP_AUDIONUMB			EQU	10	;HOW MANY AUDIOCHANNELS TO USE
VOICEEXP_VOICEPERAUDIO		EQU	12	;VOICES PER AUDIOCHANNEL
VOICEEXP_SAMPLEPTRBASE		EQU	14	;WORD CUSTOMOFFSET
VOICEEXP_BASEOFFSET			EQU	16	;WORD
VOICEEXP_BUFFERPERAUDIO		EQU	18	;WORD

VOICEEXP_SAMPLEPERFRAME		EQU	20	;WORD
VOICEEXP_BUFFERMEMSIZE		EQU	22	;WORD
VOICEEXP_PERIOD				EQU	24	;WORD

VOICEEXP_BUFFERBASE			EQU	26	;LONG
VOICEEXP_BUFFEROFFSET		EQU	30	;WORD
VOICEEXP_SUCCES				EQU	32	;WORD: TRUE/FALSE
VOICEEXP_VERSION			EQU	34	;LONG
;VOICEEXP_	EQU	
VOICEEXP_SIZEOF				EQU	38


BUFFER_NUMB					EQU	0
BUFFER_COUNT				EQU	2
BUFFER_SAMPLESPERFRAME		EQU	4	;SIZE OF 1 BUFFER
BUFFER_SAMPLEPERIOD			EQU	6	;SET IN CUSTOMREG
BUFFER_MEMSTRUCT			EQU	8
BUFFER_ACTUALBUFFERPTR		EQU	12	;PTR TO ACTUAL BUFFER
BUFFER_ISAVAILABLE			EQU	16
BUFFER_TOTALSAMPLELEN		EQU	18	;WORD: IN BYTES !!
BUFFER_VOLUME				EQU	20	;WORD
BUFFER_RESET				EQU	22	;PTR TO 1st BUFFER
BUFFER_DESTCUSTOMREG		EQU	26	;WORD CUSTOMOFFSET

BUFFER_SIZEOF				EQU	28




SAMPLE_PTR			EQU	0
SAMPLE_HIOFFSET		EQU	4
SAMPLE_FREQUENZ		EQU	8
SAMPLE_ENDPTR		EQU	12
SAMPLE_STATUS		EQU	16
SAMPLE_VOLUME		EQU	20	;NEW: WORD ONLY
SAMPLE_LOOPSTARTPTR	EQU	22	;LONG
SAMPLE_LOOPENDPTR	EQU	26	;LONG
SAMPLE_INSTRUMENTPTR	EQU	30	;LONG
SAMPLE_INSTRUMENTTYPE	EQU	34	;WORD
SAMPLE_SUSTSTARTPTR	EQU	36	;LONG
SAMPLE_SUSTENDPTR	EQU	40	;LONG
SAMPLE_LOOPNUMB		EQU	44	;WORD
SAMPLE_DECLICK	EQU	46	;FLAG
SAMPLE_FADEOUT		EQU	47	;FLAG
SAMPLE_LASTNOTE		EQU	48	;LONG	STORES FULL NOTE !!
SAMPLE_LASTSAMPLE	EQU	52	;8..max 64BIT
SAMPLE_VOLSLIDE		EQU	60	;SIGNWORD
SAMPLE_PITCHSLIDE	EQU	62	;SIGNWORD
SAMPLE_ENDREACHED	EQU	64	;BYTEFLAG
SAMPLE_STARTPTR		EQU	66
SAMPLE_FROMADD		EQU	72	;LONG
SAMPLE_VIBDEPTH		EQU	76	;WORD 0=NONE, 
SAMPLE_VIBLFOADD	EQU	78	;
SAMPLE_VIBLFOACTUAL	EQU	80	;

SAMPLE_TREMDEPTH	EQU	82	;WORD 0=NONE, 
SAMPLE_TREMLFOADD	EQU	84	;
SAMPLE_TREMLFOACTUAL	EQU	86	;

SAMPLE_SAVIBDEPTH	EQU	88	;WORD 0=NONE, 
SAMPLE_SAVIBLFOADD	EQU	90	;
SAMPLE_SAVIBLFOACTUAL	EQU	92	;
SAMPLE_SAVIBSTART	EQU	94	;LONG

SAMPLE_DESTFREQUENZ	EQU	98	;LONG 0=OFF
SAMPLE_PSLIDETOSPD	EQU	102	;WORD
SAMPLE_VFADE		EQU	104	;BYTE: 0=NOPE, -1=YES

SAMPLE_VFADESTART	EQU	106	;WORD
SAMPLE_VFADEEND		EQU	108	;WORD
SAMPLE_RETRIGNUMB	EQU	110	;0=OFF
SAMPLE_RETRIGCYCL	EQU	112	;WORD RETRIG INTERVALL 0
SAMPLE_RETRIGCOUNT	EQU	114	;WORD
SAMPLE_RETRIGPTR	EQU	116	;RETRIG PTR

SAMPLE_CVOL		EQU	128	;CHANNEL LOCAL MIX VOL
SAMPLE_CVOLADD		EQU	128+2	;CHANNEL CHANGE  PER CYCL
SAMPLE_DESTVOL		EQU	128+4	;DEST VOLUME
SAMPLE_CVTYPE		EQU	128+6	;0=NRM, 1=USE DESTVOL

SAMPLE_ENDVOL		EQU	128+8	;CHANNEL FINAL VOL SIGNBYTE (-128..+127)

SAMPLE_FILTERTYPE	EQU	144	;BYTE 0=OFF,1=LP,2=HP
SAMPLE_FILTERFREQ	EQU	140
SAMPLE_FILTERRESO	EQU	142
SAMPLE_FILTERBUF	EQU	146	;3xLONG

SAMPLE_SIZEOF	EQU	256

SAMPLEST_PENDING	EQU	0	;SAMPLE: UNBENUZT !!
SAMPLEST_INUSE		EQU	1


STREAM9BITNUMB	EQU	512
STREAM9BITLEN	EQU	4*STREAM9BITNUMB
BIT14_ENTRIES	EQU	32768*2


VolumeStep		EQU	1
VolumeTabNum		EQU	100/VolumeStep
VOLUMELIST_POINTERS	EQU	0
VOLUMELIST_FIRSTTAB	EQU	101*4
VOLUMELIST_TABLEN	EQU	256


AUD0_IR	EQU	7
AUDIOF0	EQU	7
AUDIOF1	EQU	8
AUDIOF2	EQU	9
AUDIOF3	EQU	10





	acode
GetVoiceExpander	;V1.02
			;O(D0W)(SUCCES [TRUE/FALSE])
	BGNB
	lea.l	ResoFilter_PTR,a0
	jsr	GetMem
	tst.w	d0
	beq	GetVoiceEx_ERRNOPOSTMEMb

	lea.l	DryDspBuffer_PTR,a0
	jsr	GetMem
	tst.w	d0
	beq	GetVoiceEx_ERRNOPOSTMEMb

	lea.l	RenderBuffer_PTR,a0
	jsr	GetMem
	tst.w	d0
	beq	GetVoiceEx_ERRNOPOSTMEMb

	lea.l	BufferMem0_PTR(PC),a0
	move.l	#CHIPMEM,d0
	move.l	d0,MEM_TYPE(a0)
	move.l	d0,12+MEM_TYPE(a0)
	move.l	d0,24+MEM_TYPE(a0)
	move.l	d0,36+MEM_TYPE(a0)

	lea.l	Test_VOICEEXPANDER(PC),a2

	move.w	#FALSE,VOICEEXP_SUCCES(a2)
	moveq	#0,d0
	move.w	VOICEEXP_CHANNELNUMB(a2),d0
	move.w	VOICEEXP_AUDIONUMB(a2),d1
	tst.w	d1
	beq.s	GetVoiceExpander_X
	divu	d1,d0
	move.w	d0,VOICEEXP_VOICEPERAUDIO(a2)

	move.w	VOICEEXP_BUFFERPERAUDIO(a2),d0
	move.w	VOICEEXP_SAMPLEPERFRAME(a2),d1
	mulu	d1,d0		;ONE AUDIO BUFFERMEMSIZE
	move.w	d0,VOICEEXP_BUFFERMEMSIZE(a2)

	move.w	VOICEEXP_AUDIONUMB(a2),d7

	subq.w	#1,d7
	bmi.s	GetVoiceExpander_X		;ERROR

	moveq	#0,d6
	move.l	VOICEEXP_BUFFERBASE(a2),a3
	move.w	VOICEEXP_BUFFEROFFSET(a2),d5

.loop		move.w	d6,d0
		move.l	a2,a0
		move.l	a3,a1
		bsr.w	InitBuffer
		cmpi.w	#TRUE,d0
		bne.s	GetVoiceExpander_X	;ERROR
		addq.w	#1,d6
		lea.l	(a3,d5.w),a3
	dbf	d7,.loop

	lea.l	CopyBuffer_PTR(PC),a0
	jsr	GetMem
	tst.w	d0
	beq.s	GetVoiceExpander_ERR
	jsr	InitCalcBufferInfo

	lea.l	PostDspBuffer_PTR(PC),a0
	jsr	GetMem
	tst.w	d0
	beq.s	GetVoiceEx_ERRNOPOSTMEM
	jsr	InitPostDspBufferInfo

	move.w	#TRUE,VOICEEXP_SUCCES(a2)
GetVoiceExpander_X	
		moveq	#0,d0
		move.w VOICEEXP_SUCCES(a2),d0
		jsr	HLPFilterOff			;DIGITAL FILTER OFF
	RETB

GetVoiceEx_ERRNOPOSTMEMb
	bsr	FreeRenderBuf
	bsr	FreeDryDspBuf
	bsr	FreeResoFilter
GetVoiceEx_ERRNOPOSTMEM
	lea.l	CopyBuffer_PTR(PC),a0
	move.l	#$00010016,MEM_DEBUG_INFO
	move.l	#$00000000,MEM_DEBUG_INFO+4
	jsr	FreeMem
	clr.l	(a0)

GetVoiceExpander_ERR
	move.w	#FALSE,VOICEEXP_SUCCES(a2)
	jsr	WarnFlash
	bra.s	GetVoiceExpander_X

	acode
FreeResoFilter
	BGN
	lea.l	ResoFilter_PTR,a0
	move.l	#$00010016,MEM_DEBUG_INFO
	move.l	#$00000005,MEM_DEBUG_INFO+4
	jsr	FreeMem
	clr.l	(a0)
	RET

	acode
FreeDryDspBuf
	BGN
	lea.l	DryDspBuffer_PTR,a0
	move.l	#$00010016,MEM_DEBUG_INFO
	move.l	#$00000003,MEM_DEBUG_INFO+4
	jsr	FreeMem
	clr.l	(a0)
	RET


FreeRenderBuf
	BGN
	lea.l	RenderBuffer_PTR,a0
	move.l	#$00010016,MEM_DEBUG_INFO
	move.l	#$00000004,MEM_DEBUG_INFO+4
	jsr	FreeMem
	clr.l	(a0)
	RET


	acode
FreeVoiceExpander	;V1.1
	BGN
	jsr	HLPFilterOn
	lea.l	Test_VOICEEXPANDER(PC),a2
	move.l	VOICEEXP_BUFFERBASE(a2),a3
	move.l	VOICEEXP_BUFFERBASE(a2),a0
	move.w	VOICEEXP_BUFFEROFFSET(a2),d0
	move.w	VOICEEXP_AUDIONUMB(a2),d7
	subq.w	#1,d7
.loop		bsr.w	FreeBuffer
		lea.l	(a0,d0.w),a0
	dbf	d7,.loop

	lea.l	CopyBuffer_PTR(PC),a0
	move.l	#$00010016,MEM_DEBUG_INFO
	move.l	#$00000001,MEM_DEBUG_INFO+4
	jsr	FreeMem
	clr.l	(a0)
	lea.l	PostDspBuffer_PTR(PC),a0
	move.l	#$00010016,MEM_DEBUG_INFO
	move.l	#$00000002,MEM_DEBUG_INFO+4
	jsr	FreeMem
	clr.l	(a0)
	bsr	FreeRenderBuf
	bsr	FreeDryDspBuf
	bsr	FreeResoFilter
.exit	RET



ToogleLPFilter
	IFNE DIRECTAMIGAAUDIO
	bchg	#1,$bfe001
	ENDC
	rts

	acode
HLPFilterOff
	IFNE DIRECTAMIGAAUDIO
	bset	#1,$bfe001				;DIGITAL FILTER OFF
	ENDC
	rts

HLPFilterOn
	IFNE DIRECTAMIGAAUDIO
	bclr	#1,$bfe001				;DIGITAL FILTER OFF
	ENDC
	rts

	
	acode
CheckForcedUpdate
	cmpi.w	#TRUE,PLAYER_STATUS
	beq.s	.exit
	tst.b	ForceUpdate
	beq.s	.exit
	jsr	SignalAutoUpdate
.exit	rts

	acode
InitBuffer	;V2.0
		;I(D0W,A0L,A1L)(AudioNum[0..3],VOICEEXP_STRUCT,Buffer_STRUCT)
		;O(D0W)(SUCCES:TRUE/FALSE)

	BGNB
	move.l	a1,a4
	move.l	a0,a5
	move.w	VOICEEXP_BUFFERPERAUDIO(a5),BUFFER_NUMB(a4)
	move.w	BUFFER_NUMB(a4),BUFFER_COUNT(a4)	;RESET BUFFER COUNT
	move.w	VOICEEXP_SAMPLEPERFRAME(a5),BUFFER_SAMPLESPERFRAME(a4)
	move.w	VOICEEXP_PERIOD(a5),BUFFER_SAMPLEPERIOD(a4)
	move.w	VOICEEXP_BUFFERMEMSIZE(a5),BUFFER_TOTALSAMPLELEN(a4)
	move.w	VOICEEXP_BASEOFFSET(a5),d1
	mulu	d0,d1
	add.w	VOICEEXP_SAMPLEPTRBASE(a5),d1
	move.w	d1,BUFFER_DESTCUSTOMREG(a4)
	move.w	VOICEEXP_BUFFERMEMSIZE(a5),d0
	move.l	BUFFER_MEMSTRUCT(a4),a3
		andi.l	#$1ffff,d0
		move.l	d0,4(a3)
		move.l	a3,a0
		jsr	GetMem
		tst.l	d0
		bne.s	.SUCCESS
			jsr	WarnFlash
			ERRORTXT ERRNoBufferMem_TXT
			moveq	#FALSE,d0			
			clr.l	(a3)
			move.w	#FALSE,BUFFER_ISAVAILABLE(a4)
		bra.s	.END
.SUCCESS
		move.l	(a3),BUFFERPTR
		move.l	(a3),BUFFER_ACTUALBUFFERPTR(a4)
		move.l	(a3),BUFFER_RESET(a4)
		move.w	#TRUE,BUFFER_ISAVAILABLE(a4)
		moveq	#TRUE,d0
.END	RETB



	acode
FreeBuffer
	;V1.0 FREES BUFFER MEM, ALLOCATED OR NOT ...
	;(A0L)(BUFFER_STRUCT)
	;DEBUG: causing a hunkoverflow error
	BGN
	move.l	BUFFER_MEMSTRUCT(a0),a0
	tst.l	(a0)
	beq.s	.exit
	move.l	#$00010016,MEM_DEBUG_INFO
	move.l	#$00000003,MEM_DEBUG_INFO+4
	jsr		FreeMem
.exit	RET


	IFNE DIRECTAMIGAAUDIO
	acode
GetAudioDevice
	BGN
	move.b	#FALSE,AUDIODEV_TAKEN
	move.b	#-1,sigbitnum

	moveq	#0,d2
	movea.l	EXECBASE,a6
;	+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+ alloc signal bit
	addq.l	#1,d2
	moveq	#-1,d0
	jsr	-$14a(a6)	;AllocSignal()
	tst.b	d0
	bmi.w	GetAudDevERR_NOSIGNAL
	move.b	d0,sigbitnum
;	+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+ prepare IORequest
	lea		allocport(pc),a1
	move.b	d0,15(a1)	;set mp_SigBit
	move.l	a1,-(sp)
	suba.l	a1,a1
	jsr		-$126(a6)	;FindTask(0)
	move.l	(sp)+,a1
	move.l	d0,16(a1)	;set mp_SigTask
	lea		reqlist(pc),a0
	move.l	a0,(a0)		;NEWLIST begins...
	addq.l	#4,(a0)
	clr.l	4(a0)
	move.l	a0,8(a0)	;NEWLIST ends...
;	+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+ open audio.device
	addq.l	#1,d2

	lea	allocreq(pc),a1
	lea	audiodevname(pc),a0
	moveq	#0,d0
	moveq	#0,d1
	jsr	-$1bc(a6)	;OpenDevice()
	tst.b	d0
	bne.w	GetAudDevERR_NODEV

	move.b	#TRUE,AUDIODEV_TAKEN

GetAudDev_X	RET

GetAudDevERR_NODEV
GetAudDevERR_NOSIGNAL
	jsr	WarnFlash
	ERRORTXT ENoAudioDev
	bra.s	GetAudDev_X

FreeAudioDevice
	BGN
	cmpi.b	#TRUE,AUDIODEV_TAKEN
	bne.s	FreeADev_NoDev
	move.l	EXECBASE,a6
	lea	allocreq(pc),a1
	jsr	-$1c2(a6)	;CloseDevice()

FreeADev_NoDev
	move.b	#FALSE,AUDIODEV_TAKEN

	moveq	#0,d0
	move.b	sigbitnum(pc),d0
	bmi.s	FreeADev_NoSig

	jsr	-$150(a6)	;FreeSignal()

	move.b	#-1,sigbitnum
FreeADev_NoSig	RET

	acode
SetAudioIRQ
	BGN
	move.w	#$0780,$dff09a
	move.w	#$0780,$dff09c
	move.l	4.w,a6
	moveq	#AUD0_IR,d0
	lea	audiointerrupt(pc),a1
	jsr	-162(a6)	;AddIntServer
	move.l	d0,OldIntVector
	move.w	#$8080,$dff09a
	RET

	acode
RemoveAudioIRQ
	BGN
	move.l	4.w,a6
	moveq	#AUD0_IR,d0
	move.l	OldIntVector,a1
	jsr	-162(a6)	;AddIntServer
	move.w	#$0780,$dff09a
	move.w	#$0780,$dff09c
	RET
	ENDC	;of DIRECTAMIGAAUDIO


	;--- AUDIO HARD IRQ ---
	acode
SymphonieAudioInterrrupt
	jsr	CauseSoftIRQ
	move.w	#TRUE,AudioIRQ_STATUS
	IFNE DIRECTAMIGAAUDIO
	move.w	#$0780,$dff09c		;CLEAR ALL AUDIO IRQS
	ENDC
	moveq	#-1,d0
	rts


	;--- SOFT IRQ ---
	acode
CauseSoftIRQ	;V1.1
	puts	d0-a6
	bsr		LMButton		;SV3.1b
	tst.w	d0
	bne.s	CauseStop
	tst.b	LowCPUWarn
	bne.s	CauseStop2
	bsr		DoSoftIRQ
.exit
	gets	d0-a6
	rts
	
	acode
DoSoftIRQ
	move.l	SoftInt(PC),a1
	move.b	#2,8(a1)
	CALLEXEC	Cause
	move.l	SoftInt(PC),d0
	move.l	SoftInt+4,SoftInt
	move.l	d0,SoftInt+4
	rts


	acode
CauseStop	
	move.w	#FALSE,PLAYER_STATUS
	jsr	StopAllChannels
	move.l	#StopSong3,CheckQJMsg_JMP
	;bsr	DoSoftIRQ
	;addq.b	#1,LowCPUWarn
	;bsr	SwapSyncBuffer
	gets	d0-a6
	clr.b	LowCPUWarn
	rts

CauseStop2
	move.w	#FALSE,PLAYER_STATUS
	jsr	StopAllChannels
	move.l	#StopSong4,CheckQJMsg_JMP
	gets	d0-a6
	clr.b	LowCPUWarn
	rts

	;--- SOFT IRQ ---
	acode
SymphonieSoftIRQ
	cmpi.w	#TRUE,IRQStuff_STATUS	;NEW BETA
	bne.s	.exit
	jsr	NewChangeSyncBuf
.exit	moveq	#0,d0
	rts


	acode
ChangeBuffers		;V3.0
	puts	d0/d4/d7/a0/a4/a5
	lea.l	Test_VOICEEXPANDER(PC),a5
	move.l	VOICEEXP_BUFFERBASE(a5),a4
	move.w	VOICEEXP_BUFFEROFFSET(a5),d4
	move.w	VOICEEXP_AUDIONUMB(a5),d7
	subq.w	#1,d7

	subq.w	#1,BUFFER_COUNT(a4)
	beq.s	.SetFirst
	moveq	#0,d0
.loop		move.l	BUFFER_ACTUALBUFFERPTR(a4),a0
		move.w	BUFFER_SAMPLESPERFRAME(a4),d0

		IFNE OS3
		divu.l	OverSample3,d0
		ENDC
		;--- NEXT BUFFER ---
		lea.l	(a0,d0.w),a0
		move.l	a0,BUFFER_ACTUALBUFFERPTR(a4)

		lea.l	(a4,d4.w),a4
	dbf	d7,.loop
.exit	gets	d0/d4/d7/a0/a4/a5
	rts
.SetFirst	
	move.w	BUFFER_NUMB(a4),BUFFER_COUNT(a4)
	move.l	BUFFER_RESET(a4),BUFFER_ACTUALBUFFERPTR(a4)
	lea.l   (a4,d4.w),a4
	dbf	d7,.SetFirst
	bra.s	.exit

	;--- SYNC SYSTEM / BUFFER SWAPPING ---
	acode
NewChangeSyncBuf			;NEWBUFSYNC
	puts	d0/d7/a0
	addq.b	#1,LowCPUWarn
	move.l	VexSyncBufNumb(PC),d7	
	add.l	d7,StreamCount		;###

	IFNE RENDER
	tst.b	SOUNDRENDER
	bne.s	.exit
	ENDC

	subq.w	#1,d7
	bmi.s	.exit
.loop	bsr	LMButton
	tst.b	d0
	bne.s	.Abort
	lea.l	Test_SONG(PC),a0
	jsr	PlaySong
	bsr	ChangeBuffers
	bsr	CopyVoiceBuffer
	bsr	CheckForcedUpdate		;###
	dbf	d7,.loop

.exit	move.l	BufferSet(PC),a0
	jsr	(a0)
	bsr	SwapSyncBuffer
	gets	d0/d7/a0
	subq.b	#1,LowCPUWarn
	rts

.Abort	lea.l	Test_SONG(PC),a0
	bsr	ChangeBuffers
	bsr	CopyVoiceBuffer
	dbf	d7,.Abort
	move.w	#FALSE,PLAYER_STATUS
	bsr	StopAllChannels
	move.l	#StopSong,CheckQJMsg_JMP
	bra.s	.exit

.Low	lea.l	Test_SONG(PC),a0
	bsr	ChangeBuffers
	bsr	CopyVoiceBuffer
	dbf	d7,.Low
	bra.s	.exit


	;--- MOUSE CHECK ---
	acode
LMButton	;O(D0)(TRUE/FALSE)
	IFNE DIRECTAMIGAAUDIO
	move.w	$dff016,d0
	btst	#10,d0
	beq.s	.SET
	moveq	#0,d0
	rts
.SET	btst	#6,$bfe001
	beq.s	.SET1
	moveq	#0,d0
	rts
.SET1	moveq	#-1,d0
	ENDC
	rts


	;--- DSP STUFF ---
	acode
ClearDryRoom
	tst.w	Dry_COUNT
	bne.s	.go
	rts
.go	move.w	DrySamples(PC),d0
	moveq	#0,d1	
	move.l	DryDspBuffer_PTR(PC),a0
.loop	move.l	d1,(a0)+
	dbf	d0,.loop
	clr.w	Dry_COUNT
	rts

;	acode
;ClearResoFilterRoom
;	puts	d0/d1/a0
;	subq.w	#1,d0
;	move.w	d0,ResoFilter_LEN
;	moveq	#0,d1	
;	move.l	ResoFilter_PTR(PC),a0
;.loop	move.l	d1,(a0)+
;	dbf	d0,.loop
;	gets	d0/d1/a0
;	rts

ResoFilterPreMix	;I(A0L,A1L,)(SAMPLE_PTR,BUFFER)
	tst.b	SAMPLE_FILTERTYPE(a0)
	bne.s	.do
	rts
.do	move.l	a1,ResoFilter_OLDPTR
	puts	d2
	moveq	#0,d2
	move.w	SAMPLE_FILTERFREQ(a0),d2
	move.l	d2,RTResoFilter_FREQ
	move.w	SAMPLE_FILTERRESO(a0),d2
	move.l	d2,RTResoFilter_RESO
	gets	d2
	move.w	d0,ResoFilter_LEN
	move.l	ResoFilter_PTR,a1
	rts

ResoFilterPostMix
	cmpi.b	#1,SAMPLE_FILTERTYPE(a0)
	beq.w	ResoFilterPostMixLP
	cmpi.b	#2,SAMPLE_FILTERTYPE(a0)
	beq.w	ResoFilterPostMixHP
	cmpi.b	#3,SAMPLE_FILTERTYPE(a0)
	beq.w	ResoFilterPostMixBP
	rts

ResoFilterPostMixHP
	move.l	ResoFilter_OLDPTR,a1
	puts	d0-d7/a1-a2
	move.l	ResoFilter_PTR,a2
	move.w	ResoFilter_LEN,d0
	subq.w	#1,d0
	movem.l	SAMPLE_FILTERBUF(a0),d2-d4
	move.l	RTResoFilter_FREQ(PC),d7
	cmpi.l	#CFILTER_MAXFREQ,d7
	bls.s	.freqOK
	move.l	#CFILTER_MAXFREQ,d7
.freqOK	tst.l	RTResoFilter_RESO(PC)
	beq.s	.donoreso
	cmpi.l	#CFILTER_MAXRESO,RTResoFilter_RESO
	bls.s	.loop
	move.l	#CFILTER_MAXRESO,RTResoFilter_RESO
.loop	move.w	(a2),d1
	;--- FILTER MIT RESO ---
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	d7,d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	d7,d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	move.l	RTResoFilter_RESO(PC),d6
	muls.l	d2,d6
	asr.l	#6,d6
	add.l	d6,d2
	asr.l	#2,d2
	move.l	d2,d1
	;-----------------------
	move.w	d4,(a1)
	clr.w	(a2)
	lea.l	4(a2),a2
	lea.l	4(a1),a1
	dbf	d0,.loop
.exit	movem.l	d2-d4,SAMPLE_FILTERBUF(a0)
	gets	d0-d7/a1-a2
	rts
.donoreso
.loopnr	move.w	(a2),d1
	;--- HP FILTER OHNE RESO ---
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	d7,d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	d7,d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	asr.l	#2,d2
	move.l	d2,d1
	move.w	d4,(a1)
	clr.w	(a2)
	lea.l	4(a2),a2
	lea.l	4(a1),a1
	dbf	d0,.loopnr
	bra.s	.exit

ResoFilterPostMixBP
	move.l	ResoFilter_OLDPTR,a1
	puts	d0-d7/a1-a2
	move.l	ResoFilter_PTR,a2
	move.w	ResoFilter_LEN,d0
	subq.w	#1,d0
	movem.l	SAMPLE_FILTERBUF(a0),d2-d4
	move.l	RTResoFilter_FREQ(PC),d7
	cmpi.l	#CFILTER_MAXFREQ,d7
	bls.s	.freqOK
	move.l	#CFILTER_MAXFREQ,d7
.freqOK	tst.l	RTResoFilter_RESO(PC)
	beq.s	.donoreso
	cmpi.l	#CFILTER_MAXRESO,RTResoFilter_RESO
	bls.s	.loop
	move.l	#CFILTER_MAXRESO,RTResoFilter_RESO
.loop	move.w	(a2),d1
	;--- FILTER MIT RESO ---
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	d7,d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	d7,d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	move.l	RTResoFilter_RESO(PC),d6
	muls.l	d2,d6
	asr.l	#6,d6
	add.l	d6,d2
	asr.l	#2,d2
	move.l	d2,d1
	;-----------------------
	sub.w	d4,(a2)
	sub.w	d1,(a2)
	move.w	(a2),(a1)
	clr.w	(a2)
	lea.l	4(a2),a2
	lea.l	4(a1),a1
	dbf	d0,.loop
.exit	movem.l	d2-d4,SAMPLE_FILTERBUF(a0)
	gets	d0-d7/a1-a2
	rts
.donoreso
.loopnr	move.w	(a2),d1
	;--- BP FILTER OHNE RESO ---
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	d7,d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	d7,d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	asr.l	#2,d2
	move.l	d2,d1
	sub.w	d4,(a2)
	sub.w	d1,(a2)
	move.w	(a2),(a1)
	clr.w	(a2)
	lea.l	4(a2),a2
	lea.l	4(a1),a1
	dbf	d0,.loopnr
	bra.s	.exit
.temp	dc.w	0

	;LP Filter
ResoFilterPostMixLP
	move.l	ResoFilter_OLDPTR,a1
	puts	d0-d7/a1-a2
	;move.l	ResoFilter_OLDPTR,a1
	move.l	ResoFilter_PTR,a2
	move.w	ResoFilter_LEN,d0
	subq.w	#1,d0
	movem.l	SAMPLE_FILTERBUF(a0),d2-d4
	move.l	RTResoFilter_FREQ(PC),d7
	cmpi.l	#CFILTER_MAXFREQ,d7
	bls.s	.freqOK
	move.l	#CFILTER_MAXFREQ,d7
.freqOK	tst.l	RTResoFilter_RESO(PC)
	beq.s	.donoreso
	cmpi.l	#CFILTER_MAXRESO,RTResoFilter_RESO
	bls.s	.loop
	move.l	#CFILTER_MAXRESO,RTResoFilter_RESO
.loop	move.w	(a2),d1
	;--- FILTER MIT RESO ---
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	d7,d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	d7,d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	move.l	RTResoFilter_RESO(PC),d6
	muls.l	d2,d6
	asr.l	#6,d6
	add.l	d6,d2
	asr.l	#2,d2
	move.l	d2,d1
	;-----------------------
	add.w	d1,(a1)
	clr.w	(a2)
	lea.l	4(a2),a2
	lea.l	4(a1),a1
	dbf	d0,.loop
.exit	movem.l	d2-d4,SAMPLE_FILTERBUF(a0)
	gets	d0-d7/a1-a2
	rts
.donoreso
.loopnr	move.w	(a2),d1
	;--- FILTER OHNE RESO ---
	ext.l	d1
	move.l	d1,d4
	sub.l	d2,d4
	move.l	d7,d6
	muls.l	d4,d6
	asr.l	#8,d6
	add.l	d6,d3
	move.l	d7,d6
	muls.l	d3,d6
	asr.l	#6,d6
	add.l	d6,d2
	asr.l	#2,d2
	move.l	d2,d1
	move.w	d1,(a1)
	clr.w	(a2)
	lea.l	4(a2),a2
	lea.l	4(a1),a1
	dbf	d0,.loopnr
	bra.s	.exit







RTResoFilter_FREQ	dc.l	0
RTResoFilter_RESO	dc.l	0
ResoFilter_LEN		dc.w	0
ResoFilter_COUNT	dc.w	0
ResoFilter_OLDPTR	dc.l	0

	acode
PostMixDryWet	;V1.0
		;O(A1L)(BUFFER_PTR)
		
	tst.w	Dry_COUNT
	bne.s	.go
	rts
.go	puts	d0-d2/a2
	move.l	DryDspBuffer_PTR(PC),a2
	subq.w	#1,d0
	move.w	d0,DrySamples
.loop	move.l	(a1)+,d1
		move.l	(a2),d2
		add.w	d1,d2
		swap	d1
		swap	d2
		add.w	d1,d2
		swap	d2
		move.l	d2,(a2)+
	dbf	d0,.loop
	move.l	DryDspBuffer_PTR(PC),a1
	gets	d0-d2/a2
	rts

	acode
CopyVoiceBuffer		;V3.0	SINGULAR STREAM
	BGN
	bsr	ClearDryRoom

	lea.l	Test_VOICEEXPANDER(PC),a0
	move.l	VOICEEXP_BUFFERBASE(a0),a1
	move.w	VOICEEXP_BUFFEROFFSET(a0),d0
	move.w	VOICEEXP_CHANNELNUMB(a0),d7
	move.l	VOICEEXP_FIRSTSAMPLEPTR(a0),a0
	lea.l	(a1,d0.w),a2
	lea.l	(a2,d0.w),a3
	lea.l	(a3,d0.w),a4

	lsr.w	#1,d7
	subq.w	#1,d7

	move.w	BUFFER_SAMPLESPERFRAME(a1),d0
	tst.w	OverSamp_FLAG
	beq.s	.noOverSample
		move.w	d0,d3
		lsr.w	#1,d0
.noOverSample

	move.l	BUFFER_ACTUALBUFFERPTR(a1),a5
	move.l	BUFFER_ACTUALBUFFERPTR(a2),a2

	tst.w	VEXDSP_FLAG
	bne.w	CopyVoiceBuffer_DSP

	move.l	CopyBuffer_PTR(PC),a1
	bsr	ClearSample

CopyVoiceBuffer_DSPIN

	clr.l	SAMPLE_IPTR


	move.l	a1,a6

	move.w	#0,DryDspBuffer_OFF

	move.w	#SAMPLE_SIZEOF,d1
	moveq	#2-1,d5
	move.w	d7,d6


	clr.w	SEPERATECHANNELS
	cmpi.l	#CopyBackStream14Bit_Left,COPYBACK_JR
	beq	CopyVoicePreL
	cmpi.l	#CopyBackStream14Bit_Right,COPYBACK_JR
	beq	CopyVoicePreR

	
CopyVoiceBuffer_go
	puts	a2-a4
.loop	tst.w	SEPERATECHANNELS
	bmi.s	.skipleft	
	bsr	ResoFilterPreMix
	bsr	CopySample			;Left Channel
	bsr	ResoFilterPostMix
.skipleft	
	move.l	SAMPLE_INSTRUMENTPTR(a0),a2	;Enforcer: kann 0 sein !!
	lea.l	(a0,d1.w),a0
	move.w	#2,DryDspBuffer_OFF

	cmp.l	#0,a2				;Enforcer Hit fixed
	beq	.doright
	btst	#SPLAYFLAG_SUPERFAST,INSTR_PLAYFLAG(a2)	;0 Instrument -> Error
	bne.s	.skipright
	cmpi.w	#1,SEPERATECHANNELS
	beq.s	.skipright

.doright
	lea.l	2(a1),a1
	clr.b	FASTPOSSIBLE
	bsr	ResoFilterPreMix
	bsr	CopySample			;Right Channel
	bsr	ResoFilterPostMix
	move.b	#-1,FASTPOSSIBLE
	lea.l	-2(a1),a1
.skipright
	lea.l	(a0,d1.w),a0

	move.w	#0,DryDspBuffer_OFF
	dbf	d7,.loop
Enf_ERRb
	gets	a2-a4	

	move.l	a6,a1
	move.l	POSTDSP(PC),d7
	bne.s	CopyVoice_PostGo
CopyVoiceB_NoPOSTDsp

	move.l	BUFFER_ACTUALBUFFERPTR(a3),a3
	move.l	BUFFER_ACTUALBUFFERPTR(a4),a4
	move.w	d0,SCOPE_LEN

	bsr	PostMixDryWet
	move.l	a1,SCOPE_16BITPOS
	bsr	ProcMVol

	move.l	COPYBACK_JR(PC),a0
	jsr	(a0)

CopyVoiceBuffer_X	RET
	rts
CopyVoice_PostGo
	move.l	d7,a6
	jsr	(a6)
	bra.s	CopyVoiceB_NoPOSTDsp

CopyVoicePreR
	move.w	#1,SEPERATECHANNELS
	bra	CopyVoiceBuffer_go
CopyVoicePreL
	move.w	#-1,SEPERATECHANNELS
	bra	CopyVoiceBuffer_go
Enf_ERR	;jsr	BugFlashQ
	bra.s	Enf_ERRb


	;--- COPY BACK ROUTINES ---

	acode
;CopyBackStream8Bit_Stereo
	subq.w	#1,d0
	bsr	GetCopyBackShift
.loop
	move.l	(a1)+,d5
	asr.w	d7,d5
	move.b	d5,(a2)+
	move.b	d5,(a3)+
	swap	d5
	asr.w	d7,d5
	move.b	d5,(a5)+
	move.b	d5,(a4)+
	dbf	d0,.loop
	rts

	IFNE OS3
	acode
DoOversample3	;I(A1L,D0L)(PTR,SAMPLES)
	cmpi.l	#1,OverSample3
	bne.s	.do
	rts
.do	cmpi.l	#4,OverSample3
	beq	.do4fach
	cmpi.l	#8,OverSample3
	beq	.do8fach
	puts	d0-d5/a0
	subq.l	#1,d0
	move.l	a1,a0
	move.l	OverSample3_PTR,a1
.loop	move.l	(a0)+,d4
	move.l	(a0)+,d5
	move.l	d4,d2
	move.l	d5,d3
	ext.l	d4
	ext.l	d5
	swap	d2
	swap	d3
	ext.l	d2
	ext.l	d3
	add.l	d4,d5
	asr.l	#1,d5
	add.l	d2,d3
	asr.l	#1,d3
	swap	d5
	move.w	d3,d5
	swap	d5
	move.l	d5,(a1)+
	dbf	d0,.loop
	gets	d0-d5/a0
	move.l	OverSample3_PTR,a1
	lsr.l	#1,d0
	rts

.do4fach	;O(A1L)
	puts	d0-d6/a0
	subq.l	#1,d0
	move.l	a1,a0
	move.l	OverSample3_PTR,a1
.loop4	move.w	(a0)+,d4
	ext.l	d4
	move.w	(a0)+,d2
	ext.l	d2
	moveq	#4-2,d6
.loop4b	move.w	(a0)+,d5
	ext.l	d5
	add.l	d5,d4
	move.w	(a0)+,d3
	ext.l	d3
	add.l	d3,d2
	dbf	d6,.loop4b
	lsr.l	#2,d2
	lsr.l	#2,d4
	swap	d4
	move.w	d2,d4
	move.l	d4,(a1)+
	dbf	d0,.loop4
	gets	d0-d6/a0
	move.l	OverSample3_PTR,a1
	lsr.l	#2,d0
	rts

.do8fach	;O(A1L)
	puts	d0-d6/a0
	subq.l	#1,d0
	move.l	a1,a0
	move.l	OverSample3_PTR,a1
.loop8	move.w	(a0)+,d4
	ext.l	d4
	move.w	(a0)+,d2
	ext.l	d2
	moveq	#7-1,d6
.loop8b	move.w	(a0)+,d5
	ext.l	d5
	add.l	d5,d4
	move.w	(a0)+,d3
	ext.l	d3
	add.l	d3,d2
	dbf	d6,.loop8b
	lsr.l	#3,d2
	lsr.l	#3,d4
	swap	d4
	move.w	d2,d4
	move.l	d4,(a1)+
	dbf	d0,.loop8
	gets	d0-d6/a0
	move.l	OverSample3_PTR,a1
	lsr.l	#2,d0
	rts
	ENDC

	IFNE	CALIBRATED14
	acode
CopyBackStream14Bit_Stereo	;calibrated
	puts	d6/a6
	move.l	a1,BUFFERPTR+4
	;--- DO OVERSAMPLE 3 ---
	IFNE OS3
	bsr	DoOversample3
	ENDC
	subq.w	#1,d0
	move.l	Bit14Tab_PTR,a6
	move.l	#BIT14_ENTRIES,d6
	lea.l	(a6,d6.l),a6
	;--- A5=AUDIO0  A2=AUDIO1  A3=AUDIO2 A4=AUDIO3 ---
	
	moveq	#0,d5
				;VOL[0..64] [BYTE]
.loop
	move.w	2(a1),d5
	move.w	(a6,d5.l*2),d6

	move.b	d6,(a3)+	;VOL

	lsr.w	#8,d6
	move.b	d6,(a2)+	;FINE VOL	calibrated

	move.w	(a1),d5
	move.w	(a6,d5.l*2),d6

	move.b	d6,(a4)+	;VOL
	lsr.w	#8,d6
	move.b	d6,(a5)+	;VOL

	lea.l	4(a1),a1

	dbf	d0,.loop
	gets	d6/a6
	rts

	ELSE

	acode
CopyBackStream14Bit_Stereo	;not calibrated
	puts	d6/a6
	move.l	a1,BUFFERPTR+4
	;--- DO OVERSAMPLE 3 ---
	IFNE OS3
	bsr	DoOversample3
	ENDC
	subq.w	#1,d0
	move.l	Bit14Tab_PTR,a6
	move.l	#BIT14_ENTRIES,d6
	lea.l	(a6,d6.l),a6
	;--- A5=AUDIO0  A2=AUDIO1  A3=AUDIO2 A4=AUDIO3 ---
					;VOL[0..64] [BYTE]
.loop
	move.l	(a1)+,d5
	move.w	(a6,d5.w*2),d6
	move.b	d6,(a2)+	;VOL
	lsr.w	#8,d6
	move.b	d6,(a3)+	;FINE VOL
	swap	d5
	move.w	(a6,d5.w*2),d6
	move.b	d6,(a5)+	;VOL
	lsr.w	#8,d6
	move.b	d6,(a4)+	;VOL
	dbf	d0,.loop
	gets	d6/a6
	rts
	ENDC

CopyBackStream14Bit_Mono
	puts	d6/a6
	;--- DO OVERSAMPLE 3 ---
	IFNE OS3
	bsr	DoOversample3
	ENDC
	subq.w	#1,d0
	move.l	Bit14Tab_PTR,a6
	move.l	#BIT14_ENTRIES,d6
	lea.l	(a6,d6.l),a6
	;A5=AUDIO0  A2=AUDIO1  A3=AUDIO2 A4=AUDIO3
					;VOL[0..64] [BYTE]
.loop	move.l	(a1)+,d5
	move.l	d5,d4
	swap	d4
	ext.l	d5
	ext.l	d4
	add.l	d4,d5
	addq.l	#1,d5
	asr.l	#1,d5		;D5 1 SAMPLE WORD ONLY
	move.w	(a6,d5.w*2),d6
	move.b	d6,d5
	move.b	d6,(a2)+	;VOL
	lsr.w	#8,d6
	move.b	d6,(a3)+	;FINE VOL
	move.b	d5,(a5)+	;VOL
	move.b	d6,(a4)+
	dbf	d0,.loop
	gets	d6/a6
	rts

CopyBackStream14Bit_Surround
	puts	d4/d6/a6
	subq.w	#1,d0
	move.l	Bit14Tab_PTR,a6
	move.l	#BIT14_ENTRIES,d6
	lea.l	(a6,d6.l),a6
	;A5=AUDIO0  A2=AUDIO1  A3=AUDIO2 A4=AUDIO3
				;VOL[0..64] [BYTE]
.loop	move.l	(a1)+,d5
	move.l	d5,d4
	swap	d4
	ext.l	d5
	ext.l	d4
	add.l	d4,d5
	addq.l	#1,d5
	asr.l	#1,d5		;D5 1 SAMPLE WORD ONLY
	move.w	(a6,d5.w*2),d6
	move.l	d6,d4
	move.b	d6,(a2)+	;VOL
	lsr.w	#8,d6
	move.b	d6,(a3)+	;FINE VOL
	neg.b	d4
	move.b	d4,(a5)+
	lsr.w	#8,d4
	neg.b	d4
	move.b	d4,(a4)+
	dbf	d0,.loop
	gets	d4/d6/a6
	rts


CopyBackStream14Bit_Left	;V1.1
	puts	d6/a6
	;--- DO OVERSAMPLE 3 ---
	IFNE OS3
	bsr	DoOversample3
	ENDC
	subq.w	#1,d0
	move.l	Bit14Tab_PTR,a6
	move.l	#BIT14_ENTRIES,d6
	lea.l	(a6,d6.l),a6
.loop	;A5=AUDIO0  A2=AUDIO1  A3=AUDIO2 A4=AUDIO3
	move.l	(a1)+,d5
	move.w	(a6,d5.w*2),d6
	move.b	d6,(a2)+	;VOL
	move.b	d6,(a5)+	;VOL
	lsr.w	#8,d6
	move.b	d6,(a3)+	;FINE VOL
	move.b	d6,(a4)+	;FINE VOL
	dbf	d0,.loop
	gets	d6/a6
	rts

CopyBackStream14Bit_Right
	puts	d6/a6
	;jsr	GetCopyBack16BitShift
	;--- DO OVERSAMPLE 3 ---
	IFNE OS3
	bsr	DoOversample3
	ENDC
	subq.w	#1,d0
	move.l	Bit14Tab_PTR,a6
	move.l	#BIT14_ENTRIES,d6
	lea.l	(a6,d6.l),a6
.loop	;A5=AUDIO0  A2=AUDIO1  A3=AUDIO2 A4=AUDIO3
	move.l	(a1)+,d5
	swap	d5
	move.w	(a6,d5.w*2),d6
	move.b	d6,(a2)+	;VOL
	move.b	d6,(a5)+
	lsr.w	#8,d6
	move.b	d6,(a3)+	;FINE VOL
	move.b	d6,(a4)+	;VOL
	dbf	d0,.loop
	gets	d6/a6
	rts


	acode
GetCopyBackShift
	moveq	#8,d7
	rts

	acode
CopyBackStream9Bit_Stereo
	;--- DO OVERSAMPLE 3 ---
	IFNE OS3
	bsr		DoOversample3
	ENDC

	subq.w	#1,d0
	bsr		GetCopyBackShift
	subq.w	#1,d7
	move.l	Stream9BitTAB_PTR(PC),a0
	lea.l	STREAM9BITNUMB*2(a0),a0

.loop
	move.l	(a1)+,d5
	asr.w	d7,d5

	move.l	(a0,d5.w*4),d4
	move.b	d4,(a2)+
	swap	d4
	move.b	d4,(a3)+

	swap	d5
	asr.w	d7,d5
	move.l	(a0,d5.w*4),d4
	move.b	d4,(a5)+
	swap	d4
	move.b	d4,(a4)+
	dbf		d0,.loop
	rts


CopyOS_LASTLONG	dc.l	0

	acode
CopyBackStreamOS9Bit_Stereo
	BGN
	;--- DO OVERSAMPLE 3 ---
	IFNE OS3
	bsr	DoOversample3
	ENDC

	move.l	Stream9BitTAB_PTR(PC),a0
	lea.l	STREAM9BITNUMB*2(a0),a0

	subq.w	#1,d0
	bsr	GetCopyBackShift
	subq.w	#1,d7
	move.l	CopyOS_LASTLONG(PC),d5
.loop		move.l	d5,d6

		move.l	(a1)+,d5
		asr.w	d7,d5

		add.w	d5,d6
		asr.w	#1,d6

		move.l	(a0,d6.w*4),d4
		move.b	d4,(a2)+
		swap	d4
		move.b	d4,(a3)+
		swap	d6

		move.l	(a0,d5.w*4),d4
		move.b	d4,(a2)+
		swap	d4
		move.b	d4,(a3)+
		swap	d5

		asr.w	d7,d5
		add.w	d5,d6
		asr.w	#1,d6

		move.l	(a0,d6.w*4),d4
		move.b	d4,(a5)+
		swap	d4
		move.b	d4,(a4)+

		move.l	(a0,d5.w*4),d4
		move.b	d4,(a5)+
		swap	d4
		move.b	d4,(a4)+
		swap	d5

	dbf	d0,.loop

	move.l	d5,CopyOS_LASTLONG

	btst	#0,d3
	beq.s	.exit
		move.l	(a0,d5.w*4),d4
		move.b	d4,(a2)+
		swap	d4
		move.b	d4,(a3)+
		swap	d5
		move.l	(a0,d5.w*4),d4
		move.b	d4,(a5)+
		swap	d4
		move.b	d4,(a4)+
.exit	RET

	acode

CopyBackStreamOS14Bit_Stereo
	BGN
	;--- DO OVERSAMPLE 3 ---
	IFNE OS3
	bsr	DoOversample3
	ENDC

	move.l	Bit14Tab_PTR,a0
	move.l	#BIT14_ENTRIES,d4
	lea.l	(a0,d4.l),a0

	;jsr	GetCopyBack16BitShift

	move.l	CopyOS_LASTLONG(PC),d5
	subq.w	#1,d0

.loop		move.l	d5,d6

		move.l	(a1)+,d5

		;asl.w	d7,d5
		asr.w	#1,d5
		add.w	d5,d6
		move.w	(a0,d6.w*2),d4
		move.b	d4,(a2)+
		lsr.w	#8,d4
		move.b	d4,(a3)+

		move.w	(a0,d5.w*2),d4
		move.b	d4,(a2)+
		lsr.w	#8,d4
		move.b	d4,(a3)+

		swap	d6
		swap	d5

		;asl.w	d7,d5
		asr.w	#1,d5
		add.w	d5,d6

		move.w	(a0,d6.w*2),d4
		move.b	d4,(a5)+
		lsr.w	#8,d4
		move.b	d4,(a4)+

		move.w	(a0,d5.w*2),d4
		move.b	d4,(a5)+
		lsr.w	#8,d4
		move.b	d4,(a4)+

		swap	d5

	dbf	d0,.loop
	move.l	d5,CopyOS_LASTLONG
.exit	RET

	acode
ClearSample	;V1.01 16BIT
		;I(D0W,A1L)
	puts	d0-d1/a1
	subq.w	#1,d0
	bmi.s	.exit
	moveq	#0,d1
.loop	move.l	d1,(a1)+
	dbf	d0,.loop
.exit	gets	d0-d1/a1
	rts


	;--- MASTERVOLUME, BALANCE ---

	acode
ProcMVol	;V2.0 16BIT Balance, Mastervolume
		;I(D0W,A1L)
		;V2.0: SOFT FADE
	IFNE	SYMPHPRO
	tst.b	DSPPLUG_STATUS
	beq.s	.mark
	jsr	ProcDSPPlugIn
.mark
	ENDC
	tst.b	SYSVOL
	bne.s	.notzero
	tst.b	SYSVOLOLD
	beq	.zerovol
.notzero
	puts	d0-d5/a1
	subq.w	#1,d0
	bmi.s	.exit
	moveq	#0,d2
	move.w	SYSVOL,d2
	cmp.w	SYSVOLOLD,d2
	bne	.dynamic
	move.w	SYSVOL,SYSVOLOLD

.static	cmpi.w	#100*256,d2
	bne.s	.M2
	cmpi.b	#50,SYSVOL+2
	beq.s	.exit
.M2	mulu	#127,d2
	divu	#100,d2
	move.w	d2,d3
	moveq	#0,d5
	move.b	SYSVOL+2,d5
	cmpi.b	#50,d5
	beq.s	.loop
	cmpi.b	#50,d5
	bhi.s	.m1
	moveq	#100,d1
	sub.b	d5,d1
	mulu	d5,d2
	divu	d1,d2
	bra.s	.loop
.m1	moveq	#100,d1
	sub.b	d5,d1
	mulu	d1,d3
	divu	d5,d3
.loop	move.l	(a1),d1
	move.w	d1,d4
	muls	d2,d4
	asl.l	#1,d4
	swap	d4
	move.w	d4,d1
	swap	d1
	move.w	d1,d4
	muls	d3,d4
	asl.l	#1,d4
	swap	d4
	move.w	d4,d1
	swap	d1
	move.l	d1,(a1)+
	dbf	d0,.loop
.exit	gets	d0-d5/a1
	rts

.zerovol
	clr.w	SYSVOLOLD
	bra	ClearSample

.dynamic
	cmpi.w	#SYSVOLFADE+2,d0
	blo	.static

	puts	d0-d7
	moveq	#0,d4
	moveq	#SYSVOLFADE-1,d5
	move.w	SYSVOL,d6
	moveq	#SYSVOLFADE-2,d7
.dyloop	move.w	d6,d2
	move.w	SYSVOLOLD,d3
	mulu	d4,d2
	mulu	d5,d3
	add.l	d2,d3
	lsr.l	#SYSVOLFADELN,d3
	move.w	d3,SYSVOL
	bsr	ProcessMVolSample
	addq.w	#1,d4
	subq.w	#1,d5
	dbf	d7,.dyloop
	move.w	d6,SYSVOL
	move.w	d6,SYSVOLOLD
	gets	d0-d7

	subi.w	#SYSVOLFADE-1,d0
	bra	.static

ProcessMVolSample
	;I((A1L))(SAMPLE)
	;O((A1L++))(SAMPLE)
	puts	d1-d5
	moveq	#0,d2
	move.w	SYSVOL,d2
	cmpi.w	#100*256,d2
	bne.s	.M2
	cmpi.b	#50,SYSVOL+2
	beq.s	.exit
.M2	mulu	#127,d2
	divu	#100,d2
	move.w	d2,d3
	moveq	#0,d5
	move.b	SYSVOL+2,d5
	cmpi.b	#50,d5
	beq.s	.loop
	cmpi.b	#50,d5
	bhi.s	.m1
	moveq	#100,d1
	sub.b	d5,d1
	mulu	d5,d2
	divu	d1,d2
	bra.s	.loop
.m1	moveq	#100,d1
	sub.b	d5,d1
	mulu	d1,d3
	divu	d5,d3
.loop	move.l	(a1),d1
	move.w	d1,d4
	muls	d2,d4
	asl.l	#1,d4
	swap	d4
	move.w	d4,d1
	swap	d1
	move.w	d1,d4
	muls	d3,d4
	asl.l	#1,d4
	swap	d4
	move.w	d4,d1
	swap	d1
	move.l	d1,(a1)+
.exit	gets	d1-d5
	rts





	acode
CopyVoiceBuffer_DSP
	bsr	GetCalcBuffer
	puts	a6
	move.l	PREDSP(PC),a6
	jsr	(a6)
	gets	a6
	bra	CopyVoiceBuffer_DSPIN
	acode
PostDSPFilter
	btst	#POSTFILTER,POSTDSP_FLAG
	bne.s	CopyDSP_FiltDo
	rts
	acode
PreDSPFilter
	tst.b	DSPFilterEcho
	bne.s	CopyDSP_FiltDo
	rts
	acode
CopyDSP_FiltDo
	puts	d0-d3/a1
	subq.w	#1,d0

	moveq	#1,d2	

	bra	PreDspHPFilt

	subq.w	#1,d0
PreDspFilt_L	
		move.w	4(a1),d1
		addq.w	#1,d1
		sub.w	(a1),d1
		asr.w	d2,d1
		sub.w	d1,4(a1)

		lea.l	2(a1),a1

		move.w	4(a1),d1
		addq.w	#1,d1
		sub.w	(a1),d1
		asr.w	d2,d1
		sub.w	d1,4(a1)

		lea.l	2(a1),a1

	dbf	d0,PreDspFilt_L
	gets	d0-d3/a1
	rts

	acode
PreDspHPFilt
	move.w	d2,d3
	move.l	DspHPFilt_LASTSAMPLE(PC),d2
	;	D2L	LASTSAMPLE
	puts	d4-d5
PreDspHPFilt_L	
		move.l	(a1),d1
		move.l	d1,d4

		sub.w	d2,d1
;		addq.w	#1,d1
		asr.w	d3,d1
		sub.w	d1,d4

		swap	d1
		swap	d4
		swap	d2		;NO MIDDLE FLOW

		sub.w	d2,d1
;		addq.w	#1,d1
		asr.w	d3,d1
		sub.w	d1,d4

		swap	d4

;		move.l	(a1),d5
;		sub.w	d4,d5
;		swap	d4
;		swap	d5
;		sub.w	d4,d5
;		swap	d4
;		swap	d5
;		move.l	d5,d4


		move.l	d4,(a1)+
		move.l	d4,d2

	dbf	d0,PreDspHPFilt_L
	move.l	d4,DspHPFilt_LASTSAMPLE
	gets	d4-d5

	gets	d0-d3/a1
	rts

	acode
CopyDSP_Echo
	bsr	PreDSPFilter
	puts	d0-d2/a1
	move.l	DSP_ECHO_LVL(PC),d2
	subq.w	#1,d0
PreDspSample_L	
		move.l	(a1),d1
		addq.w	#1,d1
		asr.w	d2,d1
		swap	d1
		addq.w	#1,d1
		asr.w	d2,d1
		swap	d1
		move.l	d1,(a1)+
	dbf	d0,PreDspSample_L
PreDspSample_X	gets	d0-d2/a1
	rts

	acode
CopyDSP_CrossEcho
	bsr	PreDSPFilter
	puts	d0-d3/a1
	move.l	DSP_ECHO_LVL(PC),d2
	subq.w	#1,d0
CopyDSP_CrossEcho_L	
		move.l	(a1),d1


		addq.w	#1,d1
		asr.w	d2,d1
		swap	d1
		addq.w	#1,d1
		asr.w	d2,d1

		move.l	d1,(a1)+
	dbf	d0,CopyDSP_CrossEcho_L
	gets	d0-d3/a1
	rts

	acode
CopyDSP_HallCrEcho
	puts	d0-d3/a1
	moveq	#0,d2
	move.w	HallInfo+2,d2
	subq.w	#1,d0
	addq.w	#1,d2
	bra.s	CopyDSP_CrossEcho_L2

	acode
CopyDSP_CrossEcho2
	bsr	PreDSPFilter
	puts	d0-d3/a1
	move.l	DSP_ECHO_LVL(PC),d2
	subq.w	#1,d0
	addq.w	#1,d2
CopyDSP_CrossEcho_L2	
		move.l	(a1),d1

		move.l	d1,d3

		;addq.w	#1,d1
		asr.w	d2,d1
		sub.w	d1,d3

		swap	d1
		swap	d3

		;addq.w	#1,d1
		asr.w	d2,d1
		sub.w	d1,d3

		move.l	d3,(a1)+
	dbf	d0,CopyDSP_CrossEcho_L2
	gets	d0-d3/a1
	rts

	acode
CopyDSP_HallEcho
	puts	d0-d3/a1
	moveq	#0,d2
	move.w	HallInfo+2,d2
	subq.w	#1,d0
	addq.w	#1,d2
	bra.s	CopyDSP_Echo_L2

	acode
CopyDSP_Echo2
	bsr	PreDSPFilter
	puts	d0-d3/a1
	move.l	DSP_ECHO_LVL(PC),d2
	subq.w	#1,d0
	addq.w	#1,d2
CopyDSP_Echo_L2	
		move.l	(a1),d1
		move.l	d1,d3
		addq.w	#1,d1
		asr.w	d2,d1
		sub.w	d1,d3
		swap	d1
		swap	d3
		addq.w	#1,d1
		asr.w	d2,d1
		sub.w	d1,d3
		swap	d3
		move.l	d3,(a1)+
	dbf	d0,CopyDSP_Echo_L2
	gets	d0-d3/a1
	rts


	acode
CopyDSP_CenterEcho
	tst.l	DSP_ECHO_LVL(PC)
	beq	ClearSample
	bsr	PreDSPFilter
	puts	d0-d4/a1
	move.l	DSP_ECHO_LVL(PC),d2
	subq.w	#1,d0
.loop		move.l	(a1),d1
		addq.w	#1,d1
		asr.w	d2,d1
		move.w	d1,d4
		addq.w	#1,d4
		asr.w	#1,d4
		asr.w	#1,d4
		swap	d4
		swap	d1
		addq.w	#1,d1
		asr.w	d2,d1
		move.w	d1,d4
		addq.w	#1,d4
		asr.w	#1,d4
		asr.w	#1,d4
		swap	d4
		add.w	d4,d1
		swap	d4
		swap	d1
		add.w	d4,d1
		swap	d1
		move.l	d1,(a1)+
	dbf	d0,.loop
	gets	d0-d4/a1
	rts

	acode
GetCalcBuffer
	puts	d0/a0
	lea.l	CALCBUF_INFO(PC),a0
	subq.w	#1,12(a0)
	beq.s	.RESET
	movem.l	(a0),d0/a1
.exit add.l	d0,4(a0)
	gets	d0/a0
	rts
.RESET	move.w	14(a0),12(a0)
	move.l	8(a0),a1
	move.l	(a0),d0
	move.l	a1,4(a0)
	bra.s	.exit


	acode
InitCalcBufferInfo
	puts	d0/a0-a1
	lea.l	CALCBUF_INFO(PC),a1
	move.l	CopyBuffer_PTR(PC),a0
	move.l	a0,4(a1)
	move.l	a0,8(a1)
	move.l	DSP_ECHO_LEN(PC),d0
	move.w	d0,12(a1)
	move.w	d0,14(a1)
	gets	d0/a0-a1
	rts





	acode
GetPostDspBuffer	;O(A1L)(ACTUAL_DESTPUFFER)
	puts	d0/a0
	lea.l	PostDspBUF_INFO(PC),a0
	subq.w	#1,12(a0)
	beq.s	GetPostDspBuffer_RESET
	movem.l	(a0),d0/a1
GetPostDspBuffer_X add.l	d0,4(a0)
	gets	d0/a0
	rts

	acode
GetPostDspBuffer_RESET
	move.l	4(a0),Chorus_Case+2
	move.w	14(a0),12(a0)
	move.l	8(a0),a1
	move.l	(a0),d0
	move.l	a1,4(a0)
	move.w	#-1,Chorus_Case
	bra.s	GetPostDspBuffer_X

Chorus_Case	dc.w	0	;0=OK
		dc.l	0	;LAST PTR

	acode
InitPostDspBufferInfo
	puts	d0/a0-a1
	lea.l	PostDspBUF_INFO(PC),a1
	move.l	PostDspBuffer_PTR(PC),a0
	move.l	a0,BUFINFO_ACTPTR(a1)
	move.l	a0,BUFINFO_PTR(a1)

;;;	move.l	PostDspBUFFERNUMB(PC),d0	;NON HALL
	move.w	HallInfo,d0

	move.w	d0,BUFINFO_COUNTER(a1)
	move.w	d0,BUFINFO_CRESET(a1)
	gets	d0/a0-a1
	rts
	even


BUFINFO_BUFLEN		EQU	0
BUFINFO_ACTPTR		EQU	4
BUFINFO_PTR		EQU	8
BUFINFO_COUNTER		EQU	12
BUFINFO_CRESET		EQU	14


POSTDELAY	EQU	0	;BIT0
POSTCHOR	EQU	1	;BIT1
POSTFILTER	EQU	2	;BIT1


	acode
PrepPostDsp
	puts	d0-d4/a0-a2
	move.l	a1,a0
	bsr	GetPostDspBuffer		;A1L: actual 16Bit Ring Buffer


	btst	#POSTDELAY,POSTDSP_FLAG
	beq.w	NoPostDelay

	bsr	PostDSPFilter
	bsr	DelayCopy

	puts	d0-d4/a0-a2
	subq.w	#1,d0
	lea.l	PostDspBUF_INFO(PC),a2
	move.l	BUFINFO_BUFLEN(a2),d4
	move.l	d4,d3
	mulu	DELAYINFO(PC),d3
	sub.l	d3,a1
	cmp.l	BUFINFO_PTR(a2),a1
	bhs.s	DelaySrc_OK
		move.l	d4,d3
		mulu	BUFINFO_CRESET(a2),d3
		add.l	d3,a1
DelaySrc_OK
	moveq	#0,d3
	move.w	DELAYINFO+2,d3

.loop		move.l	(a1)+,d1	
		move.l	(a0),d2

		addq.w	#1,d1
		asr.w	d3,d1	
		add.w	d1,d2

		swap	d1
		swap	d2

		addq.w	#1,d1
		asr.w	d3,d1	
		add.w	d1,d2

		swap	d2

		move.l	d2,(a0)+

	dbf	d0,.loop
;DelayHarmIn
	gets	d0-d4/a0-a2

NoPostDelay


;	subq.w	#1,d0
;	btst	#POSTCHOR,POSTDSP_FLAG
;	beq.s	NoPostChorus
;	move.w	CHORUSINFO,d3			;16Bit 2-Chorus 
;	tst.w	Chorus_Case
;	bne.w	ChorusEx
;	lea.l	(a1,d3.w),a1
;.loop	move.l	(a1)+,d1
;	move.l	(a0),d2
;	add.w	d1,d2
;	asr.w	#1,d2
;	swap	d1
;	swap	d2
;	add.w	d1,d2
;	asr.w	#1,d2
;	swap	d2
;	move.l	d2,(a0)+
;	dbf	d0,.loop
;	subq.w	#1,CHORUSINFO+8
;	bne.s	ChorusTest_M2
;	move.w	CHORUSINFO+10,CHORUSINFO+8
;	subq.w	#1,CHORUSINFO+4
;	bne.s	ChorusTest_M1
;	move.w	CHORUSINFO+6,CHORUSINFO+4
;	neg.w	CHORUSINFO+2
;ChorusTest_M1
;	add.w	CHORUSINFO+2(PC),d3
;	move.w	d3,CHORUSINFO
;	bne.s	ChorusTest_M2
;	bsr	ChorusReset
;NoPostChorus
;ChorusTest_M2

	gets	d0-d4/a0-a2
	rts

;ChorusReset
;	move.w	CHORUSINFO+6,CHORUSINFO+4
;	addq.w	#1,CHORUSINFO+4
;	clr.w	CHORUSINFO
;	move.w	#-4,CHORUSINFO+2
;	rts

;	acode
;ChorusEx_X
;	gets	d4-d5/a1
;	bra.s	NoPostChorus
;
;	acode
;ChorusEx
;	clr.w	Chorus_Case
;	bra.s	NoPostChorus;
;
;
;;	lea.l	(a1,d3.w),a1
;;	bra	ChorusTest_L
;	puts	d4-d5/a1;
;	move.w	d3,d4
;	neg.w	d4
;	lsr.w	#2,d4
;	move.w	d0,d5
;	sub.w	d4,d0
;	bmi.s	ChorusEx_X
;	subq.w	#1,d4
;	bmi.s	ChorusEx_X
;	clr.w	Chorus_Case
;	move.l	Chorus_Case+2,a1
;	lea.l	(a1,d3.w),a1
;	lea.l	(a1,d5.w*4),a1
;	
;.loop	move.l	(a1)+,d1
;	move.l	(a0),d2
;	add.w	d1,d2
;		asr.w	#1,d2
;		swap	d1
;		swap	d2
;		add.w	d1,d2
;		asr.w	#1,d2
;		swap	d2
;		move.l	d2,(a0)+
;	dbf	d4,.loop
;	gets	d4-d5/a1
;
;	bra	ChorusTest_L


	acode
DelayCopy
	tst.b	DelayFX
	bne.s	.do
	rts
.do
	puts	a6
	move.l	DelayFX+2(PC),a6
	jsr	(a6)
	gets	a6
	rts

	acode
DelayCopyNrm
	puts	d0/a0-a1
	subq.w	#1,d0
.loop	move.l	(a0)+,(a1)+
	dbf	d0,.loop
	gets	d0/a0-a1
	rts

	acode
DelayCopyCross
	puts	d0/a0-a1
	subq.w	#1,d0
.loop	move.l	(a0)+,d1
			swap	d1
			move.l	d1,(a1)+
	dbf	d0,.loop
	gets	d0/a0-a1
	rts

	acode
DelayCopyHall
	puts	d0/a0-a1
	bsr	CopyDSP_HallEcho

	subq.w	#1,d0
.loop	move.l	(a0)+,d1
		move.l	(a1),d2
		add.w	d1,d2
		swap	d1
		swap	d2
		add.w	d1,d2
		swap	d2
		move.l	d2,(a1)+
	dbf	d0,.loop
	gets	d0/a0-a1
	rts

	acode
DelayCopyCrHall
	puts	d0/a0-a1
	bsr	CopyDSP_HallCrEcho

	subq.w	#1,d0
.loop	move.l	(a0)+,d1
		move.l	(a1),d2
		add.w	d1,d2
		swap	d1
		swap	d2
		add.w	d1,d2
		swap	d2
		move.l	d2,(a1)+
	dbf	d0,.loop
	gets	d0/a0-a1
	rts

	acode
ValidateHall	
	puts	d0
	move.l	PostDspBUFFERNUMB,d0
	cmp.w	HallInfo,d0
	bhs.s	ValidateHall_X
		move.w	d0,HallInfo
		jsr	WarnFlash
ValidateHall_X	
	gets	d0
	rts	

ValidateDelay
	puts	d0
	move.l	PostDspBUFFERNUMB,d0
	subq.l	#1,d0
	cmp.w	DELAYINFO,d0
	bhs.s	ValDelay_1
		move.w	d0,DELAYINFO
ValDelay_1
	gets	d0
	rts


	
EmulateDSPFilter
	puts	d0-d1/a0-a1
	subq.w	#1,d0
EmulateDSPFilter_L
		move.b	(a1)+,d1
		sub.b	-1(a1),d1
		asr.b	#2,d1
		sub.b	d1,(a1)		
	dbf	d0,EmulateDSPFilter_L
	gets	d0-d1/a0-a1
	rts


COPYSMPLEN	EQU	2

	acode
ProcessMuteDSP
	move.l	SAMPLE_INSTRUMENTPTR(a0),a6
	cmp.l	#0,a6
	beq.s	.exit
	move.l	a2,INSTR_SAMPLEPOS(a6)			;Enforcer Hit
	btst	#SPLAYFLAG_NODSP,INSTR_PLAYFLAG(a6)
	beq.s	.exit
	move.w	DryDspBuffer_OFF(PC),d7
	move.l	DryDspBuffer_PTR(PC),a1
	lea.l	(a1,d7.w),a1
	addq.w	#1,Dry_COUNT
.exit	rts


	acode
CopySample_VFade	;D3W(VOL) A2L(SAMPLEPTR) Shift of Emphasis
	puts	d4-d6

	move.l	SAMPLE_ENDPTR(a0),d4

	move.l	d4,d5
	sub.l	SAMPLE_STARTPTR(a0),d4
	beq.s	CopySample_VFadeX
	sub.l	a2,d5			;OK

	move.w	SAMPLE_VFADEEND(a0),d6
	sub.w	SAMPLE_VFADESTART(a0),d6
	extb.l	d6

	muls.l	d6,d5
	divs.l	d4,d5
	addq.l	#1,d5

	cmpi.b	#1,SAMPLE_VFADE(a0)
	beq.s	CopySample_VFadeNoOk

	cmpi.b	#2,SAMPLE_VFADE(a0)
	bne.s	CopySample_VFadeNo2
		jsr	WarnFlash
		neg.b	d5
		addi.b	#100,d5
		bra.s	CopySample_VFadeNoOk
CopySample_VFadeNo2

	cmpi.b	#3,SAMPLE_VFADE(a0)
	bne.s	CopySample_VFadeNo3
		jsr	WarnFlash
		cmpi.b	#50,d5
		bls.s	CSVFadeNo3a

		asl.b	#1,d5
		neg.b	d5
		addi.b	#200,d5
		
		bra.s	CopySample_VFadeNoOk

CSVFadeNo3a
		asl.b	#1,d5
		bra	CopySample_VFadeNoOk
CopySample_VFadeNo3


CopySample_VFadeNoOk
	asl.l	#8,d5
	move.l	d5,d3

	move.w	SAMPLE_VFADESTART(a0),d6
	lsl.w	#8,d6
	add.w	d6,d3
	cmpi.w	#VOLUME_MAX*$100,d3
	bls.s	CopySample_VFadeX
		move.w	#VOLUME_MAX*$100,d3
CopySample_VFadeX
	gets	d4-d6
	bra	VFade_IN

	acode
CopySample_DoVibrato
	puts	d0-d2/d4/a1
	move.w	SAMPLE_VIBLFOACTUAL(a0),d0
	add.w	SAMPLE_VIBLFOADD(a0),d0
	andi.w	#$1ff,d0
	move.w	d0,SAMPLE_VIBLFOACTUAL(a0)
	move.l	VibratoTab_PTR,a1
	lsr.w	#1,d0
	move.w	(a1,d0.w*2),d0
	move.w	d3,d1
	muls	d0,d1
	divs	#$7f,d1
	move.w	SAMPLE_VIBDEPTH(a0),d2	;0..255
	lsr.w	#1,d2
	addq.w	#1,d2
	move.w	#255,d4
	sub.w	d2,d4
	mulu	d4,d3
	moveq	#8,d4
	lsr.l	d4,d3
	muls	d1,d2
	asr.l	d4,d2
	add.w	d2,d3
	cmpi.w	#100*$100,d3
	bgt.s	Vibrato_OV	;OBSOLETE ??
Vibrato_X
	gets	d0-d2/d4/a1
	bra	Vibrato_IN
Vibrato_OV
	move.w	#100*$100,d3
	bra.s	Vibrato_X

	acode
CopySample_DoTremolo
	puts	d0-d1/d3/d4/a1
	move.w	SAMPLE_TREMLFOACTUAL(a0),d0
	add.w	SAMPLE_TREMLFOADD(a0),d0
	andi.w	#$1ff,d0
	move.w	d0,SAMPLE_TREMLFOACTUAL(a0)
	move.l	TremoloTab_PTR,a1
	lsr.w	#1,d0
	move.w	(a1,d0.w*2),d0
	ext.l	d0
	move.l	d2,d4
	lsr.l	#1,d4
	muls.l	d0,d3:d4
	divs.l	#$80,d3:d4
	moveq	#0,d0
	move.w	SAMPLE_TREMDEPTH(a0),d0
	muls.l	d0,d3:d4
	divs.l	#100,d3:d4
	add.l	d4,d2
	gets	d0-d1/d3/d4/a1
	bra	Tremolo_IN

	acode
CopySample_DoSampleVib
	puts	d0-d3/a1
	move.w	SAMPLE_SAVIBLFOACTUAL(a0),d0
	add.w	SAMPLE_SAVIBLFOADD(a0),d0
	andi.w	#$3ff,d0
	move.w	d0,SAMPLE_SAVIBLFOACTUAL(a0)
	gets	d0-d3/a1
	bra	SampleVib_IN


	IFEQ	SYMPHPRO
CopySample:	;V7.2	;JR VERSION 
		;I(D0W,A0L,A1L)(SAMPLENUMB,SAMPLE_STRUCT,DEST_PTR)
		;the magic routine of SYMPHONIE-32
		;5.0:	VOLUME [0-100%]
		;5.1:   SAMPLELEN can be upto 4MEGABYTE !!! (-> % CALC)

		;6.0:   New DSP Routines implemented
		;6.1:   KeyOn Fade
		;7.0	Now is Addsample
		;7.1	V/P Slide, CONT_SAMPLE Fade
		;7.2	STOP_SAMPLE Fade

	tst.w	SAMPLE_RETRIGNUMB(a0)
	beq.s	CopySample_NoRetrig

	subq.w	#1,SAMPLE_RETRIGCOUNT(a0)
	bne.s	CopySample_NoRetrig

	subq.w	#1,SAMPLE_RETRIGNUMB(a0)
	beq.s	CopySample_NoRetrig	;LAST PASSED
	

CopySampleRetrig
	move.w	SAMPLE_RETRIGCYCL(a0),SAMPLE_RETRIGCOUNT(a0)
	move.l	SAMPLE_RETRIGPTR(a0),SAMPLE_PTR(a0)

	move.b	#FALSE,SAMPLE_ENDREACHED(a0)
	move.w	#SAMPLEST_INUSE,SAMPLE_STATUS(a0)
	clr.b	SAMPLE_DECLICK(a0)
	clr.l	SAMPLE_HIOFFSET(a0)

CopySample_NoRetrig
	cmpi.b	#TRUE,SAMPLE_ENDREACHED(a0)
	bne.s	CopySample_DoDo
	rts



CopySample_DoDo	
	BGN
	bsr	ProcessMuteDSP
	move.w	d0,d7				;COPY THE STUFFS
	subq.w	#1,d7
	cmpi.w	#SAMPLEST_PENDING,SAMPLE_STATUS(a0)
	bne.s	CopySample_Do


	tst.b	SAMPLE_FADEOUT(a0)
	beq.s	.exit

		clr.b	SAMPLE_FADEOUT(a0)
		move.w	SAMPLE_LASTSAMPLE(a0),d0
		beq.s	.exit
		clr.w	SAMPLE_LASTSAMPLE(a0)

	IFNE	SPECIAL
	tst.b	Declicking
	beq.s	.exit
	ENDC

	move.w	FADEOUTSTEPS,d6
	cmp.w	d0,d6
	blo.s	.ok
		move.w	d0,d6
.ok	move.w	d6,d4
	move.w	d4,d7
	subq.w	#1,d7
.loop	move.w	d0,d5
	muls	d4,d5
	divs	d6,d5
	subq.w	#1,d4
	add.w	d5,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	dbf	d7,.loop
.exit	RET

CopySample_Do
	move.l	SAMPLE_PTR(a0),a2
	move.l	SAMPLE_INSTRUMENTPTR(a0),a6
	cmp.l	#0,a6
	beq	CopySample_X
	move.l	a2,INSTR_SAMPLEPOS(a6)



	move.l	SAMPLE_HIOFFSET(a0),d1
	move.l	SAMPLE_FREQUENZ(a0),d2
	move.l	SAMPLE_ENDPTR(a0),d6			;D6 END OF SAMPLE


	moveq	#0,d3
	move.w	SAMPLE_VOLUME(a0),d3

	tst.b	SAMPLE_VFADE(a0)
	bne.w	CopySample_VFade

	tst.w	SAMPLE_VOLSLIDE(a0)			;Volumeslide
	beq.s	CopySample_NOVOLSLIDE

	add.w	SAMPLE_VOLSLIDE(a0),d3
	bmi.s	CopySample_SETMINVOL
	cmpi.w	#((VOLUME_MAX+1)*256),d3
	blo.s	CopySample_NEWVOL

	move.w	#VOLUME_MAX*$100,d3
	clr.w	SAMPLE_VOLSLIDE(a0)
	bra.s	CopySample_NEWVOL
CopySample_SETMINVOL
	moveq	#0,d3
	move.w	d3,SAMPLE_VOLSLIDE(a0)
CopySample_NEWVOL
	move.w	d3,SAMPLE_VOLUME(a0)
CopySample_NOVOLSLIDE

VFade_IN

	tst.w	SAMPLE_VIBDEPTH(a0)
	bne.w	CopySample_DoVibrato
Vibrato_IN

						;D3 WORDVOLUME LFO PROCESS
	lsr.w	#8,d3

	tst.w	SAMPLE_PITCHSLIDE(a0)			;Pitchslide
	beq.s	CopySample_NOPITCHSLIDE
	puts	d3
	move.l	d2,d3
	lsr.l	#8,d3
	move.w	SAMPLE_PITCHSLIDE(a0),d0
	ext.l	d0
	muls.l	d3,d0
	asr.l	#PITCHSLIDE_LN,d0
	sub.l	d0,d2
	gets	d3
CopySample_NOPITCHSLIDE

	tst.l	SAMPLE_DESTFREQUENZ(a0)
	beq.s	CopySample_NOPSLIDETO


	puts	d6-d7

	move.l	SAMPLE_DESTFREQUENZ(a0),d7
	sub.l	d2,d7
	bne.s	CopySample_PSLIDETO
	clr.l	SAMPLE_DESTFREQUENZ(a0)
CopySample_PSLIDETO

	moveq	#0,d6
	move.w	SAMPLE_PSLIDETOSPD(a0),d6

	addq.l	#1,d7
	divs.l	d6,d7

;;;		asr.l	d6,d7


	add.l	d7,d2
	gets	d6-d7

CopySample_NOPSLIDETO
	move.l	d2,SAMPLE_FREQUENZ(a0)			;PITCH SLIDE (IF)

	tst.w	SAMPLE_TREMDEPTH(a0)
	bne.w	CopySample_DoTremolo
Tremolo_IN

	tst.w	SAMPLE_SAVIBDEPTH(a0)
	bne.w	CopySample_DoSampleVib
SampleVib_IN
	move.l	a2,a4
	;D3 IS NOW BYTE
	cmpi.b	#VOLUME_COMMAND,d3
	bhi.w	CopySample_ERR

	;bsr	ProcessCV

	subq.l	#1,d6					; CORRECT END OF SAMPLE -1

	tst.b	d3
	beq	CopySampleZero
	cmpi.b	#VOLUME_MAX,d3
	bgt.s	CopySampleSlow
	cmpi.b	#-VOLUME_MAX,d3
	blt.s	CopySampleSlow
	cmp.b	VL_PROCVLIMIT+1,d3
	bgt.w	CopySampleMV

CopySampleSlow						;SUPERFAST
	tst.b	FASTPOSSIBLE
	beq.s	.nofast
	move.l	SAMPLE_INSTRUMENTPTR(a0),a6
	btst	#SPLAYFLAG_SUPERFAST,INSTR_PLAYFLAG(a6)
	bne	CopySampleSlowSF

.nofast		
	move.l	VolumeList_PTR(PC),a3
	lea.l	(a3,d3.w*4),a3				;A3L ACT VOLUME TAB
	move.l	(a3),a3
	moveq	#0,d0
	move.l	#CopySample_L,SampleRun

	tst.b	SAMPLE_DECLICK(a0)			;FADESAMPLE
	beq.s	CopySample_L
	clr.b	SAMPLE_DECLICK(a0)
	move.w	SAMPLE_LASTSAMPLE(a0),d3


	cmp.w	FADETOSTEPS,d7
	blo.s	CopySample_L
	moveq	#1,d4
	swap	d4
	move.w	#FADETO_STEPS,d4
	subi.w	#FADETO_STEPS,d7
	puts	d7
	moveq	#FADETO_STEPS-1,d7
CopySample_FadeL
	move.w	d3,d5
	muls	d4,d5
	divs	#10,d5
	subq.w	#1,d4

		move.b	(a4),d0				;D0b=SAMPLEBYTE
		ext.w	d0		

	swap	d4
	muls	d4,d0
	divs	#10,d0
	move.w	(a3,d0.w*2),d0	;VOLUME V1.0
	addq.w	#1,d4
	swap	d4
	add.w	d5,d0

	swap	d1
	lea.l	(a2,d1.w),a4	;New Pos
	swap	d1
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6

	dbls	d7,CopySample_FadeL
	gets	d7
	cmp.l	a4,d6
	bls.s	CopySample_M1	



CopySample_L	


	move.b	(a4),d0		;D0b=SAMPLEBYTE
	swap	d1
	lea.l	(a2,d1.w),a4	;New Pos
	swap	d1
	move.w	(a3,d0.w*2),d0	;VOLUME V1.0
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6
	dbls	d7,CopySample_L
CopySample_M1
	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2

	move.w	d0,SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)

	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	

CopySample_X	RET





	acode
CopySampleSlowSF
	clr.l	CopySampleSF_OFFSET
	cmpi.w	#MULTISAMPLE_STEREOL,INSTR_MULTI(a6)
	bne.s	.nostereo

	move.l	(INSTR_SAMPLEPTR+INSTR_SIZEOF)(a6),d0
	sub.l	INSTR_SAMPLEPTR(a6),d0
	move.l	d0,CopySampleSF_OFFSET
.nostereo

	move.l	VolumeList_PTR(PC),a3
	lea.l	(a3,d3.w*4),a3				;A3L ACT VOLUME TAB
	move.l	(a3),a3
	moveq	#0,d0
	move.l	#CopySampleSlowSF_L,SampleRun

	tst.b	SAMPLE_DECLICK(a0)			;FADESAMPLE
	beq.s	CopySampleSlowSF_go
	clr.b	SAMPLE_DECLICK(a0)
	move.w	SAMPLE_LASTSAMPLE(a0),d3


	cmpi.w	#FADETO_STEPS,d7
	blo.s	CopySampleSlowSF_go
	moveq	#1,d4
	swap	d4
	move.w	#FADETO_STEPS,d4
	subi.w	#FADETO_STEPS,d7
	puts	d7
	moveq	#FADETO_STEPS-1,d7
CopySampleSlowSF_FadeL
	move.w	d3,d5
	muls	d4,d5
	divs	#10,d5
	subq.w	#1,d4

	move.b	(a4),d0				;D0b=SAMPLEBYTE
	ext.w	d0		

	swap	d4
	muls	d4,d0
	divs	#10,d0
	move.w	(a3,d0.w*2),d0	;VOLUME V1.0
	addq.w	#1,d4
	swap	d4
	add.w	d5,d0

	swap	d1
	lea.l	(a2,d1.w),a4	;New Pos
	swap	d1
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6

	dbls	d7,CopySampleSlowSF_FadeL
	gets	d7
	cmp.l	a4,d6
	bls.s	CopySampleSlowSF_M1	


CopySampleSlowSF_go
	move.l	CopySampleSF_OFFSET,d5
	tst.l	d5
	moveq	#0,d3
	beq	CopySampleSlowSFmono_go
CopySampleSlowSF_L	
	move.b	(a4),d0		;D0b=SAMPLEBYTE
	move.b	(a4,d5.l),d3
	swap	d1
	lea.l	(a2,d1.w),a4	;New Pos
	swap	d1
	move.w	(a3,d0.w*2),d0	;VOLUME V1.0
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)
	move.w	(a3,d3.w*2),d0	;VOLUME V1.0
	add.w	d0,2(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6
	dbls	d7,CopySampleSlowSF_L
CopySampleSlowSF_M1
	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2

	move.w	d0,SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)

	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	

CopySampleSlowSF_X	RET


SampleRun	dc.l	CopySample_L

	acode
CopySample_dL
	move.l	SampleRun(PC),a6
	jmp	(a6)


	acode
CopySample_WASLAST
	cmpi.w	#INSTRTYPE_NONE,SAMPLE_INSTRUMENTTYPE(a0)
	beq.s	CopySample_WASLAST2
	cmpi.w	#INSTRTYPE_SUST,SAMPLE_INSTRUMENTTYPE(a0)
	beq.s	CopySample_Sustained
	move.l	SAMPLE_LOOPSTARTPTR(a0),a2
	move.l	SAMPLE_LOOPENDPTR(a0),d6
	move.l	a2,SAMPLE_PTR(a0)
	move.l	d6,SAMPLE_ENDPTR(a0)
	move.l	a2,a4
	moveq	#0,d1
	subq.w	#1,d7
	bmi	CopySample_X
	bra	CopySample_dL

	acode
CopySample_Sustained
	tst.w	SAMPLE_LOOPNUMB(a0)
	bmi.s	CopySample_WASLAST2
	subq.w	#1,SAMPLE_LOOPNUMB(a0)
	bmi.s	CopySample_DoSustain
	move.l	SAMPLE_LOOPSTARTPTR(a0),a2
	move.l	SAMPLE_LOOPENDPTR(a0),d6
	move.l	a2,SAMPLE_PTR(a0)
	move.l	d6,SAMPLE_ENDPTR(a0)
	move.l	a2,a4
	moveq	#0,d1
	subq.w	#1,d7
	bmi	CopySample_X
	bra	CopySample_dL

	acode
CopySample_DoSustain
	move.l	SAMPLE_SUSTSTARTPTR(a0),a2
	move.l	SAMPLE_SUSTENDPTR(a0),d6
	move.l	a2,SAMPLE_PTR(a0)
	move.l	d6,SAMPLE_ENDPTR(a0)
	move.l	a2,a4
	moveq	#0,d1
	subq.w	#1,d7
	bmi	CopySample_X
	bra	CopySample_dL

	acode
CopySample_ERR
	jsr	WarnFlash

CopySample_WASLAST2
	clr.b	SAMPLE_DECLICK(a0)	     ;NO FADESAMPLE
	move.w	#SAMPLEST_PENDING,SAMPLE_STATUS(a0)
	move.b	#TRUE,SAMPLE_ENDREACHED(a0)
	move.l	SAMPLE_INSTRUMENTPTR(a0),a6
	clr.l	INSTR_SAMPLEPOS(a6)
	bra	CopySample_X

CopySampleMV
	;D3 IS NOW BYTE
	cmpi.b	#VOLUME_COMMAND,d3
	bhi.w	CopySample_ERR

	tst.b	FASTPOSSIBLE
	beq.s	.nofast
	move.l	SAMPLE_INSTRUMENTPTR(a0),a6
	btst	#SPLAYFLAG_SUPERFAST,INSTR_PLAYFLAG(a6)
	bne	CopySampleSF
.nofast

	move.l	#CopySampleMV_L,SampleRun


	moveq	#0,d0
	tst.b	SAMPLE_DECLICK(a0)			;FADESAMPLE
	beq.s	CopySampleMV_L
	clr.b	SAMPLE_DECLICK(a0)


	move.w	SAMPLE_LASTSAMPLE(a0),d3
	moveq	#1,d4
	swap	d4
	move.w	#FADETO_STEPS,d4
	subi.w	#FADETO_STEPS,d7
	puts	d7
	moveq	#FADETO_STEPS-1,d7
CopySampleMV_FadeL
	move.w	d3,d5
	muls	d4,d5
	divs	#10,d5
	subq.w	#1,d4

	move.b	(a4),d0				;D0b=SAMPLEBYTE
	ext.w	d0		

	swap	d4
	muls	d4,d0
	divs	#10,d0
	addq.w	#1,d4
	swap	d4
	add.w	d5,d0

	swap	d1
	lea.l	(a2,d1.w),a4	;New Pos
	swap	d1
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6

	dbls	d7,CopySampleMV_FadeL
	gets	d7
	cmp.l	a4,d6
	bls.s	CopySampleMV_M1	

CopySampleMV_L	

	move.b	(a4),d0		;D0b=SAMPLEBYTE
	swap	d1
	lea.l	(a2,d1.w),a4	;New Pos
	swap	d1
	ext.w	d0

	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6
	dbls	d7,CopySampleMV_L
CopySampleMV_M1
	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2

	move.w	d0,SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)

	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	

	RET

CopySampleSF						;8BIT
	cmpi.b	#VOLUME_COMMAND,d3
	bhi	CopySample_ERR

	clr.l	CopySampleSF_OFFSET
	cmpi.w	#MULTISAMPLE_STEREOL,INSTR_MULTI(a6)
	bne.s	.nostereo

	move.l	(INSTR_SAMPLEPTR+INSTR_SIZEOF)(a6),d0
	sub.l	INSTR_SAMPLEPTR(a6),d0
	move.l	d0,CopySampleSF_OFFSET

.nostereo	move.l	#CopySampleSF_L,SampleRun


	moveq	#0,d0
	tst.b	SAMPLE_DECLICK(a0)			;FADESAMPLE
	beq.s	CopySampleSF_go
	clr.b	SAMPLE_DECLICK(a0)


	move.w	SAMPLE_LASTSAMPLE(a0),d3
	moveq	#1,d4
	swap	d4
	move.w	#FADETO_STEPS,d4
	subi.w	#FADETO_STEPS,d7
	puts	d7
	moveq	#FADETO_STEPS-1,d7
CopySampleSF_FadeL
	move.w	d3,d5
	muls	d4,d5
	divs	#10,d5
	subq.w	#1,d4

		move.b	(a4),d0				;D0b=SAMPLEBYTE
		ext.w	d0		

	swap	d4
	muls	d4,d0
	divs	#10,d0
	addq.w	#1,d4
	swap	d4
	add.w	d5,d0

	swap	d1
	lea.l	(a2,d1.w),a4	;New Pos
	swap	d1
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6

	dbls	d7,CopySampleSF_FadeL
	gets	d7
	cmp.l	a4,d6
	bls.s	CopySampleSF_M1	


CopySampleSF_go
	move.l	CopySampleSF_OFFSET,d5
	tst.l	d5
	beq.s	CopySampleSFmono_go
CopySampleSF_L	
	move.b	(a4),d0		;D0b=SAMPLEBYTE
	swap	d1
	move.b	(a4,d5.l),d3
	lea.l	(a2,d1.w),a4	;New Pos
	swap	d1
	ext.w	d0

	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)
	ext.w	d3
	add.w	d3,2(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6
	dbls	d7,CopySampleSF_L
CopySampleSF_M1
	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2
	move.w	d0,SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)
	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	
	RET

CopySampleSFmono_go
	move.l	#CopySampleSFmono_L,SampleRun
CopySampleSFmono_L	
	move.b	(a4),d0		;D0b=SAMPLEBYTE
	swap	d1
	lea.l	(a2,d1.w),a4	;New Pos
	swap	d1
	ext.w	d0
	add.w	d0,2(a1)
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6
	dbls	d7,CopySampleSFmono_L
	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2
	move.w	d0,SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)
	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	
	RET


CopySampleSlowSFmono_go
	move.l	#CopySampleslowSFmono_L,SampleRun
CopySampleslowSFmono_L	
	move.b	(a4),d0		;D0b=SAMPLEBYTE
	swap	d1
	lea.l	(a2,d1.w),a4	;New Pos
	swap	d1
	move.w	(a3,d0.w*2),d0	;VOLUME V1.0
	add.w	d0,(a1)
	add.l	d2,d1
	add.w	d0,2(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6
	dbls	d7,CopySampleslowSFmono_L
	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2

	move.w	d0,SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)
	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	
	RET


	acode
CopySampleZero
	move.l	#CopySampleZero_L,SampleRun
CopySampleZero_L	
	swap	d1
	lea.l	(a2,d1.w),a4	;New Pos
	swap	d1
	add.l	d2,d1			;D2=NEWHIOFFSET
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6
	dbls	d7,CopySampleZero_L
	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2
	clr.w	SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)
	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	
	RET

	ELSE
	;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 8/16

	acode
CopySample:	;V7.2	16BIT PRO VERSION
		;I(D0W,A0L,A1L)(SAMPLENUMB,SAMPLE_STRUCT,DEST_PTR)
		;the magic routine of SYMPHONIE-32
		;5.0:	VOLUME [0-100%]
		;5.1:   SAMPLELEN can be upto 4MEGABYTE !!! (-> % CALC)

		;6.0:   New DSP Routines implemented
		;6.1:   KeyOn Fade
		;7.0	Now is Addsample
		;7.1	V/P Slide, CONT_SAMPLE Fade
		;7.2	STOP_SAMPLE Fade

	tst.w	SAMPLE_RETRIGNUMB(a0)
	beq.s	CopySample_NoRetrig
	subq.w	#1,SAMPLE_RETRIGCOUNT(a0)
	bne.s	CopySample_NoRetrig
	subq.w	#1,SAMPLE_RETRIGNUMB(a0)
	beq.s	CopySample_NoRetrig	;LAST PASSED
CopySampleRetrig
	move.w	SAMPLE_RETRIGCYCL(a0),SAMPLE_RETRIGCOUNT(a0)
	move.l	SAMPLE_RETRIGPTR(a0),SAMPLE_PTR(a0)
	move.l	SAMPLE_RETRIGPTR(a0),retrigtest
	move.b	#FALSE,SAMPLE_ENDREACHED(a0)
	move.w	#SAMPLEST_INUSE,SAMPLE_STATUS(a0)
	clr.b	SAMPLE_DECLICK(a0)
	clr.l	SAMPLE_HIOFFSET(a0)
CopySample_NoRetrig
	cmpi.b	#TRUE,SAMPLE_ENDREACHED(a0)
	bne.s	CopySample_DoDo
	rts

CopySample_DoDo	
	BGN
	bsr	ProcessMuteDSP
	move.w	d0,d7				;COPY THE STUFFS
	subq.w	#1,d7
	cmpi.w	#SAMPLEST_PENDING,SAMPLE_STATUS(a0)
	bne.s	CopySample_Do
	tst.b	SAMPLE_FADEOUT(a0)
	beq.s	.exit

	clr.b	SAMPLE_FADEOUT(a0)
	move.w	SAMPLE_LASTSAMPLE(a0),d0
	beq.s	.exit
	clr.w	SAMPLE_LASTSAMPLE(a0)


	IFNE	SPECIAL
	tst.b	Declicking
	beq.s	.exit
	ENDC
	move.w	FADEOUTSTEPS,d6
	cmp.w	d0,d6
	blo.s	.ok
	move.w	d0,d6
.ok	move.w	d6,d4
	move.w	d4,d7
	subq.w	#1,d7
.loop
	move.w	d0,d5
	muls	d4,d5
	divs	d6,d5
	subq.w	#1,d4
	add.w	d5,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	dbf	d7,.loop
.exit	RET

	acode
CopySample_Do
	IFNE	TESTPRGB
;	bsr	DoSampleRTPre
	ENDC
	move.l	SAMPLE_PTR(a0),a2
	move.l	SAMPLE_INSTRUMENTPTR(a0),a6
	cmp.l	#0,a6
	beq	CopySample_X

	move.l	a2,INSTR_SAMPLEPOS(a6)
	move.l	SAMPLE_HIOFFSET(a0),d1
	move.l	SAMPLE_FREQUENZ(a0),d2
	move.l	SAMPLE_ENDPTR(a0),d6			;D6 END OF SAMPLE


	moveq	#0,d3
	move.w	SAMPLE_VOLUME(a0),d3

	tst.b	SAMPLE_VFADE(a0)
	bne.w	CopySample_VFade

	tst.w	SAMPLE_VOLSLIDE(a0)			;Volumeslide
	beq.s	CopySample_NOVOLSLIDE

	add.w	SAMPLE_VOLSLIDE(a0),d3		;#
	bmi.s	CopySample_SETMINVOL		;#

	cmpi.w	#(VOLUME_MAX+1)*256,d3
	blo.s	CopySample_NEWVOL

	move.w	#VOLUME_MAX*$100,d3
	clr.w	SAMPLE_VOLSLIDE(a0)
	bra.s	CopySample_NEWVOL
CopySample_SETMINVOL
	moveq	#0,d3			;#
	move.w	d3,SAMPLE_VOLSLIDE(a0)	;# clr.w
CopySample_NEWVOL
	move.w	d3,SAMPLE_VOLUME(a0)
CopySample_NOVOLSLIDE

VFade_IN

	tst.w	SAMPLE_VIBDEPTH(a0)
	bne.w	CopySample_DoVibrato
Vibrato_IN

						;D3 WORDVOLUME LFO PROCESS
	lsr.w	#8,d3


	tst.w	SAMPLE_PITCHSLIDE(a0)			;Pitchslide
	beq.s	CopySample_NOPITCHSLIDE
	puts	d3
	move.l	d2,d3
	lsr.l	#8,d3
	move.w	SAMPLE_PITCHSLIDE(a0),d0
	ext.l	d0
	muls.l	d3,d0
	asr.l	#PITCHSLIDE_LN,d0
	sub.l	d0,d2
	gets	d3
CopySample_NOPITCHSLIDE

	tst.l	SAMPLE_DESTFREQUENZ(a0)
	beq.s	CopySample_NOPSLIDETO

	puts	d6-d7

	move.l	SAMPLE_DESTFREQUENZ(a0),d7
	sub.l	d2,d7
	bne.s	CopySample_PSLIDETO
	clr.l	SAMPLE_DESTFREQUENZ(a0)
CopySample_PSLIDETO

	moveq	#0,d6
	move.w	SAMPLE_PSLIDETOSPD(a0),d6

	addq.l	#1,d7
	divs.l	d6,d7

;;;		asr.l	d6,d7


	add.l	d7,d2
	gets	d6-d7

CopySample_NOPSLIDETO
	move.l	d2,SAMPLE_FREQUENZ(a0)			;PITCH SLIDE (IF)

	tst.w	SAMPLE_TREMDEPTH(a0)
	bne.w	CopySample_DoTremolo
Tremolo_IN

	tst.w	SAMPLE_SAVIBDEPTH(a0)
	bne.w	CopySample_DoSampleVib
SampleVib_IN

	move.l	a2,a4

	;D3 IS NOW BYTE

	cmpi.b	#VOLUME_COMMAND,d3
	bhi.w	CopySample_ERR

	bsr	ProcessCV
	;D3 IS NOW SIGN BYTE !!!

	move.b	d3,SAMPLE_ENDVOL(a0)

	subq.l	#2,d6					;CORRECT END OF SAMPLE -1

	;tst.b	RenderHQ
	;bne.w	CopySampleHQ


	tst.w	d3
	beq	CopySampleZero
	cmpi.b	#VOLUME_MAX,d3
	bgt.s	CopySampleSlow
	cmpi.b	#-VOLUME_MAX,d3
	blt.s	CopySampleSlow
	cmp.b	VL_PROCVLIMIT+1,d3
	bgt.w	CopySampleMV

CopySampleSlow			;SLOW ROUTINE
	tst.b	FASTPOSSIBLE
	beq.s	.nofast

	move.l	SAMPLE_INSTRUMENTPTR(a0),a6
	btst	#SPLAYFLAG_SUPERFAST,INSTR_PLAYFLAG(a6)
	bne	CopySampleSlowSF

.nofast
	moveq	#0,d4
	move.b	d3,d4
	ext.w	d4
	muls	#256,d4
	divs	#100,d4

	moveq	#0,d0

	move.l	#CopySample_L,SampleRun

	tst.b	SAMPLE_DECLICK(a0)			;FADESAMPLE
	beq.s	CopySample_L
	clr.b	SAMPLE_DECLICK(a0)

	move.w	SAMPLE_LASTSAMPLE(a0),d3

	IFNE	SPECIAL
	tst.b	Declicking
	beq.s	CopySample_L
	ENDC


	cmp.w	FADETOSTEPS(PC),d7
	blo.s	CopySample_L

	sub.w	FADETOSTEPS(PC),d7				;Fade 
	puts	d7
	move.w	FADETOSTEPSm(PC),d7
	swap	d7
	move.w	d4,d7
	swap	d7
	moveq	#1,d4
	swap	d4
	move.w	FADETOSTEPS(PC),d4
CopySample_FadeL
	move.w	d3,d5
	muls	d4,d5
	divs	FADETOSTEPS(PC),d5
	subq.w	#1,d4
	move.w	(a4),d0				;D0b=SAMPLEBYTE
	swap	d7
	muls	d7,d0
	asr.l	#8,d0
	swap	d7
	swap	d4
	muls	d4,d0
	divs	FADETOSTEPS(PC),d0
	addq.w	#1,d4
	swap	d4
	add.w	d5,d0
	swap	d1
	lea.l	(a2,d1.w*2),a4	;New Pos
	swap	d1
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6
	dbls	d7,CopySample_FadeL
	swap	d7
	move.w	d7,d4
	gets	d7
	cmp.l	a4,d6
	bls.s	CopySample_M1

CopySample_L	

	move.w	(a4),d0			;D0b=SAMPLEBYTE
	swap	d1
	lea.l	(a2,d1.w*2),a4	;New Pos
	swap	d1

	muls	d4,d0
	asr.l	#8,d0

CopySample_L_IN
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6
	dbls	d7,CopySample_L				;16 BIT PRO
CopySample_M1
	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2

	move.w	d0,SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)

	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	
CopySample_X	
	IFNE	TESTPRGB
	;bsr	DoSampleRTPost
	ENDC
	RET


SampleRun	dc.l	CopySample_L

	acode
CopySample_dL
	move.l	SampleRun(PC),a6
	jmp	(a6)

	acode
CopySample_WASLAST
	cmpi.w	#INSTRTYPE_NONE,SAMPLE_INSTRUMENTTYPE(a0)
	beq.s	CopySample_WASLAST2
	cmpi.w	#INSTRTYPE_SUST,SAMPLE_INSTRUMENTTYPE(a0)
	beq.s	CopySample_Sustained

	move.l	SAMPLE_LOOPSTARTPTR(a0),a2
	move.l	SAMPLE_LOOPENDPTR(a0),d6
	move.l	a2,SAMPLE_PTR(a0)
	move.l	d6,SAMPLE_ENDPTR(a0)

	move.l	a2,a4
	subq.l	#2,d6				;CORRECT SAMPLE END
		
	subq.w	#1,d7
	bmi.s	CopySample_X
	moveq	#0,d1
	bra.s	CopySample_dL


	acode
CopySample_Sustained
	tst.w	SAMPLE_LOOPNUMB(a0)
	bmi.s	CopySample_WASLAST2
	subq.w	#1,SAMPLE_LOOPNUMB(a0)
	bmi.s	CopySample_DoSustain
	move.l	SAMPLE_LOOPSTARTPTR(a0),a2
	move.l	SAMPLE_LOOPENDPTR(a0),d6
	move.l	a2,SAMPLE_PTR(a0)
	move.l	d6,SAMPLE_ENDPTR(a0)

	subq.l	#2,d6
	move.l	a2,a4

	subq.w	#1,d7
	bmi.s	CopySample_X
	moveq	#0,d1
	bra.s	CopySample_dL

	acode
CopySample_DoSustain

	move.l	SAMPLE_SUSTSTARTPTR(a0),a2
	move.l	SAMPLE_SUSTENDPTR(a0),d6
	move.l	a2,SAMPLE_PTR(a0)
	move.l	d6,SAMPLE_ENDPTR(a0)

	subq.l	#2,d6
	move.l	a2,a4

	subq.w	#1,d7
	bmi	CopySample_X
	moveq	#0,d1
	bra	CopySample_dL

	acode
CopySample_ERR
	jsr	WarnFlash
CopySample_WASLAST2
	clr.b	SAMPLE_DECLICK(a0)	     ;NO FADESAMPLE
	move.w	#SAMPLEST_PENDING,SAMPLE_STATUS(a0)
	move.b	#TRUE,SAMPLE_ENDREACHED(a0)
	move.l	SAMPLE_INSTRUMENTPTR(a0),a6
	clr.l	INSTR_SAMPLEPOS(a6)
	bra	CopySample_X

	acode
ProcessCV
	puts	d4-d7
	move.w	SAMPLE_CVOLADD(a0),d4
	move.w	SAMPLE_CVOL(a0),d5
	move.w	d5,d6
	add.w	d4,d5

	tst.w	SAMPLE_CVTYPE(a0)
	bne.s	ProcessCV_Complex

	cmpi.w	#-100*256,d5
	blt.s	ProcessCV_Out
	cmpi.w	#100*256,d5
	bgt.s	ProcessCV_Out
	move.w	d5,SAMPLE_CVOL(a0)
ProcessCV_Out
	move.w	SAMPLE_CVOL(a0),d4
	cmpi.w	#100*256,d4
	bgt.s	ProcessCV_Fast
	ext.w	d3
	muls	d4,d3
	divs	#100*256,d3
	andi.w	#$00ff,d3
ProcessCV_Fast
	gets	d4-d7
	rts

	acode
ProcessCV_Complex
	move.w	SAMPLE_DESTVOL(a0),d7
	sub.w	d6,d7
	bpl.s	ProcessCV_C2

	move.w	SAMPLE_DESTVOL(a0),d6
	sub.w	d5,d6
	bmi.s	ProcessCV_Out
	bra.s	ProcessCV_Reach

ProcessCV_C2
	move.w	SAMPLE_DESTVOL(a0),d6
	sub.w	d5,d6
	bpl.s	ProcessCV_Out

ProcessCV_Reach
	clr.w	SAMPLE_CVTYPE(a0)
	clr.w	SAMPLE_CVOLADD(a0)
	move.w	SAMPLE_DESTVOL(a0),SAMPLE_CVOL(a0)
	bra.s	ProcessCV_Out

	acode
CopySampleMV
	;D3 IS NOW BYTE
	cmpi.b	#VOLUME_COMMAND,d3
	bhi.w	CopySample_ERR

	tst.b	FASTPOSSIBLE
	beq.s	.nofast

	move.l	SAMPLE_INSTRUMENTPTR(a0),a6
	btst	#SPLAYFLAG_SUPERFAST,INSTR_PLAYFLAG(a6)
	bne	CopySampleSF


.nofast	move.l	#CopySampleMV_L,SampleRun

	moveq	#0,d0
	tst.b	SAMPLE_DECLICK(a0)			;FADESAMPLE
	beq.s	CopySampleMV_L

	clr.b	SAMPLE_DECLICK(a0)
	move.w	SAMPLE_LASTSAMPLE(a0),d3

	IFNE	SPECIAL
	tst.b	Declicking
	beq.s	CopySampleMV_L
	ENDC

	cmp.w	FADETOSTEPS(PC),d7
	blo.s	CopySampleMV_L
	moveq	#1,d4
	swap	d4
	move.w	FADETOSTEPS(PC),d4
	sub.w	FADETOSTEPS(PC),d7

	puts	d7
	move.w	FADETOSTEPSm(PC),d7

.FadeL
	move.w	d3,d5
	muls	d4,d5
	divs	FADETOSTEPS(PC),d5
	subq.w	#1,d4

	move.w	(a4),d0				;D0b=SAMPLEBYTE

	swap	d4
	muls	d4,d0
	divs	FADETOSTEPS(PC),d0
	addq.w	#1,d4
	swap	d4
	add.w	d5,d0

	swap	d1
	lea.l	(a2,d1.w*2),a4	;New Pos
	swap	d1
	add.l	d2,d1			;D2=NEWHIOFFSET

	add.w	d0,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6

	dbls	d7,.FadeL
	gets	d7
	cmp.l	a4,d6
	bls.s	CopySampleMV_M1	

CopySampleMV_L	
	move.w	(a4),d0			;D0b=SAMPLEBYTE
	swap	d1
	lea.l	(a2,d1.w*2),a4	;New Pos
	swap	d1
	add.l	d2,d1			;D2=NEWHIOFFSET

	add.w	d0,(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6

	dbls	d7,CopySampleMV_L
CopySampleMV_M1
	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2

	move.w	d0,SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)

	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	

	;tst.w	d7
	;bpl.w	CopySample_WASLAST
	RET

	acode

CopySampleSlowSF
	clr.l	CopySampleSF_OFFSET
	cmpi.w	#MULTISAMPLE_STEREOL,INSTR_MULTI(a6)
	bne.s	.nostereo

	move.l	(INSTR_SAMPLEPTR+INSTR_SIZEOF)(a6),d0
	sub.l	INSTR_SAMPLEPTR(a6),d0
	move.l	d0,CopySampleSF_OFFSET
.nostereo

	moveq	#0,d4
	move.b	d3,d4
	ext.w	d4
	muls	#256,d4
	divs	#100,d4


	moveq	#0,d0

	move.l	#CopySampleSlowSF_L,SampleRun

	tst.b	SAMPLE_DECLICK(a0)			;FADESAMPLE
	beq.s	CopySampleSlowSF_go
	clr.b	SAMPLE_DECLICK(a0)

	move.w	SAMPLE_LASTSAMPLE(a0),d3

	IFNE	SPECIAL
	tst.b	Declicking
	beq.s	CopySampleSlowSF_go
	ENDC

	cmp.w	FADETOSTEPS(PC),d7
	blo.s	CopySampleSlowSF_go

	sub.w	FADETOSTEPS(PC),d7				;Fade 
	puts	d7
	move.w	FADETOSTEPSm(PC),d7
	swap	d7
	move.w	d4,d7
	swap	d7
	moveq	#1,d4
	swap	d4
	move.w	FADETOSTEPS(PC),d4

CopySampleSlowSFFade_L
	move.w	d3,d5
	muls	d4,d5
	divs	FADETOSTEPS(PC),d5
	subq.w	#1,d4
	move.w	(a4),d0				;D0b=SAMPLEBYTE
	swap	d7
	muls	d7,d0
	asr.l	#8,d0
	swap	d7
	swap	d4
	muls	d4,d0
	divs	FADETOSTEPS(PC),d0
	addq.w	#1,d4
	swap	d4
	add.w	d5,d0
	swap	d1
	lea.l	(a2,d1.w*2),a4	;New Pos
	swap	d1
	add.l	d2,d1			;D2=NEWHIOFFSET

	add.w	d0,(a1)
	add.w	d0,2(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6
	dbls	d7,CopySampleSlowSFFade_L
	swap	d7
	move.w	d7,d4
	gets	d7
	cmp.l	a4,d6
	bls.s	CopySampleSlowSF_M1

CopySampleSlowSF_go
	move.l	CopySampleSF_OFFSET,d5
	tst.l	d5
	beq.s	CopySampleSlowSFmono_go
CopySampleSlowSF_L
	move.w	(a4),d0			;D0b=SAMPLEBYTE
	move.w	(a4,d5.l),d3
	swap	d1
	lea.l	(a2,d1.w*2),a4	;New Pos
	swap	d1

	muls	d4,d0
	asr.l	#8,d0
	muls	d4,d3
	asr.l	#8,d3

CopySampleSlowSF_L_IN
	add.w	d0,(a1)+
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d3,(a1)+
	cmp.l	a4,d6
	dbls	d7,CopySampleSlowSF_L
CopySampleSlowSF_M1
	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2

	move.w	d0,SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)

	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	
CopySampleSlowSF_X	RET


	acode
CopySampleSlowSFmono_go
	move.l	#CopySampleSlowSFmono_L,SampleRun
CopySampleSlowSFmono_L

	move.w	(a4),d0			;D0b=SAMPLEBYTE
	swap	d1
	lea.l	(a2,d1.w*2),a4	;New Pos
	swap	d1

	muls	d4,d0
	asr.l	#8,d0
	add.w	d0,(a1)+
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)+
	cmp.l	a4,d6
	dbls	d7,CopySampleSlowSFmono_L

	move.w	d0,SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)

	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	
CopySampleSlowSFmono_X	RET

	acode
CopySampleSF	;SUPERFAST
	;D3 IS NOW BYTE
	cmpi.b	#VOLUME_COMMAND,d3
	bhi.w	CopySample_ERR

	clr.l	CopySampleSF_OFFSET
	cmpi.w	#MULTISAMPLE_STEREOL,INSTR_MULTI(a6)
	bne.s	.nostereo

	move.l	(INSTR_SAMPLEPTR+INSTR_SIZEOF)(a6),d0
	sub.l	INSTR_SAMPLEPTR(a6),d0
	move.l	d0,CopySampleSF_OFFSET

.nostereo
	move.l	#CopySampleSF_L,SampleRun
	moveq	#0,d0
	tst.b	SAMPLE_DECLICK(a0)			;FADESAMPLE
	beq.s	CopySampleSF_go

	clr.b	SAMPLE_DECLICK(a0)
	move.w	SAMPLE_LASTSAMPLE(a0),d3


	IFNE	SPECIAL
	tst.b	Declicking
	beq.s	CopySampleSF_go
	ENDC

	cmp.w	FADETOSTEPS(PC),d7
	beq.s	CopySampleSF_go
	moveq	#1,d4
	swap	d4
	move.w	FADETOSTEPS(PC),d4
	sub.w	FADETOSTEPS(PC),d7

	puts	d7
	move.w	FADETOSTEPSm(PC),d7

.FadeL
	move.w	d3,d5
	muls	d4,d5
	divs	FADETOSTEPS(PC),d5
	subq.w	#1,d4

	move.w	(a4),d0				;D0b=SAMPLEBYTE

	swap	d4
	muls	d4,d0
	divs	FADETOSTEPS(PC),d0
	addq.w	#1,d4
	swap	d4
	add.w	d5,d0

	swap	d1
	lea.l	(a2,d1.w*2),a4	;New Pos
	swap	d1
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)
	add.w	d0,2(a1)
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6

	dbls	d7,.FadeL
	gets	d7
	cmp.l	a4,d6
	bls.s	CopySampleSF_M1	

CopySampleSF_go
	move.l	CopySampleSF_OFFSET,d5
	tst.l	d5
	beq.s	CopySampleSFmono_go
CopySampleSF_L	
	move.w	(a4),d0			;D0b=SAMPLEBYTE
	swap	d1
	move.w	(a4,d5.l),d3
	lea.l	(a2,d1.w*2),a4	;New Pos
	swap	d1
	add.w	d0,(a1)+
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d3,(a1)+
	cmp.l	a4,d6
	dbls	d7,CopySampleSF_L

CopySampleSF_M1
	move.l	CopySampleSF_OFFSET,d5

	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2
	move.w	d0,SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)
	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	
	RET


	acode
CopySampleSFmono_go
	move.l	#CopySampleSFmono_L,SampleRun
CopySampleSFmono_L	
	move.w	(a4),d0			;D0b=SAMPLEBYTE
	swap	d1
	lea.l	(a2,d1.w*2),a4	;New Pos
	swap	d1
	add.w	d0,(a1)+
	add.l	d2,d1			;D2=NEWHIOFFSET
	add.w	d0,(a1)+
	cmp.l	a4,d6
	dbls	d7,CopySampleSFmono_L
	move.l	CopySampleSF_OFFSET,d5
	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2

	move.w	d0,SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)
	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	
	RET

	acode
CopySampleZero
	move.l	#CopySampleZero_L,SampleRun
CopySampleZero_L	
	swap	d1
	lea.l	(a2,d1.w*2),a4	;New Pos
	swap	d1
	add.l	d2,d1			;D2=NEWHIOFFSET
	lea.l	COPYSMPLEN*2(a1),a1
	cmp.l	a4,d6
	dbls	d7,CopySampleZero_L
	cmpi.l	#MAXPROCFREQ,d1
	bhs	CopySample_WASLAST2
	clr.w	SAMPLE_LASTSAMPLE(a0)		;FADESAMPLE
	move.l	a4,SAMPLE_PTR(a0)
	andi.l	#$ffff,d1
	move.l	d1,SAMPLE_HIOFFSET(a0)
	cmp.l	a4,d6
	bls.w	CopySample_WASLAST	
	RET


	ENDC


	acode
InitVolumeList	;V1.0
	IFEQ	SYMPHPRO
	BGN
	move.l	VolumeList_PTR,a1
	lea.l	VOLUMELIST_FIRSTTAB(a1),a0
	lea.l	VOLUMELIST_POINTERS(a1),a2

	moveq	#VolumeTabNum-1,d6
InitVolumeList_L2
	moveq	#VolumeStep-1,d7
InitVolumeList_L
	move.l	a0,(a2)+
	dbf	d7,InitVolumeList_L
	lea.l	VOLUMELIST_TABLEN*2(a0),a0
	dbf	d6,InitVolumeList_L2
	lea.l	-VOLUMELIST_TABLEN*2(a0),a0
	move.l	a0,(a2)+
	
	lea.l	VOLUMELIST_FIRSTTAB(a1),a1

	moveq	#0,d1
	moveq	#VolumeTabNum-1,d6

;;	move.w	VL_NOISELIMIT(PC),d3


InitVolumeList_L4
	moveq	#0,d0
	move.w	#VOLUMELIST_TABLEN-1,d7

	mulu	SYSTEM_VOLUME(PC),d1
	lsr.l	#8,d1

InitVolumeList_L3
	moveq	#0,d2
	;;cmp.w	d3,d1
	;;bls.s	InitVLNoiseLimit
	move.b	d0,d2
	ext.w	d2
	muls	d1,d2
	divs	#100,d2
InitVLNoiseLimit
	move.w	d2,(a1)+
	addq.b	#1,d0
	dbf	d7,InitVolumeList_L3
	addi.w	#VolumeStep,d1
	dbf	d6,InitVolumeList_L4
	RET
	ENDC
	rts	

;	acode
;WaitAudioDMA	;V1.0 #UNUSED
;	BGN
;	move.w	#$100,d2
;	lea.l	$dff004,a0
;	move.l	(a0),d1
;	and.w	d2,d1
;.loop	move.l	(a0),d0
;	and.w	d2,d0
;	cmp.w	d1,d0
;	beq.s	.loop
;	RET
	
	acode
StopVoices	;V1.0
	bra	AudioDMAOff

	acode
StartVoices	;V2.0
		;1 VOICE CHECKING ONLY !!
	BGN
	move.w	#FALSE,AudioIRQ_STATUS
	lea.l	Test_VOICEEXPANDER(PC),a5
	move.l	VOICEEXP_BUFFERBASE(a5),a4
	move.w	VOICEEXP_BUFFERPERAUDIO(a5),d0
	subq.w	#2,d0					;SAMPLE DELAY
	cmp.w	BUFFER_COUNT(a4),d0
	bne.s	StartVoices_X

	IFNE DIRECTAMIGAAUDIO
	lea.l	CUSTOMBASE,a5
	jsr	AudioDMAOn
	ENDC
StartVoices_X	RET


;	acode
;SetAudioVolume	;V1.0	obsolete
;		;I(D0W)(VOLUME[0-64])
;	BGN
;	lea.l	Test_VOICEEXPANDER(PC),a3
;	move.l	VOICEEXP_BUFFERBASE(a3),a4
;	move.w	VOICEEXP_BUFFEROFFSET(a3),d4
;	move.w	VOICEEXP_AUDIONUMB(a3),d7
;	subq.w	#1,d7
;SetAudioVolume_L	move.w	BUFFER_DESTCUSTOMREG(a4),d1
;		lea.l	CUSTOMBASE,a5
;		lea.l	(a5,d1.w),a5
;		move.w	d0,ac_vol(a5)
;		lea.l	(a4,d4.w),a4
;	dbf	d7,SetAudioVolume_L
;	RET

	acode
SetAudioPeriod
	BGN
	lea.l	Test_VOICEEXPANDER(PC),a3
	move.l	VOICEEXP_BUFFERBASE(a3),a4
	move.w	VOICEEXP_BUFFEROFFSET(a3),d4
	move.w	VOICEEXP_AUDIONUMB(a3),d7

	move.w	BUFFER_DESTCUSTOMREG(a4),d1
	IFNE DIRECTAMIGAAUDIO
	lea.l	CUSTOMBASE,a5
	lea.l	(a5,d1.w),a5
	ENDC
	
	moveq	#0,d0
	move.w	BUFFER_SAMPLEPERIOD(a4),d0
	move.w	MTune,d1
	addi.w	#50,d1
	mulu	d1,d0
	divu	#100,d0
	IFNE DIRECTAMIGAAUDIO
	move.w	d0,ac_per(a5)
	move.w	d0,ac_per+16(a5)
	move.w	d0,ac_per+32(a5)
	move.w	d0,ac_per+48(a5)
	ENDC
	move.w	d0,StreamPeriod
	RET
MTune	dc.w	50

	acode
SetAudioRegisters	;V1.2
	BGN
	lea.l	Test_VOICEEXPANDER(PC),a3
	move.l	VOICEEXP_BUFFERBASE(a3),a4
	move.w	VOICEEXP_BUFFEROFFSET(a3),d4
	move.w	VOICEEXP_AUDIONUMB(a3),d7
	subq.w	#1,d7
.loop
	move.w	BUFFER_DESTCUSTOMREG(a4),d1
	IFNE DIRECTAMIGAAUDIO
	lea.l	CUSTOMBASE,a5
	lea.l	(a5,d1.w),a5
	move.w	BUFFER_SAMPLEPERIOD(a4),ac_per(a5)
	move.w	BUFFER_VOLUME(a4),ac_vol(a5)
	ENDC
	move.w	BUFFER_SAMPLEPERIOD(a4),StreamPeriod
	move.w	BUFFER_TOTALSAMPLELEN(a4),d0

	IFNE OS3
	andi.l	#$0000ffff,d0
	divu.l	OverSample3,d0
	ENDC

	lsr.w	#1,d0				;LEN[BYTES] -> TO WORD
	lsr.w	#1,d0				;NEWBUFSYNC (First Halve only)

	IFNE DIRECTAMIGAAUDIO
	move.w	d0,ac_len(a5)
	ENDC
	
	move.l	BUFFER_RESET(a4),(a5)
	lea.l	(a4,d4.w),a4
	dbf	d7,.loop
	bsr	SetAudioPeriod
	jsr	AdjustAudioRegs
	clr.w	BufferSyncFlag
	IFNE DIRECTAMIGAAUDIO
	lea.l	SetBufferA(PC),a5
	move.l	a5,BufferSet
	lea.l	SetBufferB(PC),a5
	move.l	a5,BufferSet+4
	ENDC
	RET

	acode
CheckQJMsg
	tst.l	CheckQJMsg_JMP
	bne.s	.do
	rts
.do	puts	a0
	move.l	CheckQJMsg_JMP(PC),a0
	jsr	(a0)
	clr.l	CheckQJMsg_JMP
	gets	a0
	rts

	acode	
JumpSetBuffer
	puts	a0
	move.l	BufferSet,a0
	jsr	(a0)
	gets	a0
	rts

	IFNE DIRECTAMIGAAUDIO
	acode
SetBufferA
	puts	d0/d1/d4/d7/a2-a5
	lea.l	Test_VOICEEXPANDER(PC),a3
	move.l	VOICEEXP_BUFFERBASE(a3),a4
	move.w	VOICEEXP_BUFFEROFFSET(a3),d4
	move.w	VOICEEXP_AUDIONUMB(a3),d7
	subq.w	#1,d7
.loop		move.w	BUFFER_DESTCUSTOMREG(a4),d1
	lea.l	CUSTOMBASE,a5
	lea.l	(a5,d1.w),a5
	move.w	BUFFER_TOTALSAMPLELEN(a4),d0
	IFNE OS3
	andi.l	#$0000ffff,d0
	divu.l	OverSample3,d0
	ENDC

	lsr.w	#1,d0				;LEN[BYTES] -> TO WORD
	lsr.w	#1,d0				;NEWBUFSYNC (First Halve only)
	move.w	d0,ac_len(a5)
	move.l	BUFFER_RESET(a4),(a5)		;SET AUDIO DATA PTR
	lea.l	(a4,d4.w),a4
	dbf	d7,.loop
	clr.w	BufferSyncFlag
	gets	d0/d1/d4/d7/a2-a5
	rts

	acode
SetBufferB
	puts	d0/d1/d4/d7/a2-a5
	lea.l	Test_VOICEEXPANDER(PC),a3
	move.l	VOICEEXP_BUFFERBASE(a3),a4
	move.w	VOICEEXP_BUFFEROFFSET(a3),d4
	move.w	VOICEEXP_AUDIONUMB(a3),d7
	subq.w	#1,d7
.loop		move.w	BUFFER_DESTCUSTOMREG(a4),d1
	lea.l	CUSTOMBASE,a5
	lea.l	(a5,d1.w),a5
	move.w	BUFFER_TOTALSAMPLELEN(a4),d0
	IFNE OS3
	andi.l	#$0000ffff,d0
	divu.l	OverSample3,d0
	ENDC

	lsr.w	#1,d0				;LEN[BYTES] -> TO WORD
	lsr.w	#1,d0				;NEWBUFSYNC (First Halve only)
	move.w	d0,ac_len(a5)

	move.l	BUFFER_RESET(a4),a2
	lea.l	(a2,d0.w*2),a2

	move.l	a2,(a5)		;SET AUDIO DATA PTR
	lea.l	(a4,d4.w),a4
	dbf	d7,.loop
	move.w	#-1,BufferSyncFlag	
	gets	d0/d1/d4/d7/a2-a5
	rts
	ENDC


	acode
SwapSyncBuffer	
	puts	d0
	move.l	BufferSet,d0
	move.l	BufferSet+4,BufferSet
	move.l	d0,BufferSet+4
	gets	d0
	rts

	acode
PlayNoteGetInstr	;I(A2L)(ACTUAL_NOTE
			;O(A1L)(ACTUAL_INSTR)
	puts	d0-d1
	moveq	#0,d0
	move.b	NOTE_INSTR(a2),d0
	lea.l	Test_INSTRMAN,a1
	moveq	#0,d1
	move.w	INSTRMAN_ENTRYSIZE(a1),d1
	mulu.l	d1,d0

	move.l	INSTRMAN_FIRST(a1),a1
	move.l	(a1,d0.l),a1		;A1 INSTRUMENT
	gets	d0-d1
	rts

	acode
PlayNoteGetSample
		;I(D0W)(CHANNEL#)
		;O(A0L)(ACTUAL SAMPLE)
	puts	d1
	lea.l	Test_VOICEEXPANDER(PC),a5
	mulu	VOICEEXP_SAMPLESTRUCTSIZE(a5),d1
	move.l	VOICEEXP_FIRSTSAMPLEPTR(a5),a0
	lea.l	(a0,d1.w),a0		;A0L SAMPLE
	gets	d1
	rts

	acode
PlayNoteInstr	;V1,0
		;I(A0L,A1L,A2L,,A4L,A5L)(SAMPLE,INSTRUMENT,NOTE,,PATTERN,SONG)
		;WARN: some register trashing going on !

	jsr	ClearInstrSaPos
	puts	d1
	move.w	INSTR_TYPE(a1),d1
	bmi.w	PlayNoteInstr_Simple		;SILENTed or KILLed ->

	move.l	a1,SAMPLE_INSTRUMENTPTR(a0)
	move.w	d1,SAMPLE_INSTRUMENTTYPE(a0)
	move.l	INSTR_SAMPLEPTR(a1),d0

	move.l	d0,SAMPLE_PTR(a0)
	move.l	d0,SAMPLE_STARTPTR(a0)
	add.l	INSTR_NUMBSAMPLES(a1),d0
	move.l	d0,SAMPLE_ENDPTR(a0)
	move.b	#FALSE,SAMPLE_ENDREACHED(a0)
	clr.b	SAMPLE_DECLICK(a0)
	cmpi.w	#SAMPLEST_INUSE,SAMPLE_STATUS(a0)
	bne.s	PlayNoteInstr_FadeOff
		move.b	#-1,SAMPLE_DECLICK(a0)
PlayNoteInstr_FadeOff

	clr.l	SAMPLE_HIOFFSET(a0)
	cmpi.w	#INSTRTYPE_NONE,d1						;SIMPLE ->
	beq.s	PlayNoteInstr_Simple

	cmpi.w	#INSTRTYPE_SUST,d1
	bhi.s	PlayNoteInstr_Simple

	move.l	INSTR_SAMPLELOOPSTART(a1),SAMPLE_LOOPSTARTPTR(a0)	;LOOP or SUST
	move.l	INSTR_SAMPLELOOPENDPTR(a1),SAMPLE_LOOPENDPTR(a0)
		;move.l	SAMPLE_LOOPENDPTR(a0),SAMPLE_ENDPTR(a0)	;ERROR FIXED (caused clicks in fadeto)
	cmpi.w	#INSTRTYPE_SUST,d1
	bne.s	PlayNoteInstr_Simple
	move.l	INSTR_SAMPLESUSTSTART(a1),SAMPLE_SUSTSTARTPTR(a0)	;SUST
	move.l	INSTR_SAMPLESUSTENDPTR(a1),SAMPLE_SUSTENDPTR(a0)
	move.w	INSTR_LOOPNUMB(a1),SAMPLE_LOOPNUMB(a0)
PlayNoteInstr_Simple
	gets	d1
	rts

	acode
PlayNoteSavePitch


PlayNotePitch	;V1.0
		;I(A0L,A1L,A2L,,A4L,A5L)(SAMPLE,INSTRUMENT,NOTE,,PATTERN,SONG)
	BGN
	moveq	#0,d0
	move.b	NOTE_PITCH(a2),d0

	move.b	d0,SAMPLE_LASTNOTE+NOTE_PITCH(a0)

	add.w	INSTR_TUNE(a1),d0
	tst.w	PatternTune
	beq.s	PlayNotePitch_NoPosTune

	btst	#SPLAYFLAG_DODETUNE,INSTR_PLAYFLAG(a1)
	bne.s	PlayNotePitch_NoPosTune

	add.w	PatternTune(PC),d0	;SEQ TUNE

PlayNotePitch_NoPosTune

	bsr.w	GetNoteFreq

	moveq	#0,d5
	move.w	INSTR_FINETUNE(a1),d5
	beq.s	PlayNotePitch_NoFineTune
	bmi.s	PlayNotePitch_SubFineTune
	mulu.l	d0,d4:d5
	divu.l	#$800,d4:d5
	add.l	d5,d0
	bra.s	PlayNotePitch_NoFineTune

PlayNotePitch_SubFineTune
	neg.w	d5
	mulu.l	d0,d4:d5
	divu.l	#$800,d4:d5
	sub.l	d5,d0

PlayNotePitch_NoFineTune
	move.l	d0,SAMPLE_FREQUENZ(a0)

	RET

	acode
StartSample	;V3.2
		;I(D0L,D3B,A0L,A4L)(Frequenz,VOL,SAMPLE_PTR,INSTRUMENT)
		;3.1	Fadesample
		;3.2	SAMPLE_ENDREACHED
	tst.w	INSTR_TYPE(a4)
	bmi.w	StartSample_FASTX

	BGN

	moveq	#0,d5
	move.w	INSTR_FINETUNE(a4),d5
	beq.s	StartSample_NoFineTune
	bmi.s	StartSample_SubFineTune
	mulu.l	d0,d4:d5
	divu.l	#$800,d4:d5
	add.l	d5,d0
	bra.s	StartSample_NoFineTune

StartSample_SubFineTune
	neg.w	d5
	mulu.l	d0,d4:d5
	divu.l	#$800,d4:d5
	sub.l	d5,d0
StartSample_NoFineTune

	cmpi.b	#VOLUME_SETPITCH,d3
	beq.w	StartSampleSetFreqOnly

	cmpi.b	#VOLUME_PITCHUP,d3
	bhi.w	StartSampleSet_MM
	cmpi.b	#VOLUME_PITCHDOWN,d3
	bhs.w	StartSampleFreqFX

StartSampleSet_MM
	move.l	a4,SAMPLE_INSTRUMENTPTR(a0)
	move.w	INSTR_TYPE(a4),SAMPLE_INSTRUMENTTYPE(a0)

	tst.b	DOSAMPLEDIFF
	bne.w	StartSampleSet_DIFFSTART
	move.l	INSTR_SAMPLEPTR(a4),d4
	move.l	d4,SAMPLE_PTR(a0)
	move.l	d4,SAMPLE_RETRIGPTR(a0)
	move.l	d4,SAMPLE_STARTPTR(a0)
	add.l	INSTR_NUMBSAMPLES(a4),d4
	move.l	d4,SAMPLE_ENDPTR(a0)
BAK_DIFFSTART
	move.b	#FALSE,SAMPLE_ENDREACHED(a0)
	clr.b	SAMPLE_DECLICK(a0)				;FADESAMPLE
	cmpi.w	#SAMPLEST_INUSE,SAMPLE_STATUS(a0)
	bne.s	StartSampleSet_NoFade
	move.b	#-1,SAMPLE_DECLICK(a0)			;FADESAMPLE
StartSampleSet_NoFade

	tst.b	DOSAMPLEDIFF
	bne.w	StartSampleSet_DIFFPITCH

BAK_DIFFPITCH
	clr.w	SAMPLE_VOLSLIDE(a0)
	clr.w	SAMPLE_PITCHSLIDE(a0)
	clr.l	SAMPLE_HIOFFSET(a0)
	move.l	d0,SAMPLE_FREQUENZ(a0)
	lsl.w	#8,d3
	move.w	d3,SAMPLE_VOLUME(a0)
	move.w	#SAMPLEST_INUSE,SAMPLE_STATUS(a0)

	cmpi.w	#INSTRTYPE_NONE,INSTR_TYPE(a4)
	beq.s	StartSample_X

	cmpi.w	#INSTRTYPE_LOOP,INSTR_TYPE(a4)
	bne.s	StartSample_NOTLOOPED

	move.l	INSTR_SAMPLELOOPSTART(a4),SAMPLE_LOOPSTARTPTR(a0)
	move.l	INSTR_SAMPLELOOPENDPTR(a4),SAMPLE_LOOPENDPTR(a0)
	move.l	SAMPLE_LOOPENDPTR(a0),SAMPLE_ENDPTR(a0)	;BUG FIXED
	bra.s	StartSample_X

StartSample_NOTLOOPED

	cmpi.w	#INSTRTYPE_SUST,INSTR_TYPE(a4)
	bne.s	StartSample_X

	move.l	INSTR_SAMPLELOOPSTART(a4),SAMPLE_LOOPSTARTPTR(a0)
	move.l	INSTR_SAMPLELOOPENDPTR(a4),SAMPLE_LOOPENDPTR(a0)
	move.l	INSTR_SAMPLESUSTSTART(a4),SAMPLE_SUSTSTARTPTR(a0)
	move.l	INSTR_SAMPLESUSTENDPTR(a4),SAMPLE_SUSTENDPTR(a0)
	move.w	INSTR_LOOPNUMB(a4),SAMPLE_LOOPNUMB(a0)
	move.l	SAMPLE_LOOPENDPTR(a0),SAMPLE_ENDPTR(a0)	;BUG FIXED

StartSample_X	RET
StartSample_FASTX	rts

	acode
StartSampleSetFreqOnly
	clr.w	SAMPLE_PITCHSLIDE(a0)
	move.l	d0,SAMPLE_FREQUENZ(a0)
	bra.s	StartSample_X

StartSampleFreqFX
	cmpi.b	#VOLUME_PITCHUP,d3
	beq.s	StartSamplePitchUp
	cmpi.b	#VOLUME_PITCHDOWN,d3
	beq.s	StartSamplePitchDown
	moveq	#100,d3
	bra	StartSampleSet_MM

StartSamplePitchUp
	move.l	SAMPLE_FREQUENZ(a0),d0
	lsr.l	#PITCHFXSHIFT,d0
	add.l	d0,SAMPLE_FREQUENZ(a0)
	moveq	#100,d3
	bra	StartSampleSet_MM

StartSamplePitchDown
	move.l	SAMPLE_FREQUENZ(a0),d0
	lsr.l	#PITCHFXSHIFT,d0
	sub.l	d0,SAMPLE_FREQUENZ(a0)
	moveq	#100,d3
	bra	StartSampleSet_MM

	
StartSampleSet_DIFFSTART
	puts	d3

	move.l	SAMPLEDIFF,d3
	IFNE	SYMPHPRO
	add.l	d3,d3
	ENDC

	move.l	INSTR_SAMPLEPTR(a4),d4
	add.l	d3,d4
	move.l	d4,SAMPLE_PTR(a0)
	move.l	d4,SAMPLE_STARTPTR(a0)
	move.l	d4,SAMPLE_RETRIGPTR(a0)
	add.l	INSTR_NUMBSAMPLES(a4),d4
	sub.l	d3,d4
	bmi.s	BAK_DIFFSTARTERR
	move.l	d4,SAMPLE_ENDPTR(a0)
	gets	d3
	bra	BAK_DIFFSTART

BAK_DIFFSTARTERR
	move.l	INSTR_SAMPLEPTR(a4),d4
	move.l	d4,SAMPLE_PTR(a0)
	move.l	d4,SAMPLE_STARTPTR(a0)
	move.l	d4,SAMPLE_RETRIGPTR(a0)
	add.l	INSTR_NUMBSAMPLES(a4),d4
	move.l	d4,SAMPLE_ENDPTR(a0)
	gets	d3
	bra	BAK_DIFFSTART

	acode
StartSampleSet_DIFFPITCH	;V2.0
	tst.l	PITCHDIFF
	beq.w	BAK_DIFFPITCH

	puts	d2-d4
	move.l	PITCHDIFF,d4
	move.l	d0,d2
	moveq	#PITCHDIFFSHIFT,d3
	lsr.l	d3,d2
	mulu.l  d4,d2

	addq.b	#1,PITCHDIFF_COUNTER
	btst	#1,PITCHDIFF_COUNTER
	bne.s	.sub
	add.l	d2,d0
	bra.s	.exit
.sub
	sub.l	d2,d0
.exit
	gets	d2-d4
	bra	BAK_DIFFPITCH


	acode
QuitActualProject	;V1.1
	BGN
	IFEQ DEMO
	IFEQ TESTPRGB
	lea.l	Quit_CTXT(PC),a0
	jsr	MulitChoiceRequest
	tst.w	d0
	beq.s	.exit
	cmpi.w	#1,d0
	beq.s	.do
	jsr	SaveActualProjectAs
	ENDC
	ENDC
.do	jsr	MAINEXIT
.exit	RET


	acode
KillActualProject
	BGN
	lea.l	Kill_CTXT(PC),a0
	jsr	MulitChoiceRequest
	tst.w	d0
	beq.s	.exit
	cmpi.w	#1,d0
	beq.s	.do
	jsr	SaveActualProjectAs
.do	jsr	DoRestart
.exit	RET


	acode
SetCPatNumb
	IFEQ AMINETDEMO
	BGN
	move.l	#1024,d2
	moveq	#1,d1
	lea.l	VEX_PattNumb,a0
	lea.l	CustomPatternL_TXT(PC),a1
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit
	jsr	DoRestart
.exit	RET
	ENDC

	acode
SetCPatLen
	IFEQ AMINETDEMO
	BGN
	move.l	#1024,d2
	moveq	#1,d1
	lea.l	VEX_LinesPerPattern,a0
	lea.l	CustomPatternN_TXT(PC),a1
	jsr	ReqMinMaxLong
	tst.w	d0
	beq.s	.exit
	jsr	DoRestart
.exit	RET
	ENDC
	rts

	acode
BuildMainTitle
	BGN
	lea.l	MainScreen_TXT,a0
	move.l	ScreenTitle_PTR,a1
	move.l	a1,a2
	jsr	CopyString
	lea.l	Audio0,a0
	cmpi.l	#CopyBackStreamOS14Bit_Stereo,COPYBACK_JR
	beq.w	BuildMainTitle_Main
	lea.l	Audio2,a0
	cmpi.l	#CopyBackStream9Bit_Stereo,COPYBACK_JR
	beq.s	BuildMainTitle_Main
	lea.l	Audio3,a0
	cmpi.l	#CopyBackStream14Bit_Mono,COPYBACK_JR
	beq.s	BuildMainTitle_Main
	lea.l	Audio4,a0
	cmpi.l	#CopyBackStream14Bit_Surround,COPYBACK_JR
	beq.s	BuildMainTitle_Main
	lea.l	Audio5,a0
	cmpi.l	#CopyBackStream14Bit_Left,COPYBACK_JR
	beq.s	BuildMainTitle_Main
	lea.l	Audio6,a0
	cmpi.l	#CopyBackStream14Bit_Right,COPYBACK_JR
	beq.w	BuildMainTitle_Main
	lea.l	Audio8,a0
	cmpi.l	#CopyBackStreamOS9Bit_Stereo,COPYBACK_JR
	beq.w	BuildMainTitle_Main
	lea.l	Audio7,a0
	cmpi.l	#CopyBackStream14Bit_Stereo,COPYBACK_JR
	beq.w	BuildMainTitle_Main

	acode
BuildMainTitle_Main
	move.l	a2,a1
	jsr	AddString

	lea.l	MainScreenVoc2_TXT,a0
	jsr	AddString

	moveq	#1,d6
	lea.l	DSP_TXT(PC),a0
	tst.b	POSTDSP_FLAG
	bne.s	BuildDspTit
	tst.w	VEXDSP_FLAG
	beq.w	BuildMainTitle_NoDSP
	

	acode
BuildDspTit
	moveq	#1,d7
	jsr	AddString
	tst.w	VEXDSP_FLAG
	beq.s	BuildMainTitle_DSP1

	moveq	#0,d7

	bsr	BuildMainTitLPF

	lea.l	DSPEcho_TXT(PC),a0
	cmpi.l	#CopyDSP_Echo,PREDSP
	beq.s	BuildMainTitle_DSP1b
	lea.l	DSPCrossEcho_TXT(PC),a0
	cmpi.l	#CopyDSP_CrossEcho,PREDSP
	beq.s	BuildMainTitle_DSP1b
	lea.l	DSPCrossEcho2_TXT(PC),a0
	cmpi.l	#CopyDSP_CrossEcho2,PREDSP
	beq.s	BuildMainTitle_DSP1b
	lea.l	DSPCenterEcho_TXT(PC),a0
	cmpi.l	#CopyDSP_CenterEcho,PREDSP
	beq.s	BuildMainTitle_DSP1b

	lea.l	DSPunknown_TXT(PC),a0

BuildMainTitle_DSP1b
	jsr	AddString
	moveq	#0,d6

BuildMainTitle_DSP1
	tst.b	POSTDSP_FLAG
	beq.s	BuildMainTitle_NoDSP

	bsr	BuildMainTitLPF2

	btst	#POSTDELAY,POSTDSP_FLAG
	beq.s	BuildMainTitle_NoDel
		lea.l	DSPDelay_TXT(PC),a0
		lea.l	(a0,d7.w),a0
		jsr	AddString
		moveq	#0,d6
BuildMainTitle_NoDel
	btst	#POSTCHOR,POSTDSP_FLAG
	beq.s	BuildMainTitle_NoChor
		lea.l	DSPChor_TXT(PC),a0
		lea.l	(a0,d6.w),a0
		jsr	AddString
BuildMainTitle_NoChor

BuildMainTitle_NoDSP
	cmpi.w	#TRUE,AnalyzeMsgRECORD_FLAG
	bne.s	.NoMRec
	lea.l	MACROrecord_TXT(PC),a0
	jsr	AddString

.NoMRec	cmpi.w	#FALSE,RECORD_STATUS
	beq.s	.NoEditRec
	lea.l	Editrecord_TXT(PC),a0
	jsr	AddString
.NoEditRec	RET

	acode
BuildMainTitLPF
	puts	d0
	moveq	#" ",d0
	tst.b	DSPFilterEcho
	beq.s	TitLPFOk
		moveq	#"F",d0
TitLPFOk
	move.b	d0,DSPEcho_TXT
	move.b	d0,DSPCrossEcho_TXT
	move.b	d0,DSPCrossEcho2_TXT
	move.b	d0,DSPCenterEcho_TXT
	gets	d0
	rts

	acode
BuildMainTitLPF2        ;PostFilter     
        puts    d0                      
        moveq   #" ",d0                 
        btst    #POSTFILTER,POSTDSP_FLAG
        beq.s   TitLPFOk2               
                moveq   #"F",d0         
TitLPFOk2                               
        move.b  d0,DSPDelay_TXT+1       
        gets    d0                      
        rts

	acode
InitWinFontDim	;I(A0L)(WINDOW)
	puts	a1
	jsr	GetWindowRP
	cmp.l	#0,a1
	beq.s	.exit
	jsr	InitFontDim
.exit	gets	a1
	rts

;---- CIA Interrupt ----

AddICRVector	=   -6
RemICRVector	=  -12
LVOOpenResource	= -498
LVOOpenLibrary 	= -552
LVOCloseLibrary	= -414
LVODelay	= -198

ciatalo = $400
ciatahi = $500
ciatblo = $600
ciatbhi = $700
ciacra  = $E00
ciacrb  = $F00

;	acode
;AudioDMAReset:
;	bsr	AudioDMAOff
;	move.w	#$00ff,$9e+CUSTOMBASE
;	bsr	AudioDMAOn
;	rts

	acode
AudioDMAOn:
	;bsr	AudioDMAClearData
	IFNE DIRECTAMIGAAUDIO
	move.w	#$800f,dmacon+CUSTOMBASE
	ENDC
	rts

	acode
AudioDMAOff:
	IFNE DIRECTAMIGAAUDIO
	;bsr	AudioDMAClearData
	move.w	#$000f,dmacon+CUSTOMBASE
	ENDC
	rts



	IFEQ	COPYPROTECT
CSUM	dc.l	$109010C4
	ELSE

CSUM	dc.l	$19F81AF0
				;Security

	ENDC

	adata
ERROR_FLAG	DC.W	FALSE
MAINEXIT_FLAG	dc.w	FALSE


	adata
Main_AUTOMEM
	dc.l	First_PATHEAD
	dc.l	TrackBuffer_PTR
	dc.l	ActualBlock_PTR
	dc.l	UndoBuffer_PTR
	dc.l	LockBuffer_PTR
	IFEQ	SYMPHPRO
	dc.l	VolumeList_PTR
	ENDC
;;;	dc.l	CalcBuffer_PTR		16BIT
	dc.l	TabulatorMem_PTR

	dc.l	SequenceMem_PTR
	dc.l	TestSongData_PTR
	dc.l	NoteMem_PTR
	dc.l	-1


	;--- PUBLIC SCREEN STUFF ---

	acode
MakeScreenPublic	;V1.0
	BGN
	move.b	#FALSE,PubScreen_PUBLIC
	move.l	MainScreen_PTR,a0
	moveq	#0,d0
	move.l	a0,PSDEBUG+4
	move.l	d0,PSDEBUG+8
	CALLINT	PubScreenStatus(a6)

	move.l	d0,PSDEBUG
	btst	#0,d0
	beq.s	.exit
	move.b	#TRUE,PubScreen_PUBLIC		
.exit	RET

	acode
MakeScreenPrivate	;V1.0
	BGN
	move.b	#FALSE,PubScreen_PUBLIC
	move.l	MainScreen_PTR,a0
	moveq	#0,d0
	bset	#PSNF_PRIVATE,d0

	move.l	a0,PSDEBUG+4
	move.l	d0,PSDEBUG+8
	CALLINT	PubScreenStatus(a6)
	move.l	d0,PSDEBUG

	btst	#PSNF_PRIVATE,d0
	bne.s	.exit
	move.b	#TRUE,PubScreen_PUBLIC		
.exit	RET

	acode
PSCheckVisitors	;O(D0L)(TRUE=HAS VISITORS)
	bsr	MakeScreenPrivate
	move.b	PubScreen_PUBLIC,d0
	extb.l	d0
	bsr	MakeScreenPublic
	rts

CheckPS	;bsr	MakeScreenPublic
	bsr	PSCdo
	;bsr	MakeScreenPrivate
	;bsr	PSCdo
	rts

	acode
PSCdo	BGN
	IFNE TESTPRGB
	move.l	PSDEBUG,d0
	jsr	PrintAssHex
	move.l	PSDEBUG+4,d0
	jsr	PrintAssHex
	move.l	PSDEBUG+8,d0
	jsr	PrintAssHex
	cmpi.b	#TRUE,PubScreen_PUBLIC
	beq.s	.exit
	ASSTXT	.msg1
	RET

.exit	ASSTXT	.msg2
	ENDC
	RET
	IFNE TESTPRGB
.msg1	dc.b	"Screen is Private",0
.msg2	dc.b	"Screen is PUBLIC",0
	ENDC

	acode
Init9BitStream	;1.1
		;1.1 MEGA BUG! WAS NOT EVEN 9BIT BEVOR!!!
	BGN
	move.l	Stream9BitTAB_PTR(PC),a0
	moveq	#2-1,d1

	moveq	#-128,d2
	moveq	#-128,d3

	move.w	#(STREAM9BITNUMB/2)-1,d0	
.loop		move.w	d2,d4
		swap	d4
		move.w	d3,d4
		move.l	d4,(a0)+
		addq.w	#1,d3

		move.w	d2,d4
		swap	d4
		move.w	d3,d4
		move.l	d4,(a0)+
		addq.w	#1,d2
	dbf	d0,.loop
	RET


;-----------------------------------------------------------
                                                            
;SUBSECTION	G F X :  M A N A G E M E N T
                                                            
;-----------------------------------------------------------

	acode	;V1.0
GetWindowUP	;O(A0L)(Window_UP[0=NONE])
	cmp.l	#0,a0
	bne.s	.ok
	rts
.ok	move.l  86(a0),a0
	rts

	acode
GetWindowRP	;V1.0
		;O(A1L)(Window_RP[0=NONE])
	cmp.l	#0,a0
	beq.s	.exit
	move.l  WIN_RP(a0),a1
	rts
.exit	suba.l	a1,a1
	rts

	acode
GetWinStruct	;V1.0
		;(A0L,A1L)(WINDOW,FIELD)
	move.l	46(a0),(a1)	;SCR
	move.l  50(a0),4(a1)	;RP
	move.l  86(a0),8(a1)	;UP
	rts

;-----------------------------------------------------------

	acode
AnalyzeMsg	;V3.0	
		;I(A0L,A1L,A2L)(MSG_PTR,MSG_JUMPLIST,ALTJUMP)
		;2.1:	SAVE REGS
		;3.0	GADTOOLS VERSION
	BGN
	jsr	GetMsgShift
.AM_CheckIDCMP
	move.l	a2,a3
	move.l	(a1)+,d0 	;D0:IDCMP
	cmpi.l	#-1,d0
	beq.w	.AM_JumplistNot
	move.l	(a1)+,d1	;D1:TAB_ADR
	move.l	(a1)+,d2	;D2:OFFSET
	move.l	(a1)+,d3	;D3:MASK
	move.l	(a1)+,a4
	move.l	(a1)+,MESSAGE_PARAM	;NEW
	cmp.l	MsgIDCMP(a0),d0
	beq.s	.AM_SameIDCMP
	bra.s	.AM_CheckIDCMP
.AM_SameIDCMP
	move.l	d1,a1
.AM_LOOP
	move.l	(a1)+,d0
	move.l	(a0,d2),d4
	and.l	d3,d4		;D4:CMP_VALUE
	cmpi.l	#-1,d0
	beq.s	.AM_JumpNImplemented
	move.l	(a1)+,a2
	cmp.l	d4,d0
	bne.s	.AM_LOOP


	movem.l	d0-d7/a0-a6,-(a7)
	jsr	(a2)
	movem.l	(a7)+,d0-d7/a0-a6
	bra.s	.AM_EXIT
.AM_JumpNImplemented
	cmp.l	#0,a4
	beq.w	.AM_JumplistNot
	;D0L=MSGCODE
	movem.l	d0-d7/a0-a6,-(a7)

	jsr	(a4)

	movem.l	(a7)+,d0-d7/a0-a6
	bra.s	.AM_EXIT
.AM_JumplistNot
	cmp.l	#0,a3
	beq.s	.AM_EXIT
	movem.l	d0-d7/a0-a6,-(a7)
	jsr	(a3)
	movem.l	(a7)+,d0-d7/a0-a6
.AM_EXIT	
		;cmpi.b	#TRUE,VIRTUEL_MSG
		;beq.s	.ISVIREXIT
	jsr	SendBackIMsg
		;.ISVIREXIT
	RET


	acode
SendBackIMsg
	BGN
	move.l	a0,a1
	CALLEXEC ReplyMsg
	RET

;--- MACRO RECORD/REPLAY -------------------------------------------------

ANLZRECORDMSG_MAX	EQU	256


NGRECMSG_ACTIONID	EQU	0	;LONG
NGRECMSG_PARAM		EQU	4	;LONG
NGRECMSG_SHIFT		EQU	8	;WORD
NGRECMSG_RECORD		EQU	12	;WORD
NGRECMSG_TYPE		EQU	16	;WORD

NGRECMSG_SIZEOF		EQU	20

NGRECMSGTYPE_GAD	EQU	1
NGRECMSGTYPE_KEYBOARD	EQU	2


	acode
AnalyzeMsgRECORD_FLAG	dc.w	0,0				;FLAG,COUNTER
AnalyzeMsgRecAct_PTR	dc.l	0
AnalyzeMsgRec_PTR	dc.l	0
AnalyzeMsgRecMem_PTR	dc.l	0,NGRECMSG_SIZEOF*ANLZRECORDMSG_MAX+1024,FASTMEM

	acode
RedrawRecGad
	puts	d0-d1
	move.w	AnalyzeMsgRECORD_FLAG,d1
	move.l	#"PE1I",d0
	jsr	NGSetGadBool
	gets	d0-d1
	rts
	
	acode
RecordMsg	;V3.0 NG
		;I(D0L,D1L,D2W)(ACTIONID,PARAMS,TYPE)
	BGN
	cmpi.b	#TRUE,VIRTUEL_MSG
	beq.s	.exit
	cmpi.w	#TRUE,AnalyzeMsgRECORD_FLAG			;V2.2 : RECORD
	bne.s	.exit
	tst.l	AnalyzeMsgRec_PTR
	beq.s	.exit
	tst.l	AnalyzeMsgRecAct_PTR
	beq.s	.exit

	cmpi.w	#ANLZRECORDMSG_MAX-1,AnalyzeMsgRECORD_FLAG+2
	bhs.s	.stop

	;--- RECORD A MSG ---

	addq.w	#1,AnalyzeMsgRECORD_FLAG+2

	move.l	AnalyzeMsgRecAct_PTR,a5
	move.w	Shift_KEY,NGRECMSG_SHIFT(a5)
	move.w	RECORD_STATUS,NGRECMSG_RECORD(a5)	;Keyboard Record
	move.l	d0,NGRECMSG_ACTIONID(a5)
	move.l	d1,NGRECMSG_PARAM(a5)
	move.w	d2,NGRECMSG_TYPE(a5)

	lea.l	NGRECMSG_SIZEOF(a5),a5
	move.l	a5,AnalyzeMsgRecAct_PTR
	bsr	RedrawRecGad
.exit	RET
.stop	bsr	ForceStopRecordMsg
	bra.s	.exit

	acode
ForceStopRecordMsg
	move.w	#FALSE,AnalyzeMsgRECORD_FLAG
	bsr	RedrawRecGad
	rts

ToogleRecordMsg
	eori.w	#-1,AnalyzeMsgRECORD_FLAG
	bsr	RedrawRecGad
	rts

	acode
AnalyzeMsgInitRecord	;V1.0
	clr.w	AnalyzeMsgRECORD_FLAG+2
	move.l	AnalyzeMsgRec_PTR,AnalyzeMsgRecAct_PTR
	rts

LoadAndRunMacro
	bsr	LoadMacro
	tst.w	AnalyzeMsgRECORD_FLAG+2
	beq.s	.exit
	jsr	ReplayMacro
.exit	rts

	acode
LoadMacro
	BGN
	bsr	ForceStopRecordMsg

	;--- Get File Name ---
	lea.l	Macro_MATCH(PC),a0
	jsr	SetFileRequestPat
	lea.l	MacroDir_TXT(PC),a0
	jsr	SetFileRequestPath
	lea.l	MacroLoad_TXT(PC),a0
	jsr	SimpleFileRequest
	tst.w	d0
	beq	.exit

	;--- Get File Size ---
	move.l	FinalFileNameRT_PTR,a0
	;jsr	GetFileName	
	jsr	FileLength
	cmp.l	AnalyzeMsgRecMem_PTR+4,d0
	bhi.s	.exit
	move.l	d0,d6

	;--- Open File ---
	move.l	#MODE_OLDFILE,d0
	jsr	EasyDOpenFFN
	tst.l	d0
	beq.s	.exit

	;--- Read File ---
	move.l	AnalyzeMsgRecMem_PTR,a0
	move.l	d6,d0
	jsr	EasyDRead
	tst.l	d0
	beq.s	.err

	;--- Check File ---
	cmpi.l	#"SymM",MacroHead_ID(a0)
	bne.s	.err
	cmpi.l	#"MCRO",MacroHead_ID2(a0)
	bne.s	.err
	cmpi.l	#MacroHead_SIZEOF,MacroHead_HeadLen(a0)
	bne.s	.err
	cmpi.l	#NGRECMSG_SIZEOF,MacroHead_MacroLen(a0)
	bne.s	.err
	cmpi.w	#1,MacroHead_Version(a0)
	bne.s	.err
	cmpi.w	#0,MacroHead_Version+2(a0)
	bne.s	.err

	;--- Set Macro Anzahl ---
	move.l	MacroHead_NumbOfMacros(a0),d7
	move.w	d7,AnalyzeMsgRECORD_FLAG+2

	;--- leave ---
.exit2	jsr	EasyDClose
	jsr	CheckResidentMem
.exit	RET
.err	ASSTXT	NoMacroFile_TXT
	bra.s	.exit2


	acode
SaveMacro
	BGN
	bsr	ForceStopRecordMsg
	tst.w	AnalyzeMsgRECORD_FLAG+2	;Anzahl Macros
	beq	.exit

	lea.l	Macro_MATCH(PC),a0
	jsr	SetFileRequestPat
	lea.l	MacroDir_TXT(PC),a0
	jsr	SetFileRequestPath
	lea.l	MacroSaveAs_TXT(PC),a0
	jsr	SimpleFileRequest
	tst.w	d0
	beq	.exit

	move.l	FinalFileNameRT_PTR,a0
	jsr	ClipExtension
	lea.l	Macro_MATCH+2(PC),a1
	jsr	AddExtention


	move.l	#MODE_NEWFILE,d0
	jsr	EasyDOpenFFN
	tst.l	d0
	beq.s	.exit

	move.l	AnalyzeMsgRecMem_PTR,a0

	move.l	#"SymM",MacroHead_ID(a0)
	move.l	#"MCRO",MacroHead_ID2(a0)
	move.l	#MacroHead_SIZEOF,MacroHead_HeadLen(a0)
	move.l	#NGRECMSG_SIZEOF,MacroHead_MacroLen(a0)
	moveq	#0,d7
	move.w	AnalyzeMsgRECORD_FLAG+2,d7	
	move.l	d7,MacroHead_NumbOfMacros(a0)
	move.w	#1,MacroHead_Version(a0)
	move.w	#0,MacroHead_Version+2(a0)

	moveq	#MacroHead_SIZEOF,d0
	mulu	#NGRECMSG_SIZEOF,d7
	add.l	d7,d0

	jsr	EasyDWrite
	jsr	EasyDClose
.exit	RET

MacroHead_ID		EQU	0
MacroHead_ID2		EQU	4
MacroHead_HeadLen	EQU	8
MacroHead_MacroLen	EQU	12
MacroHead_NumbOfMacros	EQU	16
MacroHead_Version	EQU	20
MacroHead_SIZEOF	EQU	64

	acode
InitMacroMem
	puts	d0
	move.l	AnalyzeMsgRecMem_PTR,d0
	addi.l	#MacroHead_SIZEOF,d0
	move.l	d0,AnalyzeMsgRec_PTR
	gets	d0
	rts

	acode
ReplayRecordedMsg	;V3.1 NG
	BGN
	move.w	#FALSE,AnalyzeMsgRECORD_FLAG
	tst.l	AnalyzeMsgRec_PTR
	beq	.exit
	move.w	AnalyzeMsgRECORD_FLAG+2,d7
	subq.w	#1,d7
	bmi.s	.exit


	move.l	AnalyzeMsgRec_PTR,a5
	move.w	Shift_KEY,d6
	move.w	RECORD_STATUS,d5

.loop	move.w	#FALSE,AnalyzeMsgRECORD_FLAG
	move.b	#TRUE,VIRTUEL_MSG
	move.b	#TRUE,MACROPROCESS
	move.w	NGRECMSG_SHIFT(a5),Shift_KEY
	move.w	NGRECMSG_RECORD(a5),RECORD_STATUS
	move.l	NGRECMSG_ACTIONID(a5),d0
	move.l	NGRECMSG_PARAM(a5),d1
	move.w	NGRECMSG_TYPE(a5),d2
	lea.l	NGRECMSG_SIZEOF(a5),a5
	bsr	.ExecuteMacroMsg
	dbf	d7,.loop

	move.w	d5,RECORD_STATUS
	move.w	d6,Shift_KEY
.exit
	move.w	#FALSE,AnalyzeMsgRECORD_FLAG
	move.b	#FALSE,VIRTUEL_MSG
	move.b	#FALSE,MACROPROCESS
	bsr	RedrawRecGad
	RET

.ExecuteMacroMsg
	BGN
	cmpi.w	#NGRECMSGTYPE_GAD,d2
	beq.s	.gad
	bra.s	.exit2
.gad	jsr	NGGadDoAction	;I(D0L,GADID)
.exit2	RET


XXCutActualBlock
	move.l	#"XmXB",XXMsg
	jsr	NGRecordXXMsg
	bra.l	CutActualBlock

XXCopyActualBlock
	move.l	#"XmCB",XXMsg
	jsr	NGRecordXXMsg
	bra.l	CopyActualBlock

XXPasteActualBlock
	move.l	#"XmVB",XXMsg
	jsr	NGRecordXXMsg
	bra.l	PasteActualBlock

XXAddActualBlock
	move.l	#"XmBB",XXMsg
	jsr	NGRecordXXMsg
	bra.l	AddActualBlock

XXSwapActualBlock
	move.l	#"XmEB",XXMsg
	jsr	NGRecordXXMsg
	bra.l	SwapActualBlock



VIRTUEL_MSG	dc.b	FALSE


	;----------------------------------------------------------
	;------	14BiT TRANSFORM SECTION ---------------------------
	;----------------------------------------------------------

	acode

	IFNE CALIBRATED14
;======================= Load 14 Bit Calibration Table ==============================================
LoadCalibration:
	movem.l	d0-a6,-(sp)
	moveq	#-1,d7
	
	move.l	4.w,a6
	lea	.dos(pc),a1
	moveq	#33,d0
	jsr	LVOOpenLibrary(A6)
	tst.l	d0
	beq	.error
	move.l	d0,.dosbase
	move.l	d0,a6
	lea	.loadname(pc),a1
	move.l	a1,d1
	move.l	#1005,d2			;mode_oldfile
	jsr	Open(a6)
	move.l	d0,d1				;Handle
	beq.s	.closelib
	move.l	d0,d6

	lea	AdditiveArray(pc),a0
	move.l	a0,d2				;Adr
	move.l	#256,d3				;len
	jsr	Read(A6)
	move.l	d0,d7

	ASSTXT	calibrated_TXT

	move.l	d6,d1
	jsr	Close(a6)
.closelib
	move.l	a6,a1
	move.l	4.w,a6
	jsr	LVOCloseLibrary(A6)
	cmp.l	#256,d7
	beq.s	.quit
.error
	lea	AdditiveArray(pc),a0
	move	#255-1,d0
.cop	move.b	#$5f,(a0)+
	dbf	d0,.cop
	move.b	#$7f,(a0)
.quit
	movem.l	(sp)+,d0-a6
	moveq	#0,d0
	rts
.loadname:	dc.b	"ENV:Cybersound/Sounddrivers/14Bit_Calibration",0
.dos		dc.b	"dos.library",0
.dosbase	dc.l	0
calibrated_TXT	dc.b	"* Loading calibration prefs",0
AdditiveArray	blk.b	256,0

;---------------------------------------------------------------------------------------
Maketable:
	BGN

	puts	a0
	lea	AdditiveArray(pc),a1
	bsr	_CreateTable
	gets	a0

	RET

	move.l	#$8000,d7
.loop	move.b	(a0),d0
	move.b	1(a0),d1
	move.b	d1,(a0)
	move.b	d0,1(a0)
	lea.l	2(a0),a0
	subq.l	#1,d7
	bne.s	.loop

	
	RET

		; Parameters

		; a0 = Table address
		; (MUST have enough space for 65536 UWORDS)
		; a1 = Additive Array
		; 256 UBYTEs
		;
		; the table is organized as follows:
		; 32768 UWORDS positive range, ascending order
		; 32768 UWORDS negative range, ascending order
		; access: (a0,d0.l*2)
		; where d0.w is signed word sample data
		; and the upper word of d0.l is *cleared!*

_CreateTable	movem.l	a2/d2-d6,-(sp)

		lea	128(a1),a2
		add.l	#2*32768,a0		; place at the middle of the table

		move.l	a2,a1			; count the number of steps
		moveq	#128-1,d0		; in the positive range
		moveq	#0,d5
.countpositive	move.b	(a1)+,d1
		ext.w	d1
		ext.l	d1
		add.l	d1,d5
		dbra	d0,.countpositive	; d5=number of steps
		move.l	#32768,d6		; reset stretch counter
		
		move.l	a2,a1			; middle value in calibdata
		move.w	#32768-1,d0		; number of positive values -1
		moveq	#0,d1			; HI value
		moveq	#0,d2			; LO value
		moveq	#0,d3			; counter
.fetchnext2	move.b	(a1)+,d4		; add calibtable to counter
		ext.w	d4
		add.w	d4,d3
.outerloop2	tst.w	d3
		bgt.s	.positive2
.negative2	addq.w	#1,d1			; increment HI value
		sub.w	d4,d2			; reset LO value
		bra.s	.fetchnext2
.positive2	move.b	d1,(a0)+		; store HI and LO value
		move.b	d2,(a0)+
		sub.l	d5,d6			; stretch the table
		bpl.s	.repeat2		; to 32768 entries
		add.l	#32768,d6
		addq.w	#1,d2			; increment LO value
		subq.w	#1,d3			; decrement counter
.repeat2	dbra	d0,.outerloop2

		move.l	a2,a1			; count the number of steps
		moveq	#128-1,d0		; in the negative range
		moveq	#0,d5
.countnegative	move.b	-(a1),d1
		ext.w	d1
		ext.l	d1
		add.l	d1,d5
		dbra	d0,.countnegative	; d5=number of steps
		move.l	#32768,d6		; reset stretch counter
		
		sub.l	#2*32768,a0		; again place at the middle of the table

		move.l	a2,a1			; middle value in calibdata
		move.w	#32768-1,d0		; number of negative values -1
		moveq	#-1,d1			; HI value
		moveq	#-1,d2			; LO value
		moveq	#0,d3			; counter
.fetchnext1	move.b	-(a1),d4		; add calibtable to counter
		ext.w	d4
		add.w	d4,d3
		add.w	d4,d2			; maximize LO value
.outerloop1	tst.w	d3
		bgt.s	.positive1
.negative1	subq.w	#1,d1
		bra.s	.fetchnext1
.positive1	move.b	d2,-(a0)		; store LO and HI value
		move.b	d1,-(a0)
		sub.l	d5,d6			; stretch the table
		bpl.s	.repeat1		; to 32768 entries
		add.l	#32768,d6
		subq.w	#1,d2			; decrement lo value
		subq.w	#1,d3			; decrement counter
.repeat1	dbra	d0,.outerloop1

		movem.l	(sp)+,a2/d2-d6
		rts




Build14BitTab
	BGN
	bsr	LoadCalibration
	move.l	Bit14Tab_PTR,a0
	moveq	#0,d0
	bsr	Maketable
	RET

	ELSE
Build14BitTab	;V1.0
	BGN
	move.l	Bit14Tab_PTR,a0
	moveq	#-128,d0	;HIGHER 8 BIT
	moveq	#-32,d1		;LOWER 6 BIT
	move.l	#256-1,d5
.loop	
	moveq	#-32,d1
	moveq	#64-1,d6
.loop2
	moveq	#4-1,d7
.dup4	move.b	d1,(a0)+
	move.b	d0,(a0)+
	dbf	d7,.dup4
	addq.b	#1,d1
	dbf	d6,.loop2
	addq.b	#1,d0
	dbf	d5,.loop
	RET
	ENDC

	acode
AboutRequest
	BGN
	lea.l	About_TXT,a0
	jsr	InfoRequest
	RET


	;-----------------------------------------------------

	;------	REQUESTER SECTION ----------------------------

	;-----------------------------------------------------

	acode
MoveEOFString	;V1.0
		;I(A0L)(STRING)
		;O(A0L)(STRING)
.loop	tst.b	(a0)+
	bne.s	.loop
	subq.l	#1,a0
	rts

	acode
SetWBScreen
	BGN
	suba.l	a0,a0
	bsr	SetRequesterScreen
	CALLINT	OpenWorkBench(a6)		;OpenWorkBench
	move.l	d0,MainScreen_PTR
	move.l	d0,TestWin_TAGS+4
	move.l	d0,NGWin_TAGS+4
	move.b	#-1,OnWBScreen
	RET

OnWBScreen	dc.b	0	;0=Nrm Screen, -1=WB

	acode
SetRequesterScreen	;I(A0L)(SCREEN_PTR)
	BGN
	move.l	a0,InfoRequest_TAGS+4
	move.l	a0,FileREQ_TAG+4
	move.l	a0,StringREQ_TAG+4
	move.l	a0,RequesterScreen_PTR
	move.l	a0,NGWin_TAGS+4
	RET

CalcScreenDepth
	BGN
	move.l	MainScreen_PTR,a0
	move.l	84+4(a0),a0		;BM=4(RP)
	move.b	5(a0),ScreenDepth
	RET
ScreenDepth	dc.b	0
	even

	acode
InfoRequest	;V1.1
		;I(A0L)(TEXT)
	cmp.l	#0,a0
	bne.s	.Do
	rts
.Do	BGN
	move.l	a0,a1
	lea.l	InfoOK_TXT(PC),a2
	suba.l	a3,a3
	suba.l	a4,a4
	lea.l	InfoRequest_TAGS(PC),a0
		CALLREQ	EZRequestA
	RET
InfoRequest_TAGS
	dc.l	RT_Screen,0
;	dc.l	RT_ReqPos,REQPOS_CENTERSCR
	dc.l	TAG_END


	IFNE	TESTREQHANDLE
	acode
StartRequest	;V1.1
		;I(A0L)(TEXT)
	cmp.l	#0,a0
	bne.s	.go
	rts
.go	BGN
	clr.l	StartRequest_TAGS+12	;clear handler
	move.l	InfoRequest_TAGS+4,StartRequest_TAGS+4
	move.l	a0,a1
	move.l	_ReqToolsBase,a6
	lea.l	InfoOK_TXT(PC),a2
	suba.l	a3,a3
	suba.l	a4,a4
	lea.l	StartRequest_TAGS(PC),a0
	jsr	rtEZRequestA(a6)

	move.b	#TRUE,CHECKREQ_STATUS
	RET
StartRequest_TAGS
	dc.l	RT_Screen,0
	dc.l	RT_ReqHandler,0
	dc.l	TAG_END


	acode
EndInfoRequest	;V1.0
	rts
	tst.l	StartRequest_TAGS+12
	bne.s	.go
	rts
.go	BGN
	move.l	_ReqToolsBase,a6
	move.l	StartRequest_TAGS+12,a1
	lea.l	InfoClose_TAGS(PC),a0
	moveq	#0,d0				;no sigs
	jsr	rtReqHandlerA(a6)
	RET
InfoClose_TAGS
	dc.l	RTRH_EndRequest,REQ_OK
	dc.l	TAG_END

ReqAddSignal
	cmpi.b	#TRUE,CHECKREQ_STATUS
	beq.s	.go
	rts
.go	puts	d1/a1
	move.l	StartRequest_TAGS+12,a1
	move.l	4(a1),d1			;get mask
	or.l	d1,d0	
	moveq	#-1,d0
	gets	d1/a1
	rts

ReqCheckSignal
	tst.l	StartRequest_TAGS+12
	bne.s	.go
	rts
.go	cmpi.b	#TRUE,CHECKREQ_STATUS
	beq.s	.go2
	rts
.go2	BGN
	move.l	_ReqToolsBase,a6
	move.l	StartRequest_TAGS+12,a1
	lea.l	InfoClose_TAGS+8(PC),a0
	jsr	rtReqHandlerA(a6)
	cmpi.l	#CALL_HANDLER,d0
	bne.s	.exit
	move.b	#FALSE,CHECKREQ_STATUS
.exit	RET
CHECKREQ_STATUS	dc.b	FALSE

	ENDC

	acode
SplitDblString	;I(A0L)
		;O(A0L,A1L)
	move.l	a0,a1
	jsr	MoveNextString
	exg	a0,a1
	rts

	acode
MulitChoiceRequest	;V1.1
	;I(A0L)(DBLTEXT [TXT,CHOICETXT])
	;O(D0W)(CHOICE)
	;Bsp "Quit|Save As|Cancel"
	;Bsp  1    2       0(!)

	puts	d1-a6
	bsr	SplitDblString

	move.l	a1,a2
	move.l	a0,a1
	suba.l	a3,a3
	suba.l	a4,a4
	lea.l	InfoRequest_TAGS(PC),a0
	CALLREQ	EZRequestA
	gets	d1-a6
	rts




	acode
GetReqPath
	move.l	RQReqStruct_PTR,a0
	lea.l	FREQ_PATH(a0),a0
	move.l	(a0),a0
	rts

	acode
SetSamplenamePath
	BGN
	lea.l	All_MATCH,a0
	jsr	SetFileRequestPat

	lea.l	AdjustPath_TXT(PC),a0
	moveq	#PBUFID_SAMPLE,d0
	jsr	GetPathBuf
	jsr	SimpleFileRequest
	jsr	SavePathBuf

	move.l	RQReqStruct_PTR,a2
	lea.l	FREQ_PATH(a2),a0
	move.l	(a0),a0
	move.l	FinalFileNameRT_PTR,a1
	jsr	CopyString

	tst.w	d0
	beq.s	SetSampNamePath_X

	move.l	SampleNames_PTR,a4
	move.l	#MaxNumb_Samples-1,d7

SetSampNamePath_L
		move.l	RQReqStruct_PTR,a2
		lea.l	FREQ_PATH(a2),a0
		move.l	(a0),a0
		move.l	FinalFileNameRT_PTR,a1
		jsr	CopyString

		move.l	a4,a0
		tst.b	(a0)
		beq.s	SetSampNamePath_Empty
		cmpi.b	#INSTRTYPE_KILL,SAMPLENAME_INSTRTYPE(a0)
		beq.s	SetSampNamePath_Empty
		cmpi.b	#MULTISAMPLE_LINESRC,SAMPLENAME_MULTI(a0)
		beq.s	SetSampNamePath_Empty
		cmpi.b	#MULTISAMPLE_STEREOR,SAMPLENAME_MULTI(a0)
		beq.s	SetSampNamePath_Empty
		
		jsr	SetFileNamePath
		move.l	FinalFileNameRT_PTR,a1
		exg	a0,a1
		jsr	CopyString
SetSampNamePath_Empty
	lea.l	SampleNameMaxLen(a4),a4
	dbf	d7,SetSampNamePath_L
SetSampNamePath_X
	ASSTXT	Done_TXT
	jsr	DrawInstrument
	RET


	acode
SetFileNamePath
	;I(A0L,A1L)(FILENAME(INKL PATH),PATHTXT_PTR)
	;fileptr = FilePart( path )
	;D0                   D1
	BGN
	move.l	a0,a4
	move.l	a1,a5

	move.l	a0,d1
	DOS	FilePart(a6)

	move.l	a5,d1
	move.l	d0,d2
	move.l	#SampleNameMaxLen/2,d3
	DOS	AddPart(a6)
	RET


	acode
SimpleFileRequest	;V1.3
		;I(A0L)(TEXT)
		;O(D0L)(EXIT)
	BGNB
	jsr	SetOldCList
	move.l	a0,a3
	move.l	FinalFileNameRT_PTR,a0
	jsr	ClrFileName

	cmp.l	#0,a3
	bne.s	SimpleFileRequest_HasHead
		lea.l	FileAccess_TXT(PC),a3			;A3L Text toDisplay
SimpleFileRequest_HasHead

;	tst.l	FileNameRT_ACT
;	bne.s	SimpleFileRequest_M1
		move.l	FileNameRT_PTR,FileNameRT_ACT

SimpleFileRequest_M1
	move.l	RQReqStruct_PTR,a1
	move.l	FileNameRT_ACT,a2
	lea.l	FileREQ_TAG(PC),a0
	CALLREQ	FileRequestA
	bsr	BuildFileNameRT
	RETB
FileREQ_TAG
	dc.l	RT_Screen,0
	;	dc.l	RT_ReqPos,REQPOS_CENTERSCR
	dc.l	RTFI_Flags,FREQF_PATGAD
	dc.l	TAG_END


	acode
BuildFileNameRT	;V1.0
		BGN
		move.l	RQReqStruct_PTR,a2
		lea.l	FREQ_PATH(a2),a0
		move.l	(a0),a0
		move.l	FinalFileNameRT_PTR,a1
		jsr	CopyString			;Copy Path

		move.l	FinalFileNameRT_PTR,d1
		move.l	FileNameRT_ACT,d2
		move.l	FinalFileNameRT_PTR+4,d3
		DOS	AddPart(a6)			;Add FileName
		RET

FileNameRT_ACT:		dc.l	0
FileNameRT_PTR:		dc.l	0,8*100,FASTMEM
FinalFileNameRT_PTR:	dc.l	0,512,FASTMEM

	acode
NaturalLongRequest	;V2.0
			;I(D1L,A0L,A1L)(MAXIMUM,NUM_PTR,TITLE)
			;2.0:	BUFFERED CANCEL
	BGNB
	move.l	(a0),d7
NaturalLongRequest_ILL
	bsr	LongRequest
	tst.w	d0
	beq.s	NaturalLongRequest_C

	tst.l	(a0)
	beq.s	NaturalLongRequest_ILL
	bmi.s	NaturalLongRequest_ILL
	cmp.l	(a0),d1
	blo.s	NaturalLongRequest_ILL
NaturalLongRequest_X	RETB
NaturalLongRequest_C
		move.l	d7,(a0)
	bra.s	NaturalLongRequest_X	

NaturalLongRequestZ
		;I(D1L,A0L,A1L)(MAXIMUM,NUM_PTR,TITLE)
	BGNB
	move.l	(a0),d7
NatLongReqZ_ILL
		bsr	LongRequest
		tst.w	d0
		beq.s	NatLongReqZ_C

		bmi.s	NatLongReqZ_ILL
		cmp.l	(a0),d1
	blo.s	NatLongReqZ_ILL
NatLongReqZ_X	RETB
NatLongReqZ_C
	move.l	d7,(a0)
	bra.s	NatLongReqZ_X

	acode
LongRequest	;V0.1
		;I(A0L,A1L)(NUM_PTR,TITLE)
	BGNB
	moveq	#100,d0
	move.l	a1,a2
	move.l	a0,a1
	lea.l	StringREQ_TAG(PC),a0
	suba.l	a3,a3
	CALLREQ	GetLongA
	RETB

	acode
StringRequest	;V1.0
		;I(D0W,A0L,A1L)(MAXLEN,STRING,TITLE)
	BGNB
	move.l	a1,a2
	move.l	a0,a1
	lea.l	StringREQ_TAG(PC),a0
	suba.l	a3,a3
	CALLREQ	GetStringA
	RETB
StringREQ_TAG
	dc.l	RT_Screen,0
	dc.l	TAG_END

	acode
SetFileRequestPat	;V1.1
			;I(A0L)(PATTERN)
	BGN
	lea.l	FileREQ_ExtTags(PC),a2
	move.l	a0,4(a2)
	move.l	#RTFI_MatchPat,(a2)
SetFileRequestAttr
	move.l	_ReqToolsBase,a6
	move.l	RQReqStruct_PTR,a1
	move.l	a2,a0
	CALLREQ	ChangeReqAttrA
	RET
FileREQ_ExtTags	dc.l	RTFI_MatchPat,0
		dc.l	TAG_END

	acode
SetFileRequestPath	;V1.0
			;I(A0L)(PATH)
	BGN
	cmp.l	FileRequestPath_OLD,a0
	beq.s	SetFileRequestPath_X
	move.l	a0,FileRequestPath_OLD
	lea.l	FileREQ_ExtTags(PC),a2
	move.l	a0,4(a2)
	move.l	#RTFI_Dir,(a2)
	bra.s	SetFileRequestAttr
SetFileRequestPath_X	RET
FileRequestPath_OLD	dc.l	-1


	acode
PrintErrorMsg
	BGN
	tst.l	ErrorText_TXT
	beq.w	PrintErrorMsg_X

	tst.l	_ReqToolsBase
	beq.s	PrintErrorMsg_NoRequester

	move.l	ErrorText_TXT,a0
	jsr	InfoRequest
	clr.l	ErrorText_TXT
	bra	PrintErrorMsg_X

PrintErrorMsg_NoRequester
	lea.l	ERRTXT_AUTOLIBLIST+6,a1
	move.l	EXECBASE,a6
	moveq	#0,d0
	jsr	_LVOOpenLibrary(a6)
	tst.l	d0
	beq.s	PrintErrorMsg_X
	move.l	d0,ERRDOSBASE

	move.l	#ErrName,d1
	move.l	#MODE_OLDFILE,d2
	move.l	ERRDOSBASE,a6
	jsr	_LVOOpen(a6)
	move.l	d0,a5
	tst.l	d0
	beq.s	PrintErrorMsg_X

	move.l	ErrorText_TXT,a0
	jsr	GetLen
	move.l	a5,d1
	move.l	a0,d2
	move.l	d0,d3
	move.l	ERRDOSBASE,a6
	jsr	_LVOWrite(a6)

	move.l	#5*50,d1
	move.l	ERRDOSBASE,a6
	jsr	_LVODelay(a6)

	move.l	a5,d1
	move.l	ERRDOSBASE,a6
	jsr	_LVOClose(a6)

	move.l	ERRDOSBASE,a1
	move.l	EXECBASE,a6
	jsr	_LVOCloseLibrary(a6)

	clr.l	ErrorText_TXT

PrintErrorMsg_X	RET



	;-----------------------------------------------------

	;------	EXTERNAL CODE SECTION ----------------------------

	;-----------------------------------------------------

	acode
SendBackMsg:	;V1.0
		;I(A0L)(MSG_PTR)
	BGN
	move.l	a0,a1
	CALLEXEC	ReplyMsg
	RET
	
	acode
WarnFlash:
	IFNE TESTPRGB
	move.w	#$f00,$dff180
	addq.l	#1,Warn_Counter
	move.l	(SP),Warn_Counter+4
	ENDC
	rts
Warn_Counter	dc.l	0,0


	acode
MultiTaskingOff:
	BGN
	CALLEXEC	Forbid
	CALLEXEC	Disable
	RET

	acode
MultiTaskingOn:
	BGN
	CALLEXEC	Enable
	CALLEXEC	Permit
	RET


	acode
MakeA0Even:
	move.l	d0,-(a7)
	move.l	a0,d0
	addq.l	#1,d0
	bclr	#0,d0
	move.l	d0,a0
	move.l	(a7)+,d0
	rts	

mulu10:		;V1.0
	move.l	d1,-(a7)
	lsl.l	#1,d0
	move.l	d0,d1
	lsl.l	#2,d0
	add.l	d1,d0
	move.l	(a7)+,d1
	rts

;	INCLUDE "INCLUDES/LFC_Strings.i"
;	INCLUDE "INCLUDES/LFC_Memory.i" 
; 	INCLUDE "INCLUDES/LFC_AutoLib.i"
;	INCLUDE "INCLUDES/LFC_Copper.i"
;	INCLUDE "INCLUDES/LFC_Sync.i"
;	INCLUDE "INCLUDES/LFC_HardwareIO.i"
;	INCLUDE "INCLUDES/LFC_AutoMenu.i"


	acode
DrawDebugInfo
	BGN
	lea.l	MEM_DEBUG_INFO(PC),a2
	move.l	12(a2),d0
	move.l	16(a2),d1
	jsr	PrintDblAssHex
	move.l	(a2),d0
	move.l	4(a2),d1
	jsr	PrintDblAssHex
	ASSTXT	MemFail_ERR

	;moveq	#-1,d0
	;CALLEXEC	Wait
	RET

SINUNITS	EQU	360
VIBUNITS	EQU	256

SAVIBUNITS	EQU	512

	acode
BuildSinusTab
	BGN
	move.l	SinusTab(PC),a1
	move.w	#SINUNITS,d7
	move.l	#(SINTAB_UNITS*2*$10000/SINUNITS),d0
	move.w	#255,d1
;	bsr	TransformSinus

	move.l	VibratoTab_PTR(PC),a1
	move.w	#VIBUNITS,d7
	move.l	#(SINTAB_UNITS*2*$10000/VIBUNITS),d0
	move.w	#$7f,d1
	bsr	TransformSinus
	move.w	#(VIBUNITS/4),d0
	bsr	RotLTable

	move.l	SaVibratoTab_PTR(PC),a1
	move.w	#SAVIBUNITS,d7
	move.l	#(SINTAB_UNITS*2*$10000/SAVIBUNITS),d0
	move.w	#$7f,d1
	bsr	TransformSinus
	move.w	#(SAVIBUNITS/4),d0
	bsr	RotLTable


	move.l	TremoloTab_PTR(PC),a1
	move.w	#VIBUNITS,d7
	move.l	#(SINTAB_UNITS*2*$10000/VIBUNITS),d0
	move.w	#$7f,d1
	bsr	TransformSinus

	RET

RotLTable	;V1.0
		;I(A1L,D0W,D7W)(TABLE_PTR,SHIFTn,ELEMENT#)
	BGN
	subq.w	#2,d7
	bmi.s	RotLTable_X
	subq.w	#1,d0
	bmi.s	RotLTable_X
RotLTable_L2
		move.w	d7,d6
		move.l	a1,a0
RotLTable_L1	move.l	(a0),d1
			swap	d1
			move.l	d1,(a0)
			lea.l	2(a0),a0
		dbf	d6,RotLTable_L1
	dbf	d0,RotLTable_L2
RotLTable_X	RET

TransformSinus
	BGN
	lea.l	SINTAB(PC),a0
	move.w	d1,d4
	moveq	#0,d1
	lsr.w	#1,d7
	subq.w	#1,d7
	move.w	d7,d6
BuildSinusTab_L
		move.l	d1,d2
		swap	d2
		move.w	(a0,d2.w*2),d3
		mulu	d4,d3
		divu	#SINMAX,d3
		move.w	d3,(a1)+
		add.l	d0,d1
	dbf	d6,BuildSinusTab_L
	moveq	#0,d1
BuildSinusTab_L2
		move.l	d1,d2
		swap	d2
		move.w	(a0,d2.w*2),d3
		mulu	d4,d3
		divu	#SINMAX,d3
		neg.w	d3
		move.w	d3,(a1)+
		add.l	d0,d1
	dbf	d7,BuildSinusTab_L2
	RET


	acode
PlayPrevPosition
	jsr	PosNumDown
	jsr	PlayFromActualPos
	rts
PlayNextPosition
	jsr	PosNumUp
	jsr	PlayFromActualPos
	rts

MEM_DEBUG_INFO	dcb.l 6,0

	INCLUDE "DisASM.asm"

;=====================================================================

;=== DATA SECTION ====================================================

;=====================================================================

	adata
Para_FileName	blk.b	256,0
Para_PTR	dc.w	FALSE
		dc.l	0,0



TimeString_TXT	blk.l	8,0
Position_BUF	blk.b	POSITION_SIZEOF,0


PATDRAW_FAST	dc.w	FALSE
Test_PATTED	blk.l	(PATTED_SIZEOF+3)/4,0

First_PATHEAD	dc.l	0,0,FASTMEM
NoteMem_PTR	dc.l	0,0,FASTMEM
PosCache	blk.w	30,-1
InstrumentCache	blk.w	40,-1



LoadActualModule_HEAD	blk.b	8,0
tempstring		blk.b	256,0

	acode
DELYHARM_BAK		dc.l	0
SAMPLEPreOverS		dc.l	1
InstNum			dc.l	0
LineSampleEnd_PTR	dc.l	0
BuildTransSample_TEMP	blk.l	16,0


TempProjName	dc.l	0,256,FASTMEM
NewLoadSample_INFO	blk.l	32,0

PathBufID	dc.w	0





	adata
SongDuration		dc.l	0,0
SequenceDuration	dc.l	0,0
RelTimeBase_STAMP	blk.l	4,0
RelTimeMaster_STAMP	blk.l	4,0
ActTime_STAMP	blk.l	4,0

StreamCount	dc.l	0
StreamBufLen	dc.l	0
StreamPeriod	dc.w	0
NotifySeqEnd	dc.w	FALSE



	acode
CALC_PatternLen		dc.l	0
VexBufferNumb		dc.l	8
VexBufferSize		dc.l	0	;[28867/50]*[VexQuality/VexSpeed]/[1+OVERSAMPLING]
VexPeriod		dc.l	0	;[12400]/VexQuality
System_FreqBase		dc.l	0	;[131*1240/35]/[VexQuality]*[1+OVERSAMPLING]
VexQuality		dc.l	100
VexSpeed		dc.l	83
VEX_LinesPerPattern	dc.l	Test_LinesPerPattern	; PATTED_LINESPERPATTERN
VEX_NotePerPattern	dc.l	0
VEX_NoteSize		dc.l	NOTE_SIZEOF
VEX_TrackSize		dc.l	0
VEX_PatternSize		dc.l	0
VEX_PattNumb		dc.l	Test_PattNumb
VEX_PosNumb		dc.l	512
VEX_LineSize		dc.l	0	;in Bytes NEW

VEXDSP_FLAG		dc.w	DSP
VEXDSP_INFO		dc.b	DSP_OFF,0,0,0
VexVoicesPerAudio	dc.w	2
VEX_StartSetup
VexVolumeShift		dc.w	1
VexAudioNumb		dc.w	4
CHANNEL_NUMB		dc.w	8	; PATTED_NUMBVOICES
OverSamp_FLAG		dc.w	OVERSAMPLING
LargeBufCount		dc.w	0


BuildLineSample_PITCHSTART	dc.w	0

FFC	EQU	$10000/1000




	dc.l	1000*$10000/1000/16,1059*$10000/1000/16,1122*$10000/1000/16,1189*$10000/1000/16,1260*$10000/1000/16,1335*$10000/1000/16
	dc.l	1414*$10000/1000/16,1498*$10000/1000/16,1587*$10000/1000/16,1681*$10000/1000/16,1781*$10000/1000/16,1887*$10000/1000/16

	dc.l	1000*$10000/1000/8,1059*$10000/1000/8,1122*$10000/1000/8,1189*$10000/1000/8,1260*$10000/1000/8,1335*$10000/1000/8
	dc.l	1414*$10000/1000/8,1498*$10000/1000/8,1587*$10000/1000/8,1681*$10000/1000/8,1781*$10000/1000/8,1887*$10000/1000/8

	dc.l	1000*$10000/1000/4,1059*$10000/1000/4,1122*$10000/1000/4,1189*$10000/1000/4,1260*$10000/1000/4,1335*$10000/1000/4
	dc.l	1414*$10000/1000/4,1498*$10000/1000/4,1587*$10000/1000/4,1681*$10000/1000/4,1781*$10000/1000/4,1887*$10000/1000/4

	dc.l	1000*$10000/1000/2,1059*$10000/1000/2,1122*$10000/1000/2,1189*$10000/1000/2,1260*$10000/1000/2,1335*$10000/1000/2
	dc.l	1414*$10000/1000/2,1498*$10000/1000/2,1587*$10000/1000/2,1681*$10000/1000/2,1781*$10000/1000/2,1887*$10000/1000/2

BuildLineSample_FREQBASE
	dc.l	1000*$10000/1000,1059*$10000/1000,1122*$10000/1000,1189*$10000/1000,1260*$10000/1000,1335*$10000/1000
	dc.l	1414*$10000/1000,1498*$10000/1000,1587*$10000/1000,1681*$10000/1000,1781*$10000/1000,1887*$10000/1000

	dc.l	1000*$10000/1000*2,1059*$10000/1000*2,1122*$10000/1000*2,1189*$10000/1000*2,1260*$10000/1000*2,1335*$10000/1000*2
	dc.l	1414*$10000/1000*2,1498*$10000/1000*2,1587*$10000/1000*2,1681*$10000/1000*2,1781*$10000/1000*2,1887*$10000/1000*2

	dc.l	1000*$10000/1000*4,1059*$10000/1000*4,1122*$10000/1000*4,1189*$10000/1000*4,1260*$10000/1000*4,1335*$10000/1000*4
	dc.l	1414*$10000/1000*4,1498*$10000/1000*4,1587*$10000/1000*4,1681*$10000/1000*4,1781*$10000/1000*4,1887*$10000/1000*4

	dc.l	1000*$10000/1000*8,1059*$10000/1000*8,1122*$10000/1000*8,1189*$10000/1000*8,1260*$10000/1000*8,1335*$10000/1000*8
	dc.l	1414*$10000/1000*8,1498*$10000/1000*8,1587*$10000/1000*8,1681*$10000/1000*8,1781*$10000/1000*8,1887*$10000/1000*8

	dc.l	1000*$10000/1000*16,1059*$10000/1000*16,1122*$10000/1000*16,1189*$10000/1000*16,1260*$10000/1000*16,1335*$10000/1000*16
	dc.l	1414*$10000/1000*16,1498*$10000/1000*16,1587*$10000/1000*16,1681*$10000/1000*16,1781*$10000/1000*16,1887*$10000/1000*16

	dc.l	1000*$10000/1000*16,1059*$10000/1000*16,1122*$10000/1000*16,1189*$10000/1000*16,1260*$10000/1000*16,1335*$10000/1000*16
	dc.l	1414*$10000/1000*16,1498*$10000/1000*16,1587*$10000/1000*16,1681*$10000/1000*16,1781*$10000/1000*16,1887*$10000/1000*16






	acode
		dc.l	0
		dc.l	0			;PROJECT TYPE !!
ProjectName_PTR dc.l	0,1024,PUPMEM
PattedTit_PTR	dc.l	0,1024,PUPMEM

Shift_KEY	dc.w	FALSE
ShiftL_KEY	dc.w	FALSE

NGSampleBoost	dc.l	 NGSAMPLEBOOST_DEFAULT	;0-10'000 %%
SAMPLEBOOST	dc.l	100
JumpLen		dc.l	1




	acode
FastIHandle_INSTRLIST
	blk.l	MaxNumb_Samples,0
	dc.l	-1,-1

Test_INSTRMAN
	dc.l	FastIHandle_INSTRLIST,FastIHandle_INSTRLIST
	dc.w	4,0,MaxNumb_Samples-1

ActualInstrumentNum	dc.w	-1


KNACKLEN	dc.l	0
FORCEKNACK	dc.b	FALSE
	even


KNACKSTEPS	dc.l	32
KNACKMAXVOLSTEP	dc.w	KNACKMAXVOL/32	;KNACKMAXVOL/KNACKSTEPS


Standard_KEYTRANS
	dc.l	Standard_KEYDEF,Upper_KEYDEF
	dc.l	0,8*256,FASTMEM
	dc.w	256
	dc.l	Normal_FREQDEF
	dc.w	0,0

Standard_KEYDEF
	dc.w	12			;OFFSET
	dc.b	$10,2,$11,3,$12,$13,5,$14,6,$15,7,$16,$17,9,$18,$a,$19,$1a,$c,$1b,$d
	dc.b	0
	even
Upper_KEYDEF
	dc.w	0
	dc.b	$31,$21,$32,$22,$33,$34,$24,$35,$25,$36,$26,$37,$38,$28,$39,$29,$3a

	acode
SequenceMem_PTR	dc.l	0,Test_SeqNumb*SEQUENCE_SIZEOF,FASTMEM
MACROPROCESS	dc.b	FALSE


	acode
	dc.l	PlayLineNote_ComplexFXErr	;OLD NONE
ComplexFX_JMP
	dc.l	PlayLineNote_ComplexFXErr	;NONE
	dc.l	PlayLineNote_FxVSlideUp,PlayLineNote_FxVSlideDown
	dc.l	PlayLineNote_FxPSlideDown,PlayLineNote_FxPSlideUp
	dc.l	ReplayFXStartSample,ReplayFXStartPitch
	dc.l	ReplayFXSetFromAdd,ReplayFXFromAdd,ReplayFXSetSpeed
	dc.l	Play_FxAddPitch,Play_FxAddVol				;10,11
	dc.l	PlayLineNote_Vibrato,PlayLineNote_Tremolo
	dc.l	PlayLineNote_SampleVib,PlayNotePSLIDETO
	dc.l	PlayNoteRETRIG,PlayNoteShEmphasis,Play_FxAddHalvTone
	dc.l	PNoteCV,PNoteCVAdd
	dc.l	PlayLineNote_ComplexFXErr
	dc.l	PlayLineNote_ComplexFXErr
	dc.l	PlayLNFilter
	dc.l	PlayLineNote_SetDsp,PlayLineNote_SetDelay		;24,25
	dc.l	PlayLineNote_ComplexFXErr,PlayLineNote_ComplexFXErr
	dc.l	PlayLineNote_ComplexFXErr,PlayLineNote_ComplexFXErr
	dc.l	PlayLineNote_ComplexFXErr,PlayLineNote_ComplexFXErr
	dc.l	PlayLineNote_ComplexFXErr,PlayLineNote_ComplexFXErr	;32,33
	dc.l	PlayLineNote_ComplexFXErr,PlayLineNote_ComplexFXErr
	dc.l	PlayLineNote_ComplexFXErr,PlayLineNote_ComplexFXErr

VOLUMECOM_JL
	dc.l	PlayLineNote_PitchDown3,PlayLineNote_PitchUp3	;242,243
	dc.l	PlayLineNote_PitchDown2,PlayLineNote_PitchUp2
	dc.l	PlayLineNote_PitchDown,PlayLineNote_PitchUp
	dc.l	PlayLineNote_VError
	dc.l	PlayLineNote_SpeedUp,PlayLineNote_SpeedDown
	dc.l	PlayLineNote_KeyOff,PlayLineNote_VError
	dc.l	PlayLineNote_ContSample,PlayLineNote_StopSample

VEX_ACTUALLINE	dc.l	0
ActualSongData	dc.l	0
PlayCVList	dc.l	PlayCV0,PlayCV1,PlayCV2,PlayCV3,PlayCV4
AddHalvTone_NOTE	dc.l	0

TestSongData_PTR	dc.l	0,Test_PosNumb*POSITION_SIZEOF,FASTMEM


Test_SONG	dc.w	0,0		;PattNumb# songdata
		dc.l	0,0
		dc.w	SONGT_SINGLE		;type
		dc.w	Test_SongSpeed,0	;speed
Song_CHNUMB	dc.w	0			;CHANNEL_NUMB# voices used
		dc.l	0			;unused
		dc.l	FastIHandle_INSTRLIST	;instruments (PTRLIST)
		blk.l	60,0

SequenzTune	dc.w	0
PlayStereoCheck	dc.b	0,0
SignalACount	dc.b	1





;--- DSP INFO -------------------------------------------------------

DrySamples	dc.w	0
DelayFX		dc.b	0,0

		acode
			dc.l	DelayCopyNrm
DelayFXList	dc.l	DelayCopyNrm,DelayCopyCross,DelayCopyHall,DelayCopyCrHall

DELAYINFO	dc.w	8,1	;DELAY in CYCL, LEVEL

CHORUSINFO	dc.w	0,-4	;0,2	ACTUAL, LRSAMPLE_LEN
			dc.w	20,19	;4,6	STEPS
			dc.w	10,10	;8,10	TIMER

HallInfo	dc.w	16,2


	acode
COPYBACK_JR			dc.l	CopyBackStream9Bit_Stereo
CopyBuffer_PTR		dc.l	0,0,FASTMEM	;16BIT
PostDspBuffer_PTR	dc.l	0,0,FASTMEM	;16BIT
ResoFilter_PTR		dc.l	0,0,FASTMEM
DryDspBuffer_OFF	dc.w	0
Dry_COUNT			dc.w	0
DryDspBuffer_PTR	dc.l	0,0,FASTMEM
CopySampleSF_OFFSET	dc.l	0


	acode
Actual_FREQDEF
	dc.l	Normal_FREQDEF
	dc.w	12

Normal_FREQDEF
	dc.w	12*14 			;NUMBER OF FREQS
	dc.w	12				;OFFSET
	dc.w	12,12			;OCTAVES, OCTAVEUNITS
	dc.l	NormalFREQLIST_PTR
	dc.l	Gleichschwebend_FREQBASE

Gleichschwebend_FREQBASE
	dc.w	10000,10595,11225,11892,12599,13348
	dc.w	14142,14983,15874,16818,17818,18878


Math_FREQDEF
	dc.w	16*7
	dc.w	16
	dc.w	10,16
	dc.l	NormalFREQLIST_PTR
	dc.l	Math_FREQBASE16

Math_FREQDEF2
	dc.w	12*9
	dc.w	17
	dc.w	10,17
	dc.l	NormalFREQLIST_PTR
	dc.l	Math_FREQBASE17


Math_FREQBASE
	dc.w	10000,10625,11250,11892,12500,13333
	dc.w	14142,15000,15874,16666,17818,18750

Math_FREQBASE17
	dc.w	10000,10416,10850,11301,11771,12261,12772,13303,13857,14433
	dc.w	15034,15660,16311,16990,17697,18434,19201

Math_FREQBASE16
	dc.w	10000,10443,10905,11388,11892,12419,12968,13543
	dc.w	14142,14768,15422,16105,16818,17563,18340,19152

Math_FREQBASE18
	dc.w	10000,10393,10801,11225,11665,12123,12599,13094,13608
	dc.w	14142,14697,15274,15874,16497,17145,17818,18517,19244


	acode
NormalFREQLIST_PTR	dc.l	0,256*16,FASTMEM


	acode
Test_VOICEEXPANDER
	dc.w	0			;channel numb
	dc.w	SAMPLE_SIZEOF
	dc.w	0
	dc.l	0
Test_VOICEEXANumb
	dc.w	0,0		;numb of AUDIO USED			
	dc.w	aud0,16

	dc.w	0,0,0,0		;VexBufferNumb,VexBufferSize,0,VexPeriod

	dc.l	Audio0_Buffer
	dc.w	BUFFER_SIZEOF
	dc.w	FALSE

	dc.l	"V0.0"
	blk.l	10,0

	acode
Audio0_Buffer
	dc.w	0,0		
	dc.w	0
	dc.w	0
	dc.l	BufferMem0_PTR
	dc.l	0
	dc.w	FALSE
	dc.w	0
	dc.w	VexAud0Vol		;VOLUME
	dc.l	0
	dc.w	0

	acode
Audio1_Buffer
	dc.w	0,0		
	dc.w	0
	dc.w	0
	dc.l	BufferMem1_PTR
	dc.l	0
	dc.w	FALSE
	dc.w	0
	dc.w	VexAud1Vol		;VOLUME
	dc.l	0
	dc.w	0

Audio2_Buffer
	dc.w	0,0		
	dc.w	0
	dc.w	0
	dc.l	BufferMem2_PTR
	dc.l	0
	dc.w	FALSE
	dc.w	0
	dc.w	VexAud2Vol		;VOLUME
	dc.l	0
	dc.w	0

Audio3_Buffer
	dc.w	0,0		
	dc.w	0
	dc.w	0
	dc.l	BufferMem3_PTR
	dc.l	0
	dc.w	FALSE
	dc.w	0
	dc.w	VexAud3Vol		;VOLUME
	dc.l	0
	dc.w	0

	adata
			dc.w	0
FADETOSTEPS		dc.w	FADETO_STEPS

FADEOUTSTEPS
FADETOSTEPSm		dc.w	FADETO_STEPS-1
			dc.w	0
;FADEOUTSTEPS		dc.w	FADEOUT_STEPS

	adata
BufferMem0_PTR		dc.l	0,0,CHIPMEM
BufferMem1_PTR		dc.l	0,0,CHIPMEM
BufferMem2_PTR		dc.l	0,0,CHIPMEM
BufferMem3_PTR		dc.l	0,0,CHIPMEM

Test_SAMPLE		dc.l	0,SAMPLE_SIZEOF*(CHANNEL_MAXNUMB+1),FASTMEM
DspHPFilt_LASTSAMPLE	dc.l	0
PREDSP			dc.l	CopyDSP_Echo
Stream9BitTAB_PTR	dc.l	0,STREAM9BITLEN,FASTMEM
;DoSurroundMix_PTR	dc.l	0,20000,FASTMEM

Bit14Tab_PTR		dc.l	0,BIT14_ENTRIES*2,FASTMEM
CB8BITSHIFT		dc.w	2
	acode
SAMPLE_IPTR		dc.l	0
SEPERATECHANNELS	dc.w	0	;0=STEREO, 1=LEFT, -1=RIGHT
FASTPOSSIBLE		dc.b	0	;0=FALSE, -1=TRUE

DSPPLUG_STATUS		dc.b	FALSE
ForceUpdate		dc.b	-1
EmAbort			dc.b	-1,-1	;MB Abort, MB Stop Song
SURROUNDMIX		dc.b	FALSE

	


	acode
DSPDELAY_LIST		dc.l	DeactivateDelay,SetDspDelay,SetDspDelay
DSPFX_LIST		dc.l	DeactivateDsp,DspEcho,DspCrossEcho
			dc.l	DspCrossEcho2,DspCenterEcho

DSPFX			dc.l	DSP_OFF
DSP_ECHO_LVL		dc.l	1
DSP_ECHO_LEN		dc.l	8
MAXDSP_ECHO_LEN		dc.l	16

POSTDSP			dc.l	0		;PreP Routine (Copy Stream)
			dc.l	0		;POST DSP FX

PostDspBUFFERNUMB	dc.l	16


CALCBUF_INFO		dc.l	0,0,0	;BUFFERLEN, ACTUAL, RESET
			dc.w	0,0	;COUNTER, COUNTERRESET


PostDspBUF_INFO		dc.l	0,0,0	;BUFFERLEN, ACTUAL, RESET
			dc.w	0,0	;COUNTER, COUNTERRESET

DELYHARM		dc.w	0	;0=1=OFF
POSTDSP_FLAG		dc.b	0
DSPREINITECHO		dc.b	0
DSPFilterEcho		dc.b	0




	acode
CheckQJMsg_JMP	dc.l	0
		IFNE DIRECTAMIGAAUDIO
BufferSet	dc.l	SetBufferB,SetBufferA
		ELSE
BufferSet	dc.l	DoNil,DoNil
		ENDC
VolumeList_PTR	dc.l	0,VOLUMELIST_FIRSTTAB+(VolumeTabNum*VOLUMELIST_TABLEN*2),FASTMEM
		dc.w	0

PLAYER_STATUS	dc.w	FALSE
IRQStuff_STATUS	dc.w	FALSE	;Ohne Funktion !!!

AudioIRQ_STATUS	dc.w	FALSE	; ????

		dc.w	0
SYSTEM_VOLUME	dc.w	256
		dc.w	0

VL_PROCVLIMIT	dc.w	PROCVLIMIT_INIT
		dc.w	0
VL_NOISELIMIT	dc.w	5
BufferSyncFlag	dc.w	0		;0=A, -1=B
Declicking	dc.b	-1


PITCHDIFF_COUNTER	dc.b	0
DOSAMPLEDIFF	dc.b	0
	even
SAMPLEDIFF	dc.l	0
PITCHDIFF	dc.l	0



	acode
OldIntVector	dc.l	-1

allocport	dc.l	0,0	;succ, pred
		dc.b	4,0	;NT_MSGPORT
		dc.l	0	;name
		dc.b	0,0	;flags = PA_SIGNAL
		dc.l	0	;task

reqlist		dc.l	0,0,0	;list head, tail and tailpred
		dc.b	5,0

allocreq	dc.l	0,0
		dc.b	5,127	;NT_MESSAGE, use maximum priority (127)
		dc.l	0,allocport	;name, replyport
		dc.w	68		;length
		dc.l	0	;io_Device
		dc.l	0	;io_Unit
		dc.w	0	;io_Command
		dc.b	0,0	;io_Flags, io_Error
		dc.w	0	;ioa_AllocKey
		dc.l	sttempo	;ioa_Data
		dc.l	1	;ioa_Length
		dc.w	0,0,0	;ioa_Period,Volume, Cycles
		dc.w	0,0,0,0,0,0,0,0,0,0	;ioa_WriteMsg

sttempo	dc.w	$0f00

audiodevname	dc.b	"audio.device",0
		even




	acode
audiointerrupt	dc.w	0,0,0,0
		dc.b	2,25
		dc.l	audiointname,serportalloc,SymphonieAudioInterrrupt

serportalloc	dc.b	0
audiointname	dc.b	"Symphonie Audio Interrupt",0

	acode
SoftInterrupt	dc.w	0,0,0,0
		dc.b	2,0		;Type, Pri
		dc.l	SoftIntName,serportalloc2,SymphonieSoftIRQ

serportalloc2	dc.b	0
SoftIntName	dc.b	"Symphonie Soft Interrupt",0

	acode
AudioIRQOld_JMP	dc.l	0
VexSyncBufNumb	dc.l	2

SoftInterruptb	dc.w	0,0,0,0
		dc.b	2,0		;Type, Pri
		dc.l	SoftIntName,serportalloc2b,SymphonieSoftIRQ


SoftInt	dc.l	SoftInterrupt,SoftInterruptb


serportalloc2b	dc.b	0
LowCPUWarn	dc.b	0

sigbitnum	dc.b	-1
AUDIODEV_TAKEN	dc.b	FALSE







PubScreen_PUBLIC	dc.b	FALSE
PubScreenName	dc.b	"SymphonieEditor",0


	IFNE	DEMO
		IFNE	SYMPHPRO
MainScreen_TXT		dc.b	"Symphonie Player Pro "
		VerString
		dc.b	" "
		ELSE		
MainScreen_TXT		dc.b	"Symphonie Player "
		VerString
		dc.b	" "

		ENDC
	ELSE
		IFNE	SYMPHPRO
MainScreen_TXT		dc.b	"Symphonie Pro "
		VerString
		dc.b	" "
		ELSE		
MainScreen_TXT	

	IFNE AMINETDEMO
	dc.b	"FREE "
	ENDC

	dc.b	"Symphonie Jr "
	VerString
	dc.b	" "
		ENDC
	ENDC



MainScreenVoc_TXT	dc.b	"  8 Voc ",0
MainScreenVoc2_TXT
SECURITY_BEGIN		dc.b	" (C) Patrick Meng 1999",0
AdjustPath_TXT		dc.b	"Select New Sample Path",0
LongRequestDef_TXT	dc.b	"Enter a number",0
FileAccess_TXT		dc.b	"File Request",0
InfoOK_TXT		dc.b	" OK ",0

	adata
PSDEBUG	dc.l	0,0,0,0
TestWin_SCR	dc.l	0
TestWin_RP	dc.l    0
TestWin_UP	dc.l    0



SymphonieTask_PTR	dc.l	0
Restart_FLAG		dc.w	FALSE
Resync_FLAG		dc.b	0

	acode
VEX_Setup		dc.w	1,4,8

	acode
ErrorText_TXT		dc.l 0
ErrorTest_TXT		dc.b " ",0
ErrName				dc.b 	"CON:20/20/300/40/Symphonie - Error Message",0
ERRChipMem_TXT		dc.b 	"ERROR: Not enough CHIP memory !.",0
ERRFastMem_TXT		dc.b 	"ERROR: Not enough memory !.",0
ERRProc_TXT			dc.b	"ERROR: No 68020/030/040/060 CPU found.",0
ERRNoCia_TXT		dc.b	"ERROR: Cia timer not found.",0
ERRNoVoiceEx_TXT	dc.b	"ERROR: No voice expander error.",0
ERRNoMainMem_TXT	dc.b	"ERROR: No memory found.",0
ERRNoWindow_TXT		dc.b	"ERROR: Could not open windows (no chip memory).",0
ERRNoVisualInfo_TXT	dc.b	"ERROR: No visualinfo found.",0
ERRNoResMem_TXT		dc.b	"ERROR: No base memory found.",0
ERRNoFileReq_TXT	dc.b	"ERROR: Filerequester not found.",0
ERRNoScrMode_TXT	dc.b	"ERROR: Screenmode requester not found.",0
ERRNoLibs_TXT		dc.b	"ERROR: Library not found.",0
ENoAudioDev			dc.b	"ERROR: Cannot allocate audio.device.",0

MemFail_ERR			dc.b    "Memory Protection Failure."            
					dc.b    " Please reboot as soon as possible !",0
NoUpdateSigtxt		dc.b	"ERROR: No Update Signal",0
GotoInstr_TXT		dc.b	"Instrument Nr (0..255)",0
EasyDOLD			dc.b	"writing to file :",0
EasyDO				dc.b	"reading from file :",0
EasyDWERR			dc.b	"i/o error while writing occured !",0
EasyDRERR			dc.b	"i/o error while reading occured !",0
EasyDOERR			dc.b	"Dos error: Couldn't open file.",0


		even
ERRTXT_AUTOLIBLIST
ERRDOSBASE	dc.b    0,0,0,0,0,37,"dos.library",0
		even
		dc.b	-1
		even


	acode
Resident_AUTOMEM
	;dc.l	CompressorTab_PTR
	dc.l	midimsgbufferPtr
	dc.l	SampleNames_PTR
	dc.l	InstrName_PTR
	dc.l	NormalFREQLIST_PTR
	dc.l	Standard_KEYTRANS+KEYTRANS_FASTFRQTRANS
	dc.l	FileName_PTR
	dc.l	NGGadHGrp_PTR
	dc.l	NGGadInfo_PTR		;8
	dc.l	NGWinList_PTR
	IFNE	TESTPRGB
	;dc.l	NEWStreamPTR
	ENDC	
	IFNE	SQRTFUNC
	;dc.l	SqrtMem_PTR
	ENDC
	dc.l	BuildCT_DATA
	dc.l	Blitmem_PTR
	;dc.l	DoSurroundMix_PTR
	dc.l	OverSample3_PTR
	dc.l	Delta16Buf_PTR
	dc.l	Bit14Tab_PTR
	dc.l	TempAssString
	dc.l	SeqPuffer_PTR		;10

	;dc.l	GadMem_PTR
	;dc.l	GadInfoMem_PTR

	dc.l	AutoMenu_PTR
	dc.l	FileNameRT_PTR
	dc.l	FinalFileNameRT_PTR
	dc.l	AnalyzeMsgRecMem_PTR
	dc.l	TempInstrName_PTR
	dc.l	ScreenTitle_PTR

	dc.l	PattedTxtBuf_PTR
	dc.l	BuildLineINFO_PTR	;$18
	dc.l	SpecBuffer_PTR
	dc.l	Stream9BitTAB_PTR
	dc.l	Test_SAMPLE
	dc.l	ProjectName_PTR
	dc.l	PattedTit_PTR
	dc.l	SinusTab
	dc.l	VibratoTab_PTR
	dc.l	SaVibratoTab_PTR	;20
	dc.l	TremoloTab_PTR

	dc.l	SuperSupportTable_PTR
	dc.l	FLInfo_PTR
	dc.l	PathBuf_PTR
	dc.l	TempProjName
	dc.l	SCANTRANSBIG_PTR
	dc.l	PosLine_TXT		;28
	dc.l	SAMPLEMANLIST_PTR	;29
	dc.l	FirstEntry_INSTR	;2A  len = $2000

	dc.l	CopperList_PTR		;2B
	dc.l	RGB_Table_PTR
	dc.l	ResoSource1Ptr

	IFNE TESTPRGB
	dc.l	dummymem
	dc.l	dummymem2
	dc.l	dummymem3
	dc.l	dummymemc
	dc.l	dummymemc2
	dc.l	dummymemc3
	ENDC
	dc.l	-1


	acode
SuperSupportTable_PTR	dc.l	0,2048,FASTMEM
SampleNames_PTR			dc.l	0,SampleNameMaxLen*MaxNumb_Samples,FASTMEM
FileName_PTR 			dc.l	0,512,PUPMEM
InstrName_PTR 			dc.l	0,512,PUPMEM
TrackBuffer_PTR			dc.l	0,0,FASTMEM
ScreenTitle_PTR			dc.l	0,256,PUPMEM
AutoMenu_PTR			dc.l	0,$5000,PUPMEM
SpriteNULL_PTR			dc.l	0,64,CHIPMEM
CopperList_PTR			dc.l	0,6400,CHIPMEM

RenderBuffer_PTR 		dc.l	0,0,FASTMEM

	IFNE TESTPRGB
dummymem	dc.l	0,$123,FASTMEM
dummymem2	dc.l	0,$1234,FASTMEM
dummymem3	dc.l	0,$12345,FASTMEM
dummymemc	dc.l	0,$123,CHIPMEM
dummymemc2	dc.l	0,$1234,CHIPMEM
dummymemc3	dc.l	0,$12345,CHIPMEM
	ENDC


File_PTR	dc.l	0

	XREF _IntuitionBase

	IFNE	TOCCATA
TOCCATABASE	dc.b	0,0,0,1,0,0,"toccata.library",0		;LOAD ON AVAIL
			even
	ENDC
			dc.b	-1
			even

	XDEF	_SysBase
;	XREF	_IntuitionBase
	XREF	_GraphicsBase
	XREF	_DOSBase
	XREF	_AslBase
;	XREF	_GadToolsBase
	XREF	_LayersBase
	XREF	_ReqToolsBase
	XREF	_CamdBase
	XREF	_XpkBase

	acode
MainScreen_PTR
			dc.l	0
			dc.l	SA_SysFont,1
			dc.l	SA_Title,MainScreen_TXT
DisplayID2_ADR
			dc.l	SA_DisplayID,$00061000!SUPERLACE_KEY
			dc.l	SA_Width,640
			dc.l	SA_Height,400
			dc.l	SA_Depth,2

			dc.l	SA_LikeWorkbench,TRUE
			dc.l	SA_Pens,Main_Pens

MyScreenAutoScroll
			dc.l	SA_AutoScroll,TRUE
MyScreenAutoType
			dc.l	SA_Type,PUBLICSCREEN+AUTOSCROLL

			dc.l	SA_Interleaved,TRUE
			dc.l	SA_PubName,PubScreenName
			dc.l	SA_FullPalette,TRUE
			dc.l	TAG_DONE

MyScreenPubSig
			dc.l	SA_PubSig,0
MyScreenTask
			dc.l	SA_PubTask,0
			dc.l	TAG_DONE

Main_Pens	dc.l	-1,0



	adata
RequesterScreen_PTR	dc.l	0
RQReqStruct_PTR		dc.l	0
SinusTab			dc.l	0,SINUNITS*2,FASTMEM
VibratoTab_PTR		dc.l	0,VIBUNITS*2,FASTMEM
SaVibratoTab_PTR	dc.l	0,SAVIBUNITS*2,FASTMEM
TremoloTab_PTR		dc.l	0,VIBUNITS*2,FASTMEM



	IFNE RENDER
	adata
RenderF_TAB
	dc.l	0,RendForm0,1,RendForm1,2,RendForm2,3,RendForm3,-1,-1
RendMdTypeList
	dc.l	0,"SY48"
	dc.l	1,"SY4A"
	dc.l	2,"SY49"
	dc.l	3,"SY4B"
	dc.l	-1,-1

RendMdTxtList
	dc.l	$800,Rend80
	dc.l	$801,Rend81
	dc.l	$1000,Rend160
	dc.l	$1001,Rend161
	dc.l	-1,-1

RenderBgnStatus	dc.b	"Audio Rendering. Press ESC to abort",0
RenderEnd0		dc.b	"Audio Rendering: Cleaning up... Please wait ...",0
RenderEnd1		dc.b	"Audio Rendering: *** Completed ***",0
Render_SILENCE	dc.b	0
RendERR_TXT		dc.b	"Dos error while writing. Rendering not completed.",0
RenderDone_TXT	dc.b	"*** Rendering Done.",0
Rend_TXT		dc.b	"Select Render File",0
Rend_MATCH		dc.b	"#?",0
RendDos			dc.b	"8 Bit(Unsigned), 16Bit(Order Reversed)",0
Rend80			dc.b	"Resolution: 8 Bit, Mode: Mono",0
Rend81			dc.b	"Resolution: 8 Bit, Mode: Stereo",0
Rend160			dc.b	"Resolution: 16 Bit, Mode: Mono",0
Rend161			dc.b	"Resolution: 16 Bit, Mode: Stereo",0
RendForm0		dc.b	"Format: Raw (HDR,no header)",0
RendForm1		dc.b	"Format: Maestro (HDR)",0
RendForm2		dc.b	"Format: Wave (HDR,PC)",0
RendForm3		dc.b	"Format: Aiff (HDR,IFF)",0
RenderF			dc.b	0

	adata
RenderWaveHead_ADR	dc.l	44
	dc.l	"RIFF",$0001AC74		;FORM, TOTALLENGTH
	dc.l	"WAVE",$666D7420,$10000000
	dc.l	$01000200,$44AC0000,$112B0000,$04001000
	dc.l	"data"
	dc.l	$0001AC00

;RenderMaudHead_ADR	dc.l	$7c
	dc.l	"FORM",$0001AC74		;FORM, TOTALLENGTH
	dc.l	"MAUD","MHDR",$00000020		;MAUDMHDR, HEADLENGTH
	dc.l	$0001AC00,$00080008,$0000BB80,$00010000,$00010000
	dc.l	$00000000,$00000000,$00000000,$414E4E4F,$00000038
	dc.b	"$VER: Rendered with Symphonie Pro 3.3                  ",0
	dc.l	"MDAT",$0001AC00	;SAMPLELENGTH



	ENDC




RenderMaestroHead_ADR	dc.l	24
	dc.b	"MAESTRO",0
	dc.l	$01000200
	dc.l	0
	dc.l	-1,0





GuiPrefsHead
	dc.l	"SYM","PRFS"
	dc.w	PREFSVER
	dc.b	0,0			;VERSION,REVISON, FLAGS, RESERVED
GuiPrefs
	dc.l	PREFS_GUI
	dc.l	PREFBLK,256
	blk.l	64,0
AudioPrefs
	dc.l	PREFS_AUDIO
	dc.l	PREFBLK,256
	blk.l	64,0
StructPrefs
	dc.l	PREFS_STRUCT
	dc.l	PREFBLK,256
	blk.l	64,0
PrefsHead_END
Prefs_SIZE	EQU	PrefsHead_END-GuiPrefsHead

xSAMPLEBOOST_BAK	dc.l	0

	acode
APrefs_MAKELIST
	dc.l	AudioPrefs+12
	dc.l	PREFLPTR,VexBufferNumb		;1..32
	dc.l	PREFLPTR,MAXDSP_ECHO_LEN	;1..255
	dc.l	PREFLPTR,VexQuality

	dc.l	PREFLPTR,xSAMPLEBOOST_BAK
	dc.l	PREFLPTR,PITCHDIFF
	dc.l	PREFLPTR,SAMPLEDIFF
	dc.l	PREFLPTR,KNACKSTEPS
	dc.l	PREFWPTR,VL_PROCVLIMIT
	dc.l	-1				;BUG FIXED

StructPrefs_MAKELIST
	dc.l	StructPrefs+12
	dc.l	PREFLPTR,VexSpeed			
	dc.l	PREFLPTR,VEX_LinesPerPattern
	dc.l	PREFLPTR,VEX_PattNumb
	dc.l	PREFWPTR,CHANNEL_NUMB
	dc.l	-1






SINMAX	EQU	880



	acode
SINTAB
	DC.W 0,8,15,23,31,38,46,54,61,69
	DC.W 77,84,92,100,107,115,122,130,138,145
	DC.W 153,160,168,175,183,190,198,205,213,220
	DC.W 228,235,243,250,257,265,272,279,286,294
	DC.W 301,308,315,323,330,337,344,351,358,365
	DC.W 372,379,386,393,400,406,413,420,427,433
	DC.W 440,447,453,460,466,473,479,486,492,498
	DC.W 505,511,517,523,530,536,542,548,554,560
	DC.W 566,572,577,583,589,595,600,606,611,617
	DC.W 622,628,633,638,644,649,654,659,664,669
	DC.W 674,679,684,689,693,698,703,707,712,716
	DC.W 721,725,730,734,738,742,746,750,754,758
	DC.W 762,766,770,773,777,781,784,788,791,794
	DC.W 798,801,804,807,810,813,816,819,822,824
	DC.W 827,830,832,835,837,839,842,844,846,848
	DC.W 850,852,854,856,857,859,861,862,864,865
	DC.W 867,868,869,870,871,872,873,874,875,876
	DC.W 877,877,878,878,879,879,879,880,880,880
	DC.W 880,880,880,880,879,879,879,878,878,877
	DC.W 877,876,875,874,873,872,871,870,869,868
	DC.W 867,865,864,862,861,859,857,856,854,852
	DC.W 850,848,846,844,842,839,837,835,832,830
	DC.W 827,824,822,819,816,813,810,807,804,801
	DC.W 798,794,791,788,784,781,777,773,770,766
	DC.W 762,758,754,750,746,742,738,734,730,725
	DC.W 721,716,712,707,703,698,693,689,684,679
	DC.W 674,669,664,659,654,649,644,638,633,628
	DC.W 622,617,611,606,600,595,589,583,577,572
	DC.W 566,560,554,548,542,536,530,523,517,511
	DC.W 505,498,492,486,479,473,466,460,453,447
	DC.W 440,433,427,420,413,406,400,393,386,379
	DC.W 372,365,358,351,344,337,330,323,315,308
	DC.W 301,294,286,279,272,265,257,250,243,235
	DC.W 228,220,213,205,198,190,183,175,168,160
	DC.W 153,145,138,130,122,115,107,100,92,84
	DC.W 77,69,61,54,46,38,31,23,15,8
SINTABE
	;SINTAB_UNITS	EQU	(SINTABE-SINTAB)/2
SINTAB_UNITS	EQU	360

PACKHEAD	dc.l	"PACK"
PACKRESULT	dc.w	FALSE		;PACKED ?
		dc.l	0		;ORIGINAL LENGTH
		blk.l	256,0

	;;;	SECTION	ExternalData,DATA


	acode
SAMPLEMANLIST_PTR	dc.l	0,SAMPLEMANE_SIZEOF*MaxNumb_Samples,FASTMEM
FirstEntry_INSTR	dc.l	0,MaxNumb_Samples*INSTR_SIZEOF,FASTMEM

	acode
DSPGUIDefMem
	dc.l	0,0,0,0		;PARAMPTR,PARAMMIN,PARAMMAX
	blk.l	1024,0

LinkFadeRGB32_TEMP	blk.l	100,0


	adata
MMENU_JL
	dc.l	$ffff,SetOldCList
;	dc.l	$ffff,RMButton

	dc.l	$f800,AboutRequest			;INFO
	dc.l	$f820,ShowSongInfoAll


	dc.l	$0001,PlayActualSong			;PLAYER
	dc.l	$0801,PlayActualSeq
	dc.l	$1001,PlayFromActualPos
	dc.l	$1801,PlayActualPattern
	dc.l	$2001,MuteActualTrack
	dc.l	$3001,StopSong2

	dc.l	$0041,DeactivateDsp			;MENUDSP
	dc.l	$1041,DspEcho
	dc.l	$1841,DspCrossEcho
	dc.l	$2041,DspCrossEcho2
	dc.l	$2841,DspCenterEcho
	dc.l	$3041,DspFilter
	dc.l	$4041,DspDelay
	dc.l	$4841,DspCrossDelay
	IFNE	SYMPHPRO
	dc.l	$5041,DspHall
	dc.l	$5841,DspCrossHall
	dc.l	$6041,SelectPostFilter
	;dc.l	$7041,DspChorus
	ELSE
	dc.l	$5041,SelectPostFilter
	;dc.l	$6041,DspChorus
	ENDC

;	dc.l	$1021,SetStereoMode			;AUDIO MODES
	dc.l	$0021,SetOS9Bit
	dc.l	$0821,SetStereo9Mode
	dc.l	$1021,SetOS14Bit			;=14bt
	dc.l	$1821,SetStereo14Mode
	dc.l	$2821,SetMonoMode
	dc.l	$3021,SetMonoSurrMode
	dc.l	$4021,SetLeftSurrMode
	dc.l	$4821,SetRightSurrMode
	;dc.l	$5821,SetExternMode

	dc.l	$f881,QuitActualProject


	IFEQ DEMO
	dc.l	$0003,CutActSeq				;BLOCK
	dc.l	$0803,CopyActSeq
	dc.l	$1003,PasteActSeq

	dc.l	$0023,CutPosition
	dc.l	$0823,CopyPosition
	dc.l	$1023,PastePosition


	dc.l	$0043,CutActualPattern
	dc.l	$0843,CopyPattern
	dc.l	$1043,PastePattern
	dc.l	$2043,PartDupPattern
	dc.l	$2843,ShrinkPattern
	dc.l	$3043,ExpandPattern
	dc.l	$3843,DuplicatePattern

	dc.l	$0063,CutActualTrack
	dc.l	$0863,CopyActualTrack
	dc.l	$1063,PasteActualTrack
	dc.l	$2063,MirrorTrack
	dc.l	$2863,SwapActualTrack
	dc.l	$3063,RotDownTrack
	dc.l	$3863,RotUpTrack




	dc.l	$0083,XXCutActualBlock
	dc.l	$0883,XXCopyActualBlock
	dc.l	$1083,XXPasteActualBlock
	dc.l	$1883,XXAddActualBlock
	dc.l	$2883,ExpandActualBlock
	dc.l	$3083,ClrActualBlock
	dc.l	$3883,XXSwapActualBlock
	dc.l	$00a3,CutActualNote
	dc.l	$08a3,MarkNote
	dc.l	$10a3,PasteActualNote
	dc.l	$20a3,InsertTrackLine	;Note
	dc.l	$28a3,DeleteTrackLine
	dc.l	$00e3,RecordMacro			;MACRO
	dc.l	$08e3,ReplayMacro
	dc.l	$10e3,LoadMacro
	dc.l	$18e3,LoadAndRunMacro
	dc.l	$20e3,SaveMacro
	dc.l	$f923,UndoPattern
	dc.l	$0004,SequenzDwn			;MOVEMENU
	dc.l	$0804,SequenzUp
	dc.l	$1804,MoveFirstSeq
	dc.l	$2004,MoveLastSeq
	dc.l	$0024,KeyPosNumDown
	dc.l	$0824,KeyPosNumUp
	dc.l	$1824,MoveFirstPosition
	dc.l	$2024,MoveLastPosition
	dc.l	$0044,KeyPatNumDown
	dc.l	$0844,KeyPatNumUp
	dc.l	$1844,MoveFirstPattern
	dc.l	$2044,MoveLastPattern
	dc.l	$0064,CrsrTL
	dc.l	$0864,CrsrBR
	dc.l	$1864,CrsrT
	dc.l	$2064,CrsrB



	dc.l	$0025,LoadInstrSetup			;SAMPLES
	dc.l	$0825,SaveInstrSetup
	dc.l	$f845,KillActualInstr
	dc.l	$0085,BuildLineSample
	dc.l	$0885,BuildRowSample
	dc.l	$1085,CloneToLineSample
	dc.l	$1885,BuildNewTransWave
	dc.l	$2885,AutoReCalcLineSamples
	dc.l	$08c5,ReloadInstrSetup
	dc.l	$00c5,SetSamplenamePath
	dc.l	$10c5,ExportSample
	dc.l	$18c5,SelectAdjustVol
	dc.l	$20c5,PrepareCDDA

	dc.l	$0002,LoadActualProject			;FILEMENU
	dc.l	$0802,SaveActualProjectAs
	dc.l	$1002,SaveActualProject

;	dc.l	$2002,ImportSongContent

	dc.l	$0822,SaveActualModule
	dc.l	$1022,SelectModuleDiz
	dc.l	$1822,ExtractActualModule
	dc.l	$2022,ExtractActual8Bit
	dc.l	$2822,ExtractSetQuality
	dc.l	$3822,SelectModuleDiz2

	dc.l	$0062,TooglePackSong
	dc.l	$0862,ToogleModDeltaWrite
	ENDC


	dc.l	$f805,LoadNewSample
	dc.l	$0022,LoadActualModule


	dc.l	$0042,LoadPrefs				;PREFS LOAD
	dc.l	$0842,SavePrefsAs
	dc.l	$1042,SavePrefs
	dc.l	$2042,TAudioPrefs
	dc.l	$2842,TVideoPrefs
	dc.l	$3042,TStructPrefs

	dc.l	$0006,SelectBufferNumb			;PREFS
	dc.l	$0806,SetMaxDspBuffer
	IFNE	SYMPHPRO
	IFNE	RENDER
	dc.l	$1006,ReqFileBLen
	ENDC
	dc.l	$2006,SetNoiseLimit
	ELSE	
	dc.l	$1806,SetNoiseLimit
	ENDC

	dc.l	$0026,ToogleNoPosChange			;REALTIME
	dc.l	$0826,ToogleNoScroll
	dc.l	$1026,ToogleNoSpectrum
	dc.l	$1826,ToogleNoScopes
	dc.l	$2026,ToogleNoInstr
	dc.l	$3026,ToogleForceUpdate
	dc.l	$4026,ToogleAutoActWindow

	IFNE MIDILIB
	dc.l	$0046,InitMidi				;MIDI
	dc.l	$0846,SetMidiChannel
	ENDC


	IFEQ DEMO
	dc.l	$0066,SetEditJump		;PED
	ENDC
	dc.l	$0866,SetEditPunch
	dc.l	$1066,ToogleSoloMode
	dc.l	$2066,ToogleSetNoteP
	dc.l	$2866,ToogleSetNoteI
	dc.l	$3066,ToogleSetNoteV

	dc.l	$0086,ToogleKeepPatternMumb	;LOAD SONG/MOD
	dc.l	$0886,ToogleSongConv

	dc.l	$00a6,SetKnackDeepth		;SAMPLE PREPROCESSOR
	dc.l	$08a6,SetSampleBoost
	dc.l	$10a6,SetSamplePreOverS
	dc.l	$18a6,SetNoiseFilter
	dc.l	$28a6,ToogleForceAKnack
	dc.l	$30a6,ToogleLinVol

	dc.l	$0c6,SetStSampleDiff		;STEREO
	dc.l	$8c6,SetStPitchDiff
	dc.l	$10c6,SetFadeToSteps
	

	dc.l	$0e6,ToogleGUILook		;GUI
	;dc.l	$8e6,ToogleGADLook
	dc.l	$10e6,ToogleFASTGFX
	dc.l	$18e6,ChangeScreenMode


	IFNE DIRECTAMIGAAUDIO
	dc.l	$f827,EnterColorOrgan		;ColorOrgan
	dc.l	$f807,SetOldCList
	ENDC
	dc.l	-1

MRAWKEY_JL
	dc.l	$46,KbdDownInstr
	dc.l	$5f,KbdUpInstr

	IFNE DIRECTAMIGAAUDIO
	dc.l	$55,EnterColorOrgan	;F6
	ENDC
	dc.l	$59,KbdLoadNewSample	;F10

	dc.l	$54,PlayActualSong	;F5
	dc.l	$53,PlayActualSeq	;F4
	dc.l	$52,PlayFromActualPos	;F3
	dc.l	$51,PlayActualPattern	;F2
	dc.l	$45,StopSong2		;ESC



	IFNE SMALLGUI			;Special Commands for player
	dc.l	$40,PlayActualSong
	dc.l	$44,LoadActualModule
	dc.l	$4e,PlayNextPosition
	dc.l	$4f,PlayPrevPosition
	dc.l	$4c,LoadActualModule
	ENDC


	IFEQ DEMO
	dc.l	$58,KeySwapRecordState	;F9

	dc.l	$4e,KbdCrsrRight
	dc.l	$4f,KbdCrsrLeft
	dc.l	$4c,KbdCrsrUp
	dc.l	$4d,KbdCrsrDown

	dc.l	$50,MuteActualTrack	;F1
	dc.l	$40,KbdSpace		;SPACE
	dc.l	$5c,KbdPatNumDown
	dc.l	$5d,KbdPatNumUp
	dc.l	$3c,KbdDeleteTrackLine
	dc.l	$f,KbdInsertTrackLine
	dc.l	$c2,SetTab		;TAB

	dc.l	$44,KbdReturn			;RETURN
	dc.l	$2f,KbdNoteInstrUp		;NUM 9
	dc.l	$3f,KbdNoteInstrDown		;NUM 6
	dc.l	$2e,KbdPitchUp			;NUM 8
	dc.l	$3e,KbdPitchDown		;NUM 5
	dc.l	$4a,KbdVolumeDown		;NUM -
	dc.l	$5e,KbdVolumeUp			;NUM +
	ENDC

	dc.l	$5a,KbdPosNumDown
	dc.l	$5b,KbdPosNumUp
	dc.l	-1
NIL_JL	dc.l	-1


	acode
NGGadActionList
	;--- EVENT EDITOR ---
	IFEQ DEMO
	NGjmp	"EE05",LCom
	NGjmp	"EE06",SCom
	NGjmp	"EE15",LPCom
	NGjmp	"EE16",SPCom
	NGjmp	"EE25",LICom
	NGjmp	"EE26",SICom
	NGjmp	"EE35",LVCom
	NGjmp	"EE36",SVCom

	NGjmp	"EE42",SetKeyOff			;Event
	NGjmp	"EE43",SetFxDspOn
	NGjmp	"EE44",SetFxDspDelay
	NGjmp	"EE45",SetFxSetSpeed
	NGjmp	"EE46",SetFxCVol
	NGjmp	"EE47",SetFxFilter


	NGjmp	"EE5A",FXSetPitch
	NGjmp	"EE52",SetPSlideDown
	NGjmp	"EE53",SetPSlideUp
	NGjmp	"EE54",SetFxSetADDPITCH
	NGjmp	"EE55",SetFxTrem
	NGjmp	"EE56",SetFxSetADDHALVTONE
	NGjmp	"EE57",SetFxPSlideTo
	NGjmp	"EE58",FXPitchDown
	NGjmp	"EE59",FXPitchUp

	NGjmp	"EE62",SetFxFromP
	NGjmp	"EE63",SetFxSetFromAdd
	NGjmp	"EE64",SetFxFromAdd
	NGjmp	"EE65",SetFxSampleVib
	NGjmp	"EE66",SetFxPlayFrom
	NGjmp	"EE67",SetFxRetrig

	NGjmp	"EE71",SetVolume
	NGjmp	"EE72",SetVolSlideDown
	NGjmp	"EE73",SetVolSlideUp
	NGjmp	"EE74",SetFxSetADDVOL
	NGjmp	"EE75",SetFxVibrato
	NGjmp	"EE76",SetStopSample
	NGjmp	"EE77",SetContSample
	NGjmp	"EE78",SetFxVFadeIn

	NGjmp	"EE03",SetNoneFX
	NGjmp	"EE04",EventEDLock
	NGjmp	"EE84",MEventSet

	NGjmp	"EE12",PitchDown
	NGjmp	"EE13",PitchUp
	NGjmp	"EE14",EditPitch
	NGjmp	"EE22",NoteInstrDown
	NGjmp	"EE23",NoteInstrUp
	NGjmp	"EE24",SetNoteInstr
	NGjmp	"EE32",VolumeDown
	NGjmp	"EE33",VolumeUp
	NGjmp	"EE34",EditVolume

	NGjmp	"EE81",MEventMin
	NGjmp	"EE83",MEventMax
	NGjmp	"EE86",MEventQuantize
	NGjmp	"EE89",EventMSwapV
	NGjmp	"EE87",EventMSwapP
	NGjmp	"EE88",EventMSwapI
	ENDC

	;--- Song Editor : SEQUENCE ---	
	IFEQ DEMO
	NGjmp	"SE20",SequenzDwn
	NGjmp	"SE21",SequenzUp
	NGjmp	"SE22",CopyActSeq
	NGjmp	"SE23",CutActSeq
	NGjmp	"SE24",PasteActSeq
	NGjmp	"SE25",DupActSeq
	NGjmp	"SE26",DelActSeq
	;NGjmp	"SE27",SequenzPlay
	;NGjmp	"SE28",SequenzSkip
	;NGjmp	"SE29",SequenzLast
	NGjmp	"SE30",ActSeqStartDown
	NGjmp	"SE31",ActSeqStartUp
	NGjmp	"SE32",ActSeqTuneDwn
	NGjmp	"SE33",ActSeqTuneUp
	NGjmp	"SE34",ActSeqLenDown
	NGjmp	"SE35",ActSeqLenUp
	NGjmp	"SE36",ActSeqLoopDown
	NGjmp	"SE37",ActSeqLoopUp


	NGjmp	"SE40",KeyPosNumDown
	NGjmp	"SE41",KeyPosNumUp
	NGjmp	"SE42",KeyPatNumDown
	NGjmp	"SE43",KeyPatNumUp
	NGjmp	"SE44",CopyPosition
	NGjmp	"SE45",DuplicatePosition
	NGjmp	"SE46",PastePosition
	NGjmp	"SE47",ClearPosition
	NGjmp	"SE48",InsertPosition
	NGjmp	"SE49",DeletePosition

	NGjmp	"SE50",StartPosDown
	NGjmp	"SE51",StartPosUp
	NGjmp	"SE52",PosTuneDown
	NGjmp	"SE53",PosTuneUp
	NGjmp	"SE54",TrackLenDown
	NGjmp	"SE55",TrackLenUp
	NGjmp	"SE56",LoopDown
	NGjmp	"SE57",LoopUp
	NGjmp	"SE58",SpeedDown
	NGjmp	"SE59",SpeedUp
	ENDC


	;--- SCOPE ---
	NGjmp	"TSC1",SetScopeFrames
	NGjmp	"TSC2",SetScopeTest

	;--- SONG ---
	IFEQ DEMO
	NGjmp	"SE01",SwapRecordState
	NGjmp	"SE02",LoadActualProject
	NGjmp	"SE03",SaveActualProjectAs
	NGjmp	"SE04",SaveActualProject
	NGjmp	"SE05",LoadActualModule
	NGjmp	"SE10",KillActualProject
	NGjmp	"SE11",SetCPatLen
	NGjmp	"SE12",SetCPatNumb
	ENDC
	NGjmp	"SE05",LoadActualModule


	;--- INSTUMENT EDITOR -----------------------------------

	IFEQ DEMO
	NGjmp	"WV01",SetInstrNr
	NGjmp	"WV02",DownInstr
	NGjmp	"WV03",UpInstr
	NGjmp	"WV04",ReMakeSample
	NGjmp	"WV05",LoadNewSample
	NGjmp	"WV06",SetSampleVol
	NGjmp	"WV07",SetSampleVol
	NGjmp	"WV0H",SetSampleVolFade



	NGjmp	"WV09",SetSimpleInstr
	NGjmp	"WV0A",SetLoopedInstr
	NGjmp	"WV0B",SetSustainedInstr
	NGjmp	"WV0C",ToogleIFastPlay
	NGjmp	"WV0D",ToogleINoDsp
	NGjmp	"WV0E",ToogleIPosTune
	NGjmp	"WV0F",SetSilentInstr
	NGjmp	"WV0G",KillActualInstr
;
;	NGjmp	RangeClr,RangeLoop
;	IFNE	SPECIAL
;	NGjmp	BuildTransSample
;	ENDC

	NGjmp	"WV11",BuildLineSample
	NGjmp	"WV12",CloneToLineSample
	NGjmp	"WV13",BuildRowSample
	NGjmp	"WV16",SetRvsLineSample
	NGjmp	"WV17",SetMirrSample
	NGjmp	"WV19",SetDownSample
	NGjmp	"WV1C",SetFilter
	NGjmp	"WV1D",SetFilter2



	NGjmp	"WV22",InstrFineTuneDown
	NGjmp	"WV23",InstrFineTuneUp
	NGjmp	"WV25",InstrTuneDown
	NGjmp	"WV26",InstrTuneUp
	NGjmp	"WV29",LoopSmaller
	NGjmp	"WV2A",LoopLarger
	NGjmp	"WV2C",LoopLeft
	NGjmp	"WV2D",LoopRight
	NGjmp	"WV2G",InstrLoopNumbDown
	NGjmp	"WV2H",InstrLoopNumbUp
	NGjmp	"WV2I",SyncLoop
	ENDC



	;--- PATTERN EDITOR ---
	IFEQ DEMO
	NGjmp	"XnIU",NoteInstrUp			;NUM 9
	NGjmp	"XnID",NoteInstrDown			;NUM 6
	NGjmp	"XnPU",PitchUp				;NUM 8
	NGjmp	"XnPD",PitchDown			;NUM 5
	NGjmp	"XnVU",VolumeUp				;NUM +
	NGjmp	"XnVD",VolumeDown			;NUM -

	NGjmp	"XmXB",CutActualBlock
	NGjmp	"XmCB",CopyActualBlock
	NGjmp	"XmVB",PasteActualBlock
	NGjmp	"XmBB",AddActualBlock
	NGjmp	"XmEB",SwapActualBlock

	NGjmp	"PE02",KeyPatNumDown
	NGjmp	"PE03",KeyPatNumUp
	NGjmp	"PE14",KeybTuneD
	NGjmp	"PE15",KeybTuneU
	NGjmp	"PE04",MarkNote
	NGjmp	"PE05",MarkTrack
	NGjmp	"PE06",MarkPattern
	NGjmp	"PE07",MarkBlock

	NGjmp	"PE08",CopyActualBlock
	NGjmp	"PE09",CutActualBlock
	NGjmp	"PE0A",PasteActualBlock

	NGjmp	"PE0B",DuplicateBlock
	NGjmp	"PE0C",AddActualBlock
	NGjmp	"PE0D",ShrinkActualBlock
	NGjmp	"PE0E",ExpandActualBlock
	NGjmp	"PE0F",MirrorActualBlock
	NGjmp	"PE0G",LoadActualBlock
	NGjmp	"PE0H",SaveActualBlock




	NGjmp	"PE10",ToogleViewDetail
	NGjmp	"PE11",LockPattern
	NGjmp	"PE18",RotateDBlock
	NGjmp	"PE17",RotateUBlock
	NGjmp	"PE1A",PitchDownActualBlock
	NGjmp	"PE1B",PitchUpActualBlock
	NGjmp	"PE1D",InstrDownActualBlock
	NGjmp	"PE1E",InstrUpActualBlock
	NGjmp	"PE1G",VolumeDownActualBlock
	NGjmp	"PE1H",VolumeUpActualBlock
	NGjmp	"PE1I",RecordMacro
	NGjmp	"PE1J",ReplayMacro
	ENDC

	;--- SYSTEM CONTROL ---
	NGjmp	"SY21",StopSong2
	NGjmp	"SY22",PlayActualPattern
	NGjmp	"SY23",PlayFromActualPos
	NGjmp	"SY24",PlayActualSeq
	NGjmp	"SY25",PlayActualSong

	NGjmp	"SY31",MVolMax
	NGjmp	"SY35",MBalMax
	NGjmp	"SY3e",MPitMax
	NGjmp	"SY3c",MBalSet
	NGjmp	"SY3b",MVolSet
	NGjmp	"SY3d",MPitSet
	;NGjmp	"SY32",MVolD
	;NGjmp	"SY33",MVolU
	;NGjmp	"SY36",BalD
	;NGjmp	"SY37",BalU
	NGjmp	"SY3A",QualityDown
	NGjmp	"SY3B",QualityUp
	NGjmp	"SY3E",SystemSpeedDown
	NGjmp	"SY3F",SystemSpeedUp
	NGjmp	"SY81",SetStPitchDiff
	NGjmp	"SY85",SetStSampleDiff

	IFEQ DEMO
	NGjmp	"SY11",SetEightVoices
	NGjmp	"SY12",SetSixteenVoices
	NGjmp	"PE1N",VolumeFadeBlock

	NGjmp	"SY13",SetThirtytwoVoices
	IFEQ AMINETDEMO
	NGjmp	"SY14",SetSixtyFourVoices
	NGjmp	"SY15",Set128Voices
	NGjmp	"SY16",Set256Voices

	IFNE RENDER
	;--- RENDER SECTION ---
	NGjmp	"SY40",PlayRendSong
	NGjmp	"SY41",Rend8B
	NGjmp	"SY42",Rend16
	NGjmp	"SY43",RendMo
	NGjmp	"SY44",RendSte
	NGjmp	"SY45",RendMSDos
	;NGjmp	"SY46",ToogleOS3
	NGjmp	"SY48",RendFRaw
	NGjmp	"SY49",RendFWave
	NGjmp	"SY4B",RendFMaud
	NGjmp	"SY4A",RendFMaestro
	NGjmp	"SY4C",SelectHQ
	ENDC	;AMINETDEMO
	ENDC	;RENDER
	ENDC	;DEMO

	;--- DSP SECTION ---
	NGjmp	"SY82",PitchDiffD
	NGjmp	"SY83",PitchDiffU

	NGjmp	"SY86",SampleDiffD
	NGjmp	"SY87",SampleDiffU

	NGjmp	"SY53",EchoLenDown
	NGjmp	"SY54",EchoLenUp
	NGjmp	"SY57",EchoLvlD
	NGjmp	"SY58",EchoLvlU


	NGjmp	"SY63",DelayD
	NGjmp	"SY64",DelayU
	NGjmp	"SY67",DelayD2
	NGjmp	"SY68",DelayU2

	IFEQ AMINETDEMO
	NGjmp	"SY73",HallD
	NGjmp	"SY74",HallU
	NGjmp	"SY77",HallD2
	NGjmp	"SY78",HallU2
	ENDC


	IFEQ DEMO
	NGjmp	"SY91",DSPPlugLoad
	NGjmp	"SY92",DSPPlugOn
	NGjmp	"SY93",DSPPlugOff

	NGjmp	"SY96",DSPParamPrev
	NGjmp	"SY97",DSPParamNext
	NGjmp	"SY99",DSPParamDown
	NGjmp	"SY9A",DSPParamUp
	NGjmp	"PE1K",LoadMacro
	NGjmp	"PE1L",SaveMacro
	NGjmp	"PE1M",LoadAndRunMacro

	;ToogleLPFilter

	NGjmp	"SE2A",SelectSequenceType
	NGjmp	"WV08",SelectLoopType
	NGjmp	"SY59",SelectDspEcho
	NGjmp	"SY69",SelectDspDelay
	NGjmp	"SY79",SelectDspHall


	NGjmp	"WV2J",ChangeWaveStyle
	NGjmp	"WV1E",SetResoFilter
	ENDC
	

	IFEQ DEMO
	NGjmp	"XXCU",CrsrUp			;for Macro
	NGjmp	"XXCD",CrsrDown
	NGjmp	"XXCL",CrsrLeft
	NGjmp	"XXCR",CrsrRight

	NGjmp	"XXIL",InsertTrackLine
	NGjmp	"XXIS",DeleteTrackLine
	NGjmp	"XXNS",LoadNewSample
	NGjmp	"XXID",DownInstr
	NGjmp	"XXIU",UpInstr

	NGjmp	"XXSP",Space
	NGjmp	"XXRT",MarkBlock

	NGjmp	"XXPD",KeyPosNumDown
	NGjmp	"XXPU",KeyPosNumUp
	NGjmp	"XXpD",KeyPatNumDown
	NGjmp	"XXpU",KeyPatNumUp
	ENDC

	IFNE SMALLGUI
	NGjmp	"PL01",ShowSongInfoAll
	NGjmp	"PL03",PlayPrevPosition
	NGjmp	"PL04",PlayNextPosition
	ENDC

	IFNE TESTPRGB
	NGjmp	"TEST",JMPTEST

	ENDC

	dc.l	0,0,0,0
	;--- END OF JUMP LIST --------------------------------


NGWIN_SCOPE	EQU	"SCOP"
NGWIN_PED	EQU	"PTED"
NGWIN_EED	EQU	"EVED"
NGWIN_CONTROL	EQU	"CTRL"



	adata
EFXList	
		dc.l	EFX1,EFX2,EFX3,EFX4,EFX5,EFX6,EFX7,EFX8,EFX9,EFX10
		dc.l	EFX11,EFX12,EFX13,EFX14,EFX15,EFX16,EFX17,EFX18,EFX19,EFX20
		dc.l	ENone,ENone,EFX23,EFX24,EFX25,EFX26

ENone		dc.l	EDrawNone,EDrawNone,EDrawNone
		dc.b	"No Event    ",0,"------",0,"------",0,"------",0
		even

EKeyOn		dc.l	DrawNotePitch,EVENTDrawDecByte,DrawDecByte6
		dc.b	"Key On      ",0,"Pitch ",0,"Instr ",0,"Volume",0
		even

EFX1		dc.l	EDrawNone,EDrawNone,DrawDecByte6
		dc.b	"VSlide Up   ",0,"------",0,"------",0,"Speed ",0
		even
EFX2		dc.l	EDrawNone,EDrawNone,DrawDecByte6
		dc.b	"VSlide Down ",0,"------",0,"------",0,"Speed ",0
		even
EFX3		dc.l	EDrawNone,EDrawNone,DrawDecByte6
		dc.b	"PSlide Up   ",0,"------",0,"------",0,"Speed ",0
		even
EFX4		dc.l	EDrawNone,EDrawNone,DrawDecByte6
		dc.b	"PSlide Down ",0,"------",0,"------",0,"Speed ",0
		even
EFX5		dc.l	DrawFromPi,DrawFromInstr,DrawPerHexXY
		dc.b	"ReplaySaFrom",0,"(Ptch)",0,"(Inst)",0,"Sa.Pos",0
		even
EFX6		dc.l	DrawNotePitch,DrawDecByte6,DrawPerHexXY
		dc.b	"SaFrom&Pitch",0,"Pitch ",0,"Instr ",0,"Sa.Pos",0
		even
EFX7		dc.l	EDrawNone,DrawDecByte6,DrawPerHexXY
		dc.b	"SaFromOffset",0,"------",0,"------",0,"Sa.Pos",0
		even
EFX8		dc.l	EDrawNone,DrawDecByte6,DrawFx8V
		dc.b	"ModifyFOffst",0,"------",0,"------",0,"FinePo",0
		even
EFX9		dc.l	EDrawNone,EDrawNone,DrawDecByte6
		dc.b	"Set Speed   ",0,"------",0,"------",0,"Cycl  ",0
		even
EFX10		dc.l	EDrawNone,EDrawNone,DrawFx12V
		dc.b	"Add Pitch   ",0,"------",0,"------",0,"Intens",0
		even
EFX11		dc.l	EDrawNone,EDrawNone,DrawFx11V
		dc.b	"Add Volume  ",0,"------",0,"------",0,"Intens",0
		even
EFX12		dc.l	EDrawNone,DrawDecByte6,DrawPerHexXY
		dc.b	"Tremolo     ",0,"------",0,"Speed ",0,"Rate  ",0
		even
EFX13		dc.l	EDrawNone,DrawDecByte6,DrawPerHexXY
		dc.b	"Vibrato     ",0,"------",0,"Speed ",0,"Rate  ",0
		even
EFX14		dc.l	EDrawNone,DrawDecByte6,DrawPerHexXY
		dc.b	"SamplePtrVib",0,"------",0,"Speed ",0,"Rate  ",0
		even
EFX15		dc.l	DrawNotePitch,DrawDecByte6,DrawDecByte6
		dc.b	"PitchSlideTo",0,"Pitch ",0,"Instr ",0,"Speed ",0
		even
EFX16		dc.l	EDrawNone,DrawDecPlus1,DrawDecByte6
		dc.b	"Retrig      ",0,"------",0,"Cycl  ",0,"Number",0
		even
EFX17		dc.l	DrawDecByte6,DrawDecByte6,DrawDecByte6
		dc.b	"ShOfEmphasis",0,"Start%",0,"End%  ",0,"Type  ",0
		even
EFX18		dc.l	EDrawNone,EDrawNone,DrawEVCV
		dc.b	"Add HalvTone",0,"------",0,"------",0,"Offset",0
		even
EFX19		dc.l	DrawCVIdXY,DrawDecByte6,DrawEVCV	;DrawSignDecByte6
		dc.b	"Channel Vol ",0,"Type  ",0,"Pos   ",0,"Ampl  ",0
		even
EFX20		dc.l	DrawSignDecByte6,DrawSignDecByte6,DrawSignDecByte6
		dc.b	"Illegal     ",0,"Red   ",0,"Green ",0,"Blue  ",0
		even
EFX23		dc.l	EDrawFilterID,DrawDecByte6,DrawDecByte6
		dc.b	"ResoFilter  ",0,"Type  ",0,"Reso  ",0,"Freq  ",0
		even
EFX24		dc.l	DrawDspFxXY,DrawEVEchoLvl,DrawDecByte6
		dc.b	"Dsp Echo    ",0,"",0,"Level ",0,"Len   ",0
		even
EFX25		dc.l	DrawDspFxXY,DrawEVDelayLvl,DrawDecByte6
		dc.b	"Dsp Delay   ",0,"",0,"Level ",0,"Len   ",0
		even
EFX26		dc.l	DrawDspFxXY,DrawDecByte6,DrawDecByte6
		dc.b	"Dsp Chorus  ",0,"",0,"Level ",0,"Len   ",0
		even

EVibrato	dc.l	EDrawNone,DrawDecByte6,DrawPerHexXY
		dc.b	"Vibrato     ",0,"------",0,"Speed ",0,"Rate  ",0
		even

ETremolo	dc.l	EDrawNone,DrawDecByte6,DrawPerHexXY
		dc.b	"Vibrato     ",0,"------",0,"Speed ",0,"Rate  ",0
		even

ESimpleFX	dc.l	EDrawNone,EDrawNone,DrawNoteVolume
		dc.b	"Simple FX   ",0,"------",0,"------",0,"FX ID ",0


PrefsDir_TXT		dc.b	"ENVARC:",0

	IFNE DEMO
TempPrefs_TXT		dc.b	"ENVARC:SymPlayer NGTmp.prefs",0
	ELSE
TempPrefs_TXT		dc.b	"ENVARC:Symphonie NGTmp.prefs",0
	ENDC







	;--- ENCODE START --------------------------------------------
	dc.b	"XAXA"
Encode_START


	adata
AdjustVol	dc.l	0
AdjustVol_TXT	dc.b	"Volume Adjust (1..200%)",0


	adata
CVId_TXT	dc.b	"----  ",0,0
		dc.l	0,"Set "
		dc.l	1,"Fade"
		dc.l	2,"FaTo"
		dc.l	3,"FaLn"
		dc.l	4,"Pan "
		dc.l	4
CVId_ill	dc.l	"Illg"
		dc.l	-1,-1
		dc.b	0,0,0,0	;unused


		dc.b	0
ValueText6	dc.b	"---   ",0
None_TXT	dc.b	"-     ",0	



Note_TXT	dc.b	"--- --- -",0
NoteNameB_TAB	dc.b	"C C#D D#E F F#G G#A A#H I J K L M N O P Q R S T U V W X Y Z"

	acode
FXDraw_CONVERTAB:
	dc.l	FX_VOLUMESLIDEUP,"VslU"
	dc.l	FX_VOLUMESLIDEDOWN,"VslD"
	dc.l	FX_PITCHSLIDEUP,"PslU"
	dc.l	FX_PITCHSLIDEDOWN,"PslD"
	dc.l	FX_REPLAYFROM,"From"
	dc.l	FX_FROMANDPITCH,"Fr&P"
	dc.l	FX_SETFROMADD,"FSET"
	dc.l	FX_FROMADD,"FADD"
	dc.l	FX_SETSPEED,"Cyl="
	dc.l	FX_ADDPITCH,"PIT+"
	dc.l	FX_ADDVOLUME,"VOL+"
	dc.l	FX_DSPECHO,"ECHO"
	dc.l	FX_DSPDELAY,"DELY"
	dc.l	FX_DSPCHOR,"CHOR"
	dc.l	FX_VIBRATO,"TREM"
	dc.l	FX_TREMOLO,"VIBR"
	dc.l	FX_SAMPLEVIB,"SaVI"
	dc.l	FX_PSLIDETO,"->PI"
	dc.l	FX_RETRIG,"TRIG"
	dc.l	FX_ADDHALVTONE,"ADHT"
	dc.l	FX_EMPHASIS,"EMPH"	;shift of emphasis
	dc.l	FX_CV,"CV ="
	dc.l	FX_CVADD,"CV +"
	dc.l	FX_FILTER,"FILT"
	dc.l	-1,-1

PEDSiFx_CONVTAB
	dc.b	0,0,0,VOLUME_PITCHUP,"PU ",0
	dc.b	0,0,0,VOLUME_PITCHUP2,"PU2",0
	dc.b	0,0,0,VOLUME_PITCHUP3,"PU4",0
	dc.b	0,0,0,VOLUME_PITCHDOWN,"PD ",0
	dc.b	0,0,0,VOLUME_PITCHDOWN2,"PD2",0
	dc.b	0,0,0,VOLUME_PITCHDOWN3,"PD4",0
	dc.b	0,0,0,VOLUME_STOPSAMPLE,"OFF",0
	dc.b	0,0,0,VOLUME_CONTSAMPLE,"ON ",0
	dc.b	0,0,0,VOLUME_KEYOFF,"Kof",0
	dc.b	0,0,0,VOLUME_SPEEDUP,"SpU",0
	dc.b	0,0,0,VOLUME_SPEEDDOWN,"SpD",0
	dc.b	0,0,0,248,"PIT",0
	dc.l	-1,-1


	acode
MKperiodconv		dc.w	856,808,762,720,678,640,604,570,538,508,480,453
			dc.w	428,404,381,360,339,320,302,285,269,254,240,226
			dc.w	214,202,190,180,170,160,151,143,135,127,120,113
			dc.w	-1

	acode
IFF_HEAD		;8Bit Stereo
			dc.l	"FORM",$00008DBC
			dc.l	"8SVX","VHDR"
			dc.l	$14,$000046A8,$00000000
			dc.l	$00000020,$8D3D0100,$00010000
			dc.l	"NAME",$14
			dc.b	"Conv. by  Symphonie",0
			dc.l	"ANNO",$14
			dc.b	"- Unknown -        ",0
			dc.l	"CHAN",4,6
IFF_HEAD1
			dc.l	"BODY",$00008D50
IFF_HEADE

WAVfact_TXT		dc.b	">>> Warning: Non Professional 16 Bit QUALITY-LOSS packed.",0
IllegalSLen_TXT		dc.b	">>> Warning: File corrupt, illegal length detected.",0
NameFormat_TXT		dc.b	"*** WAV  FORMAT *** "
aifformat_TXT		dc.b	"16 BIT, "
			dc.b	"STEREO",0

body_TXT		dc.b	"Body found",0
WaveCHNK_ID		dc.b	"----",0
MODULE_SONGTYPE		dc.b	FALSE



NoNote_TXT		dc.b	"---",0	
FinalNote_TXT		dc.b	"C 0",0	
NoteName_TAB		dc.b	"C C#D D#E F F#G G#A A#H I J K L M N O P Q R S T U V W X Y Z"

;HQMode_TXT		dc.b	"High Quality Math:"
;HQMode_TXT2		dc.b	"    ",0
;RenderHQ		dc.b	0

	IFEQ AMINETDEMO
DspBuffer_TXT		dc.b	"Max Dsp Buffers (16..255)",0
	ELSE
DspBuffer_TXT		dc.b	"Max Dsp Buffers (16..24)",0
	ENDC

	IFNE OS3
OS3_TXT			dc.b	"Oversample Layer III"
OS3_TXTc		dc.b	" :"
OS3_TXTb		dc.b	"----",0
	ENDC


	IFEQ	LOCALDIR
SongDir_TXT		dc.b	"SAMP:Songs",0
ModuleDir_TXT		dc.b	"SAMP:Modules",0
SampleDir_TXT		dc.b	"SAMP:",0
	ELSE
SongDir_TXT		dc.b	"Songs",0
ModuleDir_TXT		dc.b	"Modules",0
SampleDir_TXT		dc.b	"Samples",0
	ENDC


NGtxt			dc.b	"* NG Sampleboost",0
Command_TXT		dc.b	"SYS:Utilities/Multiview WINDOW PUBSCREEN=SymphonieEditor "
TempDizName		dc.b	"t:SONGINFO",0
Macro_MATCH		dc.b	"#?.SymMACRO",0
UnpackedName		dc.b	"t:tempunpack_symmod",0
DeleteTempXPKFile	dc.b	FALSE
AUTOLOADSAMPLE		dc.b	TRUE
ProjMod_TXT		dc.b	"MOD  ",0
ProjSong_TXT		dc.b	"SONG  ",0
LineSampleDef_Txt	blk.b	256,0				;BUG FIXED 3.3d
	even

Prefs_MATCH		dc.b	"#?.prefs",0
Block_MATCH		dc.b	"#?.SymBLK",0

DSPPLUG_MATCH		dc.b	"#?.SymDSP",0
Song_EXT		dc.b	".SymSONG",0
SampleList_EXT		dc.b	".SymSAMP",0
SongData_EXT		dc.b	".SymSDTA",0
SongSeq_EXT		dc.b	".SymSEQ",0
SoundModule_EXT		dc.b	".SymMOD",0
MK_Name			dc.b	"t:Sample A",0
Ex8Bit			dc.b	FALSE
Song_MATCH		dc.b	"#?.SymSONG",0
SampleList_MATCH	dc.b	"#?.SymSAMP",0
SongData_MATCH		dc.b	"#?.SymSDTA",0
SongSeq_MATCH		dc.b	"#?.SymSEQ",0
SoundModule_MATCH	dc.b	"#?MOD#?",0
All_MATCH		dc.b	"#?",0
NoMod_TXT		dc.b	"No PT Mod Format",0
PTMod_TXT		dc.b	"*** PT Mod Format - Loading and converting.",0
MKFORMAT		dc.b	FALSE
EasyDWBuf_STATUS	dc.b	0	;0=run, -1=allocate first
CommandPic_TXT		dc.b	"c:Visage WBMONITOR t:SONGINFO",0

PosListtitle		dc.b	"POS PAT BGN LEN LOOP CYL TRN",0

	IFEQ AMINETDEMO
SetEx8bQuality_TXT	dc.b	"Conversion Depth (4..8) Bit",0
	ENDC

	IFNE RENDER
RBufLen_TXT		dc.b	"Render Buffer (8..10000 KB)",0	
	ENDC

PlayRen_TXT		dc.b	"Audio Rendering... please wait.",0
SmoothStatus		dc.b	0


EventED_STATUS		dc.b	FALSE
PED_ViewDetail		dc.b	0

	acode
SYSVOLOLD		dc.b	100,0
SYSVOL			dc.b	100,0
			dc.b	50,0

SetNote_PREFS		dc.b	0,0

Loopactive		dc.b	FALSE
DSPPlug_INMEM		dc.b	FALSE

;TocErr			dc.b	"Toccata signaled an error.",0
;NoToc			dc.b	"No Toccata available.",0
;ExternMode		dc.b	0




FromPi_FLAG	dc.b	0
DrawFromPi_TXT	dc.b	"DoI",0
DrawFromPi_TXT2	dc.b	"Off",0


	IFNE POLISH
SEQPlay_TXT	dc.b	"Play",0
SEQSkip_TXT	dc.b	"Skip",0
SEQLast_TXT	dc.b	"End ",0
	ELSE
SEQPlay_TXT	dc.b	"Odtwarzaj",0
SEQSkip_TXT	dc.b	"Przeskocz",0
SEQLast_TXT	dc.b	"Koniec ",0
	ENDC



	IFNE POLISH
DspTextList	dc.b	"Off   ",0
		dc.b	"Norm  ",0
		dc.b	"Cross ",0
		dc.b	"Cross2",0
		dc.b	"Center",0
DspTextIll_TXT	dc.b	"Ilegal",0
	ELSE
DspTextList	dc.b	"Wy.        ",0
		dc.b	"Normalny    ",0
		dc.b	"Naprzemian  ",0
		dc.b	"Naprzemian2 ",0 
		dc.b	"Wyrodkowany",0
DspTextIll_TXT	dc.b	"Niewaciwy ",0
	ENDC








	IFNE POLISH
MarkBlocktxt	dc.b	"* Marking Block...",0
MarkBlocktxt2	dc.b	"Block Marked.",0
EditVolume_TXT	dc.b	"Volume (1..100)",0
EditPitch_TXT	dc.b	"Pitch (0..72)",0
PatLocked	dc.b	"The actual Pattern has been locked.",0
Patunlocked	dc.b	"The Pattern is now unlocked.",0
ScreenModeReq_txt dc.b	"Screenmode Request",0

InstrNoDSPPOS_TXT	dc.b	"(*) ",0
InstrNoDSP_TXT		dc.b	"() ",0
InstrFill_TXT		dc.b	":",0
InstrNoTune_TXT		dc.b	"* ",0
InstrLeft_TXT		dc.b	"L ",0
InstrRight_TXT		dc.b	"R ",0
InstrNo_TXT		dc.b	"1SHOT ",0
InstrLooped_TXT		dc.b	"LOOP ",0
InstrSustained_TXT	dc.b	"SUST ",0
InstrKilled_TXT		dc.b	"<EMPTY> ",0
InstrSilent_TXT		dc.b	"MUTE ",0
InstrLead_TXT		dc.b	"Instr ",0
InstrNoFASTPLAY_TXT	dc.b	">> ",0

NGWTitle_TXT		dc.b	"Unnamed",0

pedtxt			dc.b	"Press MB to set crsr",0
pedtxtb 		dc.b	"Move Mouse to move crsr",0
pedtxtc 		dc.b	"Press MB to MUTE track",0
Areaerrtxt		dc.b	"Area Error",0

LPFilter_TXT		dc.b	"LP Filter (-32..127)",0
Midireqtxt		dc.b	"Input Channel (0..15)",0
EventQuant_TXT		dc.b	"Event Quantize (1..255)",0
EventMax_TXT		dc.b	"Event Maximum (0..255)",0
EventMin_TXT		dc.b	"Event Minimum (0..255)",0
Midireqtxt2		dc.b	"Kbd Punch (0..100,0=dynamic)",0



Loopseltxtb		dc.b	"Set end of loop range.",0
Loopseltxt		dc.b	"Press MB to enter loop modus.",0

Eventon			dc.b	"Event locked.",0
Eventoff		dc.b	"Event unlocked.",0

DSPPLUG_Dir		dc.b	"DSPlugin",0
DSPLoad_TXT		dc.b	"Select DSP Plugin",0
NoDSPPlugMem_TXT 	dc.b	"Error: Cannot load Dsp PlugIn",0


UnknownMsgIn		dc.b	"MIDI: Unknown Msg received.",0
MLInName		dc.b	"In",0
MLLocation		dc.b	"in.0",0
MidiLinkOk		dc.b	"Midi Link IN: ok",0
MidiNodeOk		dc.b	"Opening Midi Node: ok",0
OpenCamd		dc.b	"Opening CAMD System",0
NoMidiNode		dc.b	"Error Opening Midi Node",0
NoCamdMIDI		dc.b	"Error Opening Midi Link",0
NoCAMDlib		dc.b	"No CAMD Library. Midi is disabled.",0
MidiName_TXT		dc.b	"Symphonie CAMD Midi Node",0
ClMidiNode		dc.b	"Closing Midi Node",0



ErrNoDSMem_TXT		dc.b	"not enough memory for sample.",0
ERRNoLSMem		dc.b	"no memory for virtual sample.",0
ReqInstrTXT		dc.b	"Instrument (0..127)",0
SetSamplePreOverS_TXT	dc.b	"Pre Oversample (1..4)",0
ScopeFrame_TXT		dc.b	"Frames (1..50)",0
PitchDiff_TXT		dc.b	"Pitch Diff (0..1000)",0
SampleDiff_TXT		dc.b	"Sample Diff (0..2000)",0
SetSampleVol_TXT	dc.b	"Sample Volume (1%..199%)",0
NoiseFilt_TXT		dc.b	"AntiAlias Depth(0..10)",0
ProcVLimit_TXT		dc.b	"Max Proc Volume (1..100)",0
			dc.b	"Noise Limit (1..100)",0
SetSampleBoost_TXT	dc.b	"Sample Boost (1..10000)",0


noprefs_TXT		dc.b	"Aborted ! - This is no Symphonie prefs file.",0
SavePrefsAs_TXT		dc.b	"Save Preferences As",0
LoadPrefs_TXT		dc.b	"Load Preferences",0


SaveActualProject_TXT	dc.b	"Save Actual Project",0


Block_Diz_TXT		dc.b	"Block Info",0
SaveInstrSetup_TXT	dc.b	"Save Instr Setup",0
LoadInstrSetup_TXT	dc.b	"Load Instr Setup",0
SaveProj_PRE		dc.b	"* Saving actual Project as ",0
LoadProj_PRE		dc.b	"* Loading ",0
Delta16_TXT		dc.b	"* 16 Bit Deltapacking.",0
Delta_TXT		dc.b	"* Deltapacking.",0
Done_TXT		dc.b	"Done.",0
Fail_TXT		dc.b	"Operation FAILED.",0

Block_Diz_INCLUDED	dc.b	"* Block Info included.",0		;3.3d
Dizwrite_TXT		dc.b	"* Dizcription included.",0
Dizwrite2_TXT		dc.b	"* Dizcription Object included.",0
Extracting_TXT		dc.b	"* Extracting Samples...",0
ErrNoFileLen		dc.b	"File not found.",0
ErrTempSample2		dc.b	"i/o error.",0
ErrTempSample		dc.b	"not enough memory for Sample.",0
Errsavefile		dc.b	"An error occured while saving.",0
ErrLoadMod		dc.b	"Error: While loading Module.",0
ErrLoadHunk		dc.b	"Error: While loading Module Hunk.",0
WriteModErr_TXT		dc.b	"Error While including Samples ! (not enough memory)",0

MK_AnalyzeSample	dc.b	"*** PT Loading Samples",0
Song_TXT		dc.b	"Song ",0
Instr_TXT		dc.b	"Instruments ",0
Seq_TXT			dc.b	"Sequence ",0
Pos_TXT			dc.b	"Positions ",0
Packed_TXT		dc.b	"packed.",0
ERRUnpacked_TXT		dc.b	"Error in packed data stream - Aborting !",0
Unpacked_TXT		dc.b	"Unpacked.",0

Sampleboost_TXT		dc.b	"* Sampleboost has been set.",0

SelectModuleDiz2_TXT	dc.b	"Select Object to include",0
SelectModuleDiz_TXT	dc.b	"Select File to include",0
ExtractMod_TXT		dc.b	"Extract Samples of Module",0
SaveActualBlock_TXT	dc.b	"Save Block",0
LoadActualBlock_TXT	dc.b	"Load Block",0

LoadMod_TXT		dc.b	"Load Module",0
SaveMod_TXT		dc.b	"Save Module",0

UnpackXpk_TXT		dc.b	"XPK packed. Unpacking and loading",0

XMnomem_TXT		dc.b	"Not enough memory.",0
XMFormat_TXT		dc.b	"* XM Format, Not supported yet",0
MKNUMBPOS_TXT		dc.b	"*** Number of Positions:",0
MKNOPAT_TXT		dc.b	"*** Number of Patterns:",0

LoadModskip_TXT		dc.b	"Hunk Skipped",0

ImportSongContent_TXT	dc.b	"Import Song Content",0
LoadActualProject_TXT	dc.b	"Load Project",0


Exporttxt		dc.b	"Export Sample As",0
LoadNewSample_TXT	dc.b	"Load Sample",0
ReselectSample_TXT	dc.b	"Change Sample",0

XPKErrMsg2		dc.b	"No Memory for unpacking data.",0


KnackDeep_TXT		dc.b	"AntiClick Length (0..2000)",0	
Declicktxt		dc.b	"Realtime DeClicking (4..800)",0

EditJump_TXT		dc.b    "Jumper (MIN 1, MAX 64)",0
EmptyProject_TXT	dc.b	"Unnamed Project",0


ERRNoBufferMem_TXT	dc.b	"Error: NO BUFFER MEMORY FOUND",0
EventVol_TXT		dc.b	"Volume",0


Stop_TXT			dc.b	"Player stopped.",0
Stop2_TXT			dc.b	"Player stopped (Cpu too slow).",0	;V3.1b
PlaySo_TXT			dc.b	"Playing the whole Song.",0
PlaySe_TXT			dc.b	"Playing from actual Sequence.",0
PlayPo_TXT			dc.b	"Playing from Position     to     (   ) ",0
PlayPa_TXT			dc.b	"Playing actual Pattern.",0

SelectBuffer_TXT	dc.b	"Buffer Number (2..16)",0

DSPLength_TXT		dc.b	"DSP Level  (0..8)",0
SetSmoothLen_TXT	dc.b	"Smoothen Depth  (0..64)",0
TryWbScr_CTXT		dc.b	"ScreenMode Cancelled.",0
					dc.b	"Retry|Workbench|Quit",0
Quit_CTXT			dc.b	"The Actual Project will be lost.",0
					dc.b	"Quit|Save As|Cancel",0
Kill_CTXT			dc.b	"The Actual Project will be lost.",0
					dc.b	"New|Save As|Cancel",0
CustomPatternL_TXT	dc.b	"Pattern Number (1..1024)",0	
CustomPatternN_TXT	dc.b	"Pattern Length (1..1024)",0	

MacroDir_TXT		dc.b	"Macro",0
MacroLoad2_TXT		dc.b	"Load and Run Macro",0
MacroLoad_TXT		dc.b	"Load Macro",0
MacroSaveAs_TXT		dc.b	"Save Macro As",0
NoMacroFile_TXT		dc.b	"* Error: Illegal File Format",0

DizCleared_TXT		dc.b	"* Dizcription cleared.",0
TimeDur				dc.b	"Time elapsed so far: ",0
	ELSE
MarkBlocktxt		dc.b	"* Zaznaczanie Bloku...",0
MarkBlocktxt2		dc.b	"Blok Zaznaczony.",0
EditVolume_TXT		dc.b	"Gono (1..100)",0
EditPitch_TXT		dc.b	"Zm. czstotliwoci (0..72)",0
PatLocked			dc.b	"Aktualny Pattern zosta zablokowany.",0
Patunlocked			dc.b	"Pattern jest odblokowany.",0
ScreenModeReq_txt 	dc.b	"Wybierz rozdzielczoc",0

InstrNoDSPPOS_TXT	dc.b	"(*) ",0
InstrNoDSP_TXT		dc.b	"() ",0
InstrFill_TXT		dc.b	":",0
InstrNoTune_TXT		dc.b	"* ",0
InstrLeft_TXT		dc.b	"L ",0
InstrRight_TXT		dc.b	"R ",0
InstrNo_TXT			dc.b	"1PRZEBIEG ",0
InstrLooped_TXT		dc.b	"PTLA ",0
InstrSustained_TXT	dc.b	"WYBRZMIEWANIE ",0
InstrKilled_TXT		dc.b	"<PUSTY> ",0
InstrSilent_TXT		dc.b	"WYCZINY ",0
InstrLead_TXT		dc.b	"Instr ",0
InstrNoFASTPLAY_TXT	dc.b	">> ",0

NGWTitle_TXT		dc.b	"Bez nazwy",0

pedtxt				dc.b	"Nacinij MB, aby ustwi kursor",0
pedtxtb 			dc.b	"Przesu mysz, aby przeun kursor",0
pedtxtc 			dc.b	"Nacinij MB, aby wyczy ciek",0
Areaerrtxt			dc.b	"Bd obszaru",0

LPFilter_TXT		dc.b	"Filtr dolnoprzepustowy (-32..127)",0
Midireqtxt			dc.b	"Kana wejciowy (0..15)",0
EventQuant_TXT		dc.b	"Kwantyzacja (1..255)",0
EventMax_TXT		dc.b	"Maksimum (0..255)",0
EventMin_TXT		dc.b	"Minimum (0..255)"
Midireqtxt2			dc.b	"Nacisk klawiatury (0..100, 0=dynamiczna)",0



Loopseltxtb			dc.b	"Ustaw koniec obszaru ptli.",0
Loopseltxt			dc.b	"Nacinij MB, aby przej do ustawiania ptli.",0

Eventon				dc.b	"Zdarzenie zablokowane.",0
Eventoff			dc.b	"Zdarzenie odblokowane.",0

DSPPLUG_Dir			dc.b	"Plugin DSP",0
DSPLoad_TXT			dc.b	"Wybierz Plugin DSP",0
NoDSPPlugMem_TXT 	dc.b	"Bd: Nie mog odczyta Plugina DSP",0


UnknownMsgIn		dc.b	"MIDI: Otrzymaem nieznany Msg.",0
MLInName			dc.b	"Wejcie",0
MLLocation			dc.b	"wej.0",0
MidiLinkOk			dc.b	"Poczenie Midi: ok",0
MidiNodeOk			dc.b	"Otwieranie trybu Midi",0
OpenCamd			dc.b	"Otwieranie systemu CAMD",0
NoMidiNode			dc.b	"Bd przy otwieraniu trybu Midi",0
NoCamdMIDI			dc.b	"Bd przy otwieraniu poczenia Midi",0
NoCAMDlib			dc.b	"Brak biblioteki CAMD. Obsuga Midi wyczona",0
MidiName_TXT		dc.b	"Tryb Symphonie CAMD Midi",0
ClMidiNode			dc.b	"Zamykanie trybu Midi",0



ErrNoDSMem_TXT		dc.b	"brak pamici na sampla.",0
ERRNoLSMem			dc.b	"brak pamici na wirtualnego sampla.",0
ReqInstrTXT			dc.b	"Instrument (0..127)",0
SetSamplePreOverS_TXT	dc.b	"Wstpny Oversample (1..4)",0
ScopeFrame_TXT		dc.b	"Ramki (1..50)",0
PitchDiff_TXT		dc.b	"Rnica Czstotliwoci (0..1000)",0
SampleDiff_TXT		dc.b	"Rnica w Samplu (0..2000)",0
SetSampleVol_TXT	dc.b	"Gono Sampla (1%..199%)",0
NoiseFilt_TXT		dc.b	"Gboko AntyAliasingu(0..10)",0
ProcVLimit_TXT		dc.b	"Maksymalna Gono % (1..100)",0
					dc.b	"Granica Szumu (1..100)",0
SetSampleBoost_TXT	dc.b	"Podbicie Sampli (1..10000)",0


noprefs_TXT			dc.b	"Przerwane! - To nie jest plik z preferencjami Symphonie.",0
SavePrefsAs_TXT		dc.b	"Zapisz Preferencje jako",0
LoadPrefs_TXT		dc.b	"Wczytaj Preferencje",0


SaveActualProject_TXT	dc.b	"Zapisz Aktualny Projekt",0


SaveInstrSetup_TXT	dc.b	"Zapis Ustawienia Instrumentw",0
LoadInstrSetup_TXT	dc.b	"Wczytaj Ustawienia Instrumentw",0
SaveProj_PRE		dc.b	"* Zapisywanie aktualnego Projekt jako ",0
LoadProj_PRE		dc.b	"* Wczytywanie ",0
Delta16_TXT			dc.b	"* 16 Bit Deltapacking.",0
Delta_TXT			dc.b	"* Deltapacking.",0
Done_TXT			dc.b	"Wykonane.",0
Fail_TXT			dc.b	"Operacja wykonana NIEPOPRAWNIE.",0
Dizwrite_TXT		dc.b	"* Dizcription wstawione.",0
Dizwrite2_TXT		dc.b	"* Obiekt Dizciption wstawiony.",0
Extracting_TXT		dc.b	"* Oddzielanie Sampli...",0
ErrNoFileLen		dc.b	"Plik nie znaleziony.",0
ErrTempSample2		dc.b	"bd we/wy.",0
ErrTempSample		dc.b	"brak pamici na Sampla.",0
Errsavefile			dc.b	"Wystpi bd podczas zapisywania.",0
ErrLoadMod			dc.b	"Bd: podczas wczytywania Moduu.",0
ErrLoadHunk			dc.b	"Bd: Podczas wczytywania bloku Moduu.",0
WriteModErr_TXT		dc.b	"Bd podczas wstawiania Sampli ! (brak pamici)",0

MK_AnalyzeSample	dc.b	"*** PT Odczyt Sampli",0
Song_TXT			dc.b	"Utwr",0
Instr_TXT			dc.b	"Instrumenty ",0
Seq_TXT				dc.b	"Sekwencja ",0
Pos_TXT				dc.b	"Pozycje ",0
Packed_TXT			dc.b	"spakowany.",0
ERRUnpacked_TXT		dc.b	"Bd w spakowanym strumieniu danych - Przerwanie !",0
Unpacked_TXT		dc.b	"Rozpakowany.",0

Sampleboost_TXT		dc.b	"* Podbicie sampli ustawione.",0

SelectModuleDiz2_TXT	dc.b	"Wybierz Objekt do wstawienia.",0
SelectModuleDiz_TXT	dc.b	"Wybierz plik do wstawienia",0
ExtractMod_TXT		dc.b	"Oddzielenie Sampli od Moduu",0



LoadMod_TXT			dc.b	"Wczytaj Modu",0
SaveMod_TXT			dc.b	"Zapisz Modu ",0

UnpackXpk_TXT		dc.b	"Spakowane XPK. Dekompresowanie i wczytywanie",0

XMnomem_TXT			dc.b	"Brak pamici.",0
XMFormat_TXT		dc.b	"Format XM, w tej wersji odczyt niezaimplementowany",0
MKNUMBPOS_TXT		dc.b	"*** Liczba Pozycji:",0
MKNOPAT_TXT			dc.b	"*** Liczba Patternw:",0

LoadModskip_TXT		dc.b	"Fragment pominity",0

ImportSongContent_TXT	dc.b	"Importowanie Zawartoci Utworu",0
LoadActualProject_TXT	dc.b	"Wczytaj Projekt",0


Exporttxt			dc.b	"Zapisz Sampla Jako",0
LoadNewSample_TXT	dc.b	"Wczytaj Sampla",0
ReselectSample_TXT	dc.b	"Zmie Sampla",0

XPKErrMsg2			dc.b	"Brak pamici na rozpakowanie danych.",0


KnackDeep_TXT		dc.b	"Dugo AntiClick (0..2000)",0

EditJump_TXT		dc.b    "Skok (MIN 1, MAX 64)",0
EmptyProject_TXT	dc.b	"Projekt Bez Nazwy",0


ERRNoBufferMem_TXT	dc.b	"Bd: BRAK PAMICI NA BUFOR",0
EventVol_TXT		dc.b	"Gono",0


Stop_TXT			dc.b	"Player zatrzymany.",0
Stop2_TXT			dc.b	"Player zatrzymany (CPU zbyt wolny).",0	;V3.1b 
PlaySo_TXT			dc.b	"Odtwarzanie caego Utworu.",0
PlaySe_TXT			dc.b	"Odtwarzanie od aktualnej Sekwencji.",0
PlayPo_TXT			dc.b	"Odtwarzanie od Pozycji    do     (   ) ",0 
PlayPa_TXT			dc.b	"Odtwarzanie aktualnego Patternu.",0

SelectBuffer_TXT	dc.b	"Liczba Buforw (2..16)",0

DSPLength_TXT		dc.b	"Poziom DSP  (0..8)",0
SetSmoothLen_TXT	dc.b	"Gboko Wygadzania (0..64)",0
TryWbScr_CTXT		dc.b	"Wybr Rozdzielczoci Anulowany",0
					dc.b	"Ponw|WorkBench|Wyjcie",0
Quit_CTXT			dc.b	"Aktualny Projekt bdzie stracony.",0
					dc.b	"Wyjcie|Zapisz Jako|Anuluj",0
Kill_CTXT			dc.b	"Aktualny Projekt bdzie stracony",0
					dc.b	"Nowy|Zapisz Jako|Anuluj",0
CustomPatternL_TXT	dc.b	"Numer Patternu (1..1024)",0
CustomPatternN_TXT	dc.b	"Dugo Patternu (1..1024)",0

MacroDir_TXT		dc.b	"Makro",0
MacroLoad2_TXT		dc.b	"Wczytaj i Wykonaj Makro",0
MacroLoad_TXT		dc.b	"Wczytaj Makro",0
MacroSaveAs_TXT		dc.b	"Zapisz Makro Jako",0
NoMacroFile_TXT		dc.b	"* Bd: Niewaciwy format pliku",0

DizCleared_TXT		dc.b	"* Dizcription wyczyszczone.",0
TimeDur				dc.b	"Czas, ktry upyn do tej pory: ",0
	ENDC





	IFNE	SHAREWARE
		IFEQ	SYMPHPRO
Share1_CTXT
	dc.b	"This is a Shareware production.",10
	dc.b	"If you use it, do register !",0
	dc.b	"Ok",0
Welcome_CTXT
	dc.b	"Welcome to the SHAREWARE version",10
	dc.b	"of Symphonie Jr.",10
	dc.b	"This shareware version is NOT FD.",10
	dc.b	" (NOT freely distributable)",10
	dc.b	"You can try it out for 60 days.",10
	dc.b	"If you like it, do register.",10
	dc.b	0
	dc.b	"Accepted",0
		ELSE
Share1_CTXT
	dc.b	"This is Specialware.",10
	dc.b	"If you use it, please register.",0
	dc.b	"Ok",0
Welcome_CTXT
	dc.b	"Welcome to the SPECIALWARE version",10
	dc.b	"of Symphonie Pro.",10

	dc.b	"SPECIAL TESTING LICENCE:",10
	dc.b	"This version is for private testing purpose only !",10
	dc.b	"Test period: 1 week",10
	dc.b	"If you use it, you have to buy the original.",10
	dc.b	"This is not FD, no SHAREWARE, no PD.",10
	dc.b	"It is strictly forbidden to put it on any net,",10
	dc.b	"PD distribution service or anything similar.",10
	dc.b	"If you give it to anybody else, you have to delete",10
	dc.b	"it from your systems.",10
	dc.b	"Any professional/commercial use is prohibited.",10
	dc.b	"You are not allowed to spread or re-use anything",10
	dc.b	"created with this special version of Symphonie.",10
	dc.b	0
	dc.b	"Licence accepted",0



		ENDC

	ENDC

	IFNE AMINETDEMO
Welcome_CTXT
	dc.b	"Welcome to FREE Symphonie III",10,10

	dc.b	"SPECIAL TESTING LICENCE:",10,10
	dc.b	"- This version is for private testing purpose only !",10
	dc.b	"- If you use it, do register !",10,10
	dc.b	"This is not FD, no SHAREWARE, no PD.",10
	dc.b	"Redistribution is prohibited. Ask for a licence.",10,10
	dc.b	"Any professional/commercial use is prohibited.",10
	dc.b	0
	dc.b	"Licence accepted",0
	ENDC





	IFNE POLISH
Audio0				dc.b	"Oversample 14Bit",0
Audio2				dc.b	"Stereo 9Bit",0
Audio3				dc.b	"Mono",0
Audio4				dc.b	"Mono Surr",0
Audio5				dc.b	"Right",0
Audio6				dc.b	"Left",0
Audio7				dc.b	"Stereo 14Bit",0
Audio8				dc.b	"Oversample 9Bit",0
Audio9				dc.b	"Extern",0
Audio10				dc.b 	"AHI",0
Oversample_TXT		dc.b	"  OS",0
DSP_TXT				dc.b	"  Dsp:",0
DSPDelay_TXT		dc.b	"&FDelay",0
DSPChor_TXT			dc.b	"&Chorus",0
DSPEcho_TXT			dc.b	"FEcho",0
DSPCrossEcho_TXT 	dc.b	"FCrEcho",0
DSPCrossEcho2_TXT 	dc.b	"FCrEcho2",0
DSPCenterEcho_TXT 	dc.b	"FCentEcho",0
DSPunknown_TXT		dc.b	"???",0
MACROrecord_TXT		dc.b	" MREC",0
Editrecord_TXT		dc.b	"  Recording",0
	ELSE

Audio0				dc.b	"Oversample 14Bit",0
Audio2				dc.b	"Stereo 9Bit",0
Audio3				dc.b	"Mono",0
Audio4				dc.b	"Mono Surr",0
Audio5				dc.b	"Prawy",0
Audio6				dc.b	"Lewy",0
Audio7				dc.b	"Stereo 14Bit",0
Audio8				dc.b	"Oversample 9Bit",0
Audio9				dc.b	"Zewntrzny",0
Audio10				dc.b 	"AHI",0
Oversample_TXT		dc.b	"  OS",0
DSP_TXT				dc.b	"  Dsp:",0
DSPDelay_TXT		dc.b	"&FOpnienie",0
DSPChor_TXT			dc.b	"&Chorus",0

DSPEcho_TXT			dc.b	"FEcho",0
DSPCrossEcho_TXT 	dc.b	"FCrEcho",0
DSPCrossEcho2_TXT 	dc.b	"FCrEcho2",0
DSPCenterEcho_TXT 	dc.b	"FCentEcho",0
DSPunknown_TXT		dc.b	"???",0
MACROrecord_TXT		dc.b	" MREC",0
Editrecord_TXT		dc.b	"  Recording",0

;DSPEcho_TXT		dc.b	"FEcho",0
;DSPCrossEcho_TXT 	dc.b	"FEcho z przemieszczeniem",0
;DSPCrossEcho2_TXT 	dc.b	"FEcho z przemieszczeniem 2",0
;DSPCenterEcho_TXT 	dc.b	"FEcho z wyrodkowaniem",0
;DSPunknown_TXT		dc.b	"???",0
;MACROrecord_TXT		dc.b	" MREC",0
;Editrecord_TXT		dc.b	"  Zapisywanie",0
	ENDC






	IFNE POLISH
MenuDef_TXT  						; --- MENU ----
	dc.b    "? ",0
		dc.b    "About Symphonie ?A",0
		dc.b    "Song Info       !A",0
		dc.b    0

	dc.b    "System ",0

		dc.b    "Player     ",0
			dc.b	"Song    ",0
			dc.b	"Sequence",0
			dc.b	"Position",0
			dc.b	"Pattern ",0
			dc.b	"Track   ",0
			dc.b	"--------",0
			dc.b	"Stop    ",0
			dc.b	0

		dc.b    "Audio Mode ",0
			dc.b    "Oversample 9BT",0  
			dc.b    "Stereo     9BT",0  
			dc.b    "Oversample    ",0  
			dc.b    "Stereo        ",0  
			dc.b    "--------------",0  
			dc.b    "Mono          ",0  
			dc.b    "Mono  Surround",0  
			dc.b    "--------------",0  
			dc.b    "Right Channel ",0  
			dc.b    "Left  Channel ",0  

	IFNE	TOCCATA
			dc.b    "--------------",0  
			dc.b    "Extern        ",0  
	ENDC
			dc.b	0

		dc.b    "Dsp        ",0
			dc.b    "Deactivate  dA",0  
			dc.b    "--------------",0  
			dc.b    "Echo          ",0  
			dc.b    "Cross Echo    ",0  
			dc.b    "Cross Echo  2 ",0  
			dc.b    "Center Echo   ",0  
			dc.b    "LP Filter     ",0  
			dc.b	"--------------",0
			dc.b    "Delay         ",0  
			dc.b    "Cross Delay   ",0  
			IFNE	SYMPHPRO
			dc.b    "Hall          ",0  
			dc.b    "Cross Hall    ",0  
			ENDC

			dc.b    "LP Filter     ",0  
			;dc.b	"--------------",0
			;dc.b    "Chorus        ",0  
			dc.b	0



		dc.b	"------------",0
		dc.b	"Quit      qA",0


		dc.b    0

	dc.b    "File ",0
		dc.b    "Song     ",0
			dc.b    "Load     lA",0
	IFEQ DEMO
			dc.b    "Save as  sA",0
			dc.b    "Save       ",0
	ENDC
			dc.b	0
		dc.b    "Module   ",0
			dc.b    "Load         mA",0  
	IFEQ DEMO
			dc.b    "Save as        ",0  
			dc.b    "Dizcript       ",0  
			dc.b    "Extract Samples",0  
			dc.b    "Extract 8BT    ",0  
			dc.b    "Extract Quality",0  
			dc.b	"---------------",0
			dc.b	"Include Picture",0
			;dc.b	"Include Object ",0
	ENDC
			dc.b	0
		dc.b    "Prefs    ",0
			dc.b    "Load           ",0
			dc.b    "Save as        ",0
			dc.b    "Save Default   ",0
	IFEQ DEMO
			dc.b	"---------------",0
			dc.b	"?+   Audio     ",0
			dc.b	"?+   Video     ",0
			dc.b	"?+   Song Setup",0
			dc.b	0
		dc.b    "Pack      ",0
MT_Flag9		dc.b	"?    Song     ",0
MT_Flag10		dc.b	"?    Samples  ",0
	ENDC ;DEMO
			dc.b	0
		dc.b    0

	dc.b	"Edit ",0
		IFNE DEMO
		dc.b	"----",0,0
		ELSE
		dc.b	"Sequence ",0
			dc.b	"Cut      ",0
			dc.b	"Copy     ",0
			dc.b	"Paste    ",0
			dc.b	0
		dc.b	"Postition ",0
			dc.b	"Cut      ",0
			dc.b	"Copy     ",0
			dc.b	"Paste    ",0
			dc.b	0
		dc.b	"Pattern  ",0
			dc.b	"Cut      ",0
			dc.b	"Copy     ",0
			dc.b	"Paste    ",0
			dc.b	"---------",0
			dc.b	"DupLen   ",0
			dc.b	"Shrink   ",0
			dc.b	"Expand   ",0
			dc.b	"Duplicate",0
			dc.b	0
		dc.b	"Track    ",0
			dc.b	"Cut      ",0
			dc.b	"Copy     ",0
			dc.b	"Paste    ",0
			dc.b	"---------",0
			dc.b	"Mirror   ",0
			dc.b	"Swap Buf ",0
			dc.b	"Rot Up   ",0
			dc.b	"Rot Down ",0
			dc.b	0
		dc.b	"Block    ",0
			dc.b	"Cut    xA",0
			dc.b	"Copy   cA",0
			dc.b	"Paste  vA",0
			dc.b	"Add    bA",0
			dc.b	"---------",0
			dc.b	"Expand   ",0
			dc.b	"Clear    ",0
			dc.b	"Swap     ",0
			dc.b	0
		dc.b	"Note     ",0
			dc.b	"Cut      ",0
			dc.b	"Copy     ",0
			dc.b	"Paste    ",0
			dc.b	"---------",0
			dc.b	"Insert   ",0
			dc.b	"Delete   ",0
			dc.b	0
		dc.b	"----------",0
		dc.b	"Macro     ",0
			dc.b	"Record    ",0
			dc.b	"RePlay  rA",0
			dc.b	"Load      ",0
			dc.b	"Load & Run",0
			dc.b	"Save As   ",0
			dc.b	0
		dc.b	"----------",0
		dc.b	"Undo     uA",0
	dc.b	0
	ENDC

	dc.b	"Move ",0
		IFNE DEMO
		dc.b	"----",0,0
		ELSE
		dc.b	"Sequence ",0
			dc.b	"Previous",0
			dc.b	"Next    ",0
			dc.b	"--------",0
			dc.b	"First   ",0
			dc.b	"LAST    ",0
			dc.b	0
		dc.b	"Position ",0
			dc.b	"Previous",0
			dc.b	"Next    ",0
			dc.b	"--------",0
			dc.b	"First   ",0
			dc.b	"Last    ",0
			dc.b	0
		dc.b	"Pattern  ",0
			dc.b	"Previous",0
			dc.b	"Next    ",0
			dc.b	"--------",0
			dc.b	"First   ",0
			dc.b	"Last    ",0
			dc.b	0
		dc.b	"Crsr     ",0
			dc.b	"Top Left    ",0
			dc.b	"Bottom Right",0
			dc.b	"------------",0
			dc.b	"Top         ",0
			dc.b	"Bottom      ",0
			dc.b	0
		dc.b	0
		ENDC

	dc.b	"Sample ",0
		dc.b	"Load     ",0
		IFNE DEMO
		dc.b	"----",0,0
		ELSE
		dc.b	"Bank    ",0
			dc.b	"Load    ",0
			dc.b	"Save as ",0
			dc.b	0
		dc.b	"Remove   ",0
		dc.b	"---------",0
		dc.b	"VirTual ",0
			dc.b	"Mix         ",0
			dc.b	"Queue       ",0
			dc.b	"Remix Actual",0
			dc.b	"Transwave   ",0
			dc.b	"------------",0
			dc.b	"ReCalc All  ",0
			dc.b	0
		dc.b	"---------",0
		dc.b	"Support ",0
			dc.b	 "Adjust Path   ",0
			dc.b	 "ReLoad All    ",0
			dc.b     "Export Sample ",0
			dc.b     "Adjust Volumes",0
			dc.b	 "Prepare CDDA  ",0
			dc.b	0
		dc.b	0
		ENDC

	dc.b	"Prefs ",0
		dc.b	 "System        ",0
			dc.b	"Set System Buffer",0
			dc.b	"Set Dsp Buffer   ",0
	IFNE	SYMPHPRO
			dc.b	"Set Render Buffer",0
	ENDC
			dc.b	"-----------------",0
;			dc.b	"Set Noise Limit  ",0
			dc.b	"Set Max Proc Vol ",0
			dc.b	0

		dc.b	 "Realtime      ",0
MT_Flag1		dc.b	"?+   Pos Change  ",0
MT_Flag2		dc.b	"?    Srolling   ",0
MT_Flag3		dc.b	"?+   Spectrum    ",0
MT_Flag4		dc.b	"?+   Scopes      ",0
MT_Flag5		dc.b	"?+   Instrument  ",0
			dc.b	"-----------------",0
MT_Flag6		dc.b	"?+   Force Update",0
			dc.b	"-----------------",0
MT_Flag7		dc.b	"?    Win to Front",0
			dc.b	0


	IFNE MIDILIB
		dc.b	 "Midi    ",0			;MIDI
			dc.b	"Activate",0	;
			dc.b	"Input Channel",0	;
			dc.b	0
	ENDC

		dc.b	 "PattED         ",0
			IFNE DEMO
			dc.b	"----",0
			ELSE
			dc.b	"Set Jump Length jA",0
			dc.b	"Set Kbd Punch   pA",0
			dc.b	"?    Single       ",0
			dc.b	"------------------",0
			dc.b	"?+   Pitch        ",0
			dc.b	"?+   Instrument   ",0
			dc.b	"?+   Volume       ",0
			ENDC
			dc.b	0
		dc.b	 "Load Song/Mod  ",0
			IFNE DEMO
			dc.b	"----",0
			ELSE
			dc.b	"?    Keep Pattern #",0
			dc.b	"?    Convert Song ",0
			ENDC
			dc.b	0
		dc.b	 "S PreProcessor ",0
			dc.b	"Set Anticlick      ",0
			dc.b	"Set Sample Boost   ",0
			dc.b	"Set Oversample     ",0
			dc.b	"Set AntiAlias      ",0
			dc.b	"-------------------",0
MT_Flag8		dc.b	"?     Force A.Click",0



			dc.b	0
		dc.b	 "Sound Control ",0
			dc.b	"Set Sample Diff",0	;$a6
			dc.b	"Set Pitch  Diff",0	;8a6
			dc.b	"Set DeClicking ",0	;10a6
			dc.b	0

		dc.b	 "Gui    ",0
			dc.b	"CHG Look      ",0	;$c6
			dc.b	"CHG Gadgets   ",0	;8c6
MT_Flag11		dc.b	"?     Fast GFX",0	;10c6
	IFEQ SMALLGUI
			dc.b	"CHG ScreenMode",0
	ENDC
			dc.b	0
		dc.b	0


		dc.b	 "Fx  ",0
			dc.b	"Off         fA",0	;$c6
			dc.b	"ColorOrgan    ",0	;8c6
			dc.b	0
		dc.b	0

	ELSE
MenuDef_TXT  						; --- MENU ----
	dc.b    "? ",0
		dc.b    "O Symphonie      ?A",0
		dc.b    "Info o Utworze   !A",0
		dc.b    0

	dc.b    "System ",0

		dc.b    "Player     ",0
			dc.b	"Utwr    ",0
			dc.b	"Sekwencja",0
			dc.b	"Pozycja  ",0
			dc.b	"Pattern  ",0 
			dc.b	"cieka  ",0
			dc.b	"---------",0
			dc.b	"Stop     ",0 
			dc.b	0

		dc.b    "Tryb Audio ",0
			dc.b    "Oversample 9BT",0  
			dc.b    "Stereo     9BT",0  
			dc.b    "Oversample    ",0  
			dc.b    "Stereo        ",0  
			dc.b    "--------------",0  
			dc.b    "Mono          ",0  
			dc.b    "Mono  Surround",0  
			dc.b    "--------------",0  
			dc.b    "Prawy Kana   ",0
			dc.b    "Lewy  Kana   ",0

	IFNE	TOCCATA
			dc.b    "--------------",0  
			dc.b    "Zewntrzny    ",0
	ENDC
			dc.b	0

		dc.b    "Dsp        ",0
			dc.b    "Wyczone   dA",0 
			dc.b    "--------------",0  
			dc.b    "Echo          ",0 
			dc.b    "Echo z przem. ",0 
			dc.b    "Echo z przem.2",0 
			dc.b    "Echo wyrodkow",0 
			dc.b    "Filtr LP      ",0 
			dc.b	"--------------",0
			dc.b    "Opnienie    ",0 
			dc.b    "Op. z przem.",0 
			IFNE	SYMPHPRO
			dc.b    "Hall          ",0
			dc.b    "Hall wyrodkow",0
			ENDC

			dc.b    "Filtr LP      ",0 
			;dc.b	"--------------",0
			;dc.b    "Chorus        ",0  
			dc.b	0



		dc.b	"------------",0
		dc.b	"Wyjcie   qA",0


		dc.b    0

	dc.b    "Plik ",0
		dc.b    "Utwr    ",0
			dc.b    "Wczytanie        lA",0
	IFEQ DEMO
			dc.b    "Zapisanie Jako   sA",0
			dc.b    "Zapisanie          ",0
	ENDC
			dc.b	0
		dc.b    "Modu    ",0
			dc.b    "Wczytanie     mA",0
	IFEQ DEMO
			dc.b    "Zapisanie Jako  ",0
			dc.b    "Dizcript        ",0 
			dc.b    "Zapisz Sample   ",0 
			dc.b    "Zapisz 8BT      ",0
			dc.b    "Jako Konwersji",0
			dc.b	"----------------",0 
			dc.b	"Docz Obrazek  ",0
			;dc.b	"Docz Objekt   ",0
	ENDC
			dc.b	0
		dc.b    "Prefs    ",0
			dc.b    "Wczytanie       ",0
			dc.b    "Zapisanie Jako  ",0
			dc.b    "Zapisz Standard.",0
	IFEQ DEMO
			dc.b	"----------------",0
			dc.b	"?+   Audio      ",0
			dc.b	"?+   Video      ",0
			dc.b	"?+   Ust. Utworu",0
			dc.b	0
		dc.b    "Pakuj    ",0
MT_Flag9		dc.b	"?    Utwr    ",0
MT_Flag10		dc.b	"?    Sample   ",0
	ENDC ;DEMO
			dc.b	0
		dc.b    0

	dc.b	"Edycja ",0
		IFNE DEMO
		dc.b	"----",0,0
		ELSE
		dc.b	"Sekwencja ",0
			dc.b	"Wytnij   ",0
			dc.b	"Skopjuj  ",0
			dc.b	"Wstaw    ",0
			dc.b	0
		dc.b	"Pozycja  ",0
			dc.b	"Wytnij   ",0
			dc.b	"Skopjuj  ",0
			dc.b	"Wstaw    ",0
			dc.b	0
		dc.b	"Pattern   ",0 
			dc.b	"Wytnij   ",0
			dc.b	"Skopjuj  ",0
			dc.b	"Wstaw    ",0
			dc.b	"---------",0
			dc.b	"2xDugo",0
			dc.b	"Zmniejsz ",0
			dc.b	"Rozszerz ",0
			dc.b	"Duplikuj ",0
			dc.b	0
		dc.b	"cieka   ",0
			dc.b	"Wytnij    ",0 
			dc.b	"Skopjuj   ",0
			dc.b	"Wstaw     ",0
			dc.b	"----------",0
			dc.b	"Odwr    ",0
			dc.b	"Zam. Bufor",0
			dc.b	"Prze. Gra",0
			dc.b	"Prze. D ",0
			dc.b	0
		dc.b	"Blok      ",0
			dc.b	"Wytnij  xA",0
			dc.b	"Skopjuj cA",0
			dc.b	"Wstaw   vA",0
			dc.b	"Dodaj   bA",0
			dc.b	"----------",0
			dc.b	"Rozszerz  ",0
			dc.b	"Wyczy   ",0
			dc.b	"Zamie    ",0
			dc.b	0
		dc.b	"Nuta      ",0
			dc.b	"Wytnij     ",0
			dc.b	"Skopjuj    ",0
			dc.b	"Wstaw      ",0
			dc.b	"-----------",0
			dc.b	"Wstaw Pust",0
			dc.b	"Skasuj     ",0
			dc.b	0
		dc.b	"-----------",0
		dc.b	"Makro     ",0
			dc.b	"Nagrywaj       ",0
			dc.b	"Odtwrz      rA",0
			dc.b	"Wczytaj        ",0
			dc.b	"Wczytaj&Uruchom",0
			dc.b	"Zapisz Jako    ",0
			dc.b	0
		dc.b	"-----------",0
		dc.b	"Cofnij   uA",0
	dc.b	0
	ENDC

	dc.b	"Przesu ",0
		IFNE DEMO
		dc.b	"----",0,0
		ELSE
		dc.b	"Sekwencja ",0
			dc.b	"Poprzednia",0
			dc.b	"Nastpna  ",0
			dc.b	"----------",0
			dc.b	"Pierwsza  ",0
			dc.b	"OSTATNIA  ",0
			dc.b	0
		dc.b	"Pozycja   ",0
			dc.b	"Poprzednia",0
			dc.b	"Nastpna  ",0
			dc.b	"----------",0
			dc.b	"Pierwsza  ",0
			dc.b	"Ostatnia  ",0
			dc.b	0
		dc.b	"Pattern   ",0 
			dc.b	"Poprzedni",0
			dc.b	"Nastpny ",0
			dc.b	"---------",0
			dc.b	"Pierwszy ",0
			dc.b	"Ostatni  ",0
			dc.b	0
		dc.b	"Crsr      ",0
			dc.b	"Grny Lewy  ",0
			dc.b	"Dolny Prawy ",0
			dc.b	"------------",0
			dc.b	"Pocztek    ",0
			dc.b	"Koniec      ",0
			dc.b	0
		dc.b	0
		ENDC

	dc.b	"Sample ",0 
		dc.b	"Wczytaj  ",0
		IFNE DEMO
		dc.b	"----",0,0
		ELSE
		dc.b	"Bank       ",0 
			dc.b	"Wczytaj    ",0
			dc.b	"Zapisz Jako",0
			dc.b	0
		dc.b	"Usu     ",0
		dc.b	"------------",0
		dc.b	"Wirtualnie ",0
			dc.b	"Miksuj          ",0
			dc.b	"Kolejne         ",0
			dc.b	"Remiksuj Aktual.",0
			dc.b	"Transform. fal ",0
			dc.b	"----------------",0
			dc.b	"Przelicz Wszyst.",0
			dc.b	0
		dc.b	"------------",0
		dc.b	"Dodatkowe  ",0
			dc.b	 "Zmie ciek ",0
			dc.b	 "Odczytaj Wsz. ",0
			dc.b     "Zapisz Sampla ",0
			dc.b	 "Zmie Gono",0	;NEW	
			dc.b	0
		dc.b	0
		ENDC

	dc.b	"Prefs ",0
		dc.b	 "System        ",0
			dc.b	"Ustaw Bufor Systemowy",0
			dc.b	"Ustaw Bufor DSP      ",0
	IFNE	SYMPHPRO
			dc.b	"Ustaw Bufor Gen.     ",0
	ENDC
			dc.b	"---------------------",0
;			dc.b	"Ustaw Limit Szumu    ",0
			dc.b	"Ustaw Maks. Gono ",0
			dc.b	0

		dc.b	 "Realtime             ",0
MT_Flag1		dc.b	"?+   Zmiana Pozycji",0
MT_Flag2		dc.b	"?    Przewijanie   ",0
MT_Flag3		dc.b	"?+   Widmo         ",0
MT_Flag4		dc.b	"?+   Zakresy       ",0
MT_Flag5		dc.b	"?+   Instrument    ",0
			dc.b	"-------------------",0
MT_Flag6		dc.b	"?+   Wymu Odwie.",0
			dc.b	"-------------------",0
MT_Flag7		dc.b	"?    Okno naprzd  ",0
			dc.b	0

	IFNE MIDILIB
		dc.b	 "Midi                 ",0			;MIDI
			dc.b	"Wcz     ",0	; 
			dc.b	"Kana Wej.",0	;
			dc.b	0
	ENDC

		dc.b	 "ED Patternw         ",0
			IFNE DEMO
			dc.b	"---",0
			ELSE
			dc.b	"Ustaw D. Skoku   jA",0
			dc.b	"Ustaw Nacisk Kl.  pA",0
			dc.b	"?    Pojedyczy     ",0
			dc.b	"--------------------",0
			dc.b	"?+   Podziaka      ",0
			dc.b	"?+   Instrument     ",0
			dc.b	"?+   Gono       ",0
			ENDC
			dc.b	0
		dc.b	 "Wczytywanie Utw./Mod ",0
			IFNE DEMO
			dc.b	"----",0
			ELSE
			dc.b	"?    Zachowaj Patt #",0
			dc.b	"?    Konwertuj Utwr",0
			ENDC
			dc.b	0
		dc.b	 "S PreProcessor       ",0
			dc.b	"Ustaw Anticlick      ",0
			dc.b	"Ustaw Podbicie Sampli",0
			dc.b	"Ustaw Oversampling   ",0
			dc.b	"Ustaw Antyaliasing   ",0
			dc.b	"---------------------",0
MT_Flag8		dc.b	"?     Wymu AntiClick",0



			dc.b	0
		dc.b	 "Stereo Control       ",0
			dc.b	"Ustaw Rnic Samp.",0	;$a6
			dc.b	"Ustaw Rnic Czst",0	;8a6
			dc.b	0

		dc.b	 "Gui                  ",0
			dc.b	"Zmie Wygld      ",0	;$c6 
			dc.b	"Zmie Gadety     ",0	;8c6 
MT_Flag11		dc.b	"?     Szybkie Wy.",0	;10c6
			dc.b	0
		dc.b	0


		dc.b	 "Fx  ",0
			dc.b	"Wy.        fA",0	;$c6
			dc.b	"ColorOrgan    ",0	;8c6
			dc.b	0
		dc.b	0
	dc.b	0,0,0
	ENDC

	
	dc.b	0,0,0











	IFNE	DEMO

		IFEQ	SYMPHPRO
About_TXT		dc.b	"About Symphonie Player "
			DetailVerString
			dc.b	10,10
			dc.b	"(C) 1999 by Patrick Meng",10,10
			DC.B	"Protection: Freeware, FD",10,10

		ELSE

About_TXT		dc.b	"About Symphonie Player Pro "
			DetailVerString
			dc.b	10,10
			dc.b	"(C) 1999 by Patrick Meng",10,10
			DC.B	"Protection: Freeware, FD",10,10

		ENDC

	AvailString

	ELSE
About_TXT	

		IFEQ	SYMPHPRO

		dc.b	"About Symphonie Jr "
		DetailVerString
		dc.b	10,10
		dc.b	"(C) 1999 by Patrick Meng",10,10
	IFNE	AMINETDEMO
	;		dc.b	"Aminet SE Release.",10,10
			dc.b	"FREE SYMPHONIE - DEMO Release.",10
			dc.b	"If you use it, DO REGISTER !",10,10
	ENDC

	AvailString

		ELSE

		dc.b	"About Symphonie Pro "
		DetailVerString
		dc.b	10,10
		dc.b	"(C) 1999 by Patrick Meng",10,10
		dc.b	"16 Bit Symphonie.",10,10

	AvailString

		ENDC

	ENDC

SymTest_TXT
	dc.b	"Symphonie",0
	dc.b	"Available at : RealTime Software, Patrick Meng, Rosenfeldweg 4, CH-6048 Horw, Switzerland ",0

NGWinDef

	IFNE SMALLGUI
	dc.b	"+CTRL,Symphonie  "
	VerString
	dc.b	0
	ELSE
	;--- EDITOR ---
	dc.b	"+CTRL,System Control",0
	dc.b	"+WINB,Song Ed",0
	dc.b	"+PTED,Pattern Ed",0
	dc.b	"+EVED,Event Editor",0
	dc.b	"+WINS,Instrument Ed",0

	;--- INFO ---
	dc.b	"+WINA,Spectrum Analyzer",0
	dc.b	"+SCOP,Scope",0
	dc.b	"+WINC,Assist",0
	ENDC
	dc.b	0,0

NGAreaDef

	IFNE SMALLGUI
	dc.b	"CTRL(System Control,SYS1,100%060%008g),"
	dc.b	"CTRL(Info,C001,100%043%000a),"		;INFO
	dc.b	0

	ELSE
	;--- SCOPE ---
	dc.b	"SCOP(Scope Prefs,SCPP,100%001g000a),"	;SCOPE
	dc.b	"SCOP(Waveform,SCPA,100%100%000a),",0


	;--- SPECTRUM ---
	dc.b	"WINA(Harmony,A001,100%100%000a),",0	;SPECY

	;--- ASSIST ---
	dc.b	"WINC(Info,C001,100%100%000a),"		;INFO
	dc.b	"WINC(Status,C002,100%001g000a),",0

	;--- INSTRUMENT ---
	dc.b	"WINS(Instr,SGUI,100%050%003g),"	;INSTR
	dc.b	"WINS(Waveform,SWAV,100%050%000a),",0	;WAVEFORM

	;--- SONG ---
	dc.b	"WINB(Song,B001,100%015%002g),"		;SONG
	dc.b	"WINB(Sequence,B002,100%020%003g),"
	dc.b	"WINB(Position,B003,100%040%005g),"
	dc.b	"WINB(Poslist ,B004,100%025%000a)",0

	;--- PATTERN ED ---
	dc.b	"PTED(PED Edit,PED1,100%002g000a),"	;PED
	dc.b	"PTED(Pattern,PED2,100%100%000a),",0

	;--- EVENT ED ---
	dc.b	"EVED(Event,EED1,100%045%000a),"	;EVENT ED
	dc.b	"EVED(Special Fx,EED2,100%055%000a),",0

	;--- SYSTEM CONTROL ---				;SYSTEM
	IFEQ AMINETDEMO
	dc.b	"CTRL(System,SYS1,100%032%000a),"
	dc.b	"CTRL(Render,SYS2,100%012%000a),"
	dc.b	"CTRL(Dsp,SYS3,100%056%000a),",0
	ELSE
	dc.b	"CTRL(System,SYS1,100%050%000a),"
	dc.b	"CTRL(Dsp,SYS3,100%050%000a),",0
	ENDC

	ENDC

	dc.b	0,0





NGGadgetDef
	IFNE SMALLGUI	;--- SMALL GUI  -------------------------------
	dc.b	"CTRL"
	dc.b	"SYS1"
	;	 ==== SYSTEM CONTROL

	
	dc.b	"PL01,&-0B----,I",0
	dc.b	"PL02,&&0B----,S<",0
	dc.b	"PL03,&-0B---R,<<",0
	dc.b	"SY21,&-0B----,||",0
	dc.b	"SY25,&-0B----, > ",0
	dc.b	"PL04,&&0B---R,>>",0
	dc.b	"PL05,&-0B----,S>",0
	dc.b	"SE05,--0B----,LOAD",0

	dc.b	"SY30,&-0T----,Vol ",0
	dc.b	"SY3b,&&0S---R,"		;Slider MasterVolume
MVolDef dc.b	"100%",0
	dc.b	"SY31,&-0V----,   ",0
	dc.b	"SY34,&-0T----,Bl",0
	dc.b	"SY3c,&&0S---R,"		;Slider MasterBalance
MBalDef dc.b	"050%",0
	dc.b	"SY35,--0V----,   ",0

	dc.b	"SY38,&-0T----,Freq",0
	dc.b	"SY39,&&0V----,      ",0
	dc.b	"SY3A,&&0B---R,<",0
	dc.b	"SY3B,&-0B---R,>",0
	dc.b	"SY3C,&-0T----,Spd  ",0
	dc.b	"SY3D,&&0V----,   ",0
	dc.b	"SY3E,&&0B---R,<",0
	dc.b	"SY3F,--0B---R,>",0

	dc.b	"T0G1,&-0T----,P/I",0
	dc.b	"SV09,&-0V----,   ",0
	dc.b	"WV01,&-0V----,   ",0
	dc.b	"SY84,&-0T----,Tune",0
	dc.b	"SY3d,&&0S---R,"		;Slider MasterTune
MTuneDef dc.b	"050%",0
	dc.b	"SY3e,--0B----,R",0


	dc.b	"SY80,&-0T----,dPit  ",0
	dc.b	"SY81,&&0V----,   ",0
	dc.b	"SY82,&&0B---R,<",0
	dc.b	"SY83,&-0B---R,>",0
	dc.b	"SY84,&-0T----,dSmp",0
	dc.b	"SY85,&&0V----,    ",0
	dc.b	"SY86,&&0B---R,<",0
	dc.b	"SY87,--0B---R,>",0

	dc.b	"SY3G,&-0T----,Time",0
	dc.b	"SY3H,--0V----,            ",0



	dc.b	0

	dc.b	"CTRL"
	dc.b	"SYS3"
	;	 ====

	dc.b	"SY80,&-0T----,dPit",0
	dc.b	"SY81,&&0V----,   ",0
	dc.b	"SY82,&&0B---R,<",0
	dc.b	"SY83,&-0B---R,>",0

	dc.b	"SY84,&-0T----,dSmp",0
	dc.b	"SY85,&&0V----,    ",0
	dc.b	"SY86,&&0B---R,<",0
	dc.b	"SY87,--0B---R,>",0

	dc.b	"SY50,&&0T----,Echo ",0
	dc.b	"SY59,&-0P----,+ Off ,- Norm,- Cr,- Cr2,- Cent",0		;Popup
	dc.b	"SY51,&&0T----,Len   ",0
	dc.b	"SY52,&&0V----,   ",0
	dc.b	"SY53,&&0B---R,<",0
	dc.b	"SY54,--0B---R,>",0
	dc.b	"SY50,&-0T----,     ",0
	dc.b	"SY55,&&0T----,Lvl",0
	dc.b	"SY56,&&0V----,      ",0
	dc.b	"SY57,&&0B---R,<",0
	dc.b	"SY58,--0B---R,>",0

	dc.b	"SY60,&&0T----,Delay",0
	dc.b	"SY69,&-0P----,+ Off ,- Norm,- Cr",0		;Popup
	dc.b	"SY61,&&0T----,Len   ",0
	dc.b	"SY62,&&0V----,   ",0
	dc.b	"SY63,&&0B---R,<",0
	dc.b	"SY64,--0B---R,>",0
	dc.b	"SY60,&-0T----,     ",0
	dc.b	"SY65,&&0T----,Lvl",0
	dc.b	"SY66,&&0V----,      ",0
	dc.b	"SY67,&&0B---R,<",0
	dc.b	"SY68,--0B---R,>",0

	IFEQ AMINETDEMO
	dc.b	"SY70,&&0T----,Hall ",0
	dc.b	"SY79,&-0P----,+ Off ,- Norm,- Cr",0		;Popup
	dc.b	"SY71,&&0T----,Len   ",0
	dc.b	"SY72,&&0V----,   ",0
	dc.b	"SY73,&&0B---R,<",0
	dc.b	"SY74,--0B---R,>",0
	dc.b	"SY70,&-0T----,     ",0
	dc.b	"SY75,&&0T----,Lvl",0
	dc.b	"SY76,&&0V----,      ",0
	dc.b	"SY77,&&0B---R,<",0
	dc.b	"SY78,--0B---R,>",0
	ENDC


	;--- SMALL GUI END --------------------------------------------------


	ELSE

	;--- ASSIST WINDOW -----------------------------------------
	dc.b	"WINC"				;WIN ID
	dc.b	"C002"				;AREA ID
	;        ====
	dc.b	"INF2,--0T----,      ",0	;TEXT
	dc.b	0


	;--- SCOPE WINDOW -------------------------------------------
	dc.b	"SCOP"				;WIN ID
	dc.b	"SCPP"				;AREA ID
	;	 ====
	dc.b	"TSC1,&-0B----,FRAMES",0
	dc.b	"TSC2,--1B----,DIFF",0
	dc.b	0


	dc.b	"WINS"				;WIN ID
	dc.b	"SGUI"				;AREA ID
	;	 ====
	dc.b	"WV01,&&0V----,   ",0
	dc.b	"WV02,&&0B---R,<",0
	dc.b	"WV03,&&0B---R,>",0
	dc.b	"WV04,&&0B----,R",0
	dc.b	"WV05,&-0B----,LOAD",0
	dc.b	"WV06,&&0B----,Vol",0
	dc.b	"WV07,&&0V----,   ",0
	dc.b	"WV0H,&-0B----,F",0

	dc.b	"WV08,&-0P----,+ 1SHOT,- LOOP ,- SUST ",0		;Popup


	dc.b	"WV0C,&&1B----,>>",0
	dc.b	"WV0D,&&1B----,()",0
	dc.b	"WV0E,&-1B----,*",0
	dc.b	"WV0F,&-1B----,M",0
	dc.b	"WV0G,--0B----,KICK",0

	dc.b	"WV20,&&0T----,Tune",0
	dc.b	"WV24,&&0V----,   ",0
	dc.b	"WV25,&&0B---R,<",0
	dc.b	"WV26,&-0B---R,>",0
	dc.b	"WV20,&&0T----,Fine",0
	dc.b	"WV21,&&0V----,   ",0
	dc.b	"WV22,&&0B---R,<",0
	dc.b	"WV23,&-0B---R,>",0

	dc.b	"WV16,&-0B----,RVS",0
	dc.b	"WV17,&-0B----,INV",0
	dc.b	"WV19,&&0B----,D",0
	dc.b	"WV1A,&-0V----,   ",0
	IFNE NEWFILTER
	dc.b	"WV1E,&&0B----,FII",0
	ENDC
	dc.b	"WV1C,&&0B----,F",0
	dc.b	"WV1D,--0V----,   ",0

	dc.b	"WV11,&-0B----,MIX",0
	dc.b	"WV12,&-0B----,ReMIX",0
	dc.b	"WV13,&-0B----,QUE",0
	dc.b	"WV28,&&0T----,L.End",0
	dc.b	"WV29,&&0B---R,<",0
	dc.b	"WV2A,&-0B---R,>",0
	dc.b	"WV2B,&&0T----,Bgn",0
	dc.b	"WV2C,&&0B---R,<",0
	dc.b	"WV2D,&-0B---R,>",0
	dc.b	"WV2E,&&0T----,Rp",0
	dc.b	"WV2F,&&0V----,   ",0
	dc.b	"WV2G,&&0B---R,>",0
	dc.b	"WV2H,&-0B---R,<",0
	dc.b	"WV2I,&-0B----,SYNC",0
	dc.b	"WV2J,--0B----,G",0
	dc.b	0

	;--- SONG EDITOR WINDOW -------------------------------------
	dc.b	"WINB"
	dc.b	"B001"
						;	 ==== SONG
	dc.b	"SE01,&-1B----,REC",0
	dc.b	"SE02,&-0B----,LOAD",0
	dc.b	"SE03,&-0B----,SAVE AS",0
	dc.b	"SE04,&-0B----,SAVE",0
	dc.b	"SE05,--0B----,MOD",0
	dc.b	"SE10,&-0B----,NEW",0
	dc.b	"SE11,&&0B----,LEN",0
	dc.b	"SV01,&-0V----,    ",0
	dc.b	"SE12,&&0B----,PAT",0
	dc.b	"SV02,--0V----,    ",0
	dc.b	0

	dc.b	"WINB"
	dc.b	"B002"
						;	 ==== SEQUENCE
	dc.b	"SV03,&&0V----,   ",0
	dc.b	"SE20,&&0B---R,<",0
	dc.b	"SE21,&-0B---R,>",0
	dc.b	"SE2A,&-0P----,- Play,+ Skip,- End ",0 	;Popup
	dc.b	"SE22,&&0B----,C",0
	dc.b	"SE23,&&0B----,X",0
	dc.b	"SE24,&-0B----,P",0
	dc.b	"SE25,--0B----,DUP",0

	dc.b	"T0G2,&-0T----,Bgn",0
	dc.b	"SV05,&&0V----,   ",0
	dc.b	"SE30,&&0B---R,<",0
	dc.b	"SE31,&-0B---R,>",0
	dc.b	"T0G2,&-0T----,Trns",0
	dc.b	"SV06,&&0V----,   ",0
	dc.b	"SE32,&&0B---R,<",0
	dc.b	"SE33,--0B---R,>",0
	dc.b	"T0G2,&-0T----,Len",0
	dc.b	"SV07,&&0V----,   ",0
	dc.b	"SE34,&&0B---R,<",0
	dc.b	"SE35,&-0B---R,>",0
	dc.b	"T0G2,&-0T----,Loop",0
	dc.b	"SV08,&&0V----,   ",0
	dc.b	"SE36,&&0B---R,<",0
	dc.b	"SE37,--0B---R,>",0
	dc.b	0

	dc.b	"WINB"
	dc.b	"B003"
						;	 ==== POSITION
	dc.b	"T0G1,&-0T----,Pos",0
	dc.b	"SV09,&&0V----,   ",0
	dc.b	"SE40,&&0B---R,<",0
	dc.b	"SE41,&-0B---R,>",0
	dc.b	"T0G1,&-0T----,Patt ",0
	dc.b	"SV10,&&0V----,   ",0
	dc.b	"SE42,&&0B---R,<",0
	dc.b	"SE43,--0B---R,>",0

	dc.b	"SE44,&-0B----,COPY",0
	dc.b	"SE45,&-0B----,DUP",0
	dc.b	"SE46,&-0B----,PASTE",0
	dc.b	"SE47,&-0B----,CLR",0
	dc.b	"SE48,&-0B----,INS",0
	dc.b	"SE49,--0B----,DEL",0

	dc.b	"T0G2,&-0T----,Bgn",0
	dc.b	"SV11,&&0V----,   ",0
	dc.b	"SE50,&&0B---R,<",0
	dc.b	"SE51,&-0B---R,>",0
	dc.b	"T0G2,&-0T----,Trns ",0
	dc.b	"SV12,&&0V----,   ",0
	dc.b	"SE52,&&0B---R,<",0
	dc.b	"SE53,--0B---R,>",0

	dc.b	"T0G2,&-0T----,Len",0
	dc.b	"SV13,&&0V----,   ",0
	dc.b	"SE54,&&0B---R,<",0
	dc.b	"SE55,&-0B---R,>",0
	dc.b	"T0G2,&-0T----,Loop ",0
	dc.b	"SV14,&&0V----,   ",0
	dc.b	"SE56,&&0B---R,<",0
	dc.b	"SE57,--0B---R,>",0

	dc.b	"T0G2,&-0T----,Cyl",0
	dc.b	"SV15,&&0V----,   ",0
	dc.b	"SE58,&&0B---R,<",0
	dc.b	"SE59,&-0B---R,>",0
	dc.b	"T0G2,&-0T----,Ev/Ln",0
	dc.b	"SV16,&&0V----,   ",0
	dc.b	"SE5A,&&0B---R,<",0
	dc.b	"SE5B,--0B---R,>",0

	dc.b	0


					;--- PATTERN EDITOR ----------------
	dc.b	"PTED"
	dc.b	"PED1"
	;	 ==== PATTERN EDITOR
	dc.b	"PE01,&&0V----,    ",0
	dc.b	"PE02,&&0B---R,<",0
	dc.b	"PE03,&-0B---R,>",0
	dc.b	"PE04,&&0B----,NOTE",0
	dc.b	"PE05,&&0B----,TRK",0
	dc.b	"PE06,&&0B----,PAT",0
	dc.b	"PE07,&-0B----,BLK",0
	dc.b	"PE08,&&0B----,C",0
	dc.b	"PE09,&&0B----,X",0
	dc.b	"PE0A,&-0B----,P",0

	dc.b	"PE0G,&&0B----,L",0
	dc.b	"PE0H,&-0B----,S",0


	dc.b	"PE0B,&-0B----,DUP",0
	dc.b	"PE0C,&-0B----,ADD",0
	dc.b	"PE0D,&-0B----,SHR",0
	dc.b	"PE0E,&-0B----,EXP",0
	dc.b	"PE0F,--0B----,MIR",0

	dc.b	"PE10,&-0B----,V",0
	dc.b	"PE11,&-1B----,LOCK",0
	dc.b	"PE12,&&0T----,Kbd",0
	dc.b	"PE13,&&0V----,   ",0
	dc.b	"PE14,&&0B---R,<",0
	dc.b	"PE15,&-0B---R,>",0
	dc.b	"PE16,&&0T----,R",0
	dc.b	"PE17,&&0B---R,U",0
	dc.b	"PE18,&-0B---R,D",0

	dc.b	"PE19,&&0T----,P",0
	dc.b	"PE1A,&&0B---R,<",0
	dc.b	"PE1B,&-0B---R,>",0
	dc.b	"PE1C,&&0T----,I",0
	dc.b	"PE1D,&&0B---R,<",0
	dc.b	"PE1E,&-0B---R,>",0
	dc.b	"PE1N,&&0T----,V",0
	dc.b	"PE1G,&&0B---R,<",0
	dc.b	"PE1H,&-0B---R,>",0

	dc.b	"PE1K,&&0B---R,L",0
	dc.b	"PE1L,&&0B---R,S",0
	dc.b	"PE1M,&-0B---R,R",0

	dc.b	"PE1I,&-1B----,MREC",0
	dc.b	"PE1J,--0B---R,M>>",0
	dc.b	0


						;--- EVENT EDITOR ---
	dc.b	"EVED"
	dc.b	"EED1"
	;	 ==== EVENT EDITOR
	dc.b	"EE01,&-0T----,Event ",0
	dc.b	"EE02,&&0V----,            ",0
	dc.b	"EE03,&-0B----,C",0
	dc.b	"EE04,&-0B----,L",0
	dc.b	"EE05,&&0B----,R",0
	dc.b	"EE06,--0B----,W",0

	dc.b	"EE10,&-0T----,      ",0
	dc.b	"EE11,&&0V----,      ",0
	dc.b	"EE12,&&0B---R,<",0
	dc.b	"EE13,&-0B---R,>",0
	dc.b	"EE14,&-0B----,Edit",0
	dc.b	"EE15,&&0B----,R",0
	dc.b	"EE16,--0B----,W",0
	dc.b	"EE20,&-0T----,      ",0
	dc.b	"EE21,&&0V----,      ",0
	dc.b	"EE22,&&0B---R,<",0
	dc.b	"EE23,&-0B---R,>",0
	dc.b	"EE24,&-0B----,>Ins",0
	dc.b	"EE25,&&0B----,R",0
	dc.b	"EE26,--0B----,W",0
	dc.b	"EE30,&-0T----,      ",0
	dc.b	"EE31,&&0V----,      ",0
	dc.b	"EE32,&&0B---R,<",0
	dc.b	"EE33,&-0B---R,>",0
	dc.b	"EE34,&-0B----,Edit",0
	dc.b	"EE35,&&0B----,R",0
	dc.b	"EE36,--0B----,W",0

	dc.b	0


	dc.b	"EVED"
	dc.b	"EED2"
	;	 ==== EVENT EDITOR
	dc.b	"EE41,&-0T----,Sfx",0
	dc.b	"EE42,&-0B----,KOff",0
	dc.b	"EE43,&-0B----,Echo",0
	dc.b	"EE44,&-0B----,Delay",0
	dc.b	"EE45,&-0B----,Spd",0
	dc.b	"EE46,&-0B----,CV",0
	dc.b	"EE47,--0B----,F",0

	dc.b	"EE51,&-0T----,Pit",0
	dc.b	"EE5A,&-0B----,S",0
	dc.b	"EE52,&-0B----,D",0
	dc.b	"EE53,&-0B----,U",0
	dc.b	"EE54,&-0B----,ADD",0
	dc.b	"EE55,&-0B----,VIBR",0
	dc.b	"EE56,&-0B----,HT",0
	dc.b	"EE57,&-0B----,TO",0
	dc.b	"EE58,&-0B----,-",0
	dc.b	"EE59,--0B----,+",0

	dc.b	"EE61,&-0T----,Ins",0
	dc.b	"EE62,&-0B----,F&P",0
	dc.b	"EE63,&-0B----,FSET",0
	dc.b	"EE64,&-0B----,ADD",0
	dc.b	"EE65,&-0B----,SVIB",0
	dc.b	"EE66,&-0B----,FR",0
	dc.b	"EE67,--0B----,TRG",0

	dc.b	"EE70,&-0T----,Vol",0
	dc.b	"EE71,&-0B----,S",0
	dc.b	"EE72,&-0B----,D",0
	dc.b	"EE73,&-0B----,U",0
	dc.b	"EE74,&-0B----,ADD",0
	dc.b	"EE75,&-0B----,TREM",0
	dc.b	"EE76,&-0B----,OFF",0
	dc.b	"EE77,&-0B----,ON",0
	dc.b	"EE78,--0B----,AC",0


;	dc.b	"EE80,&-0T----,Mfy",0

	dc.b	"EE87,&&1B----,P",0
	dc.b	"EE88,&&1B----,I",0
	dc.b	"EE89,&-1B----,V",0

	dc.b	"EE81,&&0V----,   ",0
	dc.b	"EE82,&&0T----,to",0
	dc.b	"EE83,&-0V----,   ",0

	dc.b	"EE84,&&0S---R,"		;Slider Event
MEventDef dc.b	"000%",0
	dc.b	"EE86,--0V----,   ",0


	dc.b	0


	;--- SYSTEM CONTROL ---
	dc.b	"CTRL"
	dc.b	"SYS1"
	;	 ==== SYSTEM CONTROL
	IFNE TESTPRGB
	dc.b	"TEST,&-0B----,T",0
	ENDC
	dc.b	"SY20,&-0T----,Play",0
	dc.b	"SY21,&-0B----,STOP",0
	dc.b	"SY22,&-0B----,PAT",0
	dc.b	"SY23,&-0B----,POS",0
	dc.b	"SY24,&-0B----,SEQ",0
	dc.b	"SY25,--0B----,SONG",0

	dc.b	"SY30,&-0T----,Vol",0
	dc.b	"SY3b,&&0S---R,"		;Slider MasterVolume
MVolDef dc.b	"100%",0
	dc.b	"SY31,&-0V----,   ",0

	dc.b	"SY34,&-0T----,Bl",0
	dc.b	"SY3c,&&0S---R,"		;Slider MasterBalance
MBalDef dc.b	"050%",0
	dc.b	"SY35,--0V----,   ",0


	;dc.b	"SY32,&&0B---R,<",0
	;dc.b	"SY33,&-0B---R,>",0
	;dc.b	"SY34,&-0T----,Bl ",0
	;dc.b	"SY35,&&0V----,   ",0
	;dc.b	"SY36,&&0B---R,<",0
	;dc.b	"SY37,--0B---R,>",0

	dc.b	"SY38,&-0T----,Frq",0
	dc.b	"SY39,&&0V----,      ",0
	dc.b	"SY3A,&&0B---R,<",0
	dc.b	"SY3B,&-0B---R,>",0
	dc.b	"SY3C,&-0T----,Spd",0
	dc.b	"SY3D,&&0V----,   ",0
	dc.b	"SY3E,&&0B---R,<",0
	dc.b	"SY3F,--0B---R,>",0


	dc.b	"SY3G,&&0T----,Time",0
	dc.b	"SY3H,&-0V----,            ",0
	dc.b	"SY3d,&&0S---R,"		;Slider MasterTune
MTuneDef dc.b	"050%",0
	dc.b	"SY3e,--0B----,R",0


	dc.b	"SY10,&-0T----,Voc",0
	IFEQ AMINETDEMO
	dc.b	"SY11,&-0B----,8",0
	dc.b	"SY12,&-0B----,16",0
	dc.b	"SY13,&-0B----,32",0
	dc.b	"SY14,&-0B----,64",0
	dc.b	"SY15,&-0B----,128",0
	dc.b	"SY16,--0B----,256",0
	ELSE
	dc.b	"SY11,&-0T----,          ",0
	dc.b	"SY11,&-0B----,8",0
	dc.b	"SY12,&-0B----,16",0
	dc.b	"SY13,--0B----,32",0
	ENDC
	dc.b	0

	IFNE RENDER
	;--- RENDER UNIT ---
	dc.b	"CTRL"
	dc.b	"SYS2"
	;	 ====
	dc.b	"SY40,&-0B----,RENDER",0
	dc.b	"SY41,&&1B----,8",0
	dc.b	"SY42,&-1B----,16",0
	dc.b	"SY43,&&1B----,M",0
	dc.b	"SY44,&-1B----,ST",0
	dc.b	"SY45,&-1B----,PC",0

	dc.b	"SY4C,--0P----,+ Off,- 2x ,- 4x ",0		;Popup

	;dc.b	"SY46,--0B----,HQ",0
	dc.b	"SY47,&-0T----,Format",0
	dc.b	"SY48,&-1B----,RAW",0
	dc.b	"SY49,&-1B----,WAV",0
	dc.b	"SY4A,&-1B----,MAEST",0
	dc.b	"SY4B,--1B----,AIFF",0
	dc.b	0
	ENDC



	dc.b	"CTRL"
	dc.b	"SYS3"
	;	 ====

	dc.b	"SY80,&-0T----,dPit",0
	dc.b	"SY81,&&0V----,   ",0
	dc.b	"SY82,&&0B---R,<",0
	dc.b	"SY83,&-0B---R,>",0

	dc.b	"SY84,&-0T----,dSmp",0
	dc.b	"SY85,&&0V----,    ",0
	dc.b	"SY86,&&0B---R,<",0
	dc.b	"SY87,--0B---R,>",0

	dc.b	"SY50,&&0T----,Echo ",0
	dc.b	"SY59,&-0P----,+ Off ,- Norm,- Cr,- Cr2,- Cent",0		;Popup
	dc.b	"SY51,&&0T----,Len   ",0
	dc.b	"SY52,&&0V----,   ",0
	dc.b	"SY53,&&0B---R,<",0
	dc.b	"SY54,--0B---R,>",0
	dc.b	"SY50,&-0T----,     ",0
	dc.b	"SY55,&&0T----,Lvl",0
	dc.b	"SY56,&&0V----,      ",0
	dc.b	"SY57,&&0B---R,<",0
	dc.b	"SY58,--0B---R,>",0

	dc.b	"SY60,&&0T----,Delay",0
	dc.b	"SY69,&-0P----,+ Off ,- Norm,- Cr",0		;Popup
	dc.b	"SY61,&&0T----,Len   ",0
	dc.b	"SY62,&&0V----,   ",0
	dc.b	"SY63,&&0B---R,<",0
	dc.b	"SY64,--0B---R,>",0
	dc.b	"SY60,&-0T----,     ",0
	dc.b	"SY65,&&0T----,Lvl",0
	dc.b	"SY66,&&0V----,      ",0
	dc.b	"SY67,&&0B---R,<",0
	dc.b	"SY68,--0B---R,>",0

	IFEQ AMINETDEMO
	dc.b	"SY70,&&0T----,Hall ",0
	dc.b	"SY79,&-0P----,+ Off ,- Norm,- Cr",0		;Popup
	dc.b	"SY71,&&0T----,Len   ",0
	dc.b	"SY72,&&0V----,   ",0
	dc.b	"SY73,&&0B---R,<",0
	dc.b	"SY74,--0B---R,>",0
	dc.b	"SY70,&-0T----,     ",0
	dc.b	"SY75,&&0T----,Lvl",0
	dc.b	"SY76,&&0V----,      ",0
	dc.b	"SY77,&&0B---R,<",0
	dc.b	"SY78,--0B---R,>",0
	ENDC

	dc.b	"SY90,&-0T----,Plug In",0
	dc.b	"SY91,&-0B----,LOAD",0
	dc.b	"SY92,&-0B----,ON",0
	dc.b	"SY93,--0B----,OFF",0

	dc.b	"SY95,&&0V----,----------",0
	dc.b	"SY96,&&0B---R,<",0
	dc.b	"SY97,&-0B---R,>",0
	dc.b	"SY98,&&0V----,-----",0
	dc.b	"SY99,&&0B---R,<",0
	dc.b	"SY9A,--0B---R,>",0
	ENDC

	dc.b	0
	dc.b	0,0

	IFEQ DEMO
VFadeBuf	dc.l	1,100

	IFNE POLISH
VFadeMin_TXT	dc.b	"Volume Begin (1..100)",0
VFadeMax_TXT	dc.b	"Volume End (1..100)",0
VFade_INFOTXT	dc.b	"*** BLOCK: Volume Fade ***",0
ModFtxt2 dc.b	"Event Filter=",34,"Simple Fx/Key On",34,0
ModFtxt	dc.b	"Event Filter=",34,"----",34,0

	IFNE NEWFILTER
SampleVFade		dc.b	"* Sample Volume Fade",0
SampleVFadeClr		dc.b	"* Sample Volume Fade: cleared",0
SampleVFadeBgn		dc.b	"Amplitude Start (0..100)",0
SampleVFadeEnd		dc.b	"Amplitude End (0..100)",0
LPResoFilter_TXT	dc.b	"Filter Frequency (0..255)",0
LPResoFilterB_TXT	dc.b	"Filter Resonance (0..255)",0
ResoFilterLP		dc.b	"LP Filter: Start",0
ResoFilterLPb		dc.b	"LP Filter: End",0
ResoFilterAbort		dc.b	"LP Filter removed",0
ResoFilterStatic 	dc.b	"Static LP Filter Set",0
ResoFilterSweep		dc.b	"LP Filter Sweep Set",0
	ENDC

	ELSE
VFadeMin_TXT	dc.b	"G. Pocztkowa (1..100)",0
VFadeMax_TXT	dc.b	"G. Kocowa (1..100)",0
VFade_INFOTXT	dc.b	"*** BLOK: Zmiana G. ***",0
ModFtxt2	dc.b	"Event Filtr=",34,"Pojedyczy Fx/Kl. Nacinity",34,0
ModFtxt		dc.b	"Event Filtr=",34,"----",34,0

	IFNE NEWFILTER
SampleVFade		dc.b	"* Zmiana G. Sampla",0
SampleVFadeClr		dc.b	"* Zmiana G Sampla: wyczyszczone",0
SampleVFadeBgn		dc.b	"Pocztkowa Amplituda (0..100)",0
SampleVFadeEnd		dc.b	"Konicowa Amplituda (0..100)",0

LPResoFilter_TXT	dc.b	"Czstotliwo Filtra (0..255)",0
LPResoFilterB_TXT	dc.b	"Rezonas Filtra (0..255)",0
ResoFilterLP		dc.b	"LP Filtr: Pocztek",0
ResoFilterLPb		dc.b	"LP Filtr: Koniec",0
ResoFilterAbort		dc.b	"LP Filtr usunity",0 
ResoFilterStatic 	dc.b	"Static LP Filtr",0
ResoFilterSweep		dc.b	"LP Rozlegy Filtr Ustawiony",0
Declicktxt		dc.b	"Declicking (4..800)",0
	ENDC


	ENDC
	;end polish

	ENDC
Encode_END
	dc.b	"XAXA"


PlayTrackInfo	blk.b	CHANNEL_MAXNUMB,0
XPKErrMsg	blk.b	XPKERRMSGSIZE,0
INameBak	blk.b	SampleNameMaxLen+1,0

templong	dc.l	0
DUMMY		blk.l	16,0
DEBUG		blk.l   16,0


	;=== SECTION CODE EXTRA ==================================



	IFNE FXROUTINES
	acode
SetOldCList
	BGN
	IFNE DIRECTAMIGAAUDIO
	cmpi.b	#FALSE,CLIST_ENABLED
	beq.s	.exit
	move.b	#FALSE,CLIST_ENABLED
	jsr	OldCopList
	move.l	MainScreen_PTR,a0
	lea.l	44(a0),a0
	GFX	ScrollVPort(a6)
	move.l	MainScreen_PTR,a0
	CALLINT	ScreenToFront(a6)
	ENDC
.exit	RET


	acode
UpdateColorOrgan
	IFNE DIRECTAMIGAAUDIO
	cmpi.b	#TRUE,CLIST_ENABLED
	bne.s	.exit

	puts	d0-d2/a0

	andi.l	#$ff,d0
	lsl.l	#1,d0

	moveq	#0,d2
	move.b	NOTE_INSTR(a2),d2
	mulu	#11,d2
	andi.w	#$1ff,d2
	add.w	d2,d0

.ok	cmpi.w	#360,d0
	blo.s	.ok2
	subi.w	#360,d0
	bra.s	.ok

.ok2	move.w	d0,d2
	mulu	#CLPLANE_H-10,d2
	divu	#360,d2

	bsr	SetColHSVT2
	gets	d0-d2/a0
	ENDC
.exit	rts




bplcon3_LORESSPRITE	EQU	%01000000
bplcon3_HIRESSPRITE	EQU	%10000000
bplcon3_SUPERHIRESSPRITE	EQU	%11000000

	acode
LinkFadeRGB32	;V1.0
		;I(RGB32,RGB32,CWAIT,CWAITADD,STEPS,COLORREGISTER)
	movem.l	d0-d7/a1,-(a7)
	move.l	d5,d6
	move.l	d2,d5
	move.l	d4,d2
	move.l	a0,a1
	lea.l	LinkFadeRGB32_TEMP,a0
	bsr.w	BuildColFadeTab

	exg	a0,a1
	move.l	d6,d1
LinkFadeRGB32_L
		move.l	d5,(a0)+
		move.l	(a1)+,d0
		bsr.w	AddRGB32Clist
		add.l	d3,d5
	dbf	d4,LinkFadeRGB32_L

	movem.l	(a7)+,d0-d7/a1
	rts

	acode
BuildColFadeTab	;V1.0
		;I(STARTCOLOR,ENDCOLOR,STEPS,DEST_PTR)(D0L,D1L,D2W,A0L)
ColFadeTab_SRC	EQU	0
ColFadeTab_DEST	EQU	6
ColFadeTab_TEMP	EQU	12
	BGN

	move.l	d0,(a0)+

	lea.l	ColFadeTEMP_PTR(PC),a2
	move.l	d1,d3
	andi.l	#$ffff,d2
	move.l	d2,d4
	move.l	d2,d6
	
	bsr.w	SplitRGB32
	movem.w	d0-d2,ColFadeTab_SRC(a2)
	move.l	d3,d0
	bsr.b	SplitRGB32
	movem.w	d0-d2,ColFadeTab_DEST(a2)
	moveq	#1,d5

	subq.w	#1,d6
BuildColFadeTab_L2

		lea.l	ColFadeTab_SRC(a2),a3
		lea.l	ColFadeTab_DEST(a2),a4
		lea.l	ColFadeTab_TEMP(a2),a5

		moveq	#3-1,d7
BuildColFadeTab_L1	
			move.w	(a3)+,d0
			move.w	(a4)+,d1
			cmp.w	d1,d0
			bls.s	BuildColFadeTab_A

			move.w	d0,d2
			sub.w	d1,d2
			mulu	d5,d2
			divu	d4,d2
			sub.w	d2,d0
			move.w	d0,(a5)+	

			bra.s	BuildColFadeTab_B
	
BuildColFadeTab_A
			sub.w	d0,d1
			mulu	d5,d1
			divu	d4,d1
			add.w	d0,d1
			move.w	d1,(a5)+	
BuildColFadeTab_B

		dbf	d7,BuildColFadeTab_L1
BuildColFadeTab_C
		addq.w	#1,d5
		movem.w	ColFadeTab_TEMP(a2),d0-d2
		bsr.b	UnsplitRGB32
		move.l	d0,(a0)+
	dbf	d6,BuildColFadeTab_L2
	RET
ColFadeTEMP_PTR	blk.l	9,0
	
	acode
SplitRGB32	;V1.0
		;I(D0L)(RRGGBB)
		;O(D0W,D1W,D2W)(RR00,GG00,BB00)
	move.w	d0,d1
	move.l	d0,d2
	lsl.w	#8,d2	
	lsr.l	#8,d0
	andi.w	#$ff00,d0
	andi.w	#$ff00,d1
	andi.w	#$ff00,d2
	rts

	acode
UnsplitRGB32	;V1.0
		;!! CHANGES D1,D2 !!
	lsl.l	#8,d0
	andi.l	#$ff0000,d0
	move.w	d1,d0
	lsr.w	#8,d2
	move.b	d2,d0
	rts


	acode
RGB32toFastRGB32	;V1.1
			;O(D0L)(RRGGBB)
			;I(D0L)(RGB0RGB)

	movem.l	d1-d5,-(a7)
	moveq	#0,d4
	moveq	#0,d5

	moveq	#3-1,d3
.loop		move.b	d0,d1
		andi.b	#$0f,d1
		or.b	d1,d4
		lsr.l	#4,d0	
		ror.w	#4,d4

		move.b	d0,d1
		andi.b	#$0f,d1
		or.b	d1,d5
		lsr.l	#4,d0	
		ror.w	#4,d5
	dbf	d3,.loop
	move.w	d4,d0
	swap	d0
	move.w	d5,d0
	lsr.l	#4,d0
	movem.l	(a7)+,d1-d5
	rts


	acode
SetRGB32Color	;V1.0
		;I(COLOR,REGISTER)(D0L[0RGB0RGB],D1L[0..255])
	bsr.b	RGB32toFastRGB32

	acode
SetFastRGB32Color	;V1.0
		;I(COLOR,REGISTER)(D0L[0RGB0RGB],D1L[0..255])
	BGN
	bsr.b	FastRGB32	
	lea.l	$dff000,a5
	move.w	d2,bplcon3(a5)		;REGISTERBANK/COLORBANK SELECT
	move.w	d0,(a5,d1.w)		;RGB24 MOST
	bset	#9,d2
	move.w	d2,bplcon3(a5)		;COLORBANK SELECT LO
	swap	d0
	move.w	d0,(a5,d1.w)		;RGB24 LEAST
	RET

	acode
FastRGB32	;V1.0
	moveq	#0,d2
	move.w	d1,d2
	andi.w	#%0000000011100000,d2
	andi.w	#%11111,d1
	lsl.w	#1,d1
	addi.w	#color,d1
	lsl.w	#7,d2
	or.w	bplcon3_DEFAULT,d2
	bclr	#9,d2
	rts

	acode
AddRGB32Clist	;V1.0
		;I(D0L,D1W)(RRGGBB,REGISTER)
	bsr	RGB32toFastRGB32
	bra	AddFastRGB32Clist

	acode
AddFastRGB32Clist	;V1.0
		;I(D0L,D1W)(RRGGBB,REGISTER)
	movem.l	d0-d7,-(a7)
	bsr.b	FastRGB32
	move.w	#bplcon3,(a0)+
	move.w	d2,(a0)+
	move.w	d1,(a0)+
	move.w	d0,(a0)+
	bset	#9,d2
	swap	d0
	move.w	#bplcon3,(a0)+
	move.w	d2,(a0)+
	move.w	d1,(a0)+
	move.w	d0,(a0)+
	movem.l	(a7)+,d0-d7
	rts
				;	%-CCC---CSS------
bplcon3_DEFAULT	dc.w	%0000000111000001

CLADD	macro
	move.l	#\1,(a0)+
	endm


	;I(VALUE,REGISTER)


CLMOVE2	macro
	move.l	\2*$10000+\1,(a0)+
	endm



CLWAIT	MACRO
	move.l	#$\1fffe,(a0)+
	ENDM

CLFASTRGB32	MACRO	;RGB0RGB,COLORREGISTER
	move.l	\1,d0
	move.w	\2,d1
	jsr	AddFastRGB32Clist
	ENDM

CLRGB32	MACRO	;RRGGBB,COLORREGISTER
	move.l	\1,d0
	move.w	\2,d1
	jsr	AddRGB32Clist
	ENDM

	acode
AddLongCList	;V1.0
		;I(D0L,D1W,A0L)(DATA,REGISTER,CLIST)
		;O(A0L)(NEWCLIST)
	bclr	#0,d1			;FORCE CMOVE CORRECTION
	move.w	d1,(a0)+
	swap	d0
	move.w	d0,(a0)+
	swap	d0
	addq.w	#2,d1
	move.w	d1,(a0)+
	move.w	d0,(a0)+
	subq.w	#2,d1
	rts

	;***** COPPER *****




CLPLANE_H	EQU	200

	acode
MakeCopperList	;V1.0
	BGN
	move.l	CopperList_PTR,a0

	move.w	#bplcon3,(a0)+
	move.w	bplcon3_DEFAULT,(a0)+
	
	CLADD	$01800000           
	CLADD	$00960100           
	jsr	LinkNullSpriteCopList


	move.l	#$f00030,d0           
	move.l	#$000050,d1                
	move.l	#$4001fffe,d2           
	move.l	#$01000000,d3           
	moveq	#5,d4                   
	moveq	#0,d5
;	jsr	LinkFadeRGB32


	CLRGB32	#$000000,#0	;RRGGBB

;	--- build color plane -------------------------------------

	move.l	#$3001fffe,d6
	move.l	#CLPLANE_H-1,d7

	move.l	d6,(a0)+
	move.l	a0,CL_ColorPlane

.loop
	CLRGB32	#$000000,#0
	addi.l	#$01000000,d6
	move.l	d6,(a0)+
	dbf	d7,.loop

	lea.l	-4(a0),a0	;clear last command





	CLWAIT	ff01
	CLRGB32	#$000000,#0


	move.w	#bplcon3,(a0)+
	move.w	bplcon3_DEFAULT,(a0)+
	move.l	a0,COLOR_CLADR
	CLWAIT	ffff



	IFNE	TESTPRGB
	move.w	#30,d0
	bsr	ConvHSV2RGB
	moveq	#20,d1
	bsr	SetColRGBT
	move.w	#60,d0
	bsr	ConvHSV2RGB
	moveq	#30,d1
	bsr	SetColRGBT
	move.w	#90,d0
	bsr	ConvHSV2RGB
	moveq	#40,d1
	bsr	SetColRGBT
	move.w	#120,d0
	bsr	ConvHSV2RGB
	moveq	#50,d1
	bsr	SetColRGBT
	move.w	#150,d0
	bsr	ConvHSV2RGB
	moveq	#60,d1
	bsr	SetColRGBT
	move.w	#180,d0
	bsr	ConvHSV2RGB
	moveq	#70,d1
	bsr	SetColRGBT
	move.w	#210,d0
	bsr	ConvHSV2RGB
	moveq	#80,d1
	bsr	SetColRGBT
	move.w	#240,d0
	bsr	ConvHSV2RGB
	moveq	#90,d1
	bsr	SetColRGBT
	move.w	#270,d0
	bsr	ConvHSV2RGB
	moveq	#100,d1
	bsr	SetColRGBT
	move.w	#300,d0
	bsr	ConvHSV2RGB
	moveq	#110,d1
	bsr	SetColRGBT
	move.w	#330,d0
	bsr	ConvHSV2RGB
	moveq	#120,d1
	bsr	SetColRGBT
	bsr	ColRGBT2CList
	ENDC




	move.b	#TRUE,CLIST_ENABLED

	RET

CL_ColorPlane	dc.l	0
COLOR_CLADR	dc.l	0
CLIST_ENABLED	dc.b	FALSE


	;--- ANIMATE COPPERLIST ----------------------------

	acode
AnimateSpecialFX
	cmpi.b	#TRUE,CLIST_ENABLED
	bne.s	.exit
	bsr	RGBFadeZeroCol2
	bsr	RGBStretchColors
	bsr	ColRGBT2CList
.exit	rts



RGBDiffuseColorsDwn

	BGN	
	move.l	RGB_Table_PTR(PC),a1
	move.l	#CLPLANE_H-1,d7	
	moveq	#4,d3
	moveq	#8,d2

	subq.w	#1,d7
	move.l	(a1),d4

.loop	
	move.l	(a1),d0

	bsr	.fadergb
	bsr	.fadergb
	bsr	.fadergb

	ror.l	d2,d0

	move.l	d0,d4	
	move.l	d0,(a1)+
	dbf	d7,.loop
	RET

.fadergb
	lsr.b	#5,d4
	add.b	d4,d0
	bvc.s	.ok
	move.b	#255,d0	;overflow
.ok
	ror.l	d2,d0
	ror.l	d2,d4
	rts




RGBStretchColors
	BGN	
	move.l	RGB_Table_PTR(PC),a1
	move.l	#CLPLANE_H-2,d7	
	moveq	#16,d3
	moveq	#8,d2

	moveq	#0,d0

.loop	move.l	(a1)+,d4
	tst.l	d4
	beq.s	.next

	move.l	d4,d0
.next
	bsr	.fadergb
	bsr	.fadergb
	bsr	.fadergb
	ror.l	d2,d0

	tst.l	(a1)
	bne.s	.newcol
	move.l	d0,(a1)
.newcol

	dbf	d7,.loop
	RET

.fadergb
	cmp.b	d3,d0
	bhi.s	.do
	move.b	#0,d0
.skip	ror.l	d2,d0
	rts
.do	sub.b	d3,d0
	ror.l	d2,d0
	rts



RGBFadeZeroCol2
	BGN	
	move.l	RGB_Table_PTR(PC),a1
	move.l	#CLPLANE_H-1,d7	
	moveq	#20,d3			;fade speed
	moveq	#8,d2
.loop	
	move.l	(a1),d0
	bsr	.fadergb
	bsr	.fadergb
	bsr	.fadergb
	ror.l	d2,d0
	move.l	d0,(a1)+
	dbf	d7,.loop
	RET

.fadergb
	cmp.b	d3,d0
	bhi.s	.do
	move.b	#0,d0
.skip	ror.l	d2,d0
	rts
.do	sub.b	d3,d0
	ror.l	d2,d0
	rts





RGBFadeZeroCol
	BGN	

	move.l	RGB_Table_PTR(PC),a1
	move.l	#CLPLANE_H-1,d7	
	moveq	#8,d2
.loop	
	move.l	(a1),d0
	tst.b	d0
	beq.s	.skip1
	subq.b	#1,d0
.skip1	ror.l	d2,d0

	tst.b	d0
	beq.s	.skip2
	subq.b	#1,d0
.skip2	ror.l	d2,d0

	tst.b	d0
	beq.s	.skip3
	subq.b	#1,d0
.skip3	ror.l	d2,d0

	ror.l	d2,d0
	move.l	d0,(a1)+

	dbf	d7,.loop
	RET



	acode
ConvHSV2RGB	;I(d0w,d1W)(Color (0-360), Intensitiy(0-65535)
	puts	a0
	move.l	BuildCT_DATA,a0
	move.l	(a0,d0.w*4),d0
	gets	a0
	rts

	acode
InitColTTab
	BGN
	move.l	BuildCT_DATA,a1
	lea.l	BuildCT_DEF(PC),a0	

	move.w	#359,d6


	moveq	#0,d0
	move.b	(a0)+,d0	;R
	rol.l	#8,d0
	move.b	(a0)+,d0	;G
	rol.l	#8,d0
	move.b	(a0)+,d0	;B


.loop
	move.w	(a0)+,d7
	cmpi.w	#-1,d7
	beq.s	.exit

	move.b	(a0)+,d1
	move.b	(a0)+,d2
	move.b	(a0)+,d3
	
.flood	

	move.l	d0,(a1)+
	subq.w	#1,d6
	beq.s	.exit

	add.b	d3,d0
	ror.l	#8,d0
	add.b	d2,d0
	ror.l	#8,d0
	add.b	d1,d0
	rol.l	#8,d0
	rol.l	#8,d0

	dbf	d7,.flood
	bra.s	.loop

.exit	RET


BuildCT_DATA
	dc.l	0,4*360,FASTMEM

BuildCT_DEF
	dc.b	255,0,0	;START	R G B

	dc.b	0,59	;NUMB	red
	dc.b	0,0,4	;dR dG dB

	dc.b	0,59	;NUMB	violett
	dc.b	-2,2,0	;dR dG dB

	dc.b	0,59	;NUMB	blue
	dc.b	-2,2,0	;dR dG dB

	dc.b	0,59	;NUMB	cyan to green
	dc.b	4,0,-4	;dR dG dB

	dc.b	0,59	;NUMB	green to yellow
	dc.b	0,-1,0	;dR dG dB

	dc.b	0,59	;NUMB	yellow to red
	dc.b	0,-3,0	;dR dG dB

	dc.b	0,100
	dc.b	1,2,-1
	
	dc.b	0,100
	dc.b	-1,1,-1

	dc.b	-1,-1

	acode
SetColHSVT4	;(d0L,d1W,d2W)(COLORAngle, COLORIntensity, POSITION)
	puts	d0-d4
	moveq	#8,d4

.loop
		puts	d0-d2
		bsr	ConvHSV2RGB
		move.w	d2,d1
		bsr	.AddColRGBT
		gets	d0-d2

		addq.b	#2,d0
		lsr.w	#1,d1
		addq.w	#1,d2

	dbf	d4,.loop

	gets	d0-d4
	rts

.AddColRGBT	;(d0L,d1W)(COLOR 00RGB,POSITION)
	puts	a0/d0-d2
	move.l	RGB_Table_PTR(PC),a0
	andi.w	#$ff,d1	
	lea.l	(a0,d1.w*4),a0


	bsr	.AddCol
	rol.l	#8,d0
	lea.l	1(a0),a0

	bsr	.AddCol
	rol.l	#8,d0
	lea.l	1(a0),a0

	bsr	.AddCol
	rol.l	#8,d0
	lea.l	1(a0),a0

	bsr	.AddCol
	gets	a0/d0-d2
	rts

.AddCol	move.b	(a0),d2
	add.b	d0,d2
	bcc.s	.noover1
	move.b	#-1,(a0)
	rts
.noover1
	move.b	d2,(a0)
	rts

	acode
SetColHSVT3	;(d0L,d1W,d2W)(COLORAngle, COLORIntensity, POSITION)
	puts	d0-d4
	moveq	#8,d4

.loop
		puts	d0-d2
		bsr	ConvHSV2RGB
		move.w	d2,d1
		bsr	.AddColRGBT
		gets	d0-d2
		;lsr.w	#1,d1
		addq.w	#1,d2

	dbf	d4,.loop

	gets	d0-d4
	rts

.AddColRGBT	;(d0L,d1W)(COLOR 00RGB,POSITION)
	puts	a0/d0-d2
	move.l	RGB_Table_PTR(PC),a0
	andi.w	#$ff,d1	
	lea.l	1(a0,d1.w*4),a0
	bsr	.AddCol
	lsr.l	#8,d0
	lea.l	1(a0),a0
	bsr	.AddCol
	lsr.l	#8,d0
	lea.l	1(a0),a0
	bsr	.AddCol
	gets	a0/d0-d2
	rts

.AddCol	move.b	(a0),d2
	add.b	d0,d2
	bcc.s	.noover1
	move.b	#-1,(a0)
	rts
.noover1
	move.b	d2,(a0)
	rts






	acode
SetColHSVT2	;(d0L,d1W,d2W)(COLORAngle, COLORIntensity, POSITION)
	puts	d0-d3
	bsr	ConvHSV2RGB
	move.w	d2,d1
	bsr	SetColRGBT
	gets	d0-d3
	rts

SetColRGBT	;(d0L,d1W)(COLOR 00RGB,POSITION)
	puts	a0
	move.l	RGB_Table_PTR(PC),a0
	andi.w	#$ff,d1	
	move.l	d0,(a0,d1.w*4)
	gets	a0
	rts

ColRGBT2CList
	BGN
	move.l	CL_ColorPlane(PC),a0
	move.l	RGB_Table_PTR(PC),a1
	moveq	#0,d1
	move.l	#CLPLANE_H-1,d7	
.loop	move.l	(a1)+,d0
	bsr	AddRGB32Clist
	lea.l	4(a0),a0
	dbf	d7,.loop
	RET

RGB_Table_PTR	dc.l	0,CLPLANE_H*4,FASTMEM	;00RRGGBB1, 00RRGGBB2, 00RRGGBB3
	ENDC




	END


